(function(){Cocoon=window.Cocoon?window.Cocoon:{};Cocoon.version="3.0.5";Cocoon.nativeAvailable=!!window.ext;Cocoon.extend=function(subc,superc){var subcp=subc.prototype;var CocoonJSExtendHierarchyChainClass=function(){};CocoonJSExtendHierarchyChainClass.prototype=superc.prototype;subc.prototype=new CocoonJSExtendHierarchyChainClass;subc.superclass=superc.prototype;subc.prototype.constructor=subc;if(superc.prototype.constructor===Object.prototype.constructor){superc.prototype.constructor=superc}for(var method in subcp){if(subcp.hasOwnProperty(method)){subc.prototype[method]=subcp[method]}}};Cocoon.clone=function(obj,copy){if(null==obj||"object"!=typeof obj)return obj;var arr=[];for(var attr in obj){if(copy.hasOwnProperty(attr)){arr.push(copy[attr])}else{arr.push(obj[attr])}}return arr};Cocoon.callNative=function(nativeExtensionObjectName,nativeFunctionName,args,async){if(Cocoon.nativeAvailable){var argumentsArray=Array.prototype.slice.call(args);argumentsArray.unshift(nativeFunctionName);var nativeExtensionObject=ext[nativeExtensionObjectName];var makeCallFunction=async?nativeExtensionObject.makeCallAsync:nativeExtensionObject.makeCall;var ret=makeCallFunction.apply(nativeExtensionObject,argumentsArray);var finalRet=ret;if(typeof ret==="string"){try{finalRet=JSON.parse(ret)}catch(error){console.log(error)}}return finalRet}};Cocoon.getObjectFromPath=function(baseObject,objectPath){var parts=objectPath.split(".");var obj=baseObject;for(var i=0,len=parts.length;i<len;++i){obj[parts[i]]=obj[parts[i]]||undefined;obj=obj[parts[i]]}return obj};Cocoon.EventHandler=function(nativeExtensionObjectName,CocoonExtensionObjectName,nativeEventName,chainFunction){this.listeners=[];this.listenersOnce=[];this.chainFunction=chainFunction;this.addEventListener=function(listener){if(chainFunction){var f=function(){chainFunction.call(this,arguments.callee.sourceListener,Array.prototype.slice.call(arguments))};listener.CocoonEventHandlerChainFunction=f;f.sourceListener=listener;listener=f}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject&&CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].addEventListener(nativeEventName,listener)}else{var indexOfListener=this.listeners.indexOf(listener);if(indexOfListener<0){this.listeners.push(listener)}}};this.addEventListenerOnce=function(listener){if(chainFunction){var f=function(){chainFunction(arguments.callee.sourceListener,Array.prototype.slice.call(arguments))};f.sourceListener=listener;listener=f}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].addEventListenerOnce(nativeEventName,listener)}else{var indexOfListener=this.listeners.indexOf(listener);if(indexOfListener<0){this.listenersOnce.push(listener)}}};this.removeEventListener=function(listener){if(chainFunction){listener=listener.CocoonEventHandlerChainFunction;delete listener.CocoonEventHandlerChainFunction}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].removeEventListener(nativeEventName,listener)}else{var indexOfListener=this.listeners.indexOf(listener);if(indexOfListener>=0){this.listeners.splice(indexOfListener,1)}}};this.removeEventListenerOnce=function(listener){if(chainFunction){listener=listener.CocoonEventHandlerChainFunction;delete listener.CocoonEventHandlerChainFunction}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].removeEventListenerOnce(nativeEventName,listener)}else{var indexOfListener=this.listenersOnce.indexOf(listener);if(indexOfListener>=0){this.listenersOnce.splice(indexOfListener,1)}}};this.notifyEventListeners=function(){var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject&&CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].notifyEventListeners(nativeEventName)}else{var argumentsArray=Array.prototype.slice.call(arguments);var listeners=Array.prototype.slice.call(this.listeners);var listenersOnce=Array.prototype.slice.call(this.listenersOnce);var _this=this;setTimeout(function(){for(var i=0;i<listeners.length;i++){listeners[i].apply(_this,argumentsArray)}for(var i=0;i<listenersOnce.length;i++){listenersOnce[i].apply(_this,argumentsArray)}},0);_this.listenersOnce=[]}};return this};Cocoon.define=function(extName,ext){var namespace=extName.substring(0,7)=="Cocoon."?extName.substr(7):extName;var base=window.Cocoon;var parts=namespace.split(".");var object=base;for(var i=0;i<parts.length;i++){var part=parts[i];!object[part]?console.log("Created namespace: "+extName):console.log("Updated namespace: - "+extName);object=object[part]=i==parts.length-1?ext(object[part]||{}):{};if(!object){throw"Unable to create class "+extName}}return true};console.log("Created namespace: Cocoon")})();Cocoon.define("Cocoon.Signal",function(extension){"use strict";extension.createSignal=function(){this.handle=null;this.signals={};this.register=function(namespace,handle){if(!namespace&&!handle)throw new Error("Can't create signal "+(namespace||""));if(handle.addEventListener){this.signals[namespace]=handle;return true}if(!handle.addEventListener){this.signals[namespace]={};for(var prop in handle){if(handle.hasOwnProperty(prop)){this.signals[namespace][prop]=handle[prop]}}return true}throw new Error("Can't create handler for "+namespace+" signal.");return false},this.expose=function(){return function(signal,callback,params){var once=false;if(arguments.length===1){var that=this;var fnc=function(signal){this.signal=signal};fnc.prototype.remove=function(functionListener){var handle=that.signals[this.signal];if(handle&&handle.removeEventListener){handle.removeEventListener.apply(that,[functionListener]);that.signals[this.signal]=undefined}};return new fnc(signal)}if(params&&params.once){once=true}if(!this.signals[signal])throw new Error("The signal "+signal+" does not exists.");var handle=this.signals[signal];if(handle.addEventListener){if(once){handle.addEventListenerOnce(function(){callback.apply(this||window,arguments)})}else{handle.addEventListener(function(){callback.apply(this||window,arguments)})}}if(!this.signals[signal].addEventListener){for(var prop in this.signals[signal]){if(!this.signals[signal].hasOwnProperty(prop))continue;var handle=this.signals[signal][prop];if(once){handle.addEventListenerOnce(function(){this.clbk[this.name].apply(this||window,arguments)}.bind({name:prop,clbk:callback}))}else{handle.addEventListener(function(){this.clbk[this.name].apply(this||window,arguments)}.bind({name:prop,clbk:callback}))}}}}.bind(this)}};return extension});Cocoon.define("Cocoon.App",function(extension){extension.nativeAvailable=!!window.ext&&!!window.ext.IDTK_APP;extension.isBridgeAvailable=function(){if(Cocoon.App.forward.nativeAvailable==="boolean"){return Cocoon.App.forward.nativeAvailable}else{var available=Cocoon.callNative("IDTK_APP","forwardAvailable",arguments);available=!!available;Cocoon.App.forward.nativeAvailable=available;return available}};extension.forward=function(javaScriptCode){if(Cocoon.App.nativeAvailable&&Cocoon.App.isBridgeAvailable()){return Cocoon.callNative("IDTK_APP","forward",arguments)}else if(!navigator.isCocoonJS){if(window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"){return window.parent.eval(javaScriptCode)}else{return window.frames["CocoonJS_App_ForCocoonJS_WebViewIFrame"].window.eval(javaScriptCode)}}};extension.forwardAsync=function(javaScriptCode,returnCallback){if(Cocoon.App.nativeAvailable&&Cocoon.App.isBridgeAvailable()){if(typeof returnCallback!=="undefined"){return ext.IDTK_APP.makeCallAsync("forward",javaScriptCode,returnCallback)}else{return ext.IDTK_APP.makeCallAsync("forward",javaScriptCode)}}else{setTimeout(function(){var res;window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"?(res=window.parent.eval(javaScriptCode),typeof returnCallback==="function"&&returnCallback(res)):(res=window.parent.frames["CocoonJS_App_ForCocoonJS_WebViewIFrame"].window.eval(javaScriptCode),typeof returnCallback==="function"&&returnCallback(res))},1)}};extension.load=function(path,storageType){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","loadPath",arguments)}else if(!navigator.isCocoonJS){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(event){if(xhr.readyState===4){if(xhr.status===200){var jsCode;if(!Cocoon.App.EmulatedWebViewIFrame){jsCode="window.Cocoon && window.Cocoon.App.onLoadInTheWebViewSucceed.notifyEventListeners('"+path+"');"}else{jsCode="window.Cocoon && window.Cocoon.App.onLoadInCocoonJSSucceed.notifyEventListeners('"+path+"');"}Cocoon.App.forwardAsync(jsCode);window.location.href=path}else if(xhr.status===404){this.onreadystatechange=null;var jsCode;if(!Cocoon.App.EmulatedWebViewIFrame){jsCode="Cocoon && Cocoon.App.onLoadInTheWebViewFailed.notifyEventListeners('"+path+"');"}else{jsCode="Cocoon && Cocoon.App.onLoadInCocoonJSFailed.notifyEventListeners('"+path+"');"}Cocoon.App.forwardAsync(jsCode)}}};xhr.open("GET",path,true);xhr.send()}};extension.reload=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","reload",arguments)}else if(!navigator.isCocoonJS){if(window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"){return window.parent.location.reload()}else{return window.parent.frames["CocoonJS_App_ForCocoonJS_WebViewIFrame"].window.location.reload()}}};extension.openURL=function(url){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","openURL",arguments,true)}else if(!navigator.isCocoonJS){window.open(url,"_blank")}};extension.exit=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","forceToFinish",arguments)}else if(!navigator.isCocoonJS){window.close()}};extension.StorageType={APP_STORAGE:"APP_STORAGE",INTERNAL_STORAGE:"INTERNAL_STORAGE",EXTERNAL_STORAGE:"EXTERNAL_STORAGE",TEMPORARY_STORAGE:"TEMPORARY_STORAGE"};extension.onSuspended=new Cocoon.EventHandler("IDTK_APP","App","onsuspended");extension.onActivated=new Cocoon.EventHandler("IDTK_APP","App","onactivated");extension.onSuspending=new Cocoon.EventHandler("IDTK_APP","App","onsuspending");extension.onMemoryWarning=new Cocoon.EventHandler("IDTK_APP","App","onmemorywarning");var signal=new Cocoon.Signal.createSignal;signal.register("suspended",extension.onSuspended);signal.register("activated",extension.onActivated);signal.register("suspending",extension.onSuspending);signal.register("memorywarning",extension.onMemoryWarning);extension.on=signal.expose();return extension});Cocoon.define("Cocoon.App",function(extension){function checkEmulatedWebViewReady(){var emulatedWB=Cocoon.App.EmulatedWebView;if(emulatedWB){return}emulatedWB=document.createElement("div");emulatedWB.setAttribute("id","CocoonJS_App_ForCocoonJS_WebViewDiv");emulatedWB.style.width=0;emulatedWB.style.height=0;emulatedWB.style.position="absolute";emulatedWB.style.left=0;emulatedWB.style.top=0;emulatedWB.style.backgroundColor="transparent";emulatedWB.style.border="0px solid #000";var frame=document.createElement("IFRAME");frame.setAttribute("id","CocoonJS_App_ForCocoonJS_WebViewIFrame");frame.setAttribute("name","CocoonJS_App_ForCocoonJS_WebViewIFrame");frame.style.width=0;frame.style.height=0;frame.frameBorder=0;frame.allowtransparency=true;emulatedWB.appendChild(frame);Cocoon.App.EmulatedWebView=emulatedWB;Cocoon.App.EmulatedWebViewIFrame=frame;if(!document.body){document.body=document.createElement("body")}document.body.appendChild(Cocoon.App.EmulatedWebView)}extension.pause=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","pause",arguments)}};extension.resume=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","resume",arguments)}};extension.loadInTheWebView=function(path,storageType){if(navigator.isCocoonJS&&Cocoon.App.nativeAvailable){Cocoon.callNative("IDTK_APP","loadInTheWebView",arguments)}else{var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(event){if(xhr.readyState===4){if(xhr.status>=200&&xhr.status<=299||xhr.status===0){checkEmulatedWebViewReady();var callback=function(event){Cocoon.App.onLoadInTheWebViewSucceed.notifyEventListeners(path);Cocoon.App.EmulatedWebViewIFrame.removeEventListener("load",callback)};Cocoon.App.EmulatedWebViewIFrame.addEventListener("load",callback);Cocoon.App.EmulatedWebViewIFrame.contentWindow.location.href=path}else{this.onreadystatechange=null;Cocoon.App.onLoadInTheWebViewFailed.notifyEventListeners(path)}}};xhr.open("GET",path,true);xhr.send()}};extension.reloadWebView=function(){if(Cocoon.App.nativeAvailable&&navigator.isCocoonJS){Cocoon.callNative("IDTK_APP","reloadWebView",arguments)}else{checkEmulatedWebViewReady();Cocoon.App.EmulatedWebViewIFrame.contentWindow.location.reload()}};extension.showTheWebView=function(x,y,width,height){if(Cocoon.App.nativeAvailable&&navigator.isCocoonJS){Cocoon.callNative("IDTK_APP","showTheWebView",arguments)}else{checkEmulatedWebViewReady();Cocoon.App.EmulatedWebViewIFrame.style.width=(width?width/window.devicePixelRatio:window.innerWidth)+"px";Cocoon.App.EmulatedWebViewIFrame.style.height=(height?height/window.devicePixelRatio:window.innerHeight)+"px";Cocoon.App.EmulatedWebView.style.left=(x?x:0)+"px";Cocoon.App.EmulatedWebView.style.top=(y?y:0)+"px";Cocoon.App.EmulatedWebView.style.width=(width?width/window.devicePixelRatio:window.innerWidth)+"px";Cocoon.App.EmulatedWebView.style.height=(height?height/window.devicePixelRatio:window.innerHeight)+"px";Cocoon.App.EmulatedWebView.style.display="block"}};extension.hideTheWebView=function(){if(Cocoon.App.nativeAvailable&&navigator.isCocoonJS){var javaScriptCodeToForward="ext.IDTK_APP.makeCall('hide');";return Cocoon.App.forwardAsync(javaScriptCodeToForward)}else{checkEmulatedWebViewReady();Cocoon.App.EmulatedWebView.style.display="none"}};extension.exitCallback=function(appShouldFinishCallback){if(navigator.isCocoonJS&&Cocoon.App.nativeAvailable){window.onidtkappfinish=appShouldFinishCallback}};extension.forwardedEventFromTheWebView=function(eventName,eventDataString){var eventData=JSON.parse(eventDataString);eventData.target=window;var event=new Event(eventName);for(var att in eventData){event[att]=eventData[att]}event.target=window;window.dispatchEvent(event);var canvases=document.getElementsByTagName("canvas");for(var i=0;i<canvases.length;i++){event.target=canvases[i];canvases[i].dispatchEvent(event)}};extension.onLoadInTheWebViewSucceed=new Cocoon.EventHandler("IDTK_APP","App","forwardpageload");extension.onLoadInTheWebViewFailed=new Cocoon.EventHandler("IDTK_APP","App","forwardpagefail");var signal=new Cocoon.Signal.createSignal;signal.register("load",{success:extension.onLoadInTheWebViewSucceed,error:extension.onLoadInTheWebViewFailed});extension.WebView=Cocoon.WebView||{};extension.WebView.on=signal.expose();return extension});Cocoon.define("Cocoon.Utils",function(extension){"use strict";extension.logMemoryInfo=function(){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","logMemoryInfo",arguments)}};extension.textureReduction=function(sizeThreshold,applyTo,forbidFor){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","setDefaultTextureReducerThreshold",arguments)}};extension.markAsMusic=function(audioFilePath){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","addForceMusic",arguments)}};extension.captureScreen=function(fileName,storageType,captureType,saveToGallery){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","captureScreen",arguments)}};extension.captureScreenAsync=function(fileName,storageType,captureType,saveToGallery,callback){if(Cocoon.nativeAvailable){Cocoon.callNative("IDTK_APP","captureScreen",arguments,true)}};extension.setAntialias=function(enable){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","setDefaultAntialias",arguments)}};extension.setWebGLEnabled=function(enabled){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","setDefaultAntialias",arguments)}};extension.setNPOTEnabled=function(enabled){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return window.ext.IDTK_APP.makeCall("setNPOTEnabled",enabled)}};extension.setMaxMemory=function(memoryInMBs){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return window.ext.IDTK_APP.makeCall("setMaxMemory",memoryInMBs)}};extension.CaptureType={EVERYTHING:0,COCOONJS_GL_SURFACE:1,JUST_SYSTEM_VIEWS:2};extension.existsPath=function(path,storageType){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","existsPath",arguments)}return false};extension.setTextCacheSize=function(size){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","setTextCacheSize",arguments)}};return extension});Cocoon.define("Cocoon.Dialog",function(extension){"use strict";extension.keyboardType={TEXT:"text",NUMBER:"num",PHONE:"phone",EMAIL:"email",URL:"url"};extension.prompt=function(params,callbacks){if(!callbacks)throw"Callback missing for Cocoon.Dialog.prompt();";var defaultKeyboard=Cocoon.Dialog.keyboardType.TEXT;switch(params.type){case Cocoon.Dialog.keyboardType.TEXT:defaultKeyboard=Cocoon.Dialog.keyboardType.TEXT;break;case Cocoon.Dialog.keyboardType.NUMBER:defaultKeyboard=Cocoon.Dialog.keyboardType.NUMBER;break;case Cocoon.Dialog.keyboardType.PHONE:defaultKeyboard=Cocoon.Dialog.keyboardType.PHONE;break;case Cocoon.Dialog.keyboardType.EMAIL:defaultKeyboard=Cocoon.Dialog.keyboardType.EMAIL;break;case Cocoon.Dialog.keyboardType.URL:defaultKeyboard=Cocoon.Dialog.keyboardType.URL;break}var properties={title:"",message:"",text:"",type:defaultKeyboard,cancelText:"Cancel",confirmText:"Ok"};var args=Cocoon.clone(properties,params);var succedListener=function(){Cocoon.Dialog.onTextDialogCancelled.removeEventListener(errorListener);Cocoon.Dialog.onTextDialogFinished.removeEventListener(succedListener);callbacks.success.apply(window,Array.prototype.slice.call(arguments))};var errorListener=function(){Cocoon.Dialog.onTextDialogCancelled.removeEventListener(errorListener);Cocoon.Dialog.onTextDialogFinished.removeEventListener(succedListener);callbacks.cancel.apply(window,Array.prototype.slice.call(arguments))};Cocoon.Dialog.onTextDialogCancelled.addEventListener(errorListener);Cocoon.Dialog.onTextDialogFinished.addEventListener(succedListener);if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","showTextDialog",args,true)}else{setTimeout(function(){var result=prompt(properties.message,properties.text);var eventObject=result?Cocoon.Dialog.onTextDialogFinished:Cocoon.Dialog.onTextDialogCancelled;eventObject.notifyEventListeners(result)},0)}};extension.confirm=function(params,callback){if(!callback)throw"Callback missing for Cocoon.Dialog.confirm();";var properties={title:"",message:"",cancelText:"Cancel",confirmText:"Ok"};var args=Cocoon.clone(properties,params);var succedListener=function(){Cocoon.Dialog.onMessageBoxDenied.removeEventListenerOnce(errorListener);callback(true)};var errorListener=function(){Cocoon.Dialog.onMessageBoxConfirmed.removeEventListenerOnce(succedListener);callback(false)};Cocoon.Dialog.onMessageBoxDenied.addEventListenerOnce(errorListener);Cocoon.Dialog.onMessageBoxConfirmed.addEventListenerOnce(succedListener);if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","showMessageBox",args,true)}else{setTimeout(function(){var result=confirm(properties.message);var eventObject=result?Cocoon.Dialog.onMessageBoxConfirmed:Cocoon.Dialog.onMessageBoxDenied;eventObject.notifyEventListeners()},0)}};extension.showKeyboard=function(params,callbacks){params=params||{};params.type=params.type||Cocoon.Dialog.keyboardType.TEXT;var insertCallback=callbacks&&callbacks.insertText;var deleteCallback=callbacks&&callbacks.deleteBackward;var doneCallback=callbacks&&callbacks.done;var cancelCallback=callbacks&&callbacks.cancel;if(Cocoon.nativeAvailable){Cocoon.callNative("IDTK_APP","showKeyboard",[params,insertCallback,deleteCallback,doneCallback,cancelCallback],true)}};extension.dismissKeyboard=function(){if(Cocoon.nativeAvailable){Cocoon.callNative("IDTK_APP","dismissKeyboard",[],true)}};extension.onTextDialogFinished=new Cocoon.EventHandler("IDTK_APP","App","ontextdialogfinish");extension.onTextDialogCancelled=new Cocoon.EventHandler("IDTK_APP","App","ontextdialogcancel");extension.onMessageBoxConfirmed=new Cocoon.EventHandler("IDTK_APP","App","onmessageboxconfirmed");extension.onMessageBoxDenied=new Cocoon.EventHandler("IDTK_APP","App","onmessageboxdenied");return extension});Cocoon.define("Cocoon.WebView",function(extension){if(typeof Cocoon==="undefined"||Cocoon===null)return extension;if(typeof Cocoon.App==="undefined"||Cocoon.App===null)return extension;if(navigator.isCocoonJS)return extension;extension.show=function(x,y,width,height){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","show",arguments)}else{var div=window.parent.document.getElementById("CocoonJS_App_ForCocoonJS_WebViewDiv");div.style.left=(x?x:div.style.left)+"px";div.style.top=(y?y:div.style.top)+"px";div.style.width=(width?width/window.devicePixelRatio:window.parent.innerWidth)+"px";div.style.height=(height?height/window.devicePixelRatio:window.parent.innerHeight)+"px";div.style.display="block";var iframe=window.parent.document.getElementById("CocoonJS_App_ForCocoonJS_WebViewIFrame");iframe.style.width=(width?width/window.devicePixelRatio:window.parent.innerWidth)+"px";iframe.style.height=(height?height/window.devicePixelRatio:window.parent.innerHeight)+"px"}};extension.hide=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","hide",arguments)}else{window.parent.document.getElementById("CocoonJS_App_ForCocoonJS_WebViewDiv").style.display="none"}};extension.loadInCocoon=function(path,callbacks,storageType){if(Cocoon.App.nativeAvailable){var javaScriptCodeToForward="ext.IDTK_APP.makeCall('loadPath'";if(typeof path!=="undefined"){javaScriptCodeToForward+=", '"+path+"'";if(typeof storageType!=="undefined"){javaScriptCodeToForward+=", '"+storageType+"'"}}javaScriptCodeToForward+=");";return Cocoon.App.forwardAsync(javaScriptCodeToForward)}else{Cocoon.App.forwardAsync("Cocoon.App.load('"+path+"');")}};extension.reloadCocoonJS=function(){if(Cocoon.App.nativeAvailable){return Cocoon.App.forwardAsync("ext.IDTK_APP.makeCall('reload');")}else if(!navigator.isCocoonJS){window.parent.location.reload()}};window.addEventListener("load",function(){if(!Cocoon.App.nativeAvailable&&window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"){Cocoon.App.forwardEventsToCocoonJSEnabled=false;var EVENT_ATTRIBUTES=["timeStamp","button","type","x","y","pageX","pageY","clientX","clientY","offsetX","offsetY"];var EVENTS=["dblclick","touchmove","mousemove","touchend","touchcancel","mouseup","touchstart","mousedown","release","dragleft","dragright","swipeleft","swiperight"];function forwardEventToCocoonJS(eventName,event){var eventData={};var att,i;for(var att in event){i=EVENT_ATTRIBUTES.indexOf(att);if(i>=0){eventData[att]=event[att]}}var jsCode="Cocoon && Cocoon.App && Cocoon.App.forwardedEventFromTheWebView && Cocoon.App.forwardedEventFromTheWebView("+JSON.stringify(eventName)+", '"+JSON.stringify(eventData)+"');";Cocoon.App.forward(jsCode)}for(i=0;i<EVENTS.length;i++){window.addEventListener(EVENTS[i],function(eventName){return function(event){if(Cocoon.App.forwardEventsToCocoonJSEnabled){forwardEventToCocoonJS(eventName,event)}}}(EVENTS[i]))}}});extension.onLoadInCocoonJSSucceed=new Cocoon.EventHandler("IDTK_APP","App","forwardpageload");extension.onLoadInCocoonJSFailed=new Cocoon.EventHandler("IDTK_APP","App","forwardpagefail");return extension});Cocoon.define("Cocoon.Proxify",function(extension){"use strict";extension.getKeyForValueInDictionary=function(dictionary,value){var finalKey=null;for(var key in dictionary){if(dictionary[key]===value){finalKey=key;break}}return finalKey};extension.setupOriginProxyType=function(typeName,attributeNames,functionNames,eventHandlerNames){if(Cocoon.nativeAvailable){if(!typeName)throw"The given typeName must be valid.";if(!attributeNames&&!functionNames&&!eventHandlerNames)throw"There is no point on setting up a proxy for no attributes, functions nor eventHandlers.";attributeNames=attributeNames?attributeNames:[];functionNames=functionNames?functionNames:[];eventHandlerNames=eventHandlerNames?eventHandlerNames:[];var parentObject=window;var jsCode="Cocoon.Proxify.setupDestinationProxyType("+JSON.stringify(typeName)+", "+JSON.stringify(eventHandlerNames)+");";Cocoon.App.forward(jsCode);var originalType=parentObject[typeName];parentObject[typeName]=function(){var _this=this;this._cocoonjs_proxy_object_data={};var jsCode="Cocoon.Proxify.newDestinationProxyObject("+JSON.stringify(typeName)+");";this._cocoonjs_proxy_object_data.id=Cocoon.App.forward(jsCode);this._cocoonjs_proxy_object_data.eventHandlers={};this._cocoonjs_proxy_object_data.typeName=typeName;this._cocoonjs_proxy_object_data.eventListeners={};parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[this._cocoonjs_proxy_object_data.id]=this;for(var i=0;i<attributeNames.length;i++){(function(attributeName){_this.__defineSetter__(attributeName,function(value){var jsCode="Cocoon.Proxify.setDestinationProxyObjectAttribute("+JSON.stringify(typeName)+", "+_this._cocoonjs_proxy_object_data.id+", "+JSON.stringify(attributeName)+", "+JSON.stringify(value)+");";return Cocoon.App.forward(jsCode)});_this.__defineGetter__(attributeName,function(){var jsCode="Cocoon.Proxify.getDestinationProxyObjectAttribute("+JSON.stringify(typeName)+", "+_this._cocoonjs_proxy_object_data.id+", "+JSON.stringify(attributeName)+");";return Cocoon.App.forward(jsCode)})})(attributeNames[i])}for(var i=0;i<functionNames.length;i++){(function(functionName){_this[functionName]=function(){var argumentsArray=Array.prototype.slice.call(arguments);argumentsArray.unshift(functionName);argumentsArray.unshift(this._cocoonjs_proxy_object_data.id);argumentsArray.unshift(typeName);var jsCode="Cocoon.Proxify.callDestinationProxyObjectFunction(";for(var i=0;i<argumentsArray.length;i++){jsCode+=(i!==1?JSON.stringify(argumentsArray[i]):argumentsArray[i])+(i<argumentsArray.length-1?", ":"")}jsCode+=");";var ret=Cocoon.App.forwardAsync(jsCode);return ret}})(functionNames[i])}for(var i=0;i<eventHandlerNames.length;i++){(function(eventHandlerName){_this.__defineSetter__(eventHandlerName,function(value){_this._cocoonjs_proxy_object_data.eventHandlers[eventHandlerName]=value});_this.__defineGetter__(eventHandlerName,function(){return _this._cocoonjs_proxy_object_data.eventHandlers[eventHandlerName]})})(eventHandlerNames[i])}_this.addEventListener=function(eventTypeName,eventCallback){var addEventCallback=true;var eventListeners=_this._cocoonjs_proxy_object_data.eventListeners[eventTypeName];if(eventListeners){addEventCallback=eventListeners.indexOf(eventCallback)<0}else{eventListeners=[];_this._cocoonjs_proxy_object_data.eventListeners[eventTypeName]=eventListeners;var jsCode="Cocoon.Proxify.addDestinationProxyObjectEventListener("+JSON.stringify(_this._cocoonjs_proxy_object_data.typeName)+", "+_this._cocoonjs_proxy_object_data.id+", "+JSON.stringify(eventTypeName)+");";Cocoon.App.forwardAsync(jsCode)}if(addEventCallback){eventListeners.push(eventCallback)}};_this.removeEventListener=function(eventTypeName,eventCallback){var eventListeners=_this._cocoonjs_proxy_object_data.eventListeners[eventTypeName];if(eventListeners){var eventCallbackIndex=eventListeners.indexOf(eventCallback);if(eventCallbackIndex>=0){eventListeners.splice(eventCallbackIndex,1)}}};return this};parentObject[typeName]._cocoonjs_proxy_type_data={originalType:originalType,proxyObjects:[]};parentObject[typeName]._cocoonjs_proxy_type_data.deleteProxyObject=function(object){var proxyObjectKey=extension.getKeyForValueInDictionary(this.proxyObjects,object);if(proxyObjectKey){var jsCode="Cocoon.Proxify.deleteDestinationProxyObject("+JSON.stringify(typeName)+", "+object._cocoonjs_proxy_object_data.id+");";Cocoon.App.forwardAsync(jsCode);object._cocoonjs_proxy_object_data=null;delete this.proxyObjects[proxyObjectKey]}};parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventHandler=function(id,eventHandlerName){var object=this.proxyObjects[id];var eventHandler=object._cocoonjs_proxy_object_data.eventHandlers[eventHandlerName];if(eventHandler){eventHandler({target:object})}};parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventListeners=function(id,eventTypeName){var object=this.proxyObjects[id];var eventListeners=object._cocoonjs_proxy_object_data.eventListeners[eventTypeName].slice();for(var i=0;i<eventListeners.length;i++){eventListeners[i]({target:object})}}}};extension.takedownOriginProxyType=function(typeName){if(Cocoon.App.nativeAvailable){var parentObject=window;if(parentObject[typeName]&&parentObject[typeName]._cocoonjs_proxy_type_data){parentObject[typeName]=parentObject[typeName]._cocoonjs_proxy_type_data.originalType}}};extension.deleteOriginProxyObject=function(object){if(Cocoon.App.nativeAvailable){var parentObject=window;if(object&&object._cocoonjs_proxy_object_data){parentObject[object._cocoonjs_proxy_object_data.typeName]._cocoonjs_proxy_type_data.deleteProxyObject(object)}}};extension.callOriginProxyObjectEventHandler=function(typeName,id,eventHandlerName){if(Cocoon.App.nativeAvailable){var parentObject=window;parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventHandler(id,eventHandlerName)}};extension.callOriginProxyObjectEventListeners=function(typeName,id,eventTypeName){if(Cocoon.App.nativeAvailable){var parentObject=window;parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventListeners(id,eventTypeName)}};extension.setupDestinationProxyType=function(typeName,eventHandlerNames){if(Cocoon.App.nativeAvailable){var parentObject=window;parentObject[typeName]._cocoonjs_proxy_type_data={nextId:0,proxyObjects:{},eventHandlerNames:eventHandlerNames}}};extension.takedownDestinationProxyType=function(typeName){if(Cocoon.App.nativeAvailable){var parentObject=window;if(parent[typeName]&&parentObject[typeName]._cocoonjs_proxy_type_data){delete parentObject[typeName]._cocoonjs_proxy_type_data}}};extension.newDestinationProxyObject=function(typeName){if(Cocoon.App.nativeAvailable){var parentObject=window;var proxyObject=new parentObject[typeName];proxyObject._cocoonjs_proxy_object_data={};proxyObject._cocoonjs_proxy_object_data.typeName=typeName;var proxyObjectId=parentObject[typeName]._cocoonjs_proxy_type_data.nextId;parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[proxyObjectId]=proxyObject;proxyObject._cocoonjs_proxy_object_data.id=proxyObjectId;parentObject[typeName]._cocoonjs_proxy_type_data.nextId++;for(var i=0;i<parentObject[typeName]._cocoonjs_proxy_type_data.eventHandlerNames.length;i++){(function(eventHandlerName){proxyObject[eventHandlerName]=function(event){var proxyObject=this;var jsCode="Cocoon.App.callOriginProxyObjectEventHandler("+JSON.stringify(proxyObject._cocoonjs_proxy_object_data.typeName)+", "+proxyObject._cocoonjs_proxy_object_data.id+", "+JSON.stringify(eventHandlerName)+");";Cocoon.App.forwardAsync(jsCode)}})(parentObject[typeName]._cocoonjs_proxy_type_data.eventHandlerNames[i])}proxyObject._cocoonjs_proxy_object_data.eventListeners={};return proxyObjectId}};extension.callDestinationProxyObjectFunction=function(typeName,id,functionName){if(Cocoon.App.nativeAvailable){var parentObject=window;var argumentsArray=Array.prototype.slice.call(arguments);argumentsArray.splice(0,3);var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];var result=proxyObject[functionName].apply(proxyObject,argumentsArray);return result}};extension.setDestinationProxyObjectAttribute=function(typeName,id,attributeName,attributeValue){if(Cocoon.App.nativeAvailable){var parentObject=window;
var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];proxyObject[attributeName]=attributeValue}};extension.getDestinationProxyObjectAttribute=function(typeName,id,attributeName){if(Cocoon.App.nativeAvailable){var parentObject=window;var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];return proxyObject[attributeName]}};extension.deleteDestinationProxyObject=function(typeName,id){if(Cocoon.App.nativeAvailable){var parentObject=window;delete parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id]}};extension.addDestinationProxyObjectEventListener=function(typeName,id,eventTypeName){if(Cocoon.App.nativeAvailable){var parentObject=window;var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];var callback=function(event){var proxyObject=this;var jsCode="Cocoon.Proxify.callOriginProxyObjectEventListeners("+JSON.stringify(proxyObject._cocoonjs_proxy_object_data.typeName)+", "+proxyObject._cocoonjs_proxy_object_data.id+", "+JSON.stringify(eventTypeName)+");";Cocoon.App.forwardAsync(jsCode)};proxyObject._cocoonjs_proxy_object_data.eventListeners[eventTypeName]=callback;proxyObject.addEventListener(eventTypeName,callback)}};extension.xhr=function(){var ATTRIBUTE_NAMES=["timeout","withCredentials","upload","status","statusText","responseType","response","responseText","responseXML","readyState"];var FUNCTION_NAMES=["open","setRequestHeader","send","abort","getResponseHeader","getAllResponseHeaders","overrideMimeType"];var EVENT_HANDLER_NAMES=["onloadstart","onprogress","onabort","onerror","onload","ontimeout","onloadend","onreadystatechange"];Cocoon.Proxify.setupOriginProxyType("XMLHttpRequest",ATTRIBUTE_NAMES,FUNCTION_NAMES,EVENT_HANDLER_NAMES)};extension.audio=function(){var ATTRIBUTE_NAMES=["src","loop","volume","preload"];var FUNCTION_NAMES=["play","pause","load","canPlayType"];var EVENT_HANDLER_NAMES=["onended","oncanplay","oncanplaythrough","onerror"];Cocoon.Proxify.setupOriginProxyType("Audio",ATTRIBUTE_NAMES,FUNCTION_NAMES,EVENT_HANDLER_NAMES)};extension.console=function(){if(!Cocoon.nativeAvailable)return;if(typeof Cocoon.originalConsole==="undefined"){Cocoon.originalConsole=window.console}var functions=["log","error","info","debug","warn"];var newConsole={};for(var i=0;i<functions.length;i++){newConsole[functions[i]]=function(functionName){return function(message){try{var jsCode="Proxified log: "+JSON.stringify(message);Cocoon.originalConsole.log(jsCode);ext.IDTK_APP.makeCallAsync("forward",jsCode)}catch(e){console.log("Proxified log: "+e)}}}(functions[i])}if(!newConsole.assert){newConsole.assert=function assert(){if(arguments.length>0&&!arguments[0]){var str="Assertion failed: "+(arguments.length>1?arguments[1]:"");newConsole.error(str)}}}window.console=newConsole};extension.deproxifyConsole=function(){if(window.navigator.isCocoonJS||!Cocoon.nativeAvailable)return;if(typeof Cocoon.originalConsole!=="undefined"){window.console=Cocoon.originalConsole;Cocoon.originalConsole=undefined}};return extension});Cocoon.define("Cocoon.Device",function(extension){"use strict";extension.DeviceInfo={os:null,version:null,dpi:null,brand:null,model:null,imei:null,platformId:null,odin:null,openudid:null};extension.getDeviceId=function(){if(Cocoon.nativeAvailable){return window.ext.IDTK_APP.makeCall("getDeviceId")}};extension.getDeviceInfo=function(){if(Cocoon.nativeAvailable){return window.ext.IDTK_APP.makeCall("getDeviceInfo")}};extension.getOrientation=function(){if(Cocoon.nativeAvailable){return window.ext.IDTK_APP.makeCall("getPreferredOrientation")}else{return 0}};extension.setOrientation=function(preferredOrientation){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("setPreferredOrientation",preferredOrientation)}};extension.Orientations={PORTRAIT:1,PORTRAIT_UPSIDE_DOWN:2,LANDSCAPE_LEFT:4,LANDSCAPE_RIGHT:8,LANDSCAPE:4|8,BOTH:1|2|4|8};extension.autoLock=function(enabled){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","setAutoLockEnabled",arguments)}};return extension});Cocoon.define("Cocoon.Motion",function(extension){"use strict";extension.nativeAvailable=Cocoon.nativeAvailable;extension.setAccelerometerInterval=function(updateIntervalInSeconds){if(Cocoon.Motion.nativeAvailable){return window.ext.IDTK_APP.makeCall("setAccelerometerUpdateIntervalInSeconds",updateIntervalInSeconds)}};extension.getAccelerometerInterval=function(){if(Cocoon.Motion.nativeAvailable){return window.ext.IDTK_APP.makeCall("getAccelerometerUpdateIntervalInSeconds")}};extension.setGyroscopeInterval=function(updateIntervalInSeconds){if(Cocoon.Motion.nativeAvailable){return window.ext.IDTK_APP.makeCall("setGyroscopeUpdateIntervalInSeconds",updateIntervalInSeconds)}};extension.getGyroscopeInterval=function(){if(Cocoon.Motion.nativeAvailable){window.ext.IDTK_APP.makeCall("getGyroscopeUpdateIntervalInSeconds")}};return extension});Cocoon.define("Cocoon.Touch",function(extension){extension.addADivToDisableInput=function(){var div=document.createElement("div");div.id="CocoonJSInputBlockingDiv";div.style.left=0;div.style.top=0;div.style.width="100%";div.style.height="100%";div.style.position="absolute";div.style.backgroundColor="transparent";div.style.border="0px solid #000";div.style.zIndex=999999999;document.body.appendChild(div)};extension.removeTheDivToEnableInput=function(){var div=document.getElementById("CocoonJSInputBlockingDiv");if(div)document.body.removeChild(div)};extension.disable=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("disableTouchLayer","CocoonJSView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.App.forwardEventsToCocoonJSEnabled=false;Cocoon.App.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.disable();")}}};extension.enable=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("enableTouchLayer","CocoonJSView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.App.forwardEventsToCocoonJSEnabled=true;Cocoon.App.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.enable();")}}};extension.disableInWebView=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("disableTouchLayer","WebView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.Touch.addADivToDisableInput()}else{Cocoon.App.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.disableInWebView();")}}};extension.enableInWebView=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("enableTouchLayer","WebView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.Touch.removeTheDivToEnableInput()}else{Cocoon.Touch.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.enableInWebView();")}}};return extension});Cocoon.define("Cocoon.Widget",function(extension){"use strict";extension.WebDialog=function(){if(Cocoon.App.nativeAvailable){this.webDialogID=window.ext.IDTK_APP.makeCall("createWebDialog")}else{var iframe=document.createElement("iframe");iframe.id="CocoonJSWebDialogIFrame";iframe.name="CocoonJSWebDialogIFrame";iframe.style.cssText="position:fixed;left:0;top:0;bottom:0;right:0; width:100%; height:100%;margin:0;padding:0;";var me=this;iframe.onload=function(){me.iframeloaded=true;var js="Cocoon = {}; Cocoon.Widget = {}; Cocoon.Widget.WebDialog = {} Cocoon.Widget.WebDialog.close = function()"+"{"+"   window.parent.CocoonJSCloseWebDialog();"+"};";me.evalIframe(js);for(var i=0;i<me.pendingEvals.length;++i){me.evalIframe(me.pendingEvals[i])}me.pendingEvals=[]};iframe.onerror=function(){me.close()};this.iframe=iframe;this.pendingEvals=[];window.CocoonJSCloseWebDialog=function(){me.close()}}};extension.WebDialog.prototype={show:function(url,callback){this.closeCallback=function(){Cocoon.Touch.enable();if(callback)callback()};if(Cocoon.App.nativeAvailable){Cocoon.Touch.disable();return window.ext.IDTK_APP.makeCallAsync("showWebDialog",this.webDialogID,url,this.closeCallback)}else{this.iframe.src=url;document.body.appendChild(this.iframe)}},close:function(){if(Cocoon.App.nativeAvailable){return window.ext.IDTK_APP.makeCallAsync("closeWebDialog",this.webDialogID)}else{if(this.iframe.parentNode){this.iframe.parentNode.removeChild(this.iframe)}}if(this.closeCallback)this.closeCallback()},evalIframe:function(js){window.frames["CocoonJSWebDialogIFrame"].eval(js)},eval:function(js){if(Cocoon.App.nativeAvailable){return window.ext.IDTK_APP.makeCallAsync("evalWebDialog",this.webDialogID,js)}else{if(this.iframeloaded)this.evalIframe(js);else this.pendingEvals.push(js)}}};return extension});Cocoon.define("Cocoon.Camera",function(extension){navigator.getUserMedia_=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;extension.CameraType={FRONT:"FRONT",BACK:"BACK"};extension.CaptureFormatType={JPEG:"JPEG",RGB_565:"RGB_565",NV21:"NV21",NV16:"NV16",YUY2:"YUY2",YV12:"YV12",BGRA32:"32BGRA"};extension.CameraInfo={cameraIndex:0,cameraType:extension.CameraType.BACK,supportedVideoSizes:[],supportedVideoFrameRates:[],supportedVideoCaptureImageFormats:[]};extension.getNumberOfCameras=function(){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getNumberOfCameras",arguments)}else{return navigator.getUserMedia_?1:0}};extension.getAllCamerasInfo=function(){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getAllCamerasInfo",arguments)}};extension.getCameraInfoByIndex=function(cameraIndex){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getCameraInfoByIndex",arguments)}};extension.getCameraInfoByType=function(cameraType){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getCameraInfoByType",arguments)}};extension.start=function(params){if(!(Boolean(params.success)&&Boolean(params.error)))throw new Error("Missing callbacks for Cocoon.Camera.start();");if(Cocoon.nativeAvailable){var properties={cameraIndex:0,width:50,height:50,frameRate:25};var args=Cocoon.clone(properties,params);var img=Cocoon.callNative("IDTK_SRV_CAMERA","startCapturing",args);if(Boolean(img)){params.success(img)}else{params.error(false)}}else{navigator.getUserMedia_({video:true,audio:false},function(stream){params.success(stream)},function(error){params.error(error)})}};extension.stop=function(cameraIndex){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","stopCapturing",arguments)}};extension.isCapturing=function(cameraIndex){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","isCapturing",arguments)}};return extension});Cocoon.define("Cocoon.Ad",function(extension){"use strict";extension.nativeAvailable=!!Cocoon.nativeAvailable&&!!window.ext.IDTK_SRV_AD;extension.BannerLayout={TOP_CENTER:"TOP_CENTER",BOTTOM_CENTER:"BOTTOM_CENTER"};extension.Rectangle=function(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height};extension.Banner=function(id){if(typeof id!=="number")throw"The given ad ID is not a number.";this.id=id;var me=this;this.onBannerShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannershow",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onBannerHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerhide",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onBannerReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerready",function(sourceListener,args){if(me.id===args[0]){sourceListener(args[1],args[2])}});var signal=new Cocoon.Signal.createSignal;signal.register("ready",this.onBannerReady);signal.register("shown",this.onBannerShown);signal.register("hidden",this.onBannerHidden);this.on=signal.expose()};extension.Banner.prototype={showBanner:function(){if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","showBanner",[this.id],true)}},hideBanner:function(){if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","hideBanner",[this.id],true)}},load:function(){if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","refreshBanner",[this.id],true)}},getRectangle:function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","getRectangle",[this.id])}},setRectangle:function(rect){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setRectangle",[this.id,rect])}},setBannerLayout:function(bannerLayout){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setBannerLayout",[this.id,bannerLayout])}}};extension.Interstitial=function(id){if(typeof id!=="number")throw"The given ad ID is not a number.";this.id=id;var me=this;this.onFullScreenShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenshow",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onFullScreenHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenhide",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onFullScreenReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenready",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});var signal=new Cocoon.Signal.createSignal;signal.register("ready",this.onFullScreenReady);signal.register("shown",this.onFullScreenShown);signal.register("hidden",this.onFullScreenHidden);this.on=signal.expose()};extension.Interstitial.prototype={showInterstitial:function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","showFullScreen",[this.id],true)}},refreshInterstitial:function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","refreshFullScreen",[this.id],true)}}};extension.configure=function(parameters){if(typeof parameters==="undefined"){parameters={}}if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","requestInitialization",arguments,true)}};extension.createBanner=function(parameters){if(typeof parameters==="undefined"){parameters={}}if(Cocoon.Ad.nativeAvailable){var adId=Cocoon.callNative("IDTK_SRV_AD","createBanner",[parameters]);var banner=new extension.Banner(adId);return banner}};extension.releaseBanner=function(banner){if(typeof banner==="undefined"){throw"The banner ad object to be released is undefined"}if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","releaseBanner",[banner.id])}};extension.createInterstitial=function(parameters){if(typeof parameters==="undefined"){parameters={}}if(Cocoon.Ad.nativeAvailable){var adId=Cocoon.callNative("IDTK_SRV_AD","createFullscreen",[parameters]);var fullscreen=new Cocoon.Ad.Interstitial(adId);return fullscreen}};extension.releaseInterstitial=function(fullscreen){if(!fullscreen){throw"The fullscreen ad object to be released is undefined"}if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","releaseFullscreen",[fullscreen.id])}};extension.showBanner=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","showBanner",arguments,true)}};extension.hideBanner=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","hideBanner",arguments,true)}};extension.refreshBanner=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","refreshBanner",arguments,true)}};extension.showInterstitial=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","showFullScreen",arguments,true)}};extension.refreshInterstitial=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","refreshFullScreen",arguments,true)}};extension.preloadedBanner=false;extension.loadBanner=function(){if(Cocoon.Ad.nativeAvailable){if(Cocoon.Ad.preloadedBanner){return Cocoon.Ad.refreshBanner()}else{Cocoon.Ad.preloadedBanner=true;return Cocoon.callNative("IDTK_SRV_AD","preloadBanner",arguments,true)}}};extension.preloadedInterstitial=false;extension.loadInterstitial=function(){if(Cocoon.Ad.nativeAvailable){if(Cocoon.Ad.preloadedInterstitial){return Cocoon.Ad.refreshInterstitial()}else{Cocoon.Ad.preloadedInterstitial=true;return Cocoon.callNative("IDTK_SRV_AD","preloadFullScreen",arguments,true)}}};extension.setRectangle=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setRectangle",arguments)}};extension.getRectangle=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","getRectangle",arguments)}};extension.setBannerLayout=function(bannerLayout){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setBannerLayout",arguments)}};extension.onBannerShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannershow");extension.onBannerHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerhide");extension.onBannerReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerready");extension.onFullScreenShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenshow");extension.onFullScreenHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenhide");extension.onFullScreenReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenready");var signal=new Cocoon.Signal.createSignal;signal.register("ready",extension.onBannerReady);signal.register("shown",extension.onBannerShown);signal.register("hidden",extension.onBannerHidden);extension.banner={};extension.banner.on=signal.expose();var signal=new Cocoon.Signal.createSignal;signal.register("ready",extension.onFullScreenReady);signal.register("shown",extension.onFullScreenShown);signal.register("hidden",extension.onFullScreenHidden);extension.interstitial={};extension.interstitial.on=signal.expose();return extension});Cocoon.define("Cocoon.Store",function(extension){"use strict";extension.nativeAvailable=!!Cocoon.nativeAvailable&&!!window.ext.IDTK_SRV_STORE;extension.ProductInfo={productId:"productId",productAlias:"productAlias",productType:"productType",title:"title",description:"description",price:"price",localizedPrice:"localizedPrice",downloadURL:"downloadURL"};extension.ProductType={CONSUMABLE:0,NON_CONSUMABLE:1,AUTO_RENEWABLE_SUBSCRIPTION:2,FREE_SUBSCRIPTION:3,NON_RENEWABLE_SUBSCRIPTION:4};extension.StoreType={APP_STORE:0,PLAY_STORE:1,MOCK_STORE:2,CHROME_STORE:3,AMAZON_STORE:4,NOOK_STORE:5};extension.PurchaseInfo=function(transactionId,purchaseTime,purchaseState,productId,quantity){this.transactionId=transactionId;this.purchaseTime=purchaseTime;this.purchaseState=purchaseState;this.productId=productId;this.quantity=quantity;return this};extension.PurchaseState={PURCHASED:0,CANCELED:1,REFUNDED:2,EXPIRED:3};extension.getStoreType=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","getStoreType",arguments)}else{return false}};extension.initialize=function(params){params=params||{};var properties={sandbox:false,managed:true};var args=Cocoon.clone(properties,params);Cocoon.Store.requestInitialization({sandbox:args[0],managed:args[1]});Cocoon.Store.start()};extension.requestInitialization=function(parameters){if(typeof parameters==="undefined"){parameters={}}else{if(parameters["managed"]!==undefined)parameters["remote"]=parameters["managed"];if(parameters["sandbox"]!==undefined)parameters["debug"]=parameters["sandbox"]}if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","requestInitialization",arguments,true)}};extension.start=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","start",arguments)}};extension.canPurchase=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","canPurchase",arguments)}else{return false}};extension.fetchProductsFromServer=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","fetchProductsFromServer",arguments,true)}};extension.loadProducts=function(productIds){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","fetchProductsFromStore",arguments,true)}};extension.finish=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","finishPurchase",arguments,true)}};extension.consume=function(transactionId,productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","consumePurchase",arguments,true)}};extension.purchase=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","purchaseFeature",arguments,true)}};extension.puchaseProductModal=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","purchaseFeatureModal",arguments,true)}};extension.purchaseProductModalWithPreview=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","purchaseFeatureModalWithPreview",arguments,true)}};extension.isProductPurchased=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","isFeaturePurchased",arguments)}};extension.restore=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","restorePurchases",arguments,true)}};extension.restorePurchasesModal=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","restorePurchasesModal",arguments,true)}};extension.getProducts=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","getProducts",arguments)}};extension.addProduct=function(product){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","addProduct",arguments)}};extension.removeProduct=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","removeProduct",arguments)}};extension.getPurchases=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","getPurchases",arguments)}};extension.addPurchase=function(purchase){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","addPurchase",arguments)}};extension.removePurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","removePurchase",arguments)}};extension.cancelPurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","cancelPurchase",arguments)}};extension.refundPurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","refundPurchase",arguments)}};extension.expirePurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","expirePurchase",arguments)}};extension.onProductsFetchStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductsFetchStarted");extension.onProductsFetchCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductsFetchCompleted");extension.onProductsFetchFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductsFetchFailed");extension.onProductPurchaseStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseStarted");extension.onProductPurchaseVerificationRequestReceived=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseVerificationRequestReceived");extension.onProductPurchaseCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseCompleted");extension.onProductPurchaseFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseFailed");extension.onRestorePurchasesStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onRestorePurchasesStarted");extension.onRestorePurchasesCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onRestorePurchasesCompleted");extension.onRestorePurchasesFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onRestorePurchasesFailed");extension.onConsumePurchaseStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onConsumePurchaseStarted");extension.onConsumePurchaseCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onConsumePurchaseCompleted");extension.onConsumePurchaseFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onConsumePurchaseFailed");var signal=new Cocoon.Signal.createSignal;signal.register("load",{started:extension.onProductsFetchStarted,success:extension.onProductsFetchCompleted,error:extension.onProductsFetchFailed});signal.register("purchase",{started:extension.onProductPurchaseStarted,success:extension.onProductPurchaseCompleted,verification:extension.onProductPurchaseVerificationRequestReceived,error:extension.onProductPurchaseFailed});signal.register("consume",{started:extension.onConsumePurchaseStarted,success:extension.onConsumePurchaseCompleted,error:extension.onConsumePurchaseFailed});signal.register("restore",{started:extension.onRestorePurchasesStarted,success:extension.onRestorePurchasesCompleted,error:extension.onRestorePurchasesFailed});extension.on=signal.expose();return extension});Cocoon.define("Cocoon.Notification",function(extension){extension.nativeAvailable=!!window.ext&&!!window.ext.IDTK_SRV_NOTIFICATION;extension.Local={};extension.Push={};extension.Local.create=function(params){var properties={message:"",soundEnabled:true,badgeNumber:0,userData:{},contentBody:"",contentTitle:"",date:(new Date).valueOf()+1e3};var args=Cocoon.clone(properties,params);if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","createLocalNotification",args)}};extension.Push.create=function(params){var properties={message:"",soundEnabled:true,badgeNumber:0,userData:{},channels:[],expirationTime:0,expirationTimeInterval:0};for(var prop in properties){if(!params[prop]){params[prop]=properties[prop]}}return params};extension.start=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","start",arguments)}};extension.Push.register=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","registerForPushNotifications",arguments,true)}};extension.Push.unregister=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","unregisterForPushNotifications",arguments,true)}};extension.Local.cancel=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","cancelLocalNotification",arguments)}};extension.Local.cancelLast=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","cancelLocalNotification",arguments,true)}};extension.Local.cancelAllNotifications=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","cancelAllLocalNotifications",arguments)}};extension.Local.send=function(localNotification){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","sendLocalNotification",arguments,true)}};extension.subscribe=function(channel){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","subscribe",arguments,true)}};extension.unsubscribe=function(channel){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","unsubscribe",arguments,true)}};extension.Push.send=function(pushNotification){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","sendPushNotification",arguments,true)}};extension.setBadgeNumber=function(badgeNumber){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","setBadgeNumber",arguments)}};extension.getBadgeNumber=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","getBadgeNumber",arguments)}};extension.Local.getLastNotificationData=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","getLastReceivedLocalNotificationData",arguments)}};extension.Push.getLastNotificationData=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","getLastReceivedPushNotificationData",arguments)}};extension.onRegisterForPushNotificationsSucceed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationServiceRegistered");extension.onUnregisterForPushNotificationsSucceed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationServiceUnregistered");extension.onRegisterForPushNotificationsFailed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationServiceFailedToRegister");extension.onPushNotificationReceived=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationReceived");extension.onLocalNotificationReceived=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","localNotificationReceived");extension.onPushNotificationDeliverySucceed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationSuccessfullyDelivered");extension.onPushNotificationDeliveryFailed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationDeliveryError");var signal=new Cocoon.Signal.createSignal;signal.register("notification",{received:extension.onLocalNotificationReceived});extension.Local.on=signal.expose();var signal=new Cocoon.Signal.createSignal;signal.register("register",{success:extension.onRegisterForPushNotificationsSucceed,unregister:extension.onUnregisterForPushNotificationsSucceed,error:extension.onRegisterForPushNotificationsFailed});signal.register("notification",{received:extension.onPushNotificationReceived});signal.register("deliver",{success:extension.onPushNotificationDeliverySucceed,error:extension.onPushNotificationDeliveryFailed});extension.Push.on=signal.expose();return extension});Cocoon.define("Cocoon.Social",function(extension){extension.Interface=function(){this.onLoginStatusChanged=new Cocoon.EventHandler("","dummy","onLoginStatusChanged");var signal=new Cocoon.Signal.createSignal;signal.register("loginStatusChanged",this.onLoginStatusChanged);this.on=signal.expose();return this};extension.Interface.prototype={isLoggedIn:function(){return false},login:function(callback){if(callback)callback(false,{message:"Not implemented!"})},logout:function(callback){if(callback)callback({message:"Not implemented!"})},getLoggedInUser:function(){return null},hasPublishPermissions:function(callback){callback(true)},requestPublishPermissions:function(callback){if(callback)callback(true,null)},requestUser:function(callback,userID){callback(null,{message:"Not implemented!"})},requestUserImage:function(callback,userID,imageSize){callback("",{message:"Not implemented!"})},requestFriends:function(callback,userID){callback([],{message:"Not implemented!"})},publishMessage:function(message,callback){callback({message:"Not implemented!"})},publishMessageWithDialog:function(message,callback){callback({message:"Not implemented!"})}};extension.SocialGamingService=function(){Cocoon.Social.SocialGamingService.superclass.constructor.call(this);return this};extension.SocialGamingService.prototype={_cachedAchievements:null,_achievementsMap:null,_leaderboardsTemplate:null,_achievementsTemplate:null,requestScore:function(callback,params){callback(null,{message:"Not implemented!"})},submitScore:function(score,callback,params){if(callback)callback({message:"Not implemented!"})},showLeaderboard:function(callback,params){if(callback)callback({message:"Not implemented!"})},requestAllAchievements:function(callback){callback([],{message:"Not implemented!"})},requestAchievements:function(callback,userID){callback([],{message:"Not implemented!"})},submitAchievement:function(achievementID,callback){if(callback)callback({message:"Not implemented!"})},resetAchievements:function(callback){if(callback)callback([],{message:"Not implemented!"})},showAchievements:function(callback){if(!this._achievementsTemplate)throw"Please, provide a html template for achievements with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._achievementsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;this.requestAchievements(function(achievements,error){if(dialog.closed)return;
if(error){callbackSent=true;if(callback)callback(error);return}var achs=[];if(me._cachedAchievements){for(var i=0;i<me._cachedAchievements.length;++i){var ach=me._cachedAchievements[i];achs.push(ach);if(achievements&&achievements.length){for(var j=0;j<achievements.length;++j){if(achievements[j].achievementID===ach.achievementID){ach.achieved=true;break}}}}}var js="addAchievements("+JSON.stringify(achs)+");";dialog.eval(js)})},setAchievementsMap:function(map){this._achievementsMap=map;if(this._cachedAchievements){this.syncAchievementsMap(this._cachedAchievements)}},setTemplates:function(leaderboardsTemplate,achievementsTemplate){this._leaderboardsTemplate=leaderboardsTemplate;this._achievementsTemplate=achievementsTemplate},setCachedAchievements:function(achievements){this._cachedAchievements=achievements;if(achievements&&this._achievementsMap){this.syncAchievementsMap(this._cachedAchievements)}},findAchievement:function(id){if(!this._cachedAchievements)return null;for(var i=0;i<this._cachedAchievements.length;++i){if(id===this._cachedAchievements[i].achievementID){return this._cachedAchievements[i]}}return null},translateAchievementID:function(id){if(this._achievementsMap){for(var customID in this._achievementsMap){if(customID==id){return this._achievementsMap[customID]}}}return id},syncAchievementsMap:function(achievements){if(!this._achievementsMap)return;for(var i=0;i<achievements.length;++i){for(var customID in this._achievementsMap){if(this._achievementsMap[customID]===achievements[i].achievementID){achievements[i].customID=customID}}}}};Cocoon.extend(extension.SocialGamingService,extension.Interface);extension.ImageSize={THUMB:"thumb",SMALL:"small",MEDIUM:"medium",LARGE:"large"};extension.User=function(userID,userName,userImage){this.userID=userID;this.userName=userName;this.userImage=userImage;return this};extension.Message=function(message,mediaURL,linkURL,linkText,linkCaption){this.message=message;this.mediaURL=mediaURL;this.linkURL=linkURL;this.linkText=linkText;this.linkCaption=linkCaption;return this};extension.Score=function(userID,score,userName,imageURL,leaderboardID){this.userID=userID;this.score=score||0;this.userName=userName;this.imageURL=imageURL;this.leaderboardID=leaderboardID;return this};extension.ScoreParams=function(userID,leaderboardID,friends,timeScope){this.userID=userID;this.leaderboardID=leaderboardID;this.friends=!!friends;this.timeScope=timeScope||2};extension.TimeScope={ALL_TIME:0,WEEK:1,TODAY:2};extension.Achievement=function(achievementID,title,description,imageURL,points){this.achievementID=achievementID;this.customID=achievementID;this.title=title;this.description=description;this.imageURL=imageURL;this.points=points||0;return this};extension.share=function(textToShare){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","share",arguments,true)}else{}};return extension});Cocoon.define("Cocoon.Social",function(extension){extension.ManagerService=function(){this.services=[]};extension.ManagerService.prototype={services:null,registerSocialService:function(service){this.services.push(service)},submitAchievement:function(achievementID){for(var i=0;i<this.services.length;++i){var service=this.services[i];if(!service.readOnlyHint&&service.isLoggedIn()){service.submitAchievement(achievementID,function(error){if(error)console.error("Error submitting achievement: "+error.message)})}}},submitScore:function(score,params){for(var i=0;i<this.services.length;++i){var service=this.services[i];if(!service.readOnlyHint&&service.isLoggedIn()){service.submitScore(score,function(error){if(error)console.error("Error submitting score: "+error.message)},params)}}},getLoggedInServices:function(){var result=[];for(var i=0;i<this.services.length;++i){var service=this.services[i];if(!service.fakeSocialService&&service.isLoggedIn()){result.push(service)}}return result},isLoggedInAnySocialService:function(){return this.getLoggedInServices().length>0}};extension.Manager=new extension.ManagerService;return extension});Cocoon.define("Cocoon.Social",function(extension){extension.LocalStorageService=function(){Cocoon.Social.LocalStorageService.superclass.constructor.call(this);this.fakeSocialService=true};extension.LocalStorageService.prototype={loggedIn:false,keys:{score:"Cocoon.Social.LocalStorageService.score",earnedAchievements:"Cocoon.Social.LocalStorageService.earned"},isLoggedIn:function(){return this.loggedIn},login:function(callback){if(!this.loggedIn)this.onLoginStatusChanged.notifyEventListeners(true);this.loggedIn=true;if(callback)setTimeout(function(){callback(true)},0)},logout:function(callback){if(this.loggedIn)this.onLoginStatusChanged.notifyEventListeners(true);this.loggedIn=false;if(callback)setTimeout(function(){callback()},0)},getLoggedInUser:function(){return new Cocoon.Social.User("me","LocalStorage")},requestUser:function(callback,userID){var user=new Cocoon.Social.User(userID||"me","LocalStorage");if(callback)setTimeout(function(){callback(user)},0)},requestScore:function(callback,params){var scoreItem=localStorage.getItem(this.keys.score);var score=parseInt(scoreItem)||0;setTimeout(function(){callback(new Cocoon.Social.Score("me",score))},0)},submitScore:function(score,callback,params){var scoreItem=localStorage.getItem(this.keys.score);var topScore=parseInt(scoreItem)||0;if(score>topScore)localStorage.setItem(this.keys.score,score);if(callback)setTimeout(function(){callback()},0)},getLocalStorageEarnedAchievements:function(){var achievementsItem=localStorage.getItem(this.keys.earnedAchievements);var earned=[];if(achievementsItem){var array=JSON.stringify(achievementsItem);if(array&&array.length){earned=array}}return earned},requestAchievements:function(callback,userID){var earned=this.getLocalStorageEarnedAchievements();setTimeout(function(){callback(earned)},0)},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var earned=this.getLocalStorageEarnedAchievements();var exists=false;for(var i=0;i<earned.length;++i){if(earned[i]===achievementID){exists=true;break}}if(!exists){earned.push(achievementID);localStorage.setItem(this.keys.earnedAchievements,JSON.stringify(earned))}if(callback)setTimeout(function(){callback()},0)},resetAchievements:function(callback){localStorage.removeItem(this.keys.earnedAchievements);if(callback)setTimeout(function(){callback()},0)}};Cocoon.extend(extension.LocalStorageService,extension.SocialGamingService);extension.LocalStorage=new extension.LocalStorageService;return extension});Cocoon.define("Cocoon.Social",function(extension){extension.GooglePlayGamesExtension=function(){this.nativeExtensionName="IDTK_SRV_GOOGLE_PLAY_GAMES";this.extensionName="Social.GooglePlayGames";this.nativeAvailable=Cocoon.nativeAvailable&&typeof window.ext[this.nativeExtensionName]!=="undefined";this.auth=new Cocoon.Social.GooglePlayGamesAuthExtension(this);this.client=new Cocoon.Social.GooglePlayGamesClientExtension(this);this.defaultScopes=["https://www.googleapis.com/auth/games","https://www.googleapis.com/auth/plus.login"];this.gamesAPI="/games/v1";this.plusAPI="/plus/v1";this.onSessionChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onSessionChanged");Cocoon.Social.GooglePlayGames=this;var me=this;this.onSessionChanged.addEventListener(function(session,error){me.token=fromSessionToAuthTokenObject(session,error);if(session&&session.access_token){me.client.request({path:me.gamesAPI+"/players/me",callback:function(response){me.currentPlayer=response}})}});return this};extension.GooglePlayGamesExtension.prototype={token:null,settings:{},socialService:null,currentPlayer:null,initialized:false,auth:null,client:null,init:function(params){if(!params||typeof params!=="object")throw"Invalid params argument";this.settings=params;this.initialized=true;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"init",[this.settings.clientId],true)}else{var me=this;var initWebAPi=function(){gapi.auth.authorize({immediate:true,scope:me.defaultScopes,client_id:me.settings.clientId},function(response){me.token=response;if(response&&response.access_token){me.onSessionChanged.notifyEventListeners(response)}})};if(!window.gapi){window.onGapiLoadCallback=function(){window.setTimeout(initWebAPi,1)};var script=document.createElement("script");script.src="https://apis.google.com/js/client.js?onload=onGapiLoadCallback";document.getElementsByTagName("head")[0].appendChild(script)}else{initWebAPi()}}},getSocialInterface:function(){if(!this.initialized){throw"You must call init() before getting the Social Interface"}if(!this.socialService){this.socialService=new Cocoon.Social.SocialGamingServiceGooglePlayGames(this)}return this.socialService},getMultiplayerInterface:function(){return Cocoon.Multiplayer.GooglePlayGames},share:function(){window.open(this.href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600");return false}};extension.GooglePlayGamesAuthExtension=function(extension){this.extension=extension;return this};extension.GooglePlayGamesAuthExtension.prototype={authorize:function(params,callback){var me=this;if(this.extension.nativeAvailable){Cocoon.callNative(this.extension.nativeExtensionName,"authorize",[params,function(response,error){me.extension.token=fromSessionToAuthTokenObject(response,error);if(callback){callback(me.extension.token)}}],true)}else{gapi.auth.authorize(params,function(response){me.extension.token=response;me.extension.onSessionChanged.notifyEventListeners(response,response?response.error:null);if(callback)callback(response)})}},disconnect:function(callback){if(this.extension.nativeAvailable){Cocoon.callNative(this.extension.nativeExtensionName,"disconnect",[callback],true)}else{if(callback)callback({error:"Not implemented yet"})}},init:function(callback){if(this.extension.nativeAvailable){callback()}else{gapi.auth.init(callback)}},getToken:function(){if(this.extension.nativeAvailable){return this.extension.token}else{return gapi.auth.getToken()}},setToken:function(token){if(this.extension.nativeAvailable){this.extension.token=token}else{gapi.auth.setToken(token)}}};extension.GooglePlayGamesClientExtension=function(extension){this.extension=extension;return this};extension.GooglePlayGamesClientExtension.prototype={setApiKey:function(apiKey){if(this.extension.nativeAvailable){Cocoon.callNative(this.extension.nativeExtensionName,"setApiKey",[apiKey],true)}else{gapi.client.setApiKey(apiKey)}},request:function(args){if(this.extension.nativeAvailable){if(args.callback){Cocoon.callNative(this.extension.nativeExtensionName,"request",[args,function(response,error){var result=response;if(error){result=response||{};result.error=error}args.callback(result)}],true);return null}else{var me=this;var httpRequest={execute:function(callback){Cocoon.callNative(me.extension.nativeExtensionName,"request",[args,function(response,error){var result=response;if(error){result=response||{};result.error=error}callback(result)}],true)}};return httpRequest}}else{return gapi.client.request(args)}}};extension.GooglePlayGames=new Cocoon.Social.GooglePlayGamesExtension;function fromSessionToAuthTokenObject(response,error){var obj=response||{};return{access_token:response.access_token,state:response.state,error:error,expires_in:response.expirationDate?response.expirationDate-Date.now():0,player_id:response.playerId}}extension.SocialGamingServiceGooglePlayGames=function(apiObject){Cocoon.Social.SocialGamingServiceGooglePlayGames.superclass.constructor.call(this);this.gapi=apiObject;var me=this;this.gapi.onSessionChanged.addEventListener(function(session){var obj=session||{};me.onLoginStatusChanged.notifyEventListeners(!!obj.access_token,obj.error)});return this};extension.SocialGamingServiceGooglePlayGames.prototype={isLoggedIn:function(){return this.gapi.token&&this.gapi.token.access_token?true:false},login:function(callback){var me=this;this.gapi.auth.authorize({client_id:this.gapi.settings.clientId,scope:this.gapi.defaultScopes},function(response){if(callback){callback(me.isLoggedIn(),response.error)}})},logout:function(callback){this.gapi.auth.disconnect(callback)},getLoggedInUser:function(){return this.gapi.currentPlayer?fromGPUserToCocoonUser(this.gapi.currentPlayer):null},requestUser:function(callback,userId){var playerId=userId||"me";this.gapi.client.request({path:this.gapi.gamesAPI+"/players/"+playerId,callback:function(response){var user=response&&!response.error?fromGPPlayerToCocoonUser(response):null;callback(user,response.error)}})},requestUserImage:function(callback,userID,imageSize){this.requestUser(function(user,error){if(user&&user.userImage){var pixelSize=fromImageSizeToGPSize(imageSize||Cocoon.Social.ImageSize.MEDIUM);if(user.userImage.indexOf("sz=")===-1){user.userImage+="?sz="+pixelSize}else{user.userImage=user.userImage.replace(/sz=\d+/g,"sz="+pixelSize)}}callback(user?user.userImage:null,error)},userID)},requestFriends:function(callback,userId){var params={orderBy:"best"};var playerId=userId||"me";this.gapi.client.request({path:this.gapi.plusAPI+"/people/"+playerId+"/people/visible",params:params,callback:function(response){if(response&&!response.error){var friends=[];for(var i=0;i<response.items.length;++i){friends.push(fromGPPersonToCocoonUser(response.items[i]))}callback(friends)}else{callback([],response?response.error:null)}}})},publishMessage:function(message,callback){if(callback)callback("Not supported... use publishMessageWithDialog method instead")},publishMessageWithDialog:function(message,callback){if(this.gapi.nativeAvailable){var params={prefilledText:message.message,mediaUrl:message.mediaURL,mediaTitle:message.linkCaption,mediaDescription:message.linkText,url:message.linkURL};Cocoon.callNative(this.gapi.nativeExtensionName,"shareMessage",[params,callback],true)}else{var me=this;var share=function(){var options={contenturl:"https://plus.google.com/pages/",contentdeeplinkid:"/pages",clientid:me.gapi.settings.clientId,cookiepolicy:"single_host_origin",prefilltext:message.message,calltoactionlabel:"CREATE",calltoactionurl:"http://plus.google.com/pages/create",calltoactiondeeplinkid:"/pages/create"};gapi.interactivepost.render("sharePost",options)};if(!gapi.interactivepost){var script=document.createElement("script");script.type="text/javascript";script.async=true;script.src="https://apis.google.com/js/plusone.js";script.onload=function(){share()};document.getElementsByTagName("head")[0].appendChild(script)}else{share()}}},requestScore:function(callback,params){params=params||{};var playerId=params.userID||"me";var leaderboardID=params.leaderboardID||this.gapi.settings.defaultLeaderboard;if(!leaderboardID)throw"leaderboardID not provided in the params. You can also set the default leaderboard in the init method";this.gapi.client.request({path:this.gapi.gamesAPI+"/players/"+playerId+"/leaderboards/"+leaderboardID+"/scores/ALL_TIME",callback:function(response){if(response&&response.error){callback(null,response.error)}else if(response&&response.items&&response.items.length>0){var item=response.items[0];var data=new Cocoon.Social.Score(playerId,item.scoreValue,"","",item.leaderboard_id);callback(data,null)}else{callback(null,null)}}})},submitScore:function(score,callback,params){params=params||{};var leaderboardID=params.leaderboardID||this.gapi.settings.defaultLeaderboard;if(!leaderboardID)throw"leaderboardID not provided in the params. You can also set the default leaderboard in the init method";this.gapi.client.request({path:this.gapi.gamesAPI+"/leaderboards/"+leaderboardID+"/scores",method:"POST",params:{score:score},callback:function(response){if(callback){callback(response?response.error:null)}}})},showLeaderboard:function(callback,params){params=params||{};var leaderboardID=params.leaderboardID||this.gapi.settings.defaultLeaderboard;if(!leaderboardID)throw"leaderboardID not provided in the params. You can also set the default leaderboard in the init method";var ios=/(iPad|iPhone|iPod)/gi.test(navigator.userAgent);if(!ios&&this.gapi.nativeAvailable){var timeScope=params.timeScope||0;Cocoon.callNative(this.gapi.nativeExtensionName,"showLeaderboard",[leaderboardID,timeScope,callback],true)}else{if(!this._leaderboardsTemplate)throw"Please, provide a html template for leaderboards with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._leaderboardsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;var collection=params.friends?"SOCIAL":"PUBLIC";var timeSpan="ALL_TIME";if(params.timeScope===Cocoon.Social.TimeScope.WEEK){timeSpan="WEEKLY"}else if(params.timeScope===Cocoon.Social.TimeScope.TODAY){timeSpan="DAILY"}this.gapi.client.request({path:this.gapi.gamesAPI+"/leaderboards/"+leaderboardID+"/window/"+collection,method:"GET",params:{timeSpan:timeSpan},callback:function(response){if(dialog.closed)return;if(response.error){if(callback){callbackSent=true;callback(response.error);dialog.close()}return}var scores=[];var items=[];if(response&&response.items){items=response.items.slice(0)}if(response&&response.playerScore){items.push(response.playerScore)}for(var i=0;i<items.length;++i){var item=items[i];var score=fromGPScoreToCocoonScore(item,leaderboardID);score.imageURL+="?sz=50";score.position=item.scoreRank||i+1;score.me=false;scores.push(score)}var js="addScores("+JSON.stringify(scores)+")";dialog.eval(js)}})}},prepareAchievements:function(reload,callback){if(!this._cachedAchievements||reload){var me=this;this.gapi.client.request({path:this.gapi.gamesAPI+"/achievements",callback:function(response){if(response&&!response.error){var achievements=[];if(response&&response.items){for(var i=0;i<response.items.length;i++){achievements.push(fromGPAchievementToCocoonAchievement(response.items[i]))}}me.setCachedAchievements(achievements);callback(achievements,null)}else{callback([],response?response.error:null)}}})}else{callback(this._cachedAchievements,null)}},requestAllAchievements:function(callback){this.prepareAchievements(true,callback)},requestAchievements:function(callback,userID){var me=this;this.prepareAchievements(false,function(allAchievements,error){if(error){callback([],error);return}var playerID=userID||"me";me.gapi.client.request({path:me.gapi.gamesAPI+"/players/"+playerID+"/achievements",params:{state:"UNLOCKED"},callback:function(response){if(response&&!response.error){var achievements=[];if(response.items){for(var i=0;i<response.items.length;i++){var ach=me.findAchievement(response.items[i].id);if(ach)achievements.push(ach)}}callback(achievements,null)}else{callback([],response?response.error:null)}}})})},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var achID=this.translateAchievementID(achievementID);if(this.gapi.nativeAvailable){var showNotification=!!this.gapi.settings.showAchievementNotifications;Cocoon.callNative(this.gapi.nativeExtensionName,"unlockAchievement",[achID,showNotification,callback],true)}else{this.gapi.client.request({path:this.gapi.gamesAPI+"/achievements/"+achID+"/unlock",method:"POST",callback:function(response){if(callback){callback(response?response.error:null)}}})}},resetAchievements:function(callback){this.gapi.client.request({path:"/games/v1management/achievements/reset",method:"POST",callback:function(response){if(callback){callback(response?response.error:null)}}})},showAchievements:function(callback){var ios=/(iPad|iPhone|iPod)/gi.test(navigator.userAgent);if(!ios&&this.gapi.nativeAvailable){Cocoon.callNative(this.gapi.nativeExtensionName,"showAchievements",[callback],true)}else{Cocoon.Social.SocialGamingServiceGooglePlayGames.superclass.showAchievements.call(this)}}};Cocoon.extend(Cocoon.Social.SocialGamingServiceGooglePlayGames,Cocoon.Social.SocialGamingService);function fromGPPlayerToCocoonUser(gpPlayer){return new Cocoon.Social.User(gpPlayer.playerId,gpPlayer.displayName,gpPlayer.avatarImageUrl)}function fromGPPersonToCocoonUser(gpUser){var avatar=gpUser.image?gpUser.image.url:"";avatar=avatar.replace(/sz=\d+/g,"sz=100");return new Cocoon.Social.User(gpUser.id,gpUser.displayName,avatar)}function fromImageSizeToGPSize(imageSize){if(imageSize===Cocoon.Social.ImageSize.THUMB){return 100}else if(imageSize===Cocoon.Social.ImageSize.MEDIUM){return 200}else if(imageSize===Cocoon.Social.ImageSize.LARGE){return 512}}function fromGPAchievementToCocoonAchievement(gpItem){var result=new Cocoon.Social.Achievement(gpItem.id,gpItem.name,gpItem.description,gpItem.revealedIconUrl,0);result.gpAchievementData=gpItem;return result}function fromGPScoreToCocoonScore(gpItem,leaderboardID){return new Cocoon.Social.Score(gpItem.player.playerId,gpItem.scoreValue,gpItem.player.displayName,gpItem.player.avatarImageUrl,leaderboardID)}return extension});Cocoon.define("Cocoon.Social",function(extension){extension.GameCenterExtension=function(){this.nativeExtensionName="IDTK_SRV_GAMECENTER";this.extensionName="Social.GameCenter";this.nativeAvailable=!!window.ext&&!!window.ext[this.nativeExtensionName];var me=this;if(this.nativeAvailable){this.onGameCenterLoginStateChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onGameCenterLoginStateChanged");this.onGameCenterLoginStateChanged.addEventListener(function(localPlayer,error){me._currentPlayer=localPlayer})}return this};extension.GameCenterExtension.prototype={_currentPlayer:null,getSocialInterface:function(){if(!this._socialService){this._socialService=new Cocoon.Social.SocialGamingServiceGameCenter(this)}return this._socialService},getMultiplayerInterface:function(){return Cocoon.Multiplayer.GameCenter},isLoggedIn:function(){return this._currentPlayer&&this._currentPlayer.isAuthenticated},login:function(callback){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"login",[function(response,error){me._currentPlayer=response;if(callback){callback(response,error)}}],true)}else{throw"Game Center not available"}},getLocalPlayer:function(){if(this._currentPlayer)return this._currentPlayer;if(this.nativeAvailable){this._currentPlayer=Cocoon.callNative(this.nativeExtensionName,"getLocalPlayer",[]);return this._currentPlayer}else{throw"Game Center not available"}},loadPlayers:function(playerIDs,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadPlayers",[playerIDs,callback],true)}else{throw"Game Center not available"}},loadFriends:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadFriends",[callback],true)}else{throw"Game Center not available"}},loadAchievements:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadAchievements",[callback],true)}else{throw"Game Center not available"}},loadAchievementDescriptions:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadAchievementDescriptions",[callback],true)}else{throw"Game Center not available"}},loadScores:function(callback,query){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadScores",[query,callback],true)}else{throw"Game Center not available"}},submitScore:function(score,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"submitScore",[score,callback],true)}else{throw"Game Center not available"}},submitAchievements:function(achievements,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"submitAchievements",[achievements,callback],true)}else{throw"Game Center not available"}},resetAchievements:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"resetAchievements",[callback],true)}else{throw"Game Center not available"}},showAchievements:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showAchievements",[callback],true)}else{throw"Game Center not available"}},showLeaderboards:function(callback,query){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showLeaderboards",[query,callback],true)}else{throw"Game Center not available"}}};extension.GameCenter=new extension.GameCenterExtension;extension.GameCenter.Player=function(){this.playerID="";this.alias="";this.isFriend=false};extension.GameCenter.LocalPlayer=function(){this.playerID="";this.alias="";this.isAuthenticated=false};extension.GameCenter.Achievement=function(identifier,percentComplete){this.identifier=identifier;this.percentComplete=percentComplete;this.lastReportedDate=0};extension.GameCenter.AchievementDescription=function(){this.identifier="";this.title="";this.achievedDescription="";this.unachievedDescription="";this.maximumPoints=0};extension.GameCenter.Score=function(userID,score,userName,imageURL,leaderboardID,originalScoreObject){this.userID=userID;this.score=score||0;this.userName=userName;this.imageURL=imageURL;this.leaderboardID=leaderboardID;this.rank=originalScoreObject.rank;this.originalScoreObject=originalScoreObject;return this};extension.GameCenter.Leaderboard=function(category,playerIDs,timeScope,playerScope,rangeStart,rangeLength){this.category=category;this.playerIDs=playerIDs;this.timeScope=timeScope;this.playerScope=playerScope;this.rangeStart=rangeStart;this.rangeLength=rangeLength;this.scores=[];this.localPlayerScore=[];this.localizedTitle=localizedTitle};extension.GameCenter.TimeScope={TODAY:0,WEEK:1,ALL_TIME:2};extension.GameCenter.PlayerScope={GLOBAL:0,FRIENDS:1};extension.SocialGamingServiceGameCenter=function(gcExtension){Cocoon.Social.SocialGamingServiceGameCenter.superclass.constructor.call(this);this.gc=gcExtension;var me=this;this.gc.onGameCenterLoginStateChanged.addEventListener(function(localPlayer,error){me.onLoginStatusChanged.notifyEventListeners(localPlayer.isAuthenticated,error)});return this};extension.SocialGamingServiceGameCenter.prototype={_cachedAchievements:null,isLoggedIn:function(){return this.gc.isLoggedIn()},login:function(callback){this.gc.login(function(localPlayer,error){if(callback)callback(localPlayer.isAuthenticated,error)})},logout:function(callback){if(callback)callback({message:"User has to logout from the Game Center APP"})},getLoggedInUser:function(){return fromGCPLayerToCocoonUser(this.gc._currentPlayer?this.gc._currentPlayer:this.gc.getLocalPlayer())},requestUser:function(callback,userId){if(userId){this.gc.loadPlayers([userId],function(response,error){var user=response&&response.length?fromGCPLayerToCocoonUser(response[0]):null;callback(user,error)})}else{var me=this;setTimeout(function(){callback(me.getLoggedInUser())})}},requestFriends:function(callback,userId){this.gc.loadFriends(function(friends,error){var users=[];if(friends&&friends.length){for(var i=0;i<friends.length;++i){users.push(fromGCPLayerToCocoonUser(friends[i]))}}callback(users,error)})},requestScore:function(callback,params){var query={};var options=params||{};if(options.leaderboardID)query.category=options.leaderboardID;query.playerIDs=[options.userID||this.getLoggedInUser().userID];this.gc.loadScores(function(response,error){var gcScore=null;if(options.userID&&response&&response.scores&&response.scores.length)gcScore=response.scores[0];else if(response&&response.localPlayerScore)gcScore=response.localPlayerScore;var loadedScore=gcScore?new Cocoon.Social.GameCenter.Score(gcScore.playerID,gcScore.value,"","",gcScore.category,gcScore):null;callback(loadedScore,error)},query)},submitScore:function(score,callback,params){var options=params||{};this.gc.submitScore({value:score,category:options.leaderboardID||""},function(error){if(callback)callback(error)})},showLeaderboard:function(callback,params){var options=params||{};this.gc.showLeaderboards(function(error){if(callback)callback(error)},{category:options.leaderboardID||""})},prepareAchievements:function(reload,callback){if(!this._cachedAchievements||reload){var me=this;this.gc.loadAchievementDescriptions(function(response,error){if(error){callback([],error)}else{var achievements=[];if(response&&response.length){for(var i=0;i<response.length;i++){achievements.push(fromGCAchievementDescriptionToCocoonAchievement(response[i]))}}me.setCachedAchievements(achievements);callback(achievements,null)}})}else{callback(this._cachedAchievements,null)}},requestAllAchievements:function(callback){this.prepareAchievements(true,callback)},requestAchievements:function(callback,userID){var me=this;this.prepareAchievements(false,function(allAchievements,error){if(error){callback([],error);return}me.gc.loadAchievements(function(response,error){if(!error){var achievements=[];if(response&&response.length){for(var i=0;i<response.length;i++){var ach=me.findAchievement(response[i].identifier);if(ach)achievements.push(ach)}}callback(achievements,null)}else{callback([],response.error)}})})},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var achID=this.translateAchievementID(achievementID);this.gc.submitAchievements([{identifier:achID,percentComplete:100}],callback)},resetAchievements:function(callback){this.gc.resetAchievements(callback)},showAchievements:function(callback){this.gc.showAchievements(function(error){if(callback)callback(error)})}};Cocoon.extend(extension.SocialGamingServiceGameCenter,extension.SocialGamingService);function fromGCPLayerToCocoonUser(player){return new Cocoon.Social.User(player.playerID,player.alias)}function fromGCAchievementDescriptionToCocoonAchievement(ach){return new Cocoon.Social.GameCenter.Achievement(ach.identifier,ach.title,ach.achievedDescription,"",ach.maximumPoints)}return extension});Cocoon.define("Cocoon.Social",function(extension){extension.FacebookExtension=function(){this.nativeExtensionName="IDTK_SRV_FACEBOOK";this.extensionName="Social.Facebook";this.nativeAvailable=!!window.ext&&!!window.ext[this.nativeExtensionName];this.Event=new Cocoon.Social.FacebookEvent(this.nativeAvailable);var me=this;if(this.nativeAvailable){this.onFacebookSessionStateChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onFacebookSessionStateChanged");Cocoon.Social.Facebook=this;this.onFacebookSessionStateChanged.addEventListener(function(session,error){var data=fromCocoonFBSessionToFBAPISession(session,error);if(session.state==0){me.Event.notify("auth.login",data)}me.Event.notify("auth.authResponseChange",data);me.Event.notify("auth.statusChange",data)})}return this};extension.FacebookExtension.prototype={_currentSession:null,_appId:null,_socialService:null,init:function(options){if(!options||!options.appId){throw"appId must be specified!"}this._appId=options.appId;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"init",[options],true)}else{FB.init(options)}var me=this;this.Event.subscribe("auth.authResponseChange",function(session){me._currentSession=session;if(session.authResponse&&!session.authResponse.user){me.api("me?fields=username",function(response){me._currentSession.authResponse.user=response})}})},getSocialInterface:function(){if(!this._appId){throw"You must call init() before getting the Social Interface"}if(!this._socialService){this._socialService=new Cocoon.Social.SocialGamingServiceFacebook(this)}return this._socialService},login:function(callback,options){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"login",[options,function(response,error){me._currentSession=fromCocoonFBSessionToFBAPISession(response,error);if(callback){callback(me._currentSession)}}],true)}else{FB.login(function(response){me._currentSession=response;if(callback)callback(response)},options)}},logout:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"logout",[function(response,error){if(callback){callback(fromCocoonFBSessionToFBAPISession(response,error))}}],true)}else{FB.logout(function(response){if(callback){callback(response)}})}},getAuthResponse:function(){if(this.nativeAvailable){var response=Cocoon.callNative(this.nativeExtensionName,"getFacebookSession",[]);
return fromCocoonFBSessionToFBAPISession(response)}else{return FB.getAuthResponse()}},getLoginStatus:function(callback,force){if(this.nativeAvailable){var me=this;setTimeout(function(){var response=Cocoon.callNative(me.nativeExtensionName,"getFacebookSession",[]);if(callback){callback(fromCocoonFBSessionToFBAPISession(response))}},50)}else{FB.getLoginStatus(callback,force)}},api:function(path,method,params,cb){if(this.nativeAvailable){var openGraph=arguments[0];var httpMethod=arguments.length>3?arguments[1]:"GET";var options=null;if(arguments.length==3)options=arguments[1];if(arguments.length==4)options=arguments[2];var callback=arguments.length>1?arguments[arguments.length-1]:function(){};return Cocoon.callNative(this.nativeExtensionName,"api",[openGraph,httpMethod,options,callback],true)}else{FB.api(path,method,params,cb)}},ui:function(params,cb){if(this.nativeAvailable){var params=arguments[0];var callback=arguments.length>1?arguments[1]:function(){};return Cocoon.callNative(this.nativeExtensionName,"ui",[params,callback],true)}else if(!navigator.isCocoonJS){FB.ui(params,cb)}},requestAdditionalPermissions:function(permissionsType,permissions,callback){if(this.nativeAvailable){var permsArray=permissions.split(",");Cocoon.callNative(this.nativeExtensionName,"requestAdditionalPermissions",[permissionsType,permsArray,function(session,error){if(callback){callback(fromCocoonFBSessionToFBAPISession(session,error))}}],true)}else{FB.login(callback,{scope:permissions})}},getPermissions:function(callback){this.api("me/permissions",function(response){callback(response.data&&response.data[0]?response.data[0]:{})})},showShareDialog:function(params,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showShareDialog",[params,callback],true)}else{params.method="feed";FB.ui(params,callback)}},uploadPhoto:function(file,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"uploadPhoto",[file,callback],true)}else{callback({error:{message:"Not implemented"}})}},showFriendPicker:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showFriendPicker",[callback],true)}else{callback({error:{message:"Not implemented"}})}}};extension.FacebookEvent=function(nativeAvailable){this.nativeAvailable=nativeAvailable;return this};extension.FacebookEvent.prototype={subscribe:function(name,callback){if(this.nativeAvailable){var eventKey=name+"listeners";this[eventKey]=this[eventKey]||[];this[eventKey].push(callback)}else if(!navigator.isCocoonJS){FB.Event.subscribe(name,callback)}},unsubscribe:function(name,callback){if(this.nativeAvailable){var eventKey=name+"listeners";var array=this[eventKey];if(array){var index=array.indexOf(callback);if(index!==-1){array.splice(index,1)}}}else if(!navigator.isCocoonJS){FB.Event.unsubscribe(name,callback)}},notify:function(name,param){var eventKey=name+"listeners";var array=this[eventKey];if(array){for(var i=0;i<array.length;++i){array[i](param)}}}};extension.Facebook=new extension.FacebookExtension;function fromCocoonFBStatusToFBAPIState(state){if(state===0){return"connected"}else if(state===1){return"not_authorized"}else{return"unknown"}}function fromCocoonFBSessionToFBAPISession(response,error){var authResponse=null;if(response.state===0){authResponse={accessToken:response.accessToken,expirationDate:response.expirationDate,userID:response.user?response.userID:null,permissions:response.permissions,user:response.user}}return{status:fromCocoonFBStatusToFBAPIState(response.state),authResponse:authResponse,error:error}}extension.SocialGamingServiceFacebook=function(fbExtension){Cocoon.Social.SocialGamingServiceFacebook.superclass.constructor.call(this);this.fb=fbExtension;var me=this;this.fb.Event.subscribe("auth.authResponseChange",function(session){me.onLoginStatusChanged.notifyEventListeners(session.status=="connected",session.error)});return this};extension.SocialGamingServiceFacebook.prototype={currentPermissions:null,isLoggedIn:function(){return this.fb._currentSession&&this.fb._currentSession.status==="connected"},login:function(callback){var me=this;this.fb.login(function(response){if(callback)callback(me.isLoggedIn(),response.error)})},logout:function(callback){this.fb.logout(function(response){if(callback)callback(response.error)})},getLoggedInUser:function(){var authResponse=this.fb._currentSession?this.fb._currentSession.authResponse:null;if(authResponse&&authResponse.user){return fromFBUserToCocoonUser(authResponse.user)}else if(authResponse&&authResponse.userID){return new Cocoon.Social.Facebook.User(authResponse.userID,"Loading...")}return null},hasPublishPermissions:function(callback){this.fb.getPermissions(function(perms,error){callback(perms.publish_actions,error)})},requestPublishPermissions:function(callback){var me=this;this.fb.requestAdditionalPermissions("publish","publish_actions",function(response){if(response.error)callback(false,error);else{me.hasPublishPermissions(function(granted,error){callback(granted,error)})}})},requestUser:function(calback,userId){var apiCall=userId||"me";this.fb.api(apiCall,function(response){var user=response.error?null:fromFBUserToCocoonUser(response);calback(user,response.error)})},requestUserImage:function(callback,userID,imageSize){if(!userID&&this.isLoggedIn()){userID=this.fb._currentSession.authResponse.userID}var fbPictureSize="small";if(imageSize===Cocoon.Social.ImageSize.THUMB){fbPictureSize="square"}else if(imageSize===Cocoon.Social.ImageSize.MEDIUM){fbPictureSize="normal"}else if(imageSize===Cocoon.Social.ImageSize.LARGE){fbPictureSize="large"}var url="https://graph.facebook.com/"+userID+"/picture?type="+fbPictureSize;callback(url)},requestFriends:function(callback,userId){var apiCall=(userId||"me")+"/friends";this.fb.api(apiCall,function(response){var friends=[];if(!response.error){for(var i=0;i<response.data.length;i++){friends.push(fromFBUserToCocoonUser(response.data[i]))}}callback(friends,response.error)})},preparePublishAction:function(callback){if(!this.currentPermissions){var me=this;this.fb.getPermissions(function(perms){me.currentPermissions=perms;if(perms)me.preparePublishAction(callback)})}else if(this.currentPermissions.publish_actions){callback(true)}else{this.currentPermissions=null;this.fb.requestAdditionalPermissions("publish","publish_actions",function(response){callback(response.error?false:true)})}},publishMessage:function(message,callback){this.preparePublishAction(function(granted){if(granted){var params=fromCocoonMessageToFBMessage(message);var apiCall="me/feed";this.fb.api(apiCall,params,function(response){if(callback)callback(response.error)})}else{if(callback)callback({message:"No publish_actions permission granted"})}})},publishMessageWithDialog:function(message,callback){this.fb.showShareDialog(fromCocoonMessageToFBMessage(message),function(response){if(callback){callback(response.error)}})},requestScore:function(callback,params){var apiCall=(params&&params.userID?params.userID:"me")+"/scores";this.fb.api(apiCall,function(response){if(response.error){callback(null,response.error)}else if(response.data&&response.data.length>0){var data=fromFBScoreToCocoonScore(response.data[0]);callback(data,null)}else{callback(null,null)}})},submitScore:function(score,callback,params){var me=this;this.preparePublishAction(function(granted){if(granted){me.requestScore(function(currentScore,error){if(error){if(callback)callback(error);return}var topScore=currentScore?currentScore.score:0;if(score<=topScore){if(callback)callback(null);return}var apiCall="/"+(params&&params.userID?params.userID:"me")+"/scores";me.fb.api(apiCall,"POST",{score:score},function(response){if(callback)callback(response.error)})},params)}else{if(callback)callback({message:"No publish_actions permission granted"})}})},showLeaderboard:function(callback,params){if(!this._leaderboardsTemplate)throw"Please, provide a html template for leaderboards with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._leaderboardsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;this.fb.api(me.fb._appId+"/scores",function(response){if(dialog.closed)return;if(response.error){if(callback){callbackSent=true;callback(response.error);dialog.close()}return}var scores=[];if(response.data&&response.data.length){for(var i=0;i<response.data.length;++i){var score=fromFBScoreToCocoonScore(response.data[i]);score.position=i;score.imageURL="https://graph.facebook.com/"+score.userID+"/picture";score.me=score.userID===me.fb._currentSession.authResponse.userID;scores.push(score)}}var js="addScores("+JSON.stringify(scores)+")";dialog.eval(js)})},prepareAchievements:function(reload,callback){if(!this._cachedAchievements||reload){var me=this;this.fb.api(this.fb._appId+"/achievements",function(response){if(!response.error){var achievements=[];if(response.data){for(var i=0;i<response.data.length;i++){achievements.push(fromFBAchievementToCocoonAchievement(response.data[i]))}}me.setCachedAchievements(achievements);callback(achievements,null)}else{callback([],response.error)}})}else{callback(this._cachedAchievements,null)}},requestAllAchievements:function(callback){this.prepareAchievements(true,callback)},requestAchievements:function(callback,userID){var me=this;this.prepareAchievements(false,function(allAchievements,error){if(error){callback([],error);return}var apiCall=(userID||"me")+"/achievements";me.fb.api(apiCall,function(response){if(!response.error){var achievements=[];if(response.data){for(var i=0;i<response.data.length;i++){var ach=me.findAchievement((response.data[i].achievement||response.data[i].data.achievement).id);if(ach)achievements.push(ach)}}callback(achievements,null)}else{callback([],response.error)}})})},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var achID=this.translateAchievementID(achievementID);var me=this;this.preparePublishAction(function(granted){if(granted){me.fb.api("me/achievements","POST",{achievement:achID},function(response){if(callback){callback(response.error)}})}else{if(callback)callback({message:"No publish_actions permission granted"})}})},resetAchievements:function(callback){var me=this;this.preparePublishAction(function(granted){if(granted){me.requestAchievements(function(achievements,error){if(error){if(callback)callback(error);return}var someError=null;var remaining=achievements.length;for(var i=0;i<achievements.length;++i){me.fb.api("me/achievements","DELETE",{achievement:achievements[i].fbAchievementData.url},function(response){if(response.error){someError=response.error}remaining--;if(remaining==0&&callback){callback(someError)}})}})}else{if(callback)callback({message:"No publish_actions permission granted"})}})},showAchievements:function(callback){if(!this._achievementsTemplate)throw"Please, provide a html template for achievements with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._achievementsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;this.requestAchievements(function(achievements,error){if(dialog.closed)return;if(error){callbackSent=true;if(callback)callback(error);return}var achs=[];if(me._cachedAchievements){for(var i=0;i<me._cachedAchievements.length;++i){var ach=me._cachedAchievements[i];achs.push(ach);if(achievements&&achievements.length){for(var j=0;j<achievements.length;++j){if(achievements[j].achievementID===ach.achievementID){ach.achieved=true;break}}}}}var js="addAchievements("+JSON.stringify(achs)+");";dialog.eval(js)})}};Cocoon.extend(extension.SocialGamingServiceFacebook,extension.SocialGamingService);function fromFBUserToCocoonUser(facebookUser){return new Cocoon.Social.User(facebookUser.id,facebookUser.username?facebookUser.username:facebookUser.first_name+" "+facebookUser.last_name)}function fromCocoonMessageToFBMessage(message){return{link:message.linkURL,description:message.message,name:message.linkText,caption:message.linkCaption,picture:message.mediaURL}}function fromFBScoreToCocoonScore(fbResponse,requestScoreParams){var result=new Cocoon.Social.Score(fbResponse.user.id,fbResponse.score,fbResponse.user.name);if(requestScoreParams){result.leaderboardID=requestScoreParams.leaderboardID}result.imageURL="https://graph.facebook.com/"+fbResponse.user.id+"/picture";return result}function fromFBAchievementToCocoonAchievement(fbResponse){var result=new Cocoon.Social.Achievement(fbResponse.id,fbResponse.title,fbResponse.description,fbResponse.image[0].url,fbResponse.data.points);result.fbAchievementData=fbResponse;return result}if(!navigator.isCocoonJS&&!(typeof module!=="undefined"&&module.exports)){var parent=document.getElementsByTagName("script")[0];var script=document.createElement("script");var prot=location.protocol?location.protocol:"http:";script.src=prot+"//connect.facebook.net/en_US/all.js";parent.parentNode.insertBefore(script,parent)}return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){extension.MultiplayerService=function(nativeExtensionName,extensionName){this.nativeExtensionName=nativeExtensionName;this.extensionName=extensionName;this.nativeAvailable=!!window.ext&&!!window.ext[this.nativeExtensionName];var me=this;this.onInvitationReceived=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onInvitationReceived");this.onInvitationLoaded=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onInvitationLoaded",function(sourceListener,args){var matchID=args[0];var error=args[1];if(matchID&&!error){me.currentMatch=new Cocoon.Multiplayer.Match(me.nativeExtensionName,me.extensionName,matchID);sourceListener(me.currentMatch,null)}else{sourceListener(null,error)}});var signal=new Cocoon.Signal.createSignal;signal.register("invitation",{received:this.onInvitationReceived,loaded:this.onInvitationLoaded});this.on=signal.expose();return this};extension.MultiplayerService.prototype={currentMatch:null,findMatch:function(matchRequest,callback){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"findMatch",[matchRequest,function(matchID,error){if(matchID&&!error){me.currentMatch=new Cocoon.Multiplayer.Match(me.nativeExtensionName,me.extensionName,matchID);callback(me.currentMatch,null)}else{callback(null,error)}}],true)}},findAutoMatch:function(matchRequest,callback){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"findAutoMatch",[matchRequest,function(matchID,error){if(matchID&&!error){me.currentMatch=new Cocoon.Multiplayer.Match(me.nativeExtensionName,me.extensionName,matchID);callback(me.currentMatch,null)}else{callback(null,error)}}],true)}},cancelAutoMatch:function(){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"cancelAutoMatch",[],true)}},addPlayersToMatch:function(matchRequest,match,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"addPlayersToMatch",[matchRequest,match.matchID,callback],true)}},getMatch:function(){return this.currentMatch}};extension.Match=function(nativeExtensionName,extensionName,matchID){if(typeof nativeExtensionName!=="string")throw"The given native extension name '"+nativeExtensionName+"' is not a string.";if(typeof extensionName!=="string")throw"The given extension name '"+nativeExtensionName+"' is not a string.";this.nativeExtensionName=nativeExtensionName;this.extensionName=extensionName;this.nativeAvailable=Cocoon.nativeAvailable&&typeof window.ext[nativeExtensionName]!=="undefined";this.matchID=matchID;var me=this;this.onMatchDataReceived=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchDataReceived",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1],args[2])}});this.onMatchStateChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchStateChanged",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1],args[2])}});this.onMatchConnectionWithPlayerFailed=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchConnectionWithPlayerFailed",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1],args[2])}});this.onMatchFailed=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchFailed",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1])}});var signal=new Cocoon.Signal.createSignal;signal.register("match",{dataReceived:this.onMatchDataReceived,stateChanged:this.onMatchStateChanged,connectionWithPlayerFailed:this.onMatchConnectionWithPlayerFailed,failed:this.onMatchFailed});this.on=signal.expose()};extension.Match.prototype={start:function(){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"startMatch",[this.matchID],true)}},sendDataToAllPlayers:function(data,sendMode){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"sendDataToAllPlayers",[this.matchID,data,sendMode])}},sendData:function(data,playerIDs,sendMode){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"sendData",[this.matchID,data,playerIDs,sendMode])}},disconnect:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"disconnect",[this.matchID],true)}},requestPlayersInfo:function(callback){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"requestPlayersInfo",[this.matchID,callback],true)}},getExpectedPlayerCount:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"getExpectedPlayerCount",[this.matchID])}},getPlayerIDs:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"getPlayerIDs",[this.matchID])}},getLocalPlayerID:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"getLocalPlayerID",[this.matchID])}return""}};extension.SendDataMode={RELIABLE:0,UNRELIABLE:1};extension.ConnectionState={UNKNOWN:0,CONNECTED:1,DISCONNECTED:2};extension.PlayerInfo=function(userID,userName){this.userID=userID;this.userName=userName};extension.MatchRequest=function(minPlayers,maxPlayers,playersToInvite,playerGroup,playerAttributes){this.minPlayers=minPlayers;this.maxPlayers=maxPlayers;this.playersToInvite=playersToInvite;this.playerGroup=playerGroup;this.playerAttributes=playerAttributes;return this};return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){var loopbackServices=[];var indexCounter=0;var matchServices=[];var matchCounter=0;extension.LoopbackService=function(){Cocoon.Multiplayer.LoopbackService.superclass.constructor.call(this,"dummy","dummy");loopbackServices.push(this);this.playerID=""+indexCounter;indexCounter++};extension.LoopbackService.prototype={findMatch:function(request,callback){this.findMatchCallback=callback;var exists=false;for(var i=0;i<matchServices.length;++i){if(matchServices[i]===this){exists=true;break}}if(!exists)matchServices.push(this);if(matchServices.length>=request.minPlayers){var playerIDs=[];for(var i=0;i<matchServices.length;++i){playerIDs.push(matchServices[i].getPlayerID())}for(var i=0;i<matchServices.length;++i){var match=new LoopbackMatch(matchServices[i]);match.playerIDs=playerIDs.slice();matchServices[i].currentMatch=match;matchServices[i].findMatchCallback(match,null)}matchServices=[]}},findAutoMatch:function(matchRequest,callback){this.findMatch(matchRequest,callback)},cancelAutoMatch:function(){},addPlayersToMatch:function(matchRequest,match,callback){callback({message:"Not implemmented"})},getPlayerID:function(){return this.playerID},getMatch:function(){return this.currentMatch}};Cocoon.extend(extension.LoopbackService,extension.MultiplayerService);var LoopbackMatch=function(service){matchCounter++;LoopbackMatch.superclass.constructor.call(this,"","",matchCounter);this.started=false;this.disconnected=false;this.pendingData=[];this.service=service};LoopbackMatch.prototype={start:function(){var me=this;setTimeout(function(){me.started=true;for(var i=0;i<me.pendingData.length;++i){me.onMatchDataReceived.notifyEventListeners(me.matchID,me.pendingData[i].data,me.pendingData[i].player)}},0)},sendDataToAllPlayers:function(data,sendMode){this.sendData(data,this.playerIDs,sendMode)},sendData:function(data,playerIDs,sendMode){var me=this;setTimeout(function(){for(var i=0;i<loopbackServices.length;++i){var destService=null;for(var j=0;j<playerIDs.length;++j){if(playerIDs[j]===loopbackServices[i].getPlayerID()){destService=loopbackServices[i]}}if(destService){destService.getMatch().notifyDataReceived(data,me.service.getPlayerID())}}},0)},disconnect:function(){this.disconnected=true;for(var i=0;i<this.playerIDs.length;++i){var p=this.playerIDs[i];for(var j=0;j<loopbackServices.length;++j){if(loopbackServices[j].getPlayerID()===p){var match=loopbackServices[i].getMatch();if(!match.disconnected){match.onMatchStateChanged.notifyEventListeners(match,this.service.getPlayerID(),Cocoon.Multiplayer.ConnectionState.DISCONNECTED)}}}}},requestPlayersInfo:function(callback){var me=this;setTimeout(function(){var playersInfo=[];for(var i=0;i<me.playerIDs.length;++i){playersInfo[i]={userID:me.playerIDs[i],userName:"Player"+me.playerIDs[i]}}callback(playersInfo)},1)},getExpectedPlayerCount:function(){return 0},getPlayerIDs:function(){return this.playerIDs},getLocalPlayerID:function(){return this.service.playerID},notifyDataReceived:function(data,fromPlayer){if(!this.started){this.pendingData.push({data:data,player:fromPlayer})}else{this.onMatchDataReceived.notifyEventListeners(this.matchID,data,fromPlayer)}}};Cocoon.extend(LoopbackMatch,Cocoon.Multiplayer.Match);return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){extension.GooglePlayGames=new Cocoon.Multiplayer.MultiplayerService("IDTK_SRV_MULTIPLAYER_GPG","Multiplayer.GooglePlayGames");return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){extension.GameCenter=new Cocoon.Multiplayer.MultiplayerService("IDTK_SRV_MULTIPLAYER_GAMECENTER","Multiplayer.GameCenter");return extension});(function(){var root=this;var PIXI=PIXI||{};PIXI.WEBGL_RENDERER=0;PIXI.CANVAS_RENDERER=1;PIXI.VERSION="v2.2.8";PIXI._UID=0;if(typeof Float32Array!="undefined"){PIXI.Float32Array=Float32Array;PIXI.Uint16Array=Uint16Array;PIXI.Uint32Array=Uint32Array;PIXI.ArrayBuffer=ArrayBuffer}else{PIXI.Float32Array=Array;PIXI.Uint16Array=Array}PIXI.PI_2=Math.PI*2;PIXI.RAD_TO_DEG=180/Math.PI;PIXI.DEG_TO_RAD=Math.PI/180;PIXI.RETINA_PREFIX="@2x";PIXI.defaultRenderOptions={view:null,transparent:false,antialias:false,preserveDrawingBuffer:false,resolution:1,clearBeforeRender:true,autoResize:false};PIXI.DisplayObject=function(){this.position=new PIXI.Point(0,0);this.scale=new PIXI.Point(1,1);this.transformCallback=null;this.transformCallbackContext=null;this.pivot=new PIXI.Point(0,0);this.rotation=0;this.alpha=1;this.visible=true;this.hitArea=null;this.renderable=false;this.parent=null;this.stage=null;this.worldAlpha=1;this.worldTransform=new PIXI.Matrix;this._sr=0;this._cr=1;this.filterArea=null;this._bounds=new PIXI.Rectangle(0,0,1,1);this._currentBounds=null;this._mask=null;this._cacheAsBitmap=false;this._cacheIsDirty=false};PIXI.DisplayObject.prototype.constructor=PIXI.DisplayObject;PIXI.DisplayObject.prototype.destroy=function(){if(this.children){var i=this.children.length;while(i--){this.children[i].destroy()}this.children=[]}this.transformCallback=null;this.transformCallbackContext=null;this.hitArea=null;this.parent=null;this.stage=null;this.worldTransform=null;this.filterArea=null;this._bounds=null;this._currentBounds=null;this._mask=null;this.renderable=false;this._destroyCachedSprite()};Object.defineProperty(PIXI.DisplayObject.prototype,"worldVisible",{get:function(){var item=this;do{if(!item.visible)return false;item=item.parent}while(item);return true}});Object.defineProperty(PIXI.DisplayObject.prototype,"mask",{get:function(){return this._mask},set:function(value){if(this._mask)this._mask.isMask=false;this._mask=value;if(this._mask)this._mask.isMask=true}});Object.defineProperty(PIXI.DisplayObject.prototype,"filters",{get:function(){return this._filters},set:function(value){if(value){var passes=[];for(var i=0;i<value.length;i++){var filterPasses=value[i].passes;for(var j=0;j<filterPasses.length;j++){passes.push(filterPasses[j])}}this._filterBlock={target:this,filterPasses:passes}}this._filters=value}});Object.defineProperty(PIXI.DisplayObject.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap},set:function(value){if(this._cacheAsBitmap===value)return;if(value){this._generateCachedSprite()}else{this._destroyCachedSprite()}this._cacheAsBitmap=value}});PIXI.DisplayObject.prototype.updateTransform=function(){if(!this.parent){return}var pt=this.parent.worldTransform;var wt=this.worldTransform;var a,b,c,d,tx,ty;if(this.rotation%PIXI.PI_2){if(this.rotation!==this.rotationCache){this.rotationCache=this.rotation;this._sr=Math.sin(this.rotation);this._cr=Math.cos(this.rotation)}a=this._cr*this.scale.x;b=this._sr*this.scale.x;c=-this._sr*this.scale.y;d=this._cr*this.scale.y;tx=this.position.x;ty=this.position.y;if(this.pivot.x||this.pivot.y){tx-=this.pivot.x*a+this.pivot.y*c;ty-=this.pivot.x*b+this.pivot.y*d}wt.a=a*pt.a+b*pt.c;wt.b=a*pt.b+b*pt.d;wt.c=c*pt.a+d*pt.c;wt.d=c*pt.b+d*pt.d;wt.tx=tx*pt.a+ty*pt.c+pt.tx;wt.ty=tx*pt.b+ty*pt.d+pt.ty}else{a=this.scale.x;d=this.scale.y;tx=this.position.x-this.pivot.x*a;ty=this.position.y-this.pivot.y*d;wt.a=a*pt.a;wt.b=a*pt.b;wt.c=d*pt.c;wt.d=d*pt.d;wt.tx=tx*pt.a+ty*pt.c+pt.tx;wt.ty=tx*pt.b+ty*pt.d+pt.ty}this.worldAlpha=this.alpha*this.parent.worldAlpha;if(this.transformCallback){this.transformCallback.call(this.transformCallbackContext,wt,pt)}};PIXI.DisplayObject.prototype.displayObjectUpdateTransform=PIXI.DisplayObject.prototype.updateTransform;PIXI.DisplayObject.prototype.getBounds=function(matrix){matrix=matrix;return PIXI.EmptyRectangle};PIXI.DisplayObject.prototype.getLocalBounds=function(){return this.getBounds(PIXI.identityMatrix)};PIXI.DisplayObject.prototype.setStageReference=function(stage){this.stage=stage};PIXI.DisplayObject.prototype.preUpdate=function(){};PIXI.DisplayObject.prototype.generateTexture=function(resolution,scaleMode,renderer){var bounds=this.getLocalBounds();var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0,renderer,scaleMode,resolution);PIXI.DisplayObject._tempMatrix.tx=-bounds.x;PIXI.DisplayObject._tempMatrix.ty=-bounds.y;renderTexture.render(this,PIXI.DisplayObject._tempMatrix);return renderTexture};PIXI.DisplayObject.prototype.updateCache=function(){this._generateCachedSprite()};PIXI.DisplayObject.prototype.toGlobal=function(position){this.displayObjectUpdateTransform();return this.worldTransform.apply(position)};PIXI.DisplayObject.prototype.toLocal=function(position,from){if(from){position=from.toGlobal(position)}this.displayObjectUpdateTransform();return this.worldTransform.applyInverse(position)};PIXI.DisplayObject.prototype._renderCachedSprite=function(renderSession){this._cachedSprite.worldAlpha=this.worldAlpha;if(renderSession.gl){PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession)}else{PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession)}};PIXI.DisplayObject.prototype._generateCachedSprite=function(){this._cacheAsBitmap=false;var bounds=this.getLocalBounds();if(!this._cachedSprite){var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0);this._cachedSprite=new PIXI.Sprite(renderTexture);this._cachedSprite.worldTransform=this.worldTransform}else{this._cachedSprite.texture.resize(bounds.width|0,bounds.height|0)}var tempFilters=this._filters;this._filters=null;this._cachedSprite.filters=tempFilters;PIXI.DisplayObject._tempMatrix.tx=-bounds.x;PIXI.DisplayObject._tempMatrix.ty=-bounds.y;this._cachedSprite.texture.render(this,PIXI.DisplayObject._tempMatrix,true);this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._filters=tempFilters;this._cacheAsBitmap=true};PIXI.DisplayObject.prototype._destroyCachedSprite=function(){if(!this._cachedSprite)return;this._cachedSprite.texture.destroy(true);this._cachedSprite=null};PIXI.DisplayObject.prototype._renderWebGL=function(renderSession){renderSession=renderSession};PIXI.DisplayObject.prototype._renderCanvas=function(renderSession){renderSession=renderSession};Object.defineProperty(PIXI.DisplayObject.prototype,"x",{get:function(){return this.position.x},set:function(value){this.position.x=value}});Object.defineProperty(PIXI.DisplayObject.prototype,"y",{get:function(){return this.position.y},set:function(value){this.position.y=value}});PIXI.DisplayObjectContainer=function(){PIXI.DisplayObject.call(this);this.children=[]};PIXI.DisplayObjectContainer.prototype=Object.create(PIXI.DisplayObject.prototype);PIXI.DisplayObjectContainer.prototype.constructor=PIXI.DisplayObjectContainer;Object.defineProperty(PIXI.DisplayObjectContainer.prototype,"width",{get:function(){return this.scale.x*this.getLocalBounds().width},set:function(value){var width=this.getLocalBounds().width;if(width!==0){this.scale.x=value/width}else{this.scale.x=1}this._width=value}});Object.defineProperty(PIXI.DisplayObjectContainer.prototype,"height",{get:function(){return this.scale.y*this.getLocalBounds().height},set:function(value){var height=this.getLocalBounds().height;if(height!==0){this.scale.y=value/height}else{this.scale.y=1}this._height=value}});PIXI.DisplayObjectContainer.prototype.addChild=function(child){return this.addChildAt(child,this.children.length)};PIXI.DisplayObjectContainer.prototype.addChildAt=function(child,index){if(index>=0&&index<=this.children.length){if(child.parent){child.parent.removeChild(child)}child.parent=this;this.children.splice(index,0,child);if(this.stage)child.setStageReference(this.stage);return child}else{throw new Error(child+"addChildAt: The index "+index+" supplied is out of bounds "+this.children.length)}};PIXI.DisplayObjectContainer.prototype.swapChildren=function(child,child2){if(child===child2){return}var index1=this.getChildIndex(child);var index2=this.getChildIndex(child2);if(index1<0||index2<0){throw new Error("swapChildren: Both the supplied DisplayObjects must be a child of the caller.")}this.children[index1]=child2;this.children[index2]=child};PIXI.DisplayObjectContainer.prototype.getChildIndex=function(child){var index=this.children.indexOf(child);if(index===-1){throw new Error("The supplied DisplayObject must be a child of the caller")}return index};PIXI.DisplayObjectContainer.prototype.setChildIndex=function(child,index){if(index<0||index>=this.children.length){throw new Error("The supplied index is out of bounds")}var currentIndex=this.getChildIndex(child);this.children.splice(currentIndex,1);this.children.splice(index,0,child)};PIXI.DisplayObjectContainer.prototype.getChildAt=function(index){if(index<0||index>=this.children.length){throw new Error("getChildAt: Supplied index "+index+" does not exist in the child list, or the supplied DisplayObject must be a child of the caller")}return this.children[index]};PIXI.DisplayObjectContainer.prototype.removeChild=function(child){var index=this.children.indexOf(child);if(index===-1)return;return this.removeChildAt(index)};PIXI.DisplayObjectContainer.prototype.removeChildAt=function(index){var child=this.getChildAt(index);if(this.stage)child.removeStageReference();child.parent=undefined;this.children.splice(index,1);return child};PIXI.DisplayObjectContainer.prototype.removeChildren=function(beginIndex,endIndex){var begin=beginIndex||0;var end=typeof endIndex==="number"?endIndex:this.children.length;var range=end-begin;if(range>0&&range<=end){var removed=this.children.splice(begin,range);for(var i=0;i<removed.length;i++){var child=removed[i];if(this.stage)child.removeStageReference();child.parent=undefined}return removed}else if(range===0&&this.children.length===0){return[]
}else{throw new Error("removeChildren: Range Error, numeric values are outside the acceptable range")}};PIXI.DisplayObjectContainer.prototype.updateTransform=function(){if(!this.visible)return;this.displayObjectUpdateTransform();if(this._cacheAsBitmap)return;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}};PIXI.DisplayObjectContainer.prototype.displayObjectContainerUpdateTransform=PIXI.DisplayObjectContainer.prototype.updateTransform;PIXI.DisplayObjectContainer.prototype.getBounds=function(){if(this.children.length===0)return PIXI.EmptyRectangle;var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;var childBounds;var childMaxX;var childMaxY;var childVisible=false;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];if(!child.visible)continue;childVisible=true;childBounds=this.children[i].getBounds();minX=minX<childBounds.x?minX:childBounds.x;minY=minY<childBounds.y?minY:childBounds.y;childMaxX=childBounds.width+childBounds.x;childMaxY=childBounds.height+childBounds.y;maxX=maxX>childMaxX?maxX:childMaxX;maxY=maxY>childMaxY?maxY:childMaxY}if(!childVisible)return PIXI.EmptyRectangle;var bounds=this._bounds;bounds.x=minX;bounds.y=minY;bounds.width=maxX-minX;bounds.height=maxY-minY;return bounds};PIXI.DisplayObjectContainer.prototype.getLocalBounds=function(){var matrixCache=this.worldTransform;this.worldTransform=PIXI.identityMatrix;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}var bounds=this.getBounds();this.worldTransform=matrixCache;return bounds};PIXI.DisplayObjectContainer.prototype.setStageReference=function(stage){this.stage=stage;for(var i=0;i<this.children.length;i++){this.children[i].setStageReference(stage)}};PIXI.DisplayObjectContainer.prototype.removeStageReference=function(){for(var i=0;i<this.children.length;i++){this.children[i].removeStageReference()}this.stage=null};PIXI.DisplayObjectContainer.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return}var i;if(this._mask||this._filters){if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start()}for(i=0;i<this.children.length;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.popFilter();renderSession.spriteBatch.start()}else{for(i=0;i<this.children.length;i++){this.children[i]._renderWebGL(renderSession)}}};PIXI.DisplayObjectContainer.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}for(var i=0;i<this.children.length;i++){this.children[i]._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession)}};PIXI.Sprite=function(texture){PIXI.DisplayObjectContainer.call(this);this.anchor=new PIXI.Point;this.texture=texture||PIXI.Texture.emptyTexture;this._width=0;this._height=0;this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL;this.shader=null;if(this.texture.baseTexture.hasLoaded){this.onTextureUpdate()}this.renderable=true};PIXI.Sprite.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Sprite.prototype.constructor=PIXI.Sprite;Object.defineProperty(PIXI.Sprite.prototype,"width",{get:function(){return this.scale.x*this.texture.frame.width},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value}});Object.defineProperty(PIXI.Sprite.prototype,"height",{get:function(){return this.scale.y*this.texture.frame.height},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value}});PIXI.Sprite.prototype.setTexture=function(texture){this.texture=texture;this.cachedTint=16777215};PIXI.Sprite.prototype.onTextureUpdate=function(){if(this._width)this.scale.x=this._width/this.texture.frame.width;if(this._height)this.scale.y=this._height/this.texture.frame.height};PIXI.Sprite.prototype.getBounds=function(matrix){var width=this.texture.frame.width;var height=this.texture.frame.height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;if(b===0&&c===0){if(a<0)a*=-1;if(d<0)d*=-1;minX=a*w1+tx;maxX=a*w0+tx;minY=d*h1+ty;maxY=d*h0+ty}else{var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY}var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.Sprite.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0||!this.renderable)return;var i,j;if(this._mask||this._filters){var spriteBatch=renderSession.spriteBatch;if(this._filters){spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(this._mask){spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);spriteBatch.start()}spriteBatch.render(this);for(i=0;i<this.children.length;i++){this.children[i]._renderWebGL(renderSession)}spriteBatch.stop();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.popFilter();spriteBatch.start()}else{renderSession.spriteBatch.render(this);for(i=0;i<this.children.length;i++){this.children[i]._renderWebGL(renderSession)}}};PIXI.Sprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0||this.renderable===false||this.texture.crop.width<=0||this.texture.crop.height<=0)return;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;renderSession.context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}if(this.texture.valid){var resolution=this.texture.baseTexture.resolution/renderSession.resolution;renderSession.context.globalAlpha=this.worldAlpha;if(renderSession.smoothProperty&&renderSession.scaleMode!==this.texture.baseTexture.scaleMode){renderSession.scaleMode=this.texture.baseTexture.scaleMode;renderSession.context[renderSession.smoothProperty]=renderSession.scaleMode===PIXI.scaleModes.LINEAR}var dx=this.texture.trim?this.texture.trim.x-this.anchor.x*this.texture.trim.width:this.anchor.x*-this.texture.frame.width;var dy=this.texture.trim?this.texture.trim.y-this.anchor.y*this.texture.trim.height:this.anchor.y*-this.texture.frame.height;if(renderSession.roundPixels){renderSession.context.setTransform(this.worldTransform.a,this.worldTransform.b,this.worldTransform.c,this.worldTransform.d,this.worldTransform.tx*renderSession.resolution|0,this.worldTransform.ty*renderSession.resolution|0);dx=dx|0;dy=dy|0}else{renderSession.context.setTransform(this.worldTransform.a,this.worldTransform.b,this.worldTransform.c,this.worldTransform.d,this.worldTransform.tx*renderSession.resolution,this.worldTransform.ty*renderSession.resolution)}if(this.tint!==16777215){if(this.cachedTint!==this.tint){this.cachedTint=this.tint;this.tintedTexture=PIXI.CanvasTinter.getTintedTexture(this,this.tint)}renderSession.context.drawImage(this.tintedTexture,0,0,this.texture.crop.width,this.texture.crop.height,dx/resolution,dy/resolution,this.texture.crop.width/resolution,this.texture.crop.height/resolution)}else{renderSession.context.drawImage(this.texture.baseTexture.source,this.texture.crop.x,this.texture.crop.y,this.texture.crop.width,this.texture.crop.height,dx/resolution,dy/resolution,this.texture.crop.width/resolution,this.texture.crop.height/resolution)}}for(var i=0;i<this.children.length;i++){this.children[i]._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession)}};PIXI.Sprite.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache'+this);return new PIXI.Sprite(texture)};PIXI.Sprite.fromImage=function(imageId,crossorigin,scaleMode){var texture=PIXI.Texture.fromImage(imageId,crossorigin,scaleMode);return new PIXI.Sprite(texture)};PIXI.SpriteBatch=function(texture){PIXI.DisplayObjectContainer.call(this);this.textureThing=texture;this.ready=false};PIXI.SpriteBatch.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.SpriteBatch.prototype.constructor=PIXI.SpriteBatch;PIXI.SpriteBatch.prototype.initWebGL=function(gl){this.fastSpriteBatch=new PIXI.WebGLFastSpriteBatch(gl);this.ready=true};PIXI.SpriteBatch.prototype.updateTransform=function(){this.displayObjectUpdateTransform()};PIXI.SpriteBatch.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;if(!this.ready){this.initWebGL(renderSession.gl)}if(this.fastSpriteBatch.gl!==renderSession.gl){this.fastSpriteBatch.setContext(renderSession.gl)}renderSession.spriteBatch.stop();renderSession.shaderManager.setShader(renderSession.shaderManager.fastShader);this.fastSpriteBatch.begin(this,renderSession);this.fastSpriteBatch.render(this);renderSession.spriteBatch.start()};PIXI.SpriteBatch.prototype._renderCanvas=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;var context=renderSession.context;context.globalAlpha=this.worldAlpha;this.displayObjectUpdateTransform();var transform=this.worldTransform;var isRotated=true;for(var i=0;i<this.children.length;i++){var child=this.children[i];if(!child.visible)continue;var texture=child.texture;var frame=texture.frame;context.globalAlpha=this.worldAlpha*child.alpha;if(child.rotation%(Math.PI*2)===0){if(isRotated){context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx,transform.ty);isRotated=false}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*(-frame.width*child.scale.x)+child.position.x+.5|0,child.anchor.y*(-frame.height*child.scale.y)+child.position.y+.5|0,frame.width*child.scale.x,frame.height*child.scale.y)}else{if(!isRotated)isRotated=true;child.displayObjectUpdateTransform();var childTransform=child.worldTransform;if(renderSession.roundPixels){context.setTransform(childTransform.a,childTransform.b,childTransform.c,childTransform.d,childTransform.tx|0,childTransform.ty|0)}else{context.setTransform(childTransform.a,childTransform.b,childTransform.c,childTransform.d,childTransform.tx,childTransform.ty)}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*-frame.width+.5|0,child.anchor.y*-frame.height+.5|0,frame.width,frame.height)}}};PIXI.Text=function(text,style){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.resolution=1;PIXI.Sprite.call(this,PIXI.Texture.fromCanvas(this.canvas));this.setText(text);this.setStyle(style)};PIXI.Text.prototype=Object.create(PIXI.Sprite.prototype);PIXI.Text.prototype.constructor=PIXI.Text;Object.defineProperty(PIXI.Text.prototype,"width",{get:function(){if(this.dirty){this.updateText();this.dirty=false}return this.scale.x*this.texture.frame.width},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value}});Object.defineProperty(PIXI.Text.prototype,"height",{get:function(){if(this.dirty){this.updateText();this.dirty=false}return this.scale.y*this.texture.frame.height},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value}});PIXI.Text.prototype.setStyle=function(style){style=style||{};style.font=style.font||"bold 20pt Arial";style.fill=style.fill||"black";style.align=style.align||"left";style.stroke=style.stroke||"black";style.strokeThickness=style.strokeThickness||0;style.wordWrap=style.wordWrap||false;style.wordWrapWidth=style.wordWrapWidth||100;style.dropShadow=style.dropShadow||false;style.dropShadowAngle=style.dropShadowAngle||Math.PI/6;style.dropShadowDistance=style.dropShadowDistance||4;style.dropShadowColor=style.dropShadowColor||"black";this.style=style;this.dirty=true};PIXI.Text.prototype.setText=function(text){this.text=text.toString()||" ";this.dirty=true};PIXI.Text.prototype.updateText=function(){this.texture.baseTexture.resolution=this.resolution;this.context.font=this.style.font;var outputText=this.text;if(this.style.wordWrap)outputText=this.wordWrap(this.text);var lines=outputText.split(/(?:\r\n|\r|\n)/);var lineWidths=[];var maxLineWidth=0;var fontProperties=this.determineFontProperties(this.style.font);for(var i=0;i<lines.length;i++){var lineWidth=this.context.measureText(lines[i]).width;lineWidths[i]=lineWidth;maxLineWidth=Math.max(maxLineWidth,lineWidth)}var width=maxLineWidth+this.style.strokeThickness;if(this.style.dropShadow)width+=this.style.dropShadowDistance;this.canvas.width=(width+this.context.lineWidth)*this.resolution;var lineHeight=fontProperties.fontSize+this.style.strokeThickness;var height=lineHeight*lines.length;if(this.style.dropShadow)height+=this.style.dropShadowDistance;this.canvas.height=height*this.resolution;this.context.scale(this.resolution,this.resolution);if(navigator.isCocoonJS)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.font=this.style.font;this.context.strokeStyle=this.style.stroke;this.context.lineWidth=this.style.strokeThickness;this.context.textBaseline="alphabetic";var linePositionX;var linePositionY;if(this.style.dropShadow){this.context.fillStyle=this.style.dropShadowColor;var xShadowOffset=Math.sin(this.style.dropShadowAngle)*this.style.dropShadowDistance;var yShadowOffset=Math.cos(this.style.dropShadowAngle)*this.style.dropShadowDistance;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.style.fill){this.context.fillText(lines[i],linePositionX+xShadowOffset,linePositionY+yShadowOffset)}}}this.context.fillStyle=this.style.fill;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.style.stroke&&this.style.strokeThickness){this.context.strokeText(lines[i],linePositionX,linePositionY)}if(this.style.fill){this.context.fillText(lines[i],linePositionX,linePositionY)}}this.updateTexture()};PIXI.Text.prototype.updateTexture=function(){this.texture.baseTexture.width=this.canvas.width;this.texture.baseTexture.height=this.canvas.height;this.texture.crop.width=this.texture.frame.width=this.canvas.width;this.texture.crop.height=this.texture.frame.height=this.canvas.height;this._width=this.canvas.width;this._height=this.canvas.height;this.texture.baseTexture.dirty()};PIXI.Text.prototype._renderWebGL=function(renderSession){if(this.dirty){this.resolution=renderSession.resolution;this.updateText();this.dirty=false}PIXI.Sprite.prototype._renderWebGL.call(this,renderSession)};PIXI.Text.prototype._renderCanvas=function(renderSession){if(this.dirty){this.resolution=renderSession.resolution;this.updateText();this.dirty=false}PIXI.Sprite.prototype._renderCanvas.call(this,renderSession)};PIXI.Text.prototype.determineFontProperties=function(fontStyle){var properties=PIXI.Text.fontPropertiesCache[fontStyle];if(!properties){properties={};var canvas=PIXI.Text.fontPropertiesCanvas;var context=PIXI.Text.fontPropertiesContext;context.font=fontStyle;var width=Math.ceil(context.measureText("|Mq").width);var baseline=Math.ceil(context.measureText("|Mq").width);var height=2*baseline;baseline=baseline*1.4|0;canvas.width=width;canvas.height=height;context.fillStyle="#f00";context.fillRect(0,0,width,height);context.font=fontStyle;context.textBaseline="alphabetic";context.fillStyle="#000";context.fillText("|Mq",0,baseline);var imagedata=context.getImageData(0,0,width,height).data;var pixels=imagedata.length;var line=width*4;var i,j;var idx=0;var stop=false;for(i=0;i<baseline;i++){for(j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break}}if(!stop){idx+=line}else{break}}properties.ascent=baseline-i;idx=pixels-line;stop=false;for(i=height;i>baseline;i--){for(j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break}}if(!stop){idx-=line}else{break}}properties.descent=i-baseline;properties.descent+=6;properties.fontSize=properties.ascent+properties.descent;PIXI.Text.fontPropertiesCache[fontStyle]=properties}return properties};PIXI.Text.prototype.wordWrap=function(text){var result="";var lines=text.split("\n");for(var i=0;i<lines.length;i++){var spaceLeft=this.style.wordWrapWidth;var words=lines[i].split(" ");for(var j=0;j<words.length;j++){var wordWidth=this.context.measureText(words[j]).width;var wordWidthWithSpace=wordWidth+this.context.measureText(" ").width;if(j===0||wordWidthWithSpace>spaceLeft){if(j>0){result+="\n"}result+=words[j];spaceLeft=this.style.wordWrapWidth-wordWidth}else{spaceLeft-=wordWidthWithSpace;result+=" "+words[j]}}if(i<lines.length-1){result+="\n"}}return result};PIXI.Text.prototype.getBounds=function(matrix){if(this.dirty){this.updateText();this.dirty=false}return PIXI.Sprite.prototype.getBounds.call(this,matrix)};PIXI.Text.prototype.destroy=function(destroyBaseTexture){this.context=null;this.canvas=null;this.texture.destroy(destroyBaseTexture===undefined?true:destroyBaseTexture)};PIXI.Text.fontPropertiesCache={};PIXI.Text.fontPropertiesCanvas=document.createElement("canvas");PIXI.Text.fontPropertiesContext=PIXI.Text.fontPropertiesCanvas.getContext("2d");PIXI.BitmapText=function(text,style){PIXI.DisplayObjectContainer.call(this);this.textWidth=0;this.textHeight=0;this.maxWidth=0;this.anchor=new Phaser.Point(0,0);this._prevAnchor=new Phaser.Point(0,0);this._pool=[];this.setText(text);this.setStyle(style);this.updateText();this.dirty=false};PIXI.BitmapText.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.BitmapText.prototype.constructor=PIXI.BitmapText;PIXI.BitmapText.prototype.setText=function(text){this.text=text||" ";this.dirty=true};PIXI.BitmapText.prototype.setStyle=function(style){style=style||{};style.align=style.align||"left";this.style=style;var font=style.font.split(" ");this.fontName=font[font.length-1];this.fontSize=font.length>=2?parseInt(font[font.length-2],10):PIXI.BitmapText.fonts[this.fontName].size;this.dirty=true;this.tint=style.tint};PIXI.BitmapText.prototype.updateText=function(){var data=PIXI.BitmapText.fonts[this.fontName];var pos=new PIXI.Point;var prevCharCode=null;var chars=[];var maxLineWidth=0;var lineWidths=[];var line=0;var scale=this.fontSize/data.size;var lastSpace=0;for(var i=0;i<this.text.length;i++){var charCode=this.text.charCodeAt(i);lastSpace=/(\s)/.test(this.text.charAt(i))?i:lastSpace;if(/(?:\r\n|\r|\n)/.test(this.text.charAt(i))){lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue}if(lastSpace!==-1&&this.maxWidth>0&&pos.x*scale>this.maxWidth){chars.splice(lastSpace,i-lastSpace);i=lastSpace;lastSpace=-1;lineWidths.push(lastLineWidth);maxLineWidth=Math.max(maxLineWidth,lastLineWidth);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue}var charData=data.chars[charCode];if(!charData)continue;if(prevCharCode&&charData.kerning[prevCharCode]){pos.x+=charData.kerning[prevCharCode]}chars.push({texture:charData.texture,line:line,charCode:charCode,position:new PIXI.Point(pos.x+charData.xOffset,pos.y+charData.yOffset)});pos.x+=charData.xAdvance;prevCharCode=charCode}lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);var lineAlignOffsets=[];for(i=0;i<=line;i++){var alignOffset=0;if(this.style.align==="right"){alignOffset=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){alignOffset=(maxLineWidth-lineWidths[i])/2}lineAlignOffsets.push(alignOffset)}var lenChildren=this.children.length;var lenChars=chars.length;var tint=this.tint||16777215;this.textWidth=maxLineWidth*scale;this.textHeight=(pos.y+data.lineHeight)*scale;var ax=this.textWidth*this.anchor.x;var ay=this.textHeight*this.anchor.y;for(i=0;i<lenChars;i++){var c=i<lenChildren?this.children[i]:this._pool.pop();if(c)c.setTexture(chars[i].texture);else c=new PIXI.Sprite(chars[i].texture);c.position.x=(chars[i].position.x+lineAlignOffsets[chars[i].line])*scale-ax;c.position.y=chars[i].position.y*scale-ay;c.scale.x=c.scale.y=scale;c.tint=tint;if(!c.parent)this.addChild(c)}while(this.children.length>lenChars){var child=this.getChildAt(this.children.length-1);this._pool.push(child);this.removeChild(child)}};PIXI.BitmapText.prototype.updateTransform=function(){if(this.dirty||!this.anchor.equals(this._prevAnchor)){this.updateText();this.dirty=false;this._prevAnchor.copyFrom(this.anchor)}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.BitmapText.fonts={};PIXI.Stage=function(backgroundColor){PIXI.DisplayObjectContainer.call(this);this.worldTransform=new PIXI.Matrix;this.stage=this;this.setBackgroundColor(backgroundColor)};PIXI.Stage.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Stage.prototype.constructor=PIXI.Stage;PIXI.Stage.prototype.updateTransform=function(){this.worldAlpha=1;for(var i=0;i<this.children.length;i++){this.children[i].updateTransform()}};PIXI.Stage.prototype.setBackgroundColor=function(backgroundColor){this.backgroundColor=backgroundColor||0;this.backgroundColorSplit=PIXI.hex2rgb(this.backgroundColor);var hex=this.backgroundColor.toString(16);hex="000000".substr(0,6-hex.length)+hex;this.backgroundColorString="#"+hex};PIXI.hex2rgb=function(hex){return[(hex>>16&255)/255,(hex>>8&255)/255,(hex&255)/255]};PIXI.rgb2hex=function(rgb){return(rgb[0]*255<<16)+(rgb[1]*255<<8)+rgb[2]*255};PIXI.canUseNewCanvasBlendModes=function(){if(typeof document==="undefined")return false;var pngHead="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABAQMAAADD8p2OAAAAA1BMVEX/";var pngEnd="AAAACklEQVQI12NgAAAAAgAB4iG8MwAAAABJRU5ErkJggg==";var magenta=new Image;magenta.src=pngHead+"AP804Oa6"+pngEnd;var yellow=new Image;yellow.src=pngHead+"/wCKxvRF"+pngEnd;var canvas=document.createElement("canvas");canvas.width=6;canvas.height=1;var context=canvas.getContext("2d");context.globalCompositeOperation="multiply";context.drawImage(magenta,0,0);context.drawImage(yellow,2,0);var data=context.getImageData(2,0,1,1).data;return data[0]===255&&data[1]===0&&data[2]===0};PIXI.getNextPowerOfTwo=function(number){if(number>0&&(number&number-1)===0)return number;else{var result=1;while(result<number)result<<=1;return result}};PIXI.isPowerOfTwo=function(width,height){return width>0&&(width&width-1)===0&&height>0&&(height&height-1)===0};PIXI.PolyK={};PIXI.PolyK.Triangulate=function(p){var sign=true;var n=p.length>>1;if(n<3)return[];var tgs=[];var avl=[];for(var i=0;i<n;i++)avl.push(i);i=0;var al=n;while(al>3){var i0=avl[(i+0)%al];var i1=avl[(i+1)%al];var i2=avl[(i+2)%al];var ax=p[2*i0],ay=p[2*i0+1];var bx=p[2*i1],by=p[2*i1+1];var cx=p[2*i2],cy=p[2*i2+1];var earFound=false;if(PIXI.PolyK._convex(ax,ay,bx,by,cx,cy,sign)){earFound=true;for(var j=0;j<al;j++){var vi=avl[j];if(vi===i0||vi===i1||vi===i2)continue;if(PIXI.PolyK._PointInTriangle(p[2*vi],p[2*vi+1],ax,ay,bx,by,cx,cy)){earFound=false;break}}}if(earFound){tgs.push(i0,i1,i2);avl.splice((i+1)%al,1);al--;i=0}else if(i++>3*al){if(sign){tgs=[];avl=[];for(i=0;i<n;i++)avl.push(i);i=0;al=n;sign=false}else{return null}}}tgs.push(avl[0],avl[1],avl[2]);return tgs};PIXI.PolyK._PointInTriangle=function(px,py,ax,ay,bx,by,cx,cy){var v0x=cx-ax;var v0y=cy-ay;var v1x=bx-ax;var v1y=by-ay;var v2x=px-ax;var v2y=py-ay;var dot00=v0x*v0x+v0y*v0y;var dot01=v0x*v1x+v0y*v1y;var dot02=v0x*v2x+v0y*v2y;var dot11=v1x*v1x+v1y*v1y;var dot12=v1x*v2x+v1y*v2y;var invDenom=1/(dot00*dot11-dot01*dot01);var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;return u>=0&&v>=0&&u+v<1};PIXI.PolyK._convex=function(ax,ay,bx,by,cx,cy,sign){return(ay-by)*(cx-bx)+(bx-ax)*(cy-by)>=0===sign};PIXI.initDefaultShaders=function(){};PIXI.CompileVertexShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.VERTEX_SHADER)};PIXI.CompileFragmentShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.FRAGMENT_SHADER)};PIXI._CompileShader=function(gl,shaderSrc,shaderType){var src=shaderSrc.join("\n");var shader=gl.createShader(shaderType);gl.shaderSource(shader,src);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){window.console.log(gl.getShaderInfoLog(shader));return null}return shader};PIXI.compileProgram=function(gl,vertexSrc,fragmentSrc){var fragmentShader=PIXI.CompileFragmentShader(gl,fragmentSrc);var vertexShader=PIXI.CompileVertexShader(gl,vertexSrc);var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);if(!gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)){window.console.log("Could not initialise shaders")}return shaderProgram};PIXI.PixiShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision lowp float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"];this.textureCount=0;this.firstRun=true;this.dirty=true;this.attributes=[];this.init()};PIXI.PixiShader.prototype.constructor=PIXI.PixiShader;PIXI.PixiShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc||PIXI.PixiShader.defaultVertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.dimensions=gl.getUniformLocation(program,"dimensions");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.colorAttribute=gl.getAttribLocation(program,"aColor");if(this.colorAttribute===-1){this.colorAttribute=2}this.attributes=[this.aVertexPosition,this.aTextureCoord,this.colorAttribute];for(var key in this.uniforms){this.uniforms[key].uniformLocation=gl.getUniformLocation(program,key)}this.initUniforms();this.program=program};PIXI.PixiShader.prototype.initUniforms=function(){this.textureCount=1;var gl=this.gl;var uniform;for(var key in this.uniforms){uniform=this.uniforms[key];var type=uniform.type;if(type==="sampler2D"){uniform._init=false;if(uniform.value!==null){this.initSampler2D(uniform)}}else if(type==="mat2"||type==="mat3"||type==="mat4"){uniform.glMatrix=true;uniform.glValueLength=1;if(type==="mat2"){uniform.glFunc=gl.uniformMatrix2fv}else if(type==="mat3"){uniform.glFunc=gl.uniformMatrix3fv}else if(type==="mat4"){uniform.glFunc=gl.uniformMatrix4fv}}else{uniform.glFunc=gl["uniform"+type];if(type==="2f"||type==="2i"){uniform.glValueLength=2}else if(type==="3f"||type==="3i"){uniform.glValueLength=3}else if(type==="4f"||type==="4i"){uniform.glValueLength=4}else{uniform.glValueLength=1}}}};PIXI.PixiShader.prototype.initSampler2D=function(uniform){if(!uniform.value||!uniform.value.baseTexture||!uniform.value.baseTexture.hasLoaded){return}var gl=this.gl;gl.activeTexture(gl["TEXTURE"+this.textureCount]);gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id]);if(uniform.textureData){var data=uniform.textureData;var magFilter=data.magFilter?data.magFilter:gl.LINEAR;var minFilter=data.minFilter?data.minFilter:gl.LINEAR;var wrapS=data.wrapS?data.wrapS:gl.CLAMP_TO_EDGE;var wrapT=data.wrapT?data.wrapT:gl.CLAMP_TO_EDGE;var format=data.luminance?gl.LUMINANCE:gl.RGBA;if(data.repeat){wrapS=gl.REPEAT;wrapT=gl.REPEAT}gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!!data.flipY);if(data.width){var width=data.width?data.width:512;var height=data.height?data.height:2;var border=data.border?data.border:0;gl.texImage2D(gl.TEXTURE_2D,0,format,width,height,border,format,gl.UNSIGNED_BYTE,null)}else{gl.texImage2D(gl.TEXTURE_2D,0,format,gl.RGBA,gl.UNSIGNED_BYTE,uniform.value.baseTexture.source)}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,magFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrapS);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrapT)}gl.uniform1i(uniform.uniformLocation,this.textureCount);uniform._init=true;this.textureCount++};PIXI.PixiShader.prototype.syncUniforms=function(){this.textureCount=1;var uniform;var gl=this.gl;for(var key in this.uniforms){uniform=this.uniforms[key];if(uniform.glValueLength===1){if(uniform.glMatrix===true){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.transpose,uniform.value)}else{uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value)}}else if(uniform.glValueLength===2){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y)}else if(uniform.glValueLength===3){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z)}else if(uniform.glValueLength===4){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z,uniform.value.w)}else if(uniform.type==="sampler2D"){if(uniform._init){gl.activeTexture(gl["TEXTURE"+this.textureCount]);if(uniform.value.baseTexture._dirty[gl.id]){PIXI.instances[gl.id].updateTexture(uniform.value.baseTexture)}else{gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id])}gl.uniform1i(uniform.uniformLocation,this.textureCount);this.textureCount++}else{this.initSampler2D(uniform)}}}};PIXI.PixiShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.PixiShader.defaultVertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","varying vec2 vTextureCoord;","varying vec4 vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   gl_Position = vec4( ((aVertexPosition + offsetVector) / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = vec4(aColor.rgb * aColor.a, aColor.a);","}"];PIXI.PixiFastShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision lowp float;","varying vec2 vTextureCoord;","varying float vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aPositionCoord;","attribute vec2 aScale;","attribute float aRotation;","attribute vec2 aTextureCoord;","attribute float aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform mat3 uMatrix;","varying vec2 vTextureCoord;","varying float vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   vec2 v;","   vec2 sv = aVertexPosition * aScale;","   v.x = (sv.x) * cos(aRotation) - (sv.y) * sin(aRotation);","   v.y = (sv.x) * sin(aRotation) + (sv.y) * cos(aRotation);","   v = ( uMatrix * vec3(v + aPositionCoord , 1.0) ).xy ;","   gl_Position = vec4( ( v / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = aColor;","}"];
this.textureCount=0;this.init()};PIXI.PixiFastShader.prototype.constructor=PIXI.PixiFastShader;PIXI.PixiFastShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.dimensions=gl.getUniformLocation(program,"dimensions");this.uMatrix=gl.getUniformLocation(program,"uMatrix");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aPositionCoord=gl.getAttribLocation(program,"aPositionCoord");this.aScale=gl.getAttribLocation(program,"aScale");this.aRotation=gl.getAttribLocation(program,"aRotation");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.colorAttribute=gl.getAttribLocation(program,"aColor");if(this.colorAttribute===-1){this.colorAttribute=2}this.attributes=[this.aVertexPosition,this.aPositionCoord,this.aScale,this.aRotation,this.aTextureCoord,this.colorAttribute];this.program=program};PIXI.PixiFastShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.StripShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","uniform float alpha;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * alpha;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","varying vec2 vTextureCoord;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, v.y / -projectionVector.y + 1.0 , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","}"];this.init()};PIXI.StripShader.prototype.constructor=PIXI.StripShader;PIXI.StripShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.colorAttribute=gl.getAttribLocation(program,"aColor");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.attributes=[this.aVertexPosition,this.aTextureCoord];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.StripShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null};PIXI.PrimitiveShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec4 aColor;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform float alpha;","uniform float flipY;","uniform vec3 tint;","varying vec4 vColor;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, (v.y / projectionVector.y * -flipY) + flipY , 0.0, 1.0);","   vColor = aColor * vec4(tint * alpha, alpha);","}"];this.init()};PIXI.PrimitiveShader.prototype.constructor=PIXI.PrimitiveShader;PIXI.PrimitiveShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.tintColor=gl.getUniformLocation(program,"tint");this.flipY=gl.getUniformLocation(program,"flipY");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.colorAttribute=gl.getAttribLocation(program,"aColor");this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.PrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.ComplexPrimitiveShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform vec3 tint;","uniform float alpha;","uniform vec3 color;","uniform float flipY;","varying vec4 vColor;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, (v.y / projectionVector.y * -flipY) + flipY , 0.0, 1.0);","   vColor = vec4(color * alpha * tint, alpha);","}"];this.init()};PIXI.ComplexPrimitiveShader.prototype.constructor=PIXI.ComplexPrimitiveShader;PIXI.ComplexPrimitiveShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.tintColor=gl.getUniformLocation(program,"tint");this.color=gl.getUniformLocation(program,"color");this.flipY=gl.getUniformLocation(program,"flipY");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.ComplexPrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null};PIXI.WebGLGraphics=function(){};PIXI.WebGLGraphics.renderGraphics=function(graphics,renderSession){var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.primitiveShader,webGLData;if(graphics.dirty){PIXI.WebGLGraphics.updateGraphics(graphics,gl)}var webGL=graphics._webGL[gl.id];for(var i=0;i<webGL.data.length;i++){if(webGL.data[i].mode===1){webGLData=webGL.data[i];renderSession.stencilManager.pushStencil(graphics,webGLData,renderSession);gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);renderSession.stencilManager.popStencil(graphics,webGLData,renderSession)}else{webGLData=webGL.data[i];renderSession.shaderManager.setShader(shader);shader=renderSession.shaderManager.primitiveShader;gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform1f(shader.flipY,1);gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer);gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0)}}};PIXI.WebGLGraphics.updateGraphics=function(graphics,gl){var webGL=graphics._webGL[gl.id];if(!webGL)webGL=graphics._webGL[gl.id]={lastIndex:0,data:[],gl:gl};graphics.dirty=false;var i;if(graphics.clearDirty){graphics.clearDirty=false;for(i=0;i<webGL.data.length;i++){var graphicsData=webGL.data[i];graphicsData.reset();PIXI.WebGLGraphics.graphicsDataPool.push(graphicsData)}webGL.data=[];webGL.lastIndex=0}var webGLData;for(i=webGL.lastIndex;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];if(data.type===PIXI.Graphics.POLY){data.points=data.shape.points.slice();if(data.shape.closed){if(data.points[0]!==data.points[data.points.length-2]||data.points[1]!==data.points[data.points.length-1]){data.points.push(data.points[0],data.points[1])}}if(data.fill){if(data.points.length>=6){if(data.points.length<6*2){webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);var canDrawUsingSimple=PIXI.WebGLGraphics.buildPoly(data,webGLData);if(!canDrawUsingSimple){webGLData=PIXI.WebGLGraphics.switchMode(webGL,1);PIXI.WebGLGraphics.buildComplexPoly(data,webGLData)}}else{webGLData=PIXI.WebGLGraphics.switchMode(webGL,1);PIXI.WebGLGraphics.buildComplexPoly(data,webGLData)}}}if(data.lineWidth>0){webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);PIXI.WebGLGraphics.buildLine(data,webGLData)}}else{webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);if(data.type===PIXI.Graphics.RECT){PIXI.WebGLGraphics.buildRectangle(data,webGLData)}else if(data.type===PIXI.Graphics.CIRC||data.type===PIXI.Graphics.ELIP){PIXI.WebGLGraphics.buildCircle(data,webGLData)}else if(data.type===PIXI.Graphics.RREC){PIXI.WebGLGraphics.buildRoundedRectangle(data,webGLData)}}webGL.lastIndex++}for(i=0;i<webGL.data.length;i++){webGLData=webGL.data[i];if(webGLData.dirty)webGLData.upload()}};PIXI.WebGLGraphics.switchMode=function(webGL,type){var webGLData;if(!webGL.data.length){webGLData=PIXI.WebGLGraphics.graphicsDataPool.pop()||new PIXI.WebGLGraphicsData(webGL.gl);webGLData.mode=type;webGL.data.push(webGLData)}else{webGLData=webGL.data[webGL.data.length-1];if(webGLData.mode!==type||type===1){webGLData=PIXI.WebGLGraphics.graphicsDataPool.pop()||new PIXI.WebGLGraphicsData(webGL.gl);webGLData.mode=type;webGL.data.push(webGLData)}}webGLData.dirty=true;return webGLData};PIXI.WebGLGraphics.buildRectangle=function(graphicsData,webGLData){var rectData=graphicsData.shape;var x=rectData.x;var y=rectData.y;var width=rectData.width;var height=rectData.height;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vertPos=verts.length/6;verts.push(x,y);verts.push(r,g,b,alpha);verts.push(x+width,y);verts.push(r,g,b,alpha);verts.push(x,y+height);verts.push(r,g,b,alpha);verts.push(x+width,y+height);verts.push(r,g,b,alpha);indices.push(vertPos,vertPos,vertPos+1,vertPos+2,vertPos+3,vertPos+3)}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[x,y,x+width,y,x+width,y+height,x,y+height,x,y];PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.buildRoundedRectangle=function(graphicsData,webGLData){var rrectData=graphicsData.shape;var x=rrectData.x;var y=rrectData.y;var width=rrectData.width;var height=rrectData.height;var radius=rrectData.radius;var recPoints=[];recPoints.push(x,y+radius);recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x,y+height-radius,x,y+height,x+radius,y+height));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+width-radius,y+height,x+width,y+height,x+width,y+height-radius));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+width,y+radius,x+width,y,x+width-radius,y));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+radius,y,x,y,x,y+radius));if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;var triangles=PIXI.PolyK.Triangulate(recPoints);var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vecPos);indices.push(triangles[i]+vecPos);indices.push(triangles[i+1]+vecPos);indices.push(triangles[i+2]+vecPos);indices.push(triangles[i+2]+vecPos)}for(i=0;i<recPoints.length;i++){verts.push(recPoints[i],recPoints[++i],r,g,b,alpha)}}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=recPoints;PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.quadraticBezierCurve=function(fromX,fromY,cpX,cpY,toX,toY){var xa,ya,xb,yb,x,y,n=20,points=[];function getPt(n1,n2,perc){var diff=n2-n1;return n1+diff*perc}var j=0;for(var i=0;i<=n;i++){j=i/n;xa=getPt(fromX,cpX,j);ya=getPt(fromY,cpY,j);xb=getPt(cpX,toX,j);yb=getPt(cpY,toY,j);x=getPt(xa,xb,j);y=getPt(ya,yb,j);points.push(x,y)}return points};PIXI.WebGLGraphics.buildCircle=function(graphicsData,webGLData){var circleData=graphicsData.shape;var x=circleData.x;var y=circleData.y;var width;var height;if(graphicsData.type===PIXI.Graphics.CIRC){width=circleData.radius;height=circleData.radius}else{width=circleData.width;height=circleData.height}var totalSegs=40;var seg=Math.PI*2/totalSegs;var i=0;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;indices.push(vecPos);for(i=0;i<totalSegs+1;i++){verts.push(x,y,r,g,b,alpha);verts.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height,r,g,b,alpha);indices.push(vecPos++,vecPos++)}indices.push(vecPos-1)}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[];for(i=0;i<totalSegs+1;i++){graphicsData.points.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height)}PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.buildLine=function(graphicsData,webGLData){var i=0;var points=graphicsData.points;if(points.length===0)return;if(graphicsData.lineWidth%2){for(i=0;i<points.length;i++){points[i]+=.5}}var firstPoint=new PIXI.Point(points[0],points[1]);var lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);if(firstPoint.x===lastPoint.x&&firstPoint.y===lastPoint.y){points=points.slice();points.pop();points.pop();lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);var midPointX=lastPoint.x+(firstPoint.x-lastPoint.x)*.5;var midPointY=lastPoint.y+(firstPoint.y-lastPoint.y)*.5;points.unshift(midPointX,midPointY);points.push(midPointX,midPointY)}var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var indexCount=points.length;var indexStart=verts.length/6;var width=graphicsData.lineWidth/2;var color=PIXI.hex2rgb(graphicsData.lineColor);var alpha=graphicsData.lineAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var px,py,p1x,p1y,p2x,p2y,p3x,p3y;var perpx,perpy,perp2x,perp2y,perp3x,perp3y;var a1,b1,c1,a2,b2,c2;var denom,pdist,dist;p1x=points[0];p1y=points[1];p2x=points[2];p2y=points[3];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p1x-perpx,p1y-perpy,r,g,b,alpha);verts.push(p1x+perpx,p1y+perpy,r,g,b,alpha);for(i=1;i<length-1;i++){p1x=points[(i-1)*2];p1y=points[(i-1)*2+1];p2x=points[i*2];p2y=points[i*2+1];p3x=points[(i+1)*2];p3y=points[(i+1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;perp2x=-(p2y-p3y);perp2y=p2x-p3x;dist=Math.sqrt(perp2x*perp2x+perp2y*perp2y);perp2x/=dist;perp2y/=dist;perp2x*=width;perp2y*=width;a1=-perpy+p1y-(-perpy+p2y);b1=-perpx+p2x-(-perpx+p1x);c1=(-perpx+p1x)*(-perpy+p2y)-(-perpx+p2x)*(-perpy+p1y);a2=-perp2y+p3y-(-perp2y+p2y);b2=-perp2x+p2x-(-perp2x+p3x);c2=(-perp2x+p3x)*(-perp2y+p2y)-(-perp2x+p2x)*(-perp2y+p3y);denom=a1*b2-a2*b1;if(Math.abs(denom)<.1){denom+=10.1;verts.push(p2x-perpx,p2y-perpy,r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy,r,g,b,alpha);continue}px=(b1*c2-b2*c1)/denom;py=(a2*c1-a1*c2)/denom;pdist=(px-p2x)*(px-p2x)+(py-p2y)+(py-p2y);if(pdist>140*140){perp3x=perpx-perp2x;perp3y=perpy-perp2y;dist=Math.sqrt(perp3x*perp3x+perp3y*perp3y);perp3x/=dist;perp3y/=dist;perp3x*=width;perp3y*=width;verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);verts.push(p2x+perp3x,p2y+perp3y);verts.push(r,g,b,alpha);verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);indexCount++}else{verts.push(px,py);verts.push(r,g,b,alpha);verts.push(p2x-(px-p2x),p2y-(py-p2y));verts.push(r,g,b,alpha)}}p1x=points[(length-2)*2];p1y=points[(length-2)*2+1];p2x=points[(length-1)*2];p2y=points[(length-1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p2x-perpx,p2y-perpy);verts.push(r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy);verts.push(r,g,b,alpha);indices.push(indexStart);for(i=0;i<indexCount;i++){indices.push(indexStart++)}indices.push(indexStart-1)};PIXI.WebGLGraphics.buildComplexPoly=function(graphicsData,webGLData){var points=graphicsData.points.slice();if(points.length<6)return;var indices=webGLData.indices;webGLData.points=points;webGLData.alpha=graphicsData.fillAlpha;webGLData.color=PIXI.hex2rgb(graphicsData.fillColor);var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;var x,y;for(var i=0;i<points.length;i+=2){x=points[i];y=points[i+1];minX=x<minX?x:minX;maxX=x>maxX?x:maxX;minY=y<minY?y:minY;maxY=y>maxY?y:maxY}points.push(minX,minY,maxX,minY,maxX,maxY,minX,maxY);var length=points.length/2;for(i=0;i<length;i++){indices.push(i)}};PIXI.WebGLGraphics.buildPoly=function(graphicsData,webGLData){var points=graphicsData.points;if(points.length<6)return;var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var triangles=PIXI.PolyK.Triangulate(points);if(!triangles)return false;var vertPos=verts.length/6;var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vertPos);indices.push(triangles[i]+vertPos);indices.push(triangles[i+1]+vertPos);indices.push(triangles[i+2]+vertPos);indices.push(triangles[i+2]+vertPos)}for(i=0;i<length;i++){verts.push(points[i*2],points[i*2+1],r,g,b,alpha)}return true};PIXI.WebGLGraphics.graphicsDataPool=[];PIXI.WebGLGraphicsData=function(gl){this.gl=gl;this.color=[0,0,0];this.points=[];this.indices=[];this.buffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.mode=1;this.alpha=1;this.dirty=true};PIXI.WebGLGraphicsData.prototype.reset=function(){this.points=[];this.indices=[]};PIXI.WebGLGraphicsData.prototype.upload=function(){var gl=this.gl;this.glPoints=new PIXI.Float32Array(this.points);gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer);gl.bufferData(gl.ARRAY_BUFFER,this.glPoints,gl.STATIC_DRAW);this.glIndicies=new PIXI.Uint16Array(this.indices);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.glIndicies,gl.STATIC_DRAW);this.dirty=false};PIXI.glContexts=[];PIXI.instances=[];PIXI.WebGLRenderer=function(width,height,options){if(options){for(var i in PIXI.defaultRenderOptions){if(typeof options[i]==="undefined")options[i]=PIXI.defaultRenderOptions[i]}}else{options=PIXI.defaultRenderOptions}if(!PIXI.defaultRenderer){PIXI.defaultRenderer=this}this.type=PIXI.WEBGL_RENDERER;this.resolution=options.resolution;this.transparent=options.transparent;this.autoResize=options.autoResize||false;this.preserveDrawingBuffer=options.preserveDrawingBuffer;this.clearBeforeRender=options.clearBeforeRender;this.width=width||800;this.height=height||600;this.view=options.view||document.createElement("canvas");this.contextLostBound=this.handleContextLost.bind(this);this.contextRestoredBound=this.handleContextRestored.bind(this);this.view.addEventListener("webglcontextlost",this.contextLostBound,false);this.view.addEventListener("webglcontextrestored",this.contextRestoredBound,false);this._contextOptions={alpha:this.transparent,antialias:options.antialias,premultipliedAlpha:this.transparent&&this.transparent!=="notMultiplied",stencil:true,preserveDrawingBuffer:options.preserveDrawingBuffer};this.projection=new PIXI.Point;this.offset=new PIXI.Point(0,0);this.shaderManager=new PIXI.WebGLShaderManager;this.spriteBatch=new PIXI.WebGLSpriteBatch;this.maskManager=new PIXI.WebGLMaskManager;this.filterManager=new PIXI.WebGLFilterManager;this.stencilManager=new PIXI.WebGLStencilManager;this.blendModeManager=new PIXI.WebGLBlendModeManager;this.renderSession={};this.renderSession.gl=this.gl;this.renderSession.drawCount=0;this.renderSession.shaderManager=this.shaderManager;this.renderSession.maskManager=this.maskManager;this.renderSession.filterManager=this.filterManager;this.renderSession.blendModeManager=this.blendModeManager;this.renderSession.spriteBatch=this.spriteBatch;this.renderSession.stencilManager=this.stencilManager;this.renderSession.renderer=this;this.renderSession.resolution=this.resolution;this.initContext();this.mapBlendModes()};PIXI.WebGLRenderer.prototype.constructor=PIXI.WebGLRenderer;PIXI.WebGLRenderer.prototype.initContext=function(){var gl=this.view.getContext("webgl",this._contextOptions)||this.view.getContext("experimental-webgl",this._contextOptions);this.gl=gl;if(!gl){throw new Error("This browser does not support webGL. Try using the canvas renderer")}this.glContextId=gl.id=PIXI.WebGLRenderer.glContextId++;PIXI.glContexts[this.glContextId]=gl;PIXI.instances[this.glContextId]=this;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);this.shaderManager.setContext(gl);this.spriteBatch.setContext(gl);this.maskManager.setContext(gl);this.filterManager.setContext(gl);this.blendModeManager.setContext(gl);this.stencilManager.setContext(gl);this.renderSession.gl=this.gl;this.resize(this.width,this.height)};PIXI.WebGLRenderer.prototype.render=function(stage){if(this.contextLost)return;if(this.__stage!==stage){this.__stage=stage}stage.updateTransform();var gl=this.gl;gl.viewport(0,0,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.clearBeforeRender){if(this.transparent){gl.clearColor(0,0,0,0)}else{gl.clearColor(stage.backgroundColorSplit[0],stage.backgroundColorSplit[1],stage.backgroundColorSplit[2],1)}gl.clear(gl.COLOR_BUFFER_BIT)}this.renderDisplayObject(stage,this.projection)};PIXI.WebGLRenderer.prototype.renderDisplayObject=function(displayObject,projection,buffer){this.renderSession.blendModeManager.setBlendMode(PIXI.blendModes.NORMAL);this.renderSession.drawCount=0;this.renderSession.flipY=buffer?-1:1;this.renderSession.projection=projection;this.renderSession.offset=this.offset;this.spriteBatch.begin(this.renderSession);this.filterManager.begin(this.renderSession,buffer);displayObject._renderWebGL(this.renderSession);this.spriteBatch.end()};PIXI.WebGLRenderer.prototype.resize=function(width,height){this.width=width*this.resolution;this.height=height*this.resolution;this.view.width=this.width;this.view.height=this.height;if(this.autoResize){this.view.style.width=this.width/this.resolution+"px";this.view.style.height=this.height/this.resolution+"px"}this.gl.viewport(0,0,this.width,this.height);this.projection.x=this.width/2/this.resolution;this.projection.y=-this.height/2/this.resolution};PIXI.WebGLRenderer.prototype.updateTexture=function(texture){if(!texture.hasLoaded)return;var gl=this.gl;if(!texture._glTextures[gl.id])texture._glTextures[gl.id]=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id]);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,texture.premultipliedAlpha);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.source);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);if(texture.mipmap&&PIXI.isPowerOfTwo(texture.width,texture.height)){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR_MIPMAP_LINEAR:gl.NEAREST_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D)}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST)}if(!texture._powerOf2){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT)}texture._dirty[gl.id]=false;return texture._glTextures[gl.id]};PIXI.WebGLRenderer.prototype.handleContextLost=function(event){event.preventDefault();this.contextLost=true};PIXI.WebGLRenderer.prototype.handleContextRestored=function(){this.initContext();for(var key in PIXI.TextureCache){var texture=PIXI.TextureCache[key].baseTexture;texture._glTextures=[]}this.contextLost=false};PIXI.WebGLRenderer.prototype.destroy=function(){this.view.removeEventListener("webglcontextlost",this.contextLostBound);this.view.removeEventListener("webglcontextrestored",this.contextRestoredBound);PIXI.glContexts[this.glContextId]=null;this.projection=null;this.offset=null;this.shaderManager.destroy();this.spriteBatch.destroy();this.maskManager.destroy();this.filterManager.destroy();this.shaderManager=null;this.spriteBatch=null;this.maskManager=null;this.filterManager=null;this.gl=null;this.renderSession=null;PIXI.instances[this.glContextId]=null;PIXI.WebGLRenderer.glContextId--};PIXI.WebGLRenderer.prototype.mapBlendModes=function(){var gl=this.gl;if(!PIXI.blendModesWebGL){PIXI.blendModesWebGL=[];PIXI.blendModesWebGL[PIXI.blendModes.NORMAL]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.ADD]=[gl.SRC_ALPHA,gl.DST_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.MULTIPLY]=[gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SCREEN]=[gl.SRC_ALPHA,gl.ONE];PIXI.blendModesWebGL[PIXI.blendModes.OVERLAY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DARKEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LIGHTEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_DODGE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_BURN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HARD_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SOFT_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DIFFERENCE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.EXCLUSION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HUE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SATURATION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LUMINOSITY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA]}};PIXI.WebGLRenderer.glContextId=0;PIXI.WebGLBlendModeManager=function(){this.currentBlendMode=99999};PIXI.WebGLBlendModeManager.prototype.constructor=PIXI.WebGLBlendModeManager;PIXI.WebGLBlendModeManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLBlendModeManager.prototype.setBlendMode=function(blendMode){if(this.currentBlendMode===blendMode)return false;this.currentBlendMode=blendMode;var blendModeWebGL=PIXI.blendModesWebGL[this.currentBlendMode];this.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1]);return true};PIXI.WebGLBlendModeManager.prototype.destroy=function(){this.gl=null};PIXI.WebGLMaskManager=function(){};PIXI.WebGLMaskManager.prototype.constructor=PIXI.WebGLMaskManager;PIXI.WebGLMaskManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLMaskManager.prototype.pushMask=function(maskData,renderSession){var gl=renderSession.gl;if(maskData.dirty){PIXI.WebGLGraphics.updateGraphics(maskData,gl)}if(!maskData._webGL[gl.id].data.length)return;renderSession.stencilManager.pushStencil(maskData,maskData._webGL[gl.id].data[0],renderSession)};PIXI.WebGLMaskManager.prototype.popMask=function(maskData,renderSession){var gl=this.gl;renderSession.stencilManager.popStencil(maskData,maskData._webGL[gl.id].data[0],renderSession)};PIXI.WebGLMaskManager.prototype.destroy=function(){this.gl=null};PIXI.WebGLStencilManager=function(){this.stencilStack=[];this.reverse=true;this.count=0};PIXI.WebGLStencilManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLStencilManager.prototype.pushStencil=function(graphics,webGLData,renderSession){var gl=this.gl;this.bindGraphics(graphics,webGLData,renderSession);if(this.stencilStack.length===0){gl.enable(gl.STENCIL_TEST);gl.clear(gl.STENCIL_BUFFER_BIT);this.reverse=true;this.count=0}this.stencilStack.push(webGLData);var level=this.count;gl.colorMask(false,false,false,false);gl.stencilFunc(gl.ALWAYS,0,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INVERT);if(webGLData.mode===1){gl.drawElements(gl.TRIANGLE_FAN,webGLData.indices.length-4,gl.UNSIGNED_SHORT,0);if(this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}else{gl.stencilFunc(gl.EQUAL,level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);if(this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255)}else{gl.stencilFunc(gl.EQUAL,level+1,255)}this.reverse=!this.reverse}else{if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}else{gl.stencilFunc(gl.EQUAL,level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255)}else{gl.stencilFunc(gl.EQUAL,level+1,255)}}gl.colorMask(true,true,true,true);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP);this.count++};PIXI.WebGLStencilManager.prototype.bindGraphics=function(graphics,webGLData,renderSession){this._currentGraphics=graphics;var gl=this.gl;var projection=renderSession.projection,offset=renderSession.offset,shader;if(webGLData.mode===1){shader=renderSession.shaderManager.complexPrimitiveShader;renderSession.shaderManager.setShader(shader);gl.uniform1f(shader.flipY,renderSession.flipY);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform3fv(shader.color,webGLData.color);gl.uniform1f(shader.alpha,graphics.worldAlpha*webGLData.alpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*2,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer)}else{shader=renderSession.shaderManager.primitiveShader;renderSession.shaderManager.setShader(shader);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform1f(shader.flipY,renderSession.flipY);gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer)}};PIXI.WebGLStencilManager.prototype.popStencil=function(graphics,webGLData,renderSession){var gl=this.gl;this.stencilStack.pop();this.count--;if(this.stencilStack.length===0){gl.disable(gl.STENCIL_TEST)}else{var level=this.count;this.bindGraphics(graphics,webGLData,renderSession);gl.colorMask(false,false,false,false);if(webGLData.mode===1){this.reverse=!this.reverse;if(this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255);
gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}else{gl.stencilFunc(gl.EQUAL,level+1,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);gl.stencilFunc(gl.ALWAYS,0,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INVERT);gl.drawElements(gl.TRIANGLE_FAN,webGLData.indices.length-4,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255)}else{gl.stencilFunc(gl.EQUAL,level,255)}}else{if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}else{gl.stencilFunc(gl.EQUAL,level+1,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255)}else{gl.stencilFunc(gl.EQUAL,level,255)}}gl.colorMask(true,true,true,true);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP)}};PIXI.WebGLStencilManager.prototype.destroy=function(){this.stencilStack=null;this.gl=null};PIXI.WebGLShaderManager=function(){this.maxAttibs=10;this.attribState=[];this.tempAttribState=[];for(var i=0;i<this.maxAttibs;i++){this.attribState[i]=false}this.stack=[]};PIXI.WebGLShaderManager.prototype.constructor=PIXI.WebGLShaderManager;PIXI.WebGLShaderManager.prototype.setContext=function(gl){this.gl=gl;this.primitiveShader=new PIXI.PrimitiveShader(gl);this.complexPrimitiveShader=new PIXI.ComplexPrimitiveShader(gl);this.defaultShader=new PIXI.PixiShader(gl);this.fastShader=new PIXI.PixiFastShader(gl);this.stripShader=new PIXI.StripShader(gl);this.setShader(this.defaultShader)};PIXI.WebGLShaderManager.prototype.setAttribs=function(attribs){var i;for(i=0;i<this.tempAttribState.length;i++){this.tempAttribState[i]=false}for(i=0;i<attribs.length;i++){var attribId=attribs[i];this.tempAttribState[attribId]=true}var gl=this.gl;for(i=0;i<this.attribState.length;i++){if(this.attribState[i]!==this.tempAttribState[i]){this.attribState[i]=this.tempAttribState[i];if(this.tempAttribState[i]){gl.enableVertexAttribArray(i)}else{gl.disableVertexAttribArray(i)}}}};PIXI.WebGLShaderManager.prototype.setShader=function(shader){if(this._currentId===shader._UID)return false;this._currentId=shader._UID;this.currentShader=shader;this.gl.useProgram(shader.program);this.setAttribs(shader.attributes);return true};PIXI.WebGLShaderManager.prototype.destroy=function(){this.attribState=null;this.tempAttribState=null;this.primitiveShader.destroy();this.complexPrimitiveShader.destroy();this.defaultShader.destroy();this.fastShader.destroy();this.stripShader.destroy();this.gl=null};PIXI.WebGLSpriteBatch=function(){this.vertSize=5;this.size=2e3;var numVerts=this.size*4*4*this.vertSize;var numIndices=this.size*6;this.vertices=new PIXI.ArrayBuffer(numVerts);this.positions=new PIXI.Float32Array(this.vertices);this.colors=new PIXI.Uint32Array(this.vertices);this.indices=new PIXI.Uint16Array(numIndices);this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3}this.drawing=false;this.currentBatchSize=0;this.currentBaseTexture=null;this.dirty=true;this.textures=[];this.blendModes=[];this.shaders=[];this.sprites=[];this.defaultShader=new PIXI.AbstractFilter(["precision lowp float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"])};PIXI.WebGLSpriteBatch.prototype.setContext=function(gl){this.gl=gl;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);this.currentBlendMode=99999;var shader=new PIXI.PixiShader(gl);shader.fragmentSrc=this.defaultShader.fragmentSrc;shader.uniforms={};shader.init();this.defaultShader.shaders[gl.id]=shader};PIXI.WebGLSpriteBatch.prototype.begin=function(renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.defaultShader;this.start()};PIXI.WebGLSpriteBatch.prototype.end=function(){this.flush()};PIXI.WebGLSpriteBatch.prototype.render=function(sprite){var texture=sprite.texture;if(this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture}var uvs=texture._uvs;if(!uvs)return;var aX=sprite.anchor.x;var aY=sprite.anchor.y;var w0,w1,h0,h1;if(texture.trim){var trim=texture.trim;w1=trim.x-aX*trim.width;w0=w1+texture.crop.width;h1=trim.y-aY*trim.height;h0=h1+texture.crop.height}else{w0=texture.frame.width*(1-aX);w1=texture.frame.width*-aX;h0=texture.frame.height*(1-aY);h1=texture.frame.height*-aY}var index=this.currentBatchSize*4*this.vertSize;var resolution=texture.baseTexture.resolution;var worldTransform=sprite.worldTransform;var a=worldTransform.a/resolution;var b=worldTransform.b/resolution;var c=worldTransform.c/resolution;var d=worldTransform.d/resolution;var tx=worldTransform.tx;var ty=worldTransform.ty;var colors=this.colors;var positions=this.positions;if(this.renderSession.roundPixels){positions[index]=a*w1+c*h1+tx|0;positions[index+1]=d*h1+b*w1+ty|0;positions[index+5]=a*w0+c*h1+tx|0;positions[index+6]=d*h1+b*w0+ty|0;positions[index+10]=a*w0+c*h0+tx|0;positions[index+11]=d*h0+b*w0+ty|0;positions[index+15]=a*w1+c*h0+tx|0;positions[index+16]=d*h0+b*w1+ty|0}else{positions[index]=a*w1+c*h1+tx;positions[index+1]=d*h1+b*w1+ty;positions[index+5]=a*w0+c*h1+tx;positions[index+6]=d*h1+b*w0+ty;positions[index+10]=a*w0+c*h0+tx;positions[index+11]=d*h0+b*w0+ty;positions[index+15]=a*w1+c*h0+tx;positions[index+16]=d*h0+b*w1+ty}positions[index+2]=uvs.x0;positions[index+3]=uvs.y0;positions[index+7]=uvs.x1;positions[index+8]=uvs.y1;positions[index+12]=uvs.x2;positions[index+13]=uvs.y2;positions[index+17]=uvs.x3;positions[index+18]=uvs.y3;var tint=sprite.tint;colors[index+4]=colors[index+9]=colors[index+14]=colors[index+19]=(tint>>16)+(tint&65280)+((tint&255)<<16)+(sprite.worldAlpha*255<<24);this.sprites[this.currentBatchSize++]=sprite};PIXI.WebGLSpriteBatch.prototype.renderTilingSprite=function(tilingSprite){var texture=tilingSprite.tilingTexture;if(this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture}if(!tilingSprite._uvs)tilingSprite._uvs=new PIXI.TextureUvs;var uvs=tilingSprite._uvs;tilingSprite.tilePosition.x%=texture.baseTexture.width*tilingSprite.tileScaleOffset.x;tilingSprite.tilePosition.y%=texture.baseTexture.height*tilingSprite.tileScaleOffset.y;var offsetX=tilingSprite.tilePosition.x/(texture.baseTexture.width*tilingSprite.tileScaleOffset.x);var offsetY=tilingSprite.tilePosition.y/(texture.baseTexture.height*tilingSprite.tileScaleOffset.y);var scaleX=tilingSprite.width/texture.baseTexture.width/(tilingSprite.tileScale.x*tilingSprite.tileScaleOffset.x);var scaleY=tilingSprite.height/texture.baseTexture.height/(tilingSprite.tileScale.y*tilingSprite.tileScaleOffset.y);uvs.x0=0-offsetX;uvs.y0=0-offsetY;uvs.x1=1*scaleX-offsetX;uvs.y1=0-offsetY;uvs.x2=1*scaleX-offsetX;uvs.y2=1*scaleY-offsetY;uvs.x3=0-offsetX;uvs.y3=1*scaleY-offsetY;var tint=tilingSprite.tint;var color=(tint>>16)+(tint&65280)+((tint&255)<<16)+(tilingSprite.alpha*255<<24);var positions=this.positions;var colors=this.colors;var width=tilingSprite.width;var height=tilingSprite.height;var aX=tilingSprite.anchor.x;var aY=tilingSprite.anchor.y;var w0=width*(1-aX);var w1=width*-aX;var h0=height*(1-aY);var h1=height*-aY;var index=this.currentBatchSize*4*this.vertSize;var resolution=texture.baseTexture.resolution;var worldTransform=tilingSprite.worldTransform;var a=worldTransform.a/resolution;var b=worldTransform.b/resolution;var c=worldTransform.c/resolution;var d=worldTransform.d/resolution;var tx=worldTransform.tx;var ty=worldTransform.ty;positions[index++]=a*w1+c*h1+tx;positions[index++]=d*h1+b*w1+ty;positions[index++]=uvs.x0;positions[index++]=uvs.y0;colors[index++]=color;positions[index++]=a*w0+c*h1+tx;positions[index++]=d*h1+b*w0+ty;positions[index++]=uvs.x1;positions[index++]=uvs.y1;colors[index++]=color;positions[index++]=a*w0+c*h0+tx;positions[index++]=d*h0+b*w0+ty;positions[index++]=uvs.x2;positions[index++]=uvs.y2;colors[index++]=color;positions[index++]=a*w1+c*h0+tx;positions[index++]=d*h0+b*w1+ty;positions[index++]=uvs.x3;positions[index++]=uvs.y3;colors[index++]=color;this.sprites[this.currentBatchSize++]=tilingSprite};PIXI.WebGLSpriteBatch.prototype.flush=function(){if(this.currentBatchSize===0)return;var gl=this.gl;var shader;if(this.dirty){this.dirty=false;gl.activeTexture(gl.TEXTURE0);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);shader=this.defaultShader.shaders[gl.id];var stride=this.vertSize*4;gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(shader.colorAttribute,4,gl.UNSIGNED_BYTE,true,stride,4*4)}if(this.currentBatchSize>this.size*.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices)}else{var view=this.positions.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view)}var nextTexture,nextBlendMode,nextShader;var batchSize=0;var start=0;var currentBaseTexture=null;var currentBlendMode=this.renderSession.blendModeManager.currentBlendMode;var currentShader=null;var blendSwap=false;var shaderSwap=false;var sprite;for(var i=0,j=this.currentBatchSize;i<j;i++){sprite=this.sprites[i];nextTexture=sprite.texture.baseTexture;nextBlendMode=sprite.blendMode;nextShader=sprite.shader||this.defaultShader;blendSwap=currentBlendMode!==nextBlendMode;shaderSwap=currentShader!==nextShader;if(currentBaseTexture!==nextTexture||blendSwap||shaderSwap){this.renderBatch(currentBaseTexture,batchSize,start);start=i;batchSize=0;currentBaseTexture=nextTexture;if(blendSwap){currentBlendMode=nextBlendMode;this.renderSession.blendModeManager.setBlendMode(currentBlendMode)}if(shaderSwap){currentShader=nextShader;shader=currentShader.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=currentShader.fragmentSrc;shader.uniforms=currentShader.uniforms;shader.init();currentShader.shaders[gl.id]=shader}this.renderSession.shaderManager.setShader(shader);if(shader.dirty)shader.syncUniforms();var projection=this.renderSession.projection;gl.uniform2f(shader.projectionVector,projection.x,projection.y);var offsetVector=this.renderSession.offset;gl.uniform2f(shader.offsetVector,offsetVector.x,offsetVector.y)}}batchSize++}this.renderBatch(currentBaseTexture,batchSize,start);this.currentBatchSize=0};PIXI.WebGLSpriteBatch.prototype.renderBatch=function(texture,size,startIndex){if(size===0)return;var gl=this.gl;if(texture._dirty[gl.id]){this.renderSession.renderer.updateTexture(texture)}else{gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id])}gl.drawElements(gl.TRIANGLES,size*6,gl.UNSIGNED_SHORT,startIndex*6*2);this.renderSession.drawCount++};PIXI.WebGLSpriteBatch.prototype.stop=function(){this.flush();this.dirty=true};PIXI.WebGLSpriteBatch.prototype.start=function(){this.dirty=true};PIXI.WebGLSpriteBatch.prototype.destroy=function(){this.vertices=null;this.indices=null;this.gl.deleteBuffer(this.vertexBuffer);this.gl.deleteBuffer(this.indexBuffer);this.currentBaseTexture=null;this.gl=null};PIXI.WebGLFastSpriteBatch=function(gl){this.vertSize=10;this.maxSize=6e3;this.size=this.maxSize;var numVerts=this.size*4*this.vertSize;var numIndices=this.maxSize*6;this.vertices=new PIXI.Float32Array(numVerts);this.indices=new PIXI.Uint16Array(numIndices);this.vertexBuffer=null;this.indexBuffer=null;this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3}this.drawing=false;this.currentBatchSize=0;this.currentBaseTexture=null;this.currentBlendMode=0;this.renderSession=null;this.shader=null;this.matrix=null;this.setContext(gl)};PIXI.WebGLFastSpriteBatch.prototype.constructor=PIXI.WebGLFastSpriteBatch;PIXI.WebGLFastSpriteBatch.prototype.setContext=function(gl){this.gl=gl;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW)};PIXI.WebGLFastSpriteBatch.prototype.begin=function(spriteBatch,renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.fastShader;this.matrix=spriteBatch.worldTransform.toArray(true);this.start()};PIXI.WebGLFastSpriteBatch.prototype.end=function(){this.flush()};PIXI.WebGLFastSpriteBatch.prototype.render=function(spriteBatch){var children=spriteBatch.children;var sprite=children[0];if(!sprite.texture._uvs)return;this.currentBaseTexture=sprite.texture.baseTexture;if(sprite.blendMode!==this.renderSession.blendModeManager.currentBlendMode){this.flush();this.renderSession.blendModeManager.setBlendMode(sprite.blendMode)}for(var i=0,j=children.length;i<j;i++){this.renderSprite(children[i])}this.flush()};PIXI.WebGLFastSpriteBatch.prototype.renderSprite=function(sprite){if(!sprite.visible)return;if(sprite.texture.baseTexture!==this.currentBaseTexture){this.flush();this.currentBaseTexture=sprite.texture.baseTexture;if(!sprite.texture._uvs)return}var uvs,vertices=this.vertices,width,height,w0,w1,h0,h1,index;uvs=sprite.texture._uvs;width=sprite.texture.frame.width;height=sprite.texture.frame.height;if(sprite.texture.trim){var trim=sprite.texture.trim;w1=trim.x-sprite.anchor.x*trim.width;w0=w1+sprite.texture.crop.width;h1=trim.y-sprite.anchor.y*trim.height;h0=h1+sprite.texture.crop.height}else{w0=sprite.texture.frame.width*(1-sprite.anchor.x);w1=sprite.texture.frame.width*-sprite.anchor.x;h0=sprite.texture.frame.height*(1-sprite.anchor.y);h1=sprite.texture.frame.height*-sprite.anchor.y}index=this.currentBatchSize*4*this.vertSize;vertices[index++]=w1;vertices[index++]=h1;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x0;vertices[index++]=uvs.y1;vertices[index++]=sprite.alpha;vertices[index++]=w0;vertices[index++]=h1;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x1;vertices[index++]=uvs.y1;vertices[index++]=sprite.alpha;vertices[index++]=w0;vertices[index++]=h0;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x2;vertices[index++]=uvs.y2;vertices[index++]=sprite.alpha;vertices[index++]=w1;vertices[index++]=h0;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x3;vertices[index++]=uvs.y3;vertices[index++]=sprite.alpha;this.currentBatchSize++;if(this.currentBatchSize>=this.size){this.flush()}};PIXI.WebGLFastSpriteBatch.prototype.flush=function(){if(this.currentBatchSize===0)return;var gl=this.gl;if(!this.currentBaseTexture._glTextures[gl.id])this.renderSession.renderer.updateTexture(this.currentBaseTexture,gl);gl.bindTexture(gl.TEXTURE_2D,this.currentBaseTexture._glTextures[gl.id]);if(this.currentBatchSize>this.size*.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices)}else{var view=this.vertices.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view)}gl.drawElements(gl.TRIANGLES,this.currentBatchSize*6,gl.UNSIGNED_SHORT,0);this.currentBatchSize=0;this.renderSession.drawCount++};PIXI.WebGLFastSpriteBatch.prototype.stop=function(){this.flush()};PIXI.WebGLFastSpriteBatch.prototype.start=function(){var gl=this.gl;gl.activeTexture(gl.TEXTURE0);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var projection=this.renderSession.projection;gl.uniform2f(this.shader.projectionVector,projection.x,projection.y);gl.uniformMatrix3fv(this.shader.uMatrix,false,this.matrix);var stride=this.vertSize*4;gl.vertexAttribPointer(this.shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(this.shader.aPositionCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(this.shader.aScale,2,gl.FLOAT,false,stride,4*4);gl.vertexAttribPointer(this.shader.aRotation,1,gl.FLOAT,false,stride,6*4);gl.vertexAttribPointer(this.shader.aTextureCoord,2,gl.FLOAT,false,stride,7*4);gl.vertexAttribPointer(this.shader.colorAttribute,1,gl.FLOAT,false,stride,9*4)};PIXI.WebGLFilterManager=function(){this.filterStack=[];this.offsetX=0;this.offsetY=0};PIXI.WebGLFilterManager.prototype.constructor=PIXI.WebGLFilterManager;PIXI.WebGLFilterManager.prototype.setContext=function(gl){this.gl=gl;this.texturePool=[];this.initShaderBuffers()};PIXI.WebGLFilterManager.prototype.begin=function(renderSession,buffer){this.renderSession=renderSession;this.defaultShader=renderSession.shaderManager.defaultShader;var projection=this.renderSession.projection;this.width=projection.x*2;this.height=-projection.y*2;this.buffer=buffer};PIXI.WebGLFilterManager.prototype.pushFilter=function(filterBlock){var gl=this.gl;var projection=this.renderSession.projection;var offset=this.renderSession.offset;filterBlock._filterArea=filterBlock.target.filterArea||filterBlock.target.getBounds();this.filterStack.push(filterBlock);var filter=filterBlock.filterPasses[0];this.offsetX+=filterBlock._filterArea.x;this.offsetY+=filterBlock._filterArea.y;var texture=this.texturePool.pop();if(!texture){texture=new PIXI.FilterTexture(this.gl,this.width,this.height)}else{texture.resize(this.width,this.height)}gl.bindTexture(gl.TEXTURE_2D,texture.texture);var filterArea=filterBlock._filterArea;var padding=filter.padding;filterArea.x-=padding;filterArea.y-=padding;filterArea.width+=padding*2;filterArea.height+=padding*2;if(filterArea.x<0)filterArea.x=0;if(filterArea.width>this.width)filterArea.width=this.width;if(filterArea.y<0)filterArea.y=0;if(filterArea.height>this.height)filterArea.height=this.height;gl.bindFramebuffer(gl.FRAMEBUFFER,texture.frameBuffer);gl.viewport(0,0,filterArea.width,filterArea.height);projection.x=filterArea.width/2;projection.y=-filterArea.height/2;offset.x=-filterArea.x;offset.y=-filterArea.y;gl.colorMask(true,true,true,true);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);filterBlock._glFilterTexture=texture};PIXI.WebGLFilterManager.prototype.popFilter=function(){var gl=this.gl;var filterBlock=this.filterStack.pop();var filterArea=filterBlock._filterArea;var texture=filterBlock._glFilterTexture;var projection=this.renderSession.projection;var offset=this.renderSession.offset;if(filterBlock.filterPasses.length>1){gl.viewport(0,0,filterArea.width,filterArea.height);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=0;this.vertexArray[1]=filterArea.height;this.vertexArray[2]=filterArea.width;this.vertexArray[3]=filterArea.height;this.vertexArray[4]=0;this.vertexArray[5]=0;this.vertexArray[6]=filterArea.width;this.vertexArray[7]=0;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);var inputTexture=texture;var outputTexture=this.texturePool.pop();if(!outputTexture)outputTexture=new PIXI.FilterTexture(this.gl,this.width,this.height);outputTexture.resize(this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.BLEND);for(var i=0;i<filterBlock.filterPasses.length-1;i++){var filterPass=filterBlock.filterPasses[i];gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,inputTexture.texture);this.applyFilterPass(filterPass,filterArea,filterArea.width,filterArea.height);var temp=inputTexture;inputTexture=outputTexture;outputTexture=temp}gl.enable(gl.BLEND);texture=inputTexture;this.texturePool.push(outputTexture)}var filter=filterBlock.filterPasses[filterBlock.filterPasses.length-1];this.offsetX-=filterArea.x;this.offsetY-=filterArea.y;var sizeX=this.width;var sizeY=this.height;var offsetX=0;var offsetY=0;var buffer=this.buffer;if(this.filterStack.length===0){gl.colorMask(true,true,true,true)}else{var currentFilter=this.filterStack[this.filterStack.length-1];filterArea=currentFilter._filterArea;sizeX=filterArea.width;sizeY=filterArea.height;offsetX=filterArea.x;offsetY=filterArea.y;buffer=currentFilter._glFilterTexture.frameBuffer}projection.x=sizeX/2;projection.y=-sizeY/2;offset.x=offsetX;offset.y=offsetY;filterArea=filterBlock._filterArea;var x=filterArea.x-offsetX;var y=filterArea.y-offsetY;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=x;this.vertexArray[1]=y+filterArea.height;this.vertexArray[2]=x+filterArea.width;this.vertexArray[3]=y+filterArea.height;this.vertexArray[4]=x;this.vertexArray[5]=y;this.vertexArray[6]=x+filterArea.width;this.vertexArray[7]=y;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);gl.viewport(0,0,sizeX*this.renderSession.resolution,sizeY*this.renderSession.resolution);gl.bindFramebuffer(gl.FRAMEBUFFER,buffer);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture.texture);this.applyFilterPass(filter,filterArea,sizeX,sizeY);this.texturePool.push(texture);filterBlock._glFilterTexture=null};PIXI.WebGLFilterManager.prototype.applyFilterPass=function(filter,filterArea,width,height){var gl=this.gl;var shader=filter.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=filter.fragmentSrc;shader.uniforms=filter.uniforms;shader.init();filter.shaders[gl.id]=shader}this.renderSession.shaderManager.setShader(shader);gl.uniform2f(shader.projectionVector,width/2,-height/2);gl.uniform2f(shader.offsetVector,0,0);if(filter.uniforms.dimensions){filter.uniforms.dimensions.value[0]=this.width;filter.uniforms.dimensions.value[1]=this.height;filter.uniforms.dimensions.value[2]=this.vertexArray[0];filter.uniforms.dimensions.value[3]=this.vertexArray[5]}shader.syncUniforms();gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.vertexAttribPointer(shader.colorAttribute,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0);this.renderSession.drawCount++};PIXI.WebGLFilterManager.prototype.initShaderBuffers=function(){var gl=this.gl;this.vertexBuffer=gl.createBuffer();this.uvBuffer=gl.createBuffer();this.colorBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.vertexArray=new PIXI.Float32Array([0,0,1,0,0,1,1,1]);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertexArray,gl.STATIC_DRAW);this.uvArray=new PIXI.Float32Array([0,0,1,0,0,1,1,1]);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvArray,gl.STATIC_DRAW);this.colorArray=new PIXI.Float32Array([1,16777215,1,16777215,1,16777215,1,16777215]);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colorArray,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,1,3,2]),gl.STATIC_DRAW)};PIXI.WebGLFilterManager.prototype.destroy=function(){var gl=this.gl;this.filterStack=null;this.offsetX=0;this.offsetY=0;for(var i=0;i<this.texturePool.length;i++){this.texturePool[i].destroy()}this.texturePool=null;gl.deleteBuffer(this.vertexBuffer);gl.deleteBuffer(this.uvBuffer);gl.deleteBuffer(this.colorBuffer);gl.deleteBuffer(this.indexBuffer)};PIXI.FilterTexture=function(gl,width,height,scaleMode){this.gl=gl;this.frameBuffer=gl.createFramebuffer();this.texture=gl.createTexture();scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);this.renderBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this.renderBuffer);this.resize(width,height)};PIXI.FilterTexture.prototype.constructor=PIXI.FilterTexture;PIXI.FilterTexture.prototype.clear=function(){var gl=this.gl;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT)};PIXI.FilterTexture.prototype.resize=function(width,height){if(this.width===width&&this.height===height)return;this.width=width;this.height=height;var gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height)};PIXI.FilterTexture.prototype.destroy=function(){var gl=this.gl;gl.deleteFramebuffer(this.frameBuffer);gl.deleteTexture(this.texture);this.frameBuffer=null;this.texture=null};PIXI.CanvasBuffer=function(width,height){this.width=width;this.height=height;this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=width;this.canvas.height=height};PIXI.CanvasBuffer.prototype.constructor=PIXI.CanvasBuffer;PIXI.CanvasBuffer.prototype.clear=function(){this.context.setTransform(1,0,0,1,0,0);this.context.clearRect(0,0,this.width,this.height)};PIXI.CanvasBuffer.prototype.resize=function(width,height){this.width=this.canvas.width=width;this.height=this.canvas.height=height};PIXI.CanvasMaskManager=function(){};PIXI.CanvasMaskManager.prototype.constructor=PIXI.CanvasMaskManager;PIXI.CanvasMaskManager.prototype.pushMask=function(maskData,renderSession){var context=renderSession.context;context.save();var cacheAlpha=maskData.alpha;var transform=maskData.worldTransform;var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);PIXI.CanvasGraphics.renderGraphicsMask(maskData,context);context.clip();maskData.worldAlpha=cacheAlpha};PIXI.CanvasMaskManager.prototype.popMask=function(renderSession){renderSession.context.restore()};PIXI.CanvasTinter=function(){};PIXI.CanvasTinter.getTintedTexture=function(sprite,color){var texture=sprite.texture;var canvas=PIXI.CanvasTinter.canvas||document.createElement("canvas");PIXI.CanvasTinter.tintMethod(texture,color,canvas);if(PIXI.CanvasTinter.convertTintToImage){var tintImage=new Image;tintImage.src=canvas.toDataURL()}else{PIXI.CanvasTinter.canvas=null}return canvas};PIXI.CanvasTinter.tintWithMultiply=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,crop.width,crop.height);context.globalCompositeOperation="multiply";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height)};PIXI.CanvasTinter.tintWithOverlay=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.globalCompositeOperation="copy";context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,crop.width,crop.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height)};PIXI.CanvasTinter.tintWithPerPixel=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.globalCompositeOperation="copy";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);var rgbValues=PIXI.hex2rgb(color);var r=rgbValues[0],g=rgbValues[1],b=rgbValues[2];var pixelData=context.getImageData(0,0,crop.width,crop.height);var pixels=pixelData.data;for(var i=0;i<pixels.length;i+=4){pixels[i+0]*=r;pixels[i+1]*=g;pixels[i+2]*=b;if(!PIXI.CanvasTinter.canHandleAlpha){var alpha=pixels[i+3];pixels[i+0]/=255/alpha;pixels[i+1]/=255/alpha;pixels[i+2]/=255/alpha}}context.putImageData(pixelData,0,0)};PIXI.CanvasTinter.roundColor=function(color){var step=PIXI.CanvasTinter.cacheStepsPerColorChannel;var rgbValues=PIXI.hex2rgb(color);rgbValues[0]=Math.min(255,rgbValues[0]/step*step);rgbValues[1]=Math.min(255,rgbValues[1]/step*step);rgbValues[2]=Math.min(255,rgbValues[2]/step*step);return PIXI.rgb2hex(rgbValues)};PIXI.CanvasTinter.checkInverseAlpha=function(){var canvas=new PIXI.CanvasBuffer(2,1);canvas.context.fillStyle="rgba(10, 20, 30, 0.5)";canvas.context.fillRect(0,0,1,1);var s1=canvas.context.getImageData(0,0,1,1);canvas.context.putImageData(s1,1,0);var s2=canvas.context.getImageData(1,0,1,1);return s2.data[0]===s1.data[0]&&s2.data[1]===s1.data[1]&&s2.data[2]===s1.data[2]&&s2.data[3]===s1.data[3]};PIXI.CanvasTinter.cacheStepsPerColorChannel=8;PIXI.CanvasTinter.convertTintToImage=false;PIXI.CanvasTinter.canHandleAlpha=PIXI.CanvasTinter.checkInverseAlpha();PIXI.CanvasTinter.canUseMultiply=PIXI.canUseNewCanvasBlendModes();PIXI.CanvasTinter.tintMethod=PIXI.CanvasTinter.canUseMultiply?PIXI.CanvasTinter.tintWithMultiply:PIXI.CanvasTinter.tintWithPerPixel;PIXI.CanvasRenderer=function(width,height,options){if(options){for(var i in PIXI.defaultRenderOptions){if(typeof options[i]==="undefined")options[i]=PIXI.defaultRenderOptions[i]}}else{options=PIXI.defaultRenderOptions}if(!PIXI.defaultRenderer){PIXI.defaultRenderer=this}this.type=PIXI.CANVAS_RENDERER;this.resolution=options.resolution;this.clearBeforeRender=options.clearBeforeRender;this.transparent=options.transparent;this.autoResize=options.autoResize||false;this.width=width||800;this.height=height||600;this.width*=this.resolution;this.height*=this.resolution;this.view=options.view||document.createElement("canvas");this.context=this.view.getContext("2d",{alpha:this.transparent});this.refresh=true;this.view.width=this.width*this.resolution;this.view.height=this.height*this.resolution;this.count=0;this.maskManager=new PIXI.CanvasMaskManager;this.renderSession={context:this.context,maskManager:this.maskManager,scaleMode:null,smoothProperty:null,roundPixels:false};this.mapBlendModes();this.resize(width,height);if("imageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="imageSmoothingEnabled";
else if("webkitImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="webkitImageSmoothingEnabled";else if("mozImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="mozImageSmoothingEnabled";else if("oImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="oImageSmoothingEnabled";else if("msImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="msImageSmoothingEnabled"};PIXI.CanvasRenderer.prototype.constructor=PIXI.CanvasRenderer;PIXI.CanvasRenderer.prototype.render=function(stage){stage.updateTransform();this.context.setTransform(1,0,0,1,0,0);this.context.globalAlpha=1;this.renderSession.currentBlendMode=PIXI.blendModes.NORMAL;this.context.globalCompositeOperation=PIXI.blendModesCanvas[PIXI.blendModes.NORMAL];if(navigator.isCocoonJS&&this.view.screencanvas){this.context.fillStyle="black";this.context.clear()}if(this.clearBeforeRender){if(this.transparent){this.context.clearRect(0,0,this.width,this.height)}else{this.context.fillStyle=stage.backgroundColorString;this.context.fillRect(0,0,this.width,this.height)}}this.renderDisplayObject(stage)};PIXI.CanvasRenderer.prototype.destroy=function(removeView){if(typeof removeView==="undefined"){removeView=true}if(removeView&&this.view.parent){this.view.parent.removeChild(this.view)}this.view=null;this.context=null;this.maskManager=null;this.renderSession=null};PIXI.CanvasRenderer.prototype.resize=function(width,height){this.width=width*this.resolution;this.height=height*this.resolution;this.view.width=this.width;this.view.height=this.height;if(this.autoResize){this.view.style.width=this.width/this.resolution+"px";this.view.style.height=this.height/this.resolution+"px"}};PIXI.CanvasRenderer.prototype.renderDisplayObject=function(displayObject,context){this.renderSession.context=context||this.context;this.renderSession.resolution=this.resolution;displayObject._renderCanvas(this.renderSession)};PIXI.CanvasRenderer.prototype.mapBlendModes=function(){if(!PIXI.blendModesCanvas){PIXI.blendModesCanvas=[];if(PIXI.canUseNewCanvasBlendModes()){PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="multiply";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="screen";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="overlay";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="darken";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="lighten";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="color-dodge";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="color-burn";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="hard-light";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="soft-light";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="difference";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="exclusion";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="hue";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="saturation";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="color";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="luminosity"}else{PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="source-over"}}};PIXI.CanvasGraphics=function(){};PIXI.CanvasGraphics.renderGraphics=function(graphics,context){var worldAlpha=graphics.worldAlpha;if(graphics.dirty){this.updateGraphicsTint(graphics);graphics.dirty=false}for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var shape=data.shape;var fillColor=data._fillTint;var lineColor=data._lineTint;context.lineWidth=data.lineWidth;if(data.type===PIXI.Graphics.POLY){context.beginPath();var points=shape.points;context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1])}if(shape.closed){context.lineTo(points[0],points[1])}if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath()}if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}else if(data.type===PIXI.Graphics.RECT){if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fillRect(shape.x,shape.y,shape.width,shape.height)}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.strokeRect(shape.x,shape.y,shape.width,shape.height)}}else if(data.type===PIXI.Graphics.CIRC){context.beginPath();context.arc(shape.x,shape.y,shape.radius,0,2*Math.PI);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}else if(data.type===PIXI.Graphics.ELIP){var w=shape.width*2;var h=shape.height*2;var x=shape.x-w/2;var y=shape.y-h/2;context.beginPath();var kappa=.5522848,ox=w/2*kappa,oy=h/2*kappa,xe=x+w,ye=y+h,xm=x+w/2,ym=y+h/2;context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}else if(data.type===PIXI.Graphics.RREC){var rx=shape.x;var ry=shape.y;var width=shape.width;var height=shape.height;var radius=shape.radius;var maxRadius=Math.min(width,height)/2|0;radius=radius>maxRadius?maxRadius:radius;context.beginPath();context.moveTo(rx,ry+radius);context.lineTo(rx,ry+height-radius);context.quadraticCurveTo(rx,ry+height,rx+radius,ry+height);context.lineTo(rx+width-radius,ry+height);context.quadraticCurveTo(rx+width,ry+height,rx+width,ry+height-radius);context.lineTo(rx+width,ry+radius);context.quadraticCurveTo(rx+width,ry,rx+width-radius,ry);context.lineTo(rx+radius,ry);context.quadraticCurveTo(rx,ry,rx,ry+radius);context.closePath();if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}}};PIXI.CanvasGraphics.renderGraphicsMask=function(graphics,context){var len=graphics.graphicsData.length;if(len===0){return}context.beginPath();for(var i=0;i<len;i++){var data=graphics.graphicsData[i];var shape=data.shape;if(data.type===PIXI.Graphics.POLY){var points=shape.points;context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1])}if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath()}}else if(data.type===PIXI.Graphics.RECT){context.rect(shape.x,shape.y,shape.width,shape.height);context.closePath()}else if(data.type===PIXI.Graphics.CIRC){context.arc(shape.x,shape.y,shape.radius,0,2*Math.PI);context.closePath()}else if(data.type===PIXI.Graphics.ELIP){var w=shape.width*2;var h=shape.height*2;var x=shape.x-w/2;var y=shape.y-h/2;var kappa=.5522848,ox=w/2*kappa,oy=h/2*kappa,xe=x+w,ye=y+h,xm=x+w/2,ym=y+h/2;context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath()}else if(data.type===PIXI.Graphics.RREC){var rx=shape.x;var ry=shape.y;var width=shape.width;var height=shape.height;var radius=shape.radius;var maxRadius=Math.min(width,height)/2|0;radius=radius>maxRadius?maxRadius:radius;context.moveTo(rx,ry+radius);context.lineTo(rx,ry+height-radius);context.quadraticCurveTo(rx,ry+height,rx+radius,ry+height);context.lineTo(rx+width-radius,ry+height);context.quadraticCurveTo(rx+width,ry+height,rx+width,ry+height-radius);context.lineTo(rx+width,ry+radius);context.quadraticCurveTo(rx+width,ry,rx+width-radius,ry);context.lineTo(rx+radius,ry);context.quadraticCurveTo(rx,ry,rx,ry+radius);context.closePath()}}};PIXI.CanvasGraphics.updateGraphicsTint=function(graphics){if(graphics.tint===16777215){return}var tintR=(graphics.tint>>16&255)/255;var tintG=(graphics.tint>>8&255)/255;var tintB=(graphics.tint&255)/255;for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var fillColor=data.fillColor|0;var lineColor=data.lineColor|0;data._fillTint=((fillColor>>16&255)/255*tintR*255<<16)+((fillColor>>8&255)/255*tintG*255<<8)+(fillColor&255)/255*tintB*255;data._lineTint=((lineColor>>16&255)/255*tintR*255<<16)+((lineColor>>8&255)/255*tintG*255<<8)+(lineColor&255)/255*tintB*255}};PIXI.Graphics=function(){PIXI.DisplayObjectContainer.call(this);this.renderable=true;this.fillAlpha=1;this.lineWidth=0;this.lineColor=0;this.graphicsData=[];this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL;this.currentPath=null;this._webGL=[];this.isMask=false;this.boundsPadding=0;this._localBounds=new PIXI.Rectangle(0,0,1,1);this.dirty=true;this.webGLDirty=false;this.cachedSpriteDirty=false};PIXI.Graphics.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Graphics.prototype.constructor=PIXI.Graphics;PIXI.Graphics.prototype.lineStyle=function(lineWidth,color,alpha){this.lineWidth=lineWidth||0;this.lineColor=color||0;this.lineAlpha=alpha===undefined?1:alpha;if(this.currentPath){if(this.currentPath.shape.points.length){this.drawShape(new PIXI.Polygon(this.currentPath.shape.points.slice(-2)))}else{this.currentPath.lineWidth=this.lineWidth;this.currentPath.lineColor=this.lineColor;this.currentPath.lineAlpha=this.lineAlpha}}return this};PIXI.Graphics.prototype.moveTo=function(x,y){this.drawShape(new PIXI.Polygon([x,y]));return this};PIXI.Graphics.prototype.lineTo=function(x,y){if(!this.currentPath){this.moveTo(0,0)}this.currentPath.shape.points.push(x,y);this.dirty=true;return this};PIXI.Graphics.prototype.quadraticCurveTo=function(cpX,cpY,toX,toY){if(this.currentPath){if(this.currentPath.shape.points.length===0){this.currentPath.shape.points=[0,0]}}else{this.moveTo(0,0)}var xa,ya,n=20,points=this.currentPath.shape.points;if(points.length===0){this.moveTo(0,0)}var fromX=points[points.length-2];var fromY=points[points.length-1];var j=0;for(var i=1;i<=n;++i){j=i/n;xa=fromX+(cpX-fromX)*j;ya=fromY+(cpY-fromY)*j;points.push(xa+(cpX+(toX-cpX)*j-xa)*j,ya+(cpY+(toY-cpY)*j-ya)*j)}this.dirty=true;return this};PIXI.Graphics.prototype.bezierCurveTo=function(cpX,cpY,cpX2,cpY2,toX,toY){if(this.currentPath){if(this.currentPath.shape.points.length===0){this.currentPath.shape.points=[0,0]}}else{this.moveTo(0,0)}var n=20,dt,dt2,dt3,t2,t3,points=this.currentPath.shape.points;var fromX=points[points.length-2];var fromY=points[points.length-1];var j=0;for(var i=1;i<=n;++i){j=i/n;dt=1-j;dt2=dt*dt;dt3=dt2*dt;t2=j*j;t3=t2*j;points.push(dt3*fromX+3*dt2*j*cpX+3*dt*t2*cpX2+t3*toX,dt3*fromY+3*dt2*j*cpY+3*dt*t2*cpY2+t3*toY)}this.dirty=true;return this};PIXI.Graphics.prototype.arcTo=function(x1,y1,x2,y2,radius){if(this.currentPath){if(this.currentPath.shape.points.length===0){this.currentPath.shape.points.push(x1,y1)}}else{this.moveTo(x1,y1)}var points=this.currentPath.shape.points,fromX=points[points.length-2],fromY=points[points.length-1],a1=fromY-y1,b1=fromX-x1,a2=y2-y1,b2=x2-x1,mm=Math.abs(a1*b2-b1*a2);if(mm<1e-8||radius===0){if(points[points.length-2]!==x1||points[points.length-1]!==y1){points.push(x1,y1)}}else{var dd=a1*a1+b1*b1,cc=a2*a2+b2*b2,tt=a1*a2+b1*b2,k1=radius*Math.sqrt(dd)/mm,k2=radius*Math.sqrt(cc)/mm,j1=k1*tt/dd,j2=k2*tt/cc,cx=k1*b2+k2*b1,cy=k1*a2+k2*a1,px=b1*(k2+j1),py=a1*(k2+j1),qx=b2*(k1+j2),qy=a2*(k1+j2),startAngle=Math.atan2(py-cy,px-cx),endAngle=Math.atan2(qy-cy,qx-cx);this.arc(cx+x1,cy+y1,radius,startAngle,endAngle,b1*a2>b2*a1)}this.dirty=true;return this};PIXI.Graphics.prototype.arc=function(cx,cy,radius,startAngle,endAngle,anticlockwise){if(startAngle===endAngle){return this}if(typeof anticlockwise==="undefined"){anticlockwise=false}if(!anticlockwise&&endAngle<=startAngle){endAngle+=Math.PI*2}else if(anticlockwise&&startAngle<=endAngle){startAngle+=Math.PI*2}var sweep=anticlockwise?(startAngle-endAngle)*-1:endAngle-startAngle;var segs=Math.ceil(Math.abs(sweep)/(Math.PI*2))*40;if(sweep===0){return this}var startX=cx+Math.cos(startAngle)*radius;var startY=cy+Math.sin(startAngle)*radius;if(anticlockwise&&this.filling){this.moveTo(cx,cy)}else{this.moveTo(startX,startY)}var points=this.currentPath.shape.points;var theta=sweep/(segs*2);var theta2=theta*2;var cTheta=Math.cos(theta);var sTheta=Math.sin(theta);var segMinus=segs-1;var remainder=segMinus%1/segMinus;for(var i=0;i<=segMinus;i++){var real=i+remainder*i;var angle=theta+startAngle+theta2*real;var c=Math.cos(angle);var s=-Math.sin(angle);points.push((cTheta*c+sTheta*s)*radius+cx,(cTheta*-s+sTheta*c)*radius+cy)}this.dirty=true;return this};PIXI.Graphics.prototype.beginFill=function(color,alpha){this.filling=true;this.fillColor=color||0;this.fillAlpha=alpha===undefined?1:alpha;if(this.currentPath){if(this.currentPath.shape.points.length<=2){this.currentPath.fill=this.filling;this.currentPath.fillColor=this.fillColor;this.currentPath.fillAlpha=this.fillAlpha}}return this};PIXI.Graphics.prototype.endFill=function(){this.filling=false;this.fillColor=null;this.fillAlpha=1;return this};PIXI.Graphics.prototype.drawRect=function(x,y,width,height){this.drawShape(new PIXI.Rectangle(x,y,width,height));return this};PIXI.Graphics.prototype.drawRoundedRect=function(x,y,width,height,radius){this.drawShape(new PIXI.RoundedRectangle(x,y,width,height,radius));return this};PIXI.Graphics.prototype.drawCircle=function(x,y,diameter){this.drawShape(new PIXI.Circle(x,y,diameter));return this};PIXI.Graphics.prototype.drawEllipse=function(x,y,width,height){this.drawShape(new PIXI.Ellipse(x,y,width,height));return this};PIXI.Graphics.prototype.drawPolygon=function(path){var points=path;if(!Array.isArray(points)){points=new Array(arguments.length);for(var i=0;i<points.length;++i){points[i]=arguments[i]}}this.drawShape(new Phaser.Polygon(points));return this};PIXI.Graphics.prototype.clear=function(){this.lineWidth=0;this.filling=false;this.dirty=true;this.clearDirty=true;this.graphicsData=[];return this};PIXI.Graphics.prototype.generateTexture=function(resolution,scaleMode){resolution=resolution||1;var bounds=this.getBounds();var canvasBuffer=new PIXI.CanvasBuffer(bounds.width*resolution,bounds.height*resolution);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas,scaleMode);texture.baseTexture.resolution=resolution;canvasBuffer.context.scale(resolution,resolution);canvasBuffer.context.translate(-bounds.x,-bounds.y);PIXI.CanvasGraphics.renderGraphics(this,canvasBuffer.context);return texture};PIXI.Graphics.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0||this.isMask===true)return;if(this._cacheAsBitmap){if(this.dirty||this.cachedSpriteDirty){this._generateCachedSprite();this.updateCachedSpriteTexture();this.cachedSpriteDirty=false;this.dirty=false}this._cachedSprite.worldAlpha=this.worldAlpha;PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession);return}else{renderSession.spriteBatch.stop();renderSession.blendModeManager.setBlendMode(this.blendMode);if(this._mask)renderSession.maskManager.pushMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.pushFilter(this._filterBlock);if(this.blendMode!==renderSession.spriteBatch.currentBlendMode){renderSession.spriteBatch.currentBlendMode=this.blendMode;var blendModeWebGL=PIXI.blendModesWebGL[renderSession.spriteBatch.currentBlendMode];renderSession.spriteBatch.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1])}if(this.webGLDirty){this.dirty=true;this.webGLDirty=false}PIXI.WebGLGraphics.renderGraphics(this,renderSession);if(this.children.length){renderSession.spriteBatch.start();for(var i=0;i<this.children.length;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop()}if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(this.mask,renderSession);renderSession.drawCount++;renderSession.spriteBatch.start()}};PIXI.Graphics.prototype._renderCanvas=function(renderSession){if(this.isMask===true){return}if(this._prevTint!==this.tint){this.dirty=true;this._prevTint=this.tint}if(this._cacheAsBitmap){if(this.dirty||this.cachedSpriteDirty){this._generateCachedSprite();this.updateCachedSpriteTexture();this.cachedSpriteDirty=false;this.dirty=false}this._cachedSprite.alpha=this.alpha;PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession);return}else{var context=renderSession.context;var transform=this.worldTransform;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);PIXI.CanvasGraphics.renderGraphics(this,context);for(var i=0;i<this.children.length;i++){this.children[i]._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession)}}};PIXI.Graphics.prototype.getBounds=function(matrix){if(!this._currentBounds){if(!this.renderable){return PIXI.EmptyRectangle}if(this.dirty){this.updateLocalBounds();this.webGLDirty=true;this.cachedSpriteDirty=true;this.dirty=false}var bounds=this._localBounds;var w0=bounds.x;var w1=bounds.width+bounds.x;var h0=bounds.y;var h1=bounds.height+bounds.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=x1;var maxY=y1;var minX=x1;var minY=y1;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;this._bounds.x=minX;this._bounds.width=maxX-minX;this._bounds.y=minY;this._bounds.height=maxY-minY;this._currentBounds=this._bounds}return this._currentBounds};PIXI.Graphics.prototype.containsPoint=function(point){this.worldTransform.applyInverse(point,tempPoint);var graphicsData=this.graphicsData;for(var i=0;i<graphicsData.length;i++){var data=graphicsData[i];if(!data.fill){continue}if(data.shape){if(data.shape.contains(tempPoint.x,tempPoint.y)){return true}}}return false};PIXI.Graphics.prototype.updateLocalBounds=function(){var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;if(this.graphicsData.length){var shape,points,x,y,w,h;for(var i=0;i<this.graphicsData.length;i++){var data=this.graphicsData[i];var type=data.type;var lineWidth=data.lineWidth;shape=data.shape;if(type===PIXI.Graphics.RECT||type===PIXI.Graphics.RREC){x=shape.x-lineWidth/2;y=shape.y-lineWidth/2;w=shape.width+lineWidth;h=shape.height+lineWidth;minX=x<minX?x:minX;maxX=x+w>maxX?x+w:maxX;minY=y<minY?y:minY;maxY=y+h>maxY?y+h:maxY}else if(type===PIXI.Graphics.CIRC){x=shape.x;y=shape.y;w=shape.radius+lineWidth/2;h=shape.radius+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY}else if(type===PIXI.Graphics.ELIP){x=shape.x;y=shape.y;w=shape.width+lineWidth/2;h=shape.height+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY}else{points=shape.points;for(var j=0;j<points.length;j++){if(points[j]instanceof Phaser.Point){x=points[j].x;y=points[j].y}else{x=points[j];y=points[j+1];if(j<points.length-1){j++}}minX=x-lineWidth<minX?x-lineWidth:minX;maxX=x+lineWidth>maxX?x+lineWidth:maxX;minY=y-lineWidth<minY?y-lineWidth:minY;maxY=y+lineWidth>maxY?y+lineWidth:maxY}}}}else{minX=0;maxX=0;minY=0;maxY=0}var padding=this.boundsPadding;this._localBounds.x=minX-padding;this._localBounds.width=maxX-minX+padding*2;this._localBounds.y=minY-padding;this._localBounds.height=maxY-minY+padding*2};PIXI.Graphics.prototype._generateCachedSprite=function(){var bounds=this.getLocalBounds();if(!this._cachedSprite){var canvasBuffer=new PIXI.CanvasBuffer(bounds.width,bounds.height);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this._cachedSprite=new PIXI.Sprite(texture);this._cachedSprite.buffer=canvasBuffer;this._cachedSprite.worldTransform=this.worldTransform}else{this._cachedSprite.buffer.resize(bounds.width,bounds.height)}this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._cachedSprite.buffer.context.translate(-bounds.x,-bounds.y);this.worldAlpha=1;PIXI.CanvasGraphics.renderGraphics(this,this._cachedSprite.buffer.context);this._cachedSprite.alpha=this.alpha};PIXI.Graphics.prototype.updateCachedSpriteTexture=function(){var cachedSprite=this._cachedSprite;var texture=cachedSprite.texture;var canvas=cachedSprite.buffer.canvas;texture.baseTexture.width=canvas.width;texture.baseTexture.height=canvas.height;texture.crop.width=texture.frame.width=canvas.width;texture.crop.height=texture.frame.height=canvas.height;cachedSprite._width=canvas.width;cachedSprite._height=canvas.height;texture.baseTexture.dirty()};PIXI.Graphics.prototype.destroyCachedSprite=function(){this._cachedSprite.texture.destroy(true);this._cachedSprite=null};PIXI.Graphics.prototype.drawShape=function(shape){if(this.currentPath){if(this.currentPath.shape.points.length<=2){this.graphicsData.pop()}}this.currentPath=null;if(shape instanceof PIXI.Polygon){shape.flatten()}var data=new PIXI.GraphicsData(this.lineWidth,this.lineColor,this.lineAlpha,this.fillColor,this.fillAlpha,this.filling,shape);this.graphicsData.push(data);if(data.type===PIXI.Graphics.POLY){data.shape.closed=this.filling;this.currentPath=data}this.dirty=true;return data};Object.defineProperty(PIXI.Graphics.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap},set:function(value){this._cacheAsBitmap=value;if(this._cacheAsBitmap){this._generateCachedSprite()}else{this.destroyCachedSprite();this.dirty=true}}});PIXI.GraphicsData=function(lineWidth,lineColor,lineAlpha,fillColor,fillAlpha,fill,shape){this.lineWidth=lineWidth;this.lineColor=lineColor;this.lineAlpha=lineAlpha;this._lineTint=lineColor;this.fillColor=fillColor;this.fillAlpha=fillAlpha;this._fillTint=fillColor;this.fill=fill;this.shape=shape;this.type=shape.type};PIXI.GraphicsData.prototype.constructor=PIXI.GraphicsData;PIXI.GraphicsData.prototype.clone=function(){return new GraphicsData(this.lineWidth,this.lineColor,this.lineAlpha,this.fillColor,this.fillAlpha,this.fill,this.shape)};PIXI.Strip=function(texture){PIXI.DisplayObjectContainer.call(this);this.texture=texture;this.uvs=new PIXI.Float32Array([0,1,1,1,1,0,0,1]);this.vertices=new PIXI.Float32Array([0,0,100,0,100,100,0,100]);this.colors=new PIXI.Float32Array([1,1,1,1]);this.indices=new PIXI.Uint16Array([0,1,2,3]);this.dirty=true;this.blendMode=PIXI.blendModes.NORMAL;this.canvasPadding=0;this.drawMode=PIXI.Strip.DrawModes.TRIANGLE_STRIP};PIXI.Strip.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Strip.prototype.constructor=PIXI.Strip;PIXI.Strip.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;renderSession.spriteBatch.stop();if(!this._vertexBuffer)this._initWebGL(renderSession);renderSession.shaderManager.setShader(renderSession.shaderManager.stripShader);this._renderStrip(renderSession);renderSession.spriteBatch.start()};PIXI.Strip.prototype._initWebGL=function(renderSession){var gl=renderSession.gl;this._vertexBuffer=gl.createBuffer();this._indexBuffer=gl.createBuffer();this._uvBuffer=gl.createBuffer();this._colorBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvs,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this._colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colors,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW)};PIXI.Strip.prototype._renderStrip=function(renderSession){var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.stripShader;var drawMode=this.drawMode===PIXI.Strip.DrawModes.TRIANGLE_STRIP?gl.TRIANGLE_STRIP:gl.TRIANGLES;renderSession.blendModeManager.setBlendMode(this.blendMode);gl.uniformMatrix3fv(shader.translationMatrix,false,this.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform1f(shader.alpha,this.worldAlpha);if(!this.dirty){gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);if(this.texture.baseTexture._dirty[gl.id]){renderSession.renderer.updateTexture(this.texture.baseTexture)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture.baseTexture._glTextures[gl.id])}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer)}else{this.dirty=false;gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvs,gl.STATIC_DRAW);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);if(this.texture.baseTexture._dirty[gl.id]){renderSession.renderer.updateTexture(this.texture.baseTexture)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture.baseTexture._glTextures[gl.id])}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW)}gl.drawElements(drawMode,this.indices.length,gl.UNSIGNED_SHORT,0)};PIXI.Strip.prototype._renderCanvas=function(renderSession){var context=renderSession.context;var transform=this.worldTransform;if(renderSession.roundPixels){context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx|0,transform.ty|0)}else{context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx,transform.ty)}if(this.drawMode===PIXI.Strip.DrawModes.TRIANGLE_STRIP){this._renderCanvasTriangleStrip(context)}else{this._renderCanvasTriangles(context)}};PIXI.Strip.prototype._renderCanvasTriangleStrip=function(context){var vertices=this.vertices;var uvs=this.uvs;var length=vertices.length/2;this.count++;for(var i=0;i<length-2;i++){var index=i*2;this._renderCanvasDrawTriangle(context,vertices,uvs,index,index+2,index+4)}};PIXI.Strip.prototype._renderCanvasTriangles=function(context){var vertices=this.vertices;var uvs=this.uvs;var indices=this.indices;var length=indices.length;this.count++;for(var i=0;i<length;i+=3){var index0=indices[i]*2,index1=indices[i+1]*2,index2=indices[i+2]*2;this._renderCanvasDrawTriangle(context,vertices,uvs,index0,index1,index2)}};PIXI.Strip.prototype._renderCanvasDrawTriangle=function(context,vertices,uvs,index0,index1,index2){var textureSource=this.texture.baseTexture.source;var textureWidth=this.texture.width;var textureHeight=this.texture.height;var x0=vertices[index0],x1=vertices[index1],x2=vertices[index2];var y0=vertices[index0+1],y1=vertices[index1+1],y2=vertices[index2+1];var u0=uvs[index0]*textureWidth,u1=uvs[index1]*textureWidth,u2=uvs[index2]*textureWidth;var v0=uvs[index0+1]*textureHeight,v1=uvs[index1+1]*textureHeight,v2=uvs[index2+1]*textureHeight;if(this.canvasPadding>0){var paddingX=this.canvasPadding/this.worldTransform.a;var paddingY=this.canvasPadding/this.worldTransform.d;var centerX=(x0+x1+x2)/3;var centerY=(y0+y1+y2)/3;var normX=x0-centerX;var normY=y0-centerY;var dist=Math.sqrt(normX*normX+normY*normY);x0=centerX+normX/dist*(dist+paddingX);y0=centerY+normY/dist*(dist+paddingY);normX=x1-centerX;normY=y1-centerY;dist=Math.sqrt(normX*normX+normY*normY);x1=centerX+normX/dist*(dist+paddingX);y1=centerY+normY/dist*(dist+paddingY);normX=x2-centerX;normY=y2-centerY;dist=Math.sqrt(normX*normX+normY*normY);x2=centerX+normX/dist*(dist+paddingX);y2=centerY+normY/dist*(dist+paddingY)}context.save();context.beginPath();context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2);context.closePath();context.clip();var delta=u0*v1+v0*u2+u1*v2-v1*u2-v0*u1-u0*v2;var deltaA=x0*v1+v0*x2+x1*v2-v1*x2-v0*x1-x0*v2;var deltaB=u0*x1+x0*u2+u1*x2-x1*u2-x0*u1-u0*x2;var deltaC=u0*v1*x2+v0*x1*u2+x0*u1*v2-x0*v1*u2-v0*u1*x2-u0*x1*v2;var deltaD=y0*v1+v0*y2+y1*v2-v1*y2-v0*y1-y0*v2;var deltaE=u0*y1+y0*u2+u1*y2-y1*u2-y0*u1-u0*y2;var deltaF=u0*v1*y2+v0*y1*u2+y0*u1*v2-y0*v1*u2-v0*u1*y2-u0*y1*v2;context.transform(deltaA/delta,deltaD/delta,deltaB/delta,deltaE/delta,deltaC/delta,deltaF/delta);context.drawImage(textureSource,0,0);context.restore()};PIXI.Strip.prototype.renderStripFlat=function(strip){var context=this.context;var vertices=strip.vertices;var length=vertices.length/2;this.count++;context.beginPath();for(var i=1;i<length-2;i++){var index=i*2;var x0=vertices[index],x1=vertices[index+2],x2=vertices[index+4];var y0=vertices[index+1],y1=vertices[index+3],y2=vertices[index+5];context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2)}context.fillStyle="#FF0000";context.fill();context.closePath()};PIXI.Strip.prototype.onTextureUpdate=function(){this.updateFrame=true};PIXI.Strip.prototype.getBounds=function(matrix){var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;var vertices=this.vertices;for(var i=0,n=vertices.length;i<n;i+=2){var rawX=vertices[i],rawY=vertices[i+1];var x=a*rawX+c*rawY+tx;var y=d*rawY+b*rawX+ty;minX=x<minX?x:minX;minY=y<minY?y:minY;maxX=x>maxX?x:maxX;maxY=y>maxY?y:maxY}if(minX===-Infinity||maxY===Infinity){return PIXI.EmptyRectangle
}var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.Strip.DrawModes={TRIANGLE_STRIP:0,TRIANGLES:1};PIXI.Rope=function(texture,points){PIXI.Strip.call(this,texture);this.points=points;this.vertices=new PIXI.Float32Array(points.length*4);this.uvs=new PIXI.Float32Array(points.length*4);this.colors=new PIXI.Float32Array(points.length*2);this.indices=new PIXI.Uint16Array(points.length*2);this.refresh()};PIXI.Rope.prototype=Object.create(PIXI.Strip.prototype);PIXI.Rope.prototype.constructor=PIXI.Rope;PIXI.Rope.prototype.refresh=function(){var points=this.points;if(points.length<1)return;var uvs=this.uvs;var lastPoint=points[0];var indices=this.indices;var colors=this.colors;this.count-=.2;uvs[0]=0;uvs[1]=0;uvs[2]=0;uvs[3]=1;colors[0]=1;colors[1]=1;indices[0]=0;indices[1]=1;var total=points.length,point,index,amount;for(var i=1;i<total;i++){point=points[i];index=i*4;amount=i/(total-1);if(i%2){uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1}else{uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1}index=i*2;colors[index]=1;colors[index+1]=1;index=i*2;indices[index]=index;indices[index+1]=index+1;lastPoint=point}};PIXI.Rope.prototype.updateTransform=function(){var points=this.points;if(points.length<1)return;var lastPoint=points[0];var nextPoint;var perp={x:0,y:0};this.count-=.2;var vertices=this.vertices;var total=points.length,point,index,ratio,perpLength,num;for(var i=0;i<total;i++){point=points[i];index=i*4;if(i<points.length-1){nextPoint=points[i+1]}else{nextPoint=point}perp.y=-(nextPoint.x-lastPoint.x);perp.x=nextPoint.y-lastPoint.y;ratio=(1-i/(total-1))*10;if(ratio>1)ratio=1;perpLength=Math.sqrt(perp.x*perp.x+perp.y*perp.y);num=this.texture.height/2;perp.x/=perpLength;perp.y/=perpLength;perp.x*=num;perp.y*=num;vertices[index]=point.x+perp.x;vertices[index+1]=point.y+perp.y;vertices[index+2]=point.x-perp.x;vertices[index+3]=point.y-perp.y;lastPoint=point}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.Rope.prototype.setTexture=function(texture){this.texture=texture};PIXI.TilingSprite=function(texture,width,height){PIXI.Sprite.call(this,texture);this._width=width||100;this._height=height||100;this.tileScale=new PIXI.Point(1,1);this.tileScaleOffset=new PIXI.Point(1,1);this.tilePosition=new PIXI.Point(0,0);this.renderable=true;this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL};PIXI.TilingSprite.prototype=Object.create(PIXI.Sprite.prototype);PIXI.TilingSprite.prototype.constructor=PIXI.TilingSprite;Object.defineProperty(PIXI.TilingSprite.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value}});Object.defineProperty(PIXI.TilingSprite.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value}});PIXI.TilingSprite.prototype.setTexture=function(texture){if(this.texture===texture)return;this.texture=texture;this.refreshTexture=true;this.cachedTint=16777215};PIXI.TilingSprite.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0)return;var i,j;if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start()}if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(!this.tilingTexture||this.refreshTexture){this.generateTilingTexture(true);if(this.tilingTexture&&this.tilingTexture.needsUpdate){renderSession.renderer.updateTexture(this.tilingTexture.baseTexture);this.tilingTexture.needsUpdate=false}}else{renderSession.spriteBatch.renderTilingSprite(this)}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop();if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);renderSession.spriteBatch.start()};PIXI.TilingSprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;var context=renderSession.context;if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}context.globalAlpha=this.worldAlpha;var transform=this.worldTransform;var i,j;var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);if(!this.__tilePattern||this.refreshTexture){this.generateTilingTexture(false);if(this.tilingTexture){this.__tilePattern=context.createPattern(this.tilingTexture.baseTexture.source,"repeat")}else{return}}if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}var tilePosition=this.tilePosition;var tileScale=this.tileScale;tilePosition.x%=this.tilingTexture.baseTexture.width;tilePosition.y%=this.tilingTexture.baseTexture.height;context.scale(tileScale.x,tileScale.y);context.translate(tilePosition.x+this.anchor.x*-this._width,tilePosition.y+this.anchor.y*-this._height);context.fillStyle=this.__tilePattern;context.fillRect(-tilePosition.x,-tilePosition.y,this._width/tileScale.x,this._height/tileScale.y);context.scale(1/tileScale.x,1/tileScale.y);context.translate(-tilePosition.x+this.anchor.x*this._width,-tilePosition.y+this.anchor.y*this._height);if(this._mask){renderSession.maskManager.popMask(renderSession)}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession)}};PIXI.TilingSprite.prototype.getBounds=function(){var width=this._width;var height=this._height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.TilingSprite.prototype.onTextureUpdate=function(){};PIXI.TilingSprite.prototype.generateTilingTexture=function(forcePowerOfTwo){if(!this.texture.baseTexture.hasLoaded)return;var texture=this.originalTexture||this.texture;var frame=texture.frame;var targetWidth,targetHeight;var isFrame=frame.width!==texture.baseTexture.width||frame.height!==texture.baseTexture.height;var newTextureRequired=false;if(!forcePowerOfTwo){if(isFrame){if(texture.crop){targetWidth=texture.crop.width;targetHeight=texture.crop.height}else{targetWidth=frame.width;targetHeight=frame.height}newTextureRequired=true}}else{if(texture.crop){targetWidth=PIXI.getNextPowerOfTwo(texture.crop.width);targetHeight=PIXI.getNextPowerOfTwo(texture.crop.height)}else{targetWidth=PIXI.getNextPowerOfTwo(frame.width);targetHeight=PIXI.getNextPowerOfTwo(frame.height)}newTextureRequired=true}if(newTextureRequired){var canvasBuffer;if(this.tilingTexture&&this.tilingTexture.isTiling){canvasBuffer=this.tilingTexture.canvasBuffer;canvasBuffer.resize(targetWidth,targetHeight);this.tilingTexture.baseTexture.width=targetWidth;this.tilingTexture.baseTexture.height=targetHeight;this.tilingTexture.needsUpdate=true}else{canvasBuffer=new PIXI.CanvasBuffer(targetWidth,targetHeight);this.tilingTexture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this.tilingTexture.canvasBuffer=canvasBuffer;this.tilingTexture.isTiling=true}canvasBuffer.context.drawImage(texture.baseTexture.source,texture.crop.x,texture.crop.y,texture.crop.width,texture.crop.height,0,0,targetWidth,targetHeight);this.tileScaleOffset.x=frame.width/targetWidth;this.tileScaleOffset.y=frame.height/targetHeight}else{if(this.tilingTexture&&this.tilingTexture.isTiling){this.tilingTexture.destroy(true)}this.tileScaleOffset.x=1;this.tileScaleOffset.y=1;this.tilingTexture=texture}this.refreshTexture=false;this.originalTexture=this.texture;this.texture=this.tilingTexture;this.tilingTexture.baseTexture._powerOf2=true};PIXI.TilingSprite.prototype.destroy=function(){PIXI.Sprite.prototype.destroy.call(this);this.tileScale=null;this.tileScaleOffset=null;this.tilePosition=null;if(this.tilingTexture){this.tilingTexture.destroy(true);this.tilingTexture=null}};PIXI.BaseTextureCache={};PIXI.BaseTextureCacheIdGenerator=0;PIXI.BaseTexture=function(source,scaleMode){this.resolution=1;this.width=100;this.height=100;this.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.hasLoaded=false;this.source=source;this._UID=PIXI._UID++;this.premultipliedAlpha=true;this._glTextures=[];this.mipmap=false;this._dirty=[true,true,true,true];if(!source)return;if((this.source.complete||this.source.getContext)&&this.source.width&&this.source.height){this.hasLoaded=true;this.width=this.source.naturalWidth||this.source.width;this.height=this.source.naturalHeight||this.source.height;this.dirty()}else{}this.imageUrl=null;this._powerOf2=false};PIXI.BaseTexture.prototype.constructor=PIXI.BaseTexture;PIXI.BaseTexture.prototype.destroy=function(){if(this.imageUrl){delete PIXI.BaseTextureCache[this.imageUrl];delete PIXI.TextureCache[this.imageUrl];this.imageUrl=null;if(!navigator.isCocoonJS)this.source.src=""}else if(this.source&&this.source._pixiId){delete PIXI.BaseTextureCache[this.source._pixiId]}this.source=null;this.unloadFromGPU()};PIXI.BaseTexture.prototype.updateSourceImage=function(newSrc){this.hasLoaded=false;this.source.src=null;this.source.src=newSrc};PIXI.BaseTexture.prototype.dirty=function(){for(var i=0;i<this._glTextures.length;i++){this._dirty[i]=true}};PIXI.BaseTexture.prototype.unloadFromGPU=function(){this.dirty();for(var i=this._glTextures.length-1;i>=0;i--){var glTexture=this._glTextures[i];var gl=PIXI.glContexts[i];if(gl&&glTexture){gl.deleteTexture(glTexture)}}this._glTextures.length=0;this.dirty()};PIXI.BaseTexture.fromImage=function(imageUrl,crossorigin,scaleMode){var baseTexture=PIXI.BaseTextureCache[imageUrl];if(crossorigin===undefined&&imageUrl.indexOf("data:")===-1)crossorigin=true;if(!baseTexture){var image=new Image;if(crossorigin){image.crossOrigin=""}image.src=imageUrl;baseTexture=new PIXI.BaseTexture(image,scaleMode);baseTexture.imageUrl=imageUrl;PIXI.BaseTextureCache[imageUrl]=baseTexture;if(imageUrl.indexOf(PIXI.RETINA_PREFIX+".")!==-1){baseTexture.resolution=2}}return baseTexture};PIXI.BaseTexture.fromCanvas=function(canvas,scaleMode){if(!canvas._pixiId){canvas._pixiId="canvas_"+PIXI.TextureCacheIdGenerator++}var baseTexture=PIXI.BaseTextureCache[canvas._pixiId];if(!baseTexture){baseTexture=new PIXI.BaseTexture(canvas,scaleMode);PIXI.BaseTextureCache[canvas._pixiId]=baseTexture}return baseTexture};PIXI.TextureCache={};PIXI.FrameCache={};PIXI.TextureSilentFail=false;PIXI.TextureCacheIdGenerator=0;PIXI.Texture=function(baseTexture,frame,crop,trim){this.noFrame=false;if(!frame){this.noFrame=true;frame=new PIXI.Rectangle(0,0,1,1)}if(baseTexture instanceof PIXI.Texture){baseTexture=baseTexture.baseTexture}this.baseTexture=baseTexture;this.frame=frame;this.trim=trim;this.valid=false;this.requiresUpdate=false;this._uvs=null;this.width=0;this.height=0;this.crop=crop||new PIXI.Rectangle(0,0,1,1);if(baseTexture.hasLoaded){if(this.noFrame)frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(frame)}};PIXI.Texture.prototype.constructor=PIXI.Texture;PIXI.Texture.prototype.onBaseTextureLoaded=function(){var baseTexture=this.baseTexture;if(this.noFrame)this.frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(this.frame)};PIXI.Texture.prototype.destroy=function(destroyBase){if(destroyBase)this.baseTexture.destroy();this.valid=false};PIXI.Texture.prototype.setFrame=function(frame){this.noFrame=false;this.frame=frame;this.width=frame.width;this.height=frame.height;this.crop.x=frame.x;this.crop.y=frame.y;this.crop.width=frame.width;this.crop.height=frame.height;if(!this.trim&&(frame.x+frame.width>this.baseTexture.width||frame.y+frame.height>this.baseTexture.height)){if(!PIXI.TextureSilentFail){throw new Error("Texture Error: frame does not fit inside the base Texture dimensions "+this)}this.valid=false;return}this.valid=frame&&frame.width&&frame.height&&this.baseTexture.source&&this.baseTexture.hasLoaded;if(this.trim){this.width=this.trim.width;this.height=this.trim.height;this.frame.width=this.trim.width;this.frame.height=this.trim.height}if(this.valid)this._updateUvs()};PIXI.Texture.prototype._updateUvs=function(){if(!this._uvs)this._uvs=new PIXI.TextureUvs;var frame=this.crop;var tw=this.baseTexture.width;var th=this.baseTexture.height;this._uvs.x0=frame.x/tw;this._uvs.y0=frame.y/th;this._uvs.x1=(frame.x+frame.width)/tw;this._uvs.y1=frame.y/th;this._uvs.x2=(frame.x+frame.width)/tw;this._uvs.y2=(frame.y+frame.height)/th;this._uvs.x3=frame.x/tw;this._uvs.y3=(frame.y+frame.height)/th};PIXI.Texture.fromImage=function(imageUrl,crossorigin,scaleMode){var texture=PIXI.TextureCache[imageUrl];if(!texture){texture=new PIXI.Texture(PIXI.BaseTexture.fromImage(imageUrl,crossorigin,scaleMode));PIXI.TextureCache[imageUrl]=texture}return texture};PIXI.Texture.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache ');return texture};PIXI.Texture.fromCanvas=function(canvas,scaleMode){var baseTexture=PIXI.BaseTexture.fromCanvas(canvas,scaleMode);return new PIXI.Texture(baseTexture)};PIXI.Texture.addTextureToCache=function(texture,id){PIXI.TextureCache[id]=texture};PIXI.Texture.removeTextureFromCache=function(id){var texture=PIXI.TextureCache[id];delete PIXI.TextureCache[id];delete PIXI.BaseTextureCache[id];return texture};PIXI.TextureUvs=function(){this.x0=0;this.y0=0;this.x1=0;this.y1=0;this.x2=0;this.y2=0;this.x3=0;this.y3=0};PIXI.RenderTexture=function(width,height,renderer,scaleMode,resolution){this.width=width||100;this.height=height||100;this.resolution=resolution||1;this.frame=new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution);this.crop=new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution);this.baseTexture=new PIXI.BaseTexture;this.baseTexture.width=this.width*this.resolution;this.baseTexture.height=this.height*this.resolution;this.baseTexture._glTextures=[];this.baseTexture.resolution=this.resolution;this.baseTexture.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.baseTexture.hasLoaded=true;PIXI.Texture.call(this,this.baseTexture,new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution));this.renderer=renderer||PIXI.defaultRenderer;if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;this.baseTexture._dirty[gl.id]=false;this.textureBuffer=new PIXI.FilterTexture(gl,this.width,this.height,this.baseTexture.scaleMode);this.baseTexture._glTextures[gl.id]=this.textureBuffer.texture;this.render=this.renderWebGL;this.projection=new PIXI.Point(this.width*.5,-this.height*.5)}else{this.render=this.renderCanvas;this.textureBuffer=new PIXI.CanvasBuffer(this.width*this.resolution,this.height*this.resolution);this.baseTexture.source=this.textureBuffer.canvas}this.valid=true;this._updateUvs()};PIXI.RenderTexture.prototype=Object.create(PIXI.Texture.prototype);PIXI.RenderTexture.prototype.constructor=PIXI.RenderTexture;PIXI.RenderTexture.prototype.resize=function(width,height,updateBase){if(width===this.width&&height===this.height)return;this.valid=width>0&&height>0;this.width=width;this.height=height;this.frame.width=this.crop.width=width*this.resolution;this.frame.height=this.crop.height=height*this.resolution;if(updateBase){this.baseTexture.width=this.width*this.resolution;this.baseTexture.height=this.height*this.resolution}if(this.renderer.type===PIXI.WEBGL_RENDERER){this.projection.x=this.width/2;this.projection.y=-this.height/2}if(!this.valid)return;this.textureBuffer.resize(this.width,this.height)};PIXI.RenderTexture.prototype.clear=function(){if(!this.valid)return;if(this.renderer.type===PIXI.WEBGL_RENDERER){this.renderer.gl.bindFramebuffer(this.renderer.gl.FRAMEBUFFER,this.textureBuffer.frameBuffer)}this.textureBuffer.clear()};PIXI.RenderTexture.prototype.renderWebGL=function(displayObject,matrix,clear){if(!this.valid)return;var wt=displayObject.worldTransform;wt.identity();wt.translate(0,this.projection.y*2);if(matrix)wt.append(matrix);wt.scale(1,-1);displayObject.worldAlpha=1;var children=displayObject.children;for(var i=0,j=children.length;i<j;i++){children[i].updateTransform()}var gl=this.renderer.gl;gl.viewport(0,0,this.width*this.resolution,this.height*this.resolution);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);if(clear)this.textureBuffer.clear();this.renderer.spriteBatch.dirty=true;this.renderer.renderDisplayObject(displayObject,this.projection,this.textureBuffer.frameBuffer);this.renderer.spriteBatch.dirty=true};PIXI.RenderTexture.prototype.renderCanvas=function(displayObject,matrix,clear){if(!this.valid)return;var wt=displayObject.worldTransform;wt.identity();if(matrix)wt.append(matrix);displayObject.worldAlpha=1;var children=displayObject.children;for(var i=0,j=children.length;i<j;i++){children[i].updateTransform()}if(clear)this.textureBuffer.clear();var context=this.textureBuffer.context;var realResolution=this.renderer.resolution;this.renderer.resolution=this.resolution;this.renderer.renderDisplayObject(displayObject,context);this.renderer.resolution=realResolution};PIXI.RenderTexture.prototype.getImage=function(){var image=new Image;image.src=this.getBase64();return image};PIXI.RenderTexture.prototype.getBase64=function(){return this.getCanvas().toDataURL()};PIXI.RenderTexture.prototype.getCanvas=function(){if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;var width=this.textureBuffer.width;var height=this.textureBuffer.height;var webGLPixels=new Uint8Array(4*width*height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);gl.readPixels(0,0,width,height,gl.RGBA,gl.UNSIGNED_BYTE,webGLPixels);gl.bindFramebuffer(gl.FRAMEBUFFER,null);var tempCanvas=new PIXI.CanvasBuffer(width,height);var canvasData=tempCanvas.context.getImageData(0,0,width,height);canvasData.data.set(webGLPixels);tempCanvas.context.putImageData(canvasData,0,0);return tempCanvas.canvas}else{return this.textureBuffer.canvas}};PIXI.AbstractFilter=function(fragmentSrc,uniforms){this.passes=[this];this.shaders=[];this.dirty=true;this.padding=0;this.uniforms=uniforms||{};this.fragmentSrc=fragmentSrc||[]};PIXI.AbstractFilter.prototype.constructor=PIXI.AbstractFilter;PIXI.AbstractFilter.prototype.syncUniforms=function(){for(var i=0,j=this.shaders.length;i<j;i++){this.shaders[i].dirty=true}};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=PIXI}exports.PIXI=PIXI}else if(typeof define!=="undefined"&&define.amd){define("PIXI",function(){return root.PIXI=PIXI}())}else{root.PIXI=PIXI}}).call(this);(function(){var root=this;var Phaser=Phaser||{VERSION:"2.3.0",GAMES:[],AUTO:0,CANVAS:1,WEBGL:2,HEADLESS:3,NONE:0,LEFT:1,RIGHT:2,UP:3,DOWN:4,SPRITE:0,BUTTON:1,IMAGE:2,GRAPHICS:3,TEXT:4,TILESPRITE:5,BITMAPTEXT:6,GROUP:7,RENDERTEXTURE:8,TILEMAP:9,TILEMAPLAYER:10,EMITTER:11,POLYGON:12,BITMAPDATA:13,CANVAS_FILTER:14,WEBGL_FILTER:15,ELLIPSE:16,SPRITEBATCH:17,RETROFONT:18,POINTER:19,ROPE:20,CIRCLE:21,RECTANGLE:22,LINE:23,MATRIX:24,POINT:25,ROUNDEDRECTANGLE:26,blendModes:{NORMAL:0,ADD:1,MULTIPLY:2,SCREEN:3,OVERLAY:4,DARKEN:5,LIGHTEN:6,COLOR_DODGE:7,COLOR_BURN:8,HARD_LIGHT:9,SOFT_LIGHT:10,DIFFERENCE:11,EXCLUSION:12,HUE:13,SATURATION:14,COLOR:15,LUMINOSITY:16},scaleModes:{DEFAULT:0,LINEAR:0,NEAREST:1}};if(!Math.trunc){Math.trunc=function trunc(x){return x<0?Math.ceil(x):Math.floor(x)}}if(!Function.prototype.bind){Function.prototype.bind=function(){var slice=Array.prototype.slice;return function(thisArg){var target=this,boundArgs=slice.call(arguments,1);if(typeof target!=="function"){throw new TypeError}function bound(){var args=boundArgs.concat(slice.call(arguments));target.apply(this instanceof bound?this:thisArg,args)}bound.prototype=function F(proto){if(proto){F.prototype=proto}if(!(this instanceof F)){return new F}}(target.prototype);return bound}}()}if(!Array.isArray){Array.isArray=function(arg){return Object.prototype.toString.call(arg)=="[object Array]"}}if(!Array.prototype.forEach){Array.prototype.forEach=function(fun){"use strict";if(this===void 0||this===null){throw new TypeError}var t=Object(this);var len=t.length>>>0;if(typeof fun!=="function"){throw new TypeError}var thisArg=arguments.length>=2?arguments[1]:void 0;for(var i=0;i<len;i++){if(i in t){fun.call(thisArg,t[i],i,t)}}}}if(typeof window.Uint32Array!=="function"&&typeof window.Uint32Array!=="object"){var CheapArray=function(type){var proto=new Array;window[type]=function(arg){if(typeof arg==="number"){Array.call(this,arg);this.length=arg;for(var i=0;i<this.length;i++){this[i]=0}}else{Array.call(this,arg.length);this.length=arg.length;for(var i=0;i<this.length;i++){this[i]=arg[i]}}};window[type].prototype=proto;window[type].constructor=window[type]};CheapArray("Uint32Array");CheapArray("Int16Array")}if(!window.console){window.console={};window.console.log=window.console.assert=function(){};window.console.warn=window.console.assert=function(){}}Phaser.Utils={getProperty:function(obj,prop){var parts=prop.split("."),last=parts.pop(),l=parts.length,i=1,current=parts[0];while(i<l&&(obj=obj[current])){current=parts[i];i++}if(obj){return obj[last]}else{return null}},setProperty:function(obj,prop,value){var parts=prop.split("."),last=parts.pop(),l=parts.length,i=1,current=parts[0];while(i<l&&(obj=obj[current])){current=parts[i];i++}if(obj){obj[last]=value}return obj},chanceRoll:function(chance){if(typeof chance==="undefined"){chance=50}return chance>0&&Math.random()*100<=chance},randomChoice:function(choice1,choice2){return Math.random()<.5?choice1:choice2},transposeArray:function(array){return Phaser.ArrayUtils.transposeMatrix(array)},rotateArray:function(matrix,direction){return Phaser.ArrayUtils.rotateMatrix(matrix,direction)},shuffle:function(array){return Phaser.ArrayUtils.shuffle(array)},parseDimension:function(size,dimension){var f=0;var px=0;if(typeof size==="string"){if(size.substr(-1)==="%"){f=parseInt(size,10)/100;if(dimension===0){px=window.innerWidth*f}else{px=window.innerHeight*f}}else{px=parseInt(size,10)}}else{px=size}return px},pad:function(str,len,pad,dir){if(typeof len==="undefined"){var len=0}if(typeof pad==="undefined"){var pad=" "}if(typeof dir==="undefined"){var dir=3}var padlen=0;if(len+1>=str.length){switch(dir){case 1:str=new Array(len+1-str.length).join(pad)+str;break;case 3:var right=Math.ceil((padlen=len-str.length)/2);var left=padlen-right;str=new Array(left+1).join(pad)+str+new Array(right+1).join(pad);break;default:str=str+new Array(len+1-str.length).join(pad);break}}return str},isPlainObject:function(obj){if(typeof obj!=="object"||obj.nodeType||obj===obj.window){return false}try{if(obj.constructor&&!{}.hasOwnProperty.call(obj.constructor.prototype,"isPrototypeOf")){return false}}catch(e){return false}return true},extend:function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(length===i){target=this;--i}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(Phaser.Utils.isPlainObject(copy)||(copyIsArray=Array.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&Array.isArray(src)?src:[]}else{clone=src&&Phaser.Utils.isPlainObject(src)?src:{}}target[name]=Phaser.Utils.extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target},mixinPrototype:function(target,mixin,replace){if(typeof replace==="undefined"){replace=false}var mixinKeys=Object.keys(mixin);for(var i=0;i<mixinKeys.length;i++){var key=mixinKeys[i];var value=mixin[key];if(!replace&&key in target){continue}else{if(value&&(typeof value.get==="function"||typeof value.set==="function")){if(typeof value.clone==="function"){target[key]=value.clone()}else{Object.defineProperty(target,key,value)}}else{target[key]=value}}}},mixin:function(from,to){if(!from||typeof from!=="object"){return to}for(var key in from){var o=from[key];if(o.childNodes||o.cloneNode){continue}var type=typeof from[key];if(!from[key]||type!=="object"){to[key]=from[key]}else{if(typeof to[key]===type){to[key]=Phaser.Utils.mixin(from[key],to[key])}else{to[key]=Phaser.Utils.mixin(from[key],new o.constructor)}}}return to}};Phaser.Circle=function(x,y,diameter){x=x||0;y=y||0;diameter=diameter||0;this.x=x;this.y=y;this._diameter=diameter;this._radius=0;if(diameter>0){this._radius=diameter*.5}this.type=Phaser.CIRCLE};Phaser.Circle.prototype={circumference:function(){return 2*(Math.PI*this._radius)},getBounds:function(){return new Phaser.Rectangle(this.x-this.radius,this.y-this.radius,this.diameter,this.diameter)},setTo:function(x,y,diameter){this.x=x;this.y=y;this._diameter=diameter;this._radius=diameter*.5;return this},copyFrom:function(source){return this.setTo(source.x,source.y,source.diameter)},copyTo:function(dest){dest.x=this.x;dest.y=this.y;dest.diameter=this._diameter;return dest},distance:function(dest,round){var distance=Phaser.Math.distance(this.x,this.y,dest.x,dest.y);return round?Math.round(distance):distance},clone:function(output){if(typeof output==="undefined"||output===null){output=new Phaser.Circle(this.x,this.y,this.diameter)}else{output.setTo(this.x,this.y,this.diameter)}return output},contains:function(x,y){return Phaser.Circle.contains(this,x,y)},circumferencePoint:function(angle,asDegrees,out){return Phaser.Circle.circumferencePoint(this,angle,asDegrees,out)},offset:function(dx,dy){this.x+=dx;this.y+=dy;return this},offsetPoint:function(point){return this.offset(point.x,point.y)},toString:function(){return"[{Phaser.Circle (x="+this.x+" y="+this.y+" diameter="+this.diameter+" radius="+this.radius+")}]"}};Phaser.Circle.prototype.constructor=Phaser.Circle;Object.defineProperty(Phaser.Circle.prototype,"diameter",{get:function(){return this._diameter},set:function(value){if(value>0){this._diameter=value;this._radius=value*.5}}});Object.defineProperty(Phaser.Circle.prototype,"radius",{get:function(){return this._radius},set:function(value){if(value>0){this._radius=value;this._diameter=value*2}}});Object.defineProperty(Phaser.Circle.prototype,"left",{get:function(){return this.x-this._radius},set:function(value){if(value>this.x){this._radius=0;this._diameter=0}else{this.radius=this.x-value}}});Object.defineProperty(Phaser.Circle.prototype,"right",{get:function(){return this.x+this._radius},set:function(value){if(value<this.x){this._radius=0;this._diameter=0}else{this.radius=value-this.x}}});Object.defineProperty(Phaser.Circle.prototype,"top",{get:function(){return this.y-this._radius},set:function(value){if(value>this.y){this._radius=0;this._diameter=0}else{this.radius=this.y-value}}});Object.defineProperty(Phaser.Circle.prototype,"bottom",{get:function(){return this.y+this._radius},set:function(value){if(value<this.y){this._radius=0;this._diameter=0}else{this.radius=value-this.y}}});Object.defineProperty(Phaser.Circle.prototype,"area",{get:function(){if(this._radius>0){return Math.PI*this._radius*this._radius}else{return 0}}});Object.defineProperty(Phaser.Circle.prototype,"empty",{get:function(){return this._diameter===0},set:function(value){if(value===true){this.setTo(0,0,0)}}});Phaser.Circle.contains=function(a,x,y){if(a.radius>0&&x>=a.left&&x<=a.right&&y>=a.top&&y<=a.bottom){var dx=(a.x-x)*(a.x-x);var dy=(a.y-y)*(a.y-y);return dx+dy<=a.radius*a.radius}else{return false}};Phaser.Circle.equals=function(a,b){return a.x==b.x&&a.y==b.y&&a.diameter==b.diameter};Phaser.Circle.intersects=function(a,b){return Phaser.Math.distance(a.x,a.y,b.x,b.y)<=a.radius+b.radius};Phaser.Circle.circumferencePoint=function(a,angle,asDegrees,out){if(typeof asDegrees==="undefined"){asDegrees=false}if(typeof out==="undefined"){out=new Phaser.Point}if(asDegrees===true){angle=Phaser.Math.degToRad(angle)}out.x=a.x+a.radius*Math.cos(angle);out.y=a.y+a.radius*Math.sin(angle);return out};Phaser.Circle.intersectsRectangle=function(c,r){var cx=Math.abs(c.x-r.x-r.halfWidth);var xDist=r.halfWidth+c.radius;if(cx>xDist){return false}var cy=Math.abs(c.y-r.y-r.halfHeight);var yDist=r.halfHeight+c.radius;if(cy>yDist){return false}if(cx<=r.halfWidth||cy<=r.halfHeight){return true}var xCornerDist=cx-r.halfWidth;var yCornerDist=cy-r.halfHeight;var xCornerDistSq=xCornerDist*xCornerDist;var yCornerDistSq=yCornerDist*yCornerDist;var maxCornerDistSq=c.radius*c.radius;return xCornerDistSq+yCornerDistSq<=maxCornerDistSq};PIXI.Circle=Phaser.Circle;Phaser.Ellipse=function(x,y,width,height){x=x||0;y=y||0;width=width||0;height=height||0;this.x=x;this.y=y;this.width=width;this.height=height;this.type=Phaser.ELLIPSE};Phaser.Ellipse.prototype={setTo:function(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;return this},getBounds:function(){return new Phaser.Rectangle(this.x-this.width,this.y-this.height,this.width,this.height)},copyFrom:function(source){return this.setTo(source.x,source.y,source.width,source.height)},copyTo:function(dest){dest.x=this.x;dest.y=this.y;dest.width=this.width;dest.height=this.height;return dest},clone:function(output){if(typeof output==="undefined"||output===null){output=new Phaser.Ellipse(this.x,this.y,this.width,this.height)}else{output.setTo(this.x,this.y,this.width,this.height)}return output},contains:function(x,y){return Phaser.Ellipse.contains(this,x,y)},toString:function(){return"[{Phaser.Ellipse (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")}]"}};Phaser.Ellipse.prototype.constructor=Phaser.Ellipse;Object.defineProperty(Phaser.Ellipse.prototype,"left",{get:function(){return this.x},set:function(value){this.x=value}});Object.defineProperty(Phaser.Ellipse.prototype,"right",{get:function(){return this.x+this.width},set:function(value){if(value<this.x){this.width=0}else{this.width=value-this.x}}});Object.defineProperty(Phaser.Ellipse.prototype,"top",{get:function(){return this.y},set:function(value){this.y=value}});Object.defineProperty(Phaser.Ellipse.prototype,"bottom",{get:function(){return this.y+this.height},set:function(value){if(value<this.y){this.height=0}else{this.height=value-this.y}}});Object.defineProperty(Phaser.Ellipse.prototype,"empty",{get:function(){return this.width===0||this.height===0},set:function(value){if(value===true){this.setTo(0,0,0,0)}}});Phaser.Ellipse.contains=function(a,x,y){if(a.width<=0||a.height<=0){return false}var normx=(x-a.x)/a.width-.5;var normy=(y-a.y)/a.height-.5;normx*=normx;normy*=normy;return normx+normy<.25};PIXI.Ellipse=Phaser.Ellipse;Phaser.Line=function(x1,y1,x2,y2){x1=x1||0;y1=y1||0;x2=x2||0;y2=y2||0;this.start=new Phaser.Point(x1,y1);this.end=new Phaser.Point(x2,y2);this.type=Phaser.LINE};Phaser.Line.prototype={setTo:function(x1,y1,x2,y2){this.start.setTo(x1,y1);this.end.setTo(x2,y2);return this},fromSprite:function(startSprite,endSprite,useCenter){if(typeof useCenter==="undefined"){useCenter=false}if(useCenter){return this.setTo(startSprite.center.x,startSprite.center.y,endSprite.center.x,endSprite.center.y)}return this.setTo(startSprite.x,startSprite.y,endSprite.x,endSprite.y)
},fromAngle:function(x,y,angle,length){this.start.setTo(x,y);this.end.setTo(x+Math.cos(angle)*length,y+Math.sin(angle)*length);return this},intersects:function(line,asSegment,result){return Phaser.Line.intersectsPoints(this.start,this.end,line.start,line.end,asSegment,result)},reflect:function(line){return Phaser.Line.reflect(this,line)},pointOnLine:function(x,y){return(x-this.start.x)*(this.end.y-this.start.y)===(this.end.x-this.start.x)*(y-this.start.y)},pointOnSegment:function(x,y){var xMin=Math.min(this.start.x,this.end.x);var xMax=Math.max(this.start.x,this.end.x);var yMin=Math.min(this.start.y,this.end.y);var yMax=Math.max(this.start.y,this.end.y);return this.pointOnLine(x,y)&&(x>=xMin&&x<=xMax)&&(y>=yMin&&y<=yMax)},coordinatesOnLine:function(stepRate,results){if(typeof stepRate==="undefined"){stepRate=1}if(typeof results==="undefined"){results=[]}var x1=Math.round(this.start.x);var y1=Math.round(this.start.y);var x2=Math.round(this.end.x);var y2=Math.round(this.end.y);var dx=Math.abs(x2-x1);var dy=Math.abs(y2-y1);var sx=x1<x2?1:-1;var sy=y1<y2?1:-1;var err=dx-dy;results.push([x1,y1]);var i=1;while(!(x1==x2&&y1==y2)){var e2=err<<1;if(e2>-dy){err-=dy;x1+=sx}if(e2<dx){err+=dx;y1+=sy}if(i%stepRate===0){results.push([x1,y1])}i++}return results},clone:function(output){if(typeof output==="undefined"||output===null){output=new Phaser.Line(this.start.x,this.start.y,this.end.x,this.end.y)}else{output.setTo(this.start.x,this.start.y,this.end.x,this.end.y)}return output}};Object.defineProperty(Phaser.Line.prototype,"length",{get:function(){return Math.sqrt((this.end.x-this.start.x)*(this.end.x-this.start.x)+(this.end.y-this.start.y)*(this.end.y-this.start.y))}});Object.defineProperty(Phaser.Line.prototype,"angle",{get:function(){return Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x)}});Object.defineProperty(Phaser.Line.prototype,"slope",{get:function(){return(this.end.y-this.start.y)/(this.end.x-this.start.x)}});Object.defineProperty(Phaser.Line.prototype,"perpSlope",{get:function(){return-((this.end.x-this.start.x)/(this.end.y-this.start.y))}});Object.defineProperty(Phaser.Line.prototype,"x",{get:function(){return Math.min(this.start.x,this.end.x)}});Object.defineProperty(Phaser.Line.prototype,"y",{get:function(){return Math.min(this.start.y,this.end.y)}});Object.defineProperty(Phaser.Line.prototype,"left",{get:function(){return Math.min(this.start.x,this.end.x)}});Object.defineProperty(Phaser.Line.prototype,"right",{get:function(){return Math.max(this.start.x,this.end.x)}});Object.defineProperty(Phaser.Line.prototype,"top",{get:function(){return Math.min(this.start.y,this.end.y)}});Object.defineProperty(Phaser.Line.prototype,"bottom",{get:function(){return Math.max(this.start.y,this.end.y)}});Object.defineProperty(Phaser.Line.prototype,"width",{get:function(){return Math.abs(this.start.x-this.end.x)}});Object.defineProperty(Phaser.Line.prototype,"height",{get:function(){return Math.abs(this.start.y-this.end.y)}});Object.defineProperty(Phaser.Line.prototype,"normalX",{get:function(){return Math.cos(this.angle-1.5707963267948966)}});Object.defineProperty(Phaser.Line.prototype,"normalY",{get:function(){return Math.sin(this.angle-1.5707963267948966)}});Object.defineProperty(Phaser.Line.prototype,"normalAngle",{get:function(){return Phaser.Math.wrap(this.angle-1.5707963267948966,-Math.PI,Math.PI)}});Phaser.Line.intersectsPoints=function(a,b,e,f,asSegment,result){if(typeof asSegment==="undefined"){asSegment=true}if(typeof result==="undefined"){result=new Phaser.Point}var a1=b.y-a.y;var a2=f.y-e.y;var b1=a.x-b.x;var b2=e.x-f.x;var c1=b.x*a.y-a.x*b.y;var c2=f.x*e.y-e.x*f.y;var denom=a1*b2-a2*b1;if(denom===0){return null}result.x=(b1*c2-b2*c1)/denom;result.y=(a2*c1-a1*c2)/denom;if(asSegment){var uc=(f.y-e.y)*(b.x-a.x)-(f.x-e.x)*(b.y-a.y);var ua=((f.x-e.x)*(a.y-e.y)-(f.y-e.y)*(a.x-e.x))/uc;var ub=((b.x-a.x)*(a.y-e.y)-(b.y-a.y)*(a.x-e.x))/uc;if(ua>=0&&ua<=1&&ub>=0&&ub<=1){return result}else{return null}}return result};Phaser.Line.intersects=function(a,b,asSegment,result){return Phaser.Line.intersectsPoints(a.start,a.end,b.start,b.end,asSegment,result)};Phaser.Line.reflect=function(a,b){return 2*b.normalAngle-3.141592653589793-a.angle};Phaser.Matrix=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0;this.type=Phaser.MATRIX};Phaser.Matrix.prototype.fromArray=function(array){this.a=array[0];this.b=array[1];this.c=array[3];this.d=array[4];this.tx=array[2];this.ty=array[5]};Phaser.Matrix.prototype.toArray=function(transpose){if(!this.array){this.array=new PIXI.Float32Array(9)}var array=this.array;if(transpose){array[0]=this.a;array[1]=this.b;array[2]=0;array[3]=this.c;array[4]=this.d;array[5]=0;array[6]=this.tx;array[7]=this.ty;array[8]=1}else{array[0]=this.a;array[1]=this.c;array[2]=this.tx;array[3]=this.b;array[4]=this.d;array[5]=this.ty;array[6]=0;array[7]=0;array[8]=1}return array};Phaser.Matrix.prototype.apply=function(pos,newPos){newPos=newPos||new Phaser.Point;var x=pos.x;var y=pos.y;newPos.x=this.a*x+this.c*y+this.tx;newPos.y=this.b*x+this.d*y+this.ty;return newPos};Phaser.Matrix.prototype.applyInverse=function(pos,newPos){newPos=newPos||new Phaser.Point;var id=1/(this.a*this.d+this.c*-this.b);var x=pos.x;var y=pos.y;newPos.x=this.d*id*x+-this.c*id*y+(this.ty*this.c-this.tx*this.d)*id;newPos.y=this.a*id*y+-this.b*id*x+(-this.ty*this.a+this.tx*this.b)*id;return newPos};Phaser.Matrix.prototype.translate=function(x,y){this.tx+=x;this.ty+=y;return this};Phaser.Matrix.prototype.scale=function(x,y){this.a*=x;this.d*=y;this.c*=x;this.b*=y;this.tx*=x;this.ty*=y;return this};Phaser.Matrix.prototype.rotate=function(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var a1=this.a;var c1=this.c;var tx1=this.tx;this.a=a1*cos-this.b*sin;this.b=a1*sin+this.b*cos;this.c=c1*cos-this.d*sin;this.d=c1*sin+this.d*cos;this.tx=tx1*cos-this.ty*sin;this.ty=tx1*sin+this.ty*cos;return this};Phaser.Matrix.prototype.append=function(matrix){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;this.a=matrix.a*a1+matrix.b*c1;this.b=matrix.a*b1+matrix.b*d1;this.c=matrix.c*a1+matrix.d*c1;this.d=matrix.c*b1+matrix.d*d1;this.tx=matrix.tx*a1+matrix.ty*c1+this.tx;this.ty=matrix.tx*b1+matrix.ty*d1+this.ty;return this};Phaser.Matrix.prototype.identity=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0;return this};Phaser.identityMatrix=new Phaser.Matrix;PIXI.Matrix=Phaser.Matrix;PIXI.identityMatrix=Phaser.identityMatrix;Phaser.Point=function(x,y){x=x||0;y=y||0;this.x=x;this.y=y;this.type=Phaser.POINT};Phaser.Point.prototype={copyFrom:function(source){return this.setTo(source.x,source.y)},invert:function(){return this.setTo(this.y,this.x)},setTo:function(x,y){this.x=x||0;this.y=y||(y!==0?this.x:0);return this},set:function(x,y){this.x=x||0;this.y=y||(y!==0?this.x:0);return this},add:function(x,y){this.x+=x;this.y+=y;return this},subtract:function(x,y){this.x-=x;this.y-=y;return this},multiply:function(x,y){this.x*=x;this.y*=y;return this},divide:function(x,y){this.x/=x;this.y/=y;return this},clampX:function(min,max){this.x=Phaser.Math.clamp(this.x,min,max);return this},clampY:function(min,max){this.y=Phaser.Math.clamp(this.y,min,max);return this},clamp:function(min,max){this.x=Phaser.Math.clamp(this.x,min,max);this.y=Phaser.Math.clamp(this.y,min,max);return this},clone:function(output){if(typeof output==="undefined"||output===null){output=new Phaser.Point(this.x,this.y)}else{output.setTo(this.x,this.y)}return output},copyTo:function(dest){dest.x=this.x;dest.y=this.y;return dest},distance:function(dest,round){return Phaser.Point.distance(this,dest,round)},equals:function(a){return a.x===this.x&&a.y===this.y},angle:function(a,asDegrees){if(typeof asDegrees==="undefined"){asDegrees=false}if(asDegrees){return Phaser.Math.radToDeg(Math.atan2(a.y-this.y,a.x-this.x))}else{return Math.atan2(a.y-this.y,a.x-this.x)}},rotate:function(x,y,angle,asDegrees,distance){return Phaser.Point.rotate(this,x,y,angle,asDegrees,distance)},getMagnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},getMagnitudeSq:function(){return this.x*this.x+this.y*this.y},setMagnitude:function(magnitude){return this.normalize().multiply(magnitude,magnitude)},normalize:function(){if(!this.isZero()){var m=this.getMagnitude();this.x/=m;this.y/=m}return this},isZero:function(){return this.x===0&&this.y===0},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y-this.y*a.x},perp:function(){return this.setTo(-this.y,this.x)},rperp:function(){return this.setTo(this.y,-this.x)},normalRightHand:function(){return this.setTo(this.y*-1,this.x)},floor:function(){return this.setTo(Math.floor(this.x),Math.floor(this.y))},ceil:function(){return this.setTo(Math.ceil(this.x),Math.ceil(this.y))},toString:function(){return"[{Point (x="+this.x+" y="+this.y+")}]"}};Phaser.Point.prototype.constructor=Phaser.Point;Phaser.Point.add=function(a,b,out){if(typeof out==="undefined"){out=new Phaser.Point}out.x=a.x+b.x;out.y=a.y+b.y;return out};Phaser.Point.subtract=function(a,b,out){if(typeof out==="undefined"){out=new Phaser.Point}out.x=a.x-b.x;out.y=a.y-b.y;return out};Phaser.Point.multiply=function(a,b,out){if(typeof out==="undefined"){out=new Phaser.Point}out.x=a.x*b.x;out.y=a.y*b.y;return out};Phaser.Point.divide=function(a,b,out){if(typeof out==="undefined"){out=new Phaser.Point}out.x=a.x/b.x;out.y=a.y/b.y;return out};Phaser.Point.equals=function(a,b){return a.x===b.x&&a.y===b.y};Phaser.Point.angle=function(a,b){return Math.atan2(a.y-b.y,a.x-b.x)};Phaser.Point.negative=function(a,out){if(typeof out==="undefined"){out=new Phaser.Point}return out.setTo(-a.x,-a.y)};Phaser.Point.multiplyAdd=function(a,b,s,out){if(typeof out==="undefined"){out=new Phaser.Point}return out.setTo(a.x+b.x*s,a.y+b.y*s)};Phaser.Point.interpolate=function(a,b,f,out){if(typeof out==="undefined"){out=new Phaser.Point}return out.setTo(a.x+(b.x-a.x)*f,a.y+(b.y-a.y)*f)};Phaser.Point.perp=function(a,out){if(typeof out==="undefined"){out=new Phaser.Point}return out.setTo(-a.y,a.x)};Phaser.Point.rperp=function(a,out){if(typeof out==="undefined"){out=new Phaser.Point}return out.setTo(a.y,-a.x)};Phaser.Point.distance=function(a,b,round){var distance=Phaser.Math.distance(a.x,a.y,b.x,b.y);return round?Math.round(distance):distance};Phaser.Point.project=function(a,b,out){if(typeof out==="undefined"){out=new Phaser.Point}var amt=a.dot(b)/b.getMagnitudeSq();if(amt!==0){out.setTo(amt*b.x,amt*b.y)}return out};Phaser.Point.projectUnit=function(a,b,out){if(typeof out==="undefined"){out=new Phaser.Point}var amt=a.dot(b);if(amt!==0){out.setTo(amt*b.x,amt*b.y)}return out};Phaser.Point.normalRightHand=function(a,out){if(typeof out==="undefined"){out=new Phaser.Point}return out.setTo(a.y*-1,a.x)};Phaser.Point.normalize=function(a,out){if(typeof out==="undefined"){out=new Phaser.Point}var m=a.getMagnitude();if(m!==0){out.setTo(a.x/m,a.y/m)}return out};Phaser.Point.rotate=function(a,x,y,angle,asDegrees,distance){asDegrees=asDegrees||false;distance=distance||null;if(asDegrees){angle=Phaser.Math.degToRad(angle)}if(distance===null){distance=Math.sqrt((x-a.x)*(x-a.x)+(y-a.y)*(y-a.y))}var requiredAngle=angle+Math.atan2(a.y-y,a.x-x);return a.setTo(x+distance*Math.cos(requiredAngle),y+distance*Math.sin(requiredAngle))};Phaser.Point.centroid=function(points,out){if(typeof out==="undefined"){out=new Phaser.Point}if(Object.prototype.toString.call(points)!=="[object Array]"){throw new Error("Phaser.Point. Parameter 'points' must be an array")}var pointslength=points.length;if(pointslength<1){throw new Error("Phaser.Point. Parameter 'points' array must not be empty")}if(pointslength===1){out.copyFrom(points[0]);return out}for(var i=0;i<pointslength;i++){Phaser.Point.add(out,points[i],out)}out.divide(pointslength,pointslength);return out};Phaser.Point.parse=function(obj,xProp,yProp){xProp=xProp||"x";yProp=yProp||"y";var point=new Phaser.Point;if(obj[xProp]){point.x=parseInt(obj[xProp],10)}if(obj[yProp]){point.y=parseInt(obj[yProp],10)}return point};PIXI.Point=Phaser.Point;Phaser.Polygon=function(){this.area=0;this._points=[];if(arguments.length>0){this.setTo.apply(this,arguments)}this.closed=true;this.type=Phaser.POLYGON};Phaser.Polygon.prototype={toNumberArray:function(output){if(typeof output==="undefined"){output=[]}for(var i=0;i<this._points.length;i++){if(typeof this._points[i]==="number"){output.push(this._points[i]);output.push(this._points[i+1]);i++}else{output.push(this._points[i].x);output.push(this._points[i].y)}}return output},flatten:function(){this._points=this.toNumberArray();return this},clone:function(output){var points=this._points.slice();if(typeof output==="undefined"||output===null){output=new Phaser.Polygon(points)}else{output.setTo(points)}return output},contains:function(x,y){var length=this._points.length;var inside=false;for(var i=-1,j=length-1;++i<length;j=i){var ix=this._points[i].x;var iy=this._points[i].y;var jx=this._points[j].x;var jy=this._points[j].y;if((iy<=y&&y<jy||jy<=y&&y<iy)&&x<(jx-ix)*(y-iy)/(jy-iy)+ix){inside=!inside}}return inside},setTo:function(points){this.area=0;this._points=[];if(arguments.length>0){if(!Array.isArray(points)){points=Array.prototype.slice.call(arguments)}var y0=Number.MAX_VALUE;for(var i=0,len=points.length;i<len;i++){if(typeof points[i]==="number"){var p=new PIXI.Point(points[i],points[i+1]);i++}else{var p=new PIXI.Point(points[i].x,points[i].y)}this._points.push(p);if(p.y<y0){y0=p.y}}this.calculateArea(y0)}return this},calculateArea:function(y0){var p1;var p2;var avgHeight;var width;for(var i=0,len=this._points.length;i<len;i++){p1=this._points[i];if(i===len-1){p2=this._points[0]}else{p2=this._points[i+1]}avgHeight=(p1.y-y0+(p2.y-y0))/2;width=p1.x-p2.x;this.area+=avgHeight*width}return this.area}};Phaser.Polygon.prototype.constructor=Phaser.Polygon;Object.defineProperty(Phaser.Polygon.prototype,"points",{get:function(){return this._points},set:function(points){if(points!=null){this.setTo(points)}else{this.setTo()}}});PIXI.Polygon=Phaser.Polygon;Phaser.Rectangle=function(x,y,width,height){x=x||0;y=y||0;width=width||0;height=height||0;this.x=x;this.y=y;this.width=width;this.height=height;this.type=Phaser.RECTANGLE};Phaser.Rectangle.prototype={offset:function(dx,dy){this.x+=dx;this.y+=dy;return this},offsetPoint:function(point){return this.offset(point.x,point.y)},setTo:function(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;return this},scale:function(x,y){if(typeof y==="undefined"){y=x}this.width*=x;this.height*=y;return this},centerOn:function(x,y){this.centerX=x;this.centerY=y;return this},floor:function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y)},floorAll:function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.width=Math.floor(this.width);this.height=Math.floor(this.height)},copyFrom:function(source){return this.setTo(source.x,source.y,source.width,source.height)},copyTo:function(dest){dest.x=this.x;dest.y=this.y;dest.width=this.width;dest.height=this.height;return dest},inflate:function(dx,dy){return Phaser.Rectangle.inflate(this,dx,dy)},size:function(output){return Phaser.Rectangle.size(this,output)},clone:function(output){return Phaser.Rectangle.clone(this,output)},contains:function(x,y){return Phaser.Rectangle.contains(this,x,y)},containsRect:function(b){return Phaser.Rectangle.containsRect(b,this)},equals:function(b){return Phaser.Rectangle.equals(this,b)},intersection:function(b,out){return Phaser.Rectangle.intersection(this,b,out)},intersects:function(b){return Phaser.Rectangle.intersects(this,b)},intersectsRaw:function(left,right,top,bottom,tolerance){return Phaser.Rectangle.intersectsRaw(this,left,right,top,bottom,tolerance)},union:function(b,out){return Phaser.Rectangle.union(this,b,out)},toString:function(){return"[{Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+" empty="+this.empty+")}]"}};Object.defineProperty(Phaser.Rectangle.prototype,"halfWidth",{get:function(){return Math.round(this.width/2)}});Object.defineProperty(Phaser.Rectangle.prototype,"halfHeight",{get:function(){return Math.round(this.height/2)}});Object.defineProperty(Phaser.Rectangle.prototype,"bottom",{get:function(){return this.y+this.height},set:function(value){if(value<=this.y){this.height=0}else{this.height=value-this.y}}});Object.defineProperty(Phaser.Rectangle.prototype,"bottomRight",{get:function(){return new Phaser.Point(this.right,this.bottom)},set:function(value){this.right=value.x;this.bottom=value.y}});Object.defineProperty(Phaser.Rectangle.prototype,"left",{get:function(){return this.x},set:function(value){if(value>=this.right){this.width=0}else{this.width=this.right-value}this.x=value}});Object.defineProperty(Phaser.Rectangle.prototype,"right",{get:function(){return this.x+this.width},set:function(value){if(value<=this.x){this.width=0}else{this.width=value-this.x}}});Object.defineProperty(Phaser.Rectangle.prototype,"volume",{get:function(){return this.width*this.height}});Object.defineProperty(Phaser.Rectangle.prototype,"perimeter",{get:function(){return this.width*2+this.height*2}});Object.defineProperty(Phaser.Rectangle.prototype,"centerX",{get:function(){return this.x+this.halfWidth},set:function(value){this.x=value-this.halfWidth}});Object.defineProperty(Phaser.Rectangle.prototype,"centerY",{get:function(){return this.y+this.halfHeight},set:function(value){this.y=value-this.halfHeight}});Object.defineProperty(Phaser.Rectangle.prototype,"randomX",{get:function(){return this.x+Math.random()*this.width}});Object.defineProperty(Phaser.Rectangle.prototype,"randomY",{get:function(){return this.y+Math.random()*this.height}});Object.defineProperty(Phaser.Rectangle.prototype,"top",{get:function(){return this.y},set:function(value){if(value>=this.bottom){this.height=0;this.y=value}else{this.height=this.bottom-value}}});Object.defineProperty(Phaser.Rectangle.prototype,"topLeft",{get:function(){return new Phaser.Point(this.x,this.y)},set:function(value){this.x=value.x;this.y=value.y}});Object.defineProperty(Phaser.Rectangle.prototype,"topRight",{get:function(){return new Phaser.Point(this.x+this.width,this.y)},set:function(value){this.right=value.x;this.y=value.y}});Object.defineProperty(Phaser.Rectangle.prototype,"empty",{get:function(){return!this.width||!this.height},set:function(value){if(value===true){this.setTo(0,0,0,0)}}});Phaser.Rectangle.prototype.constructor=Phaser.Rectangle;Phaser.Rectangle.inflate=function(a,dx,dy){a.x-=dx;a.width+=2*dx;a.y-=dy;a.height+=2*dy;return a};Phaser.Rectangle.inflatePoint=function(a,point){return Phaser.Rectangle.inflate(a,point.x,point.y)};Phaser.Rectangle.size=function(a,output){if(typeof output==="undefined"||output===null){output=new Phaser.Point(a.width,a.height)}else{output.setTo(a.width,a.height)}return output};Phaser.Rectangle.clone=function(a,output){if(typeof output==="undefined"||output===null){output=new Phaser.Rectangle(a.x,a.y,a.width,a.height)}else{output.setTo(a.x,a.y,a.width,a.height)}return output};Phaser.Rectangle.contains=function(a,x,y){if(a.width<=0||a.height<=0){return false}return x>=a.x&&x<a.right&&y>=a.y&&y<a.bottom};Phaser.Rectangle.containsRaw=function(rx,ry,rw,rh,x,y){return x>=rx&&x<rx+rw&&y>=ry&&y<ry+rh};Phaser.Rectangle.containsPoint=function(a,point){return Phaser.Rectangle.contains(a,point.x,point.y)};Phaser.Rectangle.containsRect=function(a,b){if(a.volume>b.volume){return false}return a.x>=b.x&&a.y>=b.y&&a.right<b.right&&a.bottom<b.bottom};Phaser.Rectangle.equals=function(a,b){return a.x==b.x&&a.y==b.y&&a.width==b.width&&a.height==b.height};Phaser.Rectangle.sameDimensions=function(a,b){return a.width===b.width&&a.height===b.height};Phaser.Rectangle.intersection=function(a,b,output){if(typeof output==="undefined"){output=new Phaser.Rectangle}if(Phaser.Rectangle.intersects(a,b)){output.x=Math.max(a.x,b.x);output.y=Math.max(a.y,b.y);output.width=Math.min(a.right,b.right)-output.x;output.height=Math.min(a.bottom,b.bottom)-output.y}return output};Phaser.Rectangle.intersects=function(a,b){if(a.width<=0||a.height<=0||b.width<=0||b.height<=0){return false}return!(a.right<b.x||a.bottom<b.y||a.x>b.right||a.y>b.bottom)};Phaser.Rectangle.intersectsRaw=function(a,left,right,top,bottom,tolerance){if(typeof tolerance==="undefined"){tolerance=0}return!(left>a.right+tolerance||right<a.left-tolerance||top>a.bottom+tolerance||bottom<a.top-tolerance)};Phaser.Rectangle.union=function(a,b,output){if(typeof output==="undefined"){output=new Phaser.Rectangle}return output.setTo(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.max(a.right,b.right)-Math.min(a.left,b.left),Math.max(a.bottom,b.bottom)-Math.min(a.top,b.top))};Phaser.Rectangle.aabb=function(points,out){if(typeof out==="undefined"){out=new Phaser.Rectangle}var xMax=Number.MIN_VALUE,xMin=Number.MAX_VALUE,yMax=Number.MIN_VALUE,yMin=Number.MAX_VALUE;points.forEach(function(point){if(point.x>xMax){xMax=point.x}if(point.x<xMin){xMin=point.x}if(point.y>yMax){yMax=point.y}if(point.y<yMin){yMin=point.y}});out.setTo(xMin,yMin,xMax-xMin,yMax-yMin);return out};PIXI.Rectangle=Phaser.Rectangle;PIXI.EmptyRectangle=new Phaser.Rectangle(0,0,0,0);Phaser.RoundedRectangle=function(x,y,width,height,radius){this.x=x||0;this.y=y||0;this.width=width||0;this.height=height||0;this.radius=radius||20;this.type=Phaser.ROUNDEDRECTANGLE};Phaser.RoundedRectangle.prototype.clone=function(){return new Phaser.RoundedRectangle(this.x,this.y,this.width,this.height,this.radius)};Phaser.RoundedRectangle.prototype.contains=function(x,y){if(this.width<=0||this.height<=0){return false}var x1=this.x;if(x>=x1&&x<=x1+this.width){var y1=this.y;if(y>=y1&&y<=y1+this.height){return true}}return false};Phaser.RoundedRectangle.prototype.constructor=Phaser.RoundedRectangle;PIXI.RoundedRectangle=Phaser.RoundedRectangle;Phaser.Camera=function(game,id,x,y,width,height){this.game=game;this.world=game.world;this.id=0;this.view=new Phaser.Rectangle(x,y,width,height);this.screenView=new Phaser.Rectangle(x,y,width,height);this.bounds=new Phaser.Rectangle(x,y,width,height);this.deadzone=null;this.visible=true;this.roundPx=true;this.atLimit={x:false,y:false};this.target=null;this.displayObject=null;this.scale=null;this.totalInView=0;this._targetPosition=new Phaser.Point;this._edge=0;this._position=new Phaser.Point};Phaser.Camera.FOLLOW_LOCKON=0;Phaser.Camera.FOLLOW_PLATFORMER=1;Phaser.Camera.FOLLOW_TOPDOWN=2;Phaser.Camera.FOLLOW_TOPDOWN_TIGHT=3;Phaser.Camera.prototype={preUpdate:function(){this.totalInView=0},follow:function(target,style){if(typeof style==="undefined"){style=Phaser.Camera.FOLLOW_LOCKON}this.target=target;var helper;switch(style){case Phaser.Camera.FOLLOW_PLATFORMER:var w=this.width/8;var h=this.height/3;this.deadzone=new Phaser.Rectangle((this.width-w)/2,(this.height-h)/2-h*.25,w,h);break;case Phaser.Camera.FOLLOW_TOPDOWN:helper=Math.max(this.width,this.height)/4;this.deadzone=new Phaser.Rectangle((this.width-helper)/2,(this.height-helper)/2,helper,helper);break;case Phaser.Camera.FOLLOW_TOPDOWN_TIGHT:helper=Math.max(this.width,this.height)/8;this.deadzone=new Phaser.Rectangle((this.width-helper)/2,(this.height-helper)/2,helper,helper);break;case Phaser.Camera.FOLLOW_LOCKON:this.deadzone=null;break;default:this.deadzone=null;break}},unfollow:function(){this.target=null},focusOn:function(displayObject){this.setPosition(Math.round(displayObject.x-this.view.halfWidth),Math.round(displayObject.y-this.view.halfHeight))},focusOnXY:function(x,y){this.setPosition(Math.round(x-this.view.halfWidth),Math.round(y-this.view.halfHeight))},update:function(){if(this.target){this.updateTarget()}if(this.bounds){this.checkBounds()}if(this.roundPx){this.view.floor()}this.displayObject.position.x=-this.view.x;this.displayObject.position.y=-this.view.y},updateTarget:function(){this._targetPosition.copyFrom(this.target);if(this.target.parent){this._targetPosition.multiply(this.target.parent.worldTransform.a,this.target.parent.worldTransform.d)}if(this.deadzone){this._edge=this._targetPosition.x-this.view.x;if(this._edge<this.deadzone.left){this.view.x=this._targetPosition.x-this.deadzone.left}else if(this._edge>this.deadzone.right){this.view.x=this._targetPosition.x-this.deadzone.right}this._edge=this._targetPosition.y-this.view.y;if(this._edge<this.deadzone.top){this.view.y=this._targetPosition.y-this.deadzone.top}else if(this._edge>this.deadzone.bottom){this.view.y=this._targetPosition.y-this.deadzone.bottom}}else{this.view.x=this._targetPosition.x-this.view.halfWidth;this.view.y=this._targetPosition.y-this.view.halfHeight}},setBoundsToWorld:function(){if(this.bounds){this.bounds.setTo(this.game.world.bounds.x,this.game.world.bounds.y,this.game.world.bounds.width,this.game.world.bounds.height)}},checkBounds:function(){this.atLimit.x=false;this.atLimit.y=false;if(this.view.x<=this.bounds.x){this.atLimit.x=true;this.view.x=this.bounds.x}if(this.view.right>=this.bounds.right){this.atLimit.x=true;this.view.x=this.bounds.right-this.width}if(this.view.y<=this.bounds.top){this.atLimit.y=true;this.view.y=this.bounds.top}if(this.view.bottom>=this.bounds.bottom){this.atLimit.y=true;this.view.y=this.bounds.bottom-this.height}},setPosition:function(x,y){this.view.x=x;this.view.y=y;if(this.bounds){this.checkBounds()}},setSize:function(width,height){this.view.width=width;this.view.height=height},reset:function(){this.target=null;this.view.x=0;this.view.y=0}};Phaser.Camera.prototype.constructor=Phaser.Camera;Object.defineProperty(Phaser.Camera.prototype,"x",{get:function(){return this.view.x},set:function(value){this.view.x=value;if(this.bounds){this.checkBounds()}}});Object.defineProperty(Phaser.Camera.prototype,"y",{get:function(){return this.view.y},set:function(value){this.view.y=value;if(this.bounds){this.checkBounds()}}});Object.defineProperty(Phaser.Camera.prototype,"position",{get:function(){this._position.set(this.view.centerX,this.view.centerY);return this._position},set:function(value){if(typeof value.x!=="undefined"){this.view.x=value.x}if(typeof value.y!=="undefined"){this.view.y=value.y}if(this.bounds){this.checkBounds()}}});Object.defineProperty(Phaser.Camera.prototype,"width",{get:function(){return this.view.width},set:function(value){this.view.width=value}});Object.defineProperty(Phaser.Camera.prototype,"height",{get:function(){return this.view.height},set:function(value){this.view.height=value}});Phaser.State=function(){this.game=null;this.key="";this.add=null;this.make=null;this.camera=null;this.cache=null;this.input=null;this.load=null;this.math=null;this.sound=null;this.scale=null;this.stage=null;this.time=null;this.tweens=null;this.world=null;this.particles=null;this.physics=null;this.rnd=null};Phaser.State.prototype={init:function(){},preload:function(){},loadUpdate:function(){},loadRender:function(){},create:function(){},update:function(){},render:function(){},resize:function(){},paused:function(){},pauseUpdate:function(){},shutdown:function(){}};Phaser.State.prototype.constructor=Phaser.State;Phaser.StateManager=function(game,pendingState){this.game=game;this.states={};this._pendingState=null;if(typeof pendingState!=="undefined"&&pendingState!==null){this._pendingState=pendingState}this._clearWorld=false;this._clearCache=false;this._created=false;this._args=[];this.current="";this.onInitCallback=null;this.onPreloadCallback=null;this.onCreateCallback=null;this.onUpdateCallback=null;this.onRenderCallback=null;this.onResizeCallback=null;this.onPreRenderCallback=null;this.onLoadUpdateCallback=null;this.onLoadRenderCallback=null;this.onPausedCallback=null;this.onResumedCallback=null;this.onPauseUpdateCallback=null;this.onShutDownCallback=null};Phaser.StateManager.prototype={boot:function(){this.game.onPause.add(this.pause,this);this.game.onResume.add(this.resume,this);if(this._pendingState!==null&&typeof this._pendingState!=="string"){this.add("default",this._pendingState,true)}},add:function(key,state,autoStart){if(typeof autoStart==="undefined"){autoStart=false}var newState;if(state instanceof Phaser.State){newState=state}else if(typeof state==="object"){newState=state;newState.game=this.game}else if(typeof state==="function"){newState=new state(this.game)}this.states[key]=newState;if(autoStart){if(this.game.isBooted){this.start(key)}else{this._pendingState=key}}return newState},remove:function(key){if(this.current===key){this.callbackContext=null;this.onInitCallback=null;this.onShutDownCallback=null;this.onPreloadCallback=null;this.onLoadRenderCallback=null;this.onLoadUpdateCallback=null;this.onCreateCallback=null;this.onUpdateCallback=null;this.onPreRenderCallback=null;this.onRenderCallback=null;this.onResizeCallback=null;this.onPausedCallback=null;this.onResumedCallback=null;this.onPauseUpdateCallback=null}delete this.states[key]},start:function(key,clearWorld,clearCache){if(typeof clearWorld==="undefined"){clearWorld=true}if(typeof clearCache==="undefined"){clearCache=false}if(this.checkState(key)){this._pendingState=key;this._clearWorld=clearWorld;this._clearCache=clearCache;if(arguments.length>3){this._args=Array.prototype.splice.call(arguments,3)}}},restart:function(clearWorld,clearCache){if(typeof clearWorld==="undefined"){clearWorld=true}if(typeof clearCache==="undefined"){clearCache=false}this._pendingState=this.current;this._clearWorld=clearWorld;this._clearCache=clearCache;if(arguments.length>2){this._args=Array.prototype.splice.call(arguments,2)}},dummy:function(){},preUpdate:function(){if(this._pendingState&&this.game.isBooted){this.clearCurrentState();this.setCurrentState(this._pendingState);if(this.current!==this._pendingState){return}else{this._pendingState=null}if(this.onPreloadCallback){this.game.load.reset(true);this.onPreloadCallback.call(this.callbackContext,this.game);if(this.game.load.totalQueuedFiles()===0&&this.game.load.totalQueuedPacks()===0){this.loadComplete()}else{this.game.load.start()}}else{this.loadComplete()}}},clearCurrentState:function(){if(this.current){if(this.onShutDownCallback){this.onShutDownCallback.call(this.callbackContext,this.game)}this.game.tweens.removeAll();this.game.camera.reset();this.game.input.reset(true);this.game.physics.clear();this.game.time.removeAll();this.game.scale.reset(this._clearWorld);if(this.game.debug){this.game.debug.reset()}if(this._clearWorld){this.game.world.shutdown();if(this._clearCache===true){this.game.cache.destroy()}}}},checkState:function(key){if(this.states[key]){var valid=false;if(this.states[key]["preload"]||this.states[key]["create"]||this.states[key]["update"]||this.states[key]["render"]){valid=true}if(valid===false){console.warn("Invalid Phaser State object given. Must contain at least a one of the required functions: preload, create, update or render");return false}return true}else{console.warn("Phaser.StateManager - No state found with the key: "+key);return false}},link:function(key){this.states[key].game=this.game;this.states[key].add=this.game.add;this.states[key].make=this.game.make;this.states[key].camera=this.game.camera;this.states[key].cache=this.game.cache;this.states[key].input=this.game.input;this.states[key].load=this.game.load;this.states[key].math=this.game.math;this.states[key].sound=this.game.sound;this.states[key].scale=this.game.scale;this.states[key].state=this;this.states[key].stage=this.game.stage;this.states[key].time=this.game.time;this.states[key].tweens=this.game.tweens;this.states[key].world=this.game.world;this.states[key].particles=this.game.particles;this.states[key].rnd=this.game.rnd;this.states[key].physics=this.game.physics;this.states[key].key=key},unlink:function(key){if(this.states[key]){this.states[key].game=null;this.states[key].add=null;this.states[key].make=null;this.states[key].camera=null;this.states[key].cache=null;this.states[key].input=null;this.states[key].load=null;this.states[key].math=null;this.states[key].sound=null;this.states[key].scale=null;this.states[key].state=null;this.states[key].stage=null;this.states[key].time=null;this.states[key].tweens=null;this.states[key].world=null;this.states[key].particles=null;this.states[key].rnd=null;this.states[key].physics=null
}},setCurrentState:function(key){this.callbackContext=this.states[key];this.link(key);this.onInitCallback=this.states[key]["init"]||this.dummy;this.onPreloadCallback=this.states[key]["preload"]||null;this.onLoadRenderCallback=this.states[key]["loadRender"]||null;this.onLoadUpdateCallback=this.states[key]["loadUpdate"]||null;this.onCreateCallback=this.states[key]["create"]||null;this.onUpdateCallback=this.states[key]["update"]||null;this.onPreRenderCallback=this.states[key]["preRender"]||null;this.onRenderCallback=this.states[key]["render"]||null;this.onResizeCallback=this.states[key]["resize"]||null;this.onPausedCallback=this.states[key]["paused"]||null;this.onResumedCallback=this.states[key]["resumed"]||null;this.onPauseUpdateCallback=this.states[key]["pauseUpdate"]||null;this.onShutDownCallback=this.states[key]["shutdown"]||this.dummy;if(this.current!==""){this.game.physics.reset()}this.current=key;this._created=false;this.onInitCallback.apply(this.callbackContext,this._args);if(key===this._pendingState){this._args=[]}this.game._kickstart=true},getCurrentState:function(){return this.states[this.current]},loadComplete:function(){if(this._created===false&&this.onCreateCallback){this._created=true;this.onCreateCallback.call(this.callbackContext,this.game)}else{this._created=true}},pause:function(){if(this._created&&this.onPausedCallback){this.onPausedCallback.call(this.callbackContext,this.game)}},resume:function(){if(this._created&&this.onResumedCallback){this.onResumedCallback.call(this.callbackContext,this.game)}},update:function(){if(this._created&&this.onUpdateCallback){this.onUpdateCallback.call(this.callbackContext,this.game)}else{if(this.onLoadUpdateCallback){this.onLoadUpdateCallback.call(this.callbackContext,this.game)}}},pauseUpdate:function(){if(this._created&&this.onPauseUpdateCallback){this.onPauseUpdateCallback.call(this.callbackContext,this.game)}else{if(this.onLoadUpdateCallback){this.onLoadUpdateCallback.call(this.callbackContext,this.game)}}},preRender:function(elapsedTime){if(this.onPreRenderCallback){this.onPreRenderCallback.call(this.callbackContext,this.game,elapsedTime)}},resize:function(width,height){if(this.onResizeCallback){this.onResizeCallback.call(this.callbackContext,width,height)}},render:function(){if(this._created&&this.onRenderCallback){if(this.game.renderType===Phaser.CANVAS){this.game.context.save();this.game.context.setTransform(1,0,0,1,0,0);this.onRenderCallback.call(this.callbackContext,this.game);this.game.context.restore()}else{this.onRenderCallback.call(this.callbackContext,this.game)}}else{if(this.onLoadRenderCallback){this.onLoadRenderCallback.call(this.callbackContext,this.game)}}},destroy:function(){this.clearCurrentState();this.callbackContext=null;this.onInitCallback=null;this.onShutDownCallback=null;this.onPreloadCallback=null;this.onLoadRenderCallback=null;this.onLoadUpdateCallback=null;this.onCreateCallback=null;this.onUpdateCallback=null;this.onRenderCallback=null;this.onPausedCallback=null;this.onResumedCallback=null;this.onPauseUpdateCallback=null;this.game=null;this.states={};this._pendingState=null;this.current=""}};Phaser.StateManager.prototype.constructor=Phaser.StateManager;Phaser.Signal=function(){};Phaser.Signal.prototype={_bindings:null,_prevParams:null,memorize:false,_shouldPropagate:true,active:true,_boundDispatch:true,validateListener:function(listener,fnName){if(typeof listener!=="function"){throw new Error("Phaser.Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",fnName))}},_registerListener:function(listener,isOnce,listenerContext,priority){var prevIndex=this._indexOfListener(listener,listenerContext);var binding;if(prevIndex!==-1){binding=this._bindings[prevIndex];if(binding.isOnce()!==isOnce){throw new Error("You cannot add"+(isOnce?"":"Once")+"() then add"+(!isOnce?"":"Once")+"() the same listener without removing the relationship first.")}}else{binding=new Phaser.SignalBinding(this,listener,isOnce,listenerContext,priority);this._addBinding(binding)}if(this.memorize&&this._prevParams){binding.execute(this._prevParams)}return binding},_addBinding:function(binding){if(!this._bindings){this._bindings=[]}var n=this._bindings.length;do{n--}while(this._bindings[n]&&binding._priority<=this._bindings[n]._priority);this._bindings.splice(n+1,0,binding)},_indexOfListener:function(listener,context){if(!this._bindings){return-1}if(typeof context==="undefined"){context=null}var n=this._bindings.length;var cur;while(n--){cur=this._bindings[n];if(cur._listener===listener&&cur.context===context){return n}}return-1},has:function(listener,context){return this._indexOfListener(listener,context)!==-1},add:function(listener,listenerContext,priority){this.validateListener(listener,"add");return this._registerListener(listener,false,listenerContext,priority)},addOnce:function(listener,listenerContext,priority){this.validateListener(listener,"addOnce");return this._registerListener(listener,true,listenerContext,priority)},remove:function(listener,context){this.validateListener(listener,"remove");var i=this._indexOfListener(listener,context);if(i!==-1){this._bindings[i]._destroy();this._bindings.splice(i,1)}return listener},removeAll:function(context){if(typeof context==="undefined"){context=null}if(!this._bindings){return}var n=this._bindings.length;while(n--){if(context){if(this._bindings[n].context===context){this._bindings[n]._destroy();this._bindings.splice(n,1)}}else{this._bindings[n]._destroy()}}if(!context){this._bindings.length=0}},getNumListeners:function(){return this._bindings?this._bindings.length:0},halt:function(){this._shouldPropagate=false},dispatch:function(){if(!this.active||!this._bindings){return}var paramsArr=Array.prototype.slice.call(arguments);var n=this._bindings.length;var bindings;if(this.memorize){this._prevParams=paramsArr}if(!n){return}bindings=this._bindings.slice();this._shouldPropagate=true;do{n--}while(bindings[n]&&this._shouldPropagate&&bindings[n].execute(paramsArr)!==false)},forget:function(){if(this._prevParams){this._prevParams=null}},dispose:function(){this.removeAll();this._bindings=null;if(this._prevParams){this._prevParams=null}},toString:function(){return"[Phaser.Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};Object.defineProperty(Phaser.Signal.prototype,"boundDispatch",{get:function(){var _this=this;return this._boundDispatch||(this._boundDispatch=function(){return _this.dispatch.apply(_this,arguments)})}});Phaser.Signal.prototype.constructor=Phaser.Signal;Phaser.SignalBinding=function(signal,listener,isOnce,listenerContext,priority){this._listener=listener;if(isOnce){this._isOnce=true}if(listenerContext!=null){this.context=listenerContext}this._signal=signal;if(priority){this._priority=priority}};Phaser.SignalBinding.prototype={context:null,_isOnce:false,_priority:0,callCount:0,active:true,params:null,execute:function(paramsArr){var handlerReturn,params;if(this.active&&!!this._listener){params=this.params?this.params.concat(paramsArr):paramsArr;handlerReturn=this._listener.apply(this.context,params);this.callCount++;if(this._isOnce){this.detach()}}return handlerReturn},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal;delete this._listener;delete this.context},toString:function(){return"[Phaser.SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}};Phaser.SignalBinding.prototype.constructor=Phaser.SignalBinding;Phaser.Filter=function(game,uniforms,fragmentSrc){this.game=game;this.type=Phaser.WEBGL_FILTER;this.passes=[this];this.shaders=[];this.dirty=true;this.padding=0;this.prevPoint=new Phaser.Point;var d=new Date;this.uniforms={resolution:{type:"2f",value:{x:256,y:256}},time:{type:"1f",value:0},mouse:{type:"2f",value:{x:0,y:0}},date:{type:"4fv",value:[d.getFullYear(),d.getMonth(),d.getDate(),d.getHours()*60*60+d.getMinutes()*60+d.getSeconds()]},sampleRate:{type:"1f",value:44100},iChannel0:{type:"sampler2D",value:null,textureData:{repeat:true}},iChannel1:{type:"sampler2D",value:null,textureData:{repeat:true}},iChannel2:{type:"sampler2D",value:null,textureData:{repeat:true}},iChannel3:{type:"sampler2D",value:null,textureData:{repeat:true}}};if(uniforms){for(var key in uniforms){this.uniforms[key]=uniforms[key]}}this.fragmentSrc=fragmentSrc||[]};Phaser.Filter.prototype={init:function(){},setResolution:function(width,height){this.uniforms.resolution.value.x=width;this.uniforms.resolution.value.y=height},update:function(pointer){if(typeof pointer!=="undefined"){var x=pointer.x/this.game.width;var y=1-pointer.y/this.game.height;if(x!==this.prevPoint.x||y!==this.prevPoint.y){this.uniforms.mouse.value.x=x.toFixed(2);this.uniforms.mouse.value.y=y.toFixed(2);this.prevPoint.set(x,y)}}this.uniforms.time.value=this.game.time.totalElapsedSeconds()},destroy:function(){this.game=null}};Phaser.Filter.prototype.constructor=Phaser.Filter;Object.defineProperty(Phaser.Filter.prototype,"width",{get:function(){return this.uniforms.resolution.value.x},set:function(value){this.uniforms.resolution.value.x=value}});Object.defineProperty(Phaser.Filter.prototype,"height",{get:function(){return this.uniforms.resolution.value.y},set:function(value){this.uniforms.resolution.value.y=value}});Phaser.Plugin=function(game,parent){if(typeof parent==="undefined"){parent=null}this.game=game;this.parent=parent;this.active=false;this.visible=false;this.hasPreUpdate=false;this.hasUpdate=false;this.hasPostUpdate=false;this.hasRender=false;this.hasPostRender=false};Phaser.Plugin.prototype={preUpdate:function(){},update:function(){},render:function(){},postRender:function(){},destroy:function(){this.game=null;this.parent=null;this.active=false;this.visible=false}};Phaser.Plugin.prototype.constructor=Phaser.Plugin;Phaser.PluginManager=function(game){this.game=game;this.plugins=[];this._len=0;this._i=0};Phaser.PluginManager.prototype={add:function(plugin){var args=Array.prototype.splice.call(arguments,1);var result=false;if(typeof plugin==="function"){plugin=new plugin(this.game,this)}else{plugin.game=this.game;plugin.parent=this}if(typeof plugin["preUpdate"]==="function"){plugin.hasPreUpdate=true;result=true}if(typeof plugin["update"]==="function"){plugin.hasUpdate=true;result=true}if(typeof plugin["postUpdate"]==="function"){plugin.hasPostUpdate=true;result=true}if(typeof plugin["render"]==="function"){plugin.hasRender=true;result=true}if(typeof plugin["postRender"]==="function"){plugin.hasPostRender=true;result=true}if(result){if(plugin.hasPreUpdate||plugin.hasUpdate||plugin.hasPostUpdate){plugin.active=true}if(plugin.hasRender||plugin.hasPostRender){plugin.visible=true}this._len=this.plugins.push(plugin);if(typeof plugin["init"]==="function"){plugin.init.apply(plugin,args)}return plugin}else{return null}},remove:function(plugin){this._i=this._len;while(this._i--){if(this.plugins[this._i]===plugin){plugin.destroy();this.plugins.splice(this._i,1);this._len--;return}}},removeAll:function(){this._i=this._len;while(this._i--){this.plugins[this._i].destroy()}this.plugins.length=0;this._len=0},preUpdate:function(){this._i=this._len;while(this._i--){if(this.plugins[this._i].active&&this.plugins[this._i].hasPreUpdate){this.plugins[this._i].preUpdate()}}},update:function(){this._i=this._len;while(this._i--){if(this.plugins[this._i].active&&this.plugins[this._i].hasUpdate){this.plugins[this._i].update()}}},postUpdate:function(){this._i=this._len;while(this._i--){if(this.plugins[this._i].active&&this.plugins[this._i].hasPostUpdate){this.plugins[this._i].postUpdate()}}},render:function(){this._i=this._len;while(this._i--){if(this.plugins[this._i].visible&&this.plugins[this._i].hasRender){this.plugins[this._i].render()}}},postRender:function(){this._i=this._len;while(this._i--){if(this.plugins[this._i].visible&&this.plugins[this._i].hasPostRender){this.plugins[this._i].postRender()}}},destroy:function(){this.removeAll();this.game=null}};Phaser.PluginManager.prototype.constructor=Phaser.PluginManager;Phaser.Stage=function(game){this.game=game;PIXI.Stage.call(this,0);this.name="_stage_root";this.disableVisibilityChange=false;this.exists=true;this.currentRenderOrderID=0;this._hiddenVar="hidden";this._onChange=null;this._backgroundColor=0;if(game.config){this.parseConfig(game.config)}};Phaser.Stage.prototype=Object.create(PIXI.Stage.prototype);Phaser.Stage.prototype.constructor=Phaser.Stage;Phaser.Stage.prototype.parseConfig=function(config){if(config["disableVisibilityChange"]){this.disableVisibilityChange=config["disableVisibilityChange"]}if(config["backgroundColor"]){this.backgroundColor=config["backgroundColor"]}};Phaser.Stage.prototype.boot=function(){Phaser.DOM.getOffset(this.game.canvas,this.offset);Phaser.Canvas.setUserSelect(this.game.canvas,"none");Phaser.Canvas.setTouchAction(this.game.canvas,"none");this.checkVisibility()};Phaser.Stage.prototype.preUpdate=function(){this.currentRenderOrderID=0;for(var i=0;i<this.children.length;i++){this.children[i].preUpdate()}};Phaser.Stage.prototype.update=function(){var i=this.children.length;while(i--){this.children[i].update()}};Phaser.Stage.prototype.postUpdate=function(){if(this.game.world.camera.target){this.game.world.camera.target.postUpdate();this.game.world.camera.update();var i=this.children.length;while(i--){if(this.children[i]!==this.game.world.camera.target){this.children[i].postUpdate()}}}else{this.game.world.camera.update();var i=this.children.length;while(i--){this.children[i].postUpdate()}}};Phaser.Stage.prototype.updateTransform=function(){this.worldAlpha=1;for(var i=0;i<this.children.length;i++){this.children[i].updateTransform()}};Phaser.Stage.prototype.checkVisibility=function(){if(document.webkitHidden!==undefined){this._hiddenVar="webkitvisibilitychange"}else if(document.mozHidden!==undefined){this._hiddenVar="mozvisibilitychange"}else if(document.msHidden!==undefined){this._hiddenVar="msvisibilitychange"}else if(document.hidden!==undefined){this._hiddenVar="visibilitychange"}else{this._hiddenVar=null}var _this=this;this._onChange=function(event){return _this.visibilityChange(event)};if(this._hiddenVar){document.addEventListener(this._hiddenVar,this._onChange,false)}window.onblur=this._onChange;window.onfocus=this._onChange;window.onpagehide=this._onChange;window.onpageshow=this._onChange;if(this.game.device.cocoonJSApp){CocoonJS.App.onSuspended.addEventListener(function(){Phaser.Stage.prototype.visibilityChange.call(_this,{type:"pause"})});CocoonJS.App.onActivated.addEventListener(function(){Phaser.Stage.prototype.visibilityChange.call(_this,{type:"resume"})})}};Phaser.Stage.prototype.visibilityChange=function(event){if(event.type==="pagehide"||event.type==="blur"||event.type==="pageshow"||event.type==="focus"){if(event.type==="pagehide"||event.type==="blur"){this.game.focusLoss(event)}else if(event.type==="pageshow"||event.type==="focus"){this.game.focusGain(event)}return}if(this.disableVisibilityChange){return}if(document.hidden||document.mozHidden||document.msHidden||document.webkitHidden||event.type==="pause"){this.game.gamePaused(event)}else{this.game.gameResumed(event)}};Phaser.Stage.prototype.setBackgroundColor=function(backgroundColor){var rgb=Phaser.Color.valueToColor(backgroundColor);this._backgroundColor=Phaser.Color.getColor(rgb.r,rgb.g,rgb.b);this.backgroundColorSplit=[rgb.r/255,rgb.g/255,rgb.b/255];this.backgroundColorString=Phaser.Color.RGBtoString(rgb.r,rgb.g,rgb.b,255,"#")};Phaser.Stage.prototype.destroy=function(){if(this._hiddenVar){document.removeEventListener(this._hiddenVar,this._onChange,false)}window.onpagehide=null;window.onpageshow=null;window.onblur=null;window.onfocus=null};Object.defineProperty(Phaser.Stage.prototype,"backgroundColor",{get:function(){return this._backgroundColor},set:function(color){if(!this.game.transparent){this.setBackgroundColor(color)}}});Object.defineProperty(Phaser.Stage.prototype,"smoothed",{get:function(){return PIXI.scaleModes.DEFAULT===PIXI.scaleModes.LINEAR},set:function(value){if(value){PIXI.scaleModes.DEFAULT=PIXI.scaleModes.LINEAR}else{PIXI.scaleModes.DEFAULT=PIXI.scaleModes.NEAREST}}});Phaser.Group=function(game,parent,name,addToStage,enableBody,physicsBodyType){if(typeof addToStage==="undefined"){addToStage=false}if(typeof enableBody==="undefined"){enableBody=false}if(typeof physicsBodyType==="undefined"){physicsBodyType=Phaser.Physics.ARCADE}this.game=game;if(typeof parent==="undefined"){parent=game.world}this.name=name||"group";this.z=0;PIXI.DisplayObjectContainer.call(this);if(addToStage){this.game.stage.addChild(this);this.z=this.game.stage.children.length}else{if(parent){parent.addChild(this);this.z=parent.children.length}}this.type=Phaser.GROUP;this.physicsType=Phaser.GROUP;this.alive=true;this.exists=true;this.ignoreDestroy=false;this.classType=Phaser.Sprite;this.scale=new Phaser.Point(1,1);this.cursor=null;this.enableBody=enableBody;this.enableBodyDebug=false;this.physicsBodyType=physicsBodyType;this.onDestroy=new Phaser.Signal;this.cursorIndex=0;this.fixedToCamera=false;this.cameraOffset=new Phaser.Point;this._hash=[];this._sortProperty="z"};Phaser.Group.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);Phaser.Group.prototype.constructor=Phaser.Group;Phaser.Group.RETURN_NONE=0;Phaser.Group.RETURN_TOTAL=1;Phaser.Group.RETURN_CHILD=2;Phaser.Group.SORT_ASCENDING=-1;Phaser.Group.SORT_DESCENDING=1;Phaser.Group.prototype.add=function(child,silent){if(typeof silent==="undefined"){silent=false}if(child.parent!==this){if(this.enableBody){this.game.physics.enable(child,this.physicsBodyType)}this.addChild(child);this._hash.push(child);child.z=this.children.length;if(!silent&&child.events){child.events.onAddedToGroup$dispatch(child,this)}if(this.cursor===null){this.cursor=child}}return child};Phaser.Group.prototype.addMultiple=function(children,silent){if(Array.isArray(children)){for(var i=0;i<children.length;i++){this.add(children[i],silent)}}return children};Phaser.Group.prototype.addAt=function(child,index,silent){if(typeof silent==="undefined"){silent=false}if(child.parent!==this){if(this.enableBody){this.game.physics.enable(child,this.physicsBodyType)}this.addChildAt(child,index);this._hash.push(child);this.updateZ();if(!silent&&child.events){child.events.onAddedToGroup$dispatch(child,this)}if(this.cursor===null){this.cursor=child}}return child};Phaser.Group.prototype.getAt=function(index){if(index<0||index>=this.children.length){return-1}else{return this.getChildAt(index)}};Phaser.Group.prototype.create=function(x,y,key,frame,exists){if(typeof exists==="undefined"){exists=true}var child=new this.classType(this.game,x,y,key,frame);if(this.enableBody){this.game.physics.enable(child,this.physicsBodyType,this.enableBodyDebug)}child.exists=exists;child.visible=exists;child.alive=exists;this.addChild(child);this._hash.push(child);child.z=this.children.length;if(child.events){child.events.onAddedToGroup$dispatch(child,this)}if(this.cursor===null){this.cursor=child}return child};Phaser.Group.prototype.createMultiple=function(quantity,key,frame,exists){if(typeof exists==="undefined"){exists=false}for(var i=0;i<quantity;i++){this.create(0,0,key,frame,exists)}};Phaser.Group.prototype.updateZ=function(){var i=this.children.length;while(i--){this.children[i].z=i}};Phaser.Group.prototype.resetCursor=function(index){if(typeof index==="undefined"){index=0}if(index>this.children.length-1){index=0}if(this.cursor){this.cursorIndex=index;this.cursor=this.children[this.cursorIndex];return this.cursor}};Phaser.Group.prototype.next=function(){if(this.cursor){if(this.cursorIndex>=this.children.length-1){this.cursorIndex=0}else{this.cursorIndex++}this.cursor=this.children[this.cursorIndex];return this.cursor}};Phaser.Group.prototype.previous=function(){if(this.cursor){if(this.cursorIndex===0){this.cursorIndex=this.children.length-1}else{this.cursorIndex--}this.cursor=this.children[this.cursorIndex];return this.cursor}};Phaser.Group.prototype.swap=function(child1,child2){this.swapChildren(child1,child2);this.updateZ()};Phaser.Group.prototype.bringToTop=function(child){if(child.parent===this&&this.getIndex(child)<this.children.length){this.remove(child,false,true);this.add(child,true)}return child};Phaser.Group.prototype.sendToBack=function(child){if(child.parent===this&&this.getIndex(child)>0){this.remove(child,false,true);this.addAt(child,0,true)}return child};Phaser.Group.prototype.moveUp=function(child){if(child.parent===this&&this.getIndex(child)<this.children.length-1){var a=this.getIndex(child);var b=this.getAt(a+1);if(b){this.swap(child,b)}}return child};Phaser.Group.prototype.moveDown=function(child){if(child.parent===this&&this.getIndex(child)>0){var a=this.getIndex(child);var b=this.getAt(a-1);if(b){this.swap(child,b)}}return child};Phaser.Group.prototype.xy=function(index,x,y){if(index<0||index>this.children.length){return-1}else{this.getChildAt(index).x=x;this.getChildAt(index).y=y}};Phaser.Group.prototype.reverse=function(){this.children.reverse();this.updateZ()};Phaser.Group.prototype.getIndex=function(child){return this.children.indexOf(child)};Phaser.Group.prototype.replace=function(oldChild,newChild){var index=this.getIndex(oldChild);if(index!==-1){if(newChild.parent){if(newChild.parent instanceof Phaser.Group){newChild.parent.remove(newChild)}else{newChild.parent.removeChild(newChild)}}this.remove(oldChild);this.addAt(newChild,index);return oldChild}};Phaser.Group.prototype.hasProperty=function(child,key){var len=key.length;if(len===1&&key[0]in child){return true}else if(len===2&&key[0]in child&&key[1]in child[key[0]]){return true}else if(len===3&&key[0]in child&&key[1]in child[key[0]]&&key[2]in child[key[0]][key[1]]){return true}else if(len===4&&key[0]in child&&key[1]in child[key[0]]&&key[2]in child[key[0]][key[1]]&&key[3]in child[key[0]][key[1]][key[2]]){return true}return false};Phaser.Group.prototype.setProperty=function(child,key,value,operation,force){if(typeof force==="undefined"){force=false}operation=operation||0;if(!this.hasProperty(child,key)&&(!force||operation>0)){return false}var len=key.length;if(len===1){if(operation===0){child[key[0]]=value}else if(operation==1){child[key[0]]+=value}else if(operation==2){child[key[0]]-=value}else if(operation==3){child[key[0]]*=value}else if(operation==4){child[key[0]]/=value}}else if(len===2){if(operation===0){child[key[0]][key[1]]=value}else if(operation==1){child[key[0]][key[1]]+=value}else if(operation==2){child[key[0]][key[1]]-=value}else if(operation==3){child[key[0]][key[1]]*=value}else if(operation==4){child[key[0]][key[1]]/=value}}else if(len===3){if(operation===0){child[key[0]][key[1]][key[2]]=value}else if(operation==1){child[key[0]][key[1]][key[2]]+=value}else if(operation==2){child[key[0]][key[1]][key[2]]-=value}else if(operation==3){child[key[0]][key[1]][key[2]]*=value}else if(operation==4){child[key[0]][key[1]][key[2]]/=value}}else if(len===4){if(operation===0){child[key[0]][key[1]][key[2]][key[3]]=value}else if(operation==1){child[key[0]][key[1]][key[2]][key[3]]+=value}else if(operation==2){child[key[0]][key[1]][key[2]][key[3]]-=value}else if(operation==3){child[key[0]][key[1]][key[2]][key[3]]*=value}else if(operation==4){child[key[0]][key[1]][key[2]][key[3]]/=value}}return true};Phaser.Group.prototype.checkProperty=function(child,key,value,force){if(typeof force==="undefined"){force=false}if(!Phaser.Utils.getProperty(child,key)&&force){return false}if(Phaser.Utils.getProperty(child,key)!==value){return false}return true};Phaser.Group.prototype.set=function(child,key,value,checkAlive,checkVisible,operation,force){if(typeof force==="undefined"){force=false}key=key.split(".");if(typeof checkAlive==="undefined"){checkAlive=false}if(typeof checkVisible==="undefined"){checkVisible=false}if((checkAlive===false||checkAlive&&child.alive)&&(checkVisible===false||checkVisible&&child.visible)){return this.setProperty(child,key,value,operation,force)}};Phaser.Group.prototype.setAll=function(key,value,checkAlive,checkVisible,operation,force){if(typeof checkAlive==="undefined"){checkAlive=false}if(typeof checkVisible==="undefined"){checkVisible=false}if(typeof force==="undefined"){force=false}key=key.split(".");operation=operation||0;for(var i=0;i<this.children.length;i++){if((!checkAlive||checkAlive&&this.children[i].alive)&&(!checkVisible||checkVisible&&this.children[i].visible)){this.setProperty(this.children[i],key,value,operation,force)}}};Phaser.Group.prototype.setAllChildren=function(key,value,checkAlive,checkVisible,operation,force){if(typeof checkAlive==="undefined"){checkAlive=false}if(typeof checkVisible==="undefined"){checkVisible=false}if(typeof force==="undefined"){force=false}operation=operation||0;for(var i=0;i<this.children.length;i++){if((!checkAlive||checkAlive&&this.children[i].alive)&&(!checkVisible||checkVisible&&this.children[i].visible)){if(this.children[i]instanceof Phaser.Group){this.children[i].setAllChildren(key,value,checkAlive,checkVisible,operation,force)}else{this.setProperty(this.children[i],key.split("."),value,operation,force)}}}};Phaser.Group.prototype.checkAll=function(key,value,checkAlive,checkVisible,force){if(typeof checkAlive==="undefined"){checkAlive=false}if(typeof checkVisible==="undefined"){checkVisible=false}if(typeof force==="undefined"){force=false}for(var i=0;i<this.children.length;i++){if((!checkAlive||checkAlive&&this.children[i].alive)&&(!checkVisible||checkVisible&&this.children[i].visible)){if(!this.checkProperty(this.children[i],key,value,force)){return false}}}return true};Phaser.Group.prototype.addAll=function(property,amount,checkAlive,checkVisible){this.setAll(property,amount,checkAlive,checkVisible,1)};Phaser.Group.prototype.subAll=function(property,amount,checkAlive,checkVisible){this.setAll(property,amount,checkAlive,checkVisible,2)};Phaser.Group.prototype.multiplyAll=function(property,amount,checkAlive,checkVisible){this.setAll(property,amount,checkAlive,checkVisible,3)};Phaser.Group.prototype.divideAll=function(property,amount,checkAlive,checkVisible){this.setAll(property,amount,checkAlive,checkVisible,4)};Phaser.Group.prototype.callAllExists=function(callback,existsValue){var args;if(arguments.length>2){args=[];for(var i=2;i<arguments.length;i++){args.push(arguments[i])}}for(var i=0;i<this.children.length;i++){if(this.children[i].exists===existsValue&&this.children[i][callback]){this.children[i][callback].apply(this.children[i],args)}}};Phaser.Group.prototype.callbackFromArray=function(child,callback,length){if(length==1){if(child[callback[0]]){return child[callback[0]]}}else if(length==2){if(child[callback[0]][callback[1]]){return child[callback[0]][callback[1]]}}else if(length==3){if(child[callback[0]][callback[1]][callback[2]]){return child[callback[0]][callback[1]][callback[2]]}}else if(length==4){if(child[callback[0]][callback[1]][callback[2]][callback[3]]){return child[callback[0]][callback[1]][callback[2]][callback[3]]}}else{if(child[callback]){return child[callback]}}return false};Phaser.Group.prototype.callAll=function(method,context){if(typeof method==="undefined"){return}method=method.split(".");var methodLength=method.length;if(typeof context==="undefined"||context===null||context===""){context=null}else{if(typeof context==="string"){context=context.split(".");var contextLength=context.length}}var args;if(arguments.length>2){args=[];for(var i=2;i<arguments.length;i++){args.push(arguments[i])}}var callback=null;var callbackContext=null;for(var i=0;i<this.children.length;i++){callback=this.callbackFromArray(this.children[i],method,methodLength);if(context&&callback){callbackContext=this.callbackFromArray(this.children[i],context,contextLength);if(callback){callback.apply(callbackContext,args)}}else if(callback){callback.apply(this.children[i],args)}}};Phaser.Group.prototype.preUpdate=function(){if(!this.exists||!this.parent.exists){this.renderOrderID=-1;return false}var i=this.children.length;while(i--){this.children[i].preUpdate()}return true};Phaser.Group.prototype.update=function(){var i=this.children.length;while(i--){this.children[i].update()}};Phaser.Group.prototype.postUpdate=function(){if(this.fixedToCamera){this.x=this.game.camera.view.x+this.cameraOffset.x;this.y=this.game.camera.view.y+this.cameraOffset.y}var i=this.children.length;while(i--){this.children[i].postUpdate()}};Phaser.Group.prototype.filter=function(predicate,checkExists){var index=-1;var length=this.children.length;var results=[];while(++index<length){var child=this.children[index];if(!checkExists||checkExists&&child.exists){if(predicate(child,index,this.children)){results.push(child)}}}return new Phaser.ArraySet(results)};Phaser.Group.prototype.forEach=function(callback,callbackContext,checkExists){if(typeof checkExists==="undefined"){checkExists=false}if(arguments.length<=3){for(var i=0;i<this.children.length;i++){if(!checkExists||checkExists&&this.children[i].exists){callback.call(callbackContext,this.children[i])}}}else{var args=[null];for(var i=3;i<arguments.length;i++){args.push(arguments[i])}for(var i=0;i<this.children.length;i++){if(!checkExists||checkExists&&this.children[i].exists){args[0]=this.children[i];callback.apply(callbackContext,args)}}}};Phaser.Group.prototype.forEachExists=function(callback,callbackContext){var args;if(arguments.length>2){args=[null];for(var i=2;i<arguments.length;i++){args.push(arguments[i])}}this.iterate("exists",true,Phaser.Group.RETURN_TOTAL,callback,callbackContext,args)};Phaser.Group.prototype.forEachAlive=function(callback,callbackContext){var args;if(arguments.length>2){args=[null];for(var i=2;i<arguments.length;i++){args.push(arguments[i])}}this.iterate("alive",true,Phaser.Group.RETURN_TOTAL,callback,callbackContext,args)};Phaser.Group.prototype.forEachDead=function(callback,callbackContext){var args;if(arguments.length>2){args=[null];for(var i=2;i<arguments.length;i++){args.push(arguments[i])}}this.iterate("alive",false,Phaser.Group.RETURN_TOTAL,callback,callbackContext,args)};Phaser.Group.prototype.sort=function(key,order){if(this.children.length<2){return}if(typeof key==="undefined"){key="z"}if(typeof order==="undefined"){order=Phaser.Group.SORT_ASCENDING}this._sortProperty=key;if(order===Phaser.Group.SORT_ASCENDING){this.children.sort(this.ascendingSortHandler.bind(this))}else{this.children.sort(this.descendingSortHandler.bind(this))}this.updateZ()};Phaser.Group.prototype.customSort=function(sortHandler,context){if(this.children.length<2){return}this.children.sort(sortHandler.bind(context));this.updateZ()};Phaser.Group.prototype.ascendingSortHandler=function(a,b){if(a[this._sortProperty]<b[this._sortProperty]){return-1}else if(a[this._sortProperty]>b[this._sortProperty]){return 1}else{if(a.z<b.z){return-1}else{return 1}}};Phaser.Group.prototype.descendingSortHandler=function(a,b){if(a[this._sortProperty]<b[this._sortProperty]){return 1}else if(a[this._sortProperty]>b[this._sortProperty]){return-1}else{return 0}};Phaser.Group.prototype.iterate=function(key,value,returnType,callback,callbackContext,args){if(returnType===Phaser.Group.RETURN_TOTAL&&this.children.length===0){return 0}var total=0;for(var i=0;i<this.children.length;i++){if(this.children[i][key]===value){total++;if(callback){if(args){args[0]=this.children[i];callback.apply(callbackContext,args)}else{callback.call(callbackContext,this.children[i])}}if(returnType===Phaser.Group.RETURN_CHILD){return this.children[i]}}}if(returnType===Phaser.Group.RETURN_TOTAL){return total}return null};Phaser.Group.prototype.getFirstExists=function(exists){if(typeof exists!=="boolean"){exists=true}return this.iterate("exists",exists,Phaser.Group.RETURN_CHILD)};Phaser.Group.prototype.getFirstAlive=function(){return this.iterate("alive",true,Phaser.Group.RETURN_CHILD)};Phaser.Group.prototype.getFirstDead=function(){return this.iterate("alive",false,Phaser.Group.RETURN_CHILD)
};Phaser.Group.prototype.getTop=function(){if(this.children.length>0){return this.children[this.children.length-1]}};Phaser.Group.prototype.getBottom=function(){if(this.children.length>0){return this.children[0]}};Phaser.Group.prototype.countLiving=function(){return this.iterate("alive",true,Phaser.Group.RETURN_TOTAL)};Phaser.Group.prototype.countDead=function(){return this.iterate("alive",false,Phaser.Group.RETURN_TOTAL)};Phaser.Group.prototype.getRandom=function(startIndex,length){if(this.children.length===0){return null}startIndex=startIndex||0;length=length||this.children.length;return Phaser.ArrayUtils.getRandomItem(this.children,startIndex,length)};Phaser.Group.prototype.remove=function(child,destroy,silent){if(typeof destroy==="undefined"){destroy=false}if(typeof silent==="undefined"){silent=false}if(this.children.length===0||this.children.indexOf(child)===-1){return false}if(!silent&&child.events&&!child.destroyPhase){child.events.onRemovedFromGroup$dispatch(child,this)}var removed=this.removeChild(child);var index=this._hash.indexOf(removed);if(index!==-1){this._hash.splice(index,1)}this.updateZ();if(this.cursor===child){this.next()}if(destroy&&removed){removed.destroy(true)}return true};Phaser.Group.prototype.removeAll=function(destroy,silent){if(typeof destroy==="undefined"){destroy=false}if(typeof silent==="undefined"){silent=false}if(this.children.length===0){return}do{if(!silent&&this.children[0].events){this.children[0].events.onRemovedFromGroup$dispatch(this.children[0],this)}var removed=this.removeChild(this.children[0]);var index=this._hash.indexOf(removed);if(index!==-1){this._hash.splice(index,1)}if(destroy&&removed){removed.destroy(true)}}while(this.children.length>0);this._hash=[];this.cursor=null};Phaser.Group.prototype.removeBetween=function(startIndex,endIndex,destroy,silent){if(typeof endIndex==="undefined"){endIndex=this.children.length-1}if(typeof destroy==="undefined"){destroy=false}if(typeof silent==="undefined"){silent=false}if(this.children.length===0){return}if(startIndex>endIndex||startIndex<0||endIndex>this.children.length){return false}var i=endIndex;while(i>=startIndex){if(!silent&&this.children[i].events){this.children[i].events.onRemovedFromGroup$dispatch(this.children[i],this)}var removed=this.removeChild(this.children[i]);var index=this._hash.indexOf(removed);if(index!==-1){this._hash.splice(index,1)}if(destroy&&removed){removed.destroy(true)}if(this.cursor===this.children[i]){this.cursor=null}i--}this.updateZ()};Phaser.Group.prototype.destroy=function(destroyChildren,soft){if(this.game===null||this.ignoreDestroy){return}if(typeof destroyChildren==="undefined"){destroyChildren=true}if(typeof soft==="undefined"){soft=false}this.onDestroy.dispatch(this,destroyChildren,soft);this.removeAll(destroyChildren);this.cursor=null;this.filters=null;if(!soft){if(this.parent){this.parent.removeChild(this)}this.game=null;this.exists=false}};Object.defineProperty(Phaser.Group.prototype,"total",{get:function(){return this.iterate("exists",true,Phaser.Group.RETURN_TOTAL)}});Object.defineProperty(Phaser.Group.prototype,"length",{get:function(){return this.children.length}});Object.defineProperty(Phaser.Group.prototype,"angle",{get:function(){return Phaser.Math.radToDeg(this.rotation)},set:function(value){this.rotation=Phaser.Math.degToRad(value)}});Phaser.World=function(game){Phaser.Group.call(this,game,null,"__world",false);this.bounds=new Phaser.Rectangle(0,0,game.width,game.height);this.camera=null;this._definedSize=false;this._width=game.width;this._height=game.height};Phaser.World.prototype=Object.create(Phaser.Group.prototype);Phaser.World.prototype.constructor=Phaser.World;Phaser.World.prototype.boot=function(){this.camera=new Phaser.Camera(this.game,0,0,0,this.game.width,this.game.height);this.camera.displayObject=this;this.camera.scale=this.scale;this.game.camera=this.camera;this.game.stage.addChild(this)};Phaser.World.prototype.setBounds=function(x,y,width,height){this._definedSize=true;this._width=width;this._height=height;this.bounds.setTo(x,y,width,height);this.x=x;this.y=y;if(this.camera.bounds){this.camera.bounds.setTo(x,y,Math.max(width,this.game.width),Math.max(height,this.game.height))}this.game.physics.setBoundsToWorld()};Phaser.World.prototype.resize=function(width,height){if(this._definedSize){if(width<this._width){width=this._width}if(height<this._height){height=this._height}}this.bounds.width=width;this.bounds.height=height;this.game.camera.setBoundsToWorld();this.game.physics.setBoundsToWorld()};Phaser.World.prototype.shutdown=function(){this.destroy(true,true)};Phaser.World.prototype.wrap=function(sprite,padding,useBounds,horizontal,vertical){if(typeof padding==="undefined"){padding=0}if(typeof useBounds==="undefined"){useBounds=false}if(typeof horizontal==="undefined"){horizontal=true}if(typeof vertical==="undefined"){vertical=true}if(!useBounds){if(horizontal&&sprite.x+padding<this.bounds.x){sprite.x=this.bounds.right+padding}else if(horizontal&&sprite.x-padding>this.bounds.right){sprite.x=this.bounds.left-padding}if(vertical&&sprite.y+padding<this.bounds.top){sprite.y=this.bounds.bottom+padding}else if(vertical&&sprite.y-padding>this.bounds.bottom){sprite.y=this.bounds.top-padding}}else{sprite.getBounds();if(horizontal){if(sprite.x+sprite._currentBounds.width<this.bounds.x){sprite.x=this.bounds.right}else if(sprite.x>this.bounds.right){sprite.x=this.bounds.left}}if(vertical){if(sprite.y+sprite._currentBounds.height<this.bounds.top){sprite.y=this.bounds.bottom}else if(sprite.y>this.bounds.bottom){sprite.y=this.bounds.top}}}};Object.defineProperty(Phaser.World.prototype,"width",{get:function(){return this.bounds.width},set:function(value){if(value<this.game.width){value=this.game.width}this.bounds.width=value;this._width=value;this._definedSize=true}});Object.defineProperty(Phaser.World.prototype,"height",{get:function(){return this.bounds.height},set:function(value){if(value<this.game.height){value=this.game.height}this.bounds.height=value;this._height=value;this._definedSize=true}});Object.defineProperty(Phaser.World.prototype,"centerX",{get:function(){return this.bounds.halfWidth}});Object.defineProperty(Phaser.World.prototype,"centerY",{get:function(){return this.bounds.halfHeight}});Object.defineProperty(Phaser.World.prototype,"randomX",{get:function(){if(this.bounds.x<0){return this.game.rnd.integerInRange(this.bounds.x,this.bounds.width-Math.abs(this.bounds.x))}else{return this.game.rnd.integerInRange(this.bounds.x,this.bounds.width)}}});Object.defineProperty(Phaser.World.prototype,"randomY",{get:function(){if(this.bounds.y<0){return this.game.rnd.integerInRange(this.bounds.y,this.bounds.height-Math.abs(this.bounds.y))}else{return this.game.rnd.integerInRange(this.bounds.y,this.bounds.height)}}});Phaser.FlexGrid=function(manager,width,height){this.game=manager.game;this.manager=manager;this.width=width;this.height=height;this.boundsCustom=new Phaser.Rectangle(0,0,width,height);this.boundsFluid=new Phaser.Rectangle(0,0,width,height);this.boundsFull=new Phaser.Rectangle(0,0,width,height);this.boundsNone=new Phaser.Rectangle(0,0,width,height);this.positionCustom=new Phaser.Point(0,0);this.positionFluid=new Phaser.Point(0,0);this.positionFull=new Phaser.Point(0,0);this.positionNone=new Phaser.Point(0,0);this.scaleCustom=new Phaser.Point(1,1);this.scaleFluid=new Phaser.Point(1,1);this.scaleFluidInversed=new Phaser.Point(1,1);this.scaleFull=new Phaser.Point(1,1);this.scaleNone=new Phaser.Point(1,1);this.customWidth=0;this.customHeight=0;this.customOffsetX=0;this.customOffsetY=0;this.ratioH=width/height;this.ratioV=height/width;this.multiplier=0;this.layers=[]};Phaser.FlexGrid.prototype={setSize:function(width,height){this.width=width;this.height=height;this.ratioH=width/height;this.ratioV=height/width;this.scaleNone=new Phaser.Point(1,1);this.boundsNone.width=this.width;this.boundsNone.height=this.height;this.refresh()},createCustomLayer:function(width,height,children,addToWorld){if(typeof addToWorld==="undefined"){addToWorld=true}this.customWidth=width;this.customHeight=height;this.boundsCustom.width=width;this.boundsCustom.height=height;var layer=new Phaser.FlexLayer(this,this.positionCustom,this.boundsCustom,this.scaleCustom);if(addToWorld){this.game.world.add(layer)}this.layers.push(layer);if(typeof children!=="undefined"&&typeof children!==null){layer.addMultiple(children)}return layer},createFluidLayer:function(children,addToWorld){if(typeof addToWorld==="undefined"){addToWorld=true}var layer=new Phaser.FlexLayer(this,this.positionFluid,this.boundsFluid,this.scaleFluid);if(addToWorld){this.game.world.add(layer)}this.layers.push(layer);if(typeof children!=="undefined"&&typeof children!==null){layer.addMultiple(children)}return layer},createFullLayer:function(children){var layer=new Phaser.FlexLayer(this,this.positionFull,this.boundsFull,this.scaleFluid);this.game.world.add(layer);this.layers.push(layer);if(typeof children!=="undefined"){layer.addMultiple(children)}return layer},createFixedLayer:function(children){var layer=new Phaser.FlexLayer(this,this.positionNone,this.boundsNone,this.scaleNone);this.game.world.add(layer);this.layers.push(layer);if(typeof children!=="undefined"){layer.addMultiple(children)}return layer},reset:function(){var i=this.layers.length;while(i--){if(!this.layers[i].persist){this.layers[i].position=null;this.layers[i].scale=null;this.layers.slice(i,1)}}},onResize:function(width,height){this.ratioH=width/height;this.ratioV=height/width;this.refresh(width,height)},refresh:function(){this.multiplier=Math.min(this.manager.height/this.height,this.manager.width/this.width);this.boundsFluid.width=Math.round(this.width*this.multiplier);this.boundsFluid.height=Math.round(this.height*this.multiplier);this.scaleFluid.set(this.boundsFluid.width/this.width,this.boundsFluid.height/this.height);this.scaleFluidInversed.set(this.width/this.boundsFluid.width,this.height/this.boundsFluid.height);this.scaleFull.set(this.boundsFull.width/this.width,this.boundsFull.height/this.height);this.boundsFull.width=Math.round(this.manager.width*this.scaleFluidInversed.x);this.boundsFull.height=Math.round(this.manager.height*this.scaleFluidInversed.y);this.boundsFluid.centerOn(this.manager.bounds.centerX,this.manager.bounds.centerY);this.boundsNone.centerOn(this.manager.bounds.centerX,this.manager.bounds.centerY);this.positionFluid.set(this.boundsFluid.x,this.boundsFluid.y);this.positionNone.set(this.boundsNone.x,this.boundsNone.y)},fitSprite:function(sprite){this.manager.scaleSprite(sprite);sprite.x=this.manager.bounds.centerX;sprite.y=this.manager.bounds.centerY},debug:function(){this.game.debug.text(this.boundsFluid.width+" x "+this.boundsFluid.height,this.boundsFluid.x+4,this.boundsFluid.y+16);this.game.debug.geom(this.boundsFluid,"rgba(255,0,0,0.9",false)}};Phaser.FlexGrid.prototype.constructor=Phaser.FlexGrid;Phaser.FlexLayer=function(manager,position,bounds,scale){Phaser.Group.call(this,manager.game,null,"__flexLayer"+manager.game.rnd.uuid(),false);this.manager=manager.manager;this.grid=manager;this.persist=false;this.position=position;this.bounds=bounds;this.scale=scale;this.topLeft=bounds.topLeft;this.topMiddle=new Phaser.Point(bounds.halfWidth,0);this.topRight=bounds.topRight;this.bottomLeft=bounds.bottomLeft;this.bottomMiddle=new Phaser.Point(bounds.halfWidth,bounds.bottom);this.bottomRight=bounds.bottomRight};Phaser.FlexLayer.prototype=Object.create(Phaser.Group.prototype);Phaser.FlexLayer.prototype.constructor=Phaser.FlexLayer;Phaser.FlexLayer.prototype.resize=function(){};Phaser.FlexLayer.prototype.debug=function(){this.game.debug.text(this.bounds.width+" x "+this.bounds.height,this.bounds.x+4,this.bounds.y+16);this.game.debug.geom(this.bounds,"rgba(0,0,255,0.9",false);this.game.debug.geom(this.topLeft,"rgba(255,255,255,0.9");this.game.debug.geom(this.topMiddle,"rgba(255,255,255,0.9");this.game.debug.geom(this.topRight,"rgba(255,255,255,0.9")};Phaser.ScaleManager=function(game,width,height){this.game=game;this.dom=Phaser.DOM;this.grid=null;this.width=0;this.height=0;this.minWidth=null;this.maxWidth=null;this.minHeight=null;this.maxHeight=null;this.offset=new Phaser.Point;this.forceLandscape=false;this.forcePortrait=false;this.incorrectOrientation=false;this._pageAlignHorizontally=false;this._pageAlignVertically=false;this.maxIterations=5;this.onOrientationChange=new Phaser.Signal;this.enterLandscape=new Phaser.Signal;this.enterPortrait=new Phaser.Signal;this.enterIncorrectOrientation=new Phaser.Signal;this.leaveIncorrectOrientation=new Phaser.Signal;this.fullScreenTarget=null;this._createdFullScreenTarget=null;this.onFullScreenInit=new Phaser.Signal;this.onFullScreenChange=new Phaser.Signal;this.onFullScreenError=new Phaser.Signal;this.enterFullScreen=new Phaser.Signal;this.leaveFullScreen=new Phaser.Signal;this.fullScreenFailed=this.onFullScreenError;this.screenOrientation=this.dom.getScreenOrientation();this.scaleFactor=new Phaser.Point(1,1);this.scaleFactorInversed=new Phaser.Point(1,1);this.margin={left:0,top:0,right:0,bottom:0,x:0,y:0};this.bounds=new Phaser.Rectangle;this.aspectRatio=0;this.sourceAspectRatio=0;this.event=null;this.windowConstraints={right:"layout",bottom:""};this.compatibility={supportsFullScreen:false,orientationFallback:null,noMargins:false,scrollTo:null,forceMinimumDocumentHeight:false,canExpandParent:true,clickTrampoline:""};this._scaleMode=Phaser.ScaleManager.NO_SCALE;this._fullScreenScaleMode=Phaser.ScaleManager.NO_SCALE;this.parentIsWindow=false;this.parentNode=null;this.parentScaleFactor=new Phaser.Point(1,1);this.trackParentInterval=2e3;this.onSizeChange=new Phaser.Signal;this.onResize=null;this.onResizeContext=null;this._fullScreenRestore=null;this._gameSize=new Phaser.Rectangle;this._userScaleFactor=new Phaser.Point(1,1);this._userScaleTrim=new Phaser.Point(0,0);this._lastUpdate=0;this._updateThrottle=0;this._updateThrottleReset=100;this._parentBounds=new Phaser.Rectangle;this._tempBounds=new Phaser.Rectangle;this._lastReportedCanvasSize=new Phaser.Rectangle;this._lastReportedGameSize=new Phaser.Rectangle;if(game.config){this.parseConfig(game.config)}this.setupScale(width,height)};Phaser.ScaleManager.EXACT_FIT=0;Phaser.ScaleManager.NO_SCALE=1;Phaser.ScaleManager.SHOW_ALL=2;Phaser.ScaleManager.RESIZE=3;Phaser.ScaleManager.USER_SCALE=4;Phaser.ScaleManager.prototype={boot:function(){var compat=this.compatibility;compat.supportsFullScreen=this.game.device.fullscreen&&!this.game.device.cocoonJS;if(!this.game.device.iPad&&!this.game.device.webApp&&!this.game.device.desktop){if(this.game.device.android&&!this.game.device.chrome){compat.scrollTo=new Phaser.Point(0,1)}else{compat.scrollTo=new Phaser.Point(0,0)}}if(this.game.device.desktop){compat.orientationFallback="screen";compat.clickTrampoline="when-not-mouse"}else{compat.orientationFallback="";compat.clickTrampoline=""}var _this=this;this._orientationChange=function(event){return _this.orientationChange(event)};this._windowResize=function(event){return _this.windowResize(event)};window.addEventListener("orientationchange",this._orientationChange,false);window.addEventListener("resize",this._windowResize,false);if(this.compatibility.supportsFullScreen){this._fullScreenChange=function(event){return _this.fullScreenChange(event)};this._fullScreenError=function(event){return _this.fullScreenError(event)};document.addEventListener("webkitfullscreenchange",this._fullScreenChange,false);document.addEventListener("mozfullscreenchange",this._fullScreenChange,false);document.addEventListener("MSFullscreenChange",this._fullScreenChange,false);document.addEventListener("fullscreenchange",this._fullScreenChange,false);document.addEventListener("webkitfullscreenerror",this._fullScreenError,false);document.addEventListener("mozfullscreenerror",this._fullScreenError,false);document.addEventListener("MSFullscreenError",this._fullScreenError,false);document.addEventListener("fullscreenerror",this._fullScreenError,false)}this.game.onResume.add(this._gameResumed,this);this.dom.getOffset(this.game.canvas,this.offset);this.bounds.setTo(this.offset.x,this.offset.y,this.width,this.height);this.setGameSize(this.game.width,this.game.height);this.screenOrientation=this.dom.getScreenOrientation(this.compatibility.orientationFallback);this.grid=new Phaser.FlexGrid(this,this.width,this.height)},parseConfig:function(config){if(config["scaleMode"]){this.scaleMode=config["scaleMode"]}if(config["fullScreenScaleMode"]){this.fullScreenScaleMode=config["fullScreenScaleMode"]}if(config["fullScreenTarget"]){this.fullScreenTarget=config["fullScreenTarget"]}},setupScale:function(width,height){var target;var rect=new Phaser.Rectangle;if(this.game.parent!==""){if(typeof this.game.parent==="string"){target=document.getElementById(this.game.parent)}else if(this.game.parent&&this.game.parent.nodeType===1){target=this.game.parent}}if(!target){this.parentNode=null;this.parentIsWindow=true;rect.width=this.dom.visualBounds.width;rect.height=this.dom.visualBounds.height;this.offset.set(0,0)}else{this.parentNode=target;this.parentIsWindow=false;this.getParentBounds(this._parentBounds);rect.width=this._parentBounds.width;rect.height=this._parentBounds.height;this.offset.set(this._parentBounds.x,this._parentBounds.y)}var newWidth=0;var newHeight=0;if(typeof width==="number"){newWidth=width}else{this.parentScaleFactor.x=parseInt(width,10)/100;newWidth=rect.width*this.parentScaleFactor.x}if(typeof height==="number"){newHeight=height}else{this.parentScaleFactor.y=parseInt(height,10)/100;newHeight=rect.height*this.parentScaleFactor.y}this._gameSize.setTo(0,0,newWidth,newHeight);this.updateDimensions(newWidth,newHeight,false)},_gameResumed:function(){this.queueUpdate(true)},setGameSize:function(width,height){this._gameSize.setTo(0,0,width,height);if(this.currentScaleMode!==Phaser.ScaleManager.RESIZE){this.updateDimensions(width,height,true)}this.queueUpdate(true)},setUserScale:function(hScale,vScale,hTrim,vTrim){this._userScaleFactor.setTo(hScale,vScale);this._userScaleTrim.setTo(hTrim|0,vTrim|0);this.queueUpdate(true)},setResizeCallback:function(callback,context){this.onResize=callback;this.onResizeContext=context},signalSizeChange:function(){if(!Phaser.Rectangle.sameDimensions(this,this._lastReportedCanvasSize)||!Phaser.Rectangle.sameDimensions(this.game,this._lastReportedGameSize)){var width=this.width;var height=this.height;this._lastReportedCanvasSize.setTo(0,0,width,height);this._lastReportedGameSize.setTo(0,0,this.game.width,this.game.height);this.grid.onResize(width,height);this.onSizeChange.dispatch(this,width,height);if(this.currentScaleMode===Phaser.ScaleManager.RESIZE){this.game.state.resize(width,height);this.game.load.resize(width,height)}}},setMinMax:function(minWidth,minHeight,maxWidth,maxHeight){this.minWidth=minWidth;this.minHeight=minHeight;if(typeof maxWidth!=="undefined"){this.maxWidth=maxWidth}if(typeof maxHeight!=="undefined"){this.maxHeight=maxHeight}},preUpdate:function(){if(this.game.time.time<this._lastUpdate+this._updateThrottle){return}var prevThrottle=this._updateThrottle;this._updateThrottleReset=prevThrottle>=400?0:100;this.dom.getOffset(this.game.canvas,this.offset);var prevWidth=this._parentBounds.width;var prevHeight=this._parentBounds.height;var bounds=this.getParentBounds(this._parentBounds);var boundsChanged=bounds.width!==prevWidth||bounds.height!==prevHeight;var orientationChanged=this.updateOrientationState();if(boundsChanged||orientationChanged){if(this.onResize){this.onResize.call(this.onResizeContext,this,bounds)}this.updateLayout();this.signalSizeChange()}var throttle=this._updateThrottle*2;if(this._updateThrottle<prevThrottle){throttle=Math.min(prevThrottle,this._updateThrottleReset)}this._updateThrottle=Phaser.Math.clamp(throttle,25,this.trackParentInterval);this._lastUpdate=this.game.time.time},pauseUpdate:function(){this.preUpdate();this._updateThrottle=this.trackParentInterval},updateDimensions:function(width,height,resize){this.width=width*this.parentScaleFactor.x;this.height=height*this.parentScaleFactor.y;this.game.width=this.width;this.game.height=this.height;this.sourceAspectRatio=this.width/this.height;this.updateScalingAndBounds();if(resize){this.game.renderer.resize(this.width,this.height);this.game.camera.setSize(this.width,this.height);this.game.world.resize(this.width,this.height)}},updateScalingAndBounds:function(){this.scaleFactor.x=this.game.width/this.width;this.scaleFactor.y=this.game.height/this.height;this.scaleFactorInversed.x=this.width/this.game.width;this.scaleFactorInversed.y=this.height/this.game.height;this.aspectRatio=this.width/this.height;if(this.game.canvas){this.dom.getOffset(this.game.canvas,this.offset)}this.bounds.setTo(this.offset.x,this.offset.y,this.width,this.height);if(this.game.input&&this.game.input.scale){this.game.input.scale.setTo(this.scaleFactor.x,this.scaleFactor.y)}},forceOrientation:function(forceLandscape,forcePortrait){if(typeof forcePortrait==="undefined"){forcePortrait=false}this.forceLandscape=forceLandscape;this.forcePortrait=forcePortrait;this.queueUpdate(true)},classifyOrientation:function(orientation){if(orientation==="portrait-primary"||orientation==="portrait-secondary"){return"portrait"}else if(orientation==="landscape-primary"||orientation==="landscape-secondary"){return"landscape"}else{return null}},updateOrientationState:function(){var previousOrientation=this.screenOrientation;var previouslyIncorrect=this.incorrectOrientation;this.screenOrientation=this.dom.getScreenOrientation(this.compatibility.orientationFallback);this.incorrectOrientation=this.forceLandscape&&!this.isLandscape||this.forcePortrait&&!this.isPortrait;var changed=previousOrientation!==this.screenOrientation;var correctnessChanged=previouslyIncorrect!==this.incorrectOrientation;if(changed){if(this.isLandscape){this.enterLandscape.dispatch(this.orientation,true,false)}else{this.enterPortrait.dispatch(this.orientation,false,true)}}if(correctnessChanged){if(this.incorrectOrientation){this.enterIncorrectOrientation.dispatch()}else{this.leaveIncorrectOrientation.dispatch()}}if(changed||correctnessChanged){this.onOrientationChange.dispatch(this,previousOrientation,previouslyIncorrect)}return changed||correctnessChanged},orientationChange:function(event){this.event=event;this.queueUpdate(true)},windowResize:function(event){this.event=event;this.queueUpdate(true)},scrollTop:function(){var scrollTo=this.compatibility.scrollTo;if(scrollTo){window.scrollTo(scrollTo.x,scrollTo.y)}},refresh:function(){this.scrollTop();this.queueUpdate(true)},updateLayout:function(){var scaleMode=this.currentScaleMode;if(scaleMode===Phaser.ScaleManager.RESIZE){this.reflowGame();return}this.scrollTop();if(this.compatibility.forceMinimumDocumentHeight){document.documentElement.style.minHeight=window.innerHeight+"px"}if(this.incorrectOrientation){this.setMaximum()}else{if(scaleMode===Phaser.ScaleManager.EXACT_FIT){this.setExactFit()}else if(scaleMode===Phaser.ScaleManager.SHOW_ALL){if(!this.isFullScreen&&this.boundingParent&&this.compatibility.canExpandParent){this.setShowAll(true);this.resetCanvas();this.setShowAll()}else{this.setShowAll()}}else if(scaleMode===Phaser.ScaleManager.NO_SCALE){this.width=this.game.width;this.height=this.game.height}else if(scaleMode===Phaser.ScaleManager.USER_SCALE){this.width=this.game.width*this._userScaleFactor.x-this._userScaleTrim.x;this.height=this.game.height*this._userScaleFactor.y-this._userScaleTrim.y}}if(!this.compatibility.canExpandParent&&(scaleMode===Phaser.ScaleManager.SHOW_ALL||scaleMode===Phaser.ScaleManager.USER_SCALE)){var bounds=this.getParentBounds(this._tempBounds);this.width=Math.min(this.width,bounds.width);this.height=Math.min(this.height,bounds.height)}this.width=this.width|0;this.height=this.height|0;this.reflowCanvas()},getParentBounds:function(target){var bounds=target||new Phaser.Rectangle;var parentNode=this.boundingParent;var visualBounds=this.dom.visualBounds;var layoutBounds=this.dom.layoutBounds;if(!parentNode){bounds.setTo(0,0,visualBounds.width,visualBounds.height)}else{var clientRect=parentNode.getBoundingClientRect();bounds.setTo(clientRect.left,clientRect.top,clientRect.width,clientRect.height);var wc=this.windowConstraints;if(wc.right){var windowBounds=wc.right==="layout"?layoutBounds:visualBounds;bounds.right=Math.min(bounds.right,windowBounds.width)}if(wc.bottom){var windowBounds=wc.bottom==="layout"?layoutBounds:visualBounds;bounds.bottom=Math.min(bounds.bottom,windowBounds.height)}}bounds.setTo(Math.round(bounds.x),Math.round(bounds.y),Math.round(bounds.width),Math.round(bounds.height));return bounds},alignCanvas:function(horizontal,vertical){var parentBounds=this.getParentBounds(this._tempBounds);var canvas=this.game.canvas;var margin=this.margin;if(horizontal){margin.left=margin.right=0;var canvasBounds=canvas.getBoundingClientRect();if(this.width<parentBounds.width&&!this.incorrectOrientation){var currentEdge=canvasBounds.left-parentBounds.x;var targetEdge=parentBounds.width/2-this.width/2;targetEdge=Math.max(targetEdge,0);var offset=targetEdge-currentEdge;margin.left=Math.round(offset)}canvas.style.marginLeft=margin.left+"px";if(margin.left!==0){margin.right=-(parentBounds.width-canvasBounds.width-margin.left);canvas.style.marginRight=margin.right+"px"}}if(vertical){margin.top=margin.bottom=0;var canvasBounds=canvas.getBoundingClientRect();if(this.height<parentBounds.height&&!this.incorrectOrientation){var currentEdge=canvasBounds.top-parentBounds.y;var targetEdge=parentBounds.height/2-this.height/2;targetEdge=Math.max(targetEdge,0);var offset=targetEdge-currentEdge;margin.top=Math.round(offset)}canvas.style.marginTop=margin.top+"px";if(margin.top!==0){margin.bottom=-(parentBounds.height-canvasBounds.height-margin.top);canvas.style.marginBottom=margin.bottom+"px"}}margin.x=margin.left;margin.y=margin.top},reflowGame:function(){this.resetCanvas("","");var bounds=this.getParentBounds(this._tempBounds);this.updateDimensions(bounds.width,bounds.height,true)},reflowCanvas:function(){if(!this.incorrectOrientation){this.width=Phaser.Math.clamp(this.width,this.minWidth||0,this.maxWidth||this.width);this.height=Phaser.Math.clamp(this.height,this.minHeight||0,this.maxHeight||this.height)}this.resetCanvas();if(!this.compatibility.noMargins){if(this.isFullScreen&&this._createdFullScreenTarget){this.alignCanvas(true,true)}else{this.alignCanvas(this.pageAlignHorizontally,this.pageAlignVertically)}}this.updateScalingAndBounds()},resetCanvas:function(cssWidth,cssHeight){if(typeof cssWidth==="undefined"){cssWidth=this.width+"px"}if(typeof cssHeight==="undefined"){cssHeight=this.height+"px"}var canvas=this.game.canvas;if(!this.compatibility.noMargins){canvas.style.marginLeft="";canvas.style.marginTop="";canvas.style.marginRight="";canvas.style.marginBottom=""}canvas.style.width=cssWidth;canvas.style.height=cssHeight},queueUpdate:function(force){if(force){this._parentBounds.width=0;this._parentBounds.height=0}this._updateThrottle=this._updateThrottleReset},reset:function(clearWorld){if(clearWorld){this.grid.reset()}},setMaximum:function(){this.width=this.dom.visualBounds.width;this.height=this.dom.visualBounds.height},setShowAll:function(expanding){var bounds=this.getParentBounds(this._tempBounds);var width=bounds.width;var height=bounds.height;var multiplier;if(expanding){multiplier=Math.max(height/this.game.height,width/this.game.width)}else{multiplier=Math.min(height/this.game.height,width/this.game.width)}this.width=Math.round(this.game.width*multiplier);this.height=Math.round(this.game.height*multiplier)},setExactFit:function(){var bounds=this.getParentBounds(this._tempBounds);this.width=bounds.width;this.height=bounds.height;if(this.isFullScreen){return}if(this.maxWidth){this.width=Math.min(this.width,this.maxWidth)}if(this.maxHeight){this.height=Math.min(this.height,this.maxHeight)}},createFullScreenTarget:function(){var fsTarget=document.createElement("div");fsTarget.style.margin="0";fsTarget.style.padding="0";fsTarget.style.background="#000";return fsTarget},startFullScreen:function(antialias,allowTrampoline){if(this.isFullScreen){return false}if(!this.compatibility.supportsFullScreen){var _this=this;setTimeout(function(){_this.fullScreenError()},10);return}if(this.compatibility.clickTrampoline==="when-not-mouse"){var input=this.game.input;if(input.activePointer&&input.activePointer!==input.mousePointer&&(allowTrampoline||allowTrampoline!==false)){input.activePointer.addClickTrampoline("startFullScreen",this.startFullScreen,this,[antialias,false]);return}}if(typeof antialias!=="undefined"&&this.game.renderType===Phaser.CANVAS){this.game.stage.smoothed=antialias}var fsTarget=this.fullScreenTarget;if(!fsTarget){this.cleanupCreatedTarget();this._createdFullScreenTarget=this.createFullScreenTarget();fsTarget=this._createdFullScreenTarget}var initData={targetElement:fsTarget};this.onFullScreenInit.dispatch(this,initData);if(this._createdFullScreenTarget){var canvas=this.game.canvas;var parent=canvas.parentNode;parent.insertBefore(fsTarget,canvas);fsTarget.appendChild(canvas)}if(this.game.device.fullscreenKeyboard){fsTarget[this.game.device.requestFullscreen](Element.ALLOW_KEYBOARD_INPUT)}else{fsTarget[this.game.device.requestFullscreen]()}return true},stopFullScreen:function(){if(!this.isFullScreen||!this.compatibility.supportsFullScreen){return false}document[this.game.device.cancelFullscreen]();return true},cleanupCreatedTarget:function(){var fsTarget=this._createdFullScreenTarget;if(fsTarget&&fsTarget.parentNode){var parent=fsTarget.parentNode;parent.insertBefore(this.game.canvas,fsTarget);parent.removeChild(fsTarget)}this._createdFullScreenTarget=null},prepScreenMode:function(enteringFullscreen){var createdTarget=!!this._createdFullScreenTarget;var fsTarget=this._createdFullScreenTarget||this.fullScreenTarget;if(enteringFullscreen){if(createdTarget||this.fullScreenScaleMode===Phaser.ScaleManager.EXACT_FIT){if(fsTarget!==this.game.canvas){this._fullScreenRestore={targetWidth:fsTarget.style.width,targetHeight:fsTarget.style.height};fsTarget.style.width="100%";fsTarget.style.height="100%"}}}else{if(this._fullScreenRestore){fsTarget.style.width=this._fullScreenRestore.targetWidth;fsTarget.style.height=this._fullScreenRestore.targetHeight;this._fullScreenRestore=null}this.updateDimensions(this._gameSize.width,this._gameSize.height,true);this.resetCanvas()}},fullScreenChange:function(event){this.event=event;if(this.isFullScreen){this.prepScreenMode(true);this.updateLayout();this.queueUpdate(true);this.enterFullScreen.dispatch(this.width,this.height)}else{this.prepScreenMode(false);this.cleanupCreatedTarget();this.updateLayout();this.queueUpdate(true);this.leaveFullScreen.dispatch(this.width,this.height)}this.onFullScreenChange.dispatch(this)},fullScreenError:function(event){this.event=event;this.cleanupCreatedTarget();console.warn("Phaser.ScaleManager: requestFullscreen failed or device does not support the Fullscreen API");this.onFullScreenError.dispatch(this)},scaleSprite:function(sprite,width,height,letterBox){if(typeof width==="undefined"){width=this.width}if(typeof height==="undefined"){height=this.height}if(typeof letterBox==="undefined"){letterBox=false}sprite.scale.set(1);if(sprite.width<=0||sprite.height<=0||width<=0||height<=0){return sprite}var scaleX1=width;var scaleY1=sprite.height*width/sprite.width;var scaleX2=sprite.width*height/sprite.height;var scaleY2=height;var scaleOnWidth=scaleX2>width;if(scaleOnWidth){scaleOnWidth=letterBox}else{scaleOnWidth=!letterBox}if(scaleOnWidth){sprite.width=Math.floor(scaleX1);sprite.height=Math.floor(scaleY1)}else{sprite.width=Math.floor(scaleX2);sprite.height=Math.floor(scaleY2)}return sprite},destroy:function(){this.game.onResume.remove(this._gameResumed,this);window.removeEventListener("orientationchange",this._orientationChange,false);window.removeEventListener("resize",this._windowResize,false);if(this.compatibility.supportsFullScreen){document.removeEventListener("webkitfullscreenchange",this._fullScreenChange,false);document.removeEventListener("mozfullscreenchange",this._fullScreenChange,false);
document.removeEventListener("MSFullscreenChange",this._fullScreenChange,false);document.removeEventListener("fullscreenchange",this._fullScreenChange,false);document.removeEventListener("webkitfullscreenerror",this._fullScreenError,false);document.removeEventListener("mozfullscreenerror",this._fullScreenError,false);document.removeEventListener("MSFullscreenError",this._fullScreenError,false);document.removeEventListener("fullscreenerror",this._fullScreenError,false)}}};Phaser.ScaleManager.prototype.constructor=Phaser.ScaleManager;Phaser.ScaleManager.prototype.checkResize=Phaser.ScaleManager.prototype.windowResize;Phaser.ScaleManager.prototype.checkOrientation=Phaser.ScaleManager.prototype.orientationChange;Phaser.ScaleManager.prototype.setScreenSize=Phaser.ScaleManager.prototype.updateLayout;Phaser.ScaleManager.prototype.setSize=Phaser.ScaleManager.prototype.reflowCanvas;Phaser.ScaleManager.prototype.checkOrientationState=function(){var changed=this.updateOrientationState();if(changed){this.refresh()}return changed};Object.defineProperty(Phaser.ScaleManager.prototype,"boundingParent",{get:function(){if(this.parentIsWindow||this.isFullScreen&&!this._createdFullScreenTarget){return null}var parentNode=this.game.canvas&&this.game.canvas.parentNode;return parentNode||null}});Object.defineProperty(Phaser.ScaleManager.prototype,"scaleMode",{get:function(){return this._scaleMode},set:function(value){if(value!==this._scaleMode){if(!this.isFullScreen){this.updateDimensions(this._gameSize.width,this._gameSize.height,true);this.queueUpdate(true)}this._scaleMode=value}return this._scaleMode}});Object.defineProperty(Phaser.ScaleManager.prototype,"fullScreenScaleMode",{get:function(){return this._fullScreenScaleMode},set:function(value){if(value!==this._fullScreenScaleMode){if(this.isFullScreen){this.prepScreenMode(false);this._fullScreenScaleMode=value;this.prepScreenMode(true);this.queueUpdate(true)}else{this._fullScreenScaleMode=value}}return this._fullScreenScaleMode}});Object.defineProperty(Phaser.ScaleManager.prototype,"currentScaleMode",{get:function(){return this.isFullScreen?this._fullScreenScaleMode:this._scaleMode}});Object.defineProperty(Phaser.ScaleManager.prototype,"pageAlignHorizontally",{get:function(){return this._pageAlignHorizontally},set:function(value){if(value!==this._pageAlignHorizontally){this._pageAlignHorizontally=value;this.queueUpdate(true)}}});Object.defineProperty(Phaser.ScaleManager.prototype,"pageAlignVertically",{get:function(){return this._pageAlignVertically},set:function(value){if(value!==this._pageAlignVertically){this._pageAlignVertically=value;this.queueUpdate(true)}}});Object.defineProperty(Phaser.ScaleManager.prototype,"isFullScreen",{get:function(){return!!(document["fullscreenElement"]||document["webkitFullscreenElement"]||document["mozFullScreenElement"]||document["msFullscreenElement"])}});Object.defineProperty(Phaser.ScaleManager.prototype,"isPortrait",{get:function(){return this.classifyOrientation(this.screenOrientation)==="portrait"}});Object.defineProperty(Phaser.ScaleManager.prototype,"isLandscape",{get:function(){return this.classifyOrientation(this.screenOrientation)==="landscape"}});Object.defineProperty(Phaser.ScaleManager.prototype,"orientation",{get:function(){return this.classifyOrientation(this.screenOrientation)==="portrait"?0:90}});Object.defineProperty(Phaser.ScaleManager.prototype,"isGamePortrait",{get:function(){return this.height>this.width}});Object.defineProperty(Phaser.ScaleManager.prototype,"isGameLandscape",{get:function(){return this.width>this.height}});Phaser.Game=function(width,height,renderer,parent,state,transparent,antialias,physicsConfig){this.id=Phaser.GAMES.push(this)-1;this.config=null;this.physicsConfig=physicsConfig;this.parent="";this.width=800;this.height=600;this.resolution=1;this._width=800;this._height=600;this.transparent=false;this.antialias=true;this.preserveDrawingBuffer=false;this.renderer=null;this.renderType=Phaser.AUTO;this.state=null;this.isBooted=false;this.isRunning=false;this.raf=null;this.add=null;this.make=null;this.cache=null;this.input=null;this.load=null;this.math=null;this.net=null;this.scale=null;this.sound=null;this.stage=null;this.time=null;this.tweens=null;this.world=null;this.physics=null;this.plugins=null;this.rnd=null;this.device=Phaser.Device;this.camera=null;this.canvas=null;this.context=null;this.debug=null;this.particles=null;this.lockRender=false;this.stepping=false;this.pendingStep=false;this.stepCount=0;this.onPause=null;this.onResume=null;this.onBlur=null;this.onFocus=null;this._paused=false;this._codePaused=false;this.currentUpdateID=0;this.updatesThisFrame=1;this._deltaTime=0;this._lastCount=0;this._spiraling=0;this._kickstart=true;this.fpsProblemNotifier=new Phaser.Signal;this.forceSingleUpdate=false;this._nextFpsNotification=0;if(arguments.length===1&&typeof arguments[0]==="object"){this.parseConfig(arguments[0])}else{this.config={enableDebug:true};if(typeof width!=="undefined"){this._width=width}if(typeof height!=="undefined"){this._height=height}if(typeof renderer!=="undefined"){this.renderType=renderer}if(typeof parent!=="undefined"){this.parent=parent}if(typeof transparent!=="undefined"){this.transparent=transparent}if(typeof antialias!=="undefined"){this.antialias=antialias}this.rnd=new Phaser.RandomDataGenerator([(Date.now()*Math.random()).toString()]);this.state=new Phaser.StateManager(this,state)}this.device.whenReady(this.boot,this);return this};Phaser.Game.prototype={parseConfig:function(config){this.config=config;if(typeof config["enableDebug"]==="undefined"){this.config.enableDebug=true}if(config["width"]){this._width=config["width"]}if(config["height"]){this._height=config["height"]}if(config["renderer"]){this.renderType=config["renderer"]}if(config["parent"]){this.parent=config["parent"]}if(config["transparent"]){this.transparent=config["transparent"]}if(config["antialias"]){this.antialias=config["antialias"]}if(config["resolution"]){this.resolution=config["resolution"]}if(config["preserveDrawingBuffer"]){this.preserveDrawingBuffer=config["preserveDrawingBuffer"]}if(config["physicsConfig"]){this.physicsConfig=config["physicsConfig"]}var seed=[(Date.now()*Math.random()).toString()];if(config["seed"]){seed=config["seed"]}this.rnd=new Phaser.RandomDataGenerator(seed);var state=null;if(config["state"]){state=config["state"]}this.state=new Phaser.StateManager(this,state)},boot:function(){if(this.isBooted){return}this.onPause=new Phaser.Signal;this.onResume=new Phaser.Signal;this.onBlur=new Phaser.Signal;this.onFocus=new Phaser.Signal;this.isBooted=true;this.math=Phaser.Math;this.scale=new Phaser.ScaleManager(this,this._width,this._height);this.stage=new Phaser.Stage(this);this.setUpRenderer();this.world=new Phaser.World(this);this.add=new Phaser.GameObjectFactory(this);this.make=new Phaser.GameObjectCreator(this);this.cache=new Phaser.Cache(this);this.load=new Phaser.Loader(this);this.time=new Phaser.Time(this);this.tweens=new Phaser.TweenManager(this);this.input=new Phaser.Input(this);this.sound=new Phaser.SoundManager(this);this.physics=new Phaser.Physics(this,this.physicsConfig);this.particles=new Phaser.Particles(this);this.plugins=new Phaser.PluginManager(this);this.net=new Phaser.Net(this);this.time.boot();this.stage.boot();this.world.boot();this.scale.boot();this.input.boot();this.sound.boot();this.state.boot();if(this.config["enableDebug"]){this.debug=new Phaser.Utils.Debug(this);this.debug.boot()}else{this.debug={preUpdate:function(){},update:function(){},reset:function(){}}}this.showDebugHeader();this.isRunning=true;if(this.config&&this.config["forceSetTimeOut"]){this.raf=new Phaser.RequestAnimationFrame(this,this.config["forceSetTimeOut"])}else{this.raf=new Phaser.RequestAnimationFrame(this,false)}this._kickstart=true;if(window["focus"]){if(!window["PhaserGlobal"]||window["PhaserGlobal"]&&!window["PhaserGlobal"].stopFocus){window.focus()}}this.raf.start()},showDebugHeader:function(){if(window["PhaserGlobal"]&&window["PhaserGlobal"].hideBanner){return}var v=Phaser.VERSION;var r="Canvas";var a="HTML Audio";var c=1;if(this.renderType===Phaser.WEBGL){r="WebGL";c++}else if(this.renderType==Phaser.HEADLESS){r="Headless"}if(this.device.webAudio){a="WebAudio";c++}if(this.device.chrome){var args=["%c %c %c Phaser v"+v+" | Pixi.js "+PIXI.VERSION+" | "+r+" | "+a+"  %c %c "+"%c http://phaser.io %c%c%c","background: #9854d8","background: #6c2ca7","color: #ffffff; background: #450f78;","background: #6c2ca7","background: #9854d8","background: #ffffff"];for(var i=0;i<3;i++){if(i<c){args.push("color: #ff2424; background: #fff")}else{args.push("color: #959595; background: #fff")}}console.log.apply(console,args)}else if(window["console"]){console.log("Phaser v"+v+" | Pixi.js "+PIXI.VERSION+" | "+r+" | "+a+" | http://phaser.io")}},setUpRenderer:function(){if(this.config["canvasID"]){this.canvas=Phaser.Canvas.create(this.width,this.height,this.config["canvasID"])}else{this.canvas=Phaser.Canvas.create(this.width,this.height)}if(this.config["canvasStyle"]){this.canvas.style=this.config["canvasStyle"]}else{this.canvas.style["-webkit-full-screen"]="width: 100%; height: 100%"}if(this.device.cocoonJS){if(this.renderType===Phaser.CANVAS){this.canvas.screencanvas=true}else{this.canvas.screencanvas=false}}if(this.renderType===Phaser.HEADLESS||this.renderType===Phaser.CANVAS||this.renderType===Phaser.AUTO&&this.device.webGL===false){if(this.device.canvas){if(this.renderType===Phaser.AUTO){this.renderType=Phaser.CANVAS}this.renderer=new PIXI.CanvasRenderer(this.width,this.height,{view:this.canvas,transparent:this.transparent,resolution:this.resolution,clearBeforeRender:true});this.context=this.renderer.context}else{throw new Error("Phaser.Game - cannot create Canvas or WebGL context, aborting.")}}else{this.renderType=Phaser.WEBGL;this.renderer=new PIXI.WebGLRenderer(this.width,this.height,{view:this.canvas,transparent:this.transparent,resolution:this.resolution,antialias:this.antialias,preserveDrawingBuffer:this.preserveDrawingBuffer});this.context=null}if(this.renderType!==Phaser.HEADLESS){this.stage.smoothed=this.antialias;Phaser.Canvas.addToDOM(this.canvas,this.parent,false);Phaser.Canvas.setTouchAction(this.canvas)}},update:function(time){this.time.update(time);if(this._kickstart){this.updateLogic(1/this.time.desiredFps);this.stage.updateTransform();this.updateRender(this.time.slowMotion*this.time.desiredFps);this._kickstart=false;return}if(this._spiraling>1&&!this.forceSingleUpdate){if(this.time.time>this._nextFpsNotification){this._nextFpsNotification=this.time.time+1e3*10;this.fpsProblemNotifier.dispatch()}this._deltaTime=0;this._spiraling=0;this.updateRender(this.time.slowMotion*this.time.desiredFps)}else{var slowStep=this.time.slowMotion*1e3/this.time.desiredFps;this._deltaTime+=Math.max(Math.min(slowStep*3,this.time.elapsed),0);var count=0;this.updatesThisFrame=Math.floor(this._deltaTime/slowStep);if(this.forceSingleUpdate){this.updatesThisFrame=Math.min(1,this.updatesThisFrame)}while(this._deltaTime>=slowStep){this._deltaTime-=slowStep;this.currentUpdateID=count;this.updateLogic(1/this.time.desiredFps);this.stage.updateTransform();count++;if(this.forceSingleUpdate&&count===1){break}}if(count>this._lastCount){this._spiraling++}else if(count<this._lastCount){this._spiraling=0}this._lastCount=count;this.updateRender(this._deltaTime/slowStep)}},updateLogic:function(timeStep){if(!this._paused&&!this.pendingStep){if(this.stepping){this.pendingStep=true}this.scale.preUpdate();this.debug.preUpdate();this.world.camera.preUpdate();this.physics.preUpdate();this.state.preUpdate(timeStep);this.plugins.preUpdate(timeStep);this.stage.preUpdate();this.state.update();this.stage.update();this.tweens.update(timeStep);this.sound.update();this.input.update();this.physics.update();this.particles.update();this.plugins.update();this.stage.postUpdate();this.plugins.postUpdate()}else{this.scale.pauseUpdate();this.state.pauseUpdate();this.debug.preUpdate()}},updateRender:function(elapsedTime){if(this.lockRender){return}this.state.preRender(elapsedTime);this.renderer.render(this.stage);this.plugins.render(elapsedTime);this.state.render(elapsedTime);this.plugins.postRender(elapsedTime)},enableStep:function(){this.stepping=true;this.pendingStep=false;this.stepCount=0},disableStep:function(){this.stepping=false;this.pendingStep=false},step:function(){this.pendingStep=false;this.stepCount++},destroy:function(){this.raf.stop();this.state.destroy();this.sound.destroy();this.scale.destroy();this.stage.destroy();this.input.destroy();this.physics.destroy();this.state=null;this.cache=null;this.input=null;this.load=null;this.sound=null;this.stage=null;this.time=null;this.world=null;this.isBooted=false;this.renderer.destroy(false);Phaser.Canvas.removeFromDOM(this.canvas);Phaser.GAMES[this.id]=null},gamePaused:function(event){if(!this._paused){this._paused=true;this.time.gamePaused();this.sound.setMute();this.onPause.dispatch(event)}},gameResumed:function(event){if(this._paused&&!this._codePaused){this._paused=false;this.time.gameResumed();this.input.reset();this.sound.unsetMute();this.onResume.dispatch(event)}},focusLoss:function(event){this.onBlur.dispatch(event);if(!this.stage.disableVisibilityChange){this.gamePaused(event)}},focusGain:function(event){this.onFocus.dispatch(event);if(!this.stage.disableVisibilityChange){this.gameResumed(event)}}};Phaser.Game.prototype.constructor=Phaser.Game;Object.defineProperty(Phaser.Game.prototype,"paused",{get:function(){return this._paused},set:function(value){if(value===true){if(this._paused===false){this._paused=true;this.sound.setMute();this.time.gamePaused();this.onPause.dispatch(this)}this._codePaused=true}else{if(this._paused){this._paused=false;this.input.reset();this.sound.unsetMute();this.time.gameResumed();this.onResume.dispatch(this)}this._codePaused=false}}});Phaser.Input=function(game){this.game=game;this.hitCanvas=null;this.hitContext=null;this.moveCallbacks=[];this.moveCallback=null;this.moveCallbackContext=this;this.pollRate=0;this.enabled=true;this.multiInputOverride=Phaser.Input.MOUSE_TOUCH_COMBINE;this.position=null;this.speed=null;this.circle=null;this.scale=null;this.maxPointers=-1;this.currentPointers=0;this.tapRate=200;this.doubleTapRate=300;this.holdRate=2e3;this.justPressedRate=200;this.justReleasedRate=200;this.recordPointerHistory=false;this.recordRate=100;this.recordLimit=100;this.pointer1=null;this.pointer2=null;this.pointer3=null;this.pointer4=null;this.pointer5=null;this.pointer6=null;this.pointer7=null;this.pointer8=null;this.pointer9=null;this.pointer10=null;this.pointers=[];this.activePointer=null;this.mousePointer=null;this.mouse=null;this.keyboard=null;this.touch=null;this.mspointer=null;this.gamepad=null;this.resetLocked=false;this.onDown=null;this.onUp=null;this.onTap=null;this.onHold=null;this.minPriorityID=0;this.interactiveItems=new Phaser.ArraySet;this._localPoint=new Phaser.Point;this._pollCounter=0;this._oldPosition=null;this._x=0;this._y=0};Phaser.Input.MOUSE_OVERRIDES_TOUCH=0;Phaser.Input.TOUCH_OVERRIDES_MOUSE=1;Phaser.Input.MOUSE_TOUCH_COMBINE=2;Phaser.Input.MAX_POINTERS=10;Phaser.Input.prototype={boot:function(){this.mousePointer=new Phaser.Pointer(this.game,0);this.addPointer();this.addPointer();this.mouse=new Phaser.Mouse(this.game);this.touch=new Phaser.Touch(this.game);this.mspointer=new Phaser.MSPointer(this.game);if(Phaser.Keyboard){this.keyboard=new Phaser.Keyboard(this.game)}if(Phaser.Gamepad){this.gamepad=new Phaser.Gamepad(this.game)}this.onDown=new Phaser.Signal;this.onUp=new Phaser.Signal;this.onTap=new Phaser.Signal;this.onHold=new Phaser.Signal;this.scale=new Phaser.Point(1,1);this.speed=new Phaser.Point;this.position=new Phaser.Point;this._oldPosition=new Phaser.Point;this.circle=new Phaser.Circle(0,0,44);this.activePointer=this.mousePointer;this.currentPointers=0;this.hitCanvas=document.createElement("canvas");this.hitCanvas.width=1;this.hitCanvas.height=1;this.hitContext=this.hitCanvas.getContext("2d");this.mouse.start();this.touch.start();this.mspointer.start();this.mousePointer.active=true;if(this.keyboard){this.keyboard.start()}var _this=this;this._onClickTrampoline=function(event){_this.onClickTrampoline(event)};this.game.canvas.addEventListener("click",this._onClickTrampoline,false)},destroy:function(){this.mouse.stop();this.touch.stop();this.mspointer.stop();if(this.keyboard){this.keyboard.stop()}if(this.gamepad){this.gamepad.stop()}this.moveCallbacks=[];this.game.canvas.removeEventListener("click",this._onClickTrampoline)},addMoveCallback:function(callback,context){return this.moveCallbacks.push({callback:callback,context:context})-1},deleteMoveCallback:function(index){if(this.moveCallbacks[index]){this.moveCallbacks.splice(index,1)}},addPointer:function(){if(this.pointers.length>=Phaser.Input.MAX_POINTERS){console.warn("Phaser.Input.addPointer: only "+Phaser.Input.MAX_POINTERS+" pointer allowed");return null}var id=this.pointers.length+1;var pointer=new Phaser.Pointer(this.game,id);this.pointers.push(pointer);this["pointer"+id]=pointer;return pointer},update:function(){if(this.keyboard){this.keyboard.update()}if(this.pollRate>0&&this._pollCounter<this.pollRate){this._pollCounter++;return}this.speed.x=this.position.x-this._oldPosition.x;this.speed.y=this.position.y-this._oldPosition.y;this._oldPosition.copyFrom(this.position);this.mousePointer.update();if(this.gamepad&&this.gamepad.active){this.gamepad.update()}for(var i=0;i<this.pointers.length;i++){this.pointers[i].update()}this._pollCounter=0},reset:function(hard){if(!this.game.isBooted||this.resetLocked){return}if(typeof hard==="undefined"){hard=false}this.mousePointer.reset();if(this.keyboard){this.keyboard.reset(hard)}if(this.gamepad){this.gamepad.reset()}for(var i=0;i<this.pointers.length;i++){this.pointers[i].reset()}this.currentPointers=0;if(this.game.canvas.style.cursor!=="none"){this.game.canvas.style.cursor="inherit"}if(hard){this.onDown.dispose();this.onUp.dispose();this.onTap.dispose();this.onHold.dispose();this.onDown=new Phaser.Signal;this.onUp=new Phaser.Signal;this.onTap=new Phaser.Signal;this.onHold=new Phaser.Signal;this.moveCallbacks=[]}this._pollCounter=0},resetSpeed:function(x,y){this._oldPosition.setTo(x,y);this.speed.setTo(0,0)},startPointer:function(event){if(this.maxPointers>=0&&this.countActivePointers(this.maxPointers)>=this.maxPointers){return null}if(!this.pointer1.active){return this.pointer1.start(event)}if(!this.pointer2.active){return this.pointer2.start(event)}for(var i=2;i<this.pointers.length;i++){var pointer=this.pointers[i];if(!pointer.active){return pointer.start(event)}}return null},updatePointer:function(event){if(this.pointer1.active&&this.pointer1.identifier===event.identifier){return this.pointer1.move(event)}if(this.pointer2.active&&this.pointer2.identifier===event.identifier){return this.pointer2.move(event)}for(var i=2;i<this.pointers.length;i++){var pointer=this.pointers[i];if(pointer.active&&pointer.identifier===event.identifier){return pointer.move(event)}}return null},stopPointer:function(event){if(this.pointer1.active&&this.pointer1.identifier===event.identifier){return this.pointer1.stop(event)}if(this.pointer2.active&&this.pointer2.identifier===event.identifier){return this.pointer2.stop(event)}for(var i=2;i<this.pointers.length;i++){var pointer=this.pointers[i];if(pointer.active&&pointer.identifier===event.identifier){return pointer.stop(event)}}return null},countActivePointers:function(limit){if(typeof limit==="undefined"){limit=this.pointers.length}var count=limit;for(var i=0;i<this.pointers.length&&count>0;i++){var pointer=this.pointers[i];if(pointer.active){count--}}this.currentPointers=limit-count;return limit-count},getPointer:function(isActive){if(typeof isActive==="undefined"){isActive=false}for(var i=0;i<this.pointers.length;i++){var pointer=this.pointers[i];if(pointer.active===isActive){return pointer}}return null},getPointerFromIdentifier:function(identifier){for(var i=0;i<this.pointers.length;i++){var pointer=this.pointers[i];if(pointer.identifier===identifier){return pointer}}return null},getPointerFromId:function(pointerId){for(var i=0;i<this.pointers.length;i++){var pointer=this.pointers[i];if(pointer.pointerId===pointerId){return pointer}}return null},getLocalPosition:function(displayObject,pointer,output){if(typeof output==="undefined"){output=new Phaser.Point}var wt=displayObject.worldTransform;var id=1/(wt.a*wt.d+wt.c*-wt.b);return output.setTo(wt.d*id*pointer.x+-wt.c*id*pointer.y+(wt.ty*wt.c-wt.tx*wt.d)*id,wt.a*id*pointer.y+-wt.b*id*pointer.x+(-wt.ty*wt.a+wt.tx*wt.b)*id)},hitTest:function(displayObject,pointer,localPoint){if(!displayObject.worldVisible){return false}this.getLocalPosition(displayObject,pointer,this._localPoint);localPoint.copyFrom(this._localPoint);if(displayObject.hitArea&&displayObject.hitArea.contains){return displayObject.hitArea.contains(this._localPoint.x,this._localPoint.y)}else if(displayObject instanceof Phaser.TileSprite){var width=displayObject.width;var height=displayObject.height;var x1=-width*displayObject.anchor.x;if(this._localPoint.x>=x1&&this._localPoint.x<x1+width){var y1=-height*displayObject.anchor.y;if(this._localPoint.y>=y1&&this._localPoint.y<y1+height){return true}}}else if(displayObject instanceof PIXI.Sprite){var width=displayObject.texture.frame.width;var height=displayObject.texture.frame.height;var x1=-width*displayObject.anchor.x;if(this._localPoint.x>=x1&&this._localPoint.x<x1+width){var y1=-height*displayObject.anchor.y;if(this._localPoint.y>=y1&&this._localPoint.y<y1+height){return true}}}else if(displayObject instanceof Phaser.Graphics){for(var i=0;i<displayObject.graphicsData.length;i++){var data=displayObject.graphicsData[i];if(!data.fill){continue}if(data.shape&&data.shape.contains(this._localPoint.x,this._localPoint.y)){return true}}}for(var i=0,len=displayObject.children.length;i<len;i++){if(this.hitTest(displayObject.children[i],pointer,localPoint)){return true}}return false},onClickTrampoline:function(){this.activePointer.processClickTrampolines()}};Phaser.Input.prototype.constructor=Phaser.Input;Object.defineProperty(Phaser.Input.prototype,"x",{get:function(){return this._x},set:function(value){this._x=Math.floor(value)}});Object.defineProperty(Phaser.Input.prototype,"y",{get:function(){return this._y},set:function(value){this._y=Math.floor(value)}});Object.defineProperty(Phaser.Input.prototype,"pollLocked",{get:function(){return this.pollRate>0&&this._pollCounter<this.pollRate}});Object.defineProperty(Phaser.Input.prototype,"totalInactivePointers",{get:function(){return this.pointers.length-this.countActivePointers()}});Object.defineProperty(Phaser.Input.prototype,"totalActivePointers",{get:function(){return this.countActivePointers()}});Object.defineProperty(Phaser.Input.prototype,"worldX",{get:function(){return this.game.camera.view.x+this.x}});Object.defineProperty(Phaser.Input.prototype,"worldY",{get:function(){return this.game.camera.view.y+this.y}});Object.defineProperty(Phaser.Input.prototype,"disabled",{get:function(){return!this.enabled},set:function(value){this.enabled=!value}});Phaser.Mouse=function(game){this.game=game;this.callbackContext=this.game;this.mouseDownCallback=null;this.mouseMoveCallback=null;this.mouseUpCallback=null;this.mouseOutCallback=null;this.mouseOverCallback=null;this.mouseWheelCallback=null;this.capture=false;this.button=-1;this.wheelDelta=0;this.enabled=true;this.locked=false;this.stopOnGameOut=false;this.pointerLock=new Phaser.Signal;this.event=null;this._onMouseDown=null;this._onMouseMove=null;this._onMouseUp=null;this._onMouseOut=null;this._onMouseOver=null;this._onMouseWheel=null;this._wheelEvent=null};Phaser.Mouse.NO_BUTTON=-1;Phaser.Mouse.LEFT_BUTTON=0;Phaser.Mouse.MIDDLE_BUTTON=1;Phaser.Mouse.RIGHT_BUTTON=2;Phaser.Mouse.WHEEL_UP=1;Phaser.Mouse.WHEEL_DOWN=-1;Phaser.Mouse.prototype={start:function(){if(this.game.device.android&&this.game.device.chrome===false){return}if(this._onMouseDown!==null){return}var _this=this;this._onMouseDown=function(event){return _this.onMouseDown(event)};this._onMouseMove=function(event){return _this.onMouseMove(event)};this._onMouseUp=function(event){return _this.onMouseUp(event)};this._onMouseUpGlobal=function(event){return _this.onMouseUpGlobal(event)};this._onMouseOut=function(event){return _this.onMouseOut(event)};this._onMouseOver=function(event){return _this.onMouseOver(event)};this._onMouseWheel=function(event){return _this.onMouseWheel(event)};this.game.canvas.addEventListener("mousedown",this._onMouseDown,true);this.game.canvas.addEventListener("mousemove",this._onMouseMove,true);this.game.canvas.addEventListener("mouseup",this._onMouseUp,true);if(!this.game.device.cocoonJS){window.addEventListener("mouseup",this._onMouseUpGlobal,true);this.game.canvas.addEventListener("mouseover",this._onMouseOver,true);this.game.canvas.addEventListener("mouseout",this._onMouseOut,true)}var wheelEvent=this.game.device.wheelEvent;if(wheelEvent){this.game.canvas.addEventListener(wheelEvent,this._onMouseWheel,true);if(wheelEvent==="mousewheel"){this._wheelEvent=new WheelEventProxy(-1/40,1)}else if(wheelEvent==="DOMMouseScroll"){this._wheelEvent=new WheelEventProxy(1,1)}}},onMouseDown:function(event){this.event=event;if(this.capture){event.preventDefault()}this.button=event.button;if(this.mouseDownCallback){this.mouseDownCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}event["identifier"]=0;this.game.input.mousePointer.start(event)},onMouseMove:function(event){this.event=event;if(this.capture){event.preventDefault()}if(this.mouseMoveCallback){this.mouseMoveCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}event["identifier"]=0;this.game.input.mousePointer.move(event)},onMouseUp:function(event){this.event=event;if(this.capture){event.preventDefault()}this.button=Phaser.Mouse.NO_BUTTON;if(this.mouseUpCallback){this.mouseUpCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}event["identifier"]=0;this.game.input.mousePointer.stop(event)},onMouseUpGlobal:function(event){if(!this.game.input.mousePointer.withinGame){this.button=Phaser.Mouse.NO_BUTTON;if(this.mouseUpCallback){this.mouseUpCallback.call(this.callbackContext,event)}event["identifier"]=0;this.game.input.mousePointer.stop(event)}},onMouseOut:function(event){this.event=event;if(this.capture){event.preventDefault()}this.game.input.mousePointer.withinGame=false;if(this.mouseOutCallback){this.mouseOutCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}if(this.stopOnGameOut){event["identifier"]=0;this.game.input.mousePointer.stop(event)}},onMouseWheel:function(event){if(this._wheelEvent){event=this._wheelEvent.bindEvent(event)}this.event=event;if(this.capture){event.preventDefault()}this.wheelDelta=Phaser.Math.clamp(-event.deltaY,-1,1);if(this.mouseWheelCallback){this.mouseWheelCallback.call(this.callbackContext,event)}},onMouseOver:function(event){this.event=event;if(this.capture){event.preventDefault()}this.game.input.mousePointer.withinGame=true;if(this.mouseOverCallback){this.mouseOverCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}},requestPointerLock:function(){if(this.game.device.pointerLock){var element=this.game.canvas;element.requestPointerLock=element.requestPointerLock||element.mozRequestPointerLock||element.webkitRequestPointerLock;element.requestPointerLock();var _this=this;this._pointerLockChange=function(event){return _this.pointerLockChange(event)};document.addEventListener("pointerlockchange",this._pointerLockChange,true);document.addEventListener("mozpointerlockchange",this._pointerLockChange,true);document.addEventListener("webkitpointerlockchange",this._pointerLockChange,true)}},pointerLockChange:function(event){var element=this.game.canvas;if(document.pointerLockElement===element||document.mozPointerLockElement===element||document.webkitPointerLockElement===element){this.locked=true;this.pointerLock.dispatch(true,event)}else{this.locked=false;this.pointerLock.dispatch(false,event)}},releasePointerLock:function(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;document.exitPointerLock();document.removeEventListener("pointerlockchange",this._pointerLockChange,true);document.removeEventListener("mozpointerlockchange",this._pointerLockChange,true);document.removeEventListener("webkitpointerlockchange",this._pointerLockChange,true)},stop:function(){this.game.canvas.removeEventListener("mousedown",this._onMouseDown,true);this.game.canvas.removeEventListener("mousemove",this._onMouseMove,true);this.game.canvas.removeEventListener("mouseup",this._onMouseUp,true);this.game.canvas.removeEventListener("mouseover",this._onMouseOver,true);this.game.canvas.removeEventListener("mouseout",this._onMouseOut,true);var wheelEvent=this.game.device.wheelEvent;if(wheelEvent){this.game.canvas.removeEventListener(wheelEvent,this._onMouseWheel,true)}window.removeEventListener("mouseup",this._onMouseUpGlobal,true);document.removeEventListener("pointerlockchange",this._pointerLockChange,true);document.removeEventListener("mozpointerlockchange",this._pointerLockChange,true);document.removeEventListener("webkitpointerlockchange",this._pointerLockChange,true)}};Phaser.Mouse.prototype.constructor=Phaser.Mouse;Object.defineProperty(Phaser.Mouse.prototype,"disabled",{get:function(){return!this.enabled},set:function(value){this.enabled=!value}});function WheelEventProxy(scaleFactor,deltaMode){this._scaleFactor=scaleFactor;this._deltaMode=deltaMode;this.originalEvent=null}WheelEventProxy.prototype={};WheelEventProxy.prototype.constructor=WheelEventProxy;WheelEventProxy.prototype.bindEvent=function(event){if(!WheelEventProxy._stubsGenerated&&event){var makeBinder=function(name){return function(){var v=this.originalEvent[name];return typeof v!=="function"?v:v.bind(this.originalEvent)}};for(var prop in event){if(!(prop in WheelEventProxy.prototype)){Object.defineProperty(WheelEventProxy.prototype,prop,{get:makeBinder(prop)})}}WheelEventProxy._stubsGenerated=true}this.originalEvent=event;return this};Object.defineProperties(WheelEventProxy.prototype,{type:{value:"wheel"},deltaMode:{get:function(){return this._deltaMode}},deltaY:{get:function(){return this._scaleFactor*(this.originalEvent.wheelDelta||this.originalEvent.detail)||0}},deltaX:{get:function(){return this._scaleFactor*this.originalEvent.wheelDeltaX||0}},deltaZ:{value:0}});Phaser.MSPointer=function(game){this.game=game;this.callbackContext=this.game;this.pointerDownCallback=null;this.pointerMoveCallback=null;this.pointerUpCallback=null;this.capture=true;this.button=-1;this.event=null;this.enabled=true;this._onMSPointerDown=null;this._onMSPointerMove=null;this._onMSPointerUp=null};Phaser.MSPointer.prototype={start:function(){if(this._onMSPointerDown!==null){return}var _this=this;if(this.game.device.mspointer){this._onMSPointerDown=function(event){return _this.onPointerDown(event)};this._onMSPointerMove=function(event){return _this.onPointerMove(event)};this._onMSPointerUp=function(event){return _this.onPointerUp(event)};this.game.canvas.addEventListener("MSPointerDown",this._onMSPointerDown,false);this.game.canvas.addEventListener("MSPointerMove",this._onMSPointerMove,false);this.game.canvas.addEventListener("MSPointerUp",this._onMSPointerUp,false);this.game.canvas.addEventListener("pointerDown",this._onMSPointerDown,false);this.game.canvas.addEventListener("pointerMove",this._onMSPointerMove,false);this.game.canvas.addEventListener("pointerUp",this._onMSPointerUp,false);this.game.canvas.style["-ms-content-zooming"]="none";this.game.canvas.style["-ms-touch-action"]="none"}},onPointerDown:function(event){this.event=event;if(this.capture){event.preventDefault()}this.button=event.button;if(this.pointerDownCallback){this.pointerDownCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return
}event.identifier=event.pointerId;this.game.input.startPointer(event)},onPointerMove:function(event){this.event=event;if(this.capture){event.preventDefault()}if(this.pointerMoveCallback){this.pointerMoveCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}event.identifier=event.pointerId;this.game.input.updatePointer(event)},onPointerUp:function(event){this.event=event;if(this.capture){event.preventDefault()}this.button=Phaser.Mouse.NO_BUTTON;if(this.pointerUpCallback){this.pointerUpCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}event.identifier=event.pointerId;this.game.input.stopPointer(event)},stop:function(){this.game.canvas.removeEventListener("MSPointerDown",this._onMSPointerDown);this.game.canvas.removeEventListener("MSPointerMove",this._onMSPointerMove);this.game.canvas.removeEventListener("MSPointerUp",this._onMSPointerUp);this.game.canvas.removeEventListener("pointerDown",this._onMSPointerDown);this.game.canvas.removeEventListener("pointerMove",this._onMSPointerMove);this.game.canvas.removeEventListener("pointerUp",this._onMSPointerUp)}};Phaser.MSPointer.prototype.constructor=Phaser.MSPointer;Object.defineProperty(Phaser.MSPointer.prototype,"disabled",{get:function(){return!this.enabled},set:function(value){this.enabled=!value}});Phaser.Pointer=function(game,id){this.game=game;this.id=id;this.type=Phaser.POINTER;this.exists=true;this.identifier=0;this.pointerId=null;this.target=null;this.button=null;this._holdSent=false;this._history=[];this._nextDrop=0;this._stateReset=false;this.withinGame=false;this.clientX=-1;this.clientY=-1;this.pageX=-1;this.pageY=-1;this.screenX=-1;this.screenY=-1;this.rawMovementX=0;this.rawMovementY=0;this.movementX=0;this.movementY=0;this.x=-1;this.y=-1;this.isMouse=false;this.isDown=false;this.isUp=true;this.timeDown=0;this.timeUp=0;this.previousTapTime=0;this.totalTouches=0;this.msSinceLastClick=Number.MAX_VALUE;this.targetObject=null;this.active=false;this.dirty=false;this.position=new Phaser.Point;this.positionDown=new Phaser.Point;this.positionUp=new Phaser.Point;this.circle=new Phaser.Circle(0,0,44);if(id===0){this.isMouse=true}this._clickTrampolines=null;this._trampolineTargetObject=null};Phaser.Pointer.prototype={start:function(event){if(event["pointerId"]){this.pointerId=event.pointerId}this.identifier=event.identifier;this.target=event.target;if(typeof event.button!=="undefined"){this.button=event.button}this._history=[];this.active=true;this.withinGame=true;this.isDown=true;this.isUp=false;this.dirty=false;this._clickTrampolines=null;this._trampolineTargetObject=null;this.msSinceLastClick=this.game.time.time-this.timeDown;this.timeDown=this.game.time.time;this._holdSent=false;this.move(event,true);this.positionDown.setTo(this.x,this.y);if(this.game.input.multiInputOverride===Phaser.Input.MOUSE_OVERRIDES_TOUCH||this.game.input.multiInputOverride===Phaser.Input.MOUSE_TOUCH_COMBINE||this.game.input.multiInputOverride===Phaser.Input.TOUCH_OVERRIDES_MOUSE&&this.game.input.currentPointers===0){this.game.input.x=this.x;this.game.input.y=this.y;this.game.input.position.setTo(this.x,this.y);this.game.input.onDown.dispatch(this,event);this.game.input.resetSpeed(this.x,this.y)}this._stateReset=false;this.totalTouches++;if(!this.isMouse){this.game.input.currentPointers++}if(this.targetObject!==null){this.targetObject._touchedHandler(this)}return this},update:function(){if(this.active){if(this.dirty){if(this.game.input.interactiveItems.total>0){this.processInteractiveObjects(false)}this.dirty=false}if(this._holdSent===false&&this.duration>=this.game.input.holdRate){if(this.game.input.multiInputOverride==Phaser.Input.MOUSE_OVERRIDES_TOUCH||this.game.input.multiInputOverride==Phaser.Input.MOUSE_TOUCH_COMBINE||this.game.input.multiInputOverride==Phaser.Input.TOUCH_OVERRIDES_MOUSE&&this.game.input.currentPointers===0){this.game.input.onHold.dispatch(this)}this._holdSent=true}if(this.game.input.recordPointerHistory&&this.game.time.time>=this._nextDrop){this._nextDrop=this.game.time.time+this.game.input.recordRate;this._history.push({x:this.position.x,y:this.position.y});if(this._history.length>this.game.input.recordLimit){this._history.shift()}}}},move:function(event,fromClick){if(this.game.input.pollLocked){return}if(typeof fromClick==="undefined"){fromClick=false}if(typeof event.button!=="undefined"){this.button=event.button}this.clientX=event.clientX;this.clientY=event.clientY;this.pageX=event.pageX;this.pageY=event.pageY;this.screenX=event.screenX;this.screenY=event.screenY;if(this.isMouse&&this.game.input.mouse.locked&&!fromClick){this.rawMovementX=event.movementX||event.mozMovementX||event.webkitMovementX||0;this.rawMovementY=event.movementY||event.mozMovementY||event.webkitMovementY||0;this.movementX+=this.rawMovementX;this.movementY+=this.rawMovementY}this.x=(this.pageX-this.game.scale.offset.x)*this.game.input.scale.x;this.y=(this.pageY-this.game.scale.offset.y)*this.game.input.scale.y;this.position.setTo(this.x,this.y);this.circle.x=this.x;this.circle.y=this.y;if(this.game.input.multiInputOverride===Phaser.Input.MOUSE_OVERRIDES_TOUCH||this.game.input.multiInputOverride===Phaser.Input.MOUSE_TOUCH_COMBINE||this.game.input.multiInputOverride===Phaser.Input.TOUCH_OVERRIDES_MOUSE&&this.game.input.currentPointers===0){this.game.input.activePointer=this;this.game.input.x=this.x;this.game.input.y=this.y;this.game.input.position.setTo(this.game.input.x,this.game.input.y);this.game.input.circle.x=this.game.input.x;this.game.input.circle.y=this.game.input.y}this.withinGame=this.game.scale.bounds.contains(this.pageX,this.pageY);if(this.game.paused){return this}var i=this.game.input.moveCallbacks.length;while(i--){this.game.input.moveCallbacks[i].callback.call(this.game.input.moveCallbacks[i].context,this,this.x,this.y,fromClick)}if(this.targetObject!==null&&this.targetObject.isDragged===true){if(this.targetObject.update(this)===false){this.targetObject=null}}else if(this.game.input.interactiveItems.total>0){this.processInteractiveObjects(fromClick)}return this},processInteractiveObjects:function(fromClick){var highestRenderOrderID=Number.MAX_VALUE;var highestInputPriorityID=-1;var candidateTarget=null;var currentNode=this.game.input.interactiveItems.first;while(currentNode){currentNode.checked=false;if(currentNode.validForInput(highestInputPriorityID,highestRenderOrderID,false)){currentNode.checked=true;if(fromClick&&currentNode.checkPointerDown(this,true)||!fromClick&&currentNode.checkPointerOver(this,true)){highestRenderOrderID=currentNode.sprite.renderOrderID;highestInputPriorityID=currentNode.priorityID;candidateTarget=currentNode}}currentNode=this.game.input.interactiveItems.next}var currentNode=this.game.input.interactiveItems.first;while(currentNode){if(!currentNode.checked&&currentNode.validForInput(highestInputPriorityID,highestRenderOrderID,true)){if(fromClick&&currentNode.checkPointerDown(this,false)||!fromClick&&currentNode.checkPointerOver(this,false)){highestRenderOrderID=currentNode.sprite.renderOrderID;highestInputPriorityID=currentNode.priorityID;candidateTarget=currentNode}}currentNode=this.game.input.interactiveItems.next}if(candidateTarget===null){if(this.targetObject){this.targetObject._pointerOutHandler(this);this.targetObject=null}}else{if(this.targetObject===null){this.targetObject=candidateTarget;candidateTarget._pointerOverHandler(this)}else{if(this.targetObject===candidateTarget){if(candidateTarget.update(this)===false){this.targetObject=null}}else{this.targetObject._pointerOutHandler(this);this.targetObject=candidateTarget;this.targetObject._pointerOverHandler(this)}}}return this.targetObject!==null},leave:function(event){this.withinGame=false;this.move(event,false)},stop:function(event){if(this._stateReset&&this.withinGame){event.preventDefault();return}this.timeUp=this.game.time.time;if(this.game.input.multiInputOverride===Phaser.Input.MOUSE_OVERRIDES_TOUCH||this.game.input.multiInputOverride===Phaser.Input.MOUSE_TOUCH_COMBINE||this.game.input.multiInputOverride===Phaser.Input.TOUCH_OVERRIDES_MOUSE&&this.game.input.currentPointers===0){this.game.input.onUp.dispatch(this,event);if(this.duration>=0&&this.duration<=this.game.input.tapRate){if(this.timeUp-this.previousTapTime<this.game.input.doubleTapRate){this.game.input.onTap.dispatch(this,true)}else{this.game.input.onTap.dispatch(this,false)}this.previousTapTime=this.timeUp}}if(this.id>0){this.active=false}this.withinGame=false;this.isDown=false;this.isUp=true;this.pointerId=null;this.identifier=null;this.positionUp.setTo(this.x,this.y);if(this.isMouse===false){this.game.input.currentPointers--}this.game.input.interactiveItems.callAll("_releasedHandler",this);if(this._clickTrampolines){this._trampolineTargetObject=this.targetObject}this.targetObject=null;return this},justPressed:function(duration){duration=duration||this.game.input.justPressedRate;return this.isDown===true&&this.timeDown+duration>this.game.time.time},justReleased:function(duration){duration=duration||this.game.input.justReleasedRate;return this.isUp===true&&this.timeUp+duration>this.game.time.time},addClickTrampoline:function(name,callback,callbackContext,callbackArgs){if(!this.isDown){return}var trampolines=this._clickTrampolines=this._clickTrampolines||[];for(var i=0;i<trampolines.length;i++){if(trampolines[i].name===name){trampolines.splice(i,1);break}}trampolines.push({name:name,targetObject:this.targetObject,callback:callback,callbackContext:callbackContext,callbackArgs:callbackArgs})},processClickTrampolines:function(){var trampolines=this._clickTrampolines;if(!trampolines){return}for(var i=0;i<trampolines.length;i++){var trampoline=trampolines[i];if(trampoline.targetObject===this._trampolineTargetObject){trampoline.callback.apply(trampoline.callbackContext,trampoline.callbackArgs)}}this._clickTrampolines=null;this._trampolineTargetObject=null},reset:function(){if(this.isMouse===false){this.active=false}this.pointerId=null;this.identifier=null;this.dirty=false;this.isDown=false;this.isUp=true;this.totalTouches=0;this._holdSent=false;this._history.length=0;this._stateReset=true;if(this.targetObject){this.targetObject._releasedHandler(this)}this.targetObject=null},resetMovement:function(){this.movementX=0;this.movementY=0}};Phaser.Pointer.prototype.constructor=Phaser.Pointer;Object.defineProperty(Phaser.Pointer.prototype,"duration",{get:function(){if(this.isUp){return-1}return this.game.time.time-this.timeDown}});Object.defineProperty(Phaser.Pointer.prototype,"worldX",{get:function(){return this.game.world.camera.x+this.x}});Object.defineProperty(Phaser.Pointer.prototype,"worldY",{get:function(){return this.game.world.camera.y+this.y}});Phaser.Touch=function(game){this.game=game;this.enabled=true;this.callbackContext=this.game;this.touchStartCallback=null;this.touchMoveCallback=null;this.touchEndCallback=null;this.touchEnterCallback=null;this.touchLeaveCallback=null;this.touchCancelCallback=null;this.preventDefault=true;this.event=null;this._onTouchStart=null;this._onTouchMove=null;this._onTouchEnd=null;this._onTouchEnter=null;this._onTouchLeave=null;this._onTouchCancel=null;this._onTouchMove=null};Phaser.Touch.prototype={start:function(){if(this._onTouchStart!==null){return}var _this=this;if(this.game.device.touch){this._onTouchStart=function(event){return _this.onTouchStart(event)};this._onTouchMove=function(event){return _this.onTouchMove(event)};this._onTouchEnd=function(event){return _this.onTouchEnd(event)};this._onTouchEnter=function(event){return _this.onTouchEnter(event)};this._onTouchLeave=function(event){return _this.onTouchLeave(event)};this._onTouchCancel=function(event){return _this.onTouchCancel(event)};this.game.canvas.addEventListener("touchstart",this._onTouchStart,false);this.game.canvas.addEventListener("touchmove",this._onTouchMove,false);this.game.canvas.addEventListener("touchend",this._onTouchEnd,false);this.game.canvas.addEventListener("touchcancel",this._onTouchCancel,false);if(!this.game.device.cocoonJS){this.game.canvas.addEventListener("touchenter",this._onTouchEnter,false);this.game.canvas.addEventListener("touchleave",this._onTouchLeave,false)}}},consumeDocumentTouches:function(){this._documentTouchMove=function(event){event.preventDefault()};document.addEventListener("touchmove",this._documentTouchMove,false)},onTouchStart:function(event){this.event=event;if(this.touchStartCallback){this.touchStartCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}if(this.preventDefault){event.preventDefault()}for(var i=0;i<event.changedTouches.length;i++){this.game.input.startPointer(event.changedTouches[i])}},onTouchCancel:function(event){this.event=event;if(this.touchCancelCallback){this.touchCancelCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}if(this.preventDefault){event.preventDefault()}for(var i=0;i<event.changedTouches.length;i++){this.game.input.stopPointer(event.changedTouches[i])}},onTouchEnter:function(event){this.event=event;if(this.touchEnterCallback){this.touchEnterCallback.call(this.callbackContext,event)}if(!this.game.input.enabled||!this.enabled){return}if(this.preventDefault){event.preventDefault()}},onTouchLeave:function(event){this.event=event;if(this.touchLeaveCallback){this.touchLeaveCallback.call(this.callbackContext,event)}if(this.preventDefault){event.preventDefault()}},onTouchMove:function(event){this.event=event;if(this.touchMoveCallback){this.touchMoveCallback.call(this.callbackContext,event)}if(this.preventDefault){event.preventDefault()}for(var i=0;i<event.changedTouches.length;i++){this.game.input.updatePointer(event.changedTouches[i])}},onTouchEnd:function(event){this.event=event;if(this.touchEndCallback){this.touchEndCallback.call(this.callbackContext,event)}if(this.preventDefault){event.preventDefault()}for(var i=0;i<event.changedTouches.length;i++){this.game.input.stopPointer(event.changedTouches[i])}},stop:function(){if(this.game.device.touch){this.game.canvas.removeEventListener("touchstart",this._onTouchStart);this.game.canvas.removeEventListener("touchmove",this._onTouchMove);this.game.canvas.removeEventListener("touchend",this._onTouchEnd);this.game.canvas.removeEventListener("touchenter",this._onTouchEnter);this.game.canvas.removeEventListener("touchleave",this._onTouchLeave);this.game.canvas.removeEventListener("touchcancel",this._onTouchCancel)}}};Phaser.Touch.prototype.constructor=Phaser.Touch;Object.defineProperty(Phaser.Touch.prototype,"disabled",{get:function(){return!this.enabled},set:function(value){this.enabled=!value}});Phaser.InputHandler=function(sprite){this.sprite=sprite;this.game=sprite.game;this.enabled=false;this.checked=false;this.priorityID=0;this.useHandCursor=false;this._setHandCursor=false;this.isDragged=false;this.allowHorizontalDrag=true;this.allowVerticalDrag=true;this.bringToTop=false;this.snapOffset=null;this.snapOnDrag=false;this.snapOnRelease=false;this.snapX=0;this.snapY=0;this.snapOffsetX=0;this.snapOffsetY=0;this.pixelPerfectOver=false;this.pixelPerfectClick=false;this.pixelPerfectAlpha=255;this.draggable=false;this.boundsRect=null;this.boundsSprite=null;this.consumePointerEvent=false;this.scaleLayer=false;this.dragOffset=new Phaser.Point;this.dragFromCenter=false;this.dragStartPoint=new Phaser.Point;this._dragPoint=new Phaser.Point;this._dragPhase=false;this._wasEnabled=false;this._tempPoint=new Phaser.Point;this._pointerData=[];this._pointerData.push({id:0,x:0,y:0,isDown:false,isUp:false,isOver:false,isOut:false,timeOver:0,timeOut:0,timeDown:0,timeUp:0,downDuration:0,isDragged:false})};Phaser.InputHandler.prototype={start:function(priority,useHandCursor){priority=priority||0;if(typeof useHandCursor==="undefined"){useHandCursor=false}if(this.enabled===false){this.game.input.interactiveItems.add(this);this.useHandCursor=useHandCursor;this.priorityID=priority;for(var i=0;i<10;i++){this._pointerData[i]={id:i,x:0,y:0,isDown:false,isUp:false,isOver:false,isOut:false,timeOver:0,timeOut:0,timeDown:0,timeUp:0,downDuration:0,isDragged:false}}this.snapOffset=new Phaser.Point;this.enabled=true;this._wasEnabled=true}this.sprite.events.onAddedToGroup.add(this.addedToGroup,this);this.sprite.events.onRemovedFromGroup.add(this.removedFromGroup,this);this.flagged=false;return this.sprite},addedToGroup:function(){if(this._dragPhase){return}if(this._wasEnabled&&!this.enabled){this.start()}},removedFromGroup:function(){if(this._dragPhase){return}if(this.enabled){this._wasEnabled=true;this.stop()}else{this._wasEnabled=false}},reset:function(){this.enabled=false;this.flagged=false;for(var i=0;i<10;i++){this._pointerData[i]={id:i,x:0,y:0,isDown:false,isUp:false,isOver:false,isOut:false,timeOver:0,timeOut:0,timeDown:0,timeUp:0,downDuration:0,isDragged:false}}},stop:function(){if(this.enabled===false){return}else{this.enabled=false;this.game.input.interactiveItems.remove(this)}},destroy:function(){if(this.sprite){if(this._setHandCursor){this.game.canvas.style.cursor="default";this._setHandCursor=false}this.enabled=false;this.game.input.interactiveItems.remove(this);this._pointerData.length=0;this.boundsRect=null;this.boundsSprite=null;this.sprite=null}},validForInput:function(highestID,highestRenderID,includePixelPerfect){if(typeof includePixelPerfect==="undefined"){includePixelPerfect=true}if(this.sprite.scale.x===0||this.sprite.scale.y===0||this.priorityID<this.game.input.minPriorityID){return false}if(!includePixelPerfect&&(this.pixelPerfectClick||this.pixelPerfectOver)){return false}if(this.priorityID>highestID||this.priorityID===highestID&&this.sprite.renderOrderID<highestRenderID){return true}return false},isPixelPerfect:function(){return this.pixelPerfectClick||this.pixelPerfectOver},pointerX:function(pointer){pointer=pointer||0;return this._pointerData[pointer].x},pointerY:function(pointer){pointer=pointer||0;return this._pointerData[pointer].y},pointerDown:function(pointer){pointer=pointer||0;return this._pointerData[pointer].isDown},pointerUp:function(pointer){pointer=pointer||0;return this._pointerData[pointer].isUp},pointerTimeDown:function(pointer){pointer=pointer||0;return this._pointerData[pointer].timeDown},pointerTimeUp:function(pointer){pointer=pointer||0;return this._pointerData[pointer].timeUp},pointerOver:function(index){if(this.enabled){if(typeof index==="undefined"){for(var i=0;i<10;i++){if(this._pointerData[i].isOver){return true}}}else{return this._pointerData[index].isOver}}return false},pointerOut:function(index){if(this.enabled){if(typeof index==="undefined"){for(var i=0;i<10;i++){if(this._pointerData[i].isOut){return true}}}else{return this._pointerData[index].isOut}}return false},pointerTimeOver:function(pointer){pointer=pointer||0;return this._pointerData[pointer].timeOver},pointerTimeOut:function(pointer){pointer=pointer||0;return this._pointerData[pointer].timeOut},pointerDragged:function(pointer){pointer=pointer||0;return this._pointerData[pointer].isDragged},checkPointerDown:function(pointer,fastTest){if(!pointer.isDown||!this.enabled||!this.sprite||!this.sprite.parent||!this.sprite.visible||!this.sprite.parent.visible){return false}if(this.game.input.hitTest(this.sprite,pointer,this._tempPoint)){if(typeof fastTest==="undefined"){fastTest=false}if(!fastTest&&this.pixelPerfectClick){return this.checkPixel(this._tempPoint.x,this._tempPoint.y)}else{return true}}return false},checkPointerOver:function(pointer,fastTest){if(!this.enabled||!this.sprite||!this.sprite.parent||!this.sprite.visible||!this.sprite.parent.visible){return false}if(this.game.input.hitTest(this.sprite,pointer,this._tempPoint)){if(typeof fastTest==="undefined"){fastTest=false}if(!fastTest&&this.pixelPerfectOver){return this.checkPixel(this._tempPoint.x,this._tempPoint.y)}else{return true}}return false},checkPixel:function(x,y,pointer){if(this.sprite.texture.baseTexture.source){if(x===null&&y===null){this.game.input.getLocalPosition(this.sprite,pointer,this._tempPoint);var x=this._tempPoint.x;var y=this._tempPoint.y}if(this.sprite.anchor.x!==0){x-=-this.sprite.texture.frame.width*this.sprite.anchor.x}if(this.sprite.anchor.y!==0){y-=-this.sprite.texture.frame.height*this.sprite.anchor.y}x+=this.sprite.texture.frame.x;y+=this.sprite.texture.frame.y;if(this.sprite.texture.trim){x-=this.sprite.texture.trim.x;y-=this.sprite.texture.trim.y;if(x<this.sprite.texture.crop.x||x>this.sprite.texture.crop.right||y<this.sprite.texture.crop.y||y>this.sprite.texture.crop.bottom){this._dx=x;this._dy=y;return false}}this._dx=x;this._dy=y;this.game.input.hitContext.clearRect(0,0,1,1);this.game.input.hitContext.drawImage(this.sprite.texture.baseTexture.source,x,y,1,1,0,0,1,1);var rgb=this.game.input.hitContext.getImageData(0,0,1,1);if(rgb.data[3]>=this.pixelPerfectAlpha){return true}}return false},update:function(pointer){if(this.sprite===null||this.sprite.parent===undefined){return}if(!this.enabled||!this.sprite.visible||!this.sprite.parent.visible){this._pointerOutHandler(pointer);return false}if(this.draggable&&this._draggedPointerID===pointer.id){return this.updateDrag(pointer)}else if(this._pointerData[pointer.id].isOver){if(this.checkPointerOver(pointer)){this._pointerData[pointer.id].x=pointer.x-this.sprite.x;this._pointerData[pointer.id].y=pointer.y-this.sprite.y;return true}else{this._pointerOutHandler(pointer);return false}}},_pointerOverHandler:function(pointer){if(this.sprite===null){return}if(this._pointerData[pointer.id].isOver===false||pointer.dirty){this._pointerData[pointer.id].isOver=true;this._pointerData[pointer.id].isOut=false;this._pointerData[pointer.id].timeOver=this.game.time.time;this._pointerData[pointer.id].x=pointer.x-this.sprite.x;this._pointerData[pointer.id].y=pointer.y-this.sprite.y;if(this.useHandCursor&&this._pointerData[pointer.id].isDragged===false){this.game.canvas.style.cursor="pointer";this._setHandCursor=true}if(this.sprite&&this.sprite.events){this.sprite.events.onInputOver$dispatch(this.sprite,pointer)}}},_pointerOutHandler:function(pointer){if(this.sprite===null){return}this._pointerData[pointer.id].isOver=false;this._pointerData[pointer.id].isOut=true;this._pointerData[pointer.id].timeOut=this.game.time.time;if(this.useHandCursor&&this._pointerData[pointer.id].isDragged===false){this.game.canvas.style.cursor="default";this._setHandCursor=false}if(this.sprite&&this.sprite.events){this.sprite.events.onInputOut$dispatch(this.sprite,pointer)}},_touchedHandler:function(pointer){if(this.sprite===null){return}if(this._pointerData[pointer.id].isDown===false&&this._pointerData[pointer.id].isOver===true){if(this.pixelPerfectClick&&!this.checkPixel(null,null,pointer)){return}this._pointerData[pointer.id].isDown=true;this._pointerData[pointer.id].isUp=false;this._pointerData[pointer.id].timeDown=this.game.time.time;if(this.sprite&&this.sprite.events){this.sprite.events.onInputDown$dispatch(this.sprite,pointer)}pointer.dirty=true;if(this.draggable&&this.isDragged===false){this.startDrag(pointer)}if(this.bringToTop){this.sprite.bringToTop()}}return this.consumePointerEvent},_releasedHandler:function(pointer){if(this.sprite===null){return}if(this._pointerData[pointer.id].isDown&&pointer.isUp){this._pointerData[pointer.id].isDown=false;this._pointerData[pointer.id].isUp=true;this._pointerData[pointer.id].timeUp=this.game.time.time;this._pointerData[pointer.id].downDuration=this._pointerData[pointer.id].timeUp-this._pointerData[pointer.id].timeDown;if(this.checkPointerOver(pointer)){if(this.sprite&&this.sprite.events){this.sprite.events.onInputUp$dispatch(this.sprite,pointer,true)}}else{if(this.sprite&&this.sprite.events){this.sprite.events.onInputUp$dispatch(this.sprite,pointer,false)}if(this.useHandCursor){this.game.canvas.style.cursor="default";this._setHandCursor=false}}pointer.dirty=true;if(this.draggable&&this.isDragged&&this._draggedPointerID===pointer.id){this.stopDrag(pointer)}}},updateDrag:function(pointer){if(pointer.isUp){this.stopDrag(pointer);return false}var px=this.globalToLocalX(pointer.x)+this._dragPoint.x+this.dragOffset.x;var py=this.globalToLocalY(pointer.y)+this._dragPoint.y+this.dragOffset.y;if(this.sprite.fixedToCamera){if(this.allowHorizontalDrag){this.sprite.cameraOffset.x=px}if(this.allowVerticalDrag){this.sprite.cameraOffset.y=py}if(this.boundsRect){this.checkBoundsRect()}if(this.boundsSprite){this.checkBoundsSprite()}if(this.snapOnDrag){this.sprite.cameraOffset.x=Math.round((this.sprite.cameraOffset.x-this.snapOffsetX%this.snapX)/this.snapX)*this.snapX+this.snapOffsetX%this.snapX;this.sprite.cameraOffset.y=Math.round((this.sprite.cameraOffset.y-this.snapOffsetY%this.snapY)/this.snapY)*this.snapY+this.snapOffsetY%this.snapY}}else{if(this.allowHorizontalDrag){this.sprite.x=px}if(this.allowVerticalDrag){this.sprite.y=py}if(this.boundsRect){this.checkBoundsRect()}if(this.boundsSprite){this.checkBoundsSprite()}if(this.snapOnDrag){this.sprite.x=Math.round((this.sprite.x-this.snapOffsetX%this.snapX)/this.snapX)*this.snapX+this.snapOffsetX%this.snapX;this.sprite.y=Math.round((this.sprite.y-this.snapOffsetY%this.snapY)/this.snapY)*this.snapY+this.snapOffsetY%this.snapY}}return true},justOver:function(pointer,delay){pointer=pointer||0;delay=delay||500;return this._pointerData[pointer].isOver&&this.overDuration(pointer)<delay},justOut:function(pointer,delay){pointer=pointer||0;delay=delay||500;return this._pointerData[pointer].isOut&&this.game.time.time-this._pointerData[pointer].timeOut<delay},justPressed:function(pointer,delay){pointer=pointer||0;delay=delay||500;return this._pointerData[pointer].isDown&&this.downDuration(pointer)<delay},justReleased:function(pointer,delay){pointer=pointer||0;delay=delay||500;return this._pointerData[pointer].isUp&&this.game.time.time-this._pointerData[pointer].timeUp<delay},overDuration:function(pointer){pointer=pointer||0;if(this._pointerData[pointer].isOver){return this.game.time.time-this._pointerData[pointer].timeOver}return-1},downDuration:function(pointer){pointer=pointer||0;if(this._pointerData[pointer].isDown){return this.game.time.time-this._pointerData[pointer].timeDown}return-1},enableDrag:function(lockCenter,bringToTop,pixelPerfect,alphaThreshold,boundsRect,boundsSprite){if(typeof lockCenter==="undefined"){lockCenter=false}if(typeof bringToTop==="undefined"){bringToTop=false}if(typeof pixelPerfect==="undefined"){pixelPerfect=false}if(typeof alphaThreshold==="undefined"){alphaThreshold=255}if(typeof boundsRect==="undefined"){boundsRect=null}if(typeof boundsSprite==="undefined"){boundsSprite=null}this._dragPoint=new Phaser.Point;this.draggable=true;this.bringToTop=bringToTop;this.dragOffset=new Phaser.Point;this.dragFromCenter=lockCenter;this.pixelPerfectClick=pixelPerfect;this.pixelPerfectAlpha=alphaThreshold;if(boundsRect){this.boundsRect=boundsRect}if(boundsSprite){this.boundsSprite=boundsSprite}},disableDrag:function(){if(this._pointerData){for(var i=0;i<10;i++){this._pointerData[i].isDragged=false}}this.draggable=false;this.isDragged=false;this._draggedPointerID=-1},startDrag:function(pointer){var x=this.sprite.x;var y=this.sprite.y;this.isDragged=true;this._draggedPointerID=pointer.id;this._pointerData[pointer.id].isDragged=true;if(this.sprite.fixedToCamera){if(this.dragFromCenter){this.sprite.centerOn(pointer.x,pointer.y);this._dragPoint.setTo(this.sprite.cameraOffset.x-pointer.x,this.sprite.cameraOffset.y-pointer.y)}else{this._dragPoint.setTo(this.sprite.cameraOffset.x-pointer.x,this.sprite.cameraOffset.y-pointer.y)}}else{if(this.dragFromCenter){var bounds=this.sprite.getBounds();this.sprite.x=this.globalToLocalX(pointer.x)+(this.sprite.x-bounds.centerX);this.sprite.y=this.globalToLocalY(pointer.y)+(this.sprite.y-bounds.centerY)}this._dragPoint.setTo(this.sprite.x-this.globalToLocalX(pointer.x),this.sprite.y-this.globalToLocalY(pointer.y))}this.updateDrag(pointer);if(this.bringToTop){this._dragPhase=true;this.sprite.bringToTop()}this.dragStartPoint.set(x,y);this.sprite.events.onDragStart$dispatch(this.sprite,pointer,x,y)},globalToLocalX:function(x){if(this.scaleLayer){x-=this.game.scale.grid.boundsFluid.x;x*=this.game.scale.grid.scaleFluidInversed.x}return x},globalToLocalY:function(y){if(this.scaleLayer){y-=this.game.scale.grid.boundsFluid.y;y*=this.game.scale.grid.scaleFluidInversed.y}return y},stopDrag:function(pointer){this.isDragged=false;this._draggedPointerID=-1;this._pointerData[pointer.id].isDragged=false;this._dragPhase=false;if(this.snapOnRelease){if(this.sprite.fixedToCamera){this.sprite.cameraOffset.x=Math.round((this.sprite.cameraOffset.x-this.snapOffsetX%this.snapX)/this.snapX)*this.snapX+this.snapOffsetX%this.snapX;this.sprite.cameraOffset.y=Math.round((this.sprite.cameraOffset.y-this.snapOffsetY%this.snapY)/this.snapY)*this.snapY+this.snapOffsetY%this.snapY}else{this.sprite.x=Math.round((this.sprite.x-this.snapOffsetX%this.snapX)/this.snapX)*this.snapX+this.snapOffsetX%this.snapX;this.sprite.y=Math.round((this.sprite.y-this.snapOffsetY%this.snapY)/this.snapY)*this.snapY+this.snapOffsetY%this.snapY}}this.sprite.events.onDragStop$dispatch(this.sprite,pointer);if(this.checkPointerOver(pointer)===false){this._pointerOutHandler(pointer)}},setDragLock:function(allowHorizontal,allowVertical){if(typeof allowHorizontal==="undefined"){allowHorizontal=true}if(typeof allowVertical==="undefined"){allowVertical=true}this.allowHorizontalDrag=allowHorizontal;this.allowVerticalDrag=allowVertical},enableSnap:function(snapX,snapY,onDrag,onRelease,snapOffsetX,snapOffsetY){if(typeof onDrag==="undefined"){onDrag=true}if(typeof onRelease==="undefined"){onRelease=false}if(typeof snapOffsetX==="undefined"){snapOffsetX=0}if(typeof snapOffsetY==="undefined"){snapOffsetY=0}this.snapX=snapX;this.snapY=snapY;this.snapOffsetX=snapOffsetX;this.snapOffsetY=snapOffsetY;this.snapOnDrag=onDrag;this.snapOnRelease=onRelease},disableSnap:function(){this.snapOnDrag=false;this.snapOnRelease=false},checkBoundsRect:function(){if(this.sprite.fixedToCamera){if(this.sprite.cameraOffset.x<this.boundsRect.left){this.sprite.cameraOffset.x=this.boundsRect.left}else if(this.sprite.cameraOffset.x+this.sprite.width>this.boundsRect.right){this.sprite.cameraOffset.x=this.boundsRect.right-this.sprite.width}if(this.sprite.cameraOffset.y<this.boundsRect.top){this.sprite.cameraOffset.y=this.boundsRect.top}else if(this.sprite.cameraOffset.y+this.sprite.height>this.boundsRect.bottom){this.sprite.cameraOffset.y=this.boundsRect.bottom-this.sprite.height}}else{if(this.sprite.left<this.boundsRect.left){this.sprite.x=this.boundsRect.x+this.sprite.offsetX}else if(this.sprite.right>this.boundsRect.right){this.sprite.x=this.boundsRect.right-(this.sprite.width-this.sprite.offsetX)}if(this.sprite.top<this.boundsRect.top){this.sprite.y=this.boundsRect.top+this.sprite.offsetY}else if(this.sprite.bottom>this.boundsRect.bottom){this.sprite.y=this.boundsRect.bottom-(this.sprite.height-this.sprite.offsetY)}}},checkBoundsSprite:function(){if(this.sprite.fixedToCamera&&this.boundsSprite.fixedToCamera){if(this.sprite.cameraOffset.x<this.boundsSprite.cameraOffset.x){this.sprite.cameraOffset.x=this.boundsSprite.cameraOffset.x}else if(this.sprite.cameraOffset.x+this.sprite.width>this.boundsSprite.cameraOffset.x+this.boundsSprite.width){this.sprite.cameraOffset.x=this.boundsSprite.cameraOffset.x+this.boundsSprite.width-this.sprite.width}if(this.sprite.cameraOffset.y<this.boundsSprite.cameraOffset.y){this.sprite.cameraOffset.y=this.boundsSprite.cameraOffset.y}else if(this.sprite.cameraOffset.y+this.sprite.height>this.boundsSprite.cameraOffset.y+this.boundsSprite.height){this.sprite.cameraOffset.y=this.boundsSprite.cameraOffset.y+this.boundsSprite.height-this.sprite.height}}else{if(this.sprite.left<this.boundsSprite.left){this.sprite.x=this.boundsSprite.left+this.sprite.offsetX}else if(this.sprite.right>this.boundsSprite.right){this.sprite.x=this.boundsSprite.right-(this.sprite.width-this.sprite.offsetX)}if(this.sprite.top<this.boundsSprite.top){this.sprite.y=this.boundsSprite.top+this.sprite.offsetY}else if(this.sprite.bottom>this.boundsSprite.bottom){this.sprite.y=this.boundsSprite.bottom-(this.sprite.height-this.sprite.offsetY)
}}}};Phaser.InputHandler.prototype.constructor=Phaser.InputHandler;Phaser.Gamepad=function(game){this.game=game;this._gamepadIndexMap={};this._rawPads=[];this._active=false;this.enabled=true;this._gamepadSupportAvailable=!!navigator.webkitGetGamepads||!!navigator.webkitGamepads||navigator.userAgent.indexOf("Firefox/")!=-1||!!navigator.getGamepads;this._prevRawGamepadTypes=[];this._prevTimestamps=[];this.callbackContext=this;this.onConnectCallback=null;this.onDisconnectCallback=null;this.onDownCallback=null;this.onUpCallback=null;this.onAxisCallback=null;this.onFloatCallback=null;this._ongamepadconnected=null;this._gamepaddisconnected=null;this._gamepads=[new Phaser.SinglePad(game,this),new Phaser.SinglePad(game,this),new Phaser.SinglePad(game,this),new Phaser.SinglePad(game,this)]};Phaser.Gamepad.prototype={addCallbacks:function(context,callbacks){if(typeof callbacks!=="undefined"){this.onConnectCallback=typeof callbacks.onConnect==="function"?callbacks.onConnect:this.onConnectCallback;this.onDisconnectCallback=typeof callbacks.onDisconnect==="function"?callbacks.onDisconnect:this.onDisconnectCallback;this.onDownCallback=typeof callbacks.onDown==="function"?callbacks.onDown:this.onDownCallback;this.onUpCallback=typeof callbacks.onUp==="function"?callbacks.onUp:this.onUpCallback;this.onAxisCallback=typeof callbacks.onAxis==="function"?callbacks.onAxis:this.onAxisCallback;this.onFloatCallback=typeof callbacks.onFloat==="function"?callbacks.onFloat:this.onFloatCallback;this.callbackContext=context}},start:function(){if(this._active){return}this._active=true;var _this=this;this._onGamepadConnected=function(event){return _this.onGamepadConnected(event)};this._onGamepadDisconnected=function(event){return _this.onGamepadDisconnected(event)};window.addEventListener("gamepadconnected",this._onGamepadConnected,false);window.addEventListener("gamepaddisconnected",this._onGamepadDisconnected,false)},onGamepadConnected:function(event){var newPad=event.gamepad;this._rawPads.push(newPad);this._gamepads[newPad.index].connect(newPad)},onGamepadDisconnected:function(event){var removedPad=event.gamepad;for(var i in this._rawPads){if(this._rawPads[i].index===removedPad.index){this._rawPads.splice(i,1)}}this._gamepads[removedPad.index].disconnect()},update:function(){this._pollGamepads();this.pad1.pollStatus();this.pad2.pollStatus();this.pad3.pollStatus();this.pad4.pollStatus()},_pollGamepads:function(){if(navigator["getGamepads"]){var rawGamepads=navigator.getGamepads()}else if(navigator["webkitGetGamepads"]){var rawGamepads=navigator.webkitGetGamepads()}else if(navigator["webkitGamepads"]){var rawGamepads=navigator.webkitGamepads()}if(rawGamepads){this._rawPads=[];var gamepadsChanged=false;for(var i=0;i<rawGamepads.length;i++){if(typeof rawGamepads[i]!==this._prevRawGamepadTypes[i]){gamepadsChanged=true;this._prevRawGamepadTypes[i]=typeof rawGamepads[i]}if(rawGamepads[i]){this._rawPads.push(rawGamepads[i])}if(i===3){break}}if(gamepadsChanged){var validConnections={rawIndices:{},padIndices:{}};var singlePad;for(var j=0;j<this._gamepads.length;j++){singlePad=this._gamepads[j];if(singlePad.connected){for(var k=0;k<this._rawPads.length;k++){if(this._rawPads[k].index===singlePad.index){validConnections.rawIndices[singlePad.index]=true;validConnections.padIndices[j]=true}}}}for(var l=0;l<this._gamepads.length;l++){singlePad=this._gamepads[l];if(validConnections.padIndices[l]){continue}if(this._rawPads.length<1){singlePad.disconnect()}for(var m=0;m<this._rawPads.length;m++){if(validConnections.padIndices[l]){break}var rawPad=this._rawPads[m];if(rawPad){if(validConnections.rawIndices[rawPad.index]){singlePad.disconnect();continue}else{singlePad.connect(rawPad);validConnections.rawIndices[rawPad.index]=true;validConnections.padIndices[l]=true}}else{singlePad.disconnect()}}}}}},setDeadZones:function(value){for(var i=0;i<this._gamepads.length;i++){this._gamepads[i].deadZone=value}},stop:function(){this._active=false;window.removeEventListener("gamepadconnected",this._onGamepadConnected);window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnected)},reset:function(){this.update();for(var i=0;i<this._gamepads.length;i++){this._gamepads[i].reset()}},justPressed:function(buttonCode,duration){for(var i=0;i<this._gamepads.length;i++){if(this._gamepads[i].justPressed(buttonCode,duration)===true){return true}}return false},justReleased:function(buttonCode,duration){for(var i=0;i<this._gamepads.length;i++){if(this._gamepads[i].justReleased(buttonCode,duration)===true){return true}}return false},isDown:function(buttonCode){for(var i=0;i<this._gamepads.length;i++){if(this._gamepads[i].isDown(buttonCode)===true){return true}}return false},destroy:function(){this.stop();for(var i=0;i<this._gamepads.length;i++){this._gamepads[i].destroy()}}};Phaser.Gamepad.prototype.constructor=Phaser.Gamepad;Object.defineProperty(Phaser.Gamepad.prototype,"disabled",{get:function(){return!this.enabled},set:function(value){this.enabled=!value}});Object.defineProperty(Phaser.Gamepad.prototype,"active",{get:function(){return this._active}});Object.defineProperty(Phaser.Gamepad.prototype,"supported",{get:function(){return this._gamepadSupportAvailable}});Object.defineProperty(Phaser.Gamepad.prototype,"padsConnected",{get:function(){return this._rawPads.length}});Object.defineProperty(Phaser.Gamepad.prototype,"pad1",{get:function(){return this._gamepads[0]}});Object.defineProperty(Phaser.Gamepad.prototype,"pad2",{get:function(){return this._gamepads[1]}});Object.defineProperty(Phaser.Gamepad.prototype,"pad3",{get:function(){return this._gamepads[2]}});Object.defineProperty(Phaser.Gamepad.prototype,"pad4",{get:function(){return this._gamepads[3]}});Phaser.Gamepad.BUTTON_0=0;Phaser.Gamepad.BUTTON_1=1;Phaser.Gamepad.BUTTON_2=2;Phaser.Gamepad.BUTTON_3=3;Phaser.Gamepad.BUTTON_4=4;Phaser.Gamepad.BUTTON_5=5;Phaser.Gamepad.BUTTON_6=6;Phaser.Gamepad.BUTTON_7=7;Phaser.Gamepad.BUTTON_8=8;Phaser.Gamepad.BUTTON_9=9;Phaser.Gamepad.BUTTON_10=10;Phaser.Gamepad.BUTTON_11=11;Phaser.Gamepad.BUTTON_12=12;Phaser.Gamepad.BUTTON_13=13;Phaser.Gamepad.BUTTON_14=14;Phaser.Gamepad.BUTTON_15=15;Phaser.Gamepad.AXIS_0=0;Phaser.Gamepad.AXIS_1=1;Phaser.Gamepad.AXIS_2=2;Phaser.Gamepad.AXIS_3=3;Phaser.Gamepad.AXIS_4=4;Phaser.Gamepad.AXIS_5=5;Phaser.Gamepad.AXIS_6=6;Phaser.Gamepad.AXIS_7=7;Phaser.Gamepad.AXIS_8=8;Phaser.Gamepad.AXIS_9=9;Phaser.Gamepad.XBOX360_A=0;Phaser.Gamepad.XBOX360_B=1;Phaser.Gamepad.XBOX360_X=2;Phaser.Gamepad.XBOX360_Y=3;Phaser.Gamepad.XBOX360_LEFT_BUMPER=4;Phaser.Gamepad.XBOX360_RIGHT_BUMPER=5;Phaser.Gamepad.XBOX360_LEFT_TRIGGER=6;Phaser.Gamepad.XBOX360_RIGHT_TRIGGER=7;Phaser.Gamepad.XBOX360_BACK=8;Phaser.Gamepad.XBOX360_START=9;Phaser.Gamepad.XBOX360_STICK_LEFT_BUTTON=10;Phaser.Gamepad.XBOX360_STICK_RIGHT_BUTTON=11;Phaser.Gamepad.XBOX360_DPAD_LEFT=14;Phaser.Gamepad.XBOX360_DPAD_RIGHT=15;Phaser.Gamepad.XBOX360_DPAD_UP=12;Phaser.Gamepad.XBOX360_DPAD_DOWN=13;Phaser.Gamepad.XBOX360_STICK_LEFT_X=0;Phaser.Gamepad.XBOX360_STICK_LEFT_Y=1;Phaser.Gamepad.XBOX360_STICK_RIGHT_X=2;Phaser.Gamepad.XBOX360_STICK_RIGHT_Y=3;Phaser.Gamepad.PS3XC_X=0;Phaser.Gamepad.PS3XC_CIRCLE=1;Phaser.Gamepad.PS3XC_SQUARE=2;Phaser.Gamepad.PS3XC_TRIANGLE=3;Phaser.Gamepad.PS3XC_L1=4;Phaser.Gamepad.PS3XC_R1=5;Phaser.Gamepad.PS3XC_L2=6;Phaser.Gamepad.PS3XC_R2=7;Phaser.Gamepad.PS3XC_SELECT=8;Phaser.Gamepad.PS3XC_START=9;Phaser.Gamepad.PS3XC_STICK_LEFT_BUTTON=10;Phaser.Gamepad.PS3XC_STICK_RIGHT_BUTTON=11;Phaser.Gamepad.PS3XC_DPAD_UP=12;Phaser.Gamepad.PS3XC_DPAD_DOWN=13;Phaser.Gamepad.PS3XC_DPAD_LEFT=14;Phaser.Gamepad.PS3XC_DPAD_RIGHT=15;Phaser.Gamepad.PS3XC_STICK_LEFT_X=0;Phaser.Gamepad.PS3XC_STICK_LEFT_Y=1;Phaser.Gamepad.PS3XC_STICK_RIGHT_X=2;Phaser.Gamepad.PS3XC_STICK_RIGHT_Y=3;Phaser.SinglePad=function(game,padParent){this.game=game;this.index=null;this.connected=false;this.callbackContext=this;this.onConnectCallback=null;this.onDisconnectCallback=null;this.onDownCallback=null;this.onUpCallback=null;this.onAxisCallback=null;this.onFloatCallback=null;this.deadZone=.26;this._padParent=padParent;this._rawPad=null;this._prevTimestamp=null;this._buttons=[];this._buttonsLen=0;this._axes=[];this._axesLen=0};Phaser.SinglePad.prototype={addCallbacks:function(context,callbacks){if(typeof callbacks!=="undefined"){this.onConnectCallback=typeof callbacks.onConnect==="function"?callbacks.onConnect:this.onConnectCallback;this.onDisconnectCallback=typeof callbacks.onDisconnect==="function"?callbacks.onDisconnect:this.onDisconnectCallback;this.onDownCallback=typeof callbacks.onDown==="function"?callbacks.onDown:this.onDownCallback;this.onUpCallback=typeof callbacks.onUp==="function"?callbacks.onUp:this.onUpCallback;this.onAxisCallback=typeof callbacks.onAxis==="function"?callbacks.onAxis:this.onAxisCallback;this.onFloatCallback=typeof callbacks.onFloat==="function"?callbacks.onFloat:this.onFloatCallback}},getButton:function(buttonCode){if(this._buttons[buttonCode]){return this._buttons[buttonCode]}else{return null}},pollStatus:function(){if(!this.connected||!this.game.input.enabled||!this.game.input.gamepad.enabled||this._rawPad.timestamp&&this._rawPad.timestamp===this._prevTimestamp){return}for(var i=0;i<this._buttonsLen;i++){var rawButtonVal=isNaN(this._rawPad.buttons[i])?this._rawPad.buttons[i].value:this._rawPad.buttons[i];if(rawButtonVal!==this._buttons[i].value){if(rawButtonVal===1){this.processButtonDown(i,rawButtonVal)}else if(rawButtonVal===0){this.processButtonUp(i,rawButtonVal)}else{this.processButtonFloat(i,rawButtonVal)}}}for(var index=0;index<this._axesLen;index++){var value=this._rawPad.axes[index];if(value>0&&value>this.deadZone||value<0&&value<-this.deadZone){this.processAxisChange(index,value)}else{this.processAxisChange(index,0)}}this._prevTimestamp=this._rawPad.timestamp},connect:function(rawPad){var triggerCallback=!this.connected;this.connected=true;this.index=rawPad.index;this._rawPad=rawPad;this._buttons=[];this._buttonsLen=rawPad.buttons.length;this._axes=[];this._axesLen=rawPad.axes.length;for(var a=0;a<this._axesLen;a++){this._axes[a]=rawPad.axes[a]}for(var buttonCode in rawPad.buttons){buttonCode=parseInt(buttonCode,10);this._buttons[buttonCode]=new Phaser.GamepadButton(this,buttonCode)}if(triggerCallback&&this._padParent.onConnectCallback){this._padParent.onConnectCallback.call(this._padParent.callbackContext,this.index)}if(triggerCallback&&this.onConnectCallback){this.onConnectCallback.call(this.callbackContext)}},disconnect:function(){var triggerCallback=this.connected;var disconnectingIndex=this.index;this.connected=false;this.index=null;this._rawPad=undefined;for(var i=0;i<this._buttonsLen;i++){this._buttons[i].destroy()}this._buttons=[];this._buttonsLen=0;this._axes=[];this._axesLen=0;if(triggerCallback&&this._padParent.onDisconnectCallback){this._padParent.onDisconnectCallback.call(this._padParent.callbackContext,disconnectingIndex)}if(triggerCallback&&this.onDisconnectCallback){this.onDisconnectCallback.call(this.callbackContext)}},destroy:function(){this._rawPad=undefined;for(var i=0;i<this._buttonsLen;i++){this._buttons[i].destroy()}this._buttons=[];this._buttonsLen=0;this._axes=[];this._axesLen=0;this.onConnectCallback=null;this.onDisconnectCallback=null;this.onDownCallback=null;this.onUpCallback=null;this.onAxisCallback=null;this.onFloatCallback=null},processAxisChange:function(index,value){if(this._axes[index]===value){return}this._axes[index]=value;if(this._padParent.onAxisCallback){this._padParent.onAxisCallback.call(this._padParent.callbackContext,this,index,value)}if(this.onAxisCallback){this.onAxisCallback.call(this.callbackContext,this,index,value)}},processButtonDown:function(buttonCode,value){if(this._padParent.onDownCallback){this._padParent.onDownCallback.call(this._padParent.callbackContext,buttonCode,value,this.index)}if(this.onDownCallback){this.onDownCallback.call(this.callbackContext,buttonCode,value)}if(this._buttons[buttonCode]){this._buttons[buttonCode].processButtonDown(value)}},processButtonUp:function(buttonCode,value){if(this._padParent.onUpCallback){this._padParent.onUpCallback.call(this._padParent.callbackContext,buttonCode,value,this.index)}if(this.onUpCallback){this.onUpCallback.call(this.callbackContext,buttonCode,value)}if(this._buttons[buttonCode]){this._buttons[buttonCode].processButtonUp(value)}},processButtonFloat:function(buttonCode,value){if(this._padParent.onFloatCallback){this._padParent.onFloatCallback.call(this._padParent.callbackContext,buttonCode,value,this.index)}if(this.onFloatCallback){this.onFloatCallback.call(this.callbackContext,buttonCode,value)}if(this._buttons[buttonCode]){this._buttons[buttonCode].processButtonFloat(value)}},axis:function(axisCode){if(this._axes[axisCode]){return this._axes[axisCode]}return false},isDown:function(buttonCode){if(this._buttons[buttonCode]){return this._buttons[buttonCode].isDown}return false},isUp:function(buttonCode){if(this._buttons[buttonCode]){return this._buttons[buttonCode].isUp}return false},justReleased:function(buttonCode,duration){if(this._buttons[buttonCode]){return this._buttons[buttonCode].justReleased(duration)}},justPressed:function(buttonCode,duration){if(this._buttons[buttonCode]){return this._buttons[buttonCode].justPressed(duration)}},buttonValue:function(buttonCode){if(this._buttons[buttonCode]){return this._buttons[buttonCode].value}return null},reset:function(){for(var j=0;j<this._axes.length;j++){this._axes[j]=0}}};Phaser.SinglePad.prototype.constructor=Phaser.SinglePad;Phaser.GamepadButton=function(pad,buttonCode){this.pad=pad;this.game=pad.game;this.isDown=false;this.isUp=true;this.timeDown=0;this.duration=0;this.timeUp=0;this.repeats=0;this.value=0;this.buttonCode=buttonCode;this.onDown=new Phaser.Signal;this.onUp=new Phaser.Signal;this.onFloat=new Phaser.Signal};Phaser.GamepadButton.prototype={processButtonDown:function(value){this.isDown=true;this.isUp=false;this.timeDown=this.game.time.time;this.duration=0;this.repeats=0;this.value=value;this.onDown.dispatch(this,value)},processButtonUp:function(value){this.isDown=false;this.isUp=true;this.timeUp=this.game.time.time;this.value=value;this.onUp.dispatch(this,value)},processButtonFloat:function(value){this.value=value;this.onFloat.dispatch(this,value)},justPressed:function(duration){duration=duration||250;return this.isDown===true&&this.timeDown+duration>this.game.time.time},justReleased:function(duration){duration=duration||250;return this.isUp===true&&this.timeUp+duration>this.game.time.time},reset:function(){this.isDown=false;this.isUp=true;this.timeDown=this.game.time.time;this.duration=0;this.repeats=0},destroy:function(){this.onDown.dispose();this.onUp.dispose();this.onFloat.dispose();this.pad=null;this.game=null}};Phaser.GamepadButton.prototype.constructor=Phaser.GamepadButton;Phaser.Key=function(game,keycode){this.game=game;this._enabled=true;this.event=null;this.isDown=false;this.isUp=true;this.altKey=false;this.ctrlKey=false;this.shiftKey=false;this.timeDown=0;this.duration=0;this.timeUp=-2500;this.repeats=0;this.keyCode=keycode;this.onDown=new Phaser.Signal;this.onHoldCallback=null;this.onHoldContext=null;this.onUp=new Phaser.Signal;this._justDown=false;this._justUp=false};Phaser.Key.prototype={update:function(){if(!this._enabled){return}if(this.isDown){this.duration=this.game.time.time-this.timeDown;this.repeats++;if(this.onHoldCallback){this.onHoldCallback.call(this.onHoldContext,this)}}},processKeyDown:function(event){if(!this._enabled){return}this.event=event;if(this.isDown){return}this.altKey=event.altKey;this.ctrlKey=event.ctrlKey;this.shiftKey=event.shiftKey;this.isDown=true;this.isUp=false;this.timeDown=this.game.time.time;this.duration=0;this.repeats=0;this._justDown=true;this.onDown.dispatch(this)},processKeyUp:function(event){if(!this._enabled){return}this.event=event;if(this.isUp){return}this.isDown=false;this.isUp=true;this.timeUp=this.game.time.time;this.duration=this.game.time.time-this.timeDown;this._justUp=true;this.onUp.dispatch(this)},reset:function(hard){if(typeof hard==="undefined"){hard=true}this.isDown=false;this.isUp=true;this.timeUp=this.game.time.time;this.duration=0;this._enabled=true;this._justDown=false;this._justUp=false;if(hard){this.onDown.removeAll();this.onUp.removeAll();this.onHoldCallback=null;this.onHoldContext=null}},downDuration:function(duration){if(typeof duration==="undefined"){duration=50}return this.isDown&&this.duration<duration},upDuration:function(duration){if(typeof duration==="undefined"){duration=50}return!this.isDown&&this.game.time.time-this.timeUp<duration}};Object.defineProperty(Phaser.Key.prototype,"justDown",{get:function(){var current=this._justDown;this._justDown=false;return current}});Object.defineProperty(Phaser.Key.prototype,"justUp",{get:function(){var current=this._justUp;this._justUp=false;return current}});Object.defineProperty(Phaser.Key.prototype,"enabled",{get:function(){return this._enabled},set:function(value){value=!!value;if(value!==this._enabled){if(!value){this.reset(false)}this._enabled=value}}});Phaser.Key.prototype.constructor=Phaser.Key;Phaser.Keyboard=function(game){this.game=game;this.enabled=true;this.event=null;this.pressEvent=null;this.callbackContext=this;this.onDownCallback=null;this.onPressCallback=null;this.onUpCallback=null;this._keys=[];this._capture=[];this._onKeyDown=null;this._onKeyPress=null;this._onKeyUp=null;this._i=0;this._k=0};Phaser.Keyboard.prototype={addCallbacks:function(context,onDown,onUp,onPress){this.callbackContext=context;if(typeof onDown!=="undefined"){this.onDownCallback=onDown}if(typeof onUp!=="undefined"){this.onUpCallback=onUp}if(typeof onPress!=="undefined"){this.onPressCallback=onPress}},addKey:function(keycode){if(!this._keys[keycode]){this._keys[keycode]=new Phaser.Key(this.game,keycode);this.addKeyCapture(keycode)}return this._keys[keycode]},removeKey:function(keycode){if(this._keys[keycode]){this._keys[keycode]=null;this.removeKeyCapture(keycode)}},createCursorKeys:function(){return{up:this.addKey(Phaser.Keyboard.UP),down:this.addKey(Phaser.Keyboard.DOWN),left:this.addKey(Phaser.Keyboard.LEFT),right:this.addKey(Phaser.Keyboard.RIGHT)}},start:function(){if(this.game.device.cocoonJS){return}if(this._onKeyDown!==null){return}var _this=this;this._onKeyDown=function(event){return _this.processKeyDown(event)};this._onKeyUp=function(event){return _this.processKeyUp(event)};this._onKeyPress=function(event){return _this.processKeyPress(event)};window.addEventListener("keydown",this._onKeyDown,false);window.addEventListener("keyup",this._onKeyUp,false);window.addEventListener("keypress",this._onKeyPress,false)},stop:function(){window.removeEventListener("keydown",this._onKeyDown);window.removeEventListener("keyup",this._onKeyUp);window.removeEventListener("keypress",this._onKeyPress);this._onKeyDown=null;this._onKeyUp=null;this._onKeyPress=null},destroy:function(){this.stop();this.clearCaptures();this._keys.length=0;this._i=0},addKeyCapture:function(keycode){if(typeof keycode==="object"){for(var key in keycode){this._capture[keycode[key]]=true}}else{this._capture[keycode]=true}},removeKeyCapture:function(keycode){delete this._capture[keycode]},clearCaptures:function(){this._capture={}},update:function(){this._i=this._keys.length;while(this._i--){if(this._keys[this._i]){this._keys[this._i].update()}}},processKeyDown:function(event){this.event=event;if(!this.game.input.enabled||!this.enabled){return}if(this._capture[event.keyCode]){event.preventDefault()}if(!this._keys[event.keyCode]){this._keys[event.keyCode]=new Phaser.Key(this.game,event.keyCode)}this._keys[event.keyCode].processKeyDown(event);this._k=event.keyCode;if(this.onDownCallback){this.onDownCallback.call(this.callbackContext,event)}},processKeyPress:function(event){this.pressEvent=event;if(!this.game.input.enabled||!this.enabled){return}if(this.onPressCallback){this.onPressCallback.call(this.callbackContext,String.fromCharCode(event.charCode),event)}},processKeyUp:function(event){this.event=event;if(!this.game.input.enabled||!this.enabled){return}if(this._capture[event.keyCode]){event.preventDefault()}if(!this._keys[event.keyCode]){this._keys[event.keyCode]=new Phaser.Key(this.game,event.keyCode)}this._keys[event.keyCode].processKeyUp(event);if(this.onUpCallback){this.onUpCallback.call(this.callbackContext,event)}},reset:function(hard){if(typeof hard==="undefined"){hard=true}this.event=null;var i=this._keys.length;while(i--){if(this._keys[i]){this._keys[i].reset(hard)}}},downDuration:function(keycode,duration){if(this._keys[keycode]){return this._keys[keycode].downDuration(duration)}else{return null}},upDuration:function(keycode,duration){if(this._keys[keycode]){return this._keys[keycode].upDuration(duration)}else{return null}},isDown:function(keycode){if(this._keys[keycode]){return this._keys[keycode].isDown}else{return null}}};Object.defineProperty(Phaser.Keyboard.prototype,"disabled",{get:function(){return!this.enabled},set:function(value){this.enabled=!value}});Object.defineProperty(Phaser.Keyboard.prototype,"lastChar",{get:function(){if(this.event.charCode===32){return""}else{return String.fromCharCode(this.pressEvent.charCode)}}});Object.defineProperty(Phaser.Keyboard.prototype,"lastKey",{get:function(){return this._keys[this._k]}});Phaser.Keyboard.prototype.constructor=Phaser.Keyboard;Phaser.Keyboard.A="A".charCodeAt(0);Phaser.Keyboard.B="B".charCodeAt(0);Phaser.Keyboard.C="C".charCodeAt(0);Phaser.Keyboard.D="D".charCodeAt(0);Phaser.Keyboard.E="E".charCodeAt(0);Phaser.Keyboard.F="F".charCodeAt(0);Phaser.Keyboard.G="G".charCodeAt(0);Phaser.Keyboard.H="H".charCodeAt(0);Phaser.Keyboard.I="I".charCodeAt(0);Phaser.Keyboard.J="J".charCodeAt(0);Phaser.Keyboard.K="K".charCodeAt(0);Phaser.Keyboard.L="L".charCodeAt(0);Phaser.Keyboard.M="M".charCodeAt(0);Phaser.Keyboard.N="N".charCodeAt(0);Phaser.Keyboard.O="O".charCodeAt(0);Phaser.Keyboard.P="P".charCodeAt(0);Phaser.Keyboard.Q="Q".charCodeAt(0);Phaser.Keyboard.R="R".charCodeAt(0);Phaser.Keyboard.S="S".charCodeAt(0);Phaser.Keyboard.T="T".charCodeAt(0);Phaser.Keyboard.U="U".charCodeAt(0);Phaser.Keyboard.V="V".charCodeAt(0);Phaser.Keyboard.W="W".charCodeAt(0);Phaser.Keyboard.X="X".charCodeAt(0);Phaser.Keyboard.Y="Y".charCodeAt(0);Phaser.Keyboard.Z="Z".charCodeAt(0);Phaser.Keyboard.ZERO="0".charCodeAt(0);Phaser.Keyboard.ONE="1".charCodeAt(0);Phaser.Keyboard.TWO="2".charCodeAt(0);Phaser.Keyboard.THREE="3".charCodeAt(0);Phaser.Keyboard.FOUR="4".charCodeAt(0);Phaser.Keyboard.FIVE="5".charCodeAt(0);Phaser.Keyboard.SIX="6".charCodeAt(0);Phaser.Keyboard.SEVEN="7".charCodeAt(0);Phaser.Keyboard.EIGHT="8".charCodeAt(0);Phaser.Keyboard.NINE="9".charCodeAt(0);Phaser.Keyboard.NUMPAD_0=96;Phaser.Keyboard.NUMPAD_1=97;Phaser.Keyboard.NUMPAD_2=98;Phaser.Keyboard.NUMPAD_3=99;Phaser.Keyboard.NUMPAD_4=100;Phaser.Keyboard.NUMPAD_5=101;Phaser.Keyboard.NUMPAD_6=102;Phaser.Keyboard.NUMPAD_7=103;Phaser.Keyboard.NUMPAD_8=104;Phaser.Keyboard.NUMPAD_9=105;Phaser.Keyboard.NUMPAD_MULTIPLY=106;Phaser.Keyboard.NUMPAD_ADD=107;Phaser.Keyboard.NUMPAD_ENTER=108;Phaser.Keyboard.NUMPAD_SUBTRACT=109;Phaser.Keyboard.NUMPAD_DECIMAL=110;Phaser.Keyboard.NUMPAD_DIVIDE=111;Phaser.Keyboard.F1=112;Phaser.Keyboard.F2=113;Phaser.Keyboard.F3=114;Phaser.Keyboard.F4=115;Phaser.Keyboard.F5=116;Phaser.Keyboard.F6=117;Phaser.Keyboard.F7=118;Phaser.Keyboard.F8=119;Phaser.Keyboard.F9=120;Phaser.Keyboard.F10=121;Phaser.Keyboard.F11=122;Phaser.Keyboard.F12=123;Phaser.Keyboard.F13=124;Phaser.Keyboard.F14=125;Phaser.Keyboard.F15=126;Phaser.Keyboard.COLON=186;Phaser.Keyboard.EQUALS=187;Phaser.Keyboard.UNDERSCORE=189;Phaser.Keyboard.QUESTION_MARK=191;Phaser.Keyboard.TILDE=192;Phaser.Keyboard.OPEN_BRACKET=219;Phaser.Keyboard.BACKWARD_SLASH=220;Phaser.Keyboard.CLOSED_BRACKET=221;Phaser.Keyboard.QUOTES=222;Phaser.Keyboard.BACKSPACE=8;Phaser.Keyboard.TAB=9;Phaser.Keyboard.CLEAR=12;Phaser.Keyboard.ENTER=13;Phaser.Keyboard.SHIFT=16;Phaser.Keyboard.CONTROL=17;Phaser.Keyboard.ALT=18;Phaser.Keyboard.CAPS_LOCK=20;Phaser.Keyboard.ESC=27;Phaser.Keyboard.SPACEBAR=32;Phaser.Keyboard.PAGE_UP=33;Phaser.Keyboard.PAGE_DOWN=34;Phaser.Keyboard.END=35;Phaser.Keyboard.HOME=36;Phaser.Keyboard.LEFT=37;Phaser.Keyboard.UP=38;Phaser.Keyboard.RIGHT=39;Phaser.Keyboard.DOWN=40;Phaser.Keyboard.INSERT=45;Phaser.Keyboard.DELETE=46;Phaser.Keyboard.HELP=47;Phaser.Keyboard.NUM_LOCK=144;Phaser.Keyboard.PLUS=43;Phaser.Keyboard.MINUS=45;Phaser.Component=function(){};Phaser.Component.Angle=function(){};Phaser.Component.Angle.prototype={angle:{get:function(){return Phaser.Math.wrapAngle(Phaser.Math.radToDeg(this.rotation))},set:function(value){this.rotation=Phaser.Math.degToRad(Phaser.Math.wrapAngle(value))}}};Phaser.Component.Animation=function(){};Phaser.Component.Animation.prototype={play:function(name,frameRate,loop,killOnComplete){if(this.animations){return this.animations.play(name,frameRate,loop,killOnComplete)}}};Phaser.Component.AutoCull=function(){};Phaser.Component.AutoCull.prototype={autoCull:false,inCamera:{get:function(){if(!this.autoCull&&!this.checkWorldBounds){this._bounds.copyFrom(this.getBounds());this._bounds.x+=this.game.camera.view.x;this._bounds.y+=this.game.camera.view.y}return this.game.world.camera.view.intersects(this._bounds)}}};Phaser.Component.Bounds=function(){};Phaser.Component.Bounds.prototype={offsetX:{get:function(){return this.anchor.x*this.width}},offsetY:{get:function(){return this.anchor.y*this.height}},left:{get:function(){return this.x-this.offsetX}},right:{get:function(){return this.x+this.width-this.offsetX}},top:{get:function(){return this.y-this.offsetY}},bottom:{get:function(){return this.y+this.height-this.offsetY}}};Phaser.Component.BringToTop=function(){};Phaser.Component.BringToTop.prototype.bringToTop=function(){if(this.parent){this.parent.bringToTop(this)}return this};Phaser.Component.BringToTop.prototype.sendToBack=function(){if(this.parent){this.parent.sendToBack(this)}return this};Phaser.Component.BringToTop.prototype.moveUp=function(){if(this.parent){this.parent.moveUp(this)}return this};Phaser.Component.BringToTop.prototype.moveDown=function(){if(this.parent){this.parent.moveDown(this)}return this};Phaser.Component.Core=function(){};Phaser.Component.Core.install=function(components){Phaser.Utils.mixinPrototype(this,Phaser.Component.Core.prototype);this.components={};for(var i=0;i<components.length;i++){var id=components[i];var replace=false;if(id==="Destroy"){replace=true}Phaser.Utils.mixinPrototype(this,Phaser.Component[id].prototype,replace);this.components[id]=true}};Phaser.Component.Core.init=function(game,x,y,key,frame){this.game=game;this.key=key;this.position.set(x,y);this.world=new Phaser.Point(x,y);this.previousPosition=new Phaser.Point(x,y);this.events=new Phaser.Events(this);this._bounds=new Phaser.Rectangle;if(this.components.PhysicsBody){this.body=this.body}if(this.components.Animation){this.animations=new Phaser.AnimationManager(this)}if(this.components.LoadTexture&&key!==null){this.loadTexture(key,frame)}if(this.components.FixedToCamera){this.cameraOffset=new Phaser.Point(x,y)}};Phaser.Component.Core.preUpdate=function(){this.previousPosition.set(this.world.x,this.world.y);this.previousRotation=this.rotation;if(!this.exists||!this.parent.exists){this.renderOrderID=-1;return false}this.world.setTo(this.game.camera.x+this.worldTransform.tx,this.game.camera.y+this.worldTransform.ty);if(this.visible){this.renderOrderID=this.game.stage.currentRenderOrderID++}if(this.animations){this.animations.update()}if(this.body){this.body.preUpdate()}for(var i=0;i<this.children.length;i++){this.children[i].preUpdate()}return true};Phaser.Component.Core.prototype={game:null,name:"",components:{},z:0,events:undefined,animations:undefined,key:"",world:null,debug:false,previousPosition:null,previousRotation:0,renderOrderID:0,fresh:true,_bounds:null,_exists:true,exists:{get:function(){return this._exists},set:function(value){if(value){this._exists=true;if(this.body&&this.body.type===Phaser.Physics.P2JS){this.body.addToWorld()}this.visible=true}else{this._exists=false;if(this.body&&this.body.type===Phaser.Physics.P2JS){this.body.removeFromWorld()}this.visible=false}}},update:function(){},postUpdate:function(){if(this.key instanceof Phaser.BitmapData){this.key.render()}if(this.components.PhysicsBody){Phaser.Component.PhysicsBody.postUpdate.call(this)}if(this.components.FixedToCamera){Phaser.Component.FixedToCamera.postUpdate.call(this)}for(var i=0;i<this.children.length;i++){this.children[i].postUpdate()}}};Phaser.Component.Crop=function(){};Phaser.Component.Crop.prototype={cropRect:null,_crop:null,crop:function(rect,copy){if(typeof copy==="undefined"){copy=false}if(rect){if(copy&&this.cropRect!==null){this.cropRect.setTo(rect.x,rect.y,rect.width,rect.height)}else if(copy&&this.cropRect===null){this.cropRect=new Phaser.Rectangle(rect.x,rect.y,rect.width,rect.height)}else{this.cropRect=rect}this.updateCrop()}else{this._crop=null;this.cropRect=null;this.resetFrame()}},updateCrop:function(){if(!this.cropRect){return}this._crop=Phaser.Rectangle.clone(this.cropRect,this._crop);this._crop.x+=this._frame.x;this._crop.y+=this._frame.y;var cx=Math.max(this._frame.x,this._crop.x);var cy=Math.max(this._frame.y,this._crop.y);var cw=Math.min(this._frame.right,this._crop.right)-cx;var ch=Math.min(this._frame.bottom,this._crop.bottom)-cy;this.texture.crop.x=cx;this.texture.crop.y=cy;this.texture.crop.width=cw;this.texture.crop.height=ch;this.texture.frame.width=Math.min(cw,this.cropRect.width);this.texture.frame.height=Math.min(ch,this.cropRect.height);this.texture.width=this.texture.frame.width;this.texture.height=this.texture.frame.height;this.texture._updateUvs()}};Phaser.Component.Delta=function(){};Phaser.Component.Delta.prototype={deltaX:{get:function(){return this.world.x-this.previousPosition.x}},deltaY:{get:function(){return this.world.y-this.previousPosition.y}},deltaZ:{get:function(){return this.rotation-this.previousRotation}}};Phaser.Component.Destroy=function(){};Phaser.Component.Destroy.prototype={destroyPhase:false,destroy:function(destroyChildren){if(this.game===null||this.destroyPhase){return}if(typeof destroyChildren==="undefined"){destroyChildren=true}this.destroyPhase=true;if(this.events){this.events.onDestroy$dispatch(this)}if(this.parent){if(this.parent instanceof Phaser.Group){this.parent.remove(this)}else{this.parent.removeChild(this)}}if(this.input){this.input.destroy()}if(this.animations){this.animations.destroy()}if(this.body){this.body.destroy()}if(this.events){this.events.destroy()}var i=this.children.length;if(destroyChildren){while(i--){this.children[i].destroy(destroyChildren)}}else{while(i--){this.removeChild(this.children[i])}}if(this._crop){this._crop=null}if(this._frame){this._frame=null}this.alive=false;this.exists=false;this.visible=false;this.filters=null;this.mask=null;this.game=null;this.renderable=false;this.transformCallback=null;this.transformCallbackContext=null;this.hitArea=null;this.parent=null;this.stage=null;this.worldTransform=null;this.filterArea=null;this._bounds=null;this._currentBounds=null;this._mask=null;this._destroyCachedSprite();this.destroyPhase=false}};Phaser.Events=function(sprite){this.parent=sprite};Phaser.Events.prototype={destroy:function(){this._parent=null;if(this._onDestroy){this._onDestroy.dispose()}if(this._onAddedToGroup){this._onAddedToGroup.dispose()}if(this._onRemovedFromGroup){this._onRemovedFromGroup.dispose()}if(this._onRemovedFromWorld){this._onRemovedFromWorld.dispose()}if(this._onKilled){this._onKilled.dispose()}if(this._onRevived){this._onRevived.dispose()}if(this._onEnterBounds){this._onEnterBounds.dispose()}if(this._onOutOfBounds){this._onOutOfBounds.dispose()}if(this._onInputOver){this._onInputOver.dispose()}if(this._onInputOut){this._onInputOut.dispose()}if(this._onInputDown){this._onInputDown.dispose()}if(this._onInputUp){this._onInputUp.dispose()}if(this._onDragStart){this._onDragStart.dispose()}if(this._onDragStop){this._onDragStop.dispose()}if(this._onAnimationStart){this._onAnimationStart.dispose()}if(this._onAnimationComplete){this._onAnimationComplete.dispose()
}if(this._onAnimationLoop){this._onAnimationLoop.dispose()}},onAddedToGroup:null,onRemovedFromGroup:null,onRemovedFromWorld:null,onDestroy:null,onKilled:null,onRevived:null,onOutOfBounds:null,onEnterBounds:null,onInputOver:null,onInputOut:null,onInputDown:null,onInputUp:null,onDragStart:null,onDragStop:null,onAnimationStart:null,onAnimationComplete:null,onAnimationLoop:null};Phaser.Events.prototype.constructor=Phaser.Events;for(var prop in Phaser.Events.prototype){if(!Phaser.Events.prototype.hasOwnProperty(prop)||prop.indexOf("on")!==0||Phaser.Events.prototype[prop]!==null){continue}(function(prop,backing){"use strict";Object.defineProperty(Phaser.Events.prototype,prop,{get:function(){return this[backing]||(this[backing]=new Phaser.Signal)}});Phaser.Events.prototype[prop+"$dispatch"]=function(){return this[backing]?this[backing].dispatch.apply(this[backing],arguments):null}})(prop,"_"+prop)}Phaser.Component.FixedToCamera=function(){};Phaser.Component.FixedToCamera.postUpdate=function(){if(this.fixedToCamera){this.position.x=(this.game.camera.view.x+this.cameraOffset.x)/this.game.camera.scale.x;this.position.y=(this.game.camera.view.y+this.cameraOffset.y)/this.game.camera.scale.y}};Phaser.Component.FixedToCamera.prototype={_fixedToCamera:false,fixedToCamera:{get:function(){return this._fixedToCamera},set:function(value){if(value){this._fixedToCamera=true;this.cameraOffset.set(this.x,this.y)}else{this._fixedToCamera=false}}},cameraOffset:new Phaser.Point};Phaser.Component.Health=function(){};Phaser.Component.Health.prototype={health:1,damage:function(amount){if(this.alive){this.health-=amount;if(this.health<=0){this.kill()}}return this}};Phaser.Component.InCamera=function(){};Phaser.Component.InCamera.prototype={inCamera:{get:function(){return this.game.world.camera.view.intersects(this._bounds)}}};Phaser.Component.InputEnabled=function(){};Phaser.Component.InputEnabled.prototype={input:null,inputEnabled:{get:function(){return this.input&&this.input.enabled},set:function(value){if(value){if(this.input===null){this.input=new Phaser.InputHandler(this);this.input.start()}else if(this.input&&!this.input.enabled){this.input.start()}}else{if(this.input&&this.input.enabled){this.input.stop()}}}}};Phaser.Component.InWorld=function(){};Phaser.Component.InWorld.preUpdate=function(){if(this.autoCull||this.checkWorldBounds){this._bounds.copyFrom(this.getBounds());this._bounds.x+=this.game.camera.view.x;this._bounds.y+=this.game.camera.view.y;if(this.autoCull){if(this.game.world.camera.view.intersects(this._bounds)){this.renderable=true;this.game.world.camera.totalInView++}else{this.renderable=false}}if(this.checkWorldBounds){if(this._outOfBoundsFired&&this.game.world.bounds.intersects(this._bounds)){this._outOfBoundsFired=false;this.events.onEnterBounds$dispatch(this)}else if(!this._outOfBoundsFired&&!this.game.world.bounds.intersects(this._bounds)){this._outOfBoundsFired=true;this.events.onOutOfBounds$dispatch(this);if(this.outOfBoundsKill){this.kill();return false}}}}return true};Phaser.Component.InWorld.prototype={checkWorldBounds:false,outOfBoundsKill:false,_outOfBoundsFired:false,inWorld:{get:function(){return this.game.world.bounds.intersects(this.getBounds())}}};Phaser.Component.LifeSpan=function(){};Phaser.Component.LifeSpan.preUpdate=function(){if(this.lifespan>0){this.lifespan-=this.game.time.physicsElapsedMS;if(this.lifespan<=0){this.kill();return false}}return true};Phaser.Component.LifeSpan.prototype={alive:true,lifespan:0,revive:function(health){if(typeof health==="undefined"){health=1}this.alive=true;this.exists=true;this.visible=true;if(typeof this.health==="number"){this.health=health}if(this.events){this.events.onRevived$dispatch(this)}return this},kill:function(){this.alive=false;this.exists=false;this.visible=false;if(this.events){this.events.onKilled$dispatch(this)}return this}};Phaser.Component.LoadTexture=function(){};Phaser.Component.LoadTexture.prototype={_frame:null,loadTexture:function(key,frame,stopAnimation){frame=frame||0;if((stopAnimation||typeof stopAnimation==="undefined")&&this.animations){this.animations.stop()}this.key=key;var setFrame=true;var smoothed=!this.texture.baseTexture.scaleMode;var isRenderTexture=false;if(Phaser.RenderTexture&&key instanceof Phaser.RenderTexture){this.key=key.key;this.setTexture(key);isRenderTexture=true}else if(Phaser.BitmapData&&key instanceof Phaser.BitmapData){this.setTexture(key.texture);if(this.game.cache.getFrameData(key.key,Phaser.Cache.BITMAPDATA)){setFrame=!this.animations.loadFrameData(this.game.cache.getFrameData(key.key,Phaser.Cache.BITMAPDATA),frame)}}else if(key instanceof PIXI.Texture){this.setTexture(key)}else{if(key===null||typeof key==="undefined"){this.key="__default";this.setTexture(PIXI.TextureCache[this.key])}else if(typeof key==="string"&&!this.game.cache.checkImageKey(key)){console.warn("Texture with key '"+key+"' not found.");this.key="__missing";this.setTexture(PIXI.TextureCache[this.key])}else{this.setTexture(new PIXI.Texture(PIXI.BaseTextureCache[key]));setFrame=!this.animations.loadFrameData(this.game.cache.getFrameData(key),frame)}}if(!isRenderTexture){this.texture.baseTexture.dirty()}if(setFrame){this._frame=Phaser.Rectangle.clone(this.texture.frame)}if(!smoothed){this.texture.baseTexture.scaleMode=1}},setFrame:function(frame){this._frame=frame;this.texture.frame.x=frame.x;this.texture.frame.y=frame.y;this.texture.frame.width=frame.width;this.texture.frame.height=frame.height;this.texture.crop.x=frame.x;this.texture.crop.y=frame.y;this.texture.crop.width=frame.width;this.texture.crop.height=frame.height;if(frame.trimmed){if(this.texture.trim){this.texture.trim.x=frame.spriteSourceSizeX;this.texture.trim.y=frame.spriteSourceSizeY;this.texture.trim.width=frame.sourceSizeW;this.texture.trim.height=frame.sourceSizeH}else{this.texture.trim={x:frame.spriteSourceSizeX,y:frame.spriteSourceSizeY,width:frame.sourceSizeW,height:frame.sourceSizeH}}this.texture.width=frame.sourceSizeW;this.texture.height=frame.sourceSizeH;this.texture.frame.width=frame.sourceSizeW;this.texture.frame.height=frame.sourceSizeH}else if(!frame.trimmed&&this.texture.trim){this.texture.trim=null}if(this.cropRect){this.updateCrop()}if(this.tint!==16777215){this.cachedTint=-1}this.texture._updateUvs()},resetFrame:function(){if(this._frame){this.setFrame(this._frame)}},frame:{get:function(){return this.animations.frame},set:function(value){this.animations.frame=value}},frameName:{get:function(){return this.animations.frameName},set:function(value){this.animations.frameName=value}}};Phaser.Component.Overlap=function(){};Phaser.Component.Overlap.prototype={overlap:function(displayObject){return Phaser.Rectangle.intersects(this.getBounds(),displayObject.getBounds())}};Phaser.Component.PhysicsBody=function(){};Phaser.Component.PhysicsBody.preUpdate=function(){if(this.fresh&&this.exists){this.world.setTo(this.parent.position.x+this.position.x,this.parent.position.y+this.position.y);this.worldTransform.tx=this.world.x;this.worldTransform.ty=this.world.y;this.previousPosition.set(this.world.x,this.world.y);this.previousRotation=this.rotation;if(this.body){this.body.preUpdate()}this.fresh=false;return false}this.previousPosition.set(this.world.x,this.world.y);this.previousRotation=this.rotation;if(!this._exists||!this.parent.exists){this.renderOrderID=-1;return false}return true};Phaser.Component.PhysicsBody.postUpdate=function(){if(this.exists&&this.body){this.body.postUpdate()}};Phaser.Component.PhysicsBody.prototype={body:null,x:{get:function(){return this.position.x},set:function(value){this.position.x=value;if(this.body&&!this.body.dirty){this.body._reset=true}}},y:{get:function(){return this.position.y},set:function(value){this.position.y=value;if(this.body&&!this.body.dirty){this.body._reset=true}}}};Phaser.Component.Reset=function(){};Phaser.Component.Reset.prototype.reset=function(x,y,health){if(typeof health==="undefined"){health=1}this.world.set(x,y);this.position.set(x,y);this.fresh=true;this.exists=true;this.visible=true;this.renderable=true;if(this.components.InWorld){this._outOfBoundsFired=false}if(this.components.LifeSpan){this.alive=true;this.health=health}if(this.components.PhysicsBody){if(this.body){this.body.reset(x,y,false,false)}}return this};Phaser.Component.ScaleMinMax=function(){};Phaser.Component.ScaleMinMax.prototype={transformCallback:this.checkTransform,transformCallbackContext:this,scaleMin:null,scaleMax:null,checkTransform:function(wt){if(this.scaleMin){if(wt.a<this.scaleMin.x){wt.a=this.scaleMin.x}if(wt.d<this.scaleMin.y){wt.d=this.scaleMin.y}}if(this.scaleMax){if(wt.a>this.scaleMax.x){wt.a=this.scaleMax.x}if(wt.d>this.scaleMax.y){wt.d=this.scaleMax.y}}},setScaleMinMax:function(minX,minY,maxX,maxY){if(typeof minY==="undefined"){minY=maxX=maxY=minX}else if(typeof maxX==="undefined"){maxX=maxY=minY;minY=minX}if(minX===null){this.scaleMin=null}else{if(this.scaleMin){this.scaleMin.set(minX,minY)}else{this.scaleMin=new Phaser.Point(minX,minY)}}if(maxX===null){this.scaleMax=null}else{if(this.scaleMax){this.scaleMax.set(maxX,maxY)}else{this.scaleMax=new Phaser.Point(maxX,maxY)}}}};Phaser.Component.Smoothed=function(){};Phaser.Component.Smoothed.prototype={smoothed:{get:function(){return!this.texture.baseTexture.scaleMode},set:function(value){if(value){if(this.texture){this.texture.baseTexture.scaleMode=0}}else{if(this.texture){this.texture.baseTexture.scaleMode=1}}}}};Phaser.GameObjectFactory=function(game){this.game=game;this.world=this.game.world};Phaser.GameObjectFactory.prototype={existing:function(object){return this.world.add(object)},image:function(x,y,key,frame,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.Image(this.game,x,y,key,frame))},sprite:function(x,y,key,frame,group){if(typeof group==="undefined"){group=this.world}return group.create(x,y,key,frame)},tween:function(obj){return this.game.tweens.create(obj)},group:function(parent,name,addToStage,enableBody,physicsBodyType){return new Phaser.Group(this.game,parent,name,addToStage,enableBody,physicsBodyType)},physicsGroup:function(physicsBodyType,parent,name,addToStage){return new Phaser.Group(this.game,parent,name,addToStage,true,physicsBodyType)},spriteBatch:function(parent,name,addToStage){if(typeof parent==="undefined"){parent=null}if(typeof name==="undefined"){name="group"}if(typeof addToStage==="undefined"){addToStage=false}return new Phaser.SpriteBatch(this.game,parent,name,addToStage)},audio:function(key,volume,loop,connect){return this.game.sound.add(key,volume,loop,connect)},sound:function(key,volume,loop,connect){return this.game.sound.add(key,volume,loop,connect)},audioSprite:function(key){return this.game.sound.addSprite(key)},tileSprite:function(x,y,width,height,key,frame,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.TileSprite(this.game,x,y,width,height,key,frame))},rope:function(x,y,key,frame,points,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.Rope(this.game,x,y,key,frame,points))},text:function(x,y,text,style,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.Text(this.game,x,y,text,style))},button:function(x,y,key,callback,callbackContext,overFrame,outFrame,downFrame,upFrame,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.Button(this.game,x,y,key,callback,callbackContext,overFrame,outFrame,downFrame,upFrame))},graphics:function(x,y,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.Graphics(this.game,x,y))},emitter:function(x,y,maxParticles){return this.game.particles.add(new Phaser.Particles.Arcade.Emitter(this.game,x,y,maxParticles))},retroFont:function(font,characterWidth,characterHeight,chars,charsPerRow,xSpacing,ySpacing,xOffset,yOffset){return new Phaser.RetroFont(this.game,font,characterWidth,characterHeight,chars,charsPerRow,xSpacing,ySpacing,xOffset,yOffset)},bitmapText:function(x,y,font,text,size,group){if(typeof group==="undefined"){group=this.world}return group.add(new Phaser.BitmapText(this.game,x,y,font,text,size))},tilemap:function(key,tileWidth,tileHeight,width,height){return new Phaser.Tilemap(this.game,key,tileWidth,tileHeight,width,height)},renderTexture:function(width,height,key,addToCache){if(typeof key==="undefined"||key===""){key=this.game.rnd.uuid()}if(typeof addToCache==="undefined"){addToCache=false}var texture=new Phaser.RenderTexture(this.game,width,height,key);if(addToCache){this.game.cache.addRenderTexture(key,texture)}return texture},bitmapData:function(width,height,key,addToCache){if(typeof addToCache==="undefined"){addToCache=false}if(typeof key==="undefined"||key===""){key=this.game.rnd.uuid()}var texture=new Phaser.BitmapData(this.game,key,width,height);if(addToCache){this.game.cache.addBitmapData(key,texture)}return texture},filter:function(filter){var args=Array.prototype.splice.call(arguments,1);var filter=new Phaser.Filter[filter](this.game);filter.init.apply(filter,args);return filter},plugin:function(plugin){return this.game.plugins.add(plugin)}};Phaser.GameObjectFactory.prototype.constructor=Phaser.GameObjectFactory;Phaser.GameObjectCreator=function(game){this.game=game;this.world=this.game.world};Phaser.GameObjectCreator.prototype={image:function(x,y,key,frame){return new Phaser.Image(this.game,x,y,key,frame)},sprite:function(x,y,key,frame){return new Phaser.Sprite(this.game,x,y,key,frame)},tween:function(obj){return new Phaser.Tween(obj,this.game,this.game.tweens)},group:function(parent,name,addToStage,enableBody,physicsBodyType){return new Phaser.Group(this.game,null,name,addToStage,enableBody,physicsBodyType)},spriteBatch:function(parent,name,addToStage){if(typeof name==="undefined"){name="group"}if(typeof addToStage==="undefined"){addToStage=false}return new Phaser.SpriteBatch(this.game,parent,name,addToStage)},audio:function(key,volume,loop,connect){return this.game.sound.add(key,volume,loop,connect)},audioSprite:function(key){return this.game.sound.addSprite(key)},sound:function(key,volume,loop,connect){return this.game.sound.add(key,volume,loop,connect)},tileSprite:function(x,y,width,height,key,frame){return new Phaser.TileSprite(this.game,x,y,width,height,key,frame)},rope:function(x,y,key,frame,points){return new Phaser.Rope(this.game,x,y,key,frame,points)},text:function(x,y,text,style){return new Phaser.Text(this.game,x,y,text,style)},button:function(x,y,key,callback,callbackContext,overFrame,outFrame,downFrame,upFrame){return new Phaser.Button(this.game,x,y,key,callback,callbackContext,overFrame,outFrame,downFrame,upFrame)},graphics:function(x,y){return new Phaser.Graphics(this.game,x,y)},emitter:function(x,y,maxParticles){return new Phaser.Particles.Arcade.Emitter(this.game,x,y,maxParticles)},retroFont:function(font,characterWidth,characterHeight,chars,charsPerRow,xSpacing,ySpacing,xOffset,yOffset){return new Phaser.RetroFont(this.game,font,characterWidth,characterHeight,chars,charsPerRow,xSpacing,ySpacing,xOffset,yOffset)},bitmapText:function(x,y,font,text,size){return new Phaser.BitmapText(this.game,x,y,font,text,size)},tilemap:function(key,tileWidth,tileHeight,width,height){return new Phaser.Tilemap(this.game,key,tileWidth,tileHeight,width,height)},renderTexture:function(width,height,key,addToCache){if(typeof key==="undefined"||key===""){key=this.game.rnd.uuid()}if(typeof addToCache==="undefined"){addToCache=false}var texture=new Phaser.RenderTexture(this.game,width,height,key);if(addToCache){this.game.cache.addRenderTexture(key,texture)}return texture},bitmapData:function(width,height,key,addToCache){if(typeof addToCache==="undefined"){addToCache=false}if(typeof key==="undefined"||key===""){key=this.game.rnd.uuid()}var texture=new Phaser.BitmapData(this.game,key,width,height);if(addToCache){this.game.cache.addBitmapData(key,texture)}return texture},filter:function(filter){var args=Array.prototype.splice.call(arguments,1);var filter=new Phaser.Filter[filter](this.game);filter.init.apply(filter,args);return filter}};Phaser.GameObjectCreator.prototype.constructor=Phaser.GameObjectCreator;Phaser.Sprite=function(game,x,y,key,frame){x=x||0;y=y||0;key=key||null;frame=frame||null;this.type=Phaser.SPRITE;this.physicsType=Phaser.SPRITE;PIXI.Sprite.call(this,PIXI.TextureCache["__default"]);Phaser.Component.Core.init.call(this,game,x,y,key,frame)};Phaser.Sprite.prototype=Object.create(PIXI.Sprite.prototype);Phaser.Sprite.prototype.constructor=Phaser.Sprite;Phaser.Component.Core.install.call(Phaser.Sprite.prototype,["Angle","Animation","AutoCull","Bounds","BringToTop","Crop","Delta","Destroy","FixedToCamera","InputEnabled","InWorld","LifeSpan","LoadTexture","Overlap","PhysicsBody","Reset","ScaleMinMax","Smoothed"]);Phaser.Sprite.prototype.preUpdatePhysics=Phaser.Component.PhysicsBody.preUpdate;Phaser.Sprite.prototype.preUpdateLifeSpan=Phaser.Component.LifeSpan.preUpdate;Phaser.Sprite.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.Sprite.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.Sprite.prototype.preUpdate=function(){if(!this.preUpdatePhysics()||!this.preUpdateLifeSpan()||!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.Image=function(game,x,y,key,frame){x=x||0;y=y||0;key=key||null;frame=frame||null;this.type=Phaser.IMAGE;PIXI.Sprite.call(this,PIXI.TextureCache["__default"]);Phaser.Component.Core.init.call(this,game,x,y,key,frame)};Phaser.Image.prototype=Object.create(PIXI.Sprite.prototype);Phaser.Image.prototype.constructor=Phaser.Image;Phaser.Component.Core.install.call(Phaser.Image.prototype,["Angle","Animation","AutoCull","Bounds","BringToTop","Crop","Destroy","FixedToCamera","InputEnabled","LifeSpan","LoadTexture","Overlap","Reset","Smoothed"]);Phaser.Image.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.Image.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.Image.prototype.preUpdate=function(){if(!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.TileSprite=function(game,x,y,width,height,key,frame){x=x||0;y=y||0;width=width||256;height=height||256;key=key||null;frame=frame||null;this.type=Phaser.TILESPRITE;this._scroll=new Phaser.Point;PIXI.TilingSprite.call(this,PIXI.TextureCache["__default"],width,height);Phaser.Component.Core.init.call(this,game,x,y,key,frame)};Phaser.TileSprite.prototype=Object.create(PIXI.TilingSprite.prototype);Phaser.TileSprite.prototype.constructor=Phaser.TileSprite;Phaser.Component.Core.install.call(Phaser.TileSprite.prototype,["Angle","Animation","AutoCull","Bounds","Destroy","FixedToCamera","InputEnabled","InWorld","LoadTexture","Overlap","PhysicsBody","Reset","Smoothed"]);Phaser.TileSprite.prototype.preUpdatePhysics=Phaser.Component.PhysicsBody.preUpdate;Phaser.TileSprite.prototype.preUpdateLifeSpan=Phaser.Component.LifeSpan.preUpdate;Phaser.TileSprite.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.TileSprite.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.TileSprite.prototype.preUpdate=function(){if(this._scroll.x!==0){this.tilePosition.x+=this._scroll.x*this.game.time.physicsElapsed}if(this._scroll.y!==0){this.tilePosition.y+=this._scroll.y*this.game.time.physicsElapsed}if(!this.preUpdatePhysics()||!this.preUpdateLifeSpan()||!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.TileSprite.prototype.autoScroll=function(x,y){this._scroll.set(x,y)};Phaser.TileSprite.prototype.stopScroll=function(){this._scroll.set(0,0)};Phaser.TileSprite.prototype.destroy=function(destroyChildren){Phaser.Component.Destroy.prototype.destroy.call(this,destroyChildren);PIXI.TilingSprite.prototype.destroy.call(this)};Phaser.TileSprite.prototype.reset=function(x,y){Phaser.Component.Reset.prototype.reset.call(this,x,y);this.tilePosition.x=0;this.tilePosition.y=0;return this};Phaser.Rope=function(game,x,y,key,frame,points){this.points=[];this.points=points;this._hasUpdateAnimation=false;this._updateAnimationCallback=null;x=x||0;y=y||0;key=key||null;frame=frame||null;this.type=Phaser.ROPE;this._scroll=new Phaser.Point;PIXI.Rope.call(this,key,this.points);Phaser.Component.Core.init.call(this,game,x,y,key,frame)};Phaser.Rope.prototype=Object.create(PIXI.Rope.prototype);Phaser.Rope.prototype.constructor=Phaser.Rope;Phaser.Component.Core.install.call(Phaser.Rope.prototype,["Angle","Animation","AutoCull","Bounds","BringToTop","Crop","Delta","Destroy","FixedToCamera","InputEnabled","InWorld","LifeSpan","LoadTexture","Overlap","PhysicsBody","Reset","ScaleMinMax","Smoothed"]);Phaser.Rope.prototype.preUpdatePhysics=Phaser.Component.PhysicsBody.preUpdate;Phaser.Rope.prototype.preUpdateLifeSpan=Phaser.Component.LifeSpan.preUpdate;Phaser.Rope.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.Rope.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.Rope.prototype.preUpdate=function(){if(this._scroll.x!==0){this.tilePosition.x+=this._scroll.x*this.game.time.physicsElapsed}if(this._scroll.y!==0){this.tilePosition.y+=this._scroll.y*this.game.time.physicsElapsed}if(!this.preUpdatePhysics()||!this.preUpdateLifeSpan()||!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.Rope.prototype.update=function(){if(this._hasUpdateAnimation){this.updateAnimation.call(this)}};Phaser.Rope.prototype.reset=function(x,y){Phaser.Component.Reset.prototype.reset.call(this,x,y);this.tilePosition.x=0;this.tilePosition.y=0;return this};Object.defineProperty(Phaser.Rope.prototype,"updateAnimation",{get:function(){return this._updateAnimation},set:function(value){if(value&&typeof value==="function"){this._hasUpdateAnimation=true;this._updateAnimation=value}else{this._hasUpdateAnimation=false;this._updateAnimation=null}}});Object.defineProperty(Phaser.Rope.prototype,"segments",{get:function(){var segments=[];var index,x1,y1,x2,y2,width,height,rect;for(var i=0;i<this.points.length;i++){index=i*4;x1=this.verticies[index];y1=this.verticies[index+1];x2=this.verticies[index+4];y2=this.verticies[index+3];width=Phaser.Math.difference(x1,x2);height=Phaser.Math.difference(y1,y2);x1+=this.world.x;y1+=this.world.y;rect=new Phaser.Rectangle(x1,y1,width,height);segments.push(rect)}return segments}});Phaser.Button=function(game,x,y,key,callback,callbackContext,overFrame,outFrame,downFrame,upFrame){x=x||0;y=y||0;key=key||null;callback=callback||null;callbackContext=callbackContext||this;Phaser.Image.call(this,game,x,y,key,outFrame);this.type=Phaser.BUTTON;this.physicsType=Phaser.SPRITE;this._onOverFrame=null;this._onOutFrame=null;this._onDownFrame=null;this._onUpFrame=null;this.onOverSound=null;this.onOutSound=null;this.onDownSound=null;this.onUpSound=null;this.onOverSoundMarker="";this.onOutSoundMarker="";this.onDownSoundMarker="";this.onUpSoundMarker="";this.onInputOver=new Phaser.Signal;this.onInputOut=new Phaser.Signal;this.onInputDown=new Phaser.Signal;this.onInputUp=new Phaser.Signal;this.onOverMouseOnly=false;this.freezeFrames=false;this.forceOut=false;this.inputEnabled=true;this.input.start(0,true);this.setFrames(overFrame,outFrame,downFrame,upFrame);if(callback!==null){this.onInputUp.add(callback,callbackContext)}this.events.onInputOver.add(this.onInputOverHandler,this);this.events.onInputOut.add(this.onInputOutHandler,this);this.events.onInputDown.add(this.onInputDownHandler,this);this.events.onInputUp.add(this.onInputUpHandler,this);this.events.onRemovedFromWorld.add(this.removedFromWorld,this)};Phaser.Button.prototype=Object.create(Phaser.Image.prototype);Phaser.Button.prototype.constructor=Phaser.Button;var STATE_OVER="Over";var STATE_OUT="Out";var STATE_DOWN="Down";var STATE_UP="Up";Phaser.Button.prototype.clearFrames=function(){this.setFrames(null,null,null,null)};Phaser.Button.prototype.removedFromWorld=function(){this.inputEnabled=false};Phaser.Button.prototype.setStateFrame=function(state,frame,switchImmediately){var frameKey="_on"+state+"Frame";if(frame!=null){this[frameKey]=frame;if(switchImmediately){this.changeStateFrame(state)}}else{this[frameKey]=null}};Phaser.Button.prototype.changeStateFrame=function(state){if(this.freezeFrames){return false}var frameKey="_on"+state+"Frame";var frame=this[frameKey];if(typeof frame==="string"){this.frameName=frame;return true}else if(typeof frame==="number"){this.frame=frame;return true}else{return false}};Phaser.Button.prototype.setFrames=function(overFrame,outFrame,downFrame,upFrame){this.setStateFrame(STATE_OVER,overFrame,this.input.pointerOver());this.setStateFrame(STATE_OUT,outFrame,!this.input.pointerOver());this.setStateFrame(STATE_DOWN,downFrame,this.input.pointerDown());this.setStateFrame(STATE_UP,upFrame,this.input.pointerUp())};Phaser.Button.prototype.setStateSound=function(state,sound,marker){var soundKey="on"+state+"Sound";var markerKey="on"+state+"SoundMarker";if(sound instanceof Phaser.Sound||sound instanceof Phaser.AudioSprite){this[soundKey]=sound;this[markerKey]=typeof marker==="string"?marker:""}else{this[soundKey]=null;this[markerKey]=""}};Phaser.Button.prototype.playStateSound=function(state){var soundKey="on"+state+"Sound";var sound=this[soundKey];if(sound){var markerKey="on"+state+"SoundMarker";var marker=this[markerKey];sound.play(marker);return true}else{return false}};Phaser.Button.prototype.setSounds=function(overSound,overMarker,downSound,downMarker,outSound,outMarker,upSound,upMarker){this.setStateSound(STATE_OVER,overSound,overMarker);this.setStateSound(STATE_OUT,outSound,outMarker);this.setStateSound(STATE_DOWN,downSound,downMarker);this.setStateSound(STATE_UP,upSound,upMarker)};Phaser.Button.prototype.setOverSound=function(sound,marker){this.setStateSound(STATE_OVER,sound,marker)};Phaser.Button.prototype.setOutSound=function(sound,marker){this.setStateSound(STATE_OUT,sound,marker)};Phaser.Button.prototype.setDownSound=function(sound,marker){this.setStateSound(STATE_DOWN,sound,marker)};Phaser.Button.prototype.setUpSound=function(sound,marker){this.setStateSound(STATE_UP,sound,marker)};Phaser.Button.prototype.onInputOverHandler=function(sprite,pointer){if(pointer.justReleased()){return}this.changeStateFrame(STATE_OVER);if(this.onOverMouseOnly&&!pointer.isMouse){return}this.playStateSound(STATE_OVER);if(this.onInputOver){this.onInputOver.dispatch(this,pointer)}};Phaser.Button.prototype.onInputOutHandler=function(sprite,pointer){this.changeStateFrame(STATE_OUT);this.playStateSound(STATE_OUT);if(this.onInputOut){this.onInputOut.dispatch(this,pointer)}};Phaser.Button.prototype.onInputDownHandler=function(sprite,pointer){this.changeStateFrame(STATE_DOWN);this.playStateSound(STATE_DOWN);if(this.onInputDown){this.onInputDown.dispatch(this,pointer)}};Phaser.Button.prototype.onInputUpHandler=function(sprite,pointer,isOver){this.playStateSound(STATE_UP);if(this.onInputUp){this.onInputUp.dispatch(this,pointer,isOver)}if(this.freezeFrames){return}if(this.forceOut){this.changeStateFrame(STATE_OUT)}else{var changedUp=this.changeStateFrame(STATE_UP);if(!changedUp){if(isOver){this.changeStateFrame(STATE_OVER)}else{this.changeStateFrame(STATE_OUT)}}}};Phaser.SpriteBatch=function(game,parent,name,addToStage){if(typeof parent==="undefined"||parent===null){parent=game.world}PIXI.SpriteBatch.call(this);Phaser.Group.call(this,game,parent,name,addToStage);this.type=Phaser.SPRITEBATCH};Phaser.SpriteBatch.prototype=Phaser.Utils.extend(true,Phaser.SpriteBatch.prototype,Phaser.Group.prototype,PIXI.SpriteBatch.prototype);Phaser.SpriteBatch.prototype.constructor=Phaser.SpriteBatch;Phaser.Particle=function(game,x,y,key,frame){Phaser.Sprite.call(this,game,x,y,key,frame);this.autoScale=false;this.scaleData=null;this._s=0;this.autoAlpha=false;this.alphaData=null;this._a=0};Phaser.Particle.prototype=Object.create(Phaser.Sprite.prototype);Phaser.Particle.prototype.constructor=Phaser.Particle;Phaser.Particle.prototype.update=function(){if(this.autoScale){this._s--;if(this._s){this.scale.set(this.scaleData[this._s].x,this.scaleData[this._s].y)}else{this.autoScale=false}}if(this.autoAlpha){this._a--;if(this._a){this.alpha=this.alphaData[this._a].v}else{this.autoAlpha=false}}};Phaser.Particle.prototype.onEmit=function(){};Phaser.Particle.prototype.setAlphaData=function(data){this.alphaData=data;this._a=data.length-1;this.alpha=this.alphaData[this._a].v;this.autoAlpha=true};Phaser.Particle.prototype.setScaleData=function(data){this.scaleData=data;this._s=data.length-1;this.scale.set(this.scaleData[this._s].x,this.scaleData[this._s].y);this.autoScale=true};Phaser.Particle.prototype.reset=function(x,y,health){Phaser.Component.Reset.prototype.reset.call(this,x,y,health);this.alpha=1;this.scale.set(1);this.autoScale=false;this.autoAlpha=false;return this};Phaser.BitmapData=function(game,key,width,height){if(typeof width==="undefined"){width=256}if(typeof height==="undefined"){height=256}this.game=game;this.key=key;this.width=width;this.height=height;this.canvas=Phaser.Canvas.create(width,height,"",true);this.context=this.canvas.getContext("2d",{alpha:true});this.ctx=this.context;this.imageData=this.context.getImageData(0,0,width,height);this.data=this.imageData.data;this.pixels=null;if(this.imageData.data.buffer){this.buffer=this.imageData.data.buffer;this.pixels=new Uint32Array(this.buffer)}else{if(window["ArrayBuffer"]){this.buffer=new ArrayBuffer(this.imageData.data.length);this.pixels=new Uint32Array(this.buffer)}else{this.pixels=this.imageData.data}}this.baseTexture=new PIXI.BaseTexture(this.canvas);this.texture=new PIXI.Texture(this.baseTexture);this.textureFrame=new Phaser.Frame(0,0,0,width,height,"bitmapData",game.rnd.uuid());this.texture.frame=this.textureFrame;this.type=Phaser.BITMAPDATA;this.disableTextureUpload=false;this.dirty=false;this.cls=this.clear;this._image=null;this._pos=new Phaser.Point;this._size=new Phaser.Point;this._scale=new Phaser.Point;this._rotate=0;this._alpha={prev:1,current:1};this._anchor=new Phaser.Point;this._tempR=0;this._tempG=0;this._tempB=0;this._circle=new Phaser.Circle};Phaser.BitmapData.prototype={add:function(object){if(Array.isArray(object)){for(var i=0;i<object.length;i++){if(object[i]["loadTexture"]){object[i].loadTexture(this)}}}else{object.loadTexture(this)}return this},load:function(source){if(typeof source==="string"){source=this.game.cache.getImage(source)}if(source){this.resize(source.width,source.height);this.cls()}else{return}this.draw(source);this.update();return this},clear:function(){this.context.clearRect(0,0,this.width,this.height);this.dirty=true;return this},fill:function(r,g,b,a){if(typeof a==="undefined"){a=1}this.context.fillStyle="rgba("+r+","+g+","+b+","+a+")";this.context.fillRect(0,0,this.width,this.height);this.dirty=true;return this},resize:function(width,height){if(width!==this.width||height!==this.height){this.width=width;this.height=height;this.canvas.width=width;this.canvas.height=height;this.baseTexture.width=width;this.baseTexture.height=height;this.textureFrame.width=width;this.textureFrame.height=height;this.texture.width=width;this.texture.height=height;this.texture.crop.width=width;this.texture.crop.height=height;this.update();this.dirty=true}return this},update:function(x,y,width,height){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof width==="undefined"){width=this.width}if(typeof height==="undefined"){height=this.height}this.imageData=this.context.getImageData(x,y,width,height);this.data=this.imageData.data;if(this.imageData.data.buffer){this.buffer=this.imageData.data.buffer;this.pixels=new Uint32Array(this.buffer)}else{if(window["ArrayBuffer"]){this.buffer=new ArrayBuffer(this.imageData.data.length);this.pixels=new Uint32Array(this.buffer)}else{this.pixels=this.imageData.data}}return this},processPixelRGB:function(callback,callbackContext,x,y,width,height){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof width==="undefined"){width=this.width}if(typeof height==="undefined"){height=this.height}var w=x+width;var h=y+height;var pixel=Phaser.Color.createColor();var result={r:0,g:0,b:0,a:0};var dirty=false;for(var ty=y;ty<h;ty++){for(var tx=x;tx<w;tx++){Phaser.Color.unpackPixel(this.getPixel32(tx,ty),pixel);
result=callback.call(callbackContext,pixel,tx,ty);if(result!==false&&result!==null&&result!==undefined){this.setPixel32(tx,ty,result.r,result.g,result.b,result.a,false);dirty=true}}}if(dirty){this.context.putImageData(this.imageData,0,0);this.dirty=true}return this},processPixel:function(callback,callbackContext,x,y,width,height){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof width==="undefined"){width=this.width}if(typeof height==="undefined"){height=this.height}var w=x+width;var h=y+height;var pixel=0;var result=0;var dirty=false;for(var ty=y;ty<h;ty++){for(var tx=x;tx<w;tx++){pixel=this.getPixel32(tx,ty);result=callback.call(callbackContext,pixel,tx,ty);if(result!==pixel){this.pixels[ty*this.width+tx]=result;dirty=true}}}if(dirty){this.context.putImageData(this.imageData,0,0);this.dirty=true}return this},replaceRGB:function(r1,g1,b1,a1,r2,g2,b2,a2,region){var sx=0;var sy=0;var w=this.width;var h=this.height;var source=Phaser.Color.packPixel(r1,g1,b1,a1);if(region!==undefined&&region instanceof Phaser.Rectangle){sx=region.x;sy=region.y;w=region.width;h=region.height}for(var y=0;y<h;y++){for(var x=0;x<w;x++){if(this.getPixel32(sx+x,sy+y)===source){this.setPixel32(sx+x,sy+y,r2,g2,b2,a2,false)}}}this.context.putImageData(this.imageData,0,0);this.dirty=true;return this},setHSL:function(h,s,l,region){if(typeof h==="undefined"||h===null){h=false}if(typeof s==="undefined"||s===null){s=false}if(typeof l==="undefined"||l===null){l=false}if(!h&&!s&&!l){return}if(typeof region==="undefined"){region=new Phaser.Rectangle(0,0,this.width,this.height)}var pixel=Phaser.Color.createColor();for(var y=region.y;y<region.bottom;y++){for(var x=region.x;x<region.right;x++){Phaser.Color.unpackPixel(this.getPixel32(x,y),pixel,true);if(h){pixel.h=h}if(s){pixel.s=s}if(l){pixel.l=l}Phaser.Color.HSLtoRGB(pixel.h,pixel.s,pixel.l,pixel);this.setPixel32(x,y,pixel.r,pixel.g,pixel.b,pixel.a,false)}}this.context.putImageData(this.imageData,0,0);this.dirty=true;return this},shiftHSL:function(h,s,l,region){if(typeof h==="undefined"||h===null){h=false}if(typeof s==="undefined"||s===null){s=false}if(typeof l==="undefined"||l===null){l=false}if(!h&&!s&&!l){return}if(typeof region==="undefined"){region=new Phaser.Rectangle(0,0,this.width,this.height)}var pixel=Phaser.Color.createColor();for(var y=region.y;y<region.bottom;y++){for(var x=region.x;x<region.right;x++){Phaser.Color.unpackPixel(this.getPixel32(x,y),pixel,true);if(h){pixel.h=this.game.math.wrap(pixel.h+h,0,1)}if(s){pixel.s=this.game.math.limitValue(pixel.s+s,0,1)}if(l){pixel.l=this.game.math.limitValue(pixel.l+l,0,1)}Phaser.Color.HSLtoRGB(pixel.h,pixel.s,pixel.l,pixel);this.setPixel32(x,y,pixel.r,pixel.g,pixel.b,pixel.a,false)}}this.context.putImageData(this.imageData,0,0);this.dirty=true;return this},setPixel32:function(x,y,red,green,blue,alpha,immediate){if(typeof immediate==="undefined"){immediate=true}if(x>=0&&x<=this.width&&y>=0&&y<=this.height){if(Phaser.Device.LITTLE_ENDIAN){this.pixels[y*this.width+x]=alpha<<24|blue<<16|green<<8|red}else{this.pixels[y*this.width+x]=red<<24|green<<16|blue<<8|alpha}if(immediate){this.context.putImageData(this.imageData,0,0);this.dirty=true}}return this},setPixel:function(x,y,red,green,blue,immediate){return this.setPixel32(x,y,red,green,blue,255,immediate)},getPixel:function(x,y,out){if(!out){out=Phaser.Color.createColor()}var index=~~(x+y*this.width);index*=4;out.r=this.data[index];out.g=this.data[++index];out.b=this.data[++index];out.a=this.data[++index];return out},getPixel32:function(x,y){if(x>=0&&x<=this.width&&y>=0&&y<=this.height){return this.pixels[y*this.width+x]}},getPixelRGB:function(x,y,out,hsl,hsv){return Phaser.Color.unpackPixel(this.getPixel32(x,y),out,hsl,hsv)},getPixels:function(rect){return this.context.getImageData(rect.x,rect.y,rect.width,rect.height)},getFirstPixel:function(direction){if(typeof direction==="undefined"){direction=0}var pixel=Phaser.Color.createColor();var x=0;var y=0;var v=1;var scan=false;if(direction===1){v=-1;y=this.height}else if(direction===3){v=-1;x=this.width}do{Phaser.Color.unpackPixel(this.getPixel32(x,y),pixel);if(direction===0||direction===1){x++;if(x===this.width){x=0;y+=v;if(y>=this.height||y<=0){scan=true}}}else if(direction===2||direction===3){y++;if(y===this.height){y=0;x+=v;if(x>=this.width||x<=0){scan=true}}}}while(pixel.a===0&&!scan);pixel.x=x;pixel.y=y;return pixel},getBounds:function(rect){if(typeof rect==="undefined"){rect=new Phaser.Rectangle}rect.x=this.getFirstPixel(2).x;if(rect.x===this.width){return rect.setTo(0,0,0,0)}rect.y=this.getFirstPixel(0).y;rect.width=this.getFirstPixel(3).x-rect.x+1;rect.height=this.getFirstPixel(1).y-rect.y+1;return rect},addToWorld:function(x,y,anchorX,anchorY,scaleX,scaleY){scaleX=scaleX||1;scaleY=scaleY||1;var image=this.game.add.image(x,y,this);image.anchor.set(anchorX,anchorY);image.scale.set(scaleX,scaleY);return image},copy:function(source,x,y,width,height,tx,ty,newWidth,newHeight,rotate,anchorX,anchorY,scaleX,scaleY,alpha,blendMode,roundPx){if(typeof source==="undefined"||source===null){source=this}this._image=source;if(source instanceof Phaser.Sprite||source instanceof Phaser.Image||source instanceof Phaser.Text){this._pos.set(source.texture.crop.x,source.texture.crop.y);this._size.set(source.texture.crop.width,source.texture.crop.height);this._scale.set(source.scale.x,source.scale.y);this._anchor.set(source.anchor.x,source.anchor.y);this._rotate=source.rotation;this._alpha.current=source.alpha;this._image=source.texture.baseTexture.source;if(typeof tx==="undefined"||tx===null){tx=source.x}if(typeof ty==="undefined"||ty===null){ty=source.y}if(source.texture.trim){tx+=source.texture.trim.x-source.anchor.x*source.texture.trim.width;ty+=source.texture.trim.y-source.anchor.y*source.texture.trim.height}if(source.tint!==16777215){if(source.cachedTint!==source.tint){source.cachedTint=source.tint;source.tintedTexture=PIXI.CanvasTinter.getTintedTexture(source,source.tint)}this._image=source.tintedTexture}}else{this._pos.set(0);this._scale.set(1);this._anchor.set(0);this._rotate=0;this._alpha.current=1;if(source instanceof Phaser.BitmapData){this._image=source.canvas}else if(typeof source==="string"){source=this.game.cache.getImage(source);if(source===null){return}else{this._image=source}}this._size.set(this._image.width,this._image.height)}if(typeof x==="undefined"||x===null){x=0}if(typeof y==="undefined"||y===null){y=0}if(width){this._size.x=width}if(height){this._size.y=height}if(typeof tx==="undefined"||tx===null){tx=x}if(typeof ty==="undefined"||ty===null){ty=y}if(typeof newWidth==="undefined"||newWidth===null){newWidth=this._size.x}if(typeof newHeight==="undefined"||newHeight===null){newHeight=this._size.y}if(typeof rotate==="number"){this._rotate=rotate}if(typeof anchorX==="number"){this._anchor.x=anchorX}if(typeof anchorY==="number"){this._anchor.y=anchorY}if(typeof scaleX==="number"){this._scale.x=scaleX}if(typeof scaleY==="number"){this._scale.y=scaleY}if(typeof alpha==="number"){this._alpha.current=alpha}if(typeof blendMode==="undefined"){blendMode=null}if(typeof roundPx==="undefined"){roundPx=false}if(this._alpha.current<=0||this._scale.x===0||this._scale.y===0||this._size.x===0||this._size.y===0){return}this._alpha.prev=this.context.globalAlpha;this.context.save();this.context.globalAlpha=this._alpha.current;if(blendMode){this.context.globalCompositeOperation=blendMode}if(roundPx){tx|=0;ty|=0}this.context.translate(tx,ty);this.context.scale(this._scale.x,this._scale.y);this.context.rotate(this._rotate);this.context.drawImage(this._image,this._pos.x+x,this._pos.y+y,this._size.x,this._size.y,-newWidth*this._anchor.x,-newHeight*this._anchor.y,newWidth,newHeight);this.context.restore();this.context.globalAlpha=this._alpha.prev;this.dirty=true;return this},copyRect:function(source,area,x,y,alpha,blendMode,roundPx){return this.copy(source,area.x,area.y,area.width,area.height,x,y,area.width,area.height,0,0,0,1,1,alpha,blendMode,roundPx)},draw:function(source,x,y,width,height,blendMode,roundPx){return this.copy(source,null,null,null,null,x,y,width,height,null,null,null,null,null,null,blendMode,roundPx)},drawGroup:function(group,blendMode,roundPx){if(group.total>0){group.forEachExists(this.copy,this,null,null,null,null,null,null,null,null,null,null,null,null,null,null,blendMode,roundPx)}return this},shadow:function(color,blur,x,y){if(typeof color==="undefined"||color===null){this.context.shadowColor="rgba(0,0,0,0)"}else{this.context.shadowColor=color;this.context.shadowBlur=blur||5;this.context.shadowOffsetX=x||10;this.context.shadowOffsetY=y||10}},alphaMask:function(source,mask,sourceRect,maskRect){if(typeof maskRect==="undefined"||maskRect===null){this.draw(mask).blendSourceAtop()}else{this.draw(mask,maskRect.x,maskRect.y,maskRect.width,maskRect.height).blendSourceAtop()}if(typeof sourceRect==="undefined"||sourceRect===null){this.draw(source).blendReset()}else{this.draw(source,sourceRect.x,sourceRect.y,sourceRect.width,sourceRect.height).blendReset()}return this},extract:function(destination,r,g,b,a,resize,r2,g2,b2){if(typeof a==="undefined"){a=255}if(typeof resize==="undefined"){resize=false}if(typeof r2==="undefined"){r2=r}if(typeof g2==="undefined"){g2=g}if(typeof b2==="undefined"){b2=b}if(resize){destination.resize(this.width,this.height)}this.processPixelRGB(function(pixel,x,y){if(pixel.r===r&&pixel.g===g&&pixel.b===b){destination.setPixel32(x,y,r2,g2,b2,a,false)}return false},this);destination.context.putImageData(destination.imageData,0,0);destination.dirty=true;return destination},rect:function(x,y,width,height,fillStyle){if(typeof fillStyle!=="undefined"){this.context.fillStyle=fillStyle}this.context.fillRect(x,y,width,height);return this},text:function(text,x,y,font,color,shadow){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof font==="undefined"){font="14px Courier"}if(typeof color==="undefined"){color="rgb(255,255,255)"}if(typeof shadow==="undefined"){shadow=true}var prevFont=this.context.font;this.context.font=font;if(shadow){this.context.fillStyle="rgb(0,0,0)";this.context.fillText(text,x+1,y+1)}this.context.fillStyle=color;this.context.fillText(text,x,y);this.context.font=prevFont},circle:function(x,y,radius,fillStyle){if(typeof fillStyle!=="undefined"){this.context.fillStyle=fillStyle}this.context.beginPath();this.context.arc(x,y,radius,0,Math.PI*2,false);this.context.closePath();this.context.fill();return this},textureLine:function(line,image,repeat){if(typeof repeat==="undefined"){repeat="repeat-x"}if(typeof image==="string"){image=this.game.cache.getImage(image);if(!image){return}}var width=line.length;if(repeat==="no-repeat"&&width>image.width){width=image.width}this.context.fillStyle=this.context.createPattern(image,repeat);this._circle=new Phaser.Circle(line.start.x,line.start.y,image.height);this._circle.circumferencePoint(line.angle-1.5707963267948966,false,this._pos);this.context.save();this.context.translate(this._pos.x,this._pos.y);this.context.rotate(line.angle);this.context.fillRect(0,0,width,image.height);this.context.restore();this.dirty=true;return this},render:function(){if(!this.disableTextureUpload&&this.dirty){this.baseTexture.dirty();this.dirty=false}return this},blendReset:function(){this.context.globalCompositeOperation="source-over";return this},blendSourceOver:function(){this.context.globalCompositeOperation="source-over";return this},blendSourceIn:function(){this.context.globalCompositeOperation="source-in";return this},blendSourceOut:function(){this.context.globalCompositeOperation="source-out";return this},blendSourceAtop:function(){this.context.globalCompositeOperation="source-atop";return this},blendDestinationOver:function(){this.context.globalCompositeOperation="destination-over";return this},blendDestinationIn:function(){this.context.globalCompositeOperation="destination-in";return this},blendDestinationOut:function(){this.context.globalCompositeOperation="destination-out";return this},blendDestinationAtop:function(){this.context.globalCompositeOperation="destination-atop";return this},blendXor:function(){this.context.globalCompositeOperation="xor";return this},blendAdd:function(){this.context.globalCompositeOperation="lighter";return this},blendMultiply:function(){this.context.globalCompositeOperation="multiply";return this},blendScreen:function(){this.context.globalCompositeOperation="screen";return this},blendOverlay:function(){this.context.globalCompositeOperation="overlay";return this},blendDarken:function(){this.context.globalCompositeOperation="darken";return this},blendLighten:function(){this.context.globalCompositeOperation="lighten";return this},blendColorDodge:function(){this.context.globalCompositeOperation="color-dodge";return this},blendColorBurn:function(){this.context.globalCompositeOperation="color-burn";return this},blendHardLight:function(){this.context.globalCompositeOperation="hard-light";return this},blendSoftLight:function(){this.context.globalCompositeOperation="soft-light";return this},blendDifference:function(){this.context.globalCompositeOperation="difference";return this},blendExclusion:function(){this.context.globalCompositeOperation="exclusion";return this},blendHue:function(){this.context.globalCompositeOperation="hue";return this},blendSaturation:function(){this.context.globalCompositeOperation="saturation";return this},blendColor:function(){this.context.globalCompositeOperation="color";return this},blendLuminosity:function(){this.context.globalCompositeOperation="luminosity";return this}};Object.defineProperty(Phaser.BitmapData.prototype,"smoothed",{get:function(){Phaser.Canvas.getSmoothingEnabled(this.context)},set:function(value){Phaser.Canvas.setSmoothingEnabled(this.context,value)}});Phaser.BitmapData.getTransform=function(translateX,translateY,scaleX,scaleY,skewX,skewY){if(typeof translateX!=="number"){translateX=0}if(typeof translateY!=="number"){translateY=0}if(typeof scaleX!=="number"){scaleX=1}if(typeof scaleY!=="number"){scaleY=1}if(typeof skewX!=="number"){skewX=0}if(typeof skewY!=="number"){skewY=0}return{sx:scaleX,sy:scaleY,scaleX:scaleX,scaleY:scaleY,skewX:skewX,skewY:skewY,translateX:translateX,translateY:translateY,tx:translateX,ty:translateY}};Phaser.BitmapData.prototype.constructor=Phaser.BitmapData;Phaser.Graphics=function(game,x,y){x=x||0;y=y||0;this.type=Phaser.GRAPHICS;this.physicsType=Phaser.SPRITE;PIXI.Graphics.call(this);Phaser.Component.Core.init.call(this,game,x,y,"",null)};Phaser.Graphics.prototype=Object.create(PIXI.Graphics.prototype);Phaser.Graphics.prototype.constructor=Phaser.Graphics;Phaser.Component.Core.install.call(Phaser.Graphics.prototype,["Angle","AutoCull","Bounds","Destroy","FixedToCamera","InputEnabled","InWorld","LifeSpan","PhysicsBody","Reset"]);Phaser.Graphics.prototype.preUpdatePhysics=Phaser.Component.PhysicsBody.preUpdate;Phaser.Graphics.prototype.preUpdateLifeSpan=Phaser.Component.LifeSpan.preUpdate;Phaser.Graphics.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.Graphics.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.Graphics.prototype.preUpdate=function(){if(!this.preUpdatePhysics()||!this.preUpdateLifeSpan()||!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.Graphics.prototype.destroy=function(destroyChildren){this.clear();Phaser.Component.Destroy.prototype.destroy.call(this,destroyChildren)};Phaser.Graphics.prototype.drawTriangle=function(points,cull){if(typeof cull==="undefined"){cull=false}var triangle=new Phaser.Polygon(points);if(cull){var cameraToFace=new Phaser.Point(this.game.camera.x-points[0].x,this.game.camera.y-points[0].y);var ab=new Phaser.Point(points[1].x-points[0].x,points[1].y-points[0].y);var cb=new Phaser.Point(points[1].x-points[2].x,points[1].y-points[2].y);var faceNormal=cb.cross(ab);if(cameraToFace.dot(faceNormal)>0){this.drawPolygon(triangle)}}else{this.drawPolygon(triangle)}};Phaser.Graphics.prototype.drawTriangles=function(vertices,indices,cull){if(typeof cull==="undefined"){cull=false}var point1=new Phaser.Point;var point2=new Phaser.Point;var point3=new Phaser.Point;var points=[];var i;if(!indices){if(vertices[0]instanceof Phaser.Point){for(i=0;i<vertices.length/3;i++){this.drawTriangle([vertices[i*3],vertices[i*3+1],vertices[i*3+2]],cull)}}else{for(i=0;i<vertices.length/6;i++){point1.x=vertices[i*6+0];point1.y=vertices[i*6+1];point2.x=vertices[i*6+2];point2.y=vertices[i*6+3];point3.x=vertices[i*6+4];point3.y=vertices[i*6+5];this.drawTriangle([point1,point2,point3],cull)}}}else{if(vertices[0]instanceof Phaser.Point){for(i=0;i<indices.length/3;i++){points.push(vertices[indices[i*3]]);points.push(vertices[indices[i*3+1]]);points.push(vertices[indices[i*3+2]]);if(points.length===3){this.drawTriangle(points,cull);points=[]}}}else{for(i=0;i<indices.length;i++){point1.x=vertices[indices[i]*2];point1.y=vertices[indices[i]*2+1];points.push(point1.copyTo({}));if(points.length===3){this.drawTriangle(points,cull);points=[]}}}}};Phaser.RenderTexture=function(game,width,height,key,scaleMode,resolution){if(typeof key==="undefined"){key=""}if(typeof scaleMode==="undefined"){scaleMode=Phaser.scaleModes.DEFAULT}if(typeof resolution==="undefined"){resolution=1}this.game=game;this.key=key;this.type=Phaser.RENDERTEXTURE;this.matrix=new PIXI.Matrix;PIXI.RenderTexture.call(this,width,height,this.game.renderer,scaleMode,resolution);this.render=Phaser.RenderTexture.prototype.render};Phaser.RenderTexture.prototype=Object.create(PIXI.RenderTexture.prototype);Phaser.RenderTexture.prototype.constructor=Phaser.RenderTexture;Phaser.RenderTexture.prototype.renderXY=function(displayObject,x,y,clear){this.matrix.tx=x;this.matrix.ty=y;if(this.renderer.type===PIXI.WEBGL_RENDERER){this.renderWebGL(displayObject,this.matrix,clear)}else{this.renderCanvas(displayObject,this.matrix,clear)}};Phaser.RenderTexture.prototype.render=function(displayObject,position,clear){this.matrix.tx=position.x;this.matrix.ty=position.y;if(this.renderer.type===PIXI.WEBGL_RENDERER){this.renderWebGL(displayObject,this.matrix,clear)}else{this.renderCanvas(displayObject,this.matrix,clear)}};Phaser.Text=function(game,x,y,text,style){x=x||0;y=y||0;text=text||" ";style=style||{};if(text.length===0){text=" "}else{text=text.toString()}this.type=Phaser.TEXT;this.physicsType=Phaser.SPRITE;this.padding=new Phaser.Point;this._text=text;this._fontComponents=null;this._lineSpacing=0;this._charCount=0;this.colors=[];this.setStyle(style);PIXI.Text.call(this,text,this.style);Phaser.Component.Core.init.call(this,game,x,y,"",null);if(text!==" "){this.updateText()}};Phaser.Text.prototype=Object.create(PIXI.Text.prototype);Phaser.Text.prototype.constructor=Phaser.Text;Phaser.Component.Core.install.call(Phaser.Text.prototype,["Angle","AutoCull","Bounds","BringToTop","Destroy","FixedToCamera","InputEnabled","InWorld","LifeSpan","Overlap","PhysicsBody","Reset","Smoothed"]);Phaser.Text.prototype.preUpdatePhysics=Phaser.Component.PhysicsBody.preUpdate;Phaser.Text.prototype.preUpdateLifeSpan=Phaser.Component.LifeSpan.preUpdate;Phaser.Text.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.Text.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.Text.prototype.preUpdate=function(){if(!this.preUpdatePhysics()||!this.preUpdateLifeSpan()||!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.Text.prototype.update=function(){};Phaser.Text.prototype.destroy=function(destroyChildren){this.texture.destroy(true);if(this.canvas&&this.canvas.parentNode){this.canvas.parentNode.removeChild(this.canvas)}else{this.canvas=null;this.context=null}Phaser.Component.Destroy.prototype.destroy.call(this,destroyChildren)};Phaser.Text.prototype.setShadow=function(x,y,color,blur){if(typeof x==="undefined"){x=0}if(typeof y==="undefined"){y=0}if(typeof color==="undefined"){color="rgba(0, 0, 0, 1)"}if(typeof blur==="undefined"){blur=0}this.style.shadowOffsetX=x;this.style.shadowOffsetY=y;this.style.shadowColor=color;this.style.shadowBlur=blur;this.dirty=true};Phaser.Text.prototype.setStyle=function(style){style=style||{};style.font=style.font||"bold 20pt Arial";style.backgroundColor=style.backgroundColor||null;style.fill=style.fill||"black";style.align=style.align||"left";style.stroke=style.stroke||"black";style.strokeThickness=style.strokeThickness||0;style.wordWrap=style.wordWrap||false;style.wordWrapWidth=style.wordWrapWidth||100;style.shadowOffsetX=style.shadowOffsetX||0;style.shadowOffsetY=style.shadowOffsetY||0;style.shadowColor=style.shadowColor||"rgba(0,0,0,0)";style.shadowBlur=style.shadowBlur||0;var components=this.fontToComponents(style.font);if(style.fontStyle){components.fontStyle=style.fontStyle}if(style.fontVariant){components.fontVariant=style.fontVariant}if(style.fontWeight){components.fontWeight=style.fontWeight}if(style.fontSize){if(typeof style.fontSize==="number"){style.fontSize=style.fontSize+"px"}components.fontSize=style.fontSize}this._fontComponents=components;style.font=this.componentsToFont(this._fontComponents);this.style=style;this.dirty=true};Phaser.Text.prototype.updateText=function(){this.texture.baseTexture.resolution=this.resolution;this.context.font=this.style.font;var outputText=this.text;if(this.style.wordWrap){outputText=this.runWordWrap(this.text)}var lines=outputText.split(/(?:\r\n|\r|\n)/);var lineWidths=[];var maxLineWidth=0;var fontProperties=this.determineFontProperties(this.style.font);for(var i=0;i<lines.length;i++){var lineWidth=this.context.measureText(lines[i]).width+this.padding.x;lineWidths[i]=lineWidth;maxLineWidth=Math.max(maxLineWidth,lineWidth)}var width=maxLineWidth+this.style.strokeThickness;this.canvas.width=width*this.resolution;var lineHeight=fontProperties.fontSize+this.style.strokeThickness+this.padding.y;var height=lineHeight*lines.length;var lineSpacing=this._lineSpacing;if(lineSpacing<0&&Math.abs(lineSpacing)>lineHeight){lineSpacing=-lineHeight}if(lineSpacing!==0){var diff=lineSpacing*(lines.length-1);height+=diff}this.canvas.height=height*this.resolution;this.context.scale(this.resolution,this.resolution);if(navigator.isCocoonJS){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}if(this.style.backgroundColor){this.context.fillStyle=this.style.backgroundColor;this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}this.context.fillStyle=this.style.fill;this.context.font=this.style.font;this.context.strokeStyle=this.style.stroke;this.context.textBaseline="alphabetic";this.context.shadowOffsetX=this.style.shadowOffsetX;this.context.shadowOffsetY=this.style.shadowOffsetY;this.context.shadowColor=this.style.shadowColor;this.context.shadowBlur=this.style.shadowBlur;this.context.lineWidth=this.style.strokeThickness;this.context.lineCap="round";this.context.lineJoin="round";var linePositionX;var linePositionY;this._charCount=0;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(i>0){linePositionY+=lineSpacing*i}if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.colors.length>0){this.updateLine(lines[i],linePositionX,linePositionY)}else{if(this.style.stroke&&this.style.strokeThickness){this.context.strokeText(lines[i],linePositionX,linePositionY)}if(this.style.fill){this.context.fillText(lines[i],linePositionX,linePositionY)}}}this.updateTexture()};Phaser.Text.prototype.updateLine=function(line,x,y){for(var i=0;i<line.length;i++){var letter=line[i];if(this.colors[this._charCount]){this.context.fillStyle=this.colors[this._charCount];this.context.strokeStyle=this.colors[this._charCount]}if(this.style.stroke&&this.style.strokeThickness){this.context.strokeText(letter,x,y)}if(this.style.fill){this.context.fillText(letter,x,y)}x+=this.context.measureText(letter).width;this._charCount++}};Phaser.Text.prototype.clearColors=function(){this.colors=[];this.dirty=true};Phaser.Text.prototype.addColor=function(color,position){this.colors[position]=color;this.dirty=true};Phaser.Text.prototype.runWordWrap=function(text){var result="";var lines=text.split("\n");for(var i=0;i<lines.length;i++){var spaceLeft=this.style.wordWrapWidth;var words=lines[i].split(" ");for(var j=0;j<words.length;j++){var wordWidth=this.context.measureText(words[j]).width;var wordWidthWithSpace=wordWidth+this.context.measureText(" ").width;if(wordWidthWithSpace>spaceLeft){if(j>0){result+="\n"}result+=words[j]+" ";spaceLeft=this.style.wordWrapWidth-wordWidth}else{spaceLeft-=wordWidthWithSpace;result+=words[j]+" "}}if(i<lines.length-1){result+="\n"}}return result};Phaser.Text.prototype.updateFont=function(components){var font=this.componentsToFont(components);if(this.style.font!==font){this.style.font=font;this.dirty=true;if(this.parent){this.updateTransform()}}};Phaser.Text.prototype.fontToComponents=function(font){var m=font.match(/^\s*(?:\b(normal|italic|oblique|inherit)?\b)\s*(?:\b(normal|small-caps|inherit)?\b)\s*(?:\b(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit)?\b)\s*(?:\b(xx-small|x-small|small|medium|large|x-large|xx-large|larger|smaller|0|\d*(?:[.]\d*)?(?:%|[a-z]{2,5}))?\b)\s*(.*)\s*$/);if(m){return{font:font,fontStyle:m[1]||"normal",fontVariant:m[2]||"normal",fontWeight:m[3]||"normal",fontSize:m[4]||"medium",fontFamily:m[5]}}else{console.warn("Phaser.Text - unparsable CSS font: "+font);return{font:font}}};Phaser.Text.prototype.componentsToFont=function(components){var parts=[];var v;v=components.fontStyle;if(v&&v!=="normal"){parts.push(v)}v=components.fontVariant;if(v&&v!=="normal"){parts.push(v)}v=components.fontWeight;if(v&&v!=="normal"){parts.push(v)}v=components.fontSize;if(v&&v!=="medium"){parts.push(v)}v=components.fontFamily;if(v){parts.push(v)}if(!parts.length){parts.push(components.font)}return parts.join(" ")};Object.defineProperty(Phaser.Text.prototype,"text",{get:function(){return this._text},set:function(value){if(value!==this._text){this._text=value.toString()||" ";this.dirty=true;if(this.parent){this.updateTransform()}}}});Object.defineProperty(Phaser.Text.prototype,"cssFont",{get:function(){return this.componentsToFont(this._fontComponents)},set:function(value){value=value||"bold 20pt Arial";this._fontComponents=this.fontToComponents(value);this.updateFont(this._fontComponents)}});Object.defineProperty(Phaser.Text.prototype,"font",{get:function(){return this._fontComponents.fontFamily},set:function(value){value=value||"Arial";value=value.trim();if(!/^(?:inherit|serif|sans-serif|cursive|fantasy|monospace)$/.exec(value)&&!/['",]/.exec(value)){value="'"+value+"'"}this._fontComponents.fontFamily=value;this.updateFont(this._fontComponents)}});Object.defineProperty(Phaser.Text.prototype,"fontSize",{get:function(){var size=this._fontComponents.fontSize;if(size&&/(?:^0$|px$)/.exec(size)){return parseInt(size,10)}else{return size}},set:function(value){value=value||"0";if(typeof value==="number"){value=value+"px"}this._fontComponents.fontSize=value;this.updateFont(this._fontComponents)}});Object.defineProperty(Phaser.Text.prototype,"fontWeight",{get:function(){return this._fontComponents.fontWeight||"normal"},set:function(value){value=value||"normal";this._fontComponents.fontWeight=value;this.updateFont(this._fontComponents)}});Object.defineProperty(Phaser.Text.prototype,"fontStyle",{get:function(){return this._fontComponents.fontStyle||"normal"},set:function(value){value=value||"normal";this._fontComponents.fontStyle=value;this.updateFont(this._fontComponents)}});Object.defineProperty(Phaser.Text.prototype,"fontVariant",{get:function(){return this._fontComponents.fontVariant||"normal"},set:function(value){value=value||"normal";this._fontComponents.fontVariant=value;this.updateFont(this._fontComponents)}});Object.defineProperty(Phaser.Text.prototype,"fill",{get:function(){return this.style.fill},set:function(value){if(value!==this.style.fill){this.style.fill=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"align",{get:function(){return this.style.align},set:function(value){if(value!==this.style.align){this.style.align=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"stroke",{get:function(){return this.style.stroke},set:function(value){if(value!==this.style.stroke){this.style.stroke=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"strokeThickness",{get:function(){return this.style.strokeThickness},set:function(value){if(value!==this.style.strokeThickness){this.style.strokeThickness=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"wordWrap",{get:function(){return this.style.wordWrap},set:function(value){if(value!==this.style.wordWrap){this.style.wordWrap=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"wordWrapWidth",{get:function(){return this.style.wordWrapWidth},set:function(value){if(value!==this.style.wordWrapWidth){this.style.wordWrapWidth=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"lineSpacing",{get:function(){return this._lineSpacing},set:function(value){if(value!==this._lineSpacing){this._lineSpacing=parseFloat(value);this.dirty=true;if(this.parent){this.updateTransform()}}}});Object.defineProperty(Phaser.Text.prototype,"shadowOffsetX",{get:function(){return this.style.shadowOffsetX},set:function(value){if(value!==this.style.shadowOffsetX){this.style.shadowOffsetX=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"shadowOffsetY",{get:function(){return this.style.shadowOffsetY},set:function(value){if(value!==this.style.shadowOffsetY){this.style.shadowOffsetY=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"shadowColor",{get:function(){return this.style.shadowColor},set:function(value){if(value!==this.style.shadowColor){this.style.shadowColor=value;this.dirty=true}}});Object.defineProperty(Phaser.Text.prototype,"shadowBlur",{get:function(){return this.style.shadowBlur},set:function(value){if(value!==this.style.shadowBlur){this.style.shadowBlur=value;this.dirty=true}}});Phaser.BitmapText=function(game,x,y,font,text,size){x=x||0;y=y||0;font=font||"";text=text||"";size=size||32;this.type=Phaser.BITMAPTEXT;this.physicsType=Phaser.SPRITE;this._text=text;this._font=font;this._fontSize=size;this._align="left";this._tint=16777215;this._tw=0;this._th=0;PIXI.BitmapText.call(this,text);Phaser.Component.Core.init.call(this,game,x,y,"",null)};Phaser.BitmapText.prototype=Object.create(PIXI.BitmapText.prototype);Phaser.BitmapText.prototype.constructor=Phaser.BitmapText;Phaser.Component.Core.install.call(Phaser.BitmapText.prototype,["Angle","AutoCull","Bounds","Destroy","FixedToCamera","InputEnabled","InWorld","LifeSpan","PhysicsBody","Reset"]);Phaser.BitmapText.prototype.preUpdatePhysics=Phaser.Component.PhysicsBody.preUpdate;Phaser.BitmapText.prototype.preUpdateLifeSpan=Phaser.Component.LifeSpan.preUpdate;Phaser.BitmapText.prototype.preUpdateInWorld=Phaser.Component.InWorld.preUpdate;Phaser.BitmapText.prototype.preUpdateCore=Phaser.Component.Core.preUpdate;Phaser.BitmapText.prototype.preUpdate=function(){if(!this.preUpdatePhysics()||!this.preUpdateLifeSpan()||!this.preUpdateInWorld()){return false}return this.preUpdateCore()};Phaser.BitmapText.prototype.postUpdate=function(){Phaser.Component.PhysicsBody.postUpdate.call(this);Phaser.Component.FixedToCamera.postUpdate.call(this);if(this.body&&(this.textWidth!==this._tw||this.textHeight!==this._th)){this.body.setSize(this.textWidth,this.textHeight);this._tw=this.textWidth;this._th=this.textHeight}};Phaser.BitmapText.prototype.setStyle=function(){this.style={align:this._align};this.fontName=this._font;this.fontSize=this._fontSize;this.dirty=true};Object.defineProperty(Phaser.BitmapText.prototype,"align",{get:function(){return this._align},set:function(value){if(value!==this._align){this._align=value;this.setStyle()}}});Object.defineProperty(Phaser.BitmapText.prototype,"tint",{get:function(){return this._tint},set:function(value){if(value!==this._tint){this._tint=value;
this.dirty=true}}});Object.defineProperty(Phaser.BitmapText.prototype,"font",{get:function(){return this._font},set:function(value){if(value!==this._font){this._font=value.trim();this.fontName=this._font;this.style.font=this._fontSize+"px '"+this._font+"'";this.dirty=true}}});Object.defineProperty(Phaser.BitmapText.prototype,"fontSize",{get:function(){return this._fontSize},set:function(value){value=parseInt(value,10);if(value!==this._fontSize){this._fontSize=value;this.style.font=this._fontSize+"px '"+this._font+"'";this.dirty=true}}});Object.defineProperty(Phaser.BitmapText.prototype,"text",{get:function(){return this._text},set:function(value){if(value!==this._text){this._text=value.toString()||" ";this.dirty=true}}});Phaser.RetroFont=function(game,key,characterWidth,characterHeight,chars,charsPerRow,xSpacing,ySpacing,xOffset,yOffset){if(!game.cache.checkImageKey(key)){return false}if(typeof charsPerRow==="undefined"||charsPerRow===null){charsPerRow=game.cache.getImage(key).width/characterWidth}this.characterWidth=characterWidth;this.characterHeight=characterHeight;this.characterSpacingX=xSpacing||0;this.characterSpacingY=ySpacing||0;this.characterPerRow=charsPerRow;this.offsetX=xOffset||0;this.offsetY=yOffset||0;this.align="left";this.multiLine=false;this.autoUpperCase=true;this.customSpacingX=0;this.customSpacingY=0;this.fixedWidth=0;this.fontSet=game.cache.getImage(key);this._text="";this.grabData=[];this.frameData=new Phaser.FrameData;var currentX=this.offsetX;var currentY=this.offsetY;var r=0;for(var c=0;c<chars.length;c++){var uuid=game.rnd.uuid();var frame=this.frameData.addFrame(new Phaser.Frame(c,currentX,currentY,this.characterWidth,this.characterHeight,"",uuid));this.grabData[chars.charCodeAt(c)]=frame.index;PIXI.TextureCache[uuid]=new PIXI.Texture(PIXI.BaseTextureCache[key],{x:currentX,y:currentY,width:this.characterWidth,height:this.characterHeight});r++;if(r==this.characterPerRow){r=0;currentX=this.offsetX;currentY+=this.characterHeight+this.characterSpacingY}else{currentX+=this.characterWidth+this.characterSpacingX}}game.cache.updateFrameData(key,this.frameData);this.stamp=new Phaser.Image(game,0,0,key,0);Phaser.RenderTexture.call(this,game,100,100,"",Phaser.scaleModes.NEAREST);this.type=Phaser.RETROFONT};Phaser.RetroFont.prototype=Object.create(Phaser.RenderTexture.prototype);Phaser.RetroFont.prototype.constructor=Phaser.RetroFont;Phaser.RetroFont.ALIGN_LEFT="left";Phaser.RetroFont.ALIGN_RIGHT="right";Phaser.RetroFont.ALIGN_CENTER="center";Phaser.RetroFont.TEXT_SET1=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";Phaser.RetroFont.TEXT_SET2=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ";Phaser.RetroFont.TEXT_SET3="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ";Phaser.RetroFont.TEXT_SET4="ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789";Phaser.RetroFont.TEXT_SET5="ABCDEFGHIJKLMNOPQRSTUVWXYZ.,/() '!?-*:0123456789";Phaser.RetroFont.TEXT_SET6="ABCDEFGHIJKLMNOPQRSTUVWXYZ!?:;0123456789\"(),-.' ";Phaser.RetroFont.TEXT_SET7="AGMSY+:4BHNTZ!;5CIOU.?06DJPV,(17EKQW\")28FLRX-'39";Phaser.RetroFont.TEXT_SET8="0123456789 .ABCDEFGHIJKLMNOPQRSTUVWXYZ";Phaser.RetroFont.TEXT_SET9="ABCDEFGHIJKLMNOPQRSTUVWXYZ()-0123456789.:,'\"?!";Phaser.RetroFont.TEXT_SET10="ABCDEFGHIJKLMNOPQRSTUVWXYZ";Phaser.RetroFont.TEXT_SET11="ABCDEFGHIJKLMNOPQRSTUVWXYZ.,\"-+!?()':;0123456789";Phaser.RetroFont.prototype.setFixedWidth=function(width,lineAlignment){if(typeof lineAlignment==="undefined"){lineAlignment="left"}this.fixedWidth=width;this.align=lineAlignment};Phaser.RetroFont.prototype.setText=function(content,multiLine,characterSpacing,lineSpacing,lineAlignment,allowLowerCase){this.multiLine=multiLine||false;this.customSpacingX=characterSpacing||0;this.customSpacingY=lineSpacing||0;this.align=lineAlignment||"left";if(allowLowerCase){this.autoUpperCase=false}else{this.autoUpperCase=true}if(content.length>0){this.text=content}};Phaser.RetroFont.prototype.buildRetroFontText=function(){var cx=0;var cy=0;this.clear();if(this.multiLine){var lines=this._text.split("\n");if(this.fixedWidth>0){this.resize(this.fixedWidth,lines.length*(this.characterHeight+this.customSpacingY)-this.customSpacingY,true)}else{this.resize(this.getLongestLine()*(this.characterWidth+this.customSpacingX),lines.length*(this.characterHeight+this.customSpacingY)-this.customSpacingY,true)}for(var i=0;i<lines.length;i++){switch(this.align){case Phaser.RetroFont.ALIGN_LEFT:cx=0;break;case Phaser.RetroFont.ALIGN_RIGHT:cx=this.width-lines[i].length*(this.characterWidth+this.customSpacingX);break;case Phaser.RetroFont.ALIGN_CENTER:cx=this.width/2-lines[i].length*(this.characterWidth+this.customSpacingX)/2;cx+=this.customSpacingX/2;break}if(cx<0){cx=0}this.pasteLine(lines[i],cx,cy,this.customSpacingX);cy+=this.characterHeight+this.customSpacingY}}else{if(this.fixedWidth>0){this.resize(this.fixedWidth,this.characterHeight,true)}else{this.resize(this._text.length*(this.characterWidth+this.customSpacingX),this.characterHeight,true)}switch(this.align){case Phaser.RetroFont.ALIGN_LEFT:cx=0;break;case Phaser.RetroFont.ALIGN_RIGHT:cx=this.width-this._text.length*(this.characterWidth+this.customSpacingX);break;case Phaser.RetroFont.ALIGN_CENTER:cx=this.width/2-this._text.length*(this.characterWidth+this.customSpacingX)/2;cx+=this.customSpacingX/2;break}this.textureBuffer.clear();this.pasteLine(this._text,cx,0,this.customSpacingX)}};Phaser.RetroFont.prototype.pasteLine=function(line,x,y,customSpacingX){var p=new Phaser.Point;for(var c=0;c<line.length;c++){if(line.charAt(c)==" "){x+=this.characterWidth+customSpacingX}else{if(this.grabData[line.charCodeAt(c)]>=0){this.stamp.frame=this.grabData[line.charCodeAt(c)];p.set(x,y);this.render(this.stamp,p,false);x+=this.characterWidth+customSpacingX;if(x>this.width){break}}}}};Phaser.RetroFont.prototype.getLongestLine=function(){var longestLine=0;if(this._text.length>0){var lines=this._text.split("\n");for(var i=0;i<lines.length;i++){if(lines[i].length>longestLine){longestLine=lines[i].length}}}return longestLine};Phaser.RetroFont.prototype.removeUnsupportedCharacters=function(stripCR){var newString="";for(var c=0;c<this._text.length;c++){var aChar=this._text[c];var code=aChar.charCodeAt(0);if(this.grabData[code]>=0||!stripCR&&aChar==="\n"){newString=newString.concat(aChar)}}return newString};Phaser.RetroFont.prototype.updateOffset=function(x,y){if(this.offsetX===x&&this.offsetY===y){return}var diffX=x-this.offsetX;var diffY=y-this.offsetY;var frames=this.game.cache.getFrameData(this.stamp.key).getFrames();var i=frames.length;while(i--){frames[i].x+=diffX;frames[i].y+=diffY;PIXI.TextureCache[frames[i].uuid].frame.x=frames[i].x;PIXI.TextureCache[frames[i].uuid].frame.y=frames[i].y}this.buildRetroFontText()};Object.defineProperty(Phaser.RetroFont.prototype,"text",{get:function(){return this._text},set:function(value){var newText;if(this.autoUpperCase){newText=value.toUpperCase()}else{newText=value}if(newText!==this._text){this._text=newText;this.removeUnsupportedCharacters(this.multiLine);this.buildRetroFontText()}}});Object.defineProperty(Phaser.RetroFont.prototype,"smoothed",{get:function(){return this.stamp.smoothed},set:function(value){this.stamp.smoothed=value;this.buildRetroFontText()}});Phaser.Device=function(){this.deviceReadyAt=0;this.initialized=false;this.desktop=false;this.iOS=false;this.cocoonJS=false;this.cocoonJSApp=false;this.cordova=false;this.node=false;this.nodeWebkit=false;this.ejecta=false;this.crosswalk=false;this.android=false;this.chromeOS=false;this.linux=false;this.macOS=false;this.windows=false;this.windowsPhone=false;this.canvas=false;this.canvasBitBltShift=null;this.webGL=false;this.file=false;this.fileSystem=false;this.localStorage=false;this.worker=false;this.css3D=false;this.pointerLock=false;this.typedArray=false;this.vibration=false;this.getUserMedia=false;this.quirksMode=false;this.touch=false;this.mspointer=false;this.wheelEvent=null;this.arora=false;this.chrome=false;this.epiphany=false;this.firefox=false;this.ie=false;this.ieVersion=0;this.trident=false;this.tridentVersion=0;this.mobileSafari=false;this.midori=false;this.opera=false;this.safari=false;this.webApp=false;this.silk=false;this.audioData=false;this.webAudio=false;this.ogg=false;this.opus=false;this.mp3=false;this.wav=false;this.m4a=false;this.webm=false;this.iPhone=false;this.iPhone4=false;this.iPad=false;this.pixelRatio=0;this.littleEndian=false;this.LITTLE_ENDIAN=false;this.support32bit=false;this.fullscreen=false;this.requestFullscreen="";this.cancelFullscreen="";this.fullscreenKeyboard=false};Phaser.Device=new Phaser.Device;Phaser.Device.onInitialized=new Phaser.Signal;Phaser.Device.whenReady=function(callback,context,nonPrimer){var readyCheck=this._readyCheck;if(this.deviceReadyAt||!readyCheck){callback.call(context,this)}else if(readyCheck._monitor||nonPrimer){readyCheck._queue=readyCheck._queue||[];readyCheck._queue.push([callback,context])}else{readyCheck._monitor=readyCheck.bind(this);readyCheck._queue=readyCheck._queue||[];readyCheck._queue.push([callback,context]);var cordova=typeof window.cordova!=="undefined";var cocoonJS=navigator["isCocoonJS"];if(document.readyState==="complete"||document.readyState==="interactive"){window.setTimeout(readyCheck._monitor,0)}else if(cordova&&!cocoonJS){document.addEventListener("deviceready",readyCheck._monitor,false)}else{document.addEventListener("DOMContentLoaded",readyCheck._monitor,false);window.addEventListener("load",readyCheck._monitor,false)}}};Phaser.Device._readyCheck=function(){var readyCheck=this._readyCheck;if(!document.body){window.setTimeout(readyCheck._monitor,20)}else if(!this.deviceReadyAt){this.deviceReadyAt=Date.now();document.removeEventListener("deviceready",readyCheck._monitor);document.removeEventListener("DOMContentLoaded",readyCheck._monitor);window.removeEventListener("load",readyCheck._monitor);this._initialize();this.initialized=true;this.onInitialized.dispatch(this);var item;while(item=readyCheck._queue.shift()){var callback=item[0];var context=item[1];callback.call(context,this)}this._readyCheck=null;this._initialize=null;this.onInitialized=null}};Phaser.Device._initialize=function(){var device=this;function _checkOS(){var ua=navigator.userAgent;if(/Playstation Vita/.test(ua)){device.vita=true}else if(/Kindle/.test(ua)||/\bKF[A-Z][A-Z]+/.test(ua)||/Silk.*Mobile Safari/.test(ua)){device.kindle=true}else if(/Android/.test(ua)){device.android=true}else if(/CrOS/.test(ua)){device.chromeOS=true}else if(/iP[ao]d|iPhone/i.test(ua)){device.iOS=true}else if(/Linux/.test(ua)){device.linux=true}else if(/Mac OS/.test(ua)){device.macOS=true}else if(/Windows/.test(ua)){device.windows=true;if(/Windows Phone/i.test(ua)){device.windowsPhone=true}}var silk=/Silk/.test(ua);if(device.windows||device.macOS||device.linux&&!silk||device.chromeOS){device.desktop=true}if(device.windowsPhone||/Windows NT/i.test(ua)&&/Touch/i.test(ua)){device.desktop=false}}function _checkFeatures(){device.canvas=!!window["CanvasRenderingContext2D"]||device.cocoonJS;try{device.localStorage=!!localStorage.getItem}catch(error){device.localStorage=false}device.file=!!window["File"]&&!!window["FileReader"]&&!!window["FileList"]&&!!window["Blob"];device.fileSystem=!!window["requestFileSystem"];device.webGL=function(){try{var canvas=document.createElement("canvas");canvas.screencanvas=false;return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}();device.webGL=!!device.webGL;device.worker=!!window["Worker"];device.pointerLock="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;device.quirksMode=document.compatMode==="CSS1Compat"?false:true;device.getUserMedia=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);if(!device.iOS&&(device.ie||device.firefox||device.chrome)){device.canvasBitBltShift=true}if(device.safari||device.mobileSafari){device.canvasBitBltShift=false}}function _checkInput(){if("ontouchstart"in document.documentElement||window.navigator.maxTouchPoints&&window.navigator.maxTouchPoints>=1){device.touch=true}if(window.navigator.msPointerEnabled||window.navigator.pointerEnabled){device.mspointer=true}if(!device.cocoonJS){if("onwheel"in window||device.ie&&"WheelEvent"in window){device.wheelEvent="wheel"}else if("onmousewheel"in window){device.wheelEvent="mousewheel"}else if(device.firefox&&"MouseScrollEvent"in window){device.wheelEvent="DOMMouseScroll"}}}function _checkFullScreenSupport(){var fs=["requestFullscreen","requestFullScreen","webkitRequestFullscreen","webkitRequestFullScreen","msRequestFullscreen","msRequestFullScreen","mozRequestFullScreen","mozRequestFullscreen"];var element=document.createElement("div");for(var i=0;i<fs.length;i++){if(element[fs[i]]){device.fullscreen=true;device.requestFullscreen=fs[i];break}}var cfs=["cancelFullScreen","exitFullscreen","webkitCancelFullScreen","webkitExitFullscreen","msCancelFullScreen","msExitFullscreen","mozCancelFullScreen","mozExitFullscreen"];if(device.fullscreen){for(var i=0;i<cfs.length;i++){if(document[cfs[i]]){device.cancelFullscreen=cfs[i];break}}}if(window["Element"]&&Element["ALLOW_KEYBOARD_INPUT"]){device.fullscreenKeyboard=true}}function _checkBrowser(){var ua=navigator.userAgent;if(/Arora/.test(ua)){device.arora=true}else if(/Chrome/.test(ua)){device.chrome=true}else if(/Epiphany/.test(ua)){device.epiphany=true}else if(/Firefox/.test(ua)){device.firefox=true}else if(/AppleWebKit/.test(ua)&&device.iOS){device.mobileSafari=true}else if(/MSIE (\d+\.\d+);/.test(ua)){device.ie=true;device.ieVersion=parseInt(RegExp.$1,10)}else if(/Midori/.test(ua)){device.midori=true}else if(/Opera/.test(ua)){device.opera=true}else if(/Safari/.test(ua)){device.safari=true}else if(/Trident\/(\d+\.\d+)(.*)rv:(\d+\.\d+)/.test(ua)){device.ie=true;device.trident=true;device.tridentVersion=parseInt(RegExp.$1,10);device.ieVersion=parseInt(RegExp.$3,10)}if(/Silk/.test(ua)){device.silk=true}if(navigator["standalone"]){device.webApp=true}if(typeof window.cordova!=="undefined"){device.cordova=true}if(typeof process!=="undefined"&&typeof require!=="undefined"){device.node=true}if(device.node){try{device.nodeWebkit=typeof require("nw.gui")!=="undefined"}catch(error){device.nodeWebkit=false}}if(navigator["isCocoonJS"]){device.cocoonJS=true}if(device.cocoonJS){try{device.cocoonJSApp=typeof CocoonJS!=="undefined"}catch(error){device.cocoonJSApp=false}}if(typeof window.ejecta!=="undefined"){device.ejecta=true}if(/Crosswalk/.test(ua)){device.crosswalk=true}}function _checkAudio(){device.audioData=!!window["Audio"];device.webAudio=!!(window["AudioContext"]||window["webkitAudioContext"]);var audioElement=document.createElement("audio");var result=false;try{if(result=!!audioElement.canPlayType){if(audioElement.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")){device.ogg=true}if(audioElement.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,"")||audioElement.canPlayType("audio/opus;").replace(/^no$/,"")){device.opus=true}if(audioElement.canPlayType("audio/mpeg;").replace(/^no$/,"")){device.mp3=true}if(audioElement.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"")){device.wav=true}if(audioElement.canPlayType("audio/x-m4a;")||audioElement.canPlayType("audio/aac;").replace(/^no$/,"")){device.m4a=true}if(audioElement.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")){device.webm=true}}}catch(e){}}function _checkDevice(){device.pixelRatio=window["devicePixelRatio"]||1;device.iPhone=navigator.userAgent.toLowerCase().indexOf("iphone")!=-1;device.iPhone4=device.pixelRatio==2&&device.iPhone;device.iPad=navigator.userAgent.toLowerCase().indexOf("ipad")!=-1;if(typeof Int8Array!=="undefined"){device.typedArray=true}else{device.typedArray=false}if(typeof ArrayBuffer!=="undefined"&&typeof Uint8Array!=="undefined"&&typeof Uint32Array!=="undefined"){device.littleEndian=_checkIsLittleEndian();device.LITTLE_ENDIAN=device.littleEndian}device.support32bit=typeof ArrayBuffer!=="undefined"&&typeof Uint8ClampedArray!=="undefined"&&typeof Int32Array!=="undefined"&&device.littleEndian!==null&&_checkIsUint8ClampedImageData();navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate;if(navigator.vibrate){device.vibration=true}}function _checkIsLittleEndian(){var a=new ArrayBuffer(4);var b=new Uint8Array(a);var c=new Uint32Array(a);b[0]=161;b[1]=178;b[2]=195;b[3]=212;if(c[0]==3569595041){return true}if(c[0]==2712847316){return false}else{return null}}function _checkIsUint8ClampedImageData(){if(typeof Uint8ClampedArray==="undefined"){return false}var elem=document.createElement("canvas");var ctx=elem.getContext("2d");if(!ctx){return false}var image=ctx.createImageData(1,1);return image.data instanceof Uint8ClampedArray}function _checkCSS3D(){var el=document.createElement("p");var has3d;var transforms={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"};document.body.insertBefore(el,null);for(var t in transforms){if(el.style[t]!==undefined){el.style[t]="translate3d(1px,1px,1px)";has3d=window.getComputedStyle(el).getPropertyValue(transforms[t])}}document.body.removeChild(el);device.css3D=has3d!==undefined&&has3d.length>0&&has3d!=="none"}_checkOS();_checkAudio();_checkBrowser();_checkCSS3D();_checkDevice();_checkFeatures();_checkFullScreenSupport();_checkInput()};Phaser.Device.canPlayAudio=function(type){if(type=="mp3"&&this.mp3){return true}else if(type=="ogg"&&(this.ogg||this.opus)){return true}else if(type=="m4a"&&this.m4a){return true}else if(type=="opus"&&this.opus){return true}else if(type=="wav"&&this.wav){return true}else if(type=="webm"&&this.webm){return true}return false};Phaser.Device.isConsoleOpen=function(){if(window.console&&window.console["firebug"]){return true}if(window.console){console.profile();console.profileEnd();if(console.clear){console.clear()}if(console["profiles"]){return console["profiles"].length>0}}return false};Phaser.Device.isAndroidStockBrowser=function(){var matches=window.navigator.userAgent.match(/Android.*AppleWebKit\/([\d.]+)/);return matches&&matches[1]<537};Phaser.DOM={getOffset:function(element,point){point=point||new Phaser.Point;var box=element.getBoundingClientRect();var scrollTop=Phaser.DOM.scrollY;var scrollLeft=Phaser.DOM.scrollX;var clientTop=document.documentElement.clientTop;var clientLeft=document.documentElement.clientLeft;point.x=box.left+scrollLeft-clientLeft;point.y=box.top+scrollTop-clientTop;return point},getBounds:function(element,cushion){if(typeof cushion==="undefined"){cushion=0}element=element&&!element.nodeType?element[0]:element;if(!element||element.nodeType!==1){return false}else{return this.calibrate(element.getBoundingClientRect(),cushion)}},calibrate:function(coords,cushion){cushion=+cushion||0;var output={width:0,height:0,left:0,right:0,top:0,bottom:0};output.width=(output.right=coords.right+cushion)-(output.left=coords.left-cushion);output.height=(output.bottom=coords.bottom+cushion)-(output.top=coords.top-cushion);return output},getAspectRatio:function(object){object=null==object?this.visualBounds:1===object.nodeType?this.getBounds(object):object;var w=object["width"];var h=object["height"];if(typeof w==="function"){w=w.call(object)}if(typeof h==="function"){h=h.call(object)}return w/h},inLayoutViewport:function(element,cushion){var r=this.getBounds(element,cushion);return!!r&&r.bottom>=0&&r.right>=0&&r.top<=this.layoutBounds.width&&r.left<=this.layoutBounds.height},getScreenOrientation:function(primaryFallback){var screen=window.screen;var orientation=screen.orientation||screen.mozOrientation||screen.msOrientation;if(orientation&&typeof orientation.type==="string"){return orientation.type}else if(typeof orientation==="string"){return orientation}var PORTRAIT="portrait-primary";var LANDSCAPE="landscape-primary";if(primaryFallback==="screen"){return screen.height>screen.width?PORTRAIT:LANDSCAPE}else if(primaryFallback==="viewport"){return this.visualBounds.height>this.visualBounds.width?PORTRAIT:LANDSCAPE}else if(primaryFallback==="window.orientation"&&typeof window.orientation==="number"){return window.orientation===0||window.orientation===180?PORTRAIT:LANDSCAPE}else if(window.matchMedia){if(window.matchMedia("(orientation: portrait)").matches){return PORTRAIT}else if(window.matchMedia("(orientation: landscape)").matches){return LANDSCAPE}}return this.visualBounds.height>this.visualBounds.width?PORTRAIT:LANDSCAPE},visualBounds:new Phaser.Rectangle,layoutBounds:new Phaser.Rectangle,documentBounds:new Phaser.Rectangle};Phaser.Device.whenReady(function(device){var scrollX=window&&"pageXOffset"in window?function(){return window.pageXOffset}:function(){return document.documentElement.scrollLeft};var scrollY=window&&"pageYOffset"in window?function(){return window.pageYOffset}:function(){return document.documentElement.scrollTop};Object.defineProperty(Phaser.DOM,"scrollX",{get:scrollX});Object.defineProperty(Phaser.DOM,"scrollY",{get:scrollY});Object.defineProperty(Phaser.DOM.visualBounds,"x",{get:scrollX});Object.defineProperty(Phaser.DOM.visualBounds,"y",{get:scrollY});Object.defineProperty(Phaser.DOM.layoutBounds,"x",{value:0});Object.defineProperty(Phaser.DOM.layoutBounds,"y",{value:0});var treatAsDesktop=device.desktop&&document.documentElement.clientWidth<=window.innerWidth&&document.documentElement.clientHeight<=window.innerHeight;if(treatAsDesktop){var clientWidth=function(){return Math.max(window.innerWidth,document.documentElement.clientWidth)};var clientHeight=function(){return Math.max(window.innerHeight,document.documentElement.clientHeight)};Object.defineProperty(Phaser.DOM.visualBounds,"width",{get:clientWidth});Object.defineProperty(Phaser.DOM.visualBounds,"height",{get:clientHeight});Object.defineProperty(Phaser.DOM.layoutBounds,"width",{get:clientWidth});Object.defineProperty(Phaser.DOM.layoutBounds,"height",{get:clientHeight})}else{Object.defineProperty(Phaser.DOM.visualBounds,"width",{get:function(){return window.innerWidth}});Object.defineProperty(Phaser.DOM.visualBounds,"height",{get:function(){return window.innerHeight}});Object.defineProperty(Phaser.DOM.layoutBounds,"width",{get:function(){var a=document.documentElement.clientWidth;var b=window.innerWidth;return a<b?b:a}});Object.defineProperty(Phaser.DOM.layoutBounds,"height",{get:function(){var a=document.documentElement.clientHeight;var b=window.innerHeight;return a<b?b:a}})}Object.defineProperty(Phaser.DOM.documentBounds,"x",{value:0});Object.defineProperty(Phaser.DOM.documentBounds,"y",{value:0});Object.defineProperty(Phaser.DOM.documentBounds,"width",{get:function(){var d=document.documentElement;return Math.max(d.clientWidth,d.offsetWidth,d.scrollWidth)}});Object.defineProperty(Phaser.DOM.documentBounds,"height",{get:function(){var d=document.documentElement;return Math.max(d.clientHeight,d.offsetHeight,d.scrollHeight)}})},null,true);Phaser.Canvas={create:function(width,height,id){width=width||256;height=height||256;var canvas=document.createElement("canvas");if(typeof id==="string"&&id!==""){canvas.id=id}canvas.width=width;canvas.height=height;canvas.style.display="block";return canvas},setBackgroundColor:function(canvas,color){color=color||"rgb(0,0,0)";canvas.style.backgroundColor=color;return canvas},setTouchAction:function(canvas,value){value=value||"none";canvas.style.msTouchAction=value;canvas.style["ms-touch-action"]=value;canvas.style["touch-action"]=value;return canvas},setUserSelect:function(canvas,value){value=value||"none";canvas.style["-webkit-touch-callout"]=value;canvas.style["-webkit-user-select"]=value;canvas.style["-khtml-user-select"]=value;canvas.style["-moz-user-select"]=value;canvas.style["-ms-user-select"]=value;canvas.style["user-select"]=value;canvas.style["-webkit-tap-highlight-color"]="rgba(0, 0, 0, 0)";return canvas},addToDOM:function(canvas,parent,overflowHidden){var target;if(typeof overflowHidden==="undefined"){overflowHidden=true}if(parent){if(typeof parent==="string"){target=document.getElementById(parent)}else if(typeof parent==="object"&&parent.nodeType===1){target=parent}}if(!target){target=document.body}if(overflowHidden&&target.style){target.style.overflow="hidden"}target.appendChild(canvas);return canvas},removeFromDOM:function(canvas){if(canvas.parentNode){canvas.parentNode.removeChild(canvas)}},setTransform:function(context,translateX,translateY,scaleX,scaleY,skewX,skewY){context.setTransform(scaleX,skewX,skewY,scaleY,translateX,translateY);return context},setSmoothingEnabled:function(context,value){context["imageSmoothingEnabled"]=value;context["mozImageSmoothingEnabled"]=value;context["oImageSmoothingEnabled"]=value;context["webkitImageSmoothingEnabled"]=value;context["msImageSmoothingEnabled"]=value;return context},getSmoothingEnabled:function(context){return context["imageSmoothingEnabled"]||context["mozImageSmoothingEnabled"]||context["oImageSmoothingEnabled"]||context["webkitImageSmoothingEnabled"]||context["msImageSmoothingEnabled"]},setImageRenderingCrisp:function(canvas){canvas.style["image-rendering"]="optimizeSpeed";canvas.style["image-rendering"]="crisp-edges";canvas.style["image-rendering"]="-moz-crisp-edges";canvas.style["image-rendering"]="-webkit-optimize-contrast";canvas.style["image-rendering"]="optimize-contrast";canvas.style["image-rendering"]="pixelated";canvas.style.msInterpolationMode="nearest-neighbor";return canvas},setImageRenderingBicubic:function(canvas){canvas.style["image-rendering"]="auto";canvas.style.msInterpolationMode="bicubic";return canvas}};Phaser.Canvas.getOffset=Phaser.DOM.getOffset;Phaser.Canvas.getAspectRatio=Phaser.DOM.getAspectRatio;Phaser.RequestAnimationFrame=function(game,forceSetTimeOut){if(typeof forceSetTimeOut==="undefined"){forceSetTimeOut=false}this.game=game;this.isRunning=false;this.forceSetTimeOut=forceSetTimeOut;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;x++){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]}this._isSetTimeOut=false;this._onLoop=null;this._timeOutID=null};Phaser.RequestAnimationFrame.prototype={start:function(){this.isRunning=true;var _this=this;if(!window.requestAnimationFrame||this.forceSetTimeOut){this._isSetTimeOut=true;this._onLoop=function(){return _this.updateSetTimeout()};this._timeOutID=window.setTimeout(this._onLoop,0)}else{this._isSetTimeOut=false;this._onLoop=function(time){return _this.updateRAF(time)};this._timeOutID=window.requestAnimationFrame(this._onLoop)}},updateRAF:function(rafTime){this.game.update(Math.floor(rafTime));this._timeOutID=window.requestAnimationFrame(this._onLoop)},updateSetTimeout:function(){this.game.update(Date.now());this._timeOutID=window.setTimeout(this._onLoop,this.game.time.timeToCall)},stop:function(){if(this._isSetTimeOut){clearTimeout(this._timeOutID)}else{window.cancelAnimationFrame(this._timeOutID)}this.isRunning=false},isSetTimeOut:function(){return this._isSetTimeOut},isRAF:function(){return this._isSetTimeOut===false}};Phaser.RequestAnimationFrame.prototype.constructor=Phaser.RequestAnimationFrame;Phaser.Math={PI2:Math.PI*2,fuzzyEqual:function(a,b,epsilon){if(typeof epsilon==="undefined"){epsilon=1e-4}return Math.abs(a-b)<epsilon},fuzzyLessThan:function(a,b,epsilon){if(typeof epsilon==="undefined"){epsilon=1e-4}return a<b+epsilon},fuzzyGreaterThan:function(a,b,epsilon){if(typeof epsilon==="undefined"){epsilon=1e-4}return a>b-epsilon},fuzzyCeil:function(val,epsilon){if(typeof epsilon==="undefined"){epsilon=1e-4}return Math.ceil(val-epsilon)},fuzzyFloor:function(val,epsilon){if(typeof epsilon==="undefined"){epsilon=1e-4}return Math.floor(val+epsilon)},average:function(){var sum=0;for(var i=0;i<arguments.length;i++){sum+=+arguments[i]}return sum/arguments.length},truncate:function(n){return Math.trunc(n)},shear:function(n){return n%1},snapTo:function(input,gap,start){if(typeof start==="undefined"){start=0}if(gap===0){return input}input-=start;input=gap*Math.round(input/gap);return start+input},snapToFloor:function(input,gap,start){if(typeof start==="undefined"){start=0}if(gap===0){return input}input-=start;input=gap*Math.floor(input/gap);return start+input},snapToCeil:function(input,gap,start){if(typeof start==="undefined"){start=0}if(gap===0){return input}input-=start;input=gap*Math.ceil(input/gap);return start+input},snapToInArray:function(input,arr,sort){if(typeof sort==="undefined"){sort=true}if(sort){arr.sort()}return Phaser.ArrayUtils.findClosest(input,arr)},roundTo:function(value,place,base){if(typeof place==="undefined"){place=0}if(typeof base==="undefined"){base=10}var p=Math.pow(base,-place);return Math.round(value*p)/p},floorTo:function(value,place,base){if(typeof place==="undefined"){place=0}if(typeof base==="undefined"){base=10}var p=Math.pow(base,-place);return Math.floor(value*p)/p},ceilTo:function(value,place,base){if(typeof place==="undefined"){place=0}if(typeof base==="undefined"){base=10}var p=Math.pow(base,-place);return Math.ceil(value*p)/p},interpolateFloat:function(a,b,weight){return(b-a)*weight+a},angleBetween:function(x1,y1,x2,y2){return Math.atan2(y2-y1,x2-x1)},angleBetweenY:function(x1,y1,x2,y2){return Math.atan2(x2-x1,y2-y1)},angleBetweenPoints:function(point1,point2){return Math.atan2(point2.y-point1.y,point2.x-point1.x)},angleBetweenPointsY:function(point1,point2){return Math.atan2(point2.x-point1.x,point2.y-point1.y)},reverseAngle:function(angleRad){return this.normalizeAngle(angleRad+Math.PI,true)},normalizeAngle:function(angleRad){angleRad=angleRad%(2*Math.PI);return angleRad>=0?angleRad:angleRad+2*Math.PI},normalizeLatitude:function(lat){return Phaser.Math.clamp(lat,-90,90)},normalizeLongitude:function(lng){return Phaser.Math.wrap(lng,-180,180)},chanceRoll:function(chance){return Phaser.Utils.chanceRoll(chance)},numberArray:function(start,end){return Phaser.ArrayUtils.numberArray(start,end)},numberArrayStep:function(start,end,step){return Phaser.ArrayUtils.numberArrayStep(start,end,step)},maxAdd:function(value,amount,max){return Math.min(value+amount,max)},minSub:function(value,amount,min){return Math.max(value-amount,min)},wrap:function(value,min,max){var range=max-min;if(range<=0){return 0}var result=(value-min)%range;if(result<0){result+=range}return result+min},wrapValue:function(value,amount,max){var diff;value=Math.abs(value);amount=Math.abs(amount);max=Math.abs(max);diff=(value+amount)%max;return diff},limitValue:function(value,min,max){return Phaser.Math.clamp(value,min,max)},randomSign:function(){return Phaser.Utils.randomChoice(-1,1)},isOdd:function(n){return n&1},isEven:function(n){return!(n&1)},min:function(){if(arguments.length===1&&typeof arguments[0]==="object"){var data=arguments[0]}else{var data=arguments}for(var i=1,min=0,len=data.length;i<len;i++){if(data[i]<data[min]){min=i}}return data[min]},max:function(){if(arguments.length===1&&typeof arguments[0]==="object"){var data=arguments[0]}else{var data=arguments}for(var i=1,max=0,len=data.length;i<len;i++){if(data[i]>data[max]){max=i}}return data[max]},minProperty:function(property){if(arguments.length===2&&typeof arguments[1]==="object"){var data=arguments[1]}else{var data=arguments.slice(1)}for(var i=1,min=0,len=data.length;i<len;i++){if(data[i][property]<data[min][property]){min=i}}return data[min][property]},maxProperty:function(property){if(arguments.length===2&&typeof arguments[1]==="object"){var data=arguments[1]}else{var data=arguments.slice(1)}for(var i=1,max=0,len=data.length;i<len;i++){if(data[i][property]>data[max][property]){max=i}}return data[max][property]},wrapAngle:function(angle,radians){return radians?this.wrap(angle,-Math.PI,Math.PI):this.wrap(angle,-180,180)},angleLimit:function(angle,min,max){var result=angle;if(angle>max){result=max}else if(angle<min){result=min}return result},linearInterpolation:function(v,k){var m=v.length-1;
var f=m*k;var i=Math.floor(f);if(k<0){return this.linear(v[0],v[1],f)}if(k>1){return this.linear(v[m],v[m-1],m-f)}return this.linear(v[i],v[i+1>m?m:i+1],f-i)},bezierInterpolation:function(v,k){var b=0;var n=v.length-1;for(var i=0;i<=n;i++){b+=Math.pow(1-k,n-i)*Math.pow(k,i)*v[i]*this.bernstein(n,i)}return b},catmullRomInterpolation:function(v,k){var m=v.length-1;var f=m*k;var i=Math.floor(f);if(v[0]===v[m]){if(k<0){i=Math.floor(f=m*(1+k))}return this.catmullRom(v[(i-1+m)%m],v[i],v[(i+1)%m],v[(i+2)%m],f-i)}else{if(k<0){return v[0]-(this.catmullRom(v[0],v[0],v[1],v[1],-f)-v[0])}if(k>1){return v[m]-(this.catmullRom(v[m],v[m],v[m-1],v[m-1],f-m)-v[m])}return this.catmullRom(v[i?i-1:0],v[i],v[m<i+1?m:i+1],v[m<i+2?m:i+2],f-i)}},linear:function(p0,p1,t){return(p1-p0)*t+p0},bernstein:function(n,i){return this.factorial(n)/this.factorial(i)/this.factorial(n-i)},factorial:function(value){if(value===0){return 1}var res=value;while(--value){res*=value}return res},catmullRom:function(p0,p1,p2,p3,t){var v0=(p2-p0)*.5,v1=(p3-p1)*.5,t2=t*t,t3=t*t2;return(2*p1-2*p2+v0+v1)*t3+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1},difference:function(a,b){return Math.abs(a-b)},getRandom:function(objects,startIndex,length){return Phaser.ArrayUtils.getRandomItem(objects,startIndex,length)},removeRandom:function(objects,startIndex,length){return Phaser.ArrayUtils.removeRandomItem(objects,startIndex,length)},floor:function(value){return Math.trunc(value)},ceil:function(value){return Phaser.Math.roundAwayFromZero(value)},roundAwayFromZero:function(value){return value>0?Math.ceil(value):Math.floor(value)},sinCosGenerator:function(length,sinAmplitude,cosAmplitude,frequency){if(typeof sinAmplitude==="undefined"){sinAmplitude=1}if(typeof cosAmplitude==="undefined"){cosAmplitude=1}if(typeof frequency==="undefined"){frequency=1}var sin=sinAmplitude;var cos=cosAmplitude;var frq=frequency*Math.PI/length;var cosTable=[];var sinTable=[];for(var c=0;c<length;c++){cos-=sin*frq;sin+=cos*frq;cosTable[c]=cos;sinTable[c]=sin}return{sin:sinTable,cos:cosTable,length:length}},shift:function(array){var s=array.shift();array.push(s);return s},shuffleArray:function(array){return Phaser.ArrayUtils.shuffle(array)},distance:function(x1,y1,x2,y2){var dx=x1-x2;var dy=y1-y2;return Math.sqrt(dx*dx+dy*dy)},distancePow:function(x1,y1,x2,y2,pow){if(typeof pow==="undefined"){pow=2}return Math.sqrt(Math.pow(x2-x1,pow)+Math.pow(y2-y1,pow))},distanceRounded:function(x1,y1,x2,y2){return Math.round(Phaser.Math.distance(x1,y1,x2,y2))},clamp:function(x,a,b){return x<a?a:x>b?b:x},clampBottom:function(x,a){return x<a?a:x},within:function(a,b,tolerance){return Math.abs(a-b)<=tolerance},mapLinear:function(x,a1,a2,b1,b2){return b1+(x-a1)*(b2-b1)/(a2-a1)},smoothstep:function(x,min,max){x=Math.max(0,Math.min(1,(x-min)/(max-min)));return x*x*(3-2*x)},smootherstep:function(x,min,max){x=Math.max(0,Math.min(1,(x-min)/(max-min)));return x*x*x*(x*(x*6-15)+10)},sign:function(x){return x<0?-1:x>0?1:0},percent:function(a,b,base){if(typeof base==="undefined"){base=0}if(a>b||base>b){return 1}else if(a<base||base>a){return 0}else{return(a-base)/b}}};var degreeToRadiansFactor=Math.PI/180;var radianToDegreesFactor=180/Math.PI;Phaser.Math.degToRad=function degToRad(degrees){return degrees*degreeToRadiansFactor};Phaser.Math.radToDeg=function radToDeg(radians){return radians*radianToDegreesFactor};Phaser.RandomDataGenerator=function(seeds){if(typeof seeds==="undefined"){seeds=[]}this.c=1;this.s0=0;this.s1=0;this.s2=0;this.sow(seeds)};Phaser.RandomDataGenerator.prototype={rnd:function(){var t=2091639*this.s0+this.c*2.3283064365386963e-10;this.c=t|0;this.s0=this.s1;this.s1=this.s2;this.s2=t-this.c;return this.s2},sow:function(seeds){this.s0=this.hash(" ");this.s1=this.hash(this.s0);this.s2=this.hash(this.s1);this.c=1;if(!seeds){return}for(var i=0;i<seeds.length&&seeds[i]!=null;i++){var seed=seeds[i];this.s0-=this.hash(seed);this.s0+=~~(this.s0<0);this.s1-=this.hash(seed);this.s1+=~~(this.s1<0);this.s2-=this.hash(seed);this.s2+=~~(this.s2<0)}},hash:function(data){var h,i,n;n=4022871197;data=data.toString();for(i=0;i<data.length;i++){n+=data.charCodeAt(i);h=.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296}return(n>>>0)*2.3283064365386963e-10},integer:function(){return this.rnd.apply(this)*4294967296},frac:function(){return this.rnd.apply(this)+(this.rnd.apply(this)*2097152|0)*1.1102230246251565e-16},real:function(){return this.integer()+this.frac()},integerInRange:function(min,max){return Math.floor(this.realInRange(0,max-min+1)+min)},between:function(min,max){return this.integerInRange(min,max)},realInRange:function(min,max){return this.frac()*(max-min)+min},normal:function(){return 1-2*this.frac()},uuid:function(){var a="";var b="";for(b=a="";a++<36;b+=~a%5|a*3&4?(a^15?8^this.frac()*(a^20?16:4):4).toString(16):"-"){}return b},pick:function(ary){return ary[this.integerInRange(0,ary.length-1)]},weightedPick:function(ary){return ary[~~(Math.pow(this.frac(),2)*(ary.length-1))]},timestamp:function(min,max){return this.realInRange(min||9466848e5,max||1577862e6)},angle:function(){return this.integerInRange(-180,180)}};Phaser.RandomDataGenerator.prototype.constructor=Phaser.RandomDataGenerator;Phaser.QuadTree=function(x,y,width,height,maxObjects,maxLevels,level){this.maxObjects=10;this.maxLevels=4;this.level=0;this.bounds={};this.objects=[];this.nodes=[];this._empty=[];this.reset(x,y,width,height,maxObjects,maxLevels,level)};Phaser.QuadTree.prototype={reset:function(x,y,width,height,maxObjects,maxLevels,level){this.maxObjects=maxObjects||10;this.maxLevels=maxLevels||4;this.level=level||0;this.bounds={x:Math.round(x),y:Math.round(y),width:width,height:height,subWidth:Math.floor(width/2),subHeight:Math.floor(height/2),right:Math.round(x)+Math.floor(width/2),bottom:Math.round(y)+Math.floor(height/2)};this.objects.length=0;this.nodes.length=0},populate:function(group){group.forEach(this.populateHandler,this,true)},populateHandler:function(sprite){if(sprite.body&&sprite.exists){this.insert(sprite.body)}},split:function(){this.nodes[0]=new Phaser.QuadTree(this.bounds.right,this.bounds.y,this.bounds.subWidth,this.bounds.subHeight,this.maxObjects,this.maxLevels,this.level+1);this.nodes[1]=new Phaser.QuadTree(this.bounds.x,this.bounds.y,this.bounds.subWidth,this.bounds.subHeight,this.maxObjects,this.maxLevels,this.level+1);this.nodes[2]=new Phaser.QuadTree(this.bounds.x,this.bounds.bottom,this.bounds.subWidth,this.bounds.subHeight,this.maxObjects,this.maxLevels,this.level+1);this.nodes[3]=new Phaser.QuadTree(this.bounds.right,this.bounds.bottom,this.bounds.subWidth,this.bounds.subHeight,this.maxObjects,this.maxLevels,this.level+1)},insert:function(body){var i=0;var index;if(this.nodes[0]!=null){index=this.getIndex(body);if(index!==-1){this.nodes[index].insert(body);return}}this.objects.push(body);if(this.objects.length>this.maxObjects&&this.level<this.maxLevels){if(this.nodes[0]==null){this.split()}while(i<this.objects.length){index=this.getIndex(this.objects[i]);if(index!==-1){this.nodes[index].insert(this.objects.splice(i,1)[0])}else{i++}}}},getIndex:function(rect){var index=-1;if(rect.x<this.bounds.right&&rect.right<this.bounds.right){if(rect.y<this.bounds.bottom&&rect.bottom<this.bounds.bottom){index=1}else if(rect.y>this.bounds.bottom){index=2}}else if(rect.x>this.bounds.right){if(rect.y<this.bounds.bottom&&rect.bottom<this.bounds.bottom){index=0}else if(rect.y>this.bounds.bottom){index=3}}return index},retrieve:function(source){if(source instanceof Phaser.Rectangle){var returnObjects=this.objects;var index=this.getIndex(source)}else{if(!source.body){return this._empty}var returnObjects=this.objects;var index=this.getIndex(source.body)}if(this.nodes[0]){if(index!==-1){returnObjects=returnObjects.concat(this.nodes[index].retrieve(source))}else{returnObjects=returnObjects.concat(this.nodes[0].retrieve(source));returnObjects=returnObjects.concat(this.nodes[1].retrieve(source));returnObjects=returnObjects.concat(this.nodes[2].retrieve(source));returnObjects=returnObjects.concat(this.nodes[3].retrieve(source))}}return returnObjects},clear:function(){this.objects.length=0;var i=this.nodes.length;while(i--){this.nodes[i].clear();this.nodes.splice(i,1)}this.nodes.length=0}};Phaser.QuadTree.prototype.constructor=Phaser.QuadTree;Phaser.Net=function(game){this.game=game};Phaser.Net.prototype={getHostName:function(){if(window.location&&window.location.hostname){return window.location.hostname}return null},checkDomainName:function(domain){return window.location.hostname.indexOf(domain)!==-1},updateQueryString:function(key,value,redirect,url){if(typeof redirect==="undefined"){redirect=false}if(typeof url==="undefined"||url===""){url=window.location.href}var output="";var re=new RegExp("([?|&])"+key+"=.*?(&|#|$)(.*)","gi");if(re.test(url)){if(typeof value!=="undefined"&&value!==null){output=url.replace(re,"$1"+key+"="+value+"$2$3")}else{output=url.replace(re,"$1$3").replace(/(&|\?)$/,"")}}else{if(typeof value!=="undefined"&&value!==null){var separator=url.indexOf("?")!==-1?"&":"?";var hash=url.split("#");url=hash[0]+separator+key+"="+value;if(hash[1]){url+="#"+hash[1]}output=url}else{output=url}}if(redirect){window.location.href=output}else{return output}},getQueryString:function(parameter){if(typeof parameter==="undefined"){parameter=""}var output={};var keyValues=location.search.substring(1).split("&");for(var i in keyValues){var key=keyValues[i].split("=");if(key.length>1){if(parameter&&parameter==this.decodeURI(key[0])){return this.decodeURI(key[1])}else{output[this.decodeURI(key[0])]=this.decodeURI(key[1])}}}return output},decodeURI:function(value){return decodeURIComponent(value.replace(/\+/g," "))}};Phaser.Net.prototype.constructor=Phaser.Net;Phaser.TweenManager=function(game){this.game=game;this._tweens=[];this._add=[];this.easeMap={Power0:Phaser.Easing.Power0,Power1:Phaser.Easing.Power1,Power2:Phaser.Easing.Power2,Power3:Phaser.Easing.Power3,Power4:Phaser.Easing.Power4,Linear:Phaser.Easing.Linear.None,Quad:Phaser.Easing.Quadratic.Out,Cubic:Phaser.Easing.Cubic.Out,Quart:Phaser.Easing.Quartic.Out,Quint:Phaser.Easing.Quintic.Out,Sine:Phaser.Easing.Sinusoidal.Out,Expo:Phaser.Easing.Exponential.Out,Circ:Phaser.Easing.Circular.Out,Elastic:Phaser.Easing.Elastic.Out,Back:Phaser.Easing.Back.Out,Bounce:Phaser.Easing.Bounce.Out,"Quad.easeIn":Phaser.Easing.Quadratic.In,"Cubic.easeIn":Phaser.Easing.Cubic.In,"Quart.easeIn":Phaser.Easing.Quartic.In,"Quint.easeIn":Phaser.Easing.Quintic.In,"Sine.easeIn":Phaser.Easing.Sinusoidal.In,"Expo.easeIn":Phaser.Easing.Exponential.In,"Circ.easeIn":Phaser.Easing.Circular.In,"Elastic.easeIn":Phaser.Easing.Elastic.In,"Back.easeIn":Phaser.Easing.Back.In,"Bounce.easeIn":Phaser.Easing.Bounce.In,"Quad.easeOut":Phaser.Easing.Quadratic.Out,"Cubic.easeOut":Phaser.Easing.Cubic.Out,"Quart.easeOut":Phaser.Easing.Quartic.Out,"Quint.easeOut":Phaser.Easing.Quintic.Out,"Sine.easeOut":Phaser.Easing.Sinusoidal.Out,"Expo.easeOut":Phaser.Easing.Exponential.Out,"Circ.easeOut":Phaser.Easing.Circular.Out,"Elastic.easeOut":Phaser.Easing.Elastic.Out,"Back.easeOut":Phaser.Easing.Back.Out,"Bounce.easeOut":Phaser.Easing.Bounce.Out,"Quad.easeInOut":Phaser.Easing.Quadratic.InOut,"Cubic.easeInOut":Phaser.Easing.Cubic.InOut,"Quart.easeInOut":Phaser.Easing.Quartic.InOut,"Quint.easeInOut":Phaser.Easing.Quintic.InOut,"Sine.easeInOut":Phaser.Easing.Sinusoidal.InOut,"Expo.easeInOut":Phaser.Easing.Exponential.InOut,"Circ.easeInOut":Phaser.Easing.Circular.InOut,"Elastic.easeInOut":Phaser.Easing.Elastic.InOut,"Back.easeInOut":Phaser.Easing.Back.InOut,"Bounce.easeInOut":Phaser.Easing.Bounce.InOut};this.game.onPause.add(this._pauseAll,this);this.game.onResume.add(this._resumeAll,this)};Phaser.TweenManager.prototype={getAll:function(){return this._tweens},removeAll:function(){for(var i=0;i<this._tweens.length;i++){this._tweens[i].pendingDelete=true}this._add=[]},removeFrom:function(obj,children){if(typeof children==="undefined"){children=true}var i;var len;if(Array.isArray(obj)){for(i=0,len=obj.length;i<len;i++){this.removeFrom(obj[i])}}else if(obj.type===Phaser.GROUP&&children){for(var i=0,len=obj.children.length;i<len;i++){this.removeFrom(obj.children[i])}}else{for(i=0,len=this._tweens.length;i<len;i++){if(obj===this._tweens[i].target){this.remove(this._tweens[i])}}for(i=0,len=this._add.length;i<len;i++){if(obj===this._add[i].target){this.remove(this._add[i])}}}},add:function(tween){tween._manager=this;this._add.push(tween)},create:function(object){return new Phaser.Tween(object,this.game,this)},remove:function(tween){var i=this._tweens.indexOf(tween);if(i!==-1){this._tweens[i].pendingDelete=true}else{i=this._add.indexOf(tween);if(i!==-1){this._add[i].pendingDelete=true}}},update:function(){var addTweens=this._add.length;var numTweens=this._tweens.length;if(numTweens===0&&addTweens===0){return false}var i=0;while(i<numTweens){if(this._tweens[i].update(this.game.time.time)){i++}else{this._tweens.splice(i,1);numTweens--}}if(addTweens>0){this._tweens=this._tweens.concat(this._add);this._add.length=0}return true},isTweening:function(object){return this._tweens.some(function(tween){return tween.target===object})},_pauseAll:function(){for(var i=this._tweens.length-1;i>=0;i--){this._tweens[i]._pause()}},_resumeAll:function(){for(var i=this._tweens.length-1;i>=0;i--){this._tweens[i]._resume()}},pauseAll:function(){for(var i=this._tweens.length-1;i>=0;i--){this._tweens[i].pause()}},resumeAll:function(){for(var i=this._tweens.length-1;i>=0;i--){this._tweens[i].resume(true)}}};Phaser.TweenManager.prototype.constructor=Phaser.TweenManager;Phaser.Tween=function(target,game,manager){this.game=game;this.target=target;this.manager=manager;this.timeline=[];this.reverse=false;this.timeScale=1;this.repeatCounter=0;this.pendingDelete=false;this.onStart=new Phaser.Signal;this.onLoop=new Phaser.Signal;this.onRepeat=new Phaser.Signal;this.onChildComplete=new Phaser.Signal;this.onComplete=new Phaser.Signal;this.isRunning=false;this.current=0;this.properties={};this.chainedTween=null;this.isPaused=false;this._onUpdateCallback=null;this._onUpdateCallbackContext=null;this._pausedTime=0;this._codePaused=false};Phaser.Tween.prototype={to:function(properties,duration,ease,autoStart,delay,repeat,yoyo){if(typeof duration==="undefined"){duration=1e3}if(typeof ease==="undefined"){ease=Phaser.Easing.Default}if(typeof autoStart==="undefined"){autoStart=false}if(typeof delay==="undefined"){delay=0}if(typeof repeat==="undefined"){repeat=0}if(typeof yoyo==="undefined"){yoyo=false}if(typeof ease==="string"&&this.manager.easeMap[ease]){ease=this.manager.easeMap[ease]}if(this.isRunning){console.warn("Phaser.Tween.to cannot be called after Tween.start");return this}this.timeline.push(new Phaser.TweenData(this).to(properties,duration,ease,delay,repeat,yoyo));if(autoStart){this.start()}return this},from:function(properties,duration,ease,autoStart,delay,repeat,yoyo){if(typeof duration==="undefined"){duration=1e3}if(typeof ease==="undefined"){ease=Phaser.Easing.Default}if(typeof autoStart==="undefined"){autoStart=false}if(typeof delay==="undefined"){delay=0}if(typeof repeat==="undefined"){repeat=0}if(typeof yoyo==="undefined"){yoyo=false}if(typeof ease==="string"&&this.manager.easeMap[ease]){ease=this.manager.easeMap[ease]}if(this.isRunning){console.warn("Phaser.Tween.from cannot be called after Tween.start");return this}this.timeline.push(new Phaser.TweenData(this).from(properties,duration,ease,delay,repeat,yoyo));if(autoStart){this.start()}return this},start:function(index){if(typeof index==="undefined"){index=0}if(this.game===null||this.target===null||this.timeline.length===0||this.isRunning){return this}for(var i=0;i<this.timeline.length;i++){for(var property in this.timeline[i].vEnd){this.properties[property]=this.target[property]||0;if(!Array.isArray(this.properties[property])){this.properties[property]*=1}}}for(var i=0;i<this.timeline.length;i++){this.timeline[i].loadValues()}this.manager.add(this);this.isRunning=true;if(index<0||index>this.timeline.length-1){index=0}this.current=index;this.timeline[this.current].start();this.onStart.dispatch(this.target,this);return this},stop:function(complete){if(typeof complete==="undefined"){complete=false}this.isRunning=false;this._onUpdateCallback=null;this._onUpdateCallbackContext=null;if(complete){this.onComplete.dispatch(this.target,this);if(this.chainedTween){this.chainedTween.start()}}this.manager.remove(this);return this},updateTweenData:function(property,value,index){if(this.timeline.length===0){return this}if(typeof index==="undefined"){index=0}if(index===-1){for(var i=0;i<this.timeline.length;i++){this.timeline[i][property]=value}}else{this.timeline[index][property]=value}return this},delay:function(duration,index){return this.updateTweenData("delay",duration,index)},repeat:function(total,repeatDelay,index){if(typeof repeatDelay==="undefined"){repeatDelay=0}this.updateTweenData("repeatCounter",total,index);return this.updateTweenData("repeatDelay",repeatDelay,index)},repeatDelay:function(duration,index){return this.updateTweenData("repeatDelay",duration,index)},yoyo:function(enable,yoyoDelay,index){if(typeof yoyoDelay==="undefined"){yoyoDelay=0}this.updateTweenData("yoyo",enable,index);return this.updateTweenData("yoyoDelay",yoyoDelay,index)},yoyoDelay:function(duration,index){return this.updateTweenData("yoyoDelay",duration,index)},easing:function(ease,index){if(typeof ease==="string"&&this.manager.easeMap[ease]){ease=this.manager.easeMap[ease]}return this.updateTweenData("easingFunction",ease,index)},interpolation:function(interpolation,context,index){if(typeof context==="undefined"){context=Phaser.Math}this.updateTweenData("interpolationFunction",interpolation,index);return this.updateTweenData("interpolationContext",context,index)},repeatAll:function(total){if(typeof total==="undefined"){total=0}this.repeatCounter=total;return this},chain:function(){var i=arguments.length;while(i--){if(i>0){arguments[i-1].chainedTween=arguments[i]}else{this.chainedTween=arguments[i]}}return this},loop:function(value){if(typeof value==="undefined"){value=true}if(value){this.repeatAll(-1)}else{this.repeatCounter=0}return this},onUpdateCallback:function(callback,callbackContext){this._onUpdateCallback=callback;this._onUpdateCallbackContext=callbackContext;return this},pause:function(){this.isPaused=true;this._codePaused=true;this._pausedTime=this.game.time.time},_pause:function(){if(!this._codePaused){this.isPaused=true;this._pausedTime=this.game.time.time}},resume:function(){if(this.isPaused){this.isPaused=false;this._codePaused=false;for(var i=0;i<this.timeline.length;i++){if(!this.timeline[i].isRunning){this.timeline[i].startTime+=this.game.time.time-this._pausedTime}}}},_resume:function(){if(this._codePaused){return}else{this.resume()}},update:function(time){if(this.pendingDelete){return false}if(this.isPaused){return true}var status=this.timeline[this.current].update(time);if(status===Phaser.TweenData.PENDING){return true}else if(status===Phaser.TweenData.RUNNING){if(this._onUpdateCallback!==null){this._onUpdateCallback.call(this._onUpdateCallbackContext,this,this.timeline[this.current].value,this.timeline[this.current])}return this.isRunning}else if(status===Phaser.TweenData.LOOPED){this.onLoop.dispatch(this.target,this);return true}else if(status===Phaser.TweenData.COMPLETE){var complete=false;if(this.reverse){this.current--;if(this.current<0){this.current=this.timeline.length-1;complete=true}}else{this.current++;if(this.current===this.timeline.length){this.current=0;complete=true}}if(complete){if(this.repeatCounter===-1){this.timeline[this.current].start();this.onRepeat.dispatch(this.target,this);return true}else if(this.repeatCounter>0){this.repeatCounter--;this.timeline[this.current].start();this.onRepeat.dispatch(this.target,this);return true}else{this.isRunning=false;this.onComplete.dispatch(this.target,this);if(this.chainedTween){this.chainedTween.start()}return false}}else{this.onChildComplete.dispatch(this.target,this);this.timeline[this.current].start();return true}}},generateData:function(frameRate,data){if(this.game===null||this.target===null){return null}if(typeof data==="undefined"){data=[]}for(var i=0;i<this.timeline.length;i++){for(var property in this.timeline[i].vEnd){this.properties[property]=this.target[property]||0;if(!Array.isArray(this.properties[property])){this.properties[property]*=1}}}for(var i=0;i<this.timeline.length;i++){this.timeline[i].loadValues()}for(var i=0;i<this.timeline.length;i++){data=data.concat(this.timeline[i].generateData(frameRate))}return data}};Object.defineProperty(Phaser.Tween.prototype,"totalDuration",{get:function(){var total=0;for(var i=0;i<this.timeline.length;i++){total+=this.timeline[i].duration}return total}});Phaser.Tween.prototype.constructor=Phaser.Tween;Phaser.TweenData=function(parent){this.parent=parent;this.game=parent.game;this.vStart={};this.vStartCache={};this.vEnd={};this.vEndCache={};this.duration=1e3;this.percent=0;this.value=0;this.repeatCounter=0;this.repeatDelay=0;this.interpolate=false;this.yoyo=false;this.yoyoDelay=0;this.inReverse=false;this.delay=0;this.dt=0;this.startTime=null;this.easingFunction=Phaser.Easing.Default;this.interpolationFunction=Phaser.Math.linearInterpolation;this.interpolationContext=Phaser.Math;this.isRunning=false;this.isFrom=false};Phaser.TweenData.PENDING=0;Phaser.TweenData.RUNNING=1;Phaser.TweenData.LOOPED=2;Phaser.TweenData.COMPLETE=3;Phaser.TweenData.prototype={to:function(properties,duration,ease,delay,repeat,yoyo){this.vEnd=properties;this.duration=duration;this.easingFunction=ease;this.delay=delay;this.repeatCounter=repeat;this.yoyo=yoyo;this.isFrom=false;return this},from:function(properties,duration,ease,delay,repeat,yoyo){this.vEnd=properties;this.duration=duration;this.easingFunction=ease;this.delay=delay;this.repeatCounter=repeat;this.yoyo=yoyo;this.isFrom=true;return this},start:function(){this.startTime=this.game.time.time+this.delay;if(this.parent.reverse){this.dt=this.duration}else{this.dt=0}if(this.delay>0){this.isRunning=false}else{this.isRunning=true}if(this.isFrom){for(var property in this.vStartCache){this.vStart[property]=this.vEndCache[property];this.vEnd[property]=this.vStartCache[property];this.parent.target[property]=this.vStart[property]}}this.value=0;this.yoyoCounter=0;return this},loadValues:function(){for(var property in this.parent.properties){this.vStart[property]=this.parent.properties[property];if(Array.isArray(this.vEnd[property])){if(this.vEnd[property].length===0){continue}this.vEnd[property]=[this.vStart[property]].concat(this.vEnd[property])}if(typeof this.vEnd[property]!=="undefined"){if(typeof this.vEnd[property]==="string"){this.vEnd[property]=this.vStart[property]+parseFloat(this.vEnd[property],10)}this.parent.properties[property]=this.vEnd[property]}else{this.vEnd[property]=this.vStart[property]}this.vStartCache[property]=this.vStart[property];this.vEndCache[property]=this.vEnd[property]}return this},update:function(){if(!this.isRunning){if(this.game.time.time>=this.startTime){this.isRunning=true}else{return Phaser.TweenData.PENDING}}else{if(this.game.time.time<this.startTime){return Phaser.TweenData.RUNNING}}if(this.parent.reverse){this.dt-=this.game.time.physicsElapsedMS*this.parent.timeScale;this.dt=Math.max(this.dt,0)}else{this.dt+=this.game.time.physicsElapsedMS*this.parent.timeScale;this.dt=Math.min(this.dt,this.duration)}this.percent=this.dt/this.duration;this.value=this.easingFunction(this.percent);for(var property in this.vEnd){var start=this.vStart[property];var end=this.vEnd[property];if(Array.isArray(end)){this.parent.target[property]=this.interpolationFunction.call(this.interpolationContext,end,this.value)}else{this.parent.target[property]=start+(end-start)*this.value}}if(!this.parent.reverse&&this.percent===1||this.parent.reverse&&this.percent===0){return this.repeat()}return Phaser.TweenData.RUNNING},generateData:function(frameRate){if(this.parent.reverse){this.dt=this.duration}else{this.dt=0}var data=[];var complete=false;var fps=1/frameRate*1e3;do{if(this.parent.reverse){this.dt-=fps;this.dt=Math.max(this.dt,0)}else{this.dt+=fps;this.dt=Math.min(this.dt,this.duration)}this.percent=this.dt/this.duration;this.value=this.easingFunction(this.percent);var blob={};for(var property in this.vEnd){var start=this.vStart[property];var end=this.vEnd[property];if(Array.isArray(end)){blob[property]=this.interpolationFunction(end,this.value)}else{blob[property]=start+(end-start)*this.value}}data.push(blob);if(!this.parent.reverse&&this.percent===1||this.parent.reverse&&this.percent===0){complete=true}}while(!complete);if(this.yoyo){var reversed=data.slice();reversed.reverse();data=data.concat(reversed)}return data},repeat:function(){if(this.yoyo){if(this.inReverse&&this.repeatCounter===0){return Phaser.TweenData.COMPLETE}this.inReverse=!this.inReverse}else{if(this.repeatCounter===0){return Phaser.TweenData.COMPLETE}}if(this.inReverse){for(var property in this.vStartCache){this.vStart[property]=this.vEndCache[property];this.vEnd[property]=this.vStartCache[property]}}else{for(var property in this.vStartCache){this.vStart[property]=this.vStartCache[property];this.vEnd[property]=this.vEndCache[property]}if(this.repeatCounter>0){this.repeatCounter--}}this.startTime=this.game.time.time;if(this.yoyo&&this.inReverse){this.startTime+=this.yoyoDelay}else if(!this.inReverse){this.startTime+=this.repeatDelay}if(this.parent.reverse){this.dt=this.duration}else{this.dt=0}return Phaser.TweenData.LOOPED}};Phaser.TweenData.prototype.constructor=Phaser.TweenData;Phaser.Easing={Linear:{None:function(k){return k}},Quadratic:{In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){if((k*=2)<1)return.5*k*k;return-.5*(--k*(k-2)-1)}},Cubic:{In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){if((k*=2)<1)return.5*k*k*k;return.5*((k-=2)*k*k+2)}},Quartic:{In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){if((k*=2)<1)return.5*k*k*k*k;return-.5*((k-=2)*k*k*k-2)}},Quintic:{In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){if((k*=2)<1)return.5*k*k*k*k*k;return.5*((k-=2)*k*k*k*k+2)}},Sinusoidal:{In:function(k){if(k===0)return 0;if(k===1)return 1;return 1-Math.cos(k*Math.PI/2)},Out:function(k){if(k===0)return 0;if(k===1)return 1;return Math.sin(k*Math.PI/2)},InOut:function(k){if(k===0)return 0;if(k===1)return 1;return.5*(1-Math.cos(Math.PI*k))}},Exponential:{In:function(k){return k===0?0:Math.pow(1024,k-1)},Out:function(k){return k===1?1:1-Math.pow(2,-10*k)},InOut:function(k){if(k===0)return 0;if(k===1)return 1;if((k*=2)<1)return.5*Math.pow(1024,k-1);return.5*(-Math.pow(2,-10*(k-1))+2)}},Circular:{In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){if((k*=2)<1)return-.5*(Math.sqrt(1-k*k)-1);return.5*(Math.sqrt(1-(k-=2)*k)+1)}},Elastic:{In:function(k){var s,a=.1,p=.4;if(k===0)return 0;if(k===1)return 1;if(!a||a<1){a=1;s=p/4}else s=p*Math.asin(1/a)/(2*Math.PI);return-(a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p))},Out:function(k){var s,a=.1,p=.4;if(k===0)return 0;if(k===1)return 1;if(!a||a<1){a=1;s=p/4}else s=p*Math.asin(1/a)/(2*Math.PI);return a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/p)+1},InOut:function(k){var s,a=.1,p=.4;if(k===0)return 0;if(k===1)return 1;if(!a||a<1){a=1;s=p/4}else s=p*Math.asin(1/a)/(2*Math.PI);if((k*=2)<1)return-.5*(a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p));return a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*.5+1}},Back:{In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=1.70158*1.525;if((k*=2)<1)return.5*(k*k*((s+1)*k-s));return.5*((k-=2)*k*((s+1)*k+s)+2)}},Bounce:{In:function(k){return 1-Phaser.Easing.Bounce.Out(1-k)},Out:function(k){if(k<1/2.75){return 7.5625*k*k}else if(k<2/2.75){return 7.5625*(k-=1.5/2.75)*k+.75}else if(k<2.5/2.75){return 7.5625*(k-=2.25/2.75)*k+.9375}else{return 7.5625*(k-=2.625/2.75)*k+.984375}},InOut:function(k){if(k<.5)return Phaser.Easing.Bounce.In(k*2)*.5;return Phaser.Easing.Bounce.Out(k*2-1)*.5+.5}}};Phaser.Easing.Default=Phaser.Easing.Linear.None;Phaser.Easing.Power0=Phaser.Easing.Linear.None;Phaser.Easing.Power1=Phaser.Easing.Quadratic.Out;Phaser.Easing.Power2=Phaser.Easing.Cubic.Out;Phaser.Easing.Power3=Phaser.Easing.Quartic.Out;Phaser.Easing.Power4=Phaser.Easing.Quintic.Out;Phaser.Time=function(game){this.game=game;this.time=0;this.prevTime=0;this.now=0;this.elapsed=0;this.elapsedMS=0;this.physicsElapsed=0;this.physicsElapsedMS=0;this.desiredFps=60;this.suggestedFps=null;this.slowMotion=1;this.advancedTiming=false;this.frames=0;this.fps=0;this.fpsMin=1e3;this.fpsMax=0;this.msMin=1e3;this.msMax=0;this.pauseDuration=0;this.timeToCall=0;this.timeExpected=0;this.events=new Phaser.Timer(this.game,false);this._frameCount=0;this._elapsedAccumulator=0;this._started=0;this._timeLastSecond=0;this._pauseStarted=0;this._justResumed=false;this._timers=[]};Phaser.Time.prototype={boot:function(){this._started=Date.now();this.time=Date.now();this.events.start()},add:function(timer){this._timers.push(timer);return timer},create:function(autoDestroy){if(typeof autoDestroy==="undefined"){autoDestroy=true}var timer=new Phaser.Timer(this.game,autoDestroy);this._timers.push(timer);return timer},removeAll:function(){for(var i=0;i<this._timers.length;i++){this._timers[i].destroy()}this._timers=[];this.events.removeAll()},update:function(time){var previousDateNow=this.time;this.time=Date.now();this.elapsedMS=this.time-previousDateNow;this.prevTime=this.now;this.now=time;this.elapsed=this.now-this.prevTime;this.timeToCall=Math.floor(Math.max(0,1e3/this.desiredFps-(this.timeCallExpected-time)));this.timeCallExpected=time+this.timeToCall;this._frameCount++;this._elapsedAccumulator+=this.elapsed;if(this._frameCount>=this.desiredFps*2){this.suggestedFps=Math.floor(200/(this._elapsedAccumulator/this._frameCount))*5;this._frameCount=0;this._elapsedAccumulator=0}this.physicsElapsed=1/this.desiredFps;this.physicsElapsedMS=this.physicsElapsed*1e3;if(this.advancedTiming){this.msMin=Math.min(this.msMin,this.elapsed);this.msMax=Math.max(this.msMax,this.elapsed);this.frames++;if(this.now>this._timeLastSecond+1e3){this.fps=Math.round(this.frames*1e3/(this.now-this._timeLastSecond));this.fpsMin=Math.min(this.fpsMin,this.fps);this.fpsMax=Math.max(this.fpsMax,this.fps);this._timeLastSecond=this.now;this.frames=0}}if(!this.game.paused){this.events.update(this.time);var i=0;var len=this._timers.length;while(i<len){if(this._timers[i].update(this.time)){i++}else{this._timers.splice(i,1);len--}}}},gamePaused:function(){this._pauseStarted=Date.now();this.events.pause();var i=this._timers.length;while(i--){this._timers[i]._pause()}},gameResumed:function(){this.time=Date.now();this.pauseDuration=this.time-this._pauseStarted;this.events.resume();var i=this._timers.length;while(i--){this._timers[i]._resume()}},totalElapsedSeconds:function(){return(this.time-this._started)*.001},elapsedSince:function(since){return this.time-since},elapsedSecondsSince:function(since){return(this.time-since)*.001},reset:function(){this._started=this.time;this.removeAll()}};Phaser.Time.prototype.constructor=Phaser.Time;Phaser.Timer=function(game,autoDestroy){if(typeof autoDestroy==="undefined"){autoDestroy=true}this.game=game;this.running=false;this.autoDestroy=autoDestroy;this.expired=false;this.elapsed=0;this.events=[];this.onComplete=new Phaser.Signal;this.nextTick=0;this.timeCap=1e3;this.paused=false;this._codePaused=false;this._started=0;this._pauseStarted=0;this._pauseTotal=0;this._now=Date.now();this._len=0;this._marked=0;this._i=0;this._diff=0;this._newTick=0};Phaser.Timer.MINUTE=6e4;Phaser.Timer.SECOND=1e3;Phaser.Timer.HALF=500;Phaser.Timer.QUARTER=250;Phaser.Timer.prototype={create:function(delay,loop,repeatCount,callback,callbackContext,args){delay=Math.round(delay);var tick=delay;if(this._now===0){tick+=this.game.time.time
}else{tick+=this._now}var event=new Phaser.TimerEvent(this,delay,tick,repeatCount,loop,callback,callbackContext,args);this.events.push(event);this.order();this.expired=false;return event},add:function(delay,callback,callbackContext){return this.create(delay,false,0,callback,callbackContext,Array.prototype.splice.call(arguments,3))},repeat:function(delay,repeatCount,callback,callbackContext){return this.create(delay,false,repeatCount,callback,callbackContext,Array.prototype.splice.call(arguments,4))},loop:function(delay,callback,callbackContext){return this.create(delay,true,0,callback,callbackContext,Array.prototype.splice.call(arguments,3))},start:function(delay){if(this.running){return}this._started=this.game.time.time+(delay||0);this.running=true;for(var i=0;i<this.events.length;i++){this.events[i].tick=this.events[i].delay+this._started}},stop:function(clearEvents){this.running=false;if(typeof clearEvents==="undefined"){clearEvents=true}if(clearEvents){this.events.length=0}},remove:function(event){for(var i=0;i<this.events.length;i++){if(this.events[i]===event){this.events[i].pendingDelete=true;return true}}return false},order:function(){if(this.events.length>0){this.events.sort(this.sortHandler);this.nextTick=this.events[0].tick}},sortHandler:function(a,b){if(a.tick<b.tick){return-1}else if(a.tick>b.tick){return 1}return 0},clearPendingEvents:function(){this._i=this.events.length;while(this._i--){if(this.events[this._i].pendingDelete){this.events.splice(this._i,1)}}this._len=this.events.length;this._i=0},update:function(time){if(this.paused){return true}this.elapsed=time-this._now;this._now=time;if(this.elapsed>this.timeCap){this.adjustEvents(time-this.elapsed)}this._marked=0;this.clearPendingEvents();if(this.running&&this._now>=this.nextTick&&this._len>0){while(this._i<this._len&&this.running){if(this._now>=this.events[this._i].tick&&!this.events[this._i].pendingDelete){this._newTick=this._now+this.events[this._i].delay-(this._now-this.events[this._i].tick);if(this._newTick<0){this._newTick=this._now+this.events[this._i].delay}if(this.events[this._i].loop===true){this.events[this._i].tick=this._newTick;this.events[this._i].callback.apply(this.events[this._i].callbackContext,this.events[this._i].args)}else if(this.events[this._i].repeatCount>0){this.events[this._i].repeatCount--;this.events[this._i].tick=this._newTick;this.events[this._i].callback.apply(this.events[this._i].callbackContext,this.events[this._i].args)}else{this._marked++;this.events[this._i].pendingDelete=true;this.events[this._i].callback.apply(this.events[this._i].callbackContext,this.events[this._i].args)}this._i++}else{break}}if(this.events.length>this._marked){this.order()}else{this.expired=true;this.onComplete.dispatch(this)}}if(this.expired&&this.autoDestroy){return false}else{return true}},pause:function(){if(!this.running){return}this._codePaused=true;if(this.paused){return}this._pauseStarted=this.game.time.time;this.paused=true},_pause:function(){if(this.paused||!this.running){return}this._pauseStarted=this.game.time.time;this.paused=true},adjustEvents:function(baseTime){for(var i=0;i<this.events.length;i++){if(!this.events[i].pendingDelete){var t=this.events[i].tick-baseTime;if(t<0){t=0}this.events[i].tick=this._now+t}}var d=this.nextTick-baseTime;if(d<0){this.nextTick=this._now}else{this.nextTick=this._now+d}},resume:function(){if(!this.paused){return}var now=this.game.time.time;this._pauseTotal+=now-this._now;this._now=now;this.adjustEvents(this._pauseStarted);this.paused=false;this._codePaused=false},_resume:function(){if(this._codePaused){return}else{this.resume()}},removeAll:function(){this.onComplete.removeAll();this.events.length=0;this._len=0;this._i=0},destroy:function(){this.onComplete.removeAll();this.running=false;this.events=[];this._len=0;this._i=0}};Object.defineProperty(Phaser.Timer.prototype,"next",{get:function(){return this.nextTick}});Object.defineProperty(Phaser.Timer.prototype,"duration",{get:function(){if(this.running&&this.nextTick>this._now){return this.nextTick-this._now}else{return 0}}});Object.defineProperty(Phaser.Timer.prototype,"length",{get:function(){return this.events.length}});Object.defineProperty(Phaser.Timer.prototype,"ms",{get:function(){if(this.running){return this._now-this._started-this._pauseTotal}else{return 0}}});Object.defineProperty(Phaser.Timer.prototype,"seconds",{get:function(){if(this.running){return this.ms*.001}else{return 0}}});Phaser.Timer.prototype.constructor=Phaser.Timer;Phaser.TimerEvent=function(timer,delay,tick,repeatCount,loop,callback,callbackContext,args){this.timer=timer;this.delay=delay;this.tick=tick;this.repeatCount=repeatCount-1;this.loop=loop;this.callback=callback;this.callbackContext=callbackContext;this.args=args;this.pendingDelete=false};Phaser.TimerEvent.prototype.constructor=Phaser.TimerEvent;Phaser.AnimationManager=function(sprite){this.sprite=sprite;this.game=sprite.game;this.currentFrame=null;this.currentAnim=null;this.updateIfVisible=true;this.isLoaded=false;this._frameData=null;this._anims={};this._outputFrames=[]};Phaser.AnimationManager.prototype={loadFrameData:function(frameData,frame){if(typeof frameData==="undefined"){return false}if(this.isLoaded){for(var anim in this._anims){this._anims[anim].updateFrameData(frameData)}}this._frameData=frameData;if(typeof frame==="undefined"||frame===null){this.frame=0}else{if(typeof frame==="string"){this.frameName=frame}else{this.frame=frame}}this.isLoaded=true;return true},copyFrameData:function(frameData,frame){this._frameData=frameData.clone();if(this.isLoaded){for(var anim in this._anims){this._anims[anim].updateFrameData(this._frameData)}}if(typeof frame==="undefined"||frame===null){this.frame=0}else{if(typeof frame==="string"){this.frameName=frame}else{this.frame=frame}}this.isLoaded=true;return true},add:function(name,frames,frameRate,loop,useNumericIndex){frames=frames||[];frameRate=frameRate||60;if(typeof loop==="undefined"){loop=false}if(typeof useNumericIndex==="undefined"){if(frames&&typeof frames[0]==="number"){useNumericIndex=true}else{useNumericIndex=false}}this._outputFrames.length=0;this._frameData.getFrameIndexes(frames,useNumericIndex,this._outputFrames);this._anims[name]=new Phaser.Animation(this.game,this.sprite,name,this._frameData,this._outputFrames,frameRate,loop);this.currentAnim=this._anims[name];this.currentFrame=this.currentAnim.currentFrame;if(this.sprite.__tilePattern){this.sprite.__tilePattern=false;this.tilingTexture=false}return this._anims[name]},validateFrames:function(frames,useNumericIndex){if(typeof useNumericIndex==="undefined"){useNumericIndex=true}for(var i=0;i<frames.length;i++){if(useNumericIndex===true){if(frames[i]>this._frameData.total){return false}}else{if(this._frameData.checkFrameName(frames[i])===false){return false}}}return true},play:function(name,frameRate,loop,killOnComplete){if(this._anims[name]){if(this.currentAnim===this._anims[name]){if(this.currentAnim.isPlaying===false){this.currentAnim.paused=false;return this.currentAnim.play(frameRate,loop,killOnComplete)}return this.currentAnim}else{if(this.currentAnim&&this.currentAnim.isPlaying){this.currentAnim.stop()}this.currentAnim=this._anims[name];this.currentAnim.paused=false;this.currentFrame=this.currentAnim.currentFrame;return this.currentAnim.play(frameRate,loop,killOnComplete)}}},stop:function(name,resetFrame){if(typeof resetFrame==="undefined"){resetFrame=false}if(typeof name==="string"){if(this._anims[name]){this.currentAnim=this._anims[name];this.currentAnim.stop(resetFrame)}}else{if(this.currentAnim){this.currentAnim.stop(resetFrame)}}},update:function(){if(this.updateIfVisible&&!this.sprite.visible){return false}if(this.currentAnim&&this.currentAnim.update()){this.currentFrame=this.currentAnim.currentFrame;return true}return false},next:function(quantity){if(this.currentAnim){this.currentAnim.next(quantity);this.currentFrame=this.currentAnim.currentFrame}},previous:function(quantity){if(this.currentAnim){this.currentAnim.previous(quantity);this.currentFrame=this.currentAnim.currentFrame}},getAnimation:function(name){if(typeof name==="string"){if(this._anims[name]){return this._anims[name]}}return null},refreshFrame:function(){this.sprite.setTexture(PIXI.TextureCache[this.currentFrame.uuid]);if(this.sprite.__tilePattern){this.__tilePattern=false;this.tilingTexture=false}},destroy:function(){var anim=null;for(var anim in this._anims){if(this._anims.hasOwnProperty(anim)){this._anims[anim].destroy()}}this._anims={};this._outputFrames=[];this._frameData=null;this.currentAnim=null;this.currentFrame=null;this.sprite=null;this.game=null}};Phaser.AnimationManager.prototype.constructor=Phaser.AnimationManager;Object.defineProperty(Phaser.AnimationManager.prototype,"frameData",{get:function(){return this._frameData}});Object.defineProperty(Phaser.AnimationManager.prototype,"frameTotal",{get:function(){return this._frameData.total}});Object.defineProperty(Phaser.AnimationManager.prototype,"paused",{get:function(){return this.currentAnim.isPaused},set:function(value){this.currentAnim.paused=value}});Object.defineProperty(Phaser.AnimationManager.prototype,"name",{get:function(){if(this.currentAnim){return this.currentAnim.name}}});Object.defineProperty(Phaser.AnimationManager.prototype,"frame",{get:function(){if(this.currentFrame){return this.currentFrame.index}},set:function(value){if(typeof value==="number"&&this._frameData&&this._frameData.getFrame(value)!==null){this.currentFrame=this._frameData.getFrame(value);if(this.currentFrame){this.sprite.setFrame(this.currentFrame);if(this.sprite.__tilePattern){this.__tilePattern=false;this.tilingTexture=false}}}}});Object.defineProperty(Phaser.AnimationManager.prototype,"frameName",{get:function(){if(this.currentFrame){return this.currentFrame.name}},set:function(value){if(typeof value==="string"&&this._frameData.getFrameByName(value)!==null){this.currentFrame=this._frameData.getFrameByName(value);if(this.currentFrame){this._frameIndex=this.currentFrame.index;this.sprite.setFrame(this.currentFrame);if(this.sprite.__tilePattern){this.__tilePattern=false;this.tilingTexture=false}}}else{console.warn("Cannot set frameName: "+value)}}});Phaser.Animation=function(game,parent,name,frameData,frames,frameRate,loop){if(typeof loop==="undefined"){loop=false}this.game=game;this._parent=parent;this._frameData=frameData;this.name=name;this._frames=[];this._frames=this._frames.concat(frames);this.delay=1e3/frameRate;this.loop=loop;this.loopCount=0;this.killOnComplete=false;this.isFinished=false;this.isPlaying=false;this.isPaused=false;this._pauseStartTime=0;this._frameIndex=0;this._frameDiff=0;this._frameSkip=1;this.currentFrame=this._frameData.getFrame(this._frames[this._frameIndex]);this.onStart=new Phaser.Signal;this.onUpdate=null;this.onComplete=new Phaser.Signal;this.onLoop=new Phaser.Signal;this.game.onPause.add(this.onPause,this);this.game.onResume.add(this.onResume,this)};Phaser.Animation.prototype={play:function(frameRate,loop,killOnComplete){if(typeof frameRate==="number"){this.delay=1e3/frameRate}if(typeof loop==="boolean"){this.loop=loop}if(typeof killOnComplete!=="undefined"){this.killOnComplete=killOnComplete}this.isPlaying=true;this.isFinished=false;this.paused=false;this.loopCount=0;this._timeLastFrame=this.game.time.time;this._timeNextFrame=this.game.time.time+this.delay;this._frameIndex=0;this.updateCurrentFrame(false);this._parent.events.onAnimationStart$dispatch(this._parent,this);this.onStart.dispatch(this._parent,this);this._parent.animations.currentAnim=this;this._parent.animations.currentFrame=this.currentFrame;return this},restart:function(){this.isPlaying=true;this.isFinished=false;this.paused=false;this.loopCount=0;this._timeLastFrame=this.game.time.time;this._timeNextFrame=this.game.time.time+this.delay;this._frameIndex=0;this.currentFrame=this._frameData.getFrame(this._frames[this._frameIndex]);this._parent.setFrame(this.currentFrame);this._parent.animations.currentAnim=this;this._parent.animations.currentFrame=this.currentFrame;this.onStart.dispatch(this._parent,this)},setFrame:function(frameId,useLocalFrameIndex){var frameIndex;if(typeof useLocalFrameIndex==="undefined"){useLocalFrameIndex=false}if(typeof frameId==="string"){for(var i=0;i<this._frames.length;i++){if(this._frameData.getFrame(this._frames[i]).name===frameId){frameIndex=i}}}else if(typeof frameId==="number"){if(useLocalFrameIndex){frameIndex=frameId}else{for(var i=0;i<this._frames.length;i++){if(this._frames[i]===frameIndex){frameIndex=i}}}}if(frameIndex){this._frameIndex=frameIndex-1;this._timeNextFrame=this.game.time.time;this.update()}},stop:function(resetFrame,dispatchComplete){if(typeof resetFrame==="undefined"){resetFrame=false}if(typeof dispatchComplete==="undefined"){dispatchComplete=false}this.isPlaying=false;this.isFinished=true;this.paused=false;if(resetFrame){this.currentFrame=this._frameData.getFrame(this._frames[0]);this._parent.setFrame(this.currentFrame)}if(dispatchComplete){this._parent.events.onAnimationComplete$dispatch(this._parent,this);this.onComplete.dispatch(this._parent,this)}},onPause:function(){if(this.isPlaying){this._frameDiff=this._timeNextFrame-this.game.time.time}},onResume:function(){if(this.isPlaying){this._timeNextFrame=this.game.time.time+this._frameDiff}},update:function(){if(this.isPaused){return false}if(this.isPlaying&&this.game.time.time>=this._timeNextFrame){this._frameSkip=1;this._frameDiff=this.game.time.time-this._timeNextFrame;this._timeLastFrame=this.game.time.time;if(this._frameDiff>this.delay){this._frameSkip=Math.floor(this._frameDiff/this.delay);this._frameDiff-=this._frameSkip*this.delay}this._timeNextFrame=this.game.time.time+(this.delay-this._frameDiff);this._frameIndex+=this._frameSkip;if(this._frameIndex>=this._frames.length){if(this.loop){this._frameIndex%=this._frames.length;this.currentFrame=this._frameData.getFrame(this._frames[this._frameIndex]);this.loopCount++;this._parent.events.onAnimationLoop$dispatch(this._parent,this);this.onLoop.dispatch(this._parent,this);return this.updateCurrentFrame(true)}else{this.complete();return false}}else{return this.updateCurrentFrame(true)}}return false},updateCurrentFrame:function(signalUpdate){if(!this._frameData){return false}this.currentFrame=this._frameData.getFrame(this._frames[this._frameIndex]);if(this.currentFrame){this._parent.setFrame(this.currentFrame);if(this._parent.__tilePattern){this._parent.__tilePattern=false;this._parent.tilingTexture=false}}if(this.onUpdate&&signalUpdate){this.onUpdate.dispatch(this,this.currentFrame);return!!this._frameData}else{return true}},next:function(quantity){if(typeof quantity==="undefined"){quantity=1}var frame=this._frameIndex+quantity;if(frame>=this._frames.length){if(this.loop){frame%=this._frames.length}else{frame=this._frames.length-1}}if(frame!==this._frameIndex){this._frameIndex=frame;this.updateCurrentFrame(true)}},previous:function(quantity){if(typeof quantity==="undefined"){quantity=1}var frame=this._frameIndex-quantity;if(frame<0){if(this.loop){frame=this._frames.length+frame}else{frame++}}if(frame!==this._frameIndex){this._frameIndex=frame;this.updateCurrentFrame(true)}},updateFrameData:function(frameData){this._frameData=frameData;this.currentFrame=this._frameData?this._frameData.getFrame(this._frames[this._frameIndex%this._frames.length]):null},destroy:function(){if(!this._frameData){return}this.game.onPause.remove(this.onPause,this);this.game.onResume.remove(this.onResume,this);this.game=null;this._parent=null;this._frames=null;this._frameData=null;this.currentFrame=null;this.isPlaying=false;this.onStart.dispose();this.onLoop.dispose();this.onComplete.dispose();if(this.onUpdate){this.onUpdate.dispose()}},complete:function(){this._frameIndex=this._frames.length-1;this.currentFrame=this._frameData.getFrame(this._frames[this._frameIndex]);this.isPlaying=false;this.isFinished=true;this.paused=false;this._parent.events.onAnimationComplete$dispatch(this._parent,this);this.onComplete.dispatch(this._parent,this);if(this.killOnComplete){this._parent.kill()}}};Phaser.Animation.prototype.constructor=Phaser.Animation;Object.defineProperty(Phaser.Animation.prototype,"paused",{get:function(){return this.isPaused},set:function(value){this.isPaused=value;if(value){this._pauseStartTime=this.game.time.time}else{if(this.isPlaying){this._timeNextFrame=this.game.time.time+this.delay}}}});Object.defineProperty(Phaser.Animation.prototype,"frameTotal",{get:function(){return this._frames.length}});Object.defineProperty(Phaser.Animation.prototype,"frame",{get:function(){if(this.currentFrame!==null){return this.currentFrame.index}else{return this._frameIndex}},set:function(value){this.currentFrame=this._frameData.getFrame(this._frames[value]);if(this.currentFrame!==null){this._frameIndex=value;this._parent.setFrame(this.currentFrame);if(this.onUpdate){this.onUpdate.dispatch(this,this.currentFrame)}}}});Object.defineProperty(Phaser.Animation.prototype,"speed",{get:function(){return Math.round(1e3/this.delay)},set:function(value){if(value>=1){this.delay=1e3/value}}});Object.defineProperty(Phaser.Animation.prototype,"enableUpdate",{get:function(){return this.onUpdate!==null},set:function(value){if(value&&this.onUpdate===null){this.onUpdate=new Phaser.Signal}else if(!value&&this.onUpdate!==null){this.onUpdate.dispose();this.onUpdate=null}}});Phaser.Animation.generateFrameNames=function(prefix,start,stop,suffix,zeroPad){if(typeof suffix==="undefined"){suffix=""}var output=[];var frame="";if(start<stop){for(var i=start;i<=stop;i++){if(typeof zeroPad==="number"){frame=Phaser.Utils.pad(i.toString(),zeroPad,"0",1)}else{frame=i.toString()}frame=prefix+frame+suffix;output.push(frame)}}else{for(var i=start;i>=stop;i--){if(typeof zeroPad==="number"){frame=Phaser.Utils.pad(i.toString(),zeroPad,"0",1)}else{frame=i.toString()}frame=prefix+frame+suffix;output.push(frame)}}return output};Phaser.Frame=function(index,x,y,width,height,name,uuid){this.index=index;this.x=x;this.y=y;this.width=width;this.height=height;this.name=name;this.uuid=uuid;this.centerX=Math.floor(width/2);this.centerY=Math.floor(height/2);this.distance=Phaser.Math.distance(0,0,width,height);this.rotated=false;this.rotationDirection="cw";this.trimmed=false;this.sourceSizeW=width;this.sourceSizeH=height;this.spriteSourceSizeX=0;this.spriteSourceSizeY=0;this.spriteSourceSizeW=0;this.spriteSourceSizeH=0;this.right=this.x+this.width;this.bottom=this.y+this.height};Phaser.Frame.prototype={setTrim:function(trimmed,actualWidth,actualHeight,destX,destY,destWidth,destHeight){this.trimmed=trimmed;if(trimmed){this.sourceSizeW=actualWidth;this.sourceSizeH=actualHeight;this.centerX=Math.floor(actualWidth/2);this.centerY=Math.floor(actualHeight/2);this.spriteSourceSizeX=destX;this.spriteSourceSizeY=destY;this.spriteSourceSizeW=destWidth;this.spriteSourceSizeH=destHeight}},clone:function(){var output=new Phaser.Frame(this.index,this.x,this.y,this.width,this.height,this.name,this.uuid);for(var prop in this){if(this.hasOwnProperty(prop)){output[prop]=this[prop]}}return output},getRect:function(out){if(typeof out==="undefined"){out=new Phaser.Rectangle(this.x,this.y,this.width,this.height)}else{out.setTo(this.x,this.y,this.width,this.height)}return out}};Phaser.Frame.prototype.constructor=Phaser.Frame;Phaser.FrameData=function(){this._frames=[];this._frameNames=[]};Phaser.FrameData.prototype={addFrame:function(frame){frame.index=this._frames.length;this._frames.push(frame);if(frame.name!==""){this._frameNames[frame.name]=frame.index}return frame},getFrame:function(index){if(index>=this._frames.length){index=0}return this._frames[index]},getFrameByName:function(name){if(typeof this._frameNames[name]==="number"){return this._frames[this._frameNames[name]]}return null},checkFrameName:function(name){if(this._frameNames[name]==null){return false}return true},clone:function(){var output=new Phaser.FrameData;for(var i=0;i<this._frames.length;i++){output._frames.push(this._frames[i].clone())}for(var p in this._frameNames){if(this._frameNames.hasOwnProperty(p)){output._frameNames.push(this._frameNames[p])}}return output},getFrameRange:function(start,end,output){if(typeof output==="undefined"){output=[]}for(var i=start;i<=end;i++){output.push(this._frames[i])}return output},getFrames:function(frames,useNumericIndex,output){if(typeof useNumericIndex==="undefined"){useNumericIndex=true}if(typeof output==="undefined"){output=[]}if(typeof frames==="undefined"||frames.length===0){for(var i=0;i<this._frames.length;i++){output.push(this._frames[i])}}else{for(var i=0,len=frames.length;i<len;i++){if(useNumericIndex){output.push(this.getFrame(frames[i]))}else{output.push(this.getFrameByName(frames[i]))}}}return output},getFrameIndexes:function(frames,useNumericIndex,output){if(typeof useNumericIndex==="undefined"){useNumericIndex=true}if(typeof output==="undefined"){output=[]}if(typeof frames==="undefined"||frames.length===0){for(var i=0,len=this._frames.length;i<len;i++){output.push(this._frames[i].index)}}else{for(var i=0,len=frames.length;i<len;i++){if(useNumericIndex){output.push(frames[i])}else{if(this.getFrameByName(frames[i])){output.push(this.getFrameByName(frames[i]).index)}}}}return output}};Phaser.FrameData.prototype.constructor=Phaser.FrameData;Object.defineProperty(Phaser.FrameData.prototype,"total",{get:function(){return this._frames.length}});Phaser.AnimationParser={spriteSheet:function(game,key,frameWidth,frameHeight,frameMax,margin,spacing){var img=game.cache.getImage(key);if(img==null){return null}var width=img.width;var height=img.height;if(frameWidth<=0){frameWidth=Math.floor(-width/Math.min(-1,frameWidth))}if(frameHeight<=0){frameHeight=Math.floor(-height/Math.min(-1,frameHeight))}var row=Math.floor((width-margin)/(frameWidth+spacing));var column=Math.floor((height-margin)/(frameHeight+spacing));var total=row*column;if(frameMax!==-1){total=frameMax}if(width===0||height===0||width<frameWidth||height<frameHeight||total===0){console.warn("Phaser.AnimationParser.spriteSheet: '"+key+"'s width/height zero or width/height < given frameWidth/frameHeight");return null}var data=new Phaser.FrameData;var x=margin;var y=margin;for(var i=0;i<total;i++){var uuid=game.rnd.uuid();data.addFrame(new Phaser.Frame(i,x,y,frameWidth,frameHeight,"",uuid));PIXI.TextureCache[uuid]=new PIXI.Texture(PIXI.BaseTextureCache[key],{x:x,y:y,width:frameWidth,height:frameHeight});x+=frameWidth+spacing;if(x+frameWidth>width){x=margin;y+=frameHeight+spacing}}return data},JSONData:function(game,json,cacheKey){if(!json["frames"]){console.warn("Phaser.AnimationParser.JSONData: Invalid Texture Atlas JSON given, missing 'frames' array");console.log(json);return}var data=new Phaser.FrameData;var frames=json["frames"];var newFrame;for(var i=0;i<frames.length;i++){var uuid=game.rnd.uuid();newFrame=data.addFrame(new Phaser.Frame(i,frames[i].frame.x,frames[i].frame.y,frames[i].frame.w,frames[i].frame.h,frames[i].filename,uuid));PIXI.TextureCache[uuid]=new PIXI.Texture(PIXI.BaseTextureCache[cacheKey],{x:frames[i].frame.x,y:frames[i].frame.y,width:frames[i].frame.w,height:frames[i].frame.h});if(frames[i].trimmed){newFrame.setTrim(frames[i].trimmed,frames[i].sourceSize.w,frames[i].sourceSize.h,frames[i].spriteSourceSize.x,frames[i].spriteSourceSize.y,frames[i].spriteSourceSize.w,frames[i].spriteSourceSize.h)}}return data},JSONDataHash:function(game,json,cacheKey){if(!json["frames"]){console.warn("Phaser.AnimationParser.JSONDataHash: Invalid Texture Atlas JSON given, missing 'frames' object");console.log(json);return}var data=new Phaser.FrameData;var frames=json["frames"];var newFrame;var i=0;for(var key in frames){var uuid=game.rnd.uuid();newFrame=data.addFrame(new Phaser.Frame(i,frames[key].frame.x,frames[key].frame.y,frames[key].frame.w,frames[key].frame.h,key,uuid));PIXI.TextureCache[uuid]=new PIXI.Texture(PIXI.BaseTextureCache[cacheKey],{x:frames[key].frame.x,y:frames[key].frame.y,width:frames[key].frame.w,height:frames[key].frame.h});if(frames[key].trimmed){newFrame.setTrim(frames[key].trimmed,frames[key].sourceSize.w,frames[key].sourceSize.h,frames[key].spriteSourceSize.x,frames[key].spriteSourceSize.y,frames[key].spriteSourceSize.w,frames[key].spriteSourceSize.h)}i++}return data},XMLData:function(game,xml,cacheKey){if(!xml.getElementsByTagName("TextureAtlas")){console.warn("Phaser.AnimationParser.XMLData: Invalid Texture Atlas XML given, missing <TextureAtlas> tag");return}var data=new Phaser.FrameData;var frames=xml.getElementsByTagName("SubTexture");var newFrame;var uuid;var name;var frame;var x;var y;var width;var height;var frameX;var frameY;var frameWidth;var frameHeight;for(var i=0;i<frames.length;i++){uuid=game.rnd.uuid();frame=frames[i].attributes;name=frame.name.value;x=parseInt(frame.x.value,10);y=parseInt(frame.y.value,10);width=parseInt(frame.width.value,10);height=parseInt(frame.height.value,10);frameX=null;frameY=null;if(frame.frameX){frameX=Math.abs(parseInt(frame.frameX.value,10));frameY=Math.abs(parseInt(frame.frameY.value,10));frameWidth=parseInt(frame.frameWidth.value,10);frameHeight=parseInt(frame.frameHeight.value,10)}newFrame=data.addFrame(new Phaser.Frame(i,x,y,width,height,name,uuid));PIXI.TextureCache[uuid]=new PIXI.Texture(PIXI.BaseTextureCache[cacheKey],{x:x,y:y,width:width,height:height});if(frameX!==null||frameY!==null){newFrame.setTrim(true,width,height,frameX,frameY,frameWidth,frameHeight)}}return data}};Phaser.Cache=function(game){this.game=game;this.autoResolveURL=false;this._canvases={};this._images={};this._textures={};this._sounds={};this._text={};this._json={};this._xml={};this._physics={};this._tilemaps={};this._binary={};this._bitmapDatas={};this._bitmapFont={};this._urlMap={};this._urlResolver=new Image;this._urlTemp=null;this.addDefaultImage();this.addMissingImage();this.onSoundUnlock=new Phaser.Signal;this._cacheMap=[];this._cacheMap[Phaser.Cache.CANVAS]=this._canvases;this._cacheMap[Phaser.Cache.IMAGE]=this._images;this._cacheMap[Phaser.Cache.TEXTURE]=this._textures;this._cacheMap[Phaser.Cache.SOUND]=this._sounds;this._cacheMap[Phaser.Cache.TEXT]=this._text;this._cacheMap[Phaser.Cache.PHYSICS]=this._physics;this._cacheMap[Phaser.Cache.TILEMAP]=this._tilemaps;this._cacheMap[Phaser.Cache.BINARY]=this._binary;this._cacheMap[Phaser.Cache.BITMAPDATA]=this._bitmapDatas;this._cacheMap[Phaser.Cache.BITMAPFONT]=this._bitmapFont;this._cacheMap[Phaser.Cache.JSON]=this._json;this._cacheMap[Phaser.Cache.XML]=this._xml};Phaser.Cache.CANVAS=1;Phaser.Cache.IMAGE=2;Phaser.Cache.TEXTURE=3;Phaser.Cache.SOUND=4;Phaser.Cache.TEXT=5;Phaser.Cache.PHYSICS=6;Phaser.Cache.TILEMAP=7;Phaser.Cache.BINARY=8;Phaser.Cache.BITMAPDATA=9;Phaser.Cache.BITMAPFONT=10;Phaser.Cache.JSON=11;Phaser.Cache.XML=12;Phaser.Cache.prototype={addCanvas:function(key,canvas,context){this._canvases[key]={canvas:canvas,context:context}},addBinary:function(key,binaryData){this._binary[key]=binaryData},addBitmapData:function(key,bitmapData,frameData){bitmapData.key=key;if(typeof frameData==="undefined"){frameData=new Phaser.FrameData;frameData.addFrame(bitmapData.textureFrame)}this._bitmapDatas[key]={data:bitmapData,frameData:frameData};return bitmapData},addRenderTexture:function(key,texture){var frame=new Phaser.Frame(0,0,0,texture.width,texture.height,"","");this._textures[key]={texture:texture,frame:frame}},addSpriteSheet:function(key,url,data,frameWidth,frameHeight,frameMax,margin,spacing){this._images[key]={url:url,data:data,frameWidth:frameWidth,frameHeight:frameHeight,margin:margin,spacing:spacing};PIXI.BaseTextureCache[key]=new PIXI.BaseTexture(data);PIXI.TextureCache[key]=new PIXI.Texture(PIXI.BaseTextureCache[key]);this._images[key].frameData=Phaser.AnimationParser.spriteSheet(this.game,key,frameWidth,frameHeight,frameMax,margin,spacing);this._resolveURL(url,this._images[key])},addTilemap:function(key,url,mapData,format){this._tilemaps[key]={url:url,data:mapData,format:format};this._resolveURL(url,this._tilemaps[key])},addTextureAtlas:function(key,url,data,atlasData,format){this._images[key]={url:url,data:data};PIXI.BaseTextureCache[key]=new PIXI.BaseTexture(data);PIXI.TextureCache[key]=new PIXI.Texture(PIXI.BaseTextureCache[key]);if(format==Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY){this._images[key].frameData=Phaser.AnimationParser.JSONData(this.game,atlasData,key)}else if(format==Phaser.Loader.TEXTURE_ATLAS_JSON_HASH){this._images[key].frameData=Phaser.AnimationParser.JSONDataHash(this.game,atlasData,key)}else if(format==Phaser.Loader.TEXTURE_ATLAS_XML_STARLING){this._images[key].frameData=Phaser.AnimationParser.XMLData(this.game,atlasData,key)}this._resolveURL(url,this._images[key])},addBitmapFont:function(key,url,data,xmlData,xSpacing,ySpacing){this._images[key]={url:url,data:data};PIXI.BaseTextureCache[key]=new PIXI.BaseTexture(data);PIXI.TextureCache[key]=new PIXI.Texture(PIXI.BaseTextureCache[key]);Phaser.LoaderParser.bitmapFont(this.game,xmlData,key,xSpacing,ySpacing);this._bitmapFont[key]=PIXI.BitmapText.fonts[key];this._resolveURL(url,this._bitmapFont[key])},addPhysicsData:function(key,url,JSONData,format){this._physics[key]={url:url,data:JSONData,format:format};this._resolveURL(url,this._physics[key])},addDefaultImage:function(){var img=new Image;img.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgAQMAAABJtOi3AAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAABVJREFUeF7NwIEAAAAAgKD9qdeocAMAoAABm3DkcAAAAABJRU5ErkJggg==";this._images["__default"]={url:null,data:img};this._images["__default"].frame=new Phaser.Frame(0,0,0,32,32,"","");this._images["__default"].frameData=new Phaser.FrameData;this._images["__default"].frameData.addFrame(new Phaser.Frame(0,0,0,32,32,null,this.game.rnd.uuid()));PIXI.BaseTextureCache["__default"]=new PIXI.BaseTexture(img);PIXI.TextureCache["__default"]=new PIXI.Texture(PIXI.BaseTextureCache["__default"])},addMissingImage:function(){var img=new Image;img.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJ9JREFUeNq01ssOwyAMRFG46v//Mt1ESmgh+DFmE2GPOBARKb2NVjo+17PXLD8a1+pl5+A+wSgFygymWYHBb0FtsKhJDdZlncG2IzJ4ayoMDv20wTmSMzClEgbWYNTAkQ0Z+OJ+A/eWnAaR9+oxCF4Os0H8htsMUp+pwcgBBiMNnAwF8GqIgL2hAzaGFFgZauDPKABmowZ4GL369/0rwACp2yA/ttmvsQAAAABJRU5ErkJggg==";this._images["__missing"]={url:null,data:img};this._images["__missing"].frame=new Phaser.Frame(0,0,0,32,32,"","");this._images["__missing"].frameData=new Phaser.FrameData;this._images["__missing"].frameData.addFrame(new Phaser.Frame(0,0,0,32,32,null,this.game.rnd.uuid()));PIXI.BaseTextureCache["__missing"]=new PIXI.BaseTexture(img);PIXI.TextureCache["__missing"]=new PIXI.Texture(PIXI.BaseTextureCache["__missing"])},addText:function(key,url,data){this._text[key]={url:url,data:data};this._resolveURL(url,this._text[key])},addJSON:function(key,url,data){this._json[key]={url:url,data:data};this._resolveURL(url,this._json[key])},addXML:function(key,url,data){this._xml[key]={url:url,data:data};this._resolveURL(url,this._xml[key])},addImage:function(key,url,data){if(this.checkImageKey(key)){this.removeImage(key)}this._images[key]={url:url,data:data};this._images[key].frame=new Phaser.Frame(0,0,0,data.width,data.height,key,this.game.rnd.uuid());this._images[key].frameData=new Phaser.FrameData;this._images[key].frameData.addFrame(new Phaser.Frame(0,0,0,data.width,data.height,url,this.game.rnd.uuid()));PIXI.BaseTextureCache[key]=new PIXI.BaseTexture(data);PIXI.TextureCache[key]=new PIXI.Texture(PIXI.BaseTextureCache[key]);this._resolveURL(url,this._images[key])},addSound:function(key,url,data,webAudio,audioTag){webAudio=webAudio||true;audioTag=audioTag||false;var decoded=false;if(audioTag){decoded=true}this._sounds[key]={url:url,data:data,isDecoding:false,decoded:decoded,webAudio:webAudio,audioTag:audioTag,locked:this.game.sound.touchLocked};this._resolveURL(url,this._sounds[key])},reloadSound:function(key){var _this=this;if(this._sounds[key]){this._sounds[key].data.src=this._sounds[key].url;this._sounds[key].data.addEventListener("canplaythrough",function(){return _this.reloadSoundComplete(key)},false);
this._sounds[key].data.load()}},reloadSoundComplete:function(key){if(this._sounds[key]){this._sounds[key].locked=false;this.onSoundUnlock.dispatch(key)}},updateSound:function(key,property,value){if(this._sounds[key]){this._sounds[key][property]=value}},decodedSound:function(key,data){this._sounds[key].data=data;this._sounds[key].decoded=true;this._sounds[key].isDecoding=false},getCanvas:function(key){if(this._canvases[key]){return this._canvases[key].canvas}else{console.warn('Phaser.Cache.getCanvas: Invalid key: "'+key+'"');return null}},getBitmapData:function(key){if(this._bitmapDatas[key]){return this._bitmapDatas[key].data}else{console.warn('Phaser.Cache.getBitmapData: Invalid key: "'+key+'"');return null}},getBitmapFont:function(key){if(this._bitmapFont[key]){return this._bitmapFont[key]}else{console.warn('Phaser.Cache.getBitmapFont: Invalid key: "'+key+'"');return null}},getPhysicsData:function(key,object,fixtureKey){if(typeof object==="undefined"||object===null){if(this._physics[key]){return this._physics[key].data}else{console.warn('Phaser.Cache.getPhysicsData: Invalid key: "'+key+'"')}}else{if(this._physics[key]&&this._physics[key].data[object]){var fixtures=this._physics[key].data[object];if(fixtures&&fixtureKey){for(var fixture in fixtures){fixture=fixtures[fixture];if(fixture.fixtureKey===fixtureKey){return fixture}}console.warn('Phaser.Cache.getPhysicsData: Could not find given fixtureKey: "'+fixtureKey+" in "+key+'"')}else{return fixtures}}else{console.warn('Phaser.Cache.getPhysicsData: Invalid key/object: "'+key+" / "+object+'"')}}return null},checkKey:function(type,key){if(this._cacheMap[type][key]){return true}return false},checkCanvasKey:function(key){return this.checkKey(Phaser.Cache.CANVAS,key)},checkImageKey:function(key){return this.checkKey(Phaser.Cache.IMAGE,key)},checkTextureKey:function(key){return this.checkKey(Phaser.Cache.TEXTURE,key)},checkSoundKey:function(key){return this.checkKey(Phaser.Cache.SOUND,key)},checkTextKey:function(key){return this.checkKey(Phaser.Cache.TEXT,key)},checkPhysicsKey:function(key){return this.checkKey(Phaser.Cache.PHYSICS,key)},checkTilemapKey:function(key){return this.checkKey(Phaser.Cache.TILEMAP,key)},checkBinaryKey:function(key){return this.checkKey(Phaser.Cache.BINARY,key)},checkBitmapDataKey:function(key){return this.checkKey(Phaser.Cache.BITMAPDATA,key)},checkBitmapFontKey:function(key){return this.checkKey(Phaser.Cache.BITMAPFONT,key)},checkJSONKey:function(key){return this.checkKey(Phaser.Cache.JSON,key)},checkXMLKey:function(key){return this.checkKey(Phaser.Cache.XML,key)},checkURL:function(url){if(this._urlMap[this._resolveURL(url)]){return true}return false},getImage:function(key){if(this._images[key]){return this._images[key].data}else{console.warn('Phaser.Cache.getImage: Invalid key: "'+key+'"');return null}},getTilemapData:function(key){if(this._tilemaps[key]){return this._tilemaps[key]}else{console.warn('Phaser.Cache.getTilemapData: Invalid key: "'+key+'"');return null}},getFrameData:function(key,map){if(typeof map==="undefined"){map=Phaser.Cache.IMAGE}if(this._cacheMap[map][key]){return this._cacheMap[map][key].frameData}return null},updateFrameData:function(key,frameData){if(this._images[key]){this._images[key].frameData=frameData}},getFrameByIndex:function(key,frame){if(this._images[key]){return this._images[key].frameData.getFrame(frame)}return null},getFrameByName:function(key,frame){if(this._images[key]){return this._images[key].frameData.getFrameByName(frame)}return null},getFrame:function(key){if(this._images[key]){return this._images[key].frame}return null},getTextureFrame:function(key){if(this._textures[key]){return this._textures[key].frame}return null},getRenderTexture:function(key){if(this._textures[key]){return this._textures[key]}else{console.warn('Phaser.Cache.getTexture: Invalid key: "'+key+'"');return null}},getTexture:function(key){if(this._textures[key]){return this._textures[key]}else{console.warn('Phaser.Cache.getTexture: Invalid key: "'+key+'"')}},getSound:function(key){if(this._sounds[key]){return this._sounds[key]}else{console.warn('Phaser.Cache.getSound: Invalid key: "'+key+'"');return null}},getSoundData:function(key){if(this._sounds[key]){return this._sounds[key].data}else{console.warn('Phaser.Cache.getSoundData: Invalid key: "'+key+'"');return null}},isSoundDecoded:function(key){if(this._sounds[key]){return this._sounds[key].decoded}},isSoundReady:function(key){return this._sounds[key]&&this._sounds[key].decoded&&this.game.sound.touchLocked===false},getFrameCount:function(key){if(this._images[key]){return this._images[key].frameData.total}return 0},getText:function(key){if(this._text[key]){return this._text[key].data}else{console.warn('Phaser.Cache.getText: Invalid key: "'+key+'"');return null}},getJSON:function(key){if(this._json[key]){return this._json[key].data}else{console.warn('Phaser.Cache.getJSON: Invalid key: "'+key+'"');return null}},getXML:function(key){if(this._xml[key]){return this._xml[key].data}else{console.warn('Phaser.Cache.getXML: Invalid key: "'+key+'"');return null}},getBinary:function(key){if(this._binary[key]){return this._binary[key]}else{console.warn('Phaser.Cache.getBinary: Invalid key: "'+key+'"');return null}},getURL:function(url){var url=this._resolveURL(url);if(url){return this._urlMap[url]}else{console.warn('Phaser.Cache.getUrl: Invalid url: "'+url+'" or Cache.autoResolveURL was false');return null}},getUrl:function(url){return this.getURL(url)},getKeys:function(type){var array=null;switch(type){case Phaser.Cache.CANVAS:array=this._canvases;break;case Phaser.Cache.IMAGE:array=this._images;break;case Phaser.Cache.TEXTURE:array=this._textures;break;case Phaser.Cache.SOUND:array=this._sounds;break;case Phaser.Cache.TEXT:array=this._text;break;case Phaser.Cache.PHYSICS:array=this._physics;break;case Phaser.Cache.TILEMAP:array=this._tilemaps;break;case Phaser.Cache.BINARY:array=this._binary;break;case Phaser.Cache.BITMAPDATA:array=this._bitmapDatas;break;case Phaser.Cache.BITMAPFONT:array=this._bitmapFont;break;case Phaser.Cache.JSON:array=this._json;break;case Phaser.Cache.XML:array=this._xml;break}if(!array){return}var output=[];for(var item in array){if(item!=="__default"&&item!=="__missing"){output.push(item)}}return output},removeCanvas:function(key){delete this._canvases[key]},removeImage:function(key,removeFromPixi){if(typeof removeFromPixi==="undefined"){removeFromPixi=true}delete this._images[key];if(removeFromPixi){PIXI.BaseTextureCache[key].destroy()}},removeSound:function(key){delete this._sounds[key]},removeText:function(key){delete this._text[key]},removeJSON:function(key){delete this._json[key]},removeXML:function(key){delete this._xml[key]},removePhysics:function(key){delete this._physics[key]},removeTilemap:function(key){delete this._tilemaps[key]},removeBinary:function(key){delete this._binary[key]},removeBitmapData:function(key){delete this._bitmapDatas[key]},removeBitmapFont:function(key){delete this._bitmapFont[key]},_resolveURL:function(url,data){if(!this.autoResolveURL){return null}this._urlResolver.src=this.game.load.baseURL+url;this._urlTemp=this._urlResolver.src;this._urlResolver.src="";if(data){this._urlMap[this._urlTemp]=data}return this._urlTemp},destroy:function(){for(var item in this._images){if(item!=="__default"&&item!=="__missing"){delete this._images[item]}}var containers=[this._canvases,this._sounds,this._text,this._json,this._xml,this._textures,this._physics,this._tilemaps,this._binary,this._bitmapDatas,this._bitmapFont];for(var i=0;i<containers.length;i++){for(var item in containers[i]){delete containers[i][item]}}this._urlMap=null;this._urlResolver=null;this._urlTemp=null}};Phaser.Cache.prototype.constructor=Phaser.Cache;Phaser.Loader=function(game){this.game=game;this.resetLocked=false;this.isLoading=false;this.hasLoaded=false;this.preloadSprite=null;this.crossOrigin=false;this.baseURL="";this.onLoadStart=new Phaser.Signal;this.onLoadComplete=new Phaser.Signal;this.onPackComplete=new Phaser.Signal;this.onFileStart=new Phaser.Signal;this.onFileComplete=new Phaser.Signal;this.onFileError=new Phaser.Signal;this.useXDomainRequest=false;this._warnedAboutXDomainRequest=false;this.enableParallel=true;this.maxParallelDownloads=4;this._withSyncPointDepth=0;this._fileList=[];this._flightQueue=[];this._processingHead=0;this._fileLoadStarted=false;this._totalPackCount=0;this._totalFileCount=0;this._loadedPackCount=0;this._loadedFileCount=0};Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY=0;Phaser.Loader.TEXTURE_ATLAS_JSON_HASH=1;Phaser.Loader.TEXTURE_ATLAS_XML_STARLING=2;Phaser.Loader.PHYSICS_LIME_CORONA_JSON=3;Phaser.Loader.PHYSICS_PHASER_JSON=4;Phaser.Loader.prototype={setPreloadSprite:function(sprite,direction){direction=direction||0;this.preloadSprite={sprite:sprite,direction:direction,width:sprite.width,height:sprite.height,rect:null};if(direction===0){this.preloadSprite.rect=new Phaser.Rectangle(0,0,1,sprite.height)}else{this.preloadSprite.rect=new Phaser.Rectangle(0,0,sprite.width,1)}sprite.crop(this.preloadSprite.rect);sprite.visible=true},resize:function(){if(this.preloadSprite&&this.preloadSprite.height!==this.preloadSprite.sprite.height){this.preloadSprite.rect.height=this.preloadSprite.sprite.height}},checkKeyExists:function(type,key){return this.getAssetIndex(type,key)>-1},getAssetIndex:function(type,key){var bestFound=-1;for(var i=0;i<this._fileList.length;i++){var file=this._fileList[i];if(file.type===type&&file.key===key){bestFound=i;if(!file.loaded&&!file.loading){break}}}return bestFound},getAsset:function(type,key){var fileIndex=this.getAssetIndex(type,key);if(fileIndex>-1){return{index:fileIndex,file:this._fileList[fileIndex]}}return false},reset:function(hard,clearEvents){if(typeof clearEvents==="undefined"){clearEvents=false}if(this.resetLocked){return}if(hard){this.preloadSprite=null}this.isLoading=false;this._processingHead=0;this._fileList.length=0;this._flightQueue.length=0;this._fileLoadStarted=false;this._totalFileCount=0;this._totalPackCount=0;this._loadedPackCount=0;this._loadedFileCount=0;if(clearEvents){this.onLoadStart.removeAll();this.onLoadComplete.removeAll();this.onPackComplete.removeAll();this.onFileStart.removeAll();this.onFileComplete.removeAll();this.onFileError.removeAll()}},addToFileList:function(type,key,url,properties,overwrite){var file={type:type,key:key,url:url,syncPoint:this._withSyncPointDepth>0,data:null,loading:false,loaded:false,error:false};if(properties){for(var prop in properties){file[prop]=properties[prop]}}var fileIndex=this.getAssetIndex(type,key);if(overwrite&&fileIndex>-1){var currentFile=this._fileList[fileIndex];if(!currentFile.loading&&!currentFile.loaded){this._fileList[fileIndex]=file}else{this._fileList.push(file);this._totalFileCount++}}else if(fileIndex===-1){this._fileList.push(file);this._totalFileCount++}},replaceInFileList:function(type,key,url,properties){return this.addToFileList(type,key,url,properties,true)},pack:function(key,url,data,callbackContext){if(typeof url==="undefined"){url=null}if(typeof data==="undefined"){data=null}if(typeof callbackContext==="undefined"){callbackContext=null}if(!url&&!data){console.warn("Phaser.Loader.pack - Both url and data are null. One must be set.");return this}var pack={type:"packfile",key:key,url:url,syncPoint:true,data:null,loading:false,loaded:false,error:false,callbackContext:callbackContext};if(data){if(typeof data==="string"){data=JSON.parse(data)}pack.data=data||{};pack.loaded=true}for(var i=0;i<this._fileList.length+1;i++){var file=this._fileList[i];if(!file||!file.loaded&&!file.loading&&file.type!=="packfile"){this._fileList.splice(i,1,pack);this._totalPackCount++;break}}return this},image:function(key,url,overwrite){if(typeof overwrite==="undefined"){overwrite=false}this.addToFileList("image",key,url,undefined,overwrite);return this},text:function(key,url,overwrite){if(typeof overwrite==="undefined"){overwrite=false}this.addToFileList("text",key,url,undefined,overwrite);return this},json:function(key,url,overwrite){if(typeof overwrite==="undefined"){overwrite=false}this.addToFileList("json",key,url,undefined,overwrite);return this},xml:function(key,url,overwrite){if(typeof overwrite==="undefined"){overwrite=false}this.addToFileList("xml",key,url,undefined,overwrite);return this},script:function(key,url,callback,callbackContext){if(typeof callback==="undefined"){callback=false}if(callback!==false&&typeof callbackContext==="undefined"){callbackContext=callback}this.addToFileList("script",key,url,{syncPoint:true,callback:callback,callbackContext:callbackContext});return this},binary:function(key,url,callback,callbackContext){if(typeof callback==="undefined"){callback=false}if(callback!==false&&typeof callbackContext==="undefined"){callbackContext=callback}this.addToFileList("binary",key,url,{callback:callback,callbackContext:callbackContext});return this},spritesheet:function(key,url,frameWidth,frameHeight,frameMax,margin,spacing){if(typeof frameMax==="undefined"){frameMax=-1}if(typeof margin==="undefined"){margin=0}if(typeof spacing==="undefined"){spacing=0}this.addToFileList("spritesheet",key,url,{frameWidth:frameWidth,frameHeight:frameHeight,frameMax:frameMax,margin:margin,spacing:spacing});return this},audio:function(key,urls,autoDecode){if(typeof autoDecode==="undefined"){autoDecode=true}if(typeof urls==="string"){urls=[urls]}this.addToFileList("audio",key,urls,{buffer:null,autoDecode:autoDecode});return this},audiosprite:function(key,urls,jsonURL,jsonData,autoDecode){if(typeof jsonURL==="undefined"){jsonURL=null}if(typeof jsonData==="undefined"){jsonData=null}if(typeof autoDecode==="undefined"){autoDecode=true}this.audio(key,urls,autoDecode);if(jsonURL){this.json(key+"-audioatlas",jsonURL)}else if(jsonData){if(typeof jsonData==="string"){jsonData=JSON.parse(jsonData)}this.game.cache.addJSON(key+"-audioatlas","",jsonData)}else{console.warn("Phaser.Loader.audiosprite - You must specify either a jsonURL or provide a jsonData object")}return this},tilemap:function(key,url,data,format){if(typeof url==="undefined"){url=null}if(typeof data==="undefined"){data=null}if(typeof format==="undefined"){format=Phaser.Tilemap.CSV}if(!url&&!data){console.warn("Phaser.Loader.tilemap - Both url and data are null. One must be set.");return this}if(data){switch(format){case Phaser.Tilemap.CSV:break;case Phaser.Tilemap.TILED_JSON:if(typeof data==="string"){data=JSON.parse(data)}break}this.game.cache.addTilemap(key,null,data,format)}else{this.addToFileList("tilemap",key,url,{format:format})}return this},physics:function(key,url,data,format){if(typeof url==="undefined"){url=null}if(typeof data==="undefined"){data=null}if(typeof format==="undefined"){format=Phaser.Physics.LIME_CORONA_JSON}if(!url&&!data){console.warn("Phaser.Loader.physics - Both url and data are null. One must be set.");return this}if(data){if(typeof data==="string"){data=JSON.parse(data)}this.game.cache.addPhysicsData(key,null,data,format)}else{this.addToFileList("physics",key,url,{format:format})}return this},bitmapFont:function(key,textureURL,xmlURL,xmlData,xSpacing,ySpacing){if(typeof xmlURL==="undefined"){xmlURL=null}if(typeof xmlData==="undefined"){xmlData=null}if(typeof xSpacing==="undefined"){xSpacing=0}if(typeof ySpacing==="undefined"){ySpacing=0}if(xmlURL){this.addToFileList("bitmapfont",key,textureURL,{xmlURL:xmlURL,xSpacing:xSpacing,ySpacing:ySpacing})}else{if(typeof xmlData==="string"){var xml=this.parseXml(xmlData);if(!xml){throw new Error("Phaser.Loader. Invalid Bitmap Font XML given")}this.addToFileList("bitmapfont",key,textureURL,{xmlURL:null,xmlData:xml,xSpacing:xSpacing,ySpacing:ySpacing})}}return this},atlasJSONArray:function(key,textureURL,atlasURL,atlasData){return this.atlas(key,textureURL,atlasURL,atlasData,Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY)},atlasJSONHash:function(key,textureURL,atlasURL,atlasData){return this.atlas(key,textureURL,atlasURL,atlasData,Phaser.Loader.TEXTURE_ATLAS_JSON_HASH)},atlasXML:function(key,textureURL,atlasURL,atlasData){return this.atlas(key,textureURL,atlasURL,atlasData,Phaser.Loader.TEXTURE_ATLAS_XML_STARLING)},atlas:function(key,textureURL,atlasURL,atlasData,format){if(typeof atlasURL==="undefined"){atlasURL=null}if(typeof atlasData==="undefined"){atlasData=null}if(typeof format==="undefined"){format=Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY}if(atlasURL){this.addToFileList("textureatlas",key,textureURL,{atlasURL:atlasURL,format:format})}else{switch(format){case Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY:if(typeof atlasData==="string"){atlasData=JSON.parse(atlasData)}break;case Phaser.Loader.TEXTURE_ATLAS_XML_STARLING:if(typeof atlasData==="string"){var xml=this.parseXml(atlasData);if(!xml){throw new Error("Phaser.Loader. Invalid Texture Atlas XML given")}atlasData=xml}break}this.addToFileList("textureatlas",key,textureURL,{atlasURL:null,atlasData:atlasData,format:format})}return this},withSyncPoint:function(callback,callbackContext){this._withSyncPointDepth++;try{callback.call(callbackContext||this,this)}finally{this._withSyncPointDepth--}return this},addSyncPoint:function(type,key){var asset=this.getAsset(type,key);if(asset){asset.file.syncPoint=true}return this},removeFile:function(type,key){var asset=this.getAsset(type,key);if(asset){if(!asset.loaded&&!asset.loading){this._fileList.splice(asset.index,1)}}},removeAll:function(){this._fileList.length=0;this._flightQueue.length=0},start:function(){if(this.isLoading){return}this.hasLoaded=false;this.isLoading=true;this.updateProgress();this.processLoadQueue()},processLoadQueue:function(){if(!this.isLoading){console.warn("Phaser.Loader - active loading canceled / reset");this.finishedLoading(true);return}for(var i=0;i<this._flightQueue.length;i++){var file=this._flightQueue[i];if(file.loaded||file.error){this._flightQueue.splice(i,1);i--;file.loading=false;file.requestUrl=null;file.requestObject=null;if(file.error){this.onFileError.dispatch(file.key,file)}if(file.type!=="packfile"){this._loadedFileCount++;this.onFileComplete.dispatch(this.progress,file.key,!file.error,this._loadedFileCount,this._totalFileCount)}else if(file.type==="packfile"&&file.error){this._loadedPackCount++;this.onPackComplete.dispatch(file.key,!file.error,this._loadedPackCount,this._totalPackCount)}}}var syncblock=false;var inflightLimit=this.enableParallel?Phaser.Math.clamp(this.maxParallelDownloads,1,12):1;for(var i=this._processingHead;i<this._fileList.length;i++){var file=this._fileList[i];if(file.type==="packfile"&&!file.error&&file.loaded&&i===this._processingHead){this.processPack(file);this._loadedPackCount++;this.onPackComplete.dispatch(file.key,!file.error,this._loadedPackCount,this._totalPackCount)}if(file.loaded||file.error){if(i===this._processingHead){this._processingHead=i+1}}else if(!file.loading&&this._flightQueue.length<inflightLimit){if(file.type==="packfile"&&!file.data){this._flightQueue.push(file);file.loading=true;this.loadFile(file)}else if(!syncblock){if(!this._fileLoadStarted){this._fileLoadStarted=true;this.onLoadStart.dispatch()}this._flightQueue.push(file);file.loading=true;this.onFileStart.dispatch(this.progress,file.key,file.url);this.loadFile(file)}}if(!file.loaded&&file.syncPoint){syncblock=true}if(this._flightQueue.length>=inflightLimit||syncblock&&this._loadedPackCount===this._totalPackCount){break}}this.updateProgress();if(this._processingHead>=this._fileList.length){this.finishedLoading()}else if(!this._flightQueue.length){console.warn("Phaser.Loader - aborting: processing queue empty, loading may have stalled");var _this=this;setTimeout(function(){_this.finishedLoading(true)},2e3)}},finishedLoading:function(abnormal){if(this.hasLoaded){return}this.hasLoaded=true;this.isLoading=false;if(!abnormal&&!this._fileLoadStarted){this._fileLoadStarted=true;this.onLoadStart.dispatch()}this.onLoadComplete.dispatch();this.reset();this.game.state.loadComplete()},asyncComplete:function(file,errorMessage){if(typeof errorMessage==="undefined"){errorMessage=""}file.loaded=true;file.error=!!errorMessage;if(errorMessage){file.errorMessage=errorMessage;console.warn("Phaser.Loader - "+file.type+"["+file.key+"]"+": "+errorMessage)}this.processLoadQueue()},processPack:function(pack){var packData=pack.data[pack.key];if(!packData){console.warn("Phaser.Loader - "+pack.key+": pack has data, but not for pack key");return}for(var i=0;i<packData.length;i++){var file=packData[i];switch(file.type){case"image":this.image(file.key,file.url,file.overwrite);break;case"text":this.text(file.key,file.url,file.overwrite);break;case"json":this.json(file.key,file.url,file.overwrite);break;case"xml":this.xml(file.key,file.url,file.overwrite);break;case"script":this.script(file.key,file.url,file.callback,pack.callbackContext||this);break;case"binary":this.binary(file.key,file.url,file.callback,pack.callbackContext||this);break;case"spritesheet":this.spritesheet(file.key,file.url,file.frameWidth,file.frameHeight,file.frameMax,file.margin,file.spacing);break;case"audio":this.audio(file.key,file.urls,file.autoDecode);break;case"audiosprite":this.audio(file.key,file.urls,file.jsonURL);break;case"tilemap":this.tilemap(file.key,file.url,file.data,Phaser.Tilemap[file.format]);break;case"physics":this.physics(file.key,file.url,file.data,Phaser.Loader[file.format]);break;case"bitmapFont":this.bitmapFont(file.key,file.textureURL,file.xmlURL,file.xmlData,file.xSpacing,file.ySpacing);break;case"atlasJSONArray":this.atlasJSONArray(file.key,file.textureURL,file.atlasURL,file.atlasData);break;case"atlasJSONHash":this.atlasJSONHash(file.key,file.textureURL,file.atlasURL,file.atlasData);break;case"atlasXML":this.atlasXML(file.key,file.textureURL,file.atlasURL,file.atlasData);break;case"atlas":this.atlas(file.key,file.textureURL,file.atlasURL,file.atlasData,Phaser.Loader[file.format]);break}}},transformUrl:function(url){return this.baseURL+url},loadFile:function(file){switch(file.type){case"packfile":this.xhrLoad(file,this.transformUrl(file.url,file),"text",this.fileComplete);break;case"image":case"spritesheet":case"textureatlas":case"bitmapfont":this.loadImageTag(file);break;case"audio":file.url=this.getAudioURL(file.url);if(file.url){if(this.game.sound.usingWebAudio){this.xhrLoad(file,this.transformUrl(file.url,file),"arraybuffer",this.fileComplete)}else if(this.game.sound.usingAudioTag){this.loadAudioTag(file)}}else{this.fileError(file,null,"no supported audio URL specified")}break;case"json":this.xhrLoad(file,this.transformUrl(file.url,file),"text",this.jsonLoadComplete);break;case"xml":this.xhrLoad(file,this.transformUrl(file.url,file),"text",this.xmlLoadComplete);break;case"tilemap":if(file.format===Phaser.Tilemap.TILED_JSON){this.xhrLoad(file,this.transformUrl(file.url,file),"text",this.jsonLoadComplete)}else if(file.format===Phaser.Tilemap.CSV){this.xhrLoad(file,this.transformUrl(file.url,file),"text",this.csvLoadComplete)}else{this.asyncComplete(file,"invalid Tilemap format: "+file.format)}break;case"text":case"script":case"physics":this.xhrLoad(file,this.transformUrl(file.url,file),"text",this.fileComplete);break;case"binary":this.xhrLoad(file,this.transformUrl(file.url,file),"arraybuffer",this.fileComplete);break}},loadImageTag:function(file){var _this=this;file.data=new Image;file.data.name=file.key;if(this.crossOrigin){file.data.crossOrigin=this.crossOrigin}file.data.onload=function(){if(file.data.onload){file.data.onload=null;file.data.onerror=null;_this.fileComplete(file)}};file.data.onerror=function(){if(file.data.onload){file.data.onload=null;file.data.onerror=null;_this.fileError(file)}};file.data.src=this.transformUrl(file.url,file);if(file.data.complete&&file.data.width&&file.data.height){file.data.onload=null;file.data.onerror=null;this.fileComplete(file)}},loadAudioTag:function(file){var _this=this;if(this.game.sound.touchLocked){file.data=new Audio;file.data.name=file.key;file.data.preload="auto";file.data.src=this.transformUrl(file.url,file);this.fileComplete(file)}else{file.data=new Audio;file.data.name=file.key;var playThroughEvent=function(){file.data.removeEventListener("canplaythrough",playThroughEvent,false);file.data.onerror=null;Phaser.GAMES[_this.game.id].load.fileComplete(file)};file.data.onerror=function(){file.data.removeEventListener("canplaythrough",playThroughEvent,false);file.data.onerror=null;_this.fileError(file)};file.data.preload="auto";file.data.src=this.transformUrl(file.url,file);file.data.addEventListener("canplaythrough",playThroughEvent,false);file.data.load()}},xhrLoad:function(file,url,type,onload,onerror){if(this.useXDomainRequest&&window.XDomainRequest){this.xhrLoadWithXDR(file,url,type,onload,onerror);return}var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.responseType=type;onerror=onerror||this.fileError;var _this=this;xhr.onload=function(){try{return onload.call(_this,file,xhr)}catch(e){if(!_this.hasLoaded){_this.asyncComplete(file,e.message||"Exception")}else{if(window["console"]){console.error(e)}}}};xhr.onerror=function(){try{return onerror.call(_this,file,xhr)}catch(e){if(!_this.hasLoaded){_this.asyncComplete(file,e.message||"Exception")}else{if(window["console"]){console.error(e)}}}};file.requestObject=xhr;file.requestUrl=url;xhr.send()},xhrLoadWithXDR:function(file,url,type,onload,onerror){if(!this._warnedAboutXDomainRequest&&(!this.game.device.ie||this.game.device.ieVersion>=10)){this._warnedAboutXDomainRequest=true;console.warn("Phaser.Loader - using XDomainRequest outside of IE 9")}var xhr=new window.XDomainRequest;xhr.open("GET",url,true);xhr.responseType=type;xhr.timeout=3e3;onerror=onerror||this.fileError;var _this=this;xhr.onerror=function(){try{return onerror.call(_this,file,xhr)}catch(e){_this.asyncComplete(file,e.message||"Exception")}};xhr.ontimeout=function(){try{return onerror.call(_this,file,xhr)}catch(e){_this.asyncComplete(file,e.message||"Exception")}};xhr.onprogress=function(){};xhr.onload=function(){try{return onload.call(_this,file,xhr)}catch(e){_this.asyncComplete(file,e.message||"Exception")}};file.requestObject=xhr;file.requestUrl=url;setTimeout(function(){xhr.send()},0)},getAudioURL:function(urls){for(var i=0;i<urls.length;i++){var url=urls[i];var audioType;if(url.uri){url=url.uri;audioType=url.type}else{if(url.indexOf("blob:")===0||url.indexOf("data:")===0){return url}if(url.indexOf("?")>=0){url=url.substr(0,url.indexOf("?"))}var extension=url.substr((Math.max(0,url.lastIndexOf("."))||Infinity)+1);audioType=extension.toLowerCase()}if(this.game.device.canPlayAudio(audioType)){return urls[i]}}return null},fileError:function(file,xhr,reason){var url=file.requestUrl||this.transformUrl(file.url,file);var message="error loading asset from URL "+url;if(!reason&&xhr){reason=xhr.status}if(reason){message=message+" ("+reason+")"}this.asyncComplete(file,message)},fileComplete:function(file,xhr){var loadNext=true;switch(file.type){case"packfile":var data=JSON.parse(xhr.responseText);file.data=data||{};break;case"image":this.game.cache.addImage(file.key,file.url,file.data);break;case"spritesheet":this.game.cache.addSpriteSheet(file.key,file.url,file.data,file.frameWidth,file.frameHeight,file.frameMax,file.margin,file.spacing);break;case"textureatlas":if(file.atlasURL==null){this.game.cache.addTextureAtlas(file.key,file.url,file.data,file.atlasData,file.format)}else{loadNext=false;if(file.format==Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY||file.format==Phaser.Loader.TEXTURE_ATLAS_JSON_HASH){this.xhrLoad(file,this.transformUrl(file.atlasURL,file),"text",this.jsonLoadComplete)}else if(file.format==Phaser.Loader.TEXTURE_ATLAS_XML_STARLING){this.xhrLoad(file,this.transformUrl(file.atlasURL,file),"text",this.xmlLoadComplete)}else{throw new Error("Phaser.Loader. Invalid Texture Atlas format: "+file.format)}}break;case"bitmapfont":if(!file.xmlURL){this.game.cache.addBitmapFont(file.key,file.url,file.data,file.xmlData,file.xSpacing,file.ySpacing)}else{loadNext=false;this.xhrLoad(file,this.transformUrl(file.xmlURL,file),"text",this.xmlLoadComplete)}break;case"audio":if(this.game.sound.usingWebAudio){file.data=xhr.response;this.game.cache.addSound(file.key,file.url,file.data,true,false);if(file.autoDecode){this.game.sound.decode(file.key)}}else{this.game.cache.addSound(file.key,file.url,file.data,false,true)}break;case"text":file.data=xhr.responseText;this.game.cache.addText(file.key,file.url,file.data);break;case"physics":var data=JSON.parse(xhr.responseText);this.game.cache.addPhysicsData(file.key,file.url,data,file.format);break;case"script":file.data=document.createElement("script");file.data.language="javascript";file.data.type="text/javascript";file.data.defer=false;file.data.text=xhr.responseText;document.head.appendChild(file.data);if(file.callback){file.data=file.callback.call(file.callbackContext,file.key,xhr.responseText)}break;case"binary":if(file.callback){file.data=file.callback.call(file.callbackContext,file.key,xhr.response)}else{file.data=xhr.response}this.game.cache.addBinary(file.key,file.data);break}if(loadNext){this.asyncComplete(file)}},jsonLoadComplete:function(file,xhr){var data=JSON.parse(xhr.responseText);if(file.type==="tilemap"){this.game.cache.addTilemap(file.key,file.url,data,file.format)}else if(file.type==="json"){this.game.cache.addJSON(file.key,file.url,data)}else{this.game.cache.addTextureAtlas(file.key,file.url,file.data,data,file.format)}this.asyncComplete(file)},csvLoadComplete:function(file,xhr){var data=xhr.responseText;this.game.cache.addTilemap(file.key,file.url,data,file.format);this.asyncComplete(file)},xmlLoadComplete:function(file,xhr){var data=xhr.responseText;var xml=this.parseXml(data);if(!xml){var responseType=xhr.responseType||xhr.contentType;console.warn("Phaser.Loader - "+file.key+": invalid XML ("+responseType+")");this.asyncComplete(file,"invalid XML");return}if(file.type==="bitmapfont"){this.game.cache.addBitmapFont(file.key,file.url,file.data,xml,file.xSpacing,file.ySpacing)}else if(file.type==="textureatlas"){this.game.cache.addTextureAtlas(file.key,file.url,file.data,xml,file.format)}else if(file.type==="xml"){this.game.cache.addXML(file.key,file.url,xml)}this.asyncComplete(file)},parseXml:function(data){var xml;try{if(window["DOMParser"]){var domparser=new DOMParser;xml=domparser.parseFromString(data,"text/xml")}else{xml=new ActiveXObject("Microsoft.XMLDOM");xml.async="false";xml.loadXML(data)}}catch(e){xml=null}if(!xml||!xml.documentElement||xml.getElementsByTagName("parsererror").length){return null}else{return xml}},updateProgress:function(){if(this.preloadSprite){if(this.preloadSprite.direction===0){this.preloadSprite.rect.width=Math.floor(this.preloadSprite.width/100*this.progress)}else{this.preloadSprite.rect.height=Math.floor(this.preloadSprite.height/100*this.progress)}if(this.preloadSprite.sprite){this.preloadSprite.sprite.updateCrop()}else{this.preloadSprite=null}}},totalLoadedFiles:function(){return this._loadedFileCount},totalQueuedFiles:function(){return this._totalFileCount-this._loadedFileCount},totalLoadedPacks:function(){return this._totalPackCount},totalQueuedPacks:function(){return this._totalPackCount-this._loadedPackCount}};Object.defineProperty(Phaser.Loader.prototype,"progressFloat",{get:function(){var progress=this._loadedFileCount/this._totalFileCount*100;return Phaser.Math.clamp(progress||0,0,100)}});Object.defineProperty(Phaser.Loader.prototype,"progress",{get:function(){return Math.round(this.progressFloat)}});Phaser.Loader.prototype.constructor=Phaser.Loader;Phaser.LoaderParser={bitmapFont:function(game,xml,cacheKey,xSpacing,ySpacing){var data={};var info=xml.getElementsByTagName("info")[0];var common=xml.getElementsByTagName("common")[0];data.font=info.getAttribute("face");data.size=parseInt(info.getAttribute("size"),10);data.lineHeight=parseInt(common.getAttribute("lineHeight"),10)+ySpacing;data.chars={};var letters=xml.getElementsByTagName("char");for(var i=0;i<letters.length;i++){var charCode=parseInt(letters[i].getAttribute("id"),10);var textureRect=new PIXI.Rectangle(parseInt(letters[i].getAttribute("x"),10),parseInt(letters[i].getAttribute("y"),10),parseInt(letters[i].getAttribute("width"),10),parseInt(letters[i].getAttribute("height"),10));
data.chars[charCode]={xOffset:parseInt(letters[i].getAttribute("xoffset"),10),yOffset:parseInt(letters[i].getAttribute("yoffset"),10),xAdvance:parseInt(letters[i].getAttribute("xadvance"),10)+xSpacing,kerning:{},texture:PIXI.TextureCache[cacheKey]=new PIXI.Texture(PIXI.BaseTextureCache[cacheKey],textureRect)}}var kernings=xml.getElementsByTagName("kerning");for(i=0;i<kernings.length;i++){var first=parseInt(kernings[i].getAttribute("first"),10);var second=parseInt(kernings[i].getAttribute("second"),10);var amount=parseInt(kernings[i].getAttribute("amount"),10);data.chars[second].kerning[first]=amount}PIXI.BitmapText.fonts[cacheKey]=data}};Phaser.AudioSprite=function(game,key){this.game=game;this.key=key;this.config=this.game.cache.getJSON(key+"-audioatlas");this.autoplayKey=null;this.autoplay=false;this.sounds={};for(var k in this.config.spritemap){var marker=this.config.spritemap[k];var sound=this.game.add.sound(this.key);sound.addMarker(k,marker.start,marker.end-marker.start,null,marker.loop);this.sounds[k]=sound}if(this.config.autoplay){this.autoplayKey=this.config.autoplay;this.play(this.autoplayKey);this.autoplay=this.sounds[this.autoplayKey]}};Phaser.AudioSprite.prototype={play:function(marker,volume){if(typeof volume==="undefined"){volume=1}return this.sounds[marker].play(marker,null,volume)},stop:function(marker){if(!marker){for(var key in this.sounds){this.sounds[key].stop()}}else{this.sounds[marker].stop()}},get:function(marker){return this.sounds[marker]}};Phaser.AudioSprite.prototype.constructor=Phaser.AudioSprite;Phaser.Sound=function(game,key,volume,loop,connect){if(typeof volume==="undefined"){volume=1}if(typeof loop==="undefined"){loop=false}if(typeof connect==="undefined"){connect=game.sound.connectToMaster}this.game=game;this.name=key;this.key=key;this.loop=loop;this.volume=volume;this.markers={};this.context=null;this.autoplay=false;this.totalDuration=0;this.startTime=0;this.currentTime=0;this.duration=0;this.durationMS=0;this.position=0;this.stopTime=0;this.paused=false;this.pausedPosition=0;this.pausedTime=0;this.isPlaying=false;this.currentMarker="";this.fadeTween=null;this.pendingPlayback=false;this.override=false;this.allowMultiple=false;this.usingWebAudio=this.game.sound.usingWebAudio;this.usingAudioTag=this.game.sound.usingAudioTag;this.externalNode=null;this.masterGainNode=null;this.gainNode=null;this._sound=null;if(this.usingWebAudio){this.context=this.game.sound.context;this.masterGainNode=this.game.sound.masterGain;if(typeof this.context.createGain==="undefined"){this.gainNode=this.context.createGainNode()}else{this.gainNode=this.context.createGain()}this.gainNode.gain.value=volume*this.game.sound.volume;if(connect){this.gainNode.connect(this.masterGainNode)}}else if(this.usingAudioTag){if(this.game.cache.getSound(key)&&this.game.cache.isSoundReady(key)){this._sound=this.game.cache.getSoundData(key);this.totalDuration=0;if(this._sound.duration){this.totalDuration=this._sound.duration}}else{this.game.cache.onSoundUnlock.add(this.soundHasUnlocked,this)}}this.onDecoded=new Phaser.Signal;this.onPlay=new Phaser.Signal;this.onPause=new Phaser.Signal;this.onResume=new Phaser.Signal;this.onLoop=new Phaser.Signal;this.onStop=new Phaser.Signal;this.onMute=new Phaser.Signal;this.onMarkerComplete=new Phaser.Signal;this.onFadeComplete=new Phaser.Signal;this._volume=volume;this._buffer=null;this._muted=false;this._tempMarker=0;this._tempPosition=0;this._tempVolume=0;this._muteVolume=0;this._tempLoop=0;this._paused=false;this._onDecodedEventDispatched=false};Phaser.Sound.prototype={soundHasUnlocked:function(key){if(key===this.key){this._sound=this.game.cache.getSoundData(this.key);this.totalDuration=this._sound.duration}},addMarker:function(name,start,duration,volume,loop){if(typeof volume==="undefined"){volume=1}if(typeof loop==="undefined"){loop=false}this.markers[name]={name:name,start:start,stop:start+duration,volume:volume,duration:duration,durationMS:duration*1e3,loop:loop}},removeMarker:function(name){delete this.markers[name]},onEndedHandler:function(){this.isPlaying=false;this.stop()},update:function(){if(this.isDecoded&&!this._onDecodedEventDispatched){this.onDecoded.dispatch(this);this._onDecodedEventDispatched=true}if(this.pendingPlayback&&this.game.cache.isSoundReady(this.key)){this.pendingPlayback=false;this.play(this._tempMarker,this._tempPosition,this._tempVolume,this._tempLoop)}if(this.isPlaying){this.currentTime=this.game.time.time-this.startTime;if(this.currentTime>=this.durationMS){if(this.usingWebAudio){if(this.loop){this.onLoop.dispatch(this);if(this.currentMarker===""){this.currentTime=0;this.startTime=this.game.time.time}else{this.onMarkerComplete.dispatch(this.currentMarker,this);this.play(this.currentMarker,0,this.volume,true,true)}}else{if(this.currentMarker!==""){this.stop()}}}else{if(this.loop){this.onLoop.dispatch(this);this.play(this.currentMarker,0,this.volume,true,true)}else{this.stop()}}}}},loopFull:function(volume){this.play(null,0,volume,true)},play:function(marker,position,volume,loop,forceRestart){if(typeof marker==="undefined"||marker===false||marker===null){marker=""}if(typeof forceRestart==="undefined"){forceRestart=true}if(this.isPlaying&&!this.allowMultiple&&!forceRestart&&!this.override){return this}if(this._sound&&this.isPlaying&&!this.allowMultiple&&(this.override||forceRestart)){if(this.usingWebAudio){if(typeof this._sound.stop==="undefined"){this._sound.noteOff(0)}else{try{this._sound.stop(0)}catch(e){}}}else if(this.usingAudioTag){this._sound.pause();this._sound.currentTime=0}}if(marker===""&&Object.keys(this.markers).length>0){return this}if(marker!==""){this.currentMarker=marker;if(this.markers[marker]){this.position=this.markers[marker].start;this.volume=this.markers[marker].volume;this.loop=this.markers[marker].loop;this.duration=this.markers[marker].duration;this.durationMS=this.markers[marker].durationMS;if(typeof volume!=="undefined"){this.volume=volume}if(typeof loop!=="undefined"){this.loop=loop}this._tempMarker=marker;this._tempPosition=this.position;this._tempVolume=this.volume;this._tempLoop=this.loop}else{return this}}else{position=position||0;if(typeof volume==="undefined"){volume=this._volume}if(typeof loop==="undefined"){loop=this.loop}this.position=position;this.volume=volume;this.loop=loop;this.duration=0;this.durationMS=0;this._tempMarker=marker;this._tempPosition=position;this._tempVolume=volume;this._tempLoop=loop}if(this.usingWebAudio){if(this.game.cache.isSoundDecoded(this.key)){if(this._buffer===null){this._buffer=this.game.cache.getSoundData(this.key)}this._sound=this.context.createBufferSource();this._sound.buffer=this._buffer;if(this.externalNode){this._sound.connect(this.externalNode)}else{this._sound.connect(this.gainNode)}if(this.loop&&marker===""){this._sound.loop=true}if(!this.loop&&marker===""){this._sound.onended=this.onEndedHandler.bind(this)}this.totalDuration=this._sound.buffer.duration;if(this.duration===0){this.duration=this.totalDuration;this.durationMS=Math.ceil(this.totalDuration*1e3)}if(typeof this._sound.start==="undefined"){this._sound.noteGrainOn(0,this.position,this.duration)}else{if(this.loop&&marker===""){this._sound.start(0)}else{this._sound.start(0,this.position,this.duration)}}this.isPlaying=true;this.startTime=this.game.time.time;this.currentTime=0;this.stopTime=this.startTime+this.durationMS;this.onPlay.dispatch(this)}else{this.pendingPlayback=true;if(this.game.cache.getSound(this.key)&&this.game.cache.getSound(this.key).isDecoding===false){this.game.sound.decode(this.key,this)}}}else{if(this.game.cache.getSound(this.key)&&this.game.cache.getSound(this.key).locked){this.game.cache.reloadSound(this.key);this.pendingPlayback=true}else{if(this._sound&&(this.game.device.cocoonJS||this._sound.readyState===4)){this._sound.play();this.totalDuration=this._sound.duration;if(this.duration===0){this.duration=this.totalDuration;this.durationMS=this.totalDuration*1e3}this._sound.currentTime=this.position;this._sound.muted=this._muted;if(this._muted){this._sound.volume=0}else{this._sound.volume=this._volume}this.isPlaying=true;this.startTime=this.game.time.time;this.currentTime=0;this.stopTime=this.startTime+this.durationMS;this.onPlay.dispatch(this)}else{this.pendingPlayback=true}}}return this},restart:function(marker,position,volume,loop){marker=marker||"";position=position||0;volume=volume||1;if(typeof loop==="undefined"){loop=false}this.play(marker,position,volume,loop,true)},pause:function(){if(this.isPlaying&&this._sound){this.paused=true;this.pausedPosition=this.currentTime;this.pausedTime=this.game.time.time;this.onPause.dispatch(this);this.stop()}},resume:function(){if(this.paused&&this._sound){if(this.usingWebAudio){var p=this.position+this.pausedPosition/1e3;this._sound=this.context.createBufferSource();this._sound.buffer=this._buffer;if(this.externalNode){this._sound.connect(this.externalNode)}else{this._sound.connect(this.gainNode)}if(this.loop){this._sound.loop=true}if(!this.loop&&this.currentMarker===""){this._sound.onended=this.onEndedHandler.bind(this)}var duration=this.duration-this.pausedPosition/1e3;if(typeof this._sound.start==="undefined"){this._sound.noteGrainOn(0,p,duration)}else{this._sound.start(0,p,duration)}}else{this._sound.play()}this.isPlaying=true;this.paused=false;this.startTime+=this.game.time.time-this.pausedTime;this.onResume.dispatch(this)}},stop:function(){if(this.isPlaying&&this._sound){if(this.usingWebAudio){if(typeof this._sound.stop==="undefined"){this._sound.noteOff(0)}else{try{this._sound.stop(0)}catch(e){}}}else if(this.usingAudioTag){this._sound.pause();this._sound.currentTime=0}}this.pendingPlayback=false;this.isPlaying=false;var prevMarker=this.currentMarker;if(this.currentMarker!==""){this.onMarkerComplete.dispatch(this.currentMarker,this)}this.currentMarker="";if(this.fadeTween!==null){this.fadeTween.stop()}if(!this.paused){this.onStop.dispatch(this,prevMarker)}},fadeIn:function(duration,loop,marker){if(typeof loop==="undefined"){loop=false}if(typeof marker==="undefined"){marker=this.currentMarker}if(this.paused){return}this.play(marker,0,0,loop);this.fadeTo(duration,1)},fadeOut:function(duration){this.fadeTo(duration,0)},fadeTo:function(duration,volume){if(!this.isPlaying||this.paused||volume===this.volume){return}if(typeof duration==="undefined"){duration=1e3}if(typeof volume==="undefined"){console.warn("Phaser.Sound.fadeTo: No Volume Specified.");return}this.fadeTween=this.game.add.tween(this).to({volume:volume},duration,Phaser.Easing.Linear.None,true);this.fadeTween.onComplete.add(this.fadeComplete,this)},fadeComplete:function(){this.onFadeComplete.dispatch(this,this.volume);if(this.volume===0){this.stop()}},destroy:function(remove){if(typeof remove==="undefined"){remove=true}this.stop();if(remove){this.game.sound.remove(this)}else{this.markers={};this.context=null;this._buffer=null;this.externalNode=null;this.onDecoded.dispose();this.onPlay.dispose();this.onPause.dispose();this.onResume.dispose();this.onLoop.dispose();this.onStop.dispose();this.onMute.dispose();this.onMarkerComplete.dispose()}}};Phaser.Sound.prototype.constructor=Phaser.Sound;Object.defineProperty(Phaser.Sound.prototype,"isDecoding",{get:function(){return this.game.cache.getSound(this.key).isDecoding}});Object.defineProperty(Phaser.Sound.prototype,"isDecoded",{get:function(){return this.game.cache.isSoundDecoded(this.key)}});Object.defineProperty(Phaser.Sound.prototype,"mute",{get:function(){return this._muted||this.game.sound.mute},set:function(value){value=value||null;if(value){this._muted=true;if(this.usingWebAudio){this._muteVolume=this.gainNode.gain.value;this.gainNode.gain.value=0}else if(this.usingAudioTag&&this._sound){this._muteVolume=this._sound.volume;this._sound.volume=0}}else{this._muted=false;if(this.usingWebAudio){this.gainNode.gain.value=this._muteVolume}else if(this.usingAudioTag&&this._sound){this._sound.volume=this._muteVolume}}this.onMute.dispatch(this)}});Object.defineProperty(Phaser.Sound.prototype,"volume",{get:function(){return this._volume},set:function(value){if(this.usingWebAudio){this._volume=value;this.gainNode.gain.value=value}else if(this.usingAudioTag&&this._sound){if(value>=0&&value<=1){this._volume=value;this._sound.volume=value}}}});Phaser.SoundManager=function(game){this.game=game;this.onSoundDecode=new Phaser.Signal;this._codeMuted=false;this._muted=false;this._unlockSource=null;this._volume=1;this._sounds=[];this._watchList=new Phaser.ArraySet;this._watching=false;this._watchCallback=null;this._watchContext=null;this.context=null;this.usingWebAudio=true;this.usingAudioTag=false;this.noAudio=false;this.connectToMaster=true;this.touchLocked=false;this.channels=32};Phaser.SoundManager.prototype={boot:function(){if(this.game.device.iOS&&this.game.device.webAudio===false){this.channels=1}if(!this.game.device.cocoonJS&&this.game.device.iOS||window["PhaserGlobal"]&&window["PhaserGlobal"].fakeiOSTouchLock){this.game.input.touch.callbackContext=this;this.game.input.touch.touchStartCallback=this.unlock;this.game.input.mouse.callbackContext=this;this.game.input.mouse.mouseDownCallback=this.unlock;this.touchLocked=true}else{this.touchLocked=false}if(window["PhaserGlobal"]){if(window["PhaserGlobal"].disableAudio===true){this.usingWebAudio=false;this.noAudio=true;return}if(window["PhaserGlobal"].disableWebAudio===true){this.usingWebAudio=false;this.usingAudioTag=true;this.noAudio=false;return}}if(window["PhaserGlobal"]&&window["PhaserGlobal"].audioContext){this.context=window["PhaserGlobal"].audioContext}else{if(!!window["AudioContext"]){try{this.context=new window["AudioContext"]}catch(error){this.context=null;this.usingWebAudio=false;this.noAudio=true}}else if(!!window["webkitAudioContext"]){try{this.context=new window["webkitAudioContext"]}catch(error){this.context=null;this.usingWebAudio=false;this.noAudio=true}}}if(!!window["Audio"]&&this.context===null){this.usingWebAudio=false;this.usingAudioTag=true;this.noAudio=false}if(this.context!==null){if(typeof this.context.createGain==="undefined"){this.masterGain=this.context.createGainNode()}else{this.masterGain=this.context.createGain()}this.masterGain.gain.value=1;this.masterGain.connect(this.context.destination)}},unlock:function(){if(this.touchLocked===false){return}if(this.game.device.webAudio===false||window["PhaserGlobal"]&&window["PhaserGlobal"].disableWebAudio===true){this.touchLocked=false;this._unlockSource=null;this.game.input.touch.callbackContext=null;this.game.input.touch.touchStartCallback=null;this.game.input.mouse.callbackContext=null;this.game.input.mouse.mouseDownCallback=null}else{var buffer=this.context.createBuffer(1,1,22050);this._unlockSource=this.context.createBufferSource();this._unlockSource.buffer=buffer;this._unlockSource.connect(this.context.destination);if(typeof this._unlockSource.start==="undefined"){this._unlockSource.noteOn(0)}else{this._unlockSource.start(0)}}},stopAll:function(){for(var i=0;i<this._sounds.length;i++){if(this._sounds[i]){this._sounds[i].stop()}}},pauseAll:function(){for(var i=0;i<this._sounds.length;i++){if(this._sounds[i]){this._sounds[i].pause()}}},resumeAll:function(){for(var i=0;i<this._sounds.length;i++){if(this._sounds[i]){this._sounds[i].resume()}}},decode:function(key,sound){sound=sound||null;var soundData=this.game.cache.getSoundData(key);if(soundData){if(this.game.cache.isSoundDecoded(key)===false){this.game.cache.updateSound(key,"isDecoding",true);var that=this;this.context.decodeAudioData(soundData,function(buffer){if(buffer){that.game.cache.decodedSound(key,buffer);that.onSoundDecode.dispatch(key,sound)}})}}},setDecodedCallback:function(files,callback,callbackContext){if(typeof files==="string"){files=[files]}this._watchList.reset();for(var i=0;i<files.length;i++){if(files[i]instanceof Phaser.Sound){if(!this.game.cache.isSoundDecoded(files[i].key)){this._watchList.add(files[i].key)}}else if(!this.game.cache.isSoundDecoded(files[i])){this._watchList.add(files[i])}}if(this._watchList.total===0){this._watching=false;callback.call(callbackContext)}else{this._watching=true;this._watchCallback=callback;this._watchContext=callbackContext}},update:function(){if(this.touchLocked){if(this.game.device.webAudio&&this._unlockSource!==null){if(this._unlockSource.playbackState===this._unlockSource.PLAYING_STATE||this._unlockSource.playbackState===this._unlockSource.FINISHED_STATE){this.touchLocked=false;this._unlockSource=null;this.game.input.touch.callbackContext=null;this.game.input.touch.touchStartCallback=null}}}for(var i=0;i<this._sounds.length;i++){this._sounds[i].update()}if(this._watching){var key=this._watchList.first;while(key){if(this.game.cache.isSoundDecoded(key)){this._watchList.remove(key)}key=this._watchList.next}if(this._watchList.total===0){this._watching=false;this._watchCallback.call(this._watchContext)}}},add:function(key,volume,loop,connect){if(typeof volume==="undefined"){volume=1}if(typeof loop==="undefined"){loop=false}if(typeof connect==="undefined"){connect=this.connectToMaster}var sound=new Phaser.Sound(this.game,key,volume,loop,connect);this._sounds.push(sound);return sound},addSprite:function(key){var audioSprite=new Phaser.AudioSprite(this.game,key);return audioSprite},remove:function(sound){var i=this._sounds.length;while(i--){if(this._sounds[i]===sound){this._sounds[i].destroy(false);this._sounds.splice(i,1);return true}}return false},removeByKey:function(key){var i=this._sounds.length;var removed=0;while(i--){if(this._sounds[i].key===key){this._sounds[i].destroy(false);this._sounds.splice(i,1);removed++}}return removed},play:function(key,volume,loop){var sound=this.add(key,volume,loop);sound.play();return sound},setMute:function(){if(this._muted){return}this._muted=true;if(this.usingWebAudio){this._muteVolume=this.masterGain.gain.value;this.masterGain.gain.value=0}for(var i=0;i<this._sounds.length;i++){if(this._sounds[i].usingAudioTag){this._sounds[i].mute=true}}},unsetMute:function(){if(!this._muted||this._codeMuted){return}this._muted=false;if(this.usingWebAudio){this.masterGain.gain.value=this._muteVolume}for(var i=0;i<this._sounds.length;i++){if(this._sounds[i].usingAudioTag){this._sounds[i].mute=false}}},destroy:function(){this.stopAll();for(var i=0;i<this._sounds.length;i++){if(this._sounds[i]){this._sounds[i].destroy()}}this._sounds=[];this.onSoundDecode.dispose();if(this.context&&window["PhaserGlobal"]){window["PhaserGlobal"].audioContext=this.context}}};Phaser.SoundManager.prototype.constructor=Phaser.SoundManager;Object.defineProperty(Phaser.SoundManager.prototype,"mute",{get:function(){return this._muted},set:function(value){value=value||null;if(value){if(this._muted){return}this._codeMuted=true;this.setMute()}else{if(!this._muted){return}this._codeMuted=false;this.unsetMute()}}});Object.defineProperty(Phaser.SoundManager.prototype,"volume",{get:function(){if(this.usingWebAudio){return this.masterGain.gain.value}else{return this._volume}},set:function(value){this._volume=value;if(this.usingWebAudio){this.masterGain.gain.value=value}else{for(var i=0;i<this._sounds.length;i++){if(this._sounds[i].usingAudioTag){this._sounds[i].volume=this._sounds[i].volume*value}}}}});Phaser.Utils.Debug=function(game){this.game=game;this.sprite=null;this.bmd=null;this.canvas=null;this.context=null;this.font="14px Courier";this.columnWidth=100;this.lineHeight=16;this.renderShadow=true;this.currentX=0;this.currentY=0;this.currentAlpha=1;this.dirty=false};Phaser.Utils.Debug.prototype={boot:function(){if(this.game.renderType===Phaser.CANVAS){this.context=this.game.context}else{this.bmd=this.game.make.bitmapData(this.game.width,this.game.height);this.sprite=this.game.make.image(0,0,this.bmd);this.game.stage.addChild(this.sprite);this.canvas=Phaser.Canvas.create(this.game.width,this.game.height,"",true);this.context=this.canvas.getContext("2d")}},preUpdate:function(){if(this.dirty&&this.sprite){this.bmd.clear();this.bmd.draw(this.canvas,0,0);this.context.clearRect(0,0,this.game.width,this.game.height);this.dirty=false}},reset:function(){if(this.context){this.context.clearRect(0,0,this.game.width,this.game.height)}if(this.sprite){this.bmd.clear()}},start:function(x,y,color,columnWidth){if(typeof x!=="number"){x=0}if(typeof y!=="number"){y=0}color=color||"rgb(255,255,255)";if(typeof columnWidth==="undefined"){columnWidth=0}this.currentX=x;this.currentY=y;this.currentColor=color;this.currentAlpha=this.context.globalAlpha;this.columnWidth=columnWidth;this.dirty=true;this.context.save();this.context.setTransform(1,0,0,1,0,0);this.context.strokeStyle=color;this.context.fillStyle=color;this.context.font=this.font;this.context.globalAlpha=1},stop:function(){this.context.restore();this.context.globalAlpha=this.currentAlpha},line:function(){var x=this.currentX;for(var i=0;i<arguments.length;i++){if(this.renderShadow){this.context.fillStyle="rgb(0,0,0)";this.context.fillText(arguments[i],x+1,this.currentY+1);this.context.fillStyle=this.currentColor}this.context.fillText(arguments[i],x,this.currentY);x+=this.columnWidth}this.currentY+=this.lineHeight},soundInfo:function(sound,x,y,color){this.start(x,y,color);this.line("Sound: "+sound.key+" Locked: "+sound.game.sound.touchLocked);this.line("Is Ready?: "+this.game.cache.isSoundReady(sound.key)+" Pending Playback: "+sound.pendingPlayback);this.line("Decoded: "+sound.isDecoded+" Decoding: "+sound.isDecoding);this.line("Total Duration: "+sound.totalDuration+" Playing: "+sound.isPlaying);this.line("Time: "+sound.currentTime);this.line("Volume: "+sound.volume+" Muted: "+sound.mute);this.line("WebAudio: "+sound.usingWebAudio+" Audio: "+sound.usingAudioTag);if(sound.currentMarker!==""){this.line("Marker: "+sound.currentMarker+" Duration: "+sound.duration+" (ms: "+sound.durationMS+")");this.line("Start: "+sound.markers[sound.currentMarker].start+" Stop: "+sound.markers[sound.currentMarker].stop);this.line("Position: "+sound.position)}this.stop()},cameraInfo:function(camera,x,y,color){this.start(x,y,color);this.line("Camera ("+camera.width+" x "+camera.height+")");this.line("X: "+camera.x+" Y: "+camera.y);if(camera.bounds){this.line("Bounds x: "+camera.bounds.x+" Y: "+camera.bounds.y+" w: "+camera.bounds.width+" h: "+camera.bounds.height)}this.line("View x: "+camera.view.x+" Y: "+camera.view.y+" w: "+camera.view.width+" h: "+camera.view.height);this.line("Total in view: "+camera.totalInView);this.stop()},timer:function(timer,x,y,color){this.start(x,y,color);this.line("Timer (running: "+timer.running+" expired: "+timer.expired+")");this.line("Next Tick: "+timer.next+" Duration: "+timer.duration);this.line("Paused: "+timer.paused+" Length: "+timer.length);this.stop()},pointer:function(pointer,hideIfUp,downColor,upColor,color){if(pointer==null){return}if(typeof hideIfUp==="undefined"){hideIfUp=false}downColor=downColor||"rgba(0,255,0,0.5)";upColor=upColor||"rgba(255,0,0,0.5)";if(hideIfUp===true&&pointer.isUp===true){return}this.start(pointer.x,pointer.y-100,color);this.context.beginPath();this.context.arc(pointer.x,pointer.y,pointer.circle.radius,0,Math.PI*2);if(pointer.active){this.context.fillStyle=downColor}else{this.context.fillStyle=upColor}this.context.fill();this.context.closePath();this.context.beginPath();this.context.moveTo(pointer.positionDown.x,pointer.positionDown.y);this.context.lineTo(pointer.position.x,pointer.position.y);this.context.lineWidth=2;this.context.stroke();this.context.closePath();this.line("ID: "+pointer.id+" Active: "+pointer.active);this.line("World X: "+pointer.worldX+" World Y: "+pointer.worldY);this.line("Screen X: "+pointer.x+" Screen Y: "+pointer.y);this.line("Duration: "+pointer.duration+" ms");this.line("is Down: "+pointer.isDown+" is Up: "+pointer.isUp);this.stop()},spriteInputInfo:function(sprite,x,y,color){this.start(x,y,color);this.line("Sprite Input: ("+sprite.width+" x "+sprite.height+")");this.line("x: "+sprite.input.pointerX().toFixed(1)+" y: "+sprite.input.pointerY().toFixed(1));this.line("over: "+sprite.input.pointerOver()+" duration: "+sprite.input.overDuration().toFixed(0));this.line("down: "+sprite.input.pointerDown()+" duration: "+sprite.input.downDuration().toFixed(0));this.line("just over: "+sprite.input.justOver()+" just out: "+sprite.input.justOut());this.stop()},key:function(key,x,y,color){this.start(x,y,color,150);this.line("Key:",key.keyCode,"isDown:",key.isDown);this.line("justDown:",key.justDown,"justUp:",key.justUp);this.line("Time Down:",key.timeDown.toFixed(0),"duration:",key.duration.toFixed(0));this.stop()},inputInfo:function(x,y,color){this.start(x,y,color);this.line("Input");this.line("X: "+this.game.input.x+" Y: "+this.game.input.y);this.line("World X: "+this.game.input.worldX+" World Y: "+this.game.input.worldY);this.line("Scale X: "+this.game.input.scale.x.toFixed(1)+" Scale Y: "+this.game.input.scale.x.toFixed(1));this.line("Screen X: "+this.game.input.activePointer.screenX+" Screen Y: "+this.game.input.activePointer.screenY);this.stop()},spriteBounds:function(sprite,color,filled){var bounds=sprite.getBounds();bounds.x+=this.game.camera.x;bounds.y+=this.game.camera.y;this.rectangle(bounds,color,filled)},ropeSegments:function(rope,color,filled){var segments=rope.segments;segments.forEach(function(segment){this.rectangle(segment,color,filled)},this)},spriteInfo:function(sprite,x,y,color){this.start(x,y,color);this.line("Sprite: "+" ("+sprite.width+" x "+sprite.height+") anchor: "+sprite.anchor.x+" x "+sprite.anchor.y);this.line("x: "+sprite.x.toFixed(1)+" y: "+sprite.y.toFixed(1));this.line("angle: "+sprite.angle.toFixed(1)+" rotation: "+sprite.rotation.toFixed(1));this.line("visible: "+sprite.visible+" in camera: "+sprite.inCamera);this.line("bounds x: "+sprite._bounds.x.toFixed(1)+" y: "+sprite._bounds.y.toFixed(1)+" w: "+sprite._bounds.width.toFixed(1)+" h: "+sprite._bounds.height.toFixed(1));this.stop()},spriteCoords:function(sprite,x,y,color){this.start(x,y,color,100);if(sprite.name){this.line(sprite.name)}this.line("x:",sprite.x.toFixed(2),"y:",sprite.y.toFixed(2));this.line("pos x:",sprite.position.x.toFixed(2),"pos y:",sprite.position.y.toFixed(2));this.line("world x:",sprite.world.x.toFixed(2),"world y:",sprite.world.y.toFixed(2));this.stop()},lineInfo:function(line,x,y,color){this.start(x,y,color,80);this.line("start.x:",line.start.x.toFixed(2),"start.y:",line.start.y.toFixed(2));this.line("end.x:",line.end.x.toFixed(2),"end.y:",line.end.y.toFixed(2));this.line("length:",line.length.toFixed(2),"angle:",line.angle);this.stop()},pixel:function(x,y,color,size){size=size||2;this.start();this.context.fillStyle=color;this.context.fillRect(x,y,size,size);this.stop()},geom:function(object,color,filled,forceType){if(typeof filled==="undefined"){filled=true}if(typeof forceType==="undefined"){forceType=0}color=color||"rgba(0,255,0,0.4)";this.start();this.context.fillStyle=color;this.context.strokeStyle=color;if(object instanceof Phaser.Rectangle||forceType===1){if(filled){this.context.fillRect(object.x-this.game.camera.x,object.y-this.game.camera.y,object.width,object.height)}else{this.context.strokeRect(object.x-this.game.camera.x,object.y-this.game.camera.y,object.width,object.height)}}else if(object instanceof Phaser.Circle||forceType===2){this.context.beginPath();this.context.arc(object.x-this.game.camera.x,object.y-this.game.camera.y,object.radius,0,Math.PI*2,false);this.context.closePath();if(filled){this.context.fill()}else{this.context.stroke()}}else if(object instanceof Phaser.Point||forceType===3){this.context.fillRect(object.x-this.game.camera.x,object.y-this.game.camera.y,4,4)}else if(object instanceof Phaser.Line||forceType===4){this.context.lineWidth=1;this.context.beginPath();this.context.moveTo(object.start.x+.5-this.game.camera.x,object.start.y+.5-this.game.camera.y);this.context.lineTo(object.end.x+.5-this.game.camera.x,object.end.y+.5-this.game.camera.y);this.context.closePath();this.context.stroke()}this.stop()},rectangle:function(object,color,filled){if(typeof filled==="undefined"){filled=true}color=color||"rgba(0, 255, 0, 0.4)";this.start();if(filled){this.context.fillStyle=color;this.context.fillRect(object.x-this.game.camera.x,object.y-this.game.camera.y,object.width,object.height)}else{this.context.strokeStyle=color;this.context.strokeRect(object.x-this.game.camera.x,object.y-this.game.camera.y,object.width,object.height)}this.stop()},text:function(text,x,y,color,font){color=color||"rgb(255,255,255)";font=font||"16px Courier";this.start();this.context.font=font;if(this.renderShadow){this.context.fillStyle="rgb(0,0,0)";this.context.fillText(text,x+1,y+1)}this.context.fillStyle=color;this.context.fillText(text,x,y);this.stop()},quadTree:function(quadtree,color){color=color||"rgba(255,0,0,0.3)";this.start();var bounds=quadtree.bounds;if(quadtree.nodes.length===0){this.context.strokeStyle=color;this.context.strokeRect(bounds.x,bounds.y,bounds.width,bounds.height);this.text("size: "+quadtree.objects.length,bounds.x+4,bounds.y+16,"rgb(0,200,0)","12px Courier");this.context.strokeStyle="rgb(0,255,0)";for(var i=0;i<quadtree.objects.length;i++){this.context.strokeRect(quadtree.objects[i].x,quadtree.objects[i].y,quadtree.objects[i].width,quadtree.objects[i].height)}}else{for(var i=0;i<quadtree.nodes.length;i++){this.quadTree(quadtree.nodes[i])}}this.stop()},body:function(sprite,color,filled){if(sprite.body){this.start();if(sprite.body.type===Phaser.Physics.ARCADE){Phaser.Physics.Arcade.Body.render(this.context,sprite.body,color,filled)}else if(sprite.body.type===Phaser.Physics.NINJA){Phaser.Physics.Ninja.Body.render(this.context,sprite.body,color,filled)}else if(sprite.body.type===Phaser.Physics.BOX2D){Phaser.Physics.Box2D.renderBody(this.context,sprite.body,color)}this.stop()}},bodyInfo:function(sprite,x,y,color){if(sprite.body){this.start(x,y,color,210);if(sprite.body.type===Phaser.Physics.ARCADE){Phaser.Physics.Arcade.Body.renderBodyInfo(this,sprite.body)}else if(sprite.body.type===Phaser.Physics.BOX2D){this.game.physics.box2d.renderBodyInfo(this,sprite.body)}this.stop()}},box2dWorld:function(){this.start();this.context.translate(-this.game.camera.view.x,-this.game.camera.view.y,0);this.game.physics.box2d.renderDebugDraw(this.context);this.stop()},box2dBody:function(body,color){this.start();Phaser.Physics.Box2D.renderBody(this.context,body,color);this.stop()}};Phaser.Utils.Debug.prototype.constructor=Phaser.Utils.Debug;Phaser.ArraySet=function(list){this.position=0;this.list=list||[]};Phaser.ArraySet.prototype={add:function(item){if(!this.exists(item)){this.list.push(item)}return item},getIndex:function(item){return this.list.indexOf(item)},getByKey:function(property,value){var i=this.list.length;while(i--){if(this.list[i][property]===value){return this.list[i]}}return null},exists:function(item){return this.list.indexOf(item)>-1},reset:function(){this.list.length=0},remove:function(item){var idx=this.list.indexOf(item);if(idx>-1){this.list.splice(idx,1);return item}},setAll:function(key,value){var i=this.list.length;while(i--){if(this.list[i]){this.list[i][key]=value}}},callAll:function(key){var args=Array.prototype.splice.call(arguments,1);var i=this.list.length;while(i--){if(this.list[i]&&this.list[i][key]){this.list[i][key].apply(this.list[i],args)}}},removeAll:function(destroy){if(typeof destroy==="undefined"){destroy=false}var i=this.list.length;while(i--){if(this.list[i]){var item=this.remove(this.list[i]);if(destroy){item.destroy()}}}this.position=0;this.list=[]}};Object.defineProperty(Phaser.ArraySet.prototype,"total",{get:function(){return this.list.length}});Object.defineProperty(Phaser.ArraySet.prototype,"first",{get:function(){this.position=0;if(this.list.length>0){return this.list[0]}else{return null}}});Object.defineProperty(Phaser.ArraySet.prototype,"next",{get:function(){if(this.position<this.list.length){this.position++;return this.list[this.position]}else{return null}}});Phaser.ArraySet.prototype.constructor=Phaser.ArraySet;Phaser.ArrayList=Phaser.ArraySet;Phaser.ArrayUtils={getRandomItem:function(objects,startIndex,length){if(objects==null){return null}if(typeof startIndex==="undefined"){startIndex=0
}if(typeof length==="undefined"){length=objects.length}var randomIndex=startIndex+Math.floor(Math.random()*length);return objects[randomIndex]===undefined?null:objects[randomIndex]},removeRandomItem:function(objects,startIndex,length){if(objects==null){return null}if(typeof startIndex==="undefined"){startIndex=0}if(typeof length==="undefined"){length=objects.length}var randomIndex=startIndex+Math.floor(Math.random()*length);if(randomIndex<objects.length){var removed=objects.splice(randomIndex,1);return removed[0]===undefined?null:removed[0]}else{return null}},shuffle:function(array){for(var i=array.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var temp=array[i];array[i]=array[j];array[j]=temp}return array},transposeMatrix:function(array){var sourceRowCount=array.length;var sourceColCount=array[0].length;var result=new Array(sourceColCount);for(var i=0;i<sourceColCount;i++){result[i]=new Array(sourceRowCount);for(var j=sourceRowCount-1;j>-1;j--){result[i][j]=array[j][i]}}return result},rotateMatrix:function(matrix,direction){if(typeof direction!=="string"){direction=(direction%360+360)%360}if(direction===90||direction===-270||direction==="rotateLeft"){matrix=Phaser.ArrayUtils.transposeMatrix(matrix);matrix=matrix.reverse()}else if(direction===-90||direction===270||direction==="rotateRight"){matrix=matrix.reverse();matrix=Phaser.ArrayUtils.transposeMatrix(matrix)}else if(Math.abs(direction)===180||direction==="rotate180"){for(var i=0;i<matrix.length;i++){matrix[i].reverse()}matrix=matrix.reverse()}return matrix},findClosest:function(value,arr){if(!arr.length){return NaN}else if(arr.length===1||value<arr[0]){return arr[0]}var i=1;while(arr[i]<value){i++}var low=arr[i-1];var high=i<arr.length?arr[i]:Number.POSITIVE_INFINITY;return high-value<=value-low?high:low},rotate:function(array){var s=array.shift();array.push(s);return s},numberArray:function(start,end){var result=[];for(var i=start;i<=end;i++){result.push(i)}return result},numberArrayStep:function(start,end,step){start=+start||0;var type=typeof end;if((type==="number"||type==="string")&&step&&step[end]===start){end=step=null}step=step==null?1:+step||0;if(end===null){end=start;start=0}else{end=+end||0}var index=-1;var length=Math.max(Phaser.Math.roundAwayFromZero((end-start)/(step||1)),0);var result=new Array(length);while(++index<length){result[index]=start;start+=step}return result}};Phaser.Color={packPixel:function(r,g,b,a){if(Phaser.Device.LITTLE_ENDIAN){return(a<<24|b<<16|g<<8|r)>>>0}else{return(r<<24|g<<16|b<<8|a)>>>0}},unpackPixel:function(rgba,out,hsl,hsv){if(typeof out==="undefined"||out===null){out=Phaser.Color.createColor()}if(typeof hsl==="undefined"||hsl===null){hsl=false}if(typeof hsv==="undefined"||hsv===null){hsv=false}if(Phaser.Device.LITTLE_ENDIAN){out.a=(rgba&4278190080)>>>24;out.b=(rgba&16711680)>>>16;out.g=(rgba&65280)>>>8;out.r=rgba&255}else{out.r=(rgba&4278190080)>>>24;out.g=(rgba&16711680)>>>16;out.b=(rgba&65280)>>>8;out.a=rgba&255}out.color=rgba;out.rgba="rgba("+out.r+","+out.g+","+out.b+","+out.a/255+")";if(hsl){Phaser.Color.RGBtoHSL(out.r,out.g,out.b,out)}if(hsv){Phaser.Color.RGBtoHSV(out.r,out.g,out.b,out)}return out},fromRGBA:function(rgba,out){if(!out){out=Phaser.Color.createColor()}out.r=(rgba&4278190080)>>>24;out.g=(rgba&16711680)>>>16;out.b=(rgba&65280)>>>8;out.a=rgba&255;out.rgba="rgba("+out.r+","+out.g+","+out.b+","+out.a+")";return out},toRGBA:function(r,g,b,a){return r<<24|g<<16|b<<8|a},RGBtoHSL:function(r,g,b,out){if(!out){out=Phaser.Color.createColor(r,g,b,1)}r/=255;g/=255;b/=255;var min=Math.min(r,g,b);var max=Math.max(r,g,b);out.h=0;out.s=0;out.l=(max+min)/2;if(max!==min){var d=max-min;out.s=out.l>.5?d/(2-max-min):d/(max+min);if(max===r){out.h=(g-b)/d+(g<b?6:0)}else if(max===g){out.h=(b-r)/d+2}else if(max===b){out.h=(r-g)/d+4}out.h/=6}return out},HSLtoRGB:function(h,s,l,out){if(!out){out=Phaser.Color.createColor(l,l,l)}else{out.r=l;out.g=l;out.b=l}if(s!==0){var q=l<.5?l*(1+s):l+s-l*s;var p=2*l-q;out.r=Phaser.Color.hueToColor(p,q,h+1/3);out.g=Phaser.Color.hueToColor(p,q,h);out.b=Phaser.Color.hueToColor(p,q,h-1/3)}out.r=Math.floor(out.r*255|0);out.g=Math.floor(out.g*255|0);out.b=Math.floor(out.b*255|0);Phaser.Color.updateColor(out);return out},RGBtoHSV:function(r,g,b,out){if(!out){out=Phaser.Color.createColor(r,g,b,255)}r/=255;g/=255;b/=255;var min=Math.min(r,g,b);var max=Math.max(r,g,b);var d=max-min;out.h=0;out.s=max===0?0:d/max;out.v=max;if(max!==min){if(max===r){out.h=(g-b)/d+(g<b?6:0)}else if(max===g){out.h=(b-r)/d+2}else if(max===b){out.h=(r-g)/d+4}out.h/=6}return out},HSVtoRGB:function(h,s,v,out){if(typeof out==="undefined"){out=Phaser.Color.createColor(0,0,0,1,h,s,0,v)}var r,g,b;var i=Math.floor(h*6);var f=h*6-i;var p=v*(1-s);var q=v*(1-f*s);var t=v*(1-(1-f)*s);switch(i%6){case 0:r=v;g=t;b=p;break;case 1:r=q;g=v;b=p;break;case 2:r=p;g=v;b=t;break;case 3:r=p;g=q;b=v;break;case 4:r=t;g=p;b=v;break;case 5:r=v;g=p;b=q;break}out.r=Math.floor(r*255);out.g=Math.floor(g*255);out.b=Math.floor(b*255);Phaser.Color.updateColor(out);return out},hueToColor:function(p,q,t){if(t<0){t+=1}if(t>1){t-=1}if(t<1/6){return p+(q-p)*6*t}if(t<1/2){return q}if(t<2/3){return p+(q-p)*(2/3-t)*6}return p},createColor:function(r,g,b,a,h,s,l,v){var out={r:r||0,g:g||0,b:b||0,a:a||1,h:h||0,s:s||0,l:l||0,v:v||0,color:0,color32:0,rgba:""};out.color=Phaser.Color.getColor(out.r,out.g,out.b);out.color32=Phaser.Color.getColor32(out.a,out.r,out.g,out.b);return Phaser.Color.updateColor(out)},updateColor:function(out){out.rgba="rgba("+out.r.toString()+","+out.g.toString()+","+out.b.toString()+","+out.a.toString()+")";return out},getColor32:function(a,r,g,b){return a<<24|r<<16|g<<8|b},getColor:function(r,g,b){return r<<16|g<<8|b},RGBtoString:function(r,g,b,a,prefix){if(typeof a==="undefined"){a=255}if(typeof prefix==="undefined"){prefix="#"}if(prefix==="#"){return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}else{return"0x"+Phaser.Color.componentToHex(a)+Phaser.Color.componentToHex(r)+Phaser.Color.componentToHex(g)+Phaser.Color.componentToHex(b)}},hexToRGB:function(hex){var rgb=Phaser.Color.hexToColor(hex);if(rgb){return Phaser.Color.getColor32(rgb.a,rgb.r,rgb.g,rgb.b)}},hexToColor:function(hex,out){hex=hex.replace(/^(?:#|0x)?([a-f\d])([a-f\d])([a-f\d])$/i,function(m,r,g,b){return r+r+g+g+b+b});var result=/^(?:#|0x)?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(result){var r=parseInt(result[1],16);var g=parseInt(result[2],16);var b=parseInt(result[3],16);if(!out){out=Phaser.Color.createColor(r,g,b)}else{out.r=r;out.g=g;out.b=b}}return out},webToColor:function(web,out){if(!out){out=Phaser.Color.createColor()}var result=/^rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d+(?:\.\d+)?))?\s*\)$/.exec(web);if(result){out.r=parseInt(result[1],10);out.g=parseInt(result[2],10);out.b=parseInt(result[3],10);out.a=result[4]!==undefined?parseFloat(result[4]):1}return out},valueToColor:function(value,out){if(!out){out=Phaser.Color.createColor()}if(typeof value==="string"){if(value.indexOf("rgb")===0){return Phaser.Color.webToColor(value,out)}else{out.a=1;return Phaser.Color.hexToColor(value,out)}}else if(typeof value==="number"){var tempColor=Phaser.Color.getRGB(value);out.r=tempColor.r;out.g=tempColor.g;out.b=tempColor.b;out.a=tempColor.a/255;return out}else{return out}},componentToHex:function(color){var hex=color.toString(16);return hex.length==1?"0"+hex:hex},HSVColorWheel:function(s,v){if(typeof s==="undefined"){s=1}if(typeof v==="undefined"){v=1}var colors=[];for(var c=0;c<=359;c++){colors.push(Phaser.Color.HSVtoRGB(c/359,s,v))}return colors},HSLColorWheel:function(s,l){if(typeof s==="undefined"){s=.5}if(typeof l==="undefined"){l=.5}var colors=[];for(var c=0;c<=359;c++){colors.push(Phaser.Color.HSLtoRGB(c/359,s,l))}return colors},interpolateColor:function(color1,color2,steps,currentStep,alpha){if(typeof alpha==="undefined"){alpha=255}var src1=Phaser.Color.getRGB(color1);var src2=Phaser.Color.getRGB(color2);var r=(src2.red-src1.red)*currentStep/steps+src1.red;var g=(src2.green-src1.green)*currentStep/steps+src1.green;var b=(src2.blue-src1.blue)*currentStep/steps+src1.blue;return Phaser.Color.getColor32(alpha,r,g,b)},interpolateColorWithRGB:function(color,r,g,b,steps,currentStep){var src=Phaser.Color.getRGB(color);var or=(r-src.red)*currentStep/steps+src.red;var og=(g-src.green)*currentStep/steps+src.green;var ob=(b-src.blue)*currentStep/steps+src.blue;return Phaser.Color.getColor(or,og,ob)},interpolateRGB:function(r1,g1,b1,r2,g2,b2,steps,currentStep){var r=(r2-r1)*currentStep/steps+r1;var g=(g2-g1)*currentStep/steps+g1;var b=(b2-b1)*currentStep/steps+b1;return Phaser.Color.getColor(r,g,b)},getRandomColor:function(min,max,alpha){if(typeof min==="undefined"){min=0}if(typeof max==="undefined"){max=255}if(typeof alpha==="undefined"){alpha=255}if(max>255||min>max){return Phaser.Color.getColor(255,255,255)}var red=min+Math.round(Math.random()*(max-min));var green=min+Math.round(Math.random()*(max-min));var blue=min+Math.round(Math.random()*(max-min));return Phaser.Color.getColor32(alpha,red,green,blue)},getRGB:function(color){if(color>16777215){return{alpha:color>>>24,red:color>>16&255,green:color>>8&255,blue:color&255,a:color>>>24,r:color>>16&255,g:color>>8&255,b:color&255}}else{return{alpha:255,red:color>>16&255,green:color>>8&255,blue:color&255,a:255,r:color>>16&255,g:color>>8&255,b:color&255}}},getWebRGB:function(color){if(typeof color==="object"){return"rgba("+color.r.toString()+","+color.g.toString()+","+color.b.toString()+","+(color.a/255).toString()+")"}else{var rgb=Phaser.Color.getRGB(color);return"rgba("+rgb.r.toString()+","+rgb.g.toString()+","+rgb.b.toString()+","+(rgb.a/255).toString()+")"}},getAlpha:function(color){return color>>>24},getAlphaFloat:function(color){return(color>>>24)/255},getRed:function(color){return color>>16&255},getGreen:function(color){return color>>8&255},getBlue:function(color){return color&255}};Phaser.LinkedList=function(){this.next=null;this.prev=null;this.first=null;this.last=null;this.total=0};Phaser.LinkedList.prototype={add:function(item){if(this.total===0&&this.first===null&&this.last===null){this.first=item;this.last=item;this.next=item;item.prev=this;this.total++;return item}this.last.next=item;item.prev=this.last;this.last=item;this.total++;return item},reset:function(){this.first=null;this.last=null;this.next=null;this.prev=null;this.total=0},remove:function(item){if(this.total===1){this.reset();item.next=item.prev=null;return}if(item===this.first){this.first=this.first.next}else if(item===this.last){this.last=this.last.prev}if(item.prev){item.prev.next=item.next}if(item.next){item.next.prev=item.prev}item.next=item.prev=null;if(this.first===null){this.last=null}this.total--},callAll:function(callback){if(!this.first||!this.last){return}var entity=this.first;do{if(entity&&entity[callback]){entity[callback].call(entity)}entity=entity.next}while(entity!=this.last.next)}};Phaser.LinkedList.prototype.constructor=Phaser.LinkedList;Phaser.Physics=function(game,config){config=config||{};this.game=game;this.config=config;this.arcade=null;this.p2=null;this.ninja=null;this.box2d=null;this.chipmunk=null;this.parseConfig()};Phaser.Physics.ARCADE=0;Phaser.Physics.P2JS=1;Phaser.Physics.NINJA=2;Phaser.Physics.BOX2D=3;Phaser.Physics.CHIPMUNK=4;Phaser.Physics.prototype={parseConfig:function(){if((!this.config.hasOwnProperty("arcade")||this.config["arcade"]===true)&&Phaser.Physics.hasOwnProperty("Arcade")){this.arcade=new Phaser.Physics.Arcade(this.game);this.game.time.deltaCap=.2}if(this.config.hasOwnProperty("ninja")&&this.config["ninja"]===true&&Phaser.Physics.hasOwnProperty("Ninja")){this.ninja=new Phaser.Physics.Ninja(this.game)}if(this.config.hasOwnProperty("p2")&&this.config["p2"]===true&&Phaser.Physics.hasOwnProperty("P2")){this.p2=new Phaser.Physics.P2(this.game,this.config)}if(this.config.hasOwnProperty("box2d")&&this.config["box2d"]===true&&Phaser.Physics.hasOwnProperty("BOX2D")){this.box2d=new Phaser.Physics.BOX2D(this.game,this.config)}},startSystem:function(system){if(system===Phaser.Physics.ARCADE){this.arcade=new Phaser.Physics.Arcade(this.game)}else if(system===Phaser.Physics.P2JS){if(this.p2===null){this.p2=new Phaser.Physics.P2(this.game,this.config)}else{this.p2.reset()}}else if(system===Phaser.Physics.NINJA){this.ninja=new Phaser.Physics.Ninja(this.game)}else if(system===Phaser.Physics.BOX2D){if(this.box2d===null){this.box2d=new Phaser.Physics.Box2D(this.game,this.config)}else{this.box2d.reset()}}},enable:function(object,system,debug){if(typeof system==="undefined"){system=Phaser.Physics.ARCADE}if(typeof debug==="undefined"){debug=false}if(system===Phaser.Physics.ARCADE){this.arcade.enable(object)}else if(system===Phaser.Physics.P2JS&&this.p2){this.p2.enable(object,debug)}else if(system===Phaser.Physics.NINJA&&this.ninja){this.ninja.enableAABB(object)}else if(system===Phaser.Physics.BOX2D&&this.box2d){this.box2d.enable(object)}},preUpdate:function(){if(this.p2){this.p2.preUpdate()}if(this.box2d){this.box2d.preUpdate()}},update:function(){if(this.p2){this.p2.update()}if(this.box2d){this.box2d.update()}},setBoundsToWorld:function(){if(this.arcade){this.arcade.setBoundsToWorld()}if(this.ninja){this.ninja.setBoundsToWorld()}if(this.p2){this.p2.setBoundsToWorld()}if(this.box2d){this.box2d.setBoundsToWorld()}},clear:function(){if(this.p2){this.p2.clear()}if(this.box2d){this.box2d.clear()}},reset:function(){if(this.p2){this.p2.reset()}if(this.box2d){this.box2d.reset()}},destroy:function(){if(this.p2){this.p2.destroy()}if(this.box2d){this.box2d.destroy()}this.arcade=null;this.ninja=null;this.p2=null;this.box2d=null}};Phaser.Physics.prototype.constructor=Phaser.Physics;Phaser.Particles=function(game){this.game=game;this.emitters={};this.ID=0};Phaser.Particles.prototype={add:function(emitter){this.emitters[emitter.name]=emitter;return emitter},remove:function(emitter){delete this.emitters[emitter.name]},update:function(){for(var key in this.emitters){if(this.emitters[key].exists){this.emitters[key].update()}}}};Phaser.Particles.prototype.constructor=Phaser.Particles;if(PIXI.blendModes===undefined){PIXI.blendModes=Phaser.blendModes}if(PIXI.scaleModes===undefined){PIXI.scaleModes=Phaser.scaleModes}if(PIXI.Texture.emptyTexture===undefined){PIXI.Texture.emptyTexture=new PIXI.Texture(new PIXI.BaseTexture)}if(PIXI.DisplayObject._tempMatrix===undefined){PIXI.DisplayObject._tempMatrix=new PIXI.Matrix}if(PIXI.RenderTexture.tempMatrix===undefined){PIXI.RenderTexture.tempMatrix=new PIXI.Matrix}if(PIXI.Graphics.POLY===undefined){PIXI.Graphics.POLY=Phaser.POLYGON;PIXI.Graphics.RECT=Phaser.RECTANGLE;PIXI.Graphics.CIRC=Phaser.CIRCLE;PIXI.Graphics.ELIP=Phaser.ELLIPSE;PIXI.Graphics.RREC=Phaser.ROUNDEDRECTANGLE}if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=Phaser}exports.Phaser=Phaser}else if(typeof define!=="undefined"&&define.amd){define("Phaser",function(){return root.Phaser=Phaser}())}else{root.Phaser=Phaser}}).call(this);(function(){"use strict";var GameController,TouchableArea,TouchableButton,TouchableCircle,TouchableDirection,TouchableJoystick,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};GameController=function(){var extend;extend=function(target,src){var clone,copy,copyIsArray,deep,name,options;deep=true;if(typeof target==="boolean"){deep=target}if(typeof target!=="object"&&typeof target!=="function"){target={}}if(options=src){for(name in options){src=target[name];copy=options[name];if(target!==copy){if(deep&&(typeof copy==="object"||(copyIsArray=Object.prototype.toString.call(copy)==="[object Array]"))){if(copyIsArray){copyIsArray=false;clone=src&&Object.prototype.toString.call(src)==="[object Array]"?src:[]}else{clone=src&&typeof src==="object"?src:{}}target[name]=extend(clone,copy)}else{if(typeof copy!=="undefined"){target[name]=copy}}}}}return target};return GameController={options:{left:{type:"dpad",position:{left:"13%",bottom:"22%"},dpad:{up:{width:"7%",height:"15%",stroke:2,touchStart:function(){GameController.simulateKeyEvent("press",38);GameController.simulateKeyEvent("down",38)},touchEnd:function(){GameController.simulateKeyEvent("up",38)}},left:{width:"15%",height:"7%",stroke:2,touchStart:function(){GameController.simulateKeyEvent("press",37);GameController.simulateKeyEvent("down",37)},touchEnd:function(){GameController.simulateKeyEvent("up",37)}},down:{width:"7%",height:"15%",stroke:2,touchStart:function(){GameController.simulateKeyEvent("press",40);GameController.simulateKeyEvent("down",40)},touchEnd:function(){GameController.simulateKeyEvent("up",40)}},right:{width:"15%",height:"7%",stroke:2,touchStart:function(){GameController.simulateKeyEvent("press",39);GameController.simulateKeyEvent("down",39)},touchEnd:function(){GameController.simulateKeyEvent("up",39)}}},joystick:{radius:60,touchMove:function(e){console.log(e)}}},right:{type:"buttons",position:{right:"17%",bottom:"28%"},buttons:[{offset:{x:"-13%",y:0},label:"X",radius:"7%",stroke:2,backgroundColor:"blue",fontColor:"#fff",touchStart:function(){GameController.simulateKeyEvent("press",88);GameController.simulateKeyEvent("down",88)},touchEnd:function(){GameController.simulateKeyEvent("up",88)}},{offset:{x:0,y:"-11%"},label:"Y",radius:"7%",stroke:2,backgroundColor:"yellow",fontColor:"#fff",touchStart:function(){GameController.simulateKeyEvent("press",70);GameController.simulateKeyEvent("down",70)},touchEnd:function(){GameController.simulateKeyEvent("up",70)}},{offset:{x:"13%",y:0},label:"B",radius:"7%",stroke:2,backgroundColor:"red",fontColor:"#fff",touchStart:function(){GameController.simulateKeyEvent("press",90);GameController.simulateKeyEvent("down",90)},touchEnd:function(){GameController.simulateKeyEvent("up",90)}},{offset:{x:0,y:"11%"},label:"A",radius:"7%",stroke:2,backgroundColor:"green",fontColor:"#fff",touchStart:function(){GameController.simulateKeyEvent("press",67);GameController.simulateKeyEvent("down",67)},touchEnd:function(){GameController.simulateKeyEvent("up",67)}}],dpad:{up:{width:"7%",height:"15%",stroke:2},left:{width:"15%",height:"7%",stroke:2},down:{width:"7%",height:"15%",stroke:2},right:{width:"15%",height:"7%",stroke:2}},joystick:{radius:60,touchMove:function(e){console.log(e)}}},touchRadius:45},touchableAreas:[],touchableAreasCount:0,touches:[],offsetX:0,offsetY:0,bound:{left:false,right:false,top:false,bottom:false},cachedSprites:{},paused:false,game:null,init:function(game,options){var userAgent;if(options==null){options={}}if(!("ontouchstart"in document.documentElement)){return}this.game=game;extend(this.options,options);userAgent=navigator.userAgent.toLowerCase();this.performanceFriendly=userAgent.indexOf("iphone")!==-1||userAgent.indexOf("android")!==-1||this.options.forcePerformanceFriendly;this.createOverlayCanvas()},boundingSet:function(options){var bottom,height,left,radius,right,top,width;if(options.width){width=this.getPixels(options.width);height=this.getPixels(options.height);left=this.getPixels(options.x);top=this.getPixels(options.y)}else{if(this.options.touchRadius){radius=this.getPixels(options.radius)*2+this.getPixels(this.options.touchRadius)/2}else{radius=options.radius}width=height=(radius+this.getPixels(options.stroke))*2;left=this.getPixels(options.x)-width/2;top=this.getPixels(options.y)-height/2}right=left+width;bottom=top+height;if(this.bound.left===false||left<this.bound.left){this.bound.left=left}if(this.bound.right===false||right>this.bound.right){this.bound.right=right}if(this.bound.top===false||top<this.bound.top){this.bound.top=top}if(this.bound.bottom===false||bottom>this.bound.bottom){this.bound.bottom=bottom}},createOverlayCanvas:function(){this.setTouchEvents();this.loadSide("left");this.loadSide("right");this.render();if(!this.touches||this.touches.length===0){this.paused=true}},pixelRatio:1,getPixels:function(value,axis){if(typeof value==="undefined"){return 0}else if(typeof value==="number"){return value}else{if(axis==="x"){return parseInt(value)/100*this.game.width}else{return parseInt(value)/100*this.game.height}}},simulateKeyEvent:function(eventName,keyCode){var oEvent;if(typeof window.onkeydown==="undefined"){return false}oEvent=document.createEvent("KeyboardEvent");if(oEvent.initKeyboardEvent!=null){oEvent.initKeyboardEvent("key"+eventName,true,true,document.defaultView,false,false,false,false,keyCode,keyCode)}else{oEvent.initKeyEvent("key"+eventName,true,true,document.defaultView,false,false,false,false,keyCode,keyCode)}oEvent.keyCodeVal=keyCode},setTouchEvents:function(){},addTouchableDirection:function(options){var direction;direction=new TouchableDirection(this,options);direction.id=this.touchableAreas.push(direction);this.touchableAreasCount++;this.boundingSet(options)},addJoystick:function(options){var joystick;joystick=new TouchableJoystick(this,options);joystick.id=this.touchableAreas.push(joystick);this.touchableAreasCount++;this.boundingSet(options)},addButton:function(options){var button;button=new TouchableButton(this,options);button.id=this.touchableAreas.push(button);this.touchableAreasCount++;this.boundingSet(options)},addTouchableArea:function(check,callback){},loadButtons:function(side){var buttons,i,j,posX,posY;buttons=this.options[side].buttons;i=0;j=buttons.length;while(i<j){if(typeof buttons[i]==="undefined"||typeof buttons[i].offset==="undefined"){}else{posX=this.getPositionX(side);posY=this.getPositionY(side);buttons[i].x=posX+this.getPixels(buttons[i].offset.x,"y");buttons[i].y=posY+this.getPixels(buttons[i].offset.y,"y");this.addButton(buttons[i])}i++}},loadDPad:function(side){var center,dpad,options,posX,posY;dpad=this.options[side].dpad||{};posX=this.getPositionX(side);posY=this.getPositionY(side);if(dpad.up&&dpad.left&&dpad.down&&dpad.right||dpad.background){options={x:posX,y:posY,radius:dpad.right.height};center=new TouchableCircle(this,options);this.touchableAreas.push(center);this.touchableAreasCount++}if(dpad.up!==false){dpad.up.x=posX-this.getPixels(dpad.up.width,"y")/2;dpad.up.y=posY-(this.getPixels(dpad.up.height,"y")+this.getPixels(dpad.left.height,"y")/2);dpad.up.direction="up";this.addTouchableDirection(dpad.up)}if(dpad.left!==false){dpad.left.x=posX-(this.getPixels(dpad.left.width,"y")+this.getPixels(dpad.up.width,"y")/2);dpad.left.y=posY-this.getPixels(dpad.left.height,"y")/2;dpad.left.direction="left";this.addTouchableDirection(dpad.left)}if(dpad.down!==false){dpad.down.x=posX-this.getPixels(dpad.down.width,"y")/2;dpad.down.y=posY+this.getPixels(dpad.left.height,"y")/2;dpad.down.direction="down";this.addTouchableDirection(dpad.down)}if(dpad.right!==false){dpad.right.x=posX+this.getPixels(dpad.up.width,"y")/2;dpad.right.y=posY-this.getPixels(dpad.right.height,"y")/2;dpad.right.direction="right";this.addTouchableDirection(dpad.right)}},loadJoystick:function(side){var joystick;joystick=this.options[side].joystick;joystick.x=this.getPositionX(side);joystick.y=this.getPositionY(side);this.addJoystick(joystick)},reloadSide:function(side){this.loadSide(side)},loadSide:function(side){if(this.options[side].type==="dpad"){this.loadDPad(side)}else if(this.options[side].type==="joystick"){this.loadJoystick(side)}else{if(this.options[side].type==="buttons"){this.loadButtons(side)}}},normalizeTouchPositionX:function(x){return(x-this.offsetX)*this.pixelRatio},normalizeTouchPositionY:function(y){return(y-this.offsetY)*this.pixelRatio},getXFromRight:function(right){return this.game.width-right},getYFromBottom:function(bottom){return this.game.height-bottom},getPositionX:function(side){if(typeof this.options[side].position.left!=="undefined"){return this.getPixels(this.options[side].position.left,"x")}else{return this.getXFromRight(this.getPixels(this.options[side].position.right,"x"))}},getPositionY:function(side){if(typeof this.options[side].position.top!=="undefined"){return this.getPixels(this.options[side].position.top,"y")}else{return this.getYFromBottom(this.getPixels(this.options[side].position.bottom,"y"))}},renderAreas:function(){var area,i,j,k,l,touch,touched,x,y;i=0;j=this.touchableAreasCount;while(i<j){area=this.touchableAreas[i];if(typeof area!=="undefined"){area.draw();touched=false;k=0;l=this.touches.length;while(k<l){touch=this.touches[k];if(typeof touch!=="undefined"){x=this.normalizeTouchPositionX(touch.clientX);y=this.normalizeTouchPositionY(touch.clientY);if(area.check(x,y)!==false){if(!touched){touched=this.touches[k]}}k++}}if(touched){if(!area.active){area.touchStartWrapper(touched)}area.touchMoveWrapper(touched)}else{if(area.active){area.touchEndWrapper(touched)}}i++}}},render:function(){if(!this.paused||!this.performanceFriendly){this.renderAreas()}this.ready=true},renderWrapper:function(){GameController.render()}}}();TouchableArea=function(){TouchableArea.prototype.touchStart=null;TouchableArea.prototype.touchMove=null;TouchableArea.prototype.touchEnd=null;TouchableArea.prototype.type="area";TouchableArea.prototype.id=false;TouchableArea.prototype.active=false;function TouchableArea(controller){this.controller=controller}TouchableArea.prototype.setTouchStart=function(callback){this.touchStart=callback};TouchableArea.prototype.touchStartWrapper=function(e){if(this.touchStart){this.touchStart()}if(typeof this.setActive==="function"){this.setActive(true)}this.active=true};TouchableArea.prototype.setTouchMove=function(callback){this.touchMove=callback};TouchableArea.prototype.lastPosX=0;TouchableArea.prototype.lastPosY=0;TouchableArea.prototype.touchMoveWrapper=function(e){if(this.touchMove&&(e.clientX!==TouchableArea.prototype.lastPosX||e.clientY!==TouchableArea.prototype.lastPosY)){this.touchMove();this.lastPosX=e.clientX;this.lastPosY=e.clientY}this.active=true;if(typeof this.setActive==="function"){this.setActive(true)}};TouchableArea.prototype.setTouchEnd=function(callback){this.touchEnd=callback};TouchableArea.prototype.touchEndWrapper=function(e){if(this.touchEnd){this.touchEnd()}this.active=false;if(typeof this.setActive==="function"){this.setActive(false)}this.controller.render()};return TouchableArea}();TouchableButton=function(_super){var uniqueId;__extends(TouchableButton,_super);uniqueId=0;function TouchableButton(controller,options){this.setActive=__bind(this.setActive,this);var property,value;for(property in options){value=options[property];if(property==="x"){this[property]=controller.getPixels(value,"x")}else if(property==="x"||property==="radius"){this[property]=controller.getPixels(value,"y")}else{this[property]=value}}TouchableButton.__super__.constructor.call(this,controller);this.sprite=this.createSprite(controller.game)}TouchableButton.prototype.sprite=null;TouchableButton.prototype.type="button";TouchableButton.prototype.fontFamily="opendyslexic";TouchableButton.prototype.id=-1;TouchableButton.prototype.check=function(touchX,touchY){if(Math.abs(touchX-this.x)<this.radius+this.controller.options.touchRadius/2&&Math.abs(touchY-this.y)<this.radius+this.controller.options.touchRadius/2){return true}return false};TouchableButton.prototype.draw=function(){};TouchableButton.prototype.setActive=function(active){this.sprite.alpha=active?1:.8};TouchableButton.prototype.createSprite=function(game){var bitmap,ctx,gradient,sprite,textShadowColor;bitmap=game.add.bitmapData(2*(this.radius+this.stroke),2*(this.radius+this.stroke));ctx=bitmap.context;ctx.lineWidth=this.stroke;gradient=ctx.createRadialGradient(this.radius,this.radius,1,this.radius,this.radius,this.radius);textShadowColor=void 0;switch(this.backgroundColor||"white"){case"blue":gradient.addColorStop(0,"rgba(123, 181, 197, 0.6)");gradient.addColorStop(1,"#105a78");textShadowColor="#0A4861";break;case"green":gradient.addColorStop(0,"rgba(29, 201, 36, 0.6)");gradient.addColorStop(1,"#107814");textShadowColor="#085C0B";break;case"red":gradient.addColorStop(0,"rgba(165, 34, 34, 0.6)");gradient.addColorStop(1,"#520101");textShadowColor="#330000";break;case"yellow":gradient.addColorStop(0,"rgba(219, 217, 59, 0.6)");gradient.addColorStop(1,"#E8E10E");textShadowColor="#BDB600";break;case"white":gradient.addColorStop(0,"rgba( 255,255,255,.3 )");gradient.addColorStop(1,"#eee")}ctx.fillStyle=gradient;ctx.strokeStyle=textShadowColor;ctx.beginPath();ctx.arc(bitmap.width/2,bitmap.width/2,this.radius,0,2*Math.PI,false);ctx.fill();ctx.stroke();if(this.label){ctx.fillStyle=textShadowColor;ctx.font="bold "+(this.fontSize||bitmap.height*.35)+"px "+this.fontFamily;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.label,bitmap.height/2+2,bitmap.height/2+2);ctx.fillStyle=this.fontColor;ctx.font="bold "+(this.fontSize||bitmap.height*.35)+"px "+this.fontFamily;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.label,bitmap.height/2,bitmap.height/2)}sprite=game.add.sprite(this.x,this.y,bitmap);sprite.alpha=.8;sprite.inputEnabled=true;sprite.events.onInputDown.add(this.touchStartWrapper,this);sprite.events.onInputUp.add(this.touchEndWrapper,this);return sprite};return TouchableButton}(TouchableArea);TouchableCircle=function(_super){__extends(TouchableCircle,_super);function TouchableCircle(controller,options){var property,value;this.controller=controller;for(property in options){value=options[property];if(property==="x"){this[property]=this.controller.getPixels(value,"x")}else if(property==="x"||property==="radius"){this[property]=this.controller.getPixels(value,"y")}else{this[property]=value}}this.sprite=this.createSprite(this.controller.game);TouchableCircle.__super__.constructor.call(this,this.controller)}TouchableCircle.prototype.check=function(touchX,touchY){return false};TouchableCircle.prototype.draw=function(){};TouchableCircle.prototype.createSprite=function(game){var bitmap,ctx,gradient,hw,sprite;this.stroke=this.stroke||2;hw=2*(this.radius+this.controller.options.touchRadius+this.stroke);bitmap=game.add.bitmapData(hw,hw);ctx=bitmap.context;gradient=ctx.createRadialGradient(0,0,1,0,0,this.radius);gradient.addColorStop(0,"rgba( 200,200,200,.2 )");gradient.addColorStop(1,"rgba( 200,200,200,.4 )");ctx.strokeStyle="rgba( 0,0,0,.4 )";ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(this.radius,this.radius,this.radius,0,2*Math.PI,false);ctx.fill();ctx.stroke();sprite=game.add.sprite(this.x-this.radius,this.y-this.radius,bitmap);return sprite};return TouchableCircle}(TouchableArea);TouchableDirection=function(_super){__extends(TouchableDirection,_super);function TouchableDirection(controller,options){var property,value;this.controller=controller;this.setActive=__bind(this.setActive,this);for(property in options){value=options[property];if(property==="x"){this[property]=this.controller.getPixels(value,"x")}else if(property==="y"||property==="height"||property==="width"){this[property]=this.controller.getPixels(value,"y")}else{this[property]=value}}this.sprite=this.createSprite(this.controller.game);TouchableDirection.__super__.constructor.call(this,this.controller)}TouchableDirection.prototype.bitmap=null;TouchableDirection.prototype.type="direction";TouchableDirection.prototype.check=function(touchX,touchY){if((Math.abs(touchX-this.x)<this.controller.options.touchRadius/2||touchX>this.x)&&(Math.abs(touchX-(this.x+this.width))<this.controller.options.touchRadius/2||touchX<this.x+this.width)&&(Math.abs(touchY-this.y)<this.controller.options.touchRadius/2||touchY>this.y)&&(Math.abs(touchY-(this.y+this.height))<this.controller.options.touchRadius/2||touchY<this.y+this.height)){return true}return false};TouchableDirection.prototype.draw=function(){};TouchableDirection.prototype.setActive=function(active){this.sprite.alpha=active?.9:.45};TouchableDirection.prototype.createSprite=function(game){var bitmap,ctx,gradient,sprite;gradient=null;bitmap=this.controller.game.add.bitmapData(this.width*2+this.stroke,this.height*2+this.stroke);ctx=bitmap.context;switch(this.direction||"down"){case"up":gradient=ctx.createLinearGradient(0,0,0,this.height);
gradient.addColorStop(0,"rgba( 0, 0, 0, 0.45)");gradient.addColorStop(1,"rgba( 0, 0, 0, 0.90)");break;case"left":gradient=ctx.createLinearGradient(0,0,this.width,0);gradient.addColorStop(0,"rgba( 0, 0, 0, 0.45)");gradient.addColorStop(1,"rgba( 0, 0, 0, 0.90)");break;case"right":gradient=ctx.createLinearGradient(0,0,this.width,0);gradient.addColorStop(0,"rgba( 0, 0, 0, 0.45)");gradient.addColorStop(1,"rgba( 0, 0, 0, 0.90)");break;case"down":gradient=ctx.createLinearGradient(0,0,0,this.height);gradient.addColorStop(0,"rgba( 0, 0, 0, 0.45)");gradient.addColorStop(1,"rgba( 0, 0, 0, 0.90)")}ctx.fillStyle=gradient;ctx.fillRect(0,0,this.width,this.height);ctx.lineWidth=this.stroke;ctx.strokeStyle="rgba( 255, 255, 255, 0.1 )";ctx.strokeRect(0,0,this.width,this.height);sprite=game.add.sprite(this.x,this.y,bitmap);sprite.alpha=.45;sprite.inputEnabled=true;sprite.events.onInputDown.add(this.touchStartWrapper,this);sprite.events.onInputUp.add(this.touchEndWrapper,this);return sprite};return TouchableDirection}(TouchableArea);TouchableJoystick=function(_super){__extends(TouchableJoystick,_super);function TouchableJoystick(controller,options){var property,value;this.controller=controller;this.setActive=__bind(this.setActive,this);for(property in options){value=options[property];this[property]=value}this.originX=this.currentX=this.currentX||this.x;this.originY=this.currentY=this.currentY||this.y;this.base=this.createBase(this.controller.game);this.sprite=this.createSprite(this.controller.game);TouchableJoystick.__super__.constructor.call(this,this.controller)}TouchableJoystick.prototype.type="joystick";TouchableJoystick.prototype.check=function(touchX,touchY){if(Math.abs(touchX-this.x)<this.radius+this.controller.getPixels(this.controller.options.touchRadius)/2&&Math.abs(touchY-this.y)<this.radius+this.controller.getPixels(this.controller.options.touchRadius)/2){return true}return false};TouchableJoystick.prototype.setActive=function(active){this.sprite.alpha=active?.8:.4};TouchableJoystick.prototype.moveDetails={};TouchableJoystick.prototype.touchMoveWrapper=function(pointer,x,y){if(!this.active){return}this.currentX=this.controller.normalizeTouchPositionX(x);this.currentY=this.controller.normalizeTouchPositionY(y);if(this.touchMove){if(this.moveDetails.dx!==this.currentX-this.x&&this.moveDetails.dy!==this.y-this.currentY){x=this.currentX-this.radius;y=this.currentY-this.radius;this.sprite.x=x;this.sprite.y=y;this.moveDetails.dx=this.currentX-this.x;this.moveDetails.dy=this.y-this.currentY;this.moveDetails.max=this.radius+this.controller.options.touchRadius/2;this.moveDetails.normalizedX=this.moveDetails.dx/this.moveDetails.max;this.moveDetails.normalizedY=this.moveDetails.dy/this.moveDetails.max;this.touchMove(this.moveDetails)}}};TouchableJoystick.prototype.touchEndWrapper=function(e){this.sprite.x=this.originX-this.radius*.7;this.sprite.y=this.originY-this.radius*.7;return TouchableJoystick.__super__.touchEndWrapper.call(this,e)};TouchableJoystick.prototype.draw=function(){};TouchableJoystick.prototype.createSprite=function(game){var bitmap,hw,sprite;this.stroke=this.stroke||2;hw=2*(this.radius+this.controller.options.touchRadius+this.stroke);bitmap=game.add.bitmapData(hw,hw);bitmap.context.fillStyle="#444";bitmap.context.beginPath();bitmap.context.arc(this.radius*.7,this.radius*.7,this.radius*.7,0,2*Math.PI,false);bitmap.context.fill();bitmap.context.stroke();sprite=game.add.sprite(this.currentX-this.radius*.7,this.currentY-this.radius*.7,bitmap);sprite.alpha=.8;sprite.inputEnabled=true;sprite.events.onInputDown.add(this.touchStartWrapper,this);sprite.events.onInputUp.add(this.touchEndWrapper,this);game.input.addMoveCallback(this.touchMoveWrapper,this);return sprite};TouchableJoystick.prototype.createBase=function(game){var bitmap,ctx,gradient,hw,sprite;this.stroke=this.stroke||2;hw=2*(this.radius+this.controller.options.touchRadius+this.stroke);bitmap=game.add.bitmapData(hw,hw);ctx=bitmap.context;gradient=null;ctx.lineWidth=this.stroke;gradient=ctx.createRadialGradient(0,0,1,0,0,this.radius);gradient.addColorStop(0,"rgba( 200,200,200,.2 )");gradient.addColorStop(1,"rgba( 200,200,200,.4 )");ctx.strokeStyle="rgba( 0,0,0,.4 )";ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(this.radius,this.radius,this.radius,0,2*Math.PI,false);ctx.fill();ctx.stroke();sprite=game.add.sprite(this.currentX-this.radius,this.currentY-this.radius,bitmap);sprite.alpha=.4;return sprite};return TouchableJoystick}(TouchableArea);Phaser.Plugin.GameControllerPlugin=function(_super){__extends(GameControllerPlugin,_super);GameControllerPlugin.prototype.options=null;GameControllerPlugin.prototype.joystick=void 0;GameControllerPlugin.prototype.buttons=void 0;GameControllerPlugin.prototype.dpad=void 0;GameControllerPlugin.prototype.left=void 0;GameControllerPlugin.prototype.right=void 0;function GameControllerPlugin(game,parent){this.init=__bind(this.init,this);GameControllerPlugin.__super__.constructor.call(this,game,parent);this.options={}}GameControllerPlugin.prototype.init=function(extra){if(extra==null){extra={}}if(extra.force){return document.documentElement["ontouchstart"]=function(){}}};GameControllerPlugin.prototype.start=function(){if("ontouchstart"in document.documentElement){GameController.init(this.game,this.options)}};GameControllerPlugin.prototype.addSide=function(side,x,y,type,data){var _base;if(data==null){data={}}if((_base=this.options)[side]==null){_base[side]={}}this.options[side].position={left:x,top:y};this.options[side].type=type;this.options[side][type]=data};GameControllerPlugin.prototype.addDPad=function(side,x,y,directions){var direction,options,_fn,_ref,_ref1,_results,_results1;if("string"===typeof side){this.dpad={up:false,down:false,left:false,right:false};this.addSide(side,x,y,"dpad",{background:true});_results=[];for(direction in directions){options=directions[direction];_results.push(function(_this){return function(direction,options){if(options===false){return _this.options[side].dpad[direction]=false}else{return _this.options[side].dpad[direction]={width:options.width,height:options.height,touchStart:function(){_this.dpad[direction]=true},touchEnd:function(){_this.dpad[direction]=false}}}}}(this)(direction,options))}return _results}else{this.left={up:false,down:false,left:false,right:false};this.right={up:false,down:false,left:false,right:false};options=side.left;this.addSide(options.side,options.x,options.y,"dpad",{background:true});_ref=options.directions;_fn=function(_this){return function(direction,options){if(options===false){return _this.options[side].dpad[direction]=false}else{return _this.options[side].dpad[direction]={width:options.width,height:options.height,touchStart:function(){_this.left[direction]=true},touchEnd:function(){_this.left[direction]=false}}}}}(this);for(direction in _ref){options=_ref[direction];_fn(direction,options)}options=side.right;this.addSide(options.side,options.x,options.y,"dpad",{background:true});_ref1=options.directions;_results1=[];for(direction in _ref1){options=_ref1[direction];_results1.push(function(_this){return function(direction,options){if(options===false){return _this.options[side].dpad[direction]=false}else{return _this.options[side].dpad[direction]={width:options.width,height:options.height,touchStart:function(){_this.right[direction]=true},touchEnd:function(){_this.right[direction]=false}}}}}(this)(direction,options))}return _results1}};GameControllerPlugin.prototype.addJoystick=function(side,x,y,radius){var options;if(radius==null){radius=x}if("string"===typeof side){this.joystick=null;this.addSide(side,x,y,"joystick",{touchStart:function(){},touchEnd:function(_this){return function(){_this.joystick=null}}(this),touchMove:function(_this){return function(joystick){_this.joystick=joystick}}(this)});this.options[side].radius=radius}else{this.left=null;this.right=null;options=side.left;if(options.radius==null){options.radius=60}this.addSide(options.side,options.x,options.y,"joystick",{touchStart:function(){},touchEnd:function(_this){return function(){_this.left=null}}(this),touchMove:function(_this){return function(joystick){_this.left=joystick}}(this)});this.options[side].radius=options.radius;options=side.right;if(options.radius==null){options.radius=60}this.addSide(options.side,options.x,options.y,"joystick",{touchStart:function(){},touchEnd:function(_this){return function(){_this.right=null}}(this),touchMove:function(_this){return function(joystick){_this.right=joystick}}(this)});this.options[side].radius=options.radius}};GameControllerPlugin.prototype.addButtons=function(side,x,y,buttons){var index,options,_fn,_ref,_ref1,_results,_results1;if("string"===typeof side){this.buttons={};this.addSide(side,x,y,"buttons",[false,false,false,false]);_results=[];for(index in buttons){options=buttons[index];_results.push(function(_this){return function(index,options){return _this.options[side].buttons[parseInt(index)-1]={label:options.title,radius:""+(options.radius||5)+"%",fontSize:options.fontSize,backgroundColor:options.color,touchStart:function(){_this.buttons[options.title.toLowerCase()]=true},touchEnd:function(){_this.buttons[options.title.toLowerCase()]=false}}}}(this)(index,options))}return _results}else{this.left={};this.right={};options=side.left;this.addSide(options.side,options.x,options.y,"buttons",[false,false,false,false]);_ref=options.buttons;_fn=function(_this){return function(index,options){return _this.options[side].buttons[parseInt(index)-1]={label:options.title,radius:""+(options.radius||5)+"%",fontSize:options.fontSize,backgroundColor:options.color,touchStart:function(){_this.left[options.title.toLowerCase()]=true},touchEnd:function(){_this.right[options.title.toLowerCase()]=false}}}}(this);for(index in _ref){options=_ref[index];_fn(index,options)}options=side.right;this.addSide(options.side,options.x,options.y,"buttons",[false,false,false,false]);_ref1=options.buttons;_results1=[];for(index in _ref1){options=_ref1[index];_results1.push(function(_this){return function(index,options){return _this.options[side].buttons[parseInt(index)-1]={label:options.title,radius:""+(options.radius||5)+"%",fontSize:options.fontSize,backgroundColor:options.color,touchStart:function(){_this.right[options.title.toLowerCase()]=true},touchEnd:function(){_this.right[options.title.toLowerCase()]=false}}}}(this)(index,options))}return _results1}};return GameControllerPlugin}(Phaser.Plugin)}).call(this);var Box2D=function(){"use strict";var ClipVertex,Features,b2AABB,b2Body,b2BodyDef,b2Bound,b2BoundValues,b2BuoyancyController,b2CircleContact,b2CircleShape,b2Collision,b2Color,b2ConstantAccelController,b2ConstantForceController,b2Contact,b2ContactConstraint,b2ContactConstraintPoint,b2ContactEdge,b2ContactFactory,b2ContactFilter,b2ContactID,b2ContactImpulse,b2ContactListener,b2ContactManager,b2ContactPoint,b2ContactRegister,b2ContactResult,b2ContactSolver,b2Controller,b2ControllerEdge,b2DebugDraw,b2DestructionListener,b2Distance,b2DistanceInput,b2DistanceJoint,b2DistanceJointDef,b2DistanceOutput,b2DistanceProxy,b2DynamicTree,b2DynamicTreeBroadPhase,b2DynamicTreeNode,b2DynamicTreePair,b2EdgeAndCircleContact,b2EdgeChainDef,b2EdgeShape,b2FilterData,b2Fixture,b2FixtureDef,b2FrictionJoint,b2FrictionJointDef,b2GearJoint,b2GearJointDef,b2GravityController,b2Island,b2Jacobian,b2Joint,b2JointDef,b2JointEdge,b2LineJoint,b2LineJointDef,b2Manifold,b2ManifoldPoint,b2MassData,b2Mat22,b2Mat33,b2Math,b2MouseJoint,b2MouseJointDef,b2NullContact,b2Point,b2PolyAndCircleContact,b2PolyAndEdgeContact,b2PolygonContact,b2PolygonShape,b2PositionSolverManifold,b2PrismaticJoint,b2PrismaticJointDef,b2PulleyJoint,b2PulleyJointDef,b2RayCastInput,b2RayCastOutput,b2RevoluteJoint,b2RevoluteJointDef,b2Segment,b2SeparationFunction,b2Settings,b2Shape,b2Simplex,b2SimplexCache,b2SimplexVertex,b2Sweep,b2TOIInput,b2TensorDampingController,b2TimeOfImpact,b2TimeStep,b2Transform,b2Vec2,b2Vec3,b2WeldJoint,b2WeldJointDef,b2World,b2WorldManifold,b2Assert=function(a){if(!a){throw"Assertion Failed"}},Box2D={Common:{Math:{}},Collision:{Shapes:{}},Dynamics:{Contacts:{},Controllers:{},Joints:{}}};b2Color=Box2D.Common.b2Color=function b2Color(rr,gg,bb){this.Set(rr,gg,bb)};b2Color.constructor=b2Color;b2Color.prototype={_r:0,_g:0,_b:0,Set:function(rr,gg,bb){this._r=Math.abs(255*b2Math.Clamp(rr,0,1),10);this._g=Math.abs(255*b2Math.Clamp(gg,0,1),10);this._b=Math.abs(255*b2Math.Clamp(bb,0,1),10)}};b2Settings=Box2D.Common.b2Settings=function b2Settings(){};b2Settings.constructor=b2Settings;b2Settings.VERSION="2.1alpha";b2Settings.b2_maxFloat=Number.MAX_VALUE;b2Settings.b2_epsilon=Number.MIN_VALUE;b2Settings.b2_pi=Math.PI;b2Settings.b2_maxManifoldPoints=2;b2Settings.b2_aabbExtension=.1;b2Settings.b2_aabbMultiplier=2;b2Settings.b2_linearSlop=.005;b2Settings.b2_maxTOIContactsPerIsland=32;b2Settings.b2_maxTOIJointsPerIsland=32;b2Settings.b2_velocityThreshold=1;b2Settings.b2_maxLinearCorrection=.2;b2Settings.b2_maxTranslation=2;b2Settings.b2_contactBaumgarte=.2;b2Settings.b2_timeToSleep=.5;b2Settings.b2_linearSleepTolerance=.01;b2Settings.b2_angularSleepTolerance=2/180*b2Settings.b2_pi;b2Settings.b2_maxRotationSquared=b2Settings.b2_maxRotation*b2Settings.b2_maxRotation;b2Settings.b2_maxRotation=.5*b2Settings.b2_pi;b2Settings.b2_maxTranslationSquared=b2Settings.b2_maxTranslation*b2Settings.b2_maxTranslation;b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi;b2Settings.b2_toiSlop=8*b2Settings.b2_linearSlop;b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi;b2Settings.b2_polygonRadius=2*b2Settings.b2_linearSlop;b2Settings.b2MixFriction=function(friction1,friction2){return Math.sqrt(friction1*friction2)};b2Settings.b2MixRestitution=function(restitution1,restitution2){return restitution1>restitution2?restitution1:restitution2};b2Vec2=Box2D.Common.Math.b2Vec2=function b2Vec2(x,y){this.x=x;this.y=y};b2Vec2.Make=function(x,y){return new b2Vec2(x,y)};b2Vec2.constructor=b2Vec2;b2Vec2.prototype={x:0,y:0,SetZero:function(){this.x=0;this.y=0;return this},Set:function(x,y){this.x=x;this.y=y;return this},SetV:function(v){this.x=v.x;this.y=v.y;return this},GetNegative:function(){return new b2Vec2(-this.x,-this.y)},NegativeSelf:function(){this.x=-this.x;this.y=-this.y;return this},Copy:function(){return new b2Vec2(this.x,this.y)},Add:function(v){this.x+=v.x;this.y+=v.y;return this},Subtract:function(v){this.x-=v.x;this.y-=v.y;return this},Multiply:function(a){this.x*=a;this.y*=a;return this},MulM:function(A){var tX=this.x;this.x=A.col1.x*tX+A.col2.x*this.y;this.y=A.col1.y*tX+A.col2.y*this.y;return this},MulTM:function(A){var tX=b2Math.Dot(this,A.col1);this.y=b2Math.Dot(this,A.col2);this.x=tX;return this},CrossVF:function(s){var tX=this.x;this.x=s*this.y;this.y=-s*tX;return this},CrossFV:function(s){var tX=this.x;this.x=-s*this.y;this.y=s*tX;return this},MinV:function(b){this.x=this.x<b.x?this.x:b.x;this.y=this.y<b.y?this.y:b.y;return this},MaxV:function(b){this.x=this.x>b.x?this.x:b.x;this.y=this.y>b.y?this.y:b.y;return this},Abs:function(){if(this.x<0)this.x=-this.x;if(this.y<0)this.y=-this.y;return this},Length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},LengthSquared:function(){return this.x*this.x+this.y*this.y},Normalize:function(){var length=Math.sqrt(this.x*this.x+this.y*this.y);if(length<b2Settings.b2_epsilon){return 0}var invLength=1/length;this.x*=invLength;this.y*=invLength;return length},IsValid:function(){return b2Math.IsValid(this.x)&&b2Math.IsValid(this.y)}};b2Vec3=Box2D.Common.Math.b2Vec3=function b2Vec3(x,y,z){this.x=x;this.y=y;this.z=z};b2Vec3.constructor=b2Vec3;b2Vec3.prototype={x:0,y:0,z:0,SetZero:function(){this.x=this.y=this.z=0;return this},Set:function(x,y,z){this.x=x;this.y=y;this.z=z;return this},SetV:function(v){this.x=v.x;this.y=v.y;this.z=v.z;return this},GetNegative:function(){return new b2Vec3(-this.x,-this.y,-this.z)},NegativeSelf:function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this},Copy:function(){return new b2Vec3(this.x,this.y,this.z)},Add:function(v){this.x+=v.x;this.y+=v.y;this.z+=v.z;return this},Subtract:function(v){this.x-=v.x;this.y-=v.y;this.z-=v.z;return this},Multiply:function(a){this.x*=a;this.y*=a;this.z*=a;return this}};b2Mat22=Box2D.Common.Math.b2Mat22=function b2Mat22(){this.col1=new b2Vec2(0,0);this.col2=new b2Vec2(0,0);this.SetIdentity()};b2Mat22.FromAngle=function(angle){var mat=new b2Mat22;mat.Set(angle);return mat};b2Mat22.FromVV=function(c1,c2){var mat=new b2Mat22;mat.SetVV(c1,c2);return mat};b2Mat22.constructor=b2Mat22;b2Mat22.prototype={col1:null,col2:null,Set:function(angle){var c=Math.cos(angle),s=Math.sin(angle);this.col1.x=c;this.col2.x=-s;this.col1.y=s;this.col2.y=c;return this},SetVV:function(c1,c2){this.col1.SetV(c1);this.col2.SetV(c2);return this},Copy:function(){var mat=new b2Mat22;mat.SetM(this);return mat},SetM:function(m){this.col1.SetV(m.col1);this.col2.SetV(m.col2);return this},AddM:function(m){this.col1.x+=m.col1.x;this.col1.y+=m.col1.y;this.col2.x+=m.col2.x;this.col2.y+=m.col2.y;return this},SetIdentity:function(){this.col1.x=1;this.col2.x=0;this.col1.y=0;this.col2.y=1;return this},SetZero:function(){this.col1.x=0;this.col2.x=0;this.col1.y=0;this.col2.y=0;return this},GetAngle:function(){return Math.atan2(this.col1.y,this.col1.x)},GetInverse:function(out){var a=this.col1.x,b=this.col2.x,c=this.col1.y,d=this.col2.y,det=a*d-b*c;if(det!==0){det=1/det}out.col1.x=det*d;out.col2.x=-det*b;out.col1.y=-det*c;out.col2.y=det*a;return out},Solve:function(out,bX,bY){var a11=this.col1.x,a12=this.col2.x,a21=this.col1.y,a22=this.col2.y,det=a11*a22-a12*a21;if(det!==0){det=1/det}out.x=det*(a22*bX-a12*bY);out.y=det*(a11*bY-a21*bX);return out},Abs:function(){this.col1.Abs();this.col2.Abs();return this}};b2Mat33=Box2D.Common.Math.b2Mat33=function b2Mat33(c1,c2,c3){this.col1=new b2Vec3(0,0,0);this.col2=new b2Vec3(0,0,0);this.col3=new b2Vec3(0,0,0);if(!c1&&!c2&&!c3){this.col1.SetZero();this.col2.SetZero();this.col3.SetZero()}else{this.col1.SetV(c1);this.col2.SetV(c2);this.col3.SetV(c3)}};b2Mat33.constructor=b2Mat33;b2Mat33.prototype={col1:null,col2:null,col3:null,SetVVV:function(c1,c2,c3){this.col1.SetV(c1);this.col2.SetV(c2);this.col3.SetV(c3);return this},Copy:function(){return new b2Mat33(this.col1,this.col2,this.col3)},SetM:function(m){this.col1.SetV(m.col1);this.col2.SetV(m.col2);this.col3.SetV(m.col3);return this},AddM:function(m){this.col1.x+=m.col1.x;this.col1.y+=m.col1.y;this.col1.z+=m.col1.z;this.col2.x+=m.col2.x;this.col2.y+=m.col2.y;this.col2.z+=m.col2.z;this.col3.x+=m.col3.x;this.col3.y+=m.col3.y;this.col3.z+=m.col3.z;return this},SetIdentity:function(){this.col1.x=1;this.col2.x=0;this.col3.x=0;this.col1.y=0;this.col2.y=1;this.col3.y=0;this.col1.z=0;this.col2.z=0;this.col3.z=1;return this},SetZero:function(){this.col1.x=0;this.col2.x=0;this.col3.x=0;this.col1.y=0;this.col2.y=0;this.col3.y=0;this.col1.z=0;this.col2.z=0;this.col3.z=0;return this},Solve22:function(out,bX,bY){var a11=this.col1.x,a12=this.col2.x,a21=this.col1.y,a22=this.col2.y,det=a11*a22-a12*a21;if(det!==0){det=1/det}out.x=det*(a22*bX-a12*bY);out.y=det*(a11*bY-a21*bX);return out},Solve33:function(out,bX,bY,bZ){var a11=this.col1.x,a21=this.col1.y,a31=this.col1.z,a12=this.col2.x,a22=this.col2.y,a32=this.col2.z,a13=this.col3.x,a23=this.col3.y,a33=this.col3.z,det=a11*(a22*a33-a32*a23)+a21*(a32*a13-a12*a33)+a31*(a12*a23-a22*a13);if(det!==0){det=1/det}out.x=det*(bX*(a22*a33-a32*a23)+bY*(a32*a13-a12*a33)+bZ*(a12*a23-a22*a13));out.y=det*(a11*(bY*a33-bZ*a23)+a21*(bZ*a13-bX*a33)+a31*(bX*a23-bY*a13));out.z=det*(a11*(a22*bZ-a32*bY)+a21*(a32*bX-a12*bZ)+a31*(a12*bY-a22*bX));return out}};b2Sweep=Box2D.Common.Math.b2Sweep=function b2Sweep(){this.localCenter=new b2Vec2(0,0);this.c0=new b2Vec2(0,0);this.c=new b2Vec2(0,0)};b2Sweep.constructor=b2Sweep;b2Sweep.prototype={localCenter:null,c:null,c0:null,a:0,a0:0,t0:0,Set:function(other){this.localCenter.SetV(other.localCenter);this.c0.SetV(other.c0);this.c.SetV(other.c);this.a0=other.a0;this.a=other.a;this.t0=other.t0;return this},Copy:function(){var copy=new b2Sweep;copy.localCenter.SetV(this.localCenter);copy.c0.SetV(this.c0);copy.c.SetV(this.c);copy.a0=this.a0;copy.a=this.a;copy.t0=this.t0;return copy},GetTransform:function(xf,alpha){alpha=alpha||0;xf.position.x=(1-alpha)*this.c0.x+alpha*this.c.x;xf.position.y=(1-alpha)*this.c0.y+alpha*this.c.y;var angle=(1-alpha)*this.a0+alpha*this.a;xf.R.Set(angle);var tMat=xf.R;xf.position.x-=tMat.col1.x*this.localCenter.x+tMat.col2.x*this.localCenter.y;xf.position.y-=tMat.col1.y*this.localCenter.x+tMat.col2.y*this.localCenter.y},Advance:function(t){t=t||0;if(this.t0<t&&1-this.t0>b2Settings.b2_epsilon){var alpha=(t-this.t0)/(1-this.t0);this.c0.x=(1-alpha)*this.c0.x+alpha*this.c.x;this.c0.y=(1-alpha)*this.c0.y+alpha*this.c.y;this.a0=(1-alpha)*this.a0+alpha*this.a;this.t0=t}}};b2Transform=Box2D.Common.Math.b2Transform=function b2Transform(pos,r){this.position=new b2Vec2(0,0);this.R=new b2Mat22;if(pos){this.position.SetV(pos);this.R.SetM(r)}};b2Transform.constructor=b2Transform;b2Transform.prototype={position:null,R:null,Initialize:function(pos,r){this.position.SetV(pos);this.R.SetM(r);return this},SetIdentity:function(){this.position.SetZero();this.R.SetIdentity();return this},Set:function(x){this.position.SetV(x.position);this.R.SetM(x.R);return this},GetAngle:function(){return Math.atan2(this.R.col1.y,this.R.col1.x)}};b2Math=Box2D.Common.Math.b2Math=function b2Math(){};b2Math.constructor=b2Math;b2Math.b2Vec2_zero=new b2Vec2(0,0);b2Math.b2Mat22_identity=b2Mat22.FromVV(new b2Vec2(1,0),new b2Vec2(0,1));b2Math.IsValid=function(x){return isFinite(x)};b2Math.Dot=function(a,b){return a.x*b.x+a.y*b.y};b2Math.CrossVV=function(a,b){return a.x*b.y-a.y*b.x};b2Math.CrossVF=function(a,s){return new b2Vec2(s*a.y,-s*a.x)};b2Math.CrossFV=function(s,a){return new b2Vec2(-s*a.y,s*a.x)};b2Math.MulMV=function(A,v){return new b2Vec2(A.col1.x*v.x+A.col2.x*v.y,A.col1.y*v.x+A.col2.y*v.y)};b2Math.MulTMV=function(A,v){return new b2Vec2(b2Math.Dot(v,A.col1),b2Math.Dot(v,A.col2))};b2Math.MulX=function(T,v){var a=b2Math.MulMV(T.R,v);a.x+=T.position.x;a.y+=T.position.y;return a};b2Math.MulXT=function(T,v){var a=b2Math.SubtractVV(v,T.position),tX=a.x*T.R.col1.x+a.y*T.R.col1.y;a.y=a.x*T.R.col2.x+a.y*T.R.col2.y;a.x=tX;return a};b2Math.AddVV=function(a,b){return new b2Vec2(a.x+b.x,a.y+b.y)};b2Math.SubtractVV=function(a,b){return new b2Vec2(a.x-b.x,a.y-b.y)};b2Math.Distance=function(a,b){var cX=a.x-b.x,cY=a.y-b.y;return Math.sqrt(cX*cX+cY*cY)};b2Math.DistanceSquared=function(a,b){var cX=a.x-b.x,cY=a.y-b.y;return cX*cX+cY*cY};b2Math.MulFV=function(s,a){return new b2Vec2(s*a.x,s*a.y)};b2Math.AddMM=function(A,B){return b2Mat22.FromVV(b2Math.AddVV(A.col1,B.col1),b2Math.AddVV(A.col2,B.col2))};b2Math.MulMM=function(A,B){return b2Mat22.FromVV(b2Math.MulMV(A,B.col1),b2Math.MulMV(A,B.col2))};b2Math.MulTMM=function(A,B){var c1=new b2Vec2(b2Math.Dot(A.col1,B.col1),b2Math.Dot(A.col2,B.col1)),c2=new b2Vec2(b2Math.Dot(A.col1,B.col2),b2Math.Dot(A.col2,B.col2));return b2Mat22.FromVV(c1,c2)};b2Math.Abs=function(a){return a>0?a:-a};b2Math.AbsV=function(a){return new b2Vec2(b2Math.Abs(a.x),b2Math.Abs(a.y))};b2Math.AbsM=function(A){return b2Mat22.FromVV(b2Math.AbsV(A.col1),b2Math.AbsV(A.col2))};b2Math.Min=function(a,b){return a<b?a:b};b2Math.MinV=function(a,b){return new b2Vec2(b2Math.Min(a.x,b.x),b2Math.Min(a.y,b.y))};b2Math.Max=function(a,b){return a>b?a:b};b2Math.MaxV=function(a,b){return new b2Vec2(b2Math.Max(a.x,b.x),b2Math.Max(a.y,b.y))};b2Math.Clamp=function(a,low,high){return a<low?low:a>high?high:a};b2Math.ClampV=function(a,low,high){return b2Math.MaxV(low,b2Math.MinV(a,high))};b2Math.Swap=function(a,b){var tmp=a[0];a[0]=b[0];b[0]=tmp};b2Math.Random=function(){return Math.random()*2-1};b2Math.RandomRange=function(lo,hi){return(hi-lo)*Math.random()+lo};b2Math.NextPowerOfTwo=function(x){x|=x>>1&2147483647;x|=x>>2&1073741823;x|=x>>4&268435455;x|=x>>8&16777215;x|=x>>16&65535;return x+1};b2Math.IsPowerOfTwo=function(x){return x>0&&(x&x-1)===0};b2Math.b2Transform_identity=new b2Transform(b2Math.b2Vec2_zero,b2Math.b2Mat22_identity);b2Shape=Box2D.Collision.Shapes.b2Shape=function b2Shape(){};b2Shape.prototype.m_type=b2Shape.e_unknownShape;b2Shape.prototype.m_radius=b2Settings.b2_linearSlop;b2Shape.e_unknownShape=-1;b2Shape.e_circleShape=0;b2Shape.e_polygonShape=1;b2Shape.e_edgeShape=2;b2Shape.e_shapeTypeCount=3;b2Shape.e_hitCollide=1;b2Shape.e_missCollide=0;b2Shape.e_startsInsideCollide=-1;b2Shape.TestOverlap=function(shape1,transform1,shape2,transform2){var input=new b2DistanceInput;input.proxyA=new b2DistanceProxy;input.proxyA.Set(shape1);input.proxyB=new b2DistanceProxy;input.proxyB.Set(shape2);input.transformA=transform1;input.transformB=transform2;input.useRadii=true;var simplexCache=new b2SimplexCache;simplexCache.count=0;var output=new b2DistanceOutput;b2Distance.Distance(output,simplexCache,input);return output.distance<10*b2Settings.b2_epsilon};b2Shape.prototype.Set=function(other){this.m_radius=other.m_radius};b2Shape.prototype.GetType=function(){return this.m_type};b2CircleShape=Box2D.Collision.Shapes.b2CircleShape=function b2CircleShape(radius){this.m_p=new b2Vec2(0,0);radius=radius||0;this.m_type=b2Shape.e_circleShape;this.m_radius=radius};b2CircleShape.prototype=Object.create(b2Shape.prototype);b2CircleShape.prototype.m_type=b2Shape.e_circleShape;b2CircleShape.prototype.m_p=null;b2CircleShape.prototype.Copy=function(){var s=new b2CircleShape;s.Set(this);return s};b2CircleShape.prototype.Set=function(other){b2Shape.prototype.Set.call(this,other);if(other instanceof b2CircleShape){var other2=other instanceof b2CircleShape?other:null;this.m_p.SetV(other2.m_p)}};b2CircleShape.prototype.TestPoint=function(transform,p){var tMat=transform.R,dX=transform.position.x+(tMat.col1.x*this.m_p.x+tMat.col2.x*this.m_p.y),dY=transform.position.y+(tMat.col1.y*this.m_p.x+tMat.col2.y*this.m_p.y);dX=p.x-dX;dY=p.y-dY;return dX*dX+dY*dY<=this.m_radius*this.m_radius};b2CircleShape.prototype.RayCast=function(output,input,transform){var tMat=transform.R,positionX=transform.position.x+(tMat.col1.x*this.m_p.x+tMat.col2.x*this.m_p.y),positionY=transform.position.y+(tMat.col1.y*this.m_p.x+tMat.col2.y*this.m_p.y),sX=input.p1.x-positionX,sY=input.p1.y-positionY,b=sX*sX+sY*sY-this.m_radius*this.m_radius,rX=input.p2.x-input.p1.x,rY=input.p2.y-input.p1.y,c=sX*rX+sY*rY,rr=rX*rX+rY*rY,sigma=c*c-rr*b;if(sigma<0||rr<b2Settings.b2_epsilon){return false}var a=-(c+Math.sqrt(sigma));if(0<=a&&a<=input.maxFraction*rr){a/=rr;output.fraction=a;output.normal.x=sX+a*rX;output.normal.y=sY+a*rY;output.normal.Normalize();return true}return false};b2CircleShape.prototype.ComputeAABB=function(aabb,transform){var tMat=transform.R,pX=transform.position.x+(tMat.col1.x*this.m_p.x+tMat.col2.x*this.m_p.y),pY=transform.position.y+(tMat.col1.y*this.m_p.x+tMat.col2.y*this.m_p.y);aabb.lowerBound.Set(pX-this.m_radius,pY-this.m_radius);aabb.upperBound.Set(pX+this.m_radius,pY+this.m_radius)};b2CircleShape.prototype.ComputeMass=function(massData,density){density=density||0;massData.mass=density*b2Settings.b2_pi*this.m_radius*this.m_radius;massData.center.SetV(this.m_p);massData.I=massData.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))};b2CircleShape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){offset=offset||0;var p=b2Math.MulX(xf,this.m_p),l=-(b2Math.Dot(normal,p)-offset);if(l<-this.m_radius+b2Settings.b2_epsilon){return 0}if(l>this.m_radius){c.SetV(p);return Math.PI*this.m_radius*this.m_radius}var r2=this.m_radius*this.m_radius,l2=l*l,area=r2*(Math.asin(l/this.m_radius)+Math.PI/2)+l*Math.sqrt(r2-l2),com=-2/3*Math.pow(r2-l2,1.5)/area;c.x=p.x+normal.x*com;c.y=p.y+normal.y*com;return area};b2CircleShape.prototype.GetLocalPosition=function(){return this.m_p};b2CircleShape.prototype.SetLocalPosition=function(position){this.m_p.SetV(position)};b2CircleShape.prototype.GetRadius=function(){return this.m_radius};b2CircleShape.prototype.SetRadius=function(radius){this.m_radius=radius};b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape=function b2PolygonShape(){b2Shape.call(this);this.m_type=b2Shape.e_polygonShape;this.m_centroid=new b2Vec2(0,0);this.m_vertices=[];this.m_normals=[]};b2PolygonShape.constructor=b2PolygonShape;b2PolygonShape.prototype=Object.create(b2Shape.prototype);b2PolygonShape.s_mat=new b2Mat22;b2PolygonShape.AsArray=function(vertices,vertexCount){var polygonShape=new b2PolygonShape;polygonShape.SetAsArray(vertices,vertexCount);return polygonShape};b2PolygonShape.AsVector=function(vertices,vertexCount){var polygonShape=new b2PolygonShape;polygonShape.SetAsVector(vertices,vertexCount);return polygonShape};b2PolygonShape.AsBox=function(hx,hy){var polygonShape=new b2PolygonShape;polygonShape.SetAsBox(hx,hy);return polygonShape};b2PolygonShape.AsOrientedBox=function(hx,hy,center,angle){hx=hx||0;hy=hy||0;center=center||null;angle=angle||0;var polygonShape=new b2PolygonShape;polygonShape.SetAsOrientedBox(hx,hy,center,angle);return polygonShape};b2PolygonShape.AsEdge=function(v1,v2){var polygonShape=new b2PolygonShape;polygonShape.SetAsEdge(v1,v2);return polygonShape};b2PolygonShape.ComputeCentroid=function(vs,count){var c=new b2Vec2(0,0),area=0,p1X=0,p1Y=0,inv3=1/3;for(var i=0;i<count;++i){var p2=vs[i],p3=i+1<count?vs[i+1]:vs[0],e1X=p2.x-p1X,e1Y=p2.y-p1Y,e2X=p3.x-p1X,e2Y=p3.y-p1Y,D=e1X*e2Y-e1Y*e2X,triangleArea=.5*D;area+=triangleArea;c.x+=triangleArea*inv3*(p1X+p2.x+p3.x);c.y+=triangleArea*inv3*(p1Y+p2.y+p3.y)}c.x*=1/area;c.y*=1/area;return c};b2PolygonShape.ComputeOBB=function(obb,vs,count){var i,p=[];for(i=0;i<count;++i){p.push(vs[i])}p.push(p[0]);var minArea=b2Settings.b2_maxFloat;for(i=1;i<=count;++i){var root=p[i-1],uxX=p[i].x-root.x,uxY=p[i].y-root.y,length=Math.sqrt(uxX*uxX+uxY*uxY);uxX/=length;uxY/=length;var uyX=-uxY,uyY=uxX,lowerX=b2Settings.b2_maxFloat,lowerY=b2Settings.b2_maxFloat,upperX=-b2Settings.b2_maxFloat,upperY=-b2Settings.b2_maxFloat;for(var j=0;j<count;++j){var dX=p[j].x-root.x,dY=p[j].y-root.y,rX=uxX*dX+uxY*dY,rY=uyX*dX+uyY*dY;if(rX<lowerX)lowerX=rX;if(rY<lowerY)lowerY=rY;if(rX>upperX)upperX=rX;if(rY>upperY)upperY=rY}var area=(upperX-lowerX)*(upperY-lowerY);if(area<.95*minArea){minArea=area;obb.R.col1.x=uxX;obb.R.col1.y=uxY;obb.R.col2.x=uyX;obb.R.col2.y=uyY;var centerX=.5*(lowerX+upperX),centerY=.5*(lowerY+upperY),tMat=obb.R;obb.center.x=root.x+(tMat.col1.x*centerX+tMat.col2.x*centerY);obb.center.y=root.y+(tMat.col1.y*centerX+tMat.col2.y*centerY);obb.extents.x=.5*(upperX-lowerX);obb.extents.y=.5*(upperY-lowerY)}}};b2PolygonShape.prototype.Copy=function(){var s=new b2PolygonShape;s.Set(this);return s};b2PolygonShape.prototype.Set=function(other){b2Shape.prototype.Set.call(this,other);if(other instanceof b2PolygonShape){var other2=other instanceof b2PolygonShape?other:null;this.m_centroid.SetV(other2.m_centroid);this.m_vertexCount=other2.m_vertexCount;this.Reserve(this.m_vertexCount);for(var i=0;i<this.m_vertexCount;i++){this.m_vertices[i].SetV(other2.m_vertices[i]);this.m_normals[i].SetV(other2.m_normals[i])}}};b2PolygonShape.prototype.SetAsArray=function(vertices,vertexCount){vertexCount=vertexCount||0;var v=[];var i,tVec;for(i=0;i<vertices.length;++i){tVec=vertices[i];v.push(tVec)}this.SetAsVector(v,vertexCount)};b2PolygonShape.prototype.SetAsVector=function(vertices,vertexCount){vertexCount=vertexCount||0;if(vertexCount===0)vertexCount=vertices.length;b2Assert(2<=vertexCount);this.m_vertexCount=vertexCount;this.Reserve(vertexCount);var i=0;for(i=0;i<this.m_vertexCount;i++){this.m_vertices[i].SetV(vertices[i])}for(i=0;i<this.m_vertexCount;++i){var i1=i,i2=i+1<this.m_vertexCount?i+1:0,edge=b2Math.SubtractVV(this.m_vertices[i2],this.m_vertices[i1]);b2Assert(edge.LengthSquared()>b2Settings.b2_epsilon);this.m_normals[i].SetV(b2Math.CrossVF(edge,1));this.m_normals[i].Normalize()}this.m_centroid=b2PolygonShape.ComputeCentroid(this.m_vertices,this.m_vertexCount)};b2PolygonShape.prototype.SetAsBox=function(hx,hy){hx=hx||0;hy=hy||0;this.m_vertexCount=4;this.Reserve(4);this.m_vertices[0].Set(-hx,-hy);this.m_vertices[1].Set(hx,-hy);this.m_vertices[2].Set(hx,hy);
this.m_vertices[3].Set(-hx,hy);this.m_normals[0].Set(0,-1);this.m_normals[1].Set(1,0);this.m_normals[2].Set(0,1);this.m_normals[3].Set(-1,0);this.m_centroid.SetZero()};b2PolygonShape.prototype.SetAsOrientedBox=function(hx,hy,center,angle){hx=hx||0;hy=hy||0;center=center||null;angle=angle||0;this.m_vertexCount=4;this.Reserve(4);this.m_vertices[0].Set(-hx,-hy);this.m_vertices[1].Set(hx,-hy);this.m_vertices[2].Set(hx,hy);this.m_vertices[3].Set(-hx,hy);this.m_normals[0].Set(0,-1);this.m_normals[1].Set(1,0);this.m_normals[2].Set(0,1);this.m_normals[3].Set(-1,0);this.m_centroid=center;var xf=new b2Transform;xf.position=center;xf.R.Set(angle);for(var i=0;i<this.m_vertexCount;++i){this.m_vertices[i]=b2Math.MulX(xf,this.m_vertices[i]);this.m_normals[i]=b2Math.MulMV(xf.R,this.m_normals[i])}};b2PolygonShape.prototype.SetAsEdge=function(v1,v2){this.m_vertexCount=2;this.Reserve(2);this.m_vertices[0].SetV(v1);this.m_vertices[1].SetV(v2);this.m_centroid.x=.5*(v1.x+v2.x);this.m_centroid.y=.5*(v1.y+v2.y);this.m_normals[0]=b2Math.CrossVF(b2Math.SubtractVV(v2,v1),1);this.m_normals[0].Normalize();this.m_normals[1].x=-this.m_normals[0].x;this.m_normals[1].y=-this.m_normals[0].y};b2PolygonShape.prototype.TestPoint=function(xf,p){var tVec,tMat=xf.R,tX=p.x-xf.position.x,tY=p.y-xf.position.y,pLocalX=tX*tMat.col1.x+tY*tMat.col1.y,pLocalY=tX*tMat.col2.x+tY*tMat.col2.y;for(var i=0;i<this.m_vertexCount;++i){tVec=this.m_vertices[i];tX=pLocalX-tVec.x;tY=pLocalY-tVec.y;tVec=this.m_normals[i];var dot=tVec.x*tX+tVec.y*tY;if(dot>0){return false}}return true};b2PolygonShape.prototype.RayCast=function(output,input,transform){var lower=0,upper=input.maxFraction,tX=0,tY=0,tMat,tVec;tX=input.p1.x-transform.position.x;tY=input.p1.y-transform.position.y;tMat=transform.R;var p1X=tX*tMat.col1.x+tY*tMat.col1.y,p1Y=tX*tMat.col2.x+tY*tMat.col2.y;tX=input.p2.x-transform.position.x;tY=input.p2.y-transform.position.y;tMat=transform.R;var p2X=tX*tMat.col1.x+tY*tMat.col1.y,p2Y=tX*tMat.col2.x+tY*tMat.col2.y,dX=p2X-p1X,dY=p2Y-p1Y,index=-1;for(var i=0;i<this.m_vertexCount;++i){tVec=this.m_vertices[i];tX=tVec.x-p1X;tY=tVec.y-p1Y;tVec=this.m_normals[i];var numerator=tVec.x*tX+tVec.y*tY,denominator=tVec.x*dX+tVec.y*dY;if(denominator===0){if(numerator<0){return false}}else{if(denominator<0&&numerator<lower*denominator){lower=numerator/denominator;index=i}else if(denominator>0&&numerator<upper*denominator){upper=numerator/denominator}}if(upper<lower-b2Settings.b2_epsilon){return false}}if(index>=0){output.fraction=lower;tMat=transform.R;tVec=this.m_normals[index];output.normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;output.normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;return true}return false};b2PolygonShape.prototype.ComputeAABB=function(aabb,xf){var tMat=xf.R,tVec=this.m_vertices[0],lowerX=xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),lowerY=xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y),upperX=lowerX,upperY=lowerY;for(var i=1;i<this.m_vertexCount;++i){tVec=this.m_vertices[i];var vX=xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),vY=xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);lowerX=lowerX<vX?lowerX:vX;lowerY=lowerY<vY?lowerY:vY;upperX=upperX>vX?upperX:vX;upperY=upperY>vY?upperY:vY}aabb.lowerBound.x=lowerX-this.m_radius;aabb.lowerBound.y=lowerY-this.m_radius;aabb.upperBound.x=upperX+this.m_radius;aabb.upperBound.y=upperY+this.m_radius};b2PolygonShape.prototype.ComputeMass=function(massData,density){if(this.m_vertexCount===2){massData.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x);massData.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y);massData.mass=0;massData.I=0;return}var centerX=0,centerY=0,area=0,I=0,p1X=0,p1Y=0,k_inv3=1/3;for(var i=0;i<this.m_vertexCount;++i){var p2=this.m_vertices[i],p3=i+1<this.m_vertexCount?this.m_vertices[i+1]:this.m_vertices[0],e1X=p2.x-p1X,e1Y=p2.y-p1Y,e2X=p3.x-p1X,e2Y=p3.y-p1Y,D=e1X*e2Y-e1Y*e2X,triangleArea=.5*D;area+=triangleArea;centerX+=triangleArea*k_inv3*(p1X+p2.x+p3.x);centerY+=triangleArea*k_inv3*(p1Y+p2.y+p3.y);var px=p1X,py=p1Y,ex1=e1X,ey1=e1Y,ex2=e2X,ey2=e2Y,intx2=k_inv3*(.25*(ex1*ex1+ex2*ex1+ex2*ex2)+(px*ex1+px*ex2))+.5*px*px,inty2=k_inv3*(.25*(ey1*ey1+ey2*ey1+ey2*ey2)+(py*ey1+py*ey2))+.5*py*py;I+=D*(intx2+inty2)}massData.mass=density*area;centerX*=1/area;centerY*=1/area;massData.center.Set(centerX,centerY);massData.I=density*I};b2PolygonShape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){var normalL=b2Math.MulTMV(xf.R,normal),offsetL=offset-b2Math.Dot(normal,xf.position),depths=[],diveCount=0,intoIndex=-1,outoIndex=-1,lastSubmerged=false,i=0;for(i=0;i<this.m_vertexCount;++i){depths[i]=b2Math.Dot(normalL,this.m_vertices[i])-offsetL;var isSubmerged=depths[i]<-b2Settings.b2_epsilon;if(i>0){if(isSubmerged){if(!lastSubmerged){intoIndex=i-1;diveCount++}}else{if(lastSubmerged){outoIndex=i-1;diveCount++}}}lastSubmerged=isSubmerged}switch(diveCount){case 0:if(lastSubmerged){var md=new b2MassData;this.ComputeMass(md,1);c.SetV(b2Math.MulX(xf,md.center));return md.mass}else{return 0}break;case 1:if(intoIndex===-1){intoIndex=this.m_vertexCount-1}else{outoIndex=this.m_vertexCount-1}break}var intoIndex2=(intoIndex+1)%this.m_vertexCount,outoIndex2=(outoIndex+1)%this.m_vertexCount,intoLamdda=(0-depths[intoIndex])/(depths[intoIndex2]-depths[intoIndex]),outoLamdda=(0-depths[outoIndex])/(depths[outoIndex2]-depths[outoIndex]),intoVec=new b2Vec2(this.m_vertices[intoIndex].x*(1-intoLamdda)+this.m_vertices[intoIndex2].x*intoLamdda,this.m_vertices[intoIndex].y*(1-intoLamdda)+this.m_vertices[intoIndex2].y*intoLamdda),outoVec=new b2Vec2(this.m_vertices[outoIndex].x*(1-outoLamdda)+this.m_vertices[outoIndex2].x*outoLamdda,this.m_vertices[outoIndex].y*(1-outoLamdda)+this.m_vertices[outoIndex2].y*outoLamdda),area=0,center=new b2Vec2(0,0),p2=this.m_vertices[intoIndex2],p3;i=intoIndex2;while(i!==outoIndex2){i=(i+1)%this.m_vertexCount;if(i===outoIndex2)p3=outoVec;else p3=this.m_vertices[i];var triangleArea=.5*((p2.x-intoVec.x)*(p3.y-intoVec.y)-(p2.y-intoVec.y)*(p3.x-intoVec.x));area+=triangleArea;center.x+=triangleArea*(intoVec.x+p2.x+p3.x)/3;center.y+=triangleArea*(intoVec.y+p2.y+p3.y)/3;p2=p3}center.Multiply(1/area);c.SetV(b2Math.MulX(xf,center));return area};b2PolygonShape.prototype.GetVertexCount=function(){return this.m_vertexCount};b2PolygonShape.prototype.GetVertices=function(){return this.m_vertices};b2PolygonShape.prototype.GetNormals=function(){return this.m_normals};b2PolygonShape.prototype.GetSupport=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_vertexCount;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return bestIndex};b2PolygonShape.prototype.GetSupportVertex=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_vertexCount;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return this.m_vertices[bestIndex]};b2PolygonShape.prototype.Validate=function(){return false};b2PolygonShape.prototype.Reserve=function(count){for(var i=this.m_vertices.length;i<count;i++){this.m_vertices[i]=new b2Vec2(0,0);this.m_normals[i]=new b2Vec2(0,0)}};b2EdgeChainDef=Box2D.Collision.Shapes.b2EdgeChainDef=function b2EdgeChainDef(){this.vertexCount=0;this.isALoop=true;this.vertices=[]};b2EdgeChainDef.constructor=b2EdgeChainDef;b2EdgeShape=Box2D.Collision.Shapes.b2EdgeShape=function b2EdgeShape(v1,v2){this.s_supportVec=new b2Vec2(0,0);this.m_v1=new b2Vec2(0,0);this.m_v2=new b2Vec2(0,0);this.m_coreV1=new b2Vec2(0,0);this.m_coreV2=new b2Vec2(0,0);this.m_normal=new b2Vec2(0,0);this.m_direction=new b2Vec2(0,0);this.m_cornerDir1=new b2Vec2(0,0);this.m_cornerDir2=new b2Vec2(0,0);b2Shape.call(this);this.m_type=b2Shape.e_edgeShape;this.m_prevEdge=null;this.m_nextEdge=null;this.m_v1=v1;this.m_v2=v2;this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y);this.m_length=this.m_direction.Normalize();this.m_normal.Set(this.m_direction.y,-this.m_direction.x);this.m_coreV1.Set(-b2Settings.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-b2Settings.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y);this.m_coreV2.Set(-b2Settings.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-b2Settings.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y);this.m_cornerDir1=this.m_normal;this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)};b2EdgeShape.constructor=b2EdgeShape;b2EdgeShape.prototype=Object.create(b2Shape.prototype);b2EdgeShape.prototype.TestPoint=function(transform,p){return false};b2EdgeShape.prototype.RayCast=function(output,input,transform){var tMat,rX=input.p2.x-input.p1.x,rY=input.p2.y-input.p1.y;tMat=transform.R;var v1X=transform.position.x+(tMat.col1.x*this.m_v1.x+tMat.col2.x*this.m_v1.y),v1Y=transform.position.y+(tMat.col1.y*this.m_v1.x+tMat.col2.y*this.m_v1.y),nX=transform.position.y+(tMat.col1.y*this.m_v2.x+tMat.col2.y*this.m_v2.y)-v1Y,nY=-(transform.position.x+(tMat.col1.x*this.m_v2.x+tMat.col2.x*this.m_v2.y)-v1X),k_slop=100*b2Settings.b2_epsilon,denom=-(rX*nX+rY*nY);if(denom>k_slop){var bX=input.p1.x-v1X,bY=input.p1.y-v1Y,a=bX*nX+bY*nY;if(0<=a&&a<=input.maxFraction*denom){var mu2=-rX*bY+rY*bX;if(-k_slop*denom<=mu2&&mu2<=denom*(1+k_slop)){a/=denom;output.fraction=a;var nLen=Math.sqrt(nX*nX+nY*nY);output.normal.x=nX/nLen;output.normal.y=nY/nLen;return true}}}return false};b2EdgeShape.prototype.ComputeAABB=function(aabb,transform){var tMat=transform.R,v1X=transform.position.x+(tMat.col1.x*this.m_v1.x+tMat.col2.x*this.m_v1.y),v1Y=transform.position.y+(tMat.col1.y*this.m_v1.x+tMat.col2.y*this.m_v1.y),v2X=transform.position.x+(tMat.col1.x*this.m_v2.x+tMat.col2.x*this.m_v2.y),v2Y=transform.position.y+(tMat.col1.y*this.m_v2.x+tMat.col2.y*this.m_v2.y);if(v1X<v2X){aabb.lowerBound.x=v1X;aabb.upperBound.x=v2X}else{aabb.lowerBound.x=v2X;aabb.upperBound.x=v1X}if(v1Y<v2Y){aabb.lowerBound.y=v1Y;aabb.upperBound.y=v2Y}else{aabb.lowerBound.y=v2Y;aabb.upperBound.y=v1Y}};b2EdgeShape.prototype.ComputeMass=function(massData,density){density=density||0;massData.mass=0;massData.center.SetV(this.m_v1);massData.I=0};b2EdgeShape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){offset=offset||0;var v0=new b2Vec2(normal.x*offset,normal.y*offset),v1=b2Math.MulX(xf,this.m_v1),v2=b2Math.MulX(xf,this.m_v2),d1=b2Math.Dot(normal,v1)-offset,d2=b2Math.Dot(normal,v2)-offset;if(d1>0){if(d2>0){return 0}else{v1.x=-d2/(d1-d2)*v1.x+d1/(d1-d2)*v2.x;v1.y=-d2/(d1-d2)*v1.y+d1/(d1-d2)*v2.y}}else{if(d2>0){v2.x=-d2/(d1-d2)*v1.x+d1/(d1-d2)*v2.x;v2.y=-d2/(d1-d2)*v1.y+d1/(d1-d2)*v2.y}}c.x=(v0.x+v1.x+v2.x)/3;c.y=(v0.y+v1.y+v2.y)/3;return.5*((v1.x-v0.x)*(v2.y-v0.y)-(v1.y-v0.y)*(v2.x-v0.x))};b2EdgeShape.prototype.GetLength=function(){return this.m_length};b2EdgeShape.prototype.GetVertex1=function(){return this.m_v1};b2EdgeShape.prototype.GetVertex2=function(){return this.m_v2};b2EdgeShape.prototype.GetCoreVertex1=function(){return this.m_coreV1};b2EdgeShape.prototype.GetCoreVertex2=function(){return this.m_coreV2};b2EdgeShape.prototype.GetNormalVector=function(){return this.m_normal};b2EdgeShape.prototype.GetDirectionVector=function(){return this.m_direction};b2EdgeShape.prototype.GetCorner1Vector=function(){return this.m_cornerDir1};b2EdgeShape.prototype.GetCorner2Vector=function(){return this.m_cornerDir2};b2EdgeShape.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1};b2EdgeShape.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2};b2EdgeShape.prototype.GetFirstVertex=function(xf){var tMat=xf.R;return new b2Vec2(xf.position.x+(tMat.col1.x*this.m_coreV1.x+tMat.col2.x*this.m_coreV1.y),xf.position.y+(tMat.col1.y*this.m_coreV1.x+tMat.col2.y*this.m_coreV1.y))};b2EdgeShape.prototype.GetNextEdge=function(){return this.m_nextEdge};b2EdgeShape.prototype.GetPrevEdge=function(){return this.m_prevEdge};b2EdgeShape.prototype.Support=function(xf,dX,dY){dX=dX||0;dY=dY||0;var tMat=xf.R,v1X=xf.position.x+(tMat.col1.x*this.m_coreV1.x+tMat.col2.x*this.m_coreV1.y),v1Y=xf.position.y+(tMat.col1.y*this.m_coreV1.x+tMat.col2.y*this.m_coreV1.y),v2X=xf.position.x+(tMat.col1.x*this.m_coreV2.x+tMat.col2.x*this.m_coreV2.y),v2Y=xf.position.y+(tMat.col1.y*this.m_coreV2.x+tMat.col2.y*this.m_coreV2.y);if(v1X*dX+v1Y*dY>v2X*dX+v2Y*dY){this.s_supportVec.x=v1X;this.s_supportVec.y=v1Y}else{this.s_supportVec.x=v2X;this.s_supportVec.y=v2Y}return this.s_supportVec};b2EdgeShape.prototype.SetPrevEdge=function(edge,core,cornerDir,convex){this.m_prevEdge=edge;this.m_coreV1=core;this.m_cornerDir1=cornerDir;this.m_cornerConvex1=convex};b2EdgeShape.prototype.SetNextEdge=function(edge,core,cornerDir,convex){this.m_nextEdge=edge;this.m_coreV2=core;this.m_cornerDir2=cornerDir;this.m_cornerConvex2=convex};b2EdgeShape.prototype.Copy=function(){return null};b2MassData=Box2D.Collision.Shapes.b2MassData=function b2MassData(){this.mass=0;this.center=new b2Vec2(0,0);this.I=0};b2MassData.constructor=b2MassData;Features=Box2D.Collision.Features=function Features(){};Features.constructor=Features;Features.prototype={_m_id:null,_referenceEdge:0,_incidentEdge:0,_incidentVertex:0,_flip:0};Object.defineProperties(Features.prototype,{referenceEdge:{enumerable:false,configurable:true,get:function(){return this._referenceEdge},set:function(value){this._referenceEdge=value;this._m_id.key=this._m_id.key&4294967040|this._referenceEdge&255}},incidentEdge:{enumerable:false,configurable:true,get:function(){return this._incidentEdge},set:function(value){this._incidentEdge=value;this._m_id.key=this._m_id.key&4294902015|this._incidentEdge<<8&65280}},incidentVertex:{enumerable:false,configurable:true,get:function(){return this._incidentVertex},set:function(value){this._incidentVertex=value;this._m_id.key=this._m_id.key&4278255615|this._incidentVertex<<16&16711680}},flip:{enumerable:false,configurable:true,get:function(){return this._flip},set:function(value){this._flip=value;this._m_id.key=this._m_id.key&16777215|this._flip<<24&4278190080}}});b2ContactID=Box2D.Collision.b2ContactID=function b2ContactID(){this.features=new Features;this.features._m_id=this};b2ContactID.constructor=b2ContactID;b2ContactID.prototype._key=0;b2ContactID.prototype.features=null;b2ContactID.prototype.Set=function(id){this.key=id._key};b2ContactID.prototype.Copy=function(){var id=new b2ContactID;id.key=this.key;return id};Object.defineProperties(b2ContactID.prototype,{key:{enumerable:false,configurable:true,get:function(){return this._key},set:function(value){this._key=value;this.features._referenceEdge=this._key&255;this.features._incidentEdge=(this._key&65280)>>8&255;this.features._incidentVertex=(this._key&16711680)>>16&255;this.features._flip=(this._key&4278190080)>>24&255}}});ClipVertex=Box2D.Collision.ClipVertex=function ClipVertex(){this.v=new b2Vec2(0,0);this.id=new b2ContactID};ClipVertex.constructor=ClipVertex;ClipVertex.prototype.v=null;ClipVertex.prototype.id=null;ClipVertex.prototype.Set=function(other){this.v.SetV(other.v);this.id.Set(other.id)};b2AABB=Box2D.Collision.b2AABB=function b2AABB(){this.lowerBound=new b2Vec2(0,0);this.upperBound=new b2Vec2(0,0)};b2AABB.constructor=b2AABB;b2AABB.prototype.lowerBound=null;b2AABB.prototype.upperBound=null;b2AABB.Combine=function(aabb1,aabb2){var aabb=new b2AABB;aabb.Combine(aabb1,aabb2);return aabb};b2AABB.prototype.IsValid=function(){var dX=this.upperBound.x-this.lowerBound.x,dY=this.upperBound.y-this.lowerBound.y,valid=dX>=0&&dY>=0;valid=valid&&this.lowerBound.IsValid()&&this.upperBound.IsValid();return valid};b2AABB.prototype.GetCenter=function(){return new b2Vec2((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)};b2AABB.prototype.GetExtents=function(){return new b2Vec2((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)};b2AABB.prototype.Contains=function(aabb){var result=true;result=result&&this.lowerBound.x<=aabb.lowerBound.x;result=result&&this.lowerBound.y<=aabb.lowerBound.y;result=result&&aabb.upperBound.x<=this.upperBound.x;result=result&&aabb.upperBound.y<=this.upperBound.y;return result};b2AABB.prototype.RayCast=function(output,input){var tmin=-b2Settings.b2_maxFloat,tmax=b2Settings.b2_maxFloat,pX=input.p1.x,pY=input.p1.y,dX=input.p2.x-input.p1.x,dY=input.p2.y-input.p1.y,absDX=Math.abs(dX),absDY=Math.abs(dY),normal=output.normal,inv_d=0,t1=0,t2=0,t3=0;var s=0;{if(absDX<b2Settings.b2_epsilon){if(pX<this.lowerBound.x||this.upperBound.x<pX)return false}else{inv_d=1/dX;t1=(this.lowerBound.x-pX)*inv_d;t2=(this.upperBound.x-pX)*inv_d;s=-1;if(t1>t2){t3=t1;t1=t2;t2=t3;s=1}if(t1>tmin){normal.x=s;normal.y=0;tmin=t1}tmax=Math.min(tmax,t2);if(tmin>tmax)return false}}{if(absDY<b2Settings.b2_epsilon){if(pY<this.lowerBound.y||this.upperBound.y<pY)return false}else{inv_d=1/dY;t1=(this.lowerBound.y-pY)*inv_d;t2=(this.upperBound.y-pY)*inv_d;s=-1;if(t1>t2){t3=t1;t1=t2;t2=t3;s=1}if(t1>tmin){normal.y=s;normal.x=0;tmin=t1}tmax=Math.min(tmax,t2);if(tmin>tmax)return false}}output.fraction=tmin;return true};b2AABB.prototype.TestOverlap=function(other){var d1X=other.lowerBound.x-this.upperBound.x,d1Y=other.lowerBound.y-this.upperBound.y,d2X=this.lowerBound.x-other.upperBound.x,d2Y=this.lowerBound.y-other.upperBound.y;if(d1X>0||d1Y>0)return false;if(d2X>0||d2Y>0)return false;return true};b2AABB.prototype.Combine=function(aabb1,aabb2){this.lowerBound.x=Math.min(aabb1.lowerBound.x,aabb2.lowerBound.x);this.lowerBound.y=Math.min(aabb1.lowerBound.y,aabb2.lowerBound.y);this.upperBound.x=Math.max(aabb1.upperBound.x,aabb2.upperBound.x);this.upperBound.y=Math.max(aabb1.upperBound.y,aabb2.upperBound.y)};b2SimplexCache=Box2D.Collision.b2SimplexCache=function b2SimplexCache(){this.indexA=[0,0,0];this.indexB=[0,0,0]};b2SimplexCache.constructor=b2SimplexCache;b2SimplexCache.prototype.indexA=null;b2SimplexCache.prototype.indexB=null;b2Bound=Box2D.Collision.b2Bound=function b2Bound(){};b2Bound.constructor=b2Bound;b2Bound.prototype.value=0;b2Bound.prototype.proxy=null;b2Bound.prototype.stabbingCount=0;b2Bound.prototype.IsLower=function(){return(this.value&1)===0};b2Bound.prototype.IsUpper=function(){return(this.value&1)===1};b2Bound.prototype.Swap=function(b){var tempValue=this.value,tempProxy=this.proxy,tempStabbingCount=this.stabbingCount;this.value=b.value;this.proxy=b.proxy;this.stabbingCount=b.stabbingCount;b.value=tempValue;b.proxy=tempProxy;b.stabbingCount=tempStabbingCount};b2BoundValues=Box2D.Collision.b2BoundValues=function b2BoundValues(){this.lowerValues=[];this.lowerValues[0]=0;this.lowerValues[1]=0;this.upperValues=[];this.upperValues[0]=0;this.upperValues[1]=0};b2BoundValues.constructor=b2BoundValues;b2BoundValues.prototype.lowerValues=null;b2BoundValues.prototype.upperValues=null;b2ManifoldPoint=Box2D.Collision.b2ManifoldPoint=function b2ManifoldPoint(){this.m_localPoint=new b2Vec2(0,0);this.m_id=new b2ContactID;this.Reset()};b2ManifoldPoint.constructor=b2ManifoldPoint;b2ManifoldPoint.prototype.m_localPoint=null;b2ManifoldPoint.prototype.m_id=null;b2ManifoldPoint.prototype.m_localPoint=null;b2ManifoldPoint.prototype.m_normalImpulse=0;b2ManifoldPoint.prototype.m_tangentImpulse=0;b2ManifoldPoint.prototype.Reset=function(){this.m_localPoint.SetZero();this.m_normalImpulse=0;this.m_tangentImpulse=0;this.m_id.key=0};b2ManifoldPoint.prototype.Set=function(m){this.m_localPoint.SetV(m.m_localPoint);this.m_normalImpulse=m.m_normalImpulse;this.m_tangentImpulse=m.m_tangentImpulse;this.m_id.Set(m.m_id)};b2Manifold=Box2D.Collision.b2Manifold=function b2Manifold(){this.m_pointCount=0;this.m_points=[];for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.m_points.push(new b2ManifoldPoint)}this.m_localPlaneNormal=new b2Vec2(0,0);this.m_localPoint=new b2Vec2(0,0)};b2Manifold.constructor=b2Manifold;b2Manifold.e_circles=1;b2Manifold.e_faceA=2;b2Manifold.e_faceB=4;b2Manifold.prototype.m_type=0;b2Manifold.prototype.m_pointCount=0;b2Manifold.prototype.m_points=null;b2Manifold.prototype.m_localPlaneNormal=null;b2Manifold.prototype.m_localPoint=null;b2Manifold.prototype.Reset=function(){for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){(this.m_points[i]instanceof b2ManifoldPoint?this.m_points[i]:null).Reset()}this.m_localPlaneNormal.SetZero();this.m_localPoint.SetZero();this.m_type=0;this.m_pointCount=0};b2Manifold.prototype.Set=function(m){this.m_pointCount=m.m_pointCount;for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){(this.m_points[i]instanceof b2ManifoldPoint?this.m_points[i]:null).Set(m.m_points[i])}this.m_localPlaneNormal.SetV(m.m_localPlaneNormal);this.m_localPoint.SetV(m.m_localPoint);this.m_type=m.m_type};b2Manifold.prototype.Copy=function(){var copy=new b2Manifold;copy.Set(this);return copy};b2Collision=Box2D.Collision.b2Collision=function b2Collision(){};b2Collision.constructor=b2Collision;b2Collision.s_edgeAO=[0];b2Collision.s_edgeBO=[0];b2Collision.s_localTangent=new b2Vec2(0,0);b2Collision.s_localNormal=new b2Vec2(0,0);b2Collision.s_planePoint=new b2Vec2(0,0);b2Collision.s_normal=new b2Vec2(0,0);b2Collision.s_tangent=new b2Vec2(0,0);b2Collision.s_tangent2=new b2Vec2(0,0);b2Collision.s_v11=new b2Vec2(0,0);b2Collision.s_v12=new b2Vec2(0,0);b2Collision.b2CollidePolyTempVec=new b2Vec2(0,0);b2Collision.b2_nullFeature=255;b2Collision.ClipSegmentToLine=function(vOut,vIn,normal,offset){offset=offset||0;var cv,numOut=0;cv=vIn[0];var vIn0=cv.v;cv=vIn[1];var vIn1=cv.v,distance0=normal.x*vIn0.x+normal.y*vIn0.y-offset,distance1=normal.x*vIn1.x+normal.y*vIn1.y-offset;if(distance0<=0)vOut[numOut++].Set(vIn[0]);if(distance1<=0)vOut[numOut++].Set(vIn[1]);if(distance0*distance1<0){var interp=distance0/(distance0-distance1);cv=vOut[numOut];var tVec=cv.v;tVec.x=vIn0.x+interp*(vIn1.x-vIn0.x);tVec.y=vIn0.y+interp*(vIn1.y-vIn0.y);cv=vOut[numOut];var cv2;if(distance0>0){cv2=vIn[0];cv.id=cv2.id}else{cv2=vIn[1];cv.id=cv2.id}++numOut}return numOut};b2Collision.EdgeSeparation=function(poly1,xf1,edge1,poly2,xf2){edge1=edge1||0;var vertices1=poly1.m_vertices,normals1=poly1.m_normals,count2=poly2.m_vertexCount,vertices2=poly2.m_vertices,tMat,tVec;tMat=xf1.R;tVec=normals1[edge1];var normal1WorldX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,normal1WorldY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xf2.R;var normal1X=tMat.col1.x*normal1WorldX+tMat.col1.y*normal1WorldY,normal1Y=tMat.col2.x*normal1WorldX+tMat.col2.y*normal1WorldY,index=0,minDot=b2Settings.b2_maxFloat;for(var i=0;i<count2;++i){tVec=vertices2[i];var dot=tVec.x*normal1X+tVec.y*normal1Y;if(dot<minDot){minDot=dot;index=i}}tVec=vertices1[edge1];tMat=xf1.R;var v1X=xf1.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),v1Y=xf1.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=vertices2[index];tMat=xf2.R;var v2X=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),v2Y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);v2X-=v1X;v2Y-=v1Y;return v2X*normal1WorldX+v2Y*normal1WorldY};b2Collision.FindMaxSeparation=function(edgeIndex,poly1,xf1,poly2,xf2){var count1=poly1.m_vertexCount,normals1=poly1.m_normals,tVec,tMat;tMat=xf2.R;tVec=poly2.m_centroid;var dX=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),dY=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=xf1.R;tVec=poly1.m_centroid;dX-=xf1.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);dY-=xf1.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);var dLocal1X=dX*xf1.R.col1.x+dY*xf1.R.col1.y,dLocal1Y=dX*xf1.R.col2.x+dY*xf1.R.col2.y,edge=0,maxDot=-b2Settings.b2_maxFloat;for(var i=0;i<count1;++i){tVec=normals1[i];var dot=tVec.x*dLocal1X+tVec.y*dLocal1Y;if(dot>maxDot){maxDot=dot;edge=i}}var s=b2Collision.EdgeSeparation(poly1,xf1,edge,poly2,xf2),prevEdge=edge-1>=0?edge-1:count1-1,sPrev=b2Collision.EdgeSeparation(poly1,xf1,prevEdge,poly2,xf2),nextEdge=edge+1<count1?edge+1:0,sNext=b2Collision.EdgeSeparation(poly1,xf1,nextEdge,poly2,xf2),bestEdge=0,bestSeparation=0,increment=0;if(sPrev>s&&sPrev>sNext){increment=-1;bestEdge=prevEdge;bestSeparation=sPrev}else if(sNext>s){increment=1;bestEdge=nextEdge;bestSeparation=sNext}else{edgeIndex[0]=edge;return s}while(true){if(increment===-1)edge=bestEdge-1>=0?bestEdge-1:count1-1;else edge=bestEdge+1<count1?bestEdge+1:0;s=b2Collision.EdgeSeparation(poly1,xf1,edge,poly2,xf2);if(s>bestSeparation){bestEdge=edge;bestSeparation=s}else{break}}edgeIndex[0]=bestEdge;return bestSeparation};b2Collision.FindIncidentEdge=function(c,poly1,xf1,edge1,poly2,xf2){edge1=edge1||0;var normals1=poly1.m_normals,count2=poly2.m_vertexCount,vertices2=poly2.m_vertices,normals2=poly2.m_normals,tMat,tVec;tMat=xf1.R;tVec=normals1[edge1];var normal1X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,normal1Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xf2.R;var tX=tMat.col1.x*normal1X+tMat.col1.y*normal1Y;normal1Y=tMat.col2.x*normal1X+tMat.col2.y*normal1Y;normal1X=tX;var index=0,minDot=b2Settings.b2_maxFloat;for(var i=0;i<count2;++i){tVec=normals2[i];var dot=normal1X*tVec.x+normal1Y*tVec.y;if(dot<minDot){minDot=dot;index=i}}var tClip,i1=index,i2=i1+1<count2?i1+1:0;tClip=c[0];tVec=vertices2[i1];tMat=xf2.R;tClip.v.x=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);tClip.v.y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tClip.id.features.referenceEdge=edge1;tClip.id.features.incidentEdge=i1;tClip.id.features.incidentVertex=0;tClip=c[1];tVec=vertices2[i2];tMat=xf2.R;tClip.v.x=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);tClip.v.y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tClip.id.features.referenceEdge=edge1;tClip.id.features.incidentEdge=i2;tClip.id.features.incidentVertex=1};b2Collision.MakeClipPointVector=function(){return[new ClipVertex,new ClipVertex]};b2Collision.CollidePolygons=function(manifold,polyA,xfA,polyB,xfB){var cv;manifold.m_pointCount=0;var totalRadius=polyA.m_radius+polyB.m_radius,edgeA=0;b2Collision.s_edgeAO[0]=edgeA;var separationA=b2Collision.FindMaxSeparation(b2Collision.s_edgeAO,polyA,xfA,polyB,xfB);edgeA=b2Collision.s_edgeAO[0];if(separationA>totalRadius)return;var edgeB=0;b2Collision.s_edgeBO[0]=edgeB;var separationB=b2Collision.FindMaxSeparation(b2Collision.s_edgeBO,polyB,xfB,polyA,xfA);edgeB=b2Collision.s_edgeBO[0];if(separationB>totalRadius)return;var poly1,poly2,xf1,xf2,edge1=0,flip=0,k_relativeTol=.98,k_absoluteTol=.001,tMat;if(separationB>k_relativeTol*separationA+k_absoluteTol){poly1=polyB;poly2=polyA;xf1=xfB;xf2=xfA;edge1=edgeB;manifold.m_type=b2Manifold.e_faceB;flip=1}else{poly1=polyA;poly2=polyB;xf1=xfA;xf2=xfB;edge1=edgeA;manifold.m_type=b2Manifold.e_faceA;flip=0}var incidentEdge=b2Collision.s_incidentEdge;b2Collision.FindIncidentEdge(incidentEdge,poly1,xf1,edge1,poly2,xf2);var count1=poly1.m_vertexCount,vertices1=poly1.m_vertices,local_v11=vertices1[edge1],local_v12;if(edge1+1<count1){local_v12=vertices1[edge1+1]}else{local_v12=vertices1[0]}var localTangent=b2Collision.s_localTangent;localTangent.Set(local_v12.x-local_v11.x,local_v12.y-local_v11.y);localTangent.Normalize();var localNormal=b2Collision.s_localNormal;localNormal.x=localTangent.y;localNormal.y=-localTangent.x;var planePoint=b2Collision.s_planePoint;planePoint.Set(.5*(local_v11.x+local_v12.x),.5*(local_v11.y+local_v12.y));var tangent=b2Collision.s_tangent;tMat=xf1.R;tangent.x=tMat.col1.x*localTangent.x+tMat.col2.x*localTangent.y;tangent.y=tMat.col1.y*localTangent.x+tMat.col2.y*localTangent.y;var tangent2=b2Collision.s_tangent2;tangent2.x=-tangent.x;tangent2.y=-tangent.y;var normal=b2Collision.s_normal;normal.x=tangent.y;normal.y=-tangent.x;var v11=b2Collision.s_v11,v12=b2Collision.s_v12;v11.x=xf1.position.x+(tMat.col1.x*local_v11.x+tMat.col2.x*local_v11.y);v11.y=xf1.position.y+(tMat.col1.y*local_v11.x+tMat.col2.y*local_v11.y);v12.x=xf1.position.x+(tMat.col1.x*local_v12.x+tMat.col2.x*local_v12.y);v12.y=xf1.position.y+(tMat.col1.y*local_v12.x+tMat.col2.y*local_v12.y);var frontOffset=normal.x*v11.x+normal.y*v11.y,sideOffset1=-tangent.x*v11.x-tangent.y*v11.y+totalRadius,sideOffset2=tangent.x*v12.x+tangent.y*v12.y+totalRadius,clipPoints1=b2Collision.s_clipPoints1,clipPoints2=b2Collision.s_clipPoints2,np=0;np=b2Collision.ClipSegmentToLine(clipPoints1,incidentEdge,tangent2,sideOffset1);if(np<2)return;np=b2Collision.ClipSegmentToLine(clipPoints2,clipPoints1,tangent,sideOffset2);if(np<2)return;manifold.m_localPlaneNormal.SetV(localNormal);manifold.m_localPoint.SetV(planePoint);var pointCount=0;for(var i=0;i<b2Settings.b2_maxManifoldPoints;++i){cv=clipPoints2[i];var separation=normal.x*cv.v.x+normal.y*cv.v.y-frontOffset;if(separation<=totalRadius){var cp=manifold.m_points[pointCount];tMat=xf2.R;var tX=cv.v.x-xf2.position.x,tY=cv.v.y-xf2.position.y;cp.m_localPoint.x=tX*tMat.col1.x+tY*tMat.col1.y;cp.m_localPoint.y=tX*tMat.col2.x+tY*tMat.col2.y;cp.m_id.Set(cv.id);cp.m_id.features.flip=flip;++pointCount}}manifold.m_pointCount=pointCount};b2Collision.CollideCircles=function(manifold,circle1,xf1,circle2,xf2){manifold.m_pointCount=0;var tMat,tVec;tMat=xf1.R;tVec=circle1.m_p;var p1X=xf1.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),p1Y=xf1.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=xf2.R;tVec=circle2.m_p;var p2X=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),p2Y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y),dX=p2X-p1X,dY=p2Y-p1Y,distSqr=dX*dX+dY*dY,radius=circle1.m_radius+circle2.m_radius;if(distSqr>radius*radius){return}manifold.m_type=b2Manifold.e_circles;manifold.m_localPoint.SetV(circle1.m_p);manifold.m_localPlaneNormal.SetZero();manifold.m_pointCount=1;manifold.m_points[0].m_localPoint.SetV(circle2.m_p);manifold.m_points[0].m_id.key=0};b2Collision.CollidePolygonAndCircle=function(manifold,polygon,xf1,circle,xf2){manifold.m_pointCount=0;var tPoint,dX=0,dY=0,positionX=0,positionY=0,tVec,tMat;tMat=xf2.R;tVec=circle.m_p;var cX=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),cY=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);dX=cX-xf1.position.x;dY=cY-xf1.position.y;tMat=xf1.R;var cLocalX=dX*tMat.col1.x+dY*tMat.col1.y,cLocalY=dX*tMat.col2.x+dY*tMat.col2.y,dist=0,normalIndex=0,separation=-b2Settings.b2_maxFloat,radius=polygon.m_radius+circle.m_radius,vertexCount=polygon.m_vertexCount,vertices=polygon.m_vertices,normals=polygon.m_normals;for(var i=0;i<vertexCount;++i){tVec=vertices[i];dX=cLocalX-tVec.x;dY=cLocalY-tVec.y;tVec=normals[i];var s=tVec.x*dX+tVec.y*dY;if(s>radius){return}if(s>separation){separation=s;normalIndex=i}}var vertIndex1=normalIndex,vertIndex2=vertIndex1+1<vertexCount?vertIndex1+1:0,v1=vertices[vertIndex1],v2=vertices[vertIndex2];if(separation<b2Settings.b2_epsilon){manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.SetV(normals[normalIndex]);manifold.m_localPoint.x=.5*(v1.x+v2.x);manifold.m_localPoint.y=.5*(v1.y+v2.y);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0;return}var u1=(cLocalX-v1.x)*(v2.x-v1.x)+(cLocalY-v1.y)*(v2.y-v1.y),u2=(cLocalX-v2.x)*(v1.x-v2.x)+(cLocalY-v2.y)*(v1.y-v2.y);if(u1<=0){if((cLocalX-v1.x)*(cLocalX-v1.x)+(cLocalY-v1.y)*(cLocalY-v1.y)>radius*radius)return;manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.x=cLocalX-v1.x;manifold.m_localPlaneNormal.y=cLocalY-v1.y;manifold.m_localPlaneNormal.Normalize();manifold.m_localPoint.SetV(v1);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0}else if(u2<=0){if((cLocalX-v2.x)*(cLocalX-v2.x)+(cLocalY-v2.y)*(cLocalY-v2.y)>radius*radius)return;manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.x=cLocalX-v2.x;manifold.m_localPlaneNormal.y=cLocalY-v2.y;manifold.m_localPlaneNormal.Normalize();manifold.m_localPoint.SetV(v2);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0}else{var faceCenterX=.5*(v1.x+v2.x),faceCenterY=.5*(v1.y+v2.y);separation=(cLocalX-faceCenterX)*normals[vertIndex1].x+(cLocalY-faceCenterY)*normals[vertIndex1].y;if(separation>radius)return;manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.x=normals[vertIndex1].x;manifold.m_localPlaneNormal.y=normals[vertIndex1].y;manifold.m_localPlaneNormal.Normalize();manifold.m_localPoint.Set(faceCenterX,faceCenterY);
manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0}};b2Collision.TestOverlap=function(a,b){var t1=b.lowerBound,t2=a.upperBound,d1X=t1.x-t2.x,d1Y=t1.y-t2.y;t1=a.lowerBound;t2=b.upperBound;var d2X=t1.x-t2.x,d2Y=t1.y-t2.y;if(d1X>0||d1Y>0)return false;if(d2X>0||d2Y>0)return false;return true};b2Collision.s_clipPoints2=b2Collision.MakeClipPointVector();b2Collision.s_clipPoints1=b2Collision.MakeClipPointVector();b2Collision.s_incidentEdge=b2Collision.MakeClipPointVector();b2ContactPoint=Box2D.Collision.b2ContactPoint=function b2ContactPoint(){this.position=new b2Vec2(0,0);this.velocity=new b2Vec2(0,0);this.normal=new b2Vec2(0,0);this.id=new b2ContactID};b2ContactPoint.constructor=b2ContactPoint;b2ContactPoint.prototype.position=null;b2ContactPoint.prototype.velocity=null;b2ContactPoint.prototype.normal=null;b2ContactPoint.prototype.id=null;b2SimplexVertex=Box2D.Collision.b2SimplexVertex=function b2SimplexVertex(){};b2SimplexVertex.constructor=b2SimplexVertex;b2SimplexVertex.prototype.wA=null;b2SimplexVertex.prototype.wB=null;b2SimplexVertex.prototype.w=null;b2SimplexVertex.prototype.a=null;b2SimplexVertex.prototype.indexA=null;b2SimplexVertex.prototype.indexB=null;b2SimplexVertex.prototype.Set=function(other){this.wA.SetV(other.wA);this.wB.SetV(other.wB);this.w.SetV(other.w);this.a=other.a;this.indexA=other.indexA;this.indexB=other.indexB};b2Simplex=Box2D.Collision.b2Simplex=function b2Simplex(){this.m_v1=new b2SimplexVertex;this.m_v2=new b2SimplexVertex;this.m_v3=new b2SimplexVertex;this.m_vertices=[this.m_v1,this.m_v2,this.m_v3]};b2Simplex.constructor=b2Simplex;b2Simplex.prototype.m_v1=null;b2Simplex.prototype.m_v2=null;b2Simplex.prototype.m_v3=null;b2Simplex.prototype.m_vertices=null;b2Simplex.prototype.m_count=0;b2Simplex.prototype.ReadCache=function(cache,proxyA,transformA,proxyB,transformB){b2Assert(0<=cache.count&&cache.count<=3);var wALocal,wBLocal;this.m_count=cache.count;var vertices=this.m_vertices;for(var i=0;i<this.m_count;i++){var v=vertices[i];v.indexA=cache.indexA[i];v.indexB=cache.indexB[i];wALocal=proxyA.GetVertex(v.indexA);wBLocal=proxyB.GetVertex(v.indexB);v.wA=b2Math.MulX(transformA,wALocal);v.wB=b2Math.MulX(transformB,wBLocal);v.w=b2Math.SubtractVV(v.wB,v.wA);v.a=0}if(this.m_count>1){var metric1=cache.metric,metric2=this.GetMetric();if(metric2<.5*metric1||2*metric1<metric2||metric2<b2Settings.b2_epsilon){this.m_count=0}}if(this.m_count===0){v=vertices[0];v.indexA=0;v.indexB=0;wALocal=proxyA.GetVertex(0);wBLocal=proxyB.GetVertex(0);v.wA=b2Math.MulX(transformA,wALocal);v.wB=b2Math.MulX(transformB,wBLocal);v.w=b2Math.SubtractVV(v.wB,v.wA);this.m_count=1}};b2Simplex.prototype.WriteCache=function(cache){cache.metric=this.GetMetric();cache.count=Math.abs(this.m_count);var vertices=this.m_vertices;for(var i=0;i<this.m_count;i++){cache.indexA[i]=Math.abs(vertices[i].indexA);cache.indexB[i]=Math.abs(vertices[i].indexB)}};b2Simplex.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:{var e12=b2Math.SubtractVV(this.m_v2.w,this.m_v1.w),sgn=b2Math.CrossVV(e12,this.m_v1.w.GetNegative());if(sgn>0){return b2Math.CrossFV(1,e12)}else{return b2Math.CrossVF(e12,1)}}default:b2Assert(false);return new b2Vec2(0,0)}};b2Simplex.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:b2Assert(false);return new b2Vec2(0,0);case 1:return this.m_v1.w;case 2:return new b2Vec2(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);default:b2Assert(false);return new b2Vec2(0,0)}};b2Simplex.prototype.GetWitnessPoints=function(pA,pB){switch(this.m_count){case 0:b2Assert(false);break;case 1:pA.SetV(this.m_v1.wA);pB.SetV(this.m_v1.wB);break;case 2:pA.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x;pA.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y;pB.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x;pB.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:pB.x=pA.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x;pB.y=pA.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break;default:b2Assert(false);break}};b2Simplex.prototype.GetMetric=function(){switch(this.m_count){case 0:b2Assert(false);return 0;case 1:return 0;case 2:return b2Math.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return b2Math.CrossVV(b2Math.SubtractVV(this.m_v2.w,this.m_v1.w),b2Math.SubtractVV(this.m_v3.w,this.m_v1.w));default:b2Assert(false);return 0}};b2Simplex.prototype.Solve2=function(){var w1=this.m_v1.w,w2=this.m_v2.w,e12=b2Math.SubtractVV(w2,w1),d12_2=-(w1.x*e12.x+w1.y*e12.y);if(d12_2<=0){this.m_v1.a=1;this.m_count=1;return}var d12_1=w2.x*e12.x+w2.y*e12.y;if(d12_1<=0){this.m_v2.a=1;this.m_count=1;this.m_v1.Set(this.m_v2);return}var inv_d12=1/(d12_1+d12_2);this.m_v1.a=d12_1*inv_d12;this.m_v2.a=d12_2*inv_d12;this.m_count=2};b2Simplex.prototype.Solve3=function(){var w1=this.m_v1.w,w2=this.m_v2.w,w3=this.m_v3.w,e12=b2Math.SubtractVV(w2,w1),w1e12=b2Math.Dot(w1,e12),w2e12=b2Math.Dot(w2,e12),d12_1=w2e12,d12_2=-w1e12,e13=b2Math.SubtractVV(w3,w1),w1e13=b2Math.Dot(w1,e13),w3e13=b2Math.Dot(w3,e13),d13_1=w3e13,d13_2=-w1e13,e23=b2Math.SubtractVV(w3,w2),w2e23=b2Math.Dot(w2,e23),w3e23=b2Math.Dot(w3,e23),d23_1=w3e23,d23_2=-w2e23,n123=b2Math.CrossVV(e12,e13),d123_1=n123*b2Math.CrossVV(w2,w3),d123_2=n123*b2Math.CrossVV(w3,w1),d123_3=n123*b2Math.CrossVV(w1,w2);if(d12_2<=0&&d13_2<=0){this.m_v1.a=1;this.m_count=1;return}if(d12_1>0&&d12_2>0&&d123_3<=0){var inv_d12=1/(d12_1+d12_2);this.m_v1.a=d12_1*inv_d12;this.m_v2.a=d12_2*inv_d12;this.m_count=2;return}if(d13_1>0&&d13_2>0&&d123_2<=0){var inv_d13=1/(d13_1+d13_2);this.m_v1.a=d13_1*inv_d13;this.m_v3.a=d13_2*inv_d13;this.m_count=2;this.m_v2.Set(this.m_v3);return}if(d12_1<=0&&d23_2<=0){this.m_v2.a=1;this.m_count=1;this.m_v1.Set(this.m_v2);return}if(d13_1<=0&&d23_1<=0){this.m_v3.a=1;this.m_count=1;this.m_v1.Set(this.m_v3);return}if(d23_1>0&&d23_2>0&&d123_1<=0){var inv_d23=1/(d23_1+d23_2);this.m_v2.a=d23_1*inv_d23;this.m_v3.a=d23_2*inv_d23;this.m_count=2;this.m_v1.Set(this.m_v3);return}var inv_d123=1/(d123_1+d123_2+d123_3);this.m_v1.a=d123_1*inv_d123;this.m_v2.a=d123_2*inv_d123;this.m_v3.a=d123_3*inv_d123;this.m_count=3};b2Distance=Box2D.Collision.b2Distance=function b2Distance(){};b2Distance.constructor=b2Distance;b2Distance.s_simplex=new b2Simplex;b2Distance.s_saveA=[0,0,0];b2Distance.s_saveB=[0,0,0];b2Distance.Distance=function(output,cache,input){var proxyA=input.proxyA,proxyB=input.proxyB,transformA=input.transformA,transformB=input.transformB,simplex=b2Distance.s_simplex;simplex.ReadCache(cache,proxyA,transformA,proxyB,transformB);var vertices=simplex.m_vertices,k_maxIters=20,saveA=b2Distance.s_saveA,saveB=b2Distance.s_saveB,saveCount=0,closestPoint=simplex.GetClosestPoint(),distanceSqr1=closestPoint.LengthSquared(),distanceSqr2=distanceSqr1,i=0,p,iter=0;while(iter<k_maxIters){saveCount=simplex.m_count;for(i=0;i<saveCount;i++){saveA[i]=vertices[i].indexA;saveB[i]=vertices[i].indexB}switch(simplex.m_count){case 1:break;case 2:simplex.Solve2();break;case 3:simplex.Solve3();break;default:b2Assert(false)}if(simplex.m_count===3){break}p=simplex.GetClosestPoint();distanceSqr2=p.LengthSquared();if(distanceSqr2>distanceSqr1){}distanceSqr1=distanceSqr2;var d=simplex.GetSearchDirection();if(d.LengthSquared()<b2Settings.b2_epsilon*b2Settings.b2_epsilon){break}var vertex=vertices[simplex.m_count];vertex.indexA=proxyA.GetSupport(b2Math.MulTMV(transformA.R,d.GetNegative()));vertex.wA=b2Math.MulX(transformA,proxyA.GetVertex(vertex.indexA));vertex.indexB=proxyB.GetSupport(b2Math.MulTMV(transformB.R,d));vertex.wB=b2Math.MulX(transformB,proxyB.GetVertex(vertex.indexB));vertex.w=b2Math.SubtractVV(vertex.wB,vertex.wA);++iter;++b2Distance.b2_gjkIters;var duplicate=false;for(i=0;i<saveCount;i++){if(vertex.indexA===saveA[i]&&vertex.indexB===saveB[i]){duplicate=true;break}}if(duplicate){break}++simplex.m_count}b2Distance.b2_gjkMaxIters=b2Math.Max(b2Distance.b2_gjkMaxIters,iter);simplex.GetWitnessPoints(output.pointA,output.pointB);output.distance=b2Math.SubtractVV(output.pointA,output.pointB).Length();output.iterations=iter;simplex.WriteCache(cache);if(input.useRadii){var rA=proxyA.m_radius,rB=proxyB.m_radius;if(output.distance>rA+rB&&output.distance>b2Settings.b2_epsilon){output.distance-=rA+rB;var normal=b2Math.SubtractVV(output.pointB,output.pointA);normal.Normalize();output.pointA.x+=rA*normal.x;output.pointA.y+=rA*normal.y;output.pointB.x-=rB*normal.x;output.pointB.y-=rB*normal.y}else{p=new b2Vec2(0,0);p.x=.5*(output.pointA.x+output.pointB.x);p.y=.5*(output.pointA.y+output.pointB.y);output.pointA.x=output.pointB.x=p.x;output.pointA.y=output.pointB.y=p.y;output.distance=0}}};b2DistanceInput=Box2D.Collision.b2DistanceInput=function b2DistanceInput(){};b2DistanceInput.constructor=b2DistanceInput;b2DistanceOutput=Box2D.Collision.b2DistanceOutput=function b2DistanceOutput(){this.pointA=new b2Vec2(0,0);this.pointB=new b2Vec2(0,0)};b2DistanceOutput.constructor=b2DistanceOutput;b2DistanceOutput.prototype.pointA=null;b2DistanceOutput.prototype.pointB=null;b2DistanceProxy=Box2D.Collision.b2DistanceProxy=function b2DistanceProxy(){};b2DistanceProxy.constructor=b2DistanceProxy;b2DistanceProxy.prototype.m_vertices=null;b2DistanceProxy.prototype.m_count=0;b2DistanceProxy.prototype.m_radius=0;b2DistanceProxy.prototype.Set=function(shape){switch(shape.GetType()){case b2Shape.e_circleShape:{var circle=shape instanceof b2CircleShape?shape:null;this.m_vertices=[true];this.m_vertices[0]=circle.m_p;this.m_count=1;this.m_radius=circle.m_radius}break;case b2Shape.e_polygonShape:{var polygon=shape instanceof b2PolygonShape?shape:null;this.m_vertices=polygon.m_vertices;this.m_count=polygon.m_vertexCount;this.m_radius=polygon.m_radius}break;default:b2Assert(false)}};b2DistanceProxy.prototype.GetSupport=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_count;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return bestIndex};b2DistanceProxy.prototype.GetSupportVertex=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_count;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return this.m_vertices[bestIndex]};b2DistanceProxy.prototype.GetVertexCount=function(){return this.m_count};b2DistanceProxy.prototype.GetVertex=function(index){index=index||0;b2Assert(0<=index&&index<this.m_count);return this.m_vertices[index]};b2DynamicTreeNode=Box2D.Collision.b2DynamicTreeNode=function b2DynamicTreeNode(){this.aabb=new b2AABB};b2DynamicTreeNode.constructor=b2DynamicTreeNode;b2DynamicTreeNode.prototype.aabb=null;b2DynamicTreeNode.prototype.child1=null;b2DynamicTreeNode.prototype.IsLeaf=function(){return this.child1==null};b2DynamicTree=Box2D.Collision.b2DynamicTree=function b2DynamicTree(){this.m_root=null;this.m_freeList=null;this.m_path=0;this.m_insertionCount=0};b2DynamicTree.constructor=b2DynamicTree;b2DynamicTree.prototype.m_root=null;b2DynamicTree.prototype.m_freeList=null;b2DynamicTree.prototype.m_path=0;b2DynamicTree.prototype.m_insertionCount=0;b2DynamicTree.prototype.CreateProxy=function(aabb,userData){var node=this.AllocateNode(),extendX=b2Settings.b2_aabbExtension,extendY=b2Settings.b2_aabbExtension;node.aabb.lowerBound.x=aabb.lowerBound.x-extendX;node.aabb.lowerBound.y=aabb.lowerBound.y-extendY;node.aabb.upperBound.x=aabb.upperBound.x+extendX;node.aabb.upperBound.y=aabb.upperBound.y+extendY;node.userData=userData;this.InsertLeaf(node);return node};b2DynamicTree.prototype.DestroyProxy=function(proxy){this.RemoveLeaf(proxy);this.FreeNode(proxy)};b2DynamicTree.prototype.MoveProxy=function(proxy,aabb,displacement){b2Assert(proxy.IsLeaf());if(proxy.aabb.Contains(aabb)){return false}this.RemoveLeaf(proxy);var extendX=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(displacement.x>0?displacement.x:-displacement.x),extendY=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(displacement.y>0?displacement.y:-displacement.y);proxy.aabb.lowerBound.x=aabb.lowerBound.x-extendX;proxy.aabb.lowerBound.y=aabb.lowerBound.y-extendY;proxy.aabb.upperBound.x=aabb.upperBound.x+extendX;proxy.aabb.upperBound.y=aabb.upperBound.y+extendY;this.InsertLeaf(proxy);return true};b2DynamicTree.prototype.Rebalance=function(iterations){iterations=iterations||0;if(this.m_root==null)return;for(var i=0;i<iterations;i++){var node=this.m_root,bit=0;while(node.IsLeaf()===false){node=this.m_path>>bit&1?node.child2:node.child1;bit=bit+1&31}++this.m_path;this.RemoveLeaf(node);this.InsertLeaf(node)}};b2DynamicTree.prototype.GetFatAABB=function(proxy){return proxy.aabb};b2DynamicTree.prototype.GetUserData=function(proxy){return proxy.userData};b2DynamicTree.prototype.Query=function(callback,aabb){if(this.m_root==null)return;var stack=[],count=0;stack[count++]=this.m_root;while(count>0){var node=stack[--count];if(node.aabb.TestOverlap(aabb)){if(node.IsLeaf()){var proceed=callback(node);if(!proceed)return}else{stack[count++]=node.child1;stack[count++]=node.child2}}}};b2DynamicTree.prototype.RayCast=function(callback,input){if(this.m_root==null)return;var p1=input.p1,p2=input.p2,r=b2Math.SubtractVV(p1,p2);r.Normalize();var v=b2Math.CrossFV(1,r),abs_v=b2Math.AbsV(v),maxFraction=input.maxFraction,segmentAABB=new b2AABB,tX=0;var tY=0;{tX=p1.x+maxFraction*(p2.x-p1.x);tY=p1.y+maxFraction*(p2.y-p1.y);segmentAABB.lowerBound.x=Math.min(p1.x,tX);segmentAABB.lowerBound.y=Math.min(p1.y,tY);segmentAABB.upperBound.x=Math.max(p1.x,tX);segmentAABB.upperBound.y=Math.max(p1.y,tY)}var stack=[],count=0;stack[count++]=this.m_root;while(count>0){var node=stack[--count];if(node.aabb.TestOverlap(segmentAABB)===false){continue}var c=node.aabb.GetCenter(),h=node.aabb.GetExtents(),separation=Math.abs(v.x*(p1.x-c.x)+v.y*(p1.y-c.y))-abs_v.x*h.x-abs_v.y*h.y;if(separation>0)continue;if(node.IsLeaf()){var subInput=new b2RayCastInput;subInput.p1=input.p1;subInput.p2=input.p2;subInput.maxFraction=input.maxFraction;maxFraction=callback(subInput,node);if(maxFraction===0)return;if(maxFraction>0){tX=p1.x+maxFraction*(p2.x-p1.x);tY=p1.y+maxFraction*(p2.y-p1.y);segmentAABB.lowerBound.x=Math.min(p1.x,tX);segmentAABB.lowerBound.y=Math.min(p1.y,tY);segmentAABB.upperBound.x=Math.max(p1.x,tX);segmentAABB.upperBound.y=Math.max(p1.y,tY)}}else{stack[count++]=node.child1;stack[count++]=node.child2}}};b2DynamicTree.prototype.AllocateNode=function(){if(this.m_freeList){var node=this.m_freeList;this.m_freeList=node.parent;node.parent=null;node.child1=null;node.child2=null;return node}return new b2DynamicTreeNode};b2DynamicTree.prototype.FreeNode=function(node){node.parent=this.m_freeList;this.m_freeList=node};b2DynamicTree.prototype.InsertLeaf=function(leaf){++this.m_insertionCount;if(this.m_root==null){this.m_root=leaf;this.m_root.parent=null;return}var center=leaf.aabb.GetCenter(),sibling=this.m_root;if(sibling.IsLeaf()===false){do{var child1=sibling.child1,child2=sibling.child2,norm1=Math.abs((child1.aabb.lowerBound.x+child1.aabb.upperBound.x)/2-center.x)+Math.abs((child1.aabb.lowerBound.y+child1.aabb.upperBound.y)/2-center.y),norm2=Math.abs((child2.aabb.lowerBound.x+child2.aabb.upperBound.x)/2-center.x)+Math.abs((child2.aabb.lowerBound.y+child2.aabb.upperBound.y)/2-center.y);if(norm1<norm2){sibling=child1}else{sibling=child2}}while(sibling.IsLeaf()===false)}var node1=sibling.parent,node2=this.AllocateNode();node2.parent=node1;node2.userData=null;node2.aabb.Combine(leaf.aabb,sibling.aabb);if(node1){if(sibling.parent.child1===sibling){node1.child1=node2}else{node1.child2=node2}node2.child1=sibling;node2.child2=leaf;sibling.parent=node2;leaf.parent=node2;do{if(node1.aabb.Contains(node2.aabb))break;node1.aabb.Combine(node1.child1.aabb,node1.child2.aabb);node2=node1;node1=node1.parent}while(node1)}else{node2.child1=sibling;node2.child2=leaf;sibling.parent=node2;leaf.parent=node2;this.m_root=node2}};b2DynamicTree.prototype.RemoveLeaf=function(leaf){if(leaf===this.m_root){this.m_root=null;return}var node2=leaf.parent,node1=node2.parent,sibling;if(node2.child1===leaf){sibling=node2.child2}else{sibling=node2.child1}if(node1){if(node1.child1===node2){node1.child1=sibling}else{node1.child2=sibling}sibling.parent=node1;this.FreeNode(node2);while(node1){var oldAABB=node1.aabb;node1.aabb=b2AABB.Combine(node1.child1.aabb,node1.child2.aabb);if(oldAABB.Contains(node1.aabb))break;node1=node1.parent}}else{this.m_root=sibling;sibling.parent=null;this.FreeNode(node2)}};b2DynamicTreePair=Box2D.Collision.b2DynamicTreePair=function b2DynamicTreePair(){};b2DynamicTreePair.constructor=b2DynamicTreePair;b2DynamicTreeBroadPhase=Box2D.Collision.b2DynamicTreeBroadPhase=function b2DynamicTreeBroadPhase(){this.m_tree=new b2DynamicTree;this.m_moveBuffer=[];this.m_pairBuffer=[];this.m_pairCount=0};b2DynamicTreeBroadPhase.constructor=b2DynamicTreeBroadPhase;b2DynamicTreeBroadPhase.prototype.m_tree=null;b2DynamicTreeBroadPhase.prototype.m_moveBuffer=null;b2DynamicTreeBroadPhase.prototype.m_pairBuffer=null;b2DynamicTreeBroadPhase.prototype.m_pairCount=null;b2DynamicTreeBroadPhase.prototype.CreateProxy=function(aabb,userData){var proxy=this.m_tree.CreateProxy(aabb,userData);++this.m_proxyCount;this.BufferMove(proxy);return proxy};b2DynamicTreeBroadPhase.prototype.DestroyProxy=function(proxy){this.UnBufferMove(proxy);--this.m_proxyCount;this.m_tree.DestroyProxy(proxy)};b2DynamicTreeBroadPhase.prototype.MoveProxy=function(proxy,aabb,displacement){var buffer=this.m_tree.MoveProxy(proxy,aabb,displacement);if(buffer){this.BufferMove(proxy)}};b2DynamicTreeBroadPhase.prototype.TestOverlap=function(proxyA,proxyB){var aabbA=this.m_tree.GetFatAABB(proxyA),aabbB=this.m_tree.GetFatAABB(proxyB);return aabbA.TestOverlap(aabbB)};b2DynamicTreeBroadPhase.prototype.GetUserData=function(proxy){return this.m_tree.GetUserData(proxy)};b2DynamicTreeBroadPhase.prototype.GetFatAABB=function(proxy){return this.m_tree.GetFatAABB(proxy)};b2DynamicTreeBroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount};b2DynamicTreeBroadPhase.prototype.UpdatePairs=function(callback){var __this=this;__this.m_pairCount=0;var i=0,queryProxy;function QueryCallback(proxy){if(proxy===queryProxy)return true;if(__this.m_pairCount===__this.m_pairBuffer.length){__this.m_pairBuffer[__this.m_pairCount]=new b2DynamicTreePair}var pair=__this.m_pairBuffer[__this.m_pairCount];pair.proxyA=proxy<queryProxy?proxy:queryProxy;pair.proxyB=proxy>=queryProxy?proxy:queryProxy;++__this.m_pairCount;return true}for(i=0;i<__this.m_moveBuffer.length;++i){queryProxy=__this.m_moveBuffer[i];var fatAABB=__this.m_tree.GetFatAABB(queryProxy);__this.m_tree.Query(QueryCallback,fatAABB)}__this.m_moveBuffer.length=0;for(var i=0;i<__this.m_pairCount;){var primaryPair=__this.m_pairBuffer[i],userDataA=__this.m_tree.GetUserData(primaryPair.proxyA),userDataB=__this.m_tree.GetUserData(primaryPair.proxyB);callback(userDataA,userDataB);++i;while(i<__this.m_pairCount){var pair=__this.m_pairBuffer[i];if(pair.proxyA!==primaryPair.proxyA||pair.proxyB!==primaryPair.proxyB){break}++i}}};b2DynamicTreeBroadPhase.prototype.Query=function(callback,aabb){this.m_tree.Query(callback,aabb)};b2DynamicTreeBroadPhase.prototype.RayCast=function(callback,input){this.m_tree.RayCast(callback,input)};b2DynamicTreeBroadPhase.prototype.Validate=function(){};b2DynamicTreeBroadPhase.prototype.Rebalance=function(iterations){iterations=iterations||0;this.m_tree.Rebalance(iterations)};b2DynamicTreeBroadPhase.prototype.BufferMove=function(proxy){this.m_moveBuffer[this.m_moveBuffer.length]=proxy};b2DynamicTreeBroadPhase.prototype.UnBufferMove=function(proxy){var i=this.m_moveBuffer.indexOf(proxy);this.m_moveBuffer.splice(i,1)};b2DynamicTreeBroadPhase.prototype.ComparePairs=function(pair1,pair2){return 0};b2Point=Box2D.Collision.b2Point=function b2Point(){this.p=new b2Vec2(0,0)};b2Point.constructor=b2Point;b2Point.prototype.p=null;b2Point.prototype.Support=function(xf,vX,vY){return this.p};b2Point.prototype.GetFirstVertex=function(xf){return this.p};b2RayCastInput=Box2D.Collision.b2RayCastInput=function b2RayCastInput(p1,p2,maxFraction){this.p1=new b2Vec2(0,0);this.p2=new b2Vec2(0,0);p1=p1||null;p2=p2||null;maxFraction=maxFraction||1;if(p1)this.p1.SetV(p1);if(p2)this.p2.SetV(p2);this.maxFraction=maxFraction};b2RayCastInput.constructor=b2RayCastInput;b2RayCastInput.prototype.p1=null;b2RayCastInput.prototype.p2=null;b2RayCastInput.prototype.maxFraction=1;b2RayCastOutput=Box2D.Collision.b2RayCastOutput=function b2RayCastOutput(){this.normal=new b2Vec2(0,0)};b2RayCastOutput.constructor=b2RayCastOutput;b2RayCastOutput.prototype.normal=null;b2Segment=Box2D.Collision.b2Segment=function b2Segment(){this.p1=new b2Vec2(0,0);this.p2=new b2Vec2(0,0)};b2Segment.constructor=b2Segment;b2Segment.prototype.p1=null;b2Segment.prototype.p2=null;b2Segment.prototype.TestSegment=function(lambda,normal,segment,maxLambda){maxLambda=maxLambda||0;var s=segment.p1,rX=segment.p2.x-s.x,rY=segment.p2.y-s.y,dX=this.p2.x-this.p1.x,dY=this.p2.y-this.p1.y,nX=dY,nY=-dX,k_slop=100*b2Settings.b2_epsilon,denom=-(rX*nX+rY*nY);if(denom>k_slop){var bX=s.x-this.p1.x,bY=s.y-this.p1.y,a=bX*nX+bY*nY;if(0<=a&&a<=maxLambda*denom){var mu2=-rX*bY+rY*bX;if(-k_slop*denom<=mu2&&mu2<=denom*(1+k_slop)){a/=denom;var nLen=Math.sqrt(nX*nX+nY*nY);nX/=nLen;nY/=nLen;lambda[0]=a;normal.Set(nX,nY);return true}}}return false};b2Segment.prototype.Extend=function(aabb){this.ExtendForward(aabb);this.ExtendBackward(aabb)};b2Segment.prototype.ExtendForward=function(aabb){var dX=this.p2.x-this.p1.x,dY=this.p2.y-this.p1.y;var lambda=Math.min(dX>0?(aabb.upperBound.x-this.p1.x)/dX:dX<0?(aabb.lowerBound.x-this.p1.x)/dX:Number.POSITIVE_INFINITY,dY>0?(aabb.upperBound.y-this.p1.y)/dY:dY<0?(aabb.lowerBound.y-this.p1.y)/dY:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+dX*lambda;this.p2.y=this.p1.y+dY*lambda};b2Segment.prototype.ExtendBackward=function(aabb){var dX=-this.p2.x+this.p1.x,dY=-this.p2.y+this.p1.y;var lambda=Math.min(dX>0?(aabb.upperBound.x-this.p2.x)/dX:dX<0?(aabb.lowerBound.x-this.p2.x)/dX:Number.POSITIVE_INFINITY,dY>0?(aabb.upperBound.y-this.p2.y)/dY:dY<0?(aabb.lowerBound.y-this.p2.y)/dY:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+dX*lambda;this.p1.y=this.p2.y+dY*lambda};b2SeparationFunction=Box2D.Collision.b2SeparationFunction=function b2SeparationFunction(){this.m_localPoint=new b2Vec2(0,0);this.m_axis=new b2Vec2(0,0)};b2SeparationFunction.constructor=b2SeparationFunction;b2SeparationFunction.e_points=1;b2SeparationFunction.e_faceA=2;b2SeparationFunction.e_faceB=4;b2SeparationFunction.prototype.m_localPoint=null;b2SeparationFunction.prototype.m_axis=null;b2SeparationFunction.prototype.m_proxyA=null;b2SeparationFunction.prototype.m_proxyB=null;b2SeparationFunction.prototype.Initialize=function(cache,proxyA,transformA,proxyB,transformB){this.m_proxyA=proxyA;this.m_proxyB=proxyB;var count=cache.count;b2Assert(0<count&&count<3);var localPointA,localPointA1,localPointA2,localPointB,localPointB1,localPointB2,pointAX=0,pointAY=0,pointBX=0,pointBY=0,normalX=0,normalY=0,tMat,tVec,s=0,sgn=0;if(count===1){this.m_type=b2SeparationFunction.e_points;localPointA=this.m_proxyA.GetVertex(cache.indexA[0]);localPointB=this.m_proxyB.GetVertex(cache.indexB[0]);tVec=localPointA;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointB;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);this.m_axis.x=pointBX-pointAX;this.m_axis.y=pointBY-pointAY;this.m_axis.Normalize()}else if(cache.indexB[0]===cache.indexB[1]){this.m_type=b2SeparationFunction.e_faceA;localPointA1=this.m_proxyA.GetVertex(cache.indexA[0]);localPointA2=this.m_proxyA.GetVertex(cache.indexA[1]);localPointB=this.m_proxyB.GetVertex(cache.indexB[0]);this.m_localPoint.x=.5*(localPointA1.x+localPointA2.x);this.m_localPoint.y=.5*(localPointA1.y+localPointA2.y);this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointA2,localPointA1),1);this.m_axis.Normalize();tVec=this.m_axis;tMat=transformA.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointB;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);s=(pointBX-pointAX)*normalX+(pointBY-pointAY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}else if(cache.indexA[0]===cache.indexA[0]){this.m_type=b2SeparationFunction.e_faceB;localPointB1=this.m_proxyB.GetVertex(cache.indexB[0]);localPointB2=this.m_proxyB.GetVertex(cache.indexB[1]);localPointA=this.m_proxyA.GetVertex(cache.indexA[0]);this.m_localPoint.x=.5*(localPointB1.x+localPointB2.x);this.m_localPoint.y=.5*(localPointB1.y+localPointB2.y);this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointB2,localPointB1),1);this.m_axis.Normalize();tVec=this.m_axis;tMat=transformB.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointA;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);s=(pointAX-pointBX)*normalX+(pointAY-pointBY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}else{localPointA1=this.m_proxyA.GetVertex(cache.indexA[0]);localPointA2=this.m_proxyA.GetVertex(cache.indexA[1]);localPointB1=this.m_proxyB.GetVertex(cache.indexB[0]);localPointB2=this.m_proxyB.GetVertex(cache.indexB[1]);var pA=b2Math.MulX(transformA,localPointA),dA=b2Math.MulMV(transformA.R,b2Math.SubtractVV(localPointA2,localPointA1)),pB=b2Math.MulX(transformB,localPointB),dB=b2Math.MulMV(transformB.R,b2Math.SubtractVV(localPointB2,localPointB1)),a=dA.x*dA.x+dA.y*dA.y,e=dB.x*dB.x+dB.y*dB.y,r=b2Math.SubtractVV(dB,dA),c=dA.x*r.x+dA.y*r.y,f=dB.x*r.x+dB.y*r.y,b=dA.x*dB.x+dA.y*dB.y,denom=a*e-b*b;s=0;if(denom!==0){s=b2Math.Clamp((b*f-c*e)/denom,0,1)}var t=(b*s+f)/e;if(t<0){t=0;s=b2Math.Clamp((b-c)/a,0,1)}localPointA=new b2Vec2(0,0);localPointA.x=localPointA1.x+s*(localPointA2.x-localPointA1.x);localPointA.y=localPointA1.y+s*(localPointA2.y-localPointA1.y);localPointB=new b2Vec2(0,0);localPointB.x=localPointB1.x+s*(localPointB2.x-localPointB1.x);localPointB.y=localPointB1.y+s*(localPointB2.y-localPointB1.y);if(s===0||s===1){this.m_type=b2SeparationFunction.e_faceB;this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointB2,localPointB1),1);this.m_axis.Normalize();this.m_localPoint=localPointB;tVec=this.m_axis;tMat=transformB.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointA;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);sgn=(pointAX-pointBX)*normalX+(pointAY-pointBY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}else{this.m_type=b2SeparationFunction.e_faceA;this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointA2,localPointA1),1);this.m_localPoint=localPointA;tVec=this.m_axis;tMat=transformA.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointB;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);sgn=(pointBX-pointAX)*normalX+(pointBY-pointAY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}}};b2SeparationFunction.prototype.Evaluate=function(transformA,transformB){var axisA,axisB,localPointA,localPointB,pointA,pointB,seperation=0,normal;switch(this.m_type){case b2SeparationFunction.e_points:{axisA=b2Math.MulTMV(transformA.R,this.m_axis);axisB=b2Math.MulTMV(transformB.R,this.m_axis.GetNegative());localPointA=this.m_proxyA.GetSupportVertex(axisA);localPointB=this.m_proxyB.GetSupportVertex(axisB);pointA=b2Math.MulX(transformA,localPointA);pointB=b2Math.MulX(transformB,localPointB);seperation=(pointB.x-pointA.x)*this.m_axis.x+(pointB.y-pointA.y)*this.m_axis.y;return seperation}case b2SeparationFunction.e_faceA:{normal=b2Math.MulMV(transformA.R,this.m_axis);pointA=b2Math.MulX(transformA,this.m_localPoint);axisB=b2Math.MulTMV(transformB.R,normal.GetNegative());localPointB=this.m_proxyB.GetSupportVertex(axisB);pointB=b2Math.MulX(transformB,localPointB);seperation=(pointB.x-pointA.x)*normal.x+(pointB.y-pointA.y)*normal.y;return seperation}case b2SeparationFunction.e_faceB:{normal=b2Math.MulMV(transformB.R,this.m_axis);pointB=b2Math.MulX(transformB,this.m_localPoint);axisA=b2Math.MulTMV(transformA.R,normal.GetNegative());localPointA=this.m_proxyA.GetSupportVertex(axisA);pointA=b2Math.MulX(transformA,localPointA);seperation=(pointA.x-pointB.x)*normal.x+(pointA.y-pointB.y)*normal.y;return seperation}default:b2Assert(false);return 0}};b2TimeOfImpact=Box2D.Collision.b2TimeOfImpact=function b2TimeOfImpact(){};b2TimeOfImpact.constructor=b2TimeOfImpact;b2TimeOfImpact.b2_toiCalls=0;b2TimeOfImpact.b2_toiIters=0;b2TimeOfImpact.b2_toiMaxIters=0;b2TimeOfImpact.b2_toiRootIters=0;b2TimeOfImpact.b2_toiMaxRootIters=0;b2TimeOfImpact.s_cache=new b2SimplexCache;b2TimeOfImpact.s_distanceInput=new b2DistanceInput;b2TimeOfImpact.s_xfA=new b2Transform;b2TimeOfImpact.s_xfB=new b2Transform;b2TimeOfImpact.s_fcn=new b2SeparationFunction;b2TimeOfImpact.s_distanceOutput=new b2DistanceOutput;b2TimeOfImpact.TimeOfImpact=function(input){++b2TimeOfImpact.b2_toiCalls;var proxyA=input.proxyA,proxyB=input.proxyB,sweepA=input.sweepA,sweepB=input.sweepB;b2Assert(sweepA.t0===sweepB.t0);b2Assert(1-sweepA.t0>b2Settings.b2_epsilon);var radius=proxyA.m_radius+proxyB.m_radius,tolerance=input.tolerance,alpha=0,k_maxIterations=1e3,iter=0,target=0;b2TimeOfImpact.s_cache.count=0;b2TimeOfImpact.s_distanceInput.useRadii=false;for(;;){sweepA.GetTransform(b2TimeOfImpact.s_xfA,alpha);sweepB.GetTransform(b2TimeOfImpact.s_xfB,alpha);b2TimeOfImpact.s_distanceInput.proxyA=proxyA;b2TimeOfImpact.s_distanceInput.proxyB=proxyB;b2TimeOfImpact.s_distanceInput.transformA=b2TimeOfImpact.s_xfA;b2TimeOfImpact.s_distanceInput.transformB=b2TimeOfImpact.s_xfB;b2Distance.Distance(b2TimeOfImpact.s_distanceOutput,b2TimeOfImpact.s_cache,b2TimeOfImpact.s_distanceInput);if(b2TimeOfImpact.s_distanceOutput.distance<=0){alpha=1;break}b2TimeOfImpact.s_fcn.Initialize(b2TimeOfImpact.s_cache,proxyA,b2TimeOfImpact.s_xfA,proxyB,b2TimeOfImpact.s_xfB);var separation=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(separation<=0){alpha=1;break}if(iter===0){if(separation>radius){target=b2Math.Max(radius-tolerance,.75*radius)}else{target=b2Math.Max(separation-tolerance,.02*radius)}}if(separation-target<.5*tolerance){if(iter===0){alpha=1;break}break}var newAlpha=alpha;{var x1=alpha,x2=1,f1=separation;sweepA.GetTransform(b2TimeOfImpact.s_xfA,x2);sweepB.GetTransform(b2TimeOfImpact.s_xfB,x2);var f2=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(f2>=target){alpha=1;break}var rootIterCount=0;for(;;){var x=0;if(rootIterCount&1){x=x1+(target-f1)*(x2-x1)/(f2-f1)}else{x=.5*(x1+x2)}sweepA.GetTransform(b2TimeOfImpact.s_xfA,x);sweepB.GetTransform(b2TimeOfImpact.s_xfB,x);
var f=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(b2Math.Abs(f-target)<.025*tolerance){newAlpha=x;break}if(f>target){x1=x;f1=f}else{x2=x;f2=f}++rootIterCount;++b2TimeOfImpact.b2_toiRootIters;if(rootIterCount===50){break}}b2TimeOfImpact.b2_toiMaxRootIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxRootIters,rootIterCount)}if(newAlpha<(1+100*b2Settings.b2_epsilon)*alpha){break}alpha=newAlpha;iter++;++b2TimeOfImpact.b2_toiIters;if(iter===k_maxIterations){break}}b2TimeOfImpact.b2_toiMaxIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxIters,iter);return alpha};b2TOIInput=Box2D.Collision.b2TOIInput=function b2TOIInput(){this.proxyA=new b2DistanceProxy;this.proxyB=new b2DistanceProxy;this.sweepA=new b2Sweep;this.sweepB=new b2Sweep};b2TOIInput.constructor=b2TOIInput;b2TOIInput.prototype.proxyA=null;b2TOIInput.prototype.proxyB=null;b2TOIInput.prototype.sweepA=null;b2TOIInput.prototype.sweepB=null;b2WorldManifold=Box2D.Collision.b2WorldManifold=function b2WorldManifold(){this.m_normal=new b2Vec2(0,0);this.m_points=[];for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.m_points.push(new b2Vec2(0,0))}};b2WorldManifold.constructor=b2WorldManifold;b2WorldManifold.prototype.m_normal=null;b2WorldManifold.prototype.m_points=null;b2WorldManifold.prototype.Initialize=function(manifold,xfA,radiusA,xfB,radiusB){radiusA=radiusA||0;radiusB=radiusB||0;if(manifold.m_pointCount===0){return}var i=0,tVec,tMat,normalX=0,normalY=0,planePointX=0,planePointY=0,clipPointX=0,clipPointY=0;switch(manifold.m_type){case b2Manifold.e_circles:{tMat=xfA.R;tVec=manifold.m_localPoint;var pointAX=xfA.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,pointAY=xfA.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xfB.R;tVec=manifold.m_points[0].m_localPoint;var pointBX=xfB.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,pointBY=xfB.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y,dX=pointBX-pointAX,dY=pointBY-pointAY,d2=dX*dX+dY*dY;if(d2>b2Settings.b2_epsilon*b2Settings.b2_epsilon){var d=Math.sqrt(d2);this.m_normal.x=dX/d;this.m_normal.y=dY/d}else{this.m_normal.x=1;this.m_normal.y=0}var cAX=pointAX+radiusA*this.m_normal.x,cAY=pointAY+radiusA*this.m_normal.y,cBX=pointBX-radiusB*this.m_normal.x,cBY=pointBY-radiusB*this.m_normal.y;this.m_points[0].x=.5*(cAX+cBX);this.m_points[0].y=.5*(cAY+cBY)}break;case b2Manifold.e_faceA:{tMat=xfA.R;tVec=manifold.m_localPlaneNormal;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xfA.R;tVec=manifold.m_localPoint;planePointX=xfA.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;planePointY=xfA.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_normal.x=normalX;this.m_normal.y=normalY;for(i=0;i<manifold.m_pointCount;i++){tMat=xfB.R;tVec=manifold.m_points[i].m_localPoint;clipPointX=xfB.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;clipPointY=xfB.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_points[i].x=clipPointX+.5*(radiusA-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusB)*normalX;this.m_points[i].y=clipPointY+.5*(radiusA-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusB)*normalY}}break;case b2Manifold.e_faceB:{tMat=xfB.R;tVec=manifold.m_localPlaneNormal;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xfB.R;tVec=manifold.m_localPoint;planePointX=xfB.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;planePointY=xfB.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_normal.x=-normalX;this.m_normal.y=-normalY;for(i=0;i<manifold.m_pointCount;i++){tMat=xfA.R;tVec=manifold.m_points[i].m_localPoint;clipPointX=xfA.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;clipPointY=xfA.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_points[i].x=clipPointX+.5*(radiusB-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusA)*normalX;this.m_points[i].y=clipPointY+.5*(radiusB-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusA)*normalY}}break}};b2FilterData=Box2D.Dynamics.b2FilterData=function b2FilterData(){};b2FilterData.constructor=b2FilterData;b2FilterData.prototype={categoryBits:1,maskBits:65535,groupIndex:0,Copy:function(){var copy=new b2FilterData;copy.categoryBits=this.categoryBits;copy.maskBits=this.maskBits;copy.groupIndex=this.groupIndex;return copy}};b2TimeStep=Box2D.Dynamics.b2TimeStep=function b2TimeStep(){};b2TimeStep.constructor=b2TimeStep;b2TimeStep.prototype={dt:0,inv_dt:0,positionIterations:0,velocityIterations:0,warmStarting:0,Set:function(step){this.dt=step.dt;this.inv_dt=step.inv_dt;this.positionIterations=step.positionIterations;this.velocityIterations=step.velocityIterations;this.warmStarting=step.warmStarting}};b2ContactRegister=Box2D.Dynamics.Contacts.b2ContactRegister=function b2ContactRegister(){};b2ContactRegister.constructor=b2ContactRegister;b2ContactResult=Box2D.Dynamics.Contacts.b2ContactResult=function b2ContactResult(){this.position=new b2Vec2(0,0);this.normal=new b2Vec2(0,0);this.id=new b2ContactID};b2ContactResult.constructor=b2ContactResult;b2ContactResult.prototype.position=null;b2ContactResult.prototype.normal=null;b2ContactResult.prototype.id=null;b2ContactEdge=Box2D.Dynamics.Contacts.b2ContactEdge=function b2ContactEdge(){};b2ContactEdge.constructor=b2ContactEdge;b2ContactConstraintPoint=Box2D.Dynamics.Contacts.b2ContactConstraintPoint=function b2ContactConstraintPoint(){this.localPoint=new b2Vec2(0,0);this.rA=new b2Vec2(0,0);this.rB=new b2Vec2(0,0)};b2ContactConstraintPoint.constructor=b2ContactConstraintPoint;b2ContactConstraintPoint.prototype.localPoint=null;b2ContactConstraintPoint.prototype.rA=null;b2ContactConstraintPoint.prototype.rB=null;b2ContactConstraint=Box2D.Dynamics.Contacts.b2ContactConstraint=function b2ContactConstraint(){this.localPlaneNormal=new b2Vec2(0,0);this.localPoint=new b2Vec2(0,0);this.normal=new b2Vec2(0,0);this.normalMass=new b2Mat22;this.K=new b2Mat22;this.points=[];for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.points.push(new b2ContactConstraintPoint)}};b2ContactConstraint.constructor=b2ContactConstraint;b2ContactConstraint.prototype.localPlaneNormal=null;b2ContactConstraint.prototype.localPoint=null;b2ContactConstraint.prototype.normal=null;b2ContactConstraint.prototype.normalMass=null;b2ContactConstraint.prototype.K=null;b2ContactConstraint.prototype.points=null;b2Contact=Box2D.Dynamics.Contacts.b2Contact=function b2Contact(){this.m_nodeA=new b2ContactEdge;this.m_nodeB=new b2ContactEdge;this.m_manifold=new b2Manifold;this.m_oldManifold=new b2Manifold};b2Contact.constructor=b2Contact;b2Contact.e_sensorFlag=1;b2Contact.e_continuousFlag=2;b2Contact.e_islandFlag=4;b2Contact.e_toiFlag=8;b2Contact.e_touchingFlag=16;b2Contact.e_enabledFlag=32;b2Contact.e_filterFlag=64;b2Contact.s_input=new b2TOIInput;b2Contact.prototype.m_flags=0;b2Contact.prototype.m_next=null;b2Contact.prototype.m_prev=null;b2Contact.prototype.m_nodeA=null;b2Contact.prototype.m_nodeB=null;b2Contact.prototype.m_manifold=null;b2Contact.prototype.m_oldManifold=null;b2Contact.prototype.m_fixtureA=null;b2Contact.prototype.m_fixtureB=null;b2Contact.prototype.m_touching=false;b2Contact.prototype.GetManifold=function(){return this.m_manifold};b2Contact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2Contact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2Contact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2Contact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2Contact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2Contact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2Contact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2Contact.prototype.GetNext=function(){return this.m_next};b2Contact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2Contact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2Contact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2Contact.prototype.Reset=function(fixtureA,fixtureB){fixtureA=fixtureA||null;fixtureB=fixtureB||null;this.m_flags=b2Contact.e_enabledFlag;if(!fixtureA||!fixtureB){this.m_fixtureA=null;this.m_fixtureB=null;return}if(fixtureA.IsSensor()||fixtureB.IsSensor()){this.m_flags|=b2Contact.e_sensorFlag}var bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}this.m_fixtureA=fixtureA;this.m_fixtureB=fixtureB;this.m_manifold.m_pointCount=0;this.m_prev=null;this.m_next=null;this.m_nodeA.contact=null;this.m_nodeA.prev=null;this.m_nodeA.next=null;this.m_nodeA.other=null;this.m_nodeB.contact=null;this.m_nodeB.prev=null;this.m_nodeB.next=null;this.m_nodeB.other=null};b2Contact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2Contact.prototype.Evaluate=function(){};b2Contact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2CircleContact=Box2D.Dynamics.Contacts.b2CircleContact=function b2CircleContact(){b2Contact.apply(this,arguments)};b2CircleContact.constructor=b2CircleContact;b2CircleContact.prototype=Object.create(b2Contact.prototype);b2CircleContact.Create=function(allocator){return new b2CircleContact};b2CircleContact.Destroy=function(contact,allocator){};b2CircleContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB)};b2CircleContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();b2Collision.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2CircleShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2CircleShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2CircleContact.prototype.GetManifold=function(){return this.m_manifold};b2CircleContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2CircleContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2CircleContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2CircleContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2CircleContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2CircleContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2CircleContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2CircleContact.prototype.GetNext=function(){return this.m_next};b2CircleContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2CircleContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2CircleContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2CircleContact.prototype.b2Contact=function(){};b2CircleContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2CircleContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PositionSolverManifold=Box2D.Dynamics.Contacts.b2PositionSolverManifold=function b2PositionSolverManifold(){this.m_normal=new b2Vec2(0,0);this.m_separations=[];var i=b2Settings.b2_maxManifoldPoints;while(i){this.m_separations.push(0);i--}this.m_points=[];for(i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.m_points.push(new b2Vec2(0,0))}};b2PositionSolverManifold.constructor=b2PositionSolverManifold;b2PositionSolverManifold.circlePointA=new b2Vec2(0,0);b2PositionSolverManifold.circlePointB=new b2Vec2(0,0);b2PositionSolverManifold.prototype.m_normal=null;b2PositionSolverManifold.prototype.m_separations=null;b2PositionSolverManifold.prototype.m_points=null;b2PositionSolverManifold.prototype.Initialize=function(cc){b2Assert(cc.pointCount>0);var i=0,clipPointX=0,clipPointY=0,tMat,tVec,planePointX=0,planePointY=0;switch(cc.type){case b2Manifold.e_circles:{tMat=cc.bodyA.m_xf.R;tVec=cc.localPoint;var pointAX=cc.bodyA.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),pointAY=cc.bodyA.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=cc.bodyB.m_xf.R;tVec=cc.points[0].localPoint;var pointBX=cc.bodyB.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),pointBY=cc.bodyB.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y),dX=pointBX-pointAX,dY=pointBY-pointAY,d2=dX*dX+dY*dY;if(d2>b2Settings.b2_epsilon*b2Settings.b2_epsilon){var d=Math.sqrt(d2);this.m_normal.x=dX/d;this.m_normal.y=dY/d}else{this.m_normal.x=1;this.m_normal.y=0}this.m_points[0].x=.5*(pointAX+pointBX);this.m_points[0].y=.5*(pointAY+pointBY);this.m_separations[0]=dX*this.m_normal.x+dY*this.m_normal.y-cc.radius}break;case b2Manifold.e_faceA:{tMat=cc.bodyA.m_xf.R;tVec=cc.localPlaneNormal;this.m_normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=cc.bodyA.m_xf.R;tVec=cc.localPoint;planePointX=cc.bodyA.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);planePointY=cc.bodyA.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=cc.bodyB.m_xf.R;for(i=0;i<cc.pointCount;++i){tVec=cc.points[i].localPoint;clipPointX=cc.bodyB.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);clipPointY=cc.bodyB.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);this.m_separations[i]=(clipPointX-planePointX)*this.m_normal.x+(clipPointY-planePointY)*this.m_normal.y-cc.radius;this.m_points[i].x=clipPointX;this.m_points[i].y=clipPointY}}break;case b2Manifold.e_faceB:{tMat=cc.bodyB.m_xf.R;tVec=cc.localPlaneNormal;this.m_normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=cc.bodyB.m_xf.R;tVec=cc.localPoint;planePointX=cc.bodyB.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);planePointY=cc.bodyB.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=cc.bodyA.m_xf.R;for(i=0;i<cc.pointCount;++i){tVec=cc.points[i].localPoint;clipPointX=cc.bodyA.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);clipPointY=cc.bodyA.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);this.m_separations[i]=(clipPointX-planePointX)*this.m_normal.x+(clipPointY-planePointY)*this.m_normal.y-cc.radius;this.m_points[i].Set(clipPointX,clipPointY)}this.m_normal.x*=-1;this.m_normal.y*=-1}break}};b2ContactSolver=Box2D.Dynamics.Contacts.b2ContactSolver=function b2ContactSolver(){this.m_step=new b2TimeStep;this.m_constraints=[]};b2ContactSolver.constructor=b2ContactSolver;b2ContactSolver.prototype.m_step=null;b2ContactSolver.prototype.m_constraints=null;b2ContactSolver.prototype.m_allocator=null;b2ContactSolver.prototype.m_constraintCount=0;b2ContactSolver.s_worldManifold=new b2WorldManifold;b2ContactSolver.s_psm=new b2PositionSolverManifold;b2ContactSolver.prototype.Initialize=function(step,contacts,contactCount,allocator){contactCount=contactCount||0;var contact;this.m_step.Set(step);this.m_allocator=allocator;var i=0,tVec,tMat;this.m_constraintCount=contactCount;while(this.m_constraints.length<this.m_constraintCount){this.m_constraints[this.m_constraints.length]=new b2ContactConstraint}for(i=0;i<contactCount;++i){contact=contacts[i];var fixtureA=contact.m_fixtureA,fixtureB=contact.m_fixtureB,shapeA=fixtureA.m_shape,shapeB=fixtureB.m_shape,radiusA=shapeA.m_radius,radiusB=shapeB.m_radius,bodyA=fixtureA.m_body,bodyB=fixtureB.m_body,manifold=contact.GetManifold(),friction=b2Settings.b2MixFriction(fixtureA.GetFriction(),fixtureB.GetFriction()),restitution=b2Settings.b2MixRestitution(fixtureA.GetRestitution(),fixtureB.GetRestitution()),vAX=bodyA.m_linearVelocity.x,vAY=bodyA.m_linearVelocity.y,vBX=bodyB.m_linearVelocity.x,vBY=bodyB.m_linearVelocity.y,wA=bodyA.m_angularVelocity,wB=bodyB.m_angularVelocity;b2Assert(manifold.m_pointCount>0);b2ContactSolver.s_worldManifold.Initialize(manifold,bodyA.m_xf,radiusA,bodyB.m_xf,radiusB);var normalX=b2ContactSolver.s_worldManifold.m_normal.x,normalY=b2ContactSolver.s_worldManifold.m_normal.y,cc=this.m_constraints[i];cc.bodyA=bodyA;cc.bodyB=bodyB;cc.manifold=manifold;cc.normal.x=normalX;cc.normal.y=normalY;cc.pointCount=manifold.m_pointCount;cc.friction=friction;cc.restitution=restitution;cc.localPlaneNormal.x=manifold.m_localPlaneNormal.x;cc.localPlaneNormal.y=manifold.m_localPlaneNormal.y;cc.localPoint.x=manifold.m_localPoint.x;cc.localPoint.y=manifold.m_localPoint.y;cc.radius=radiusA+radiusB;cc.type=manifold.m_type;for(var k=0;k<cc.pointCount;++k){var cp=manifold.m_points[k],ccp=cc.points[k];ccp.normalImpulse=cp.m_normalImpulse;ccp.tangentImpulse=cp.m_tangentImpulse;ccp.localPoint.SetV(cp.m_localPoint);var rAX=ccp.rA.x=b2ContactSolver.s_worldManifold.m_points[k].x-bodyA.m_sweep.c.x,rAY=ccp.rA.y=b2ContactSolver.s_worldManifold.m_points[k].y-bodyA.m_sweep.c.y,rBX=ccp.rB.x=b2ContactSolver.s_worldManifold.m_points[k].x-bodyB.m_sweep.c.x,rBY=ccp.rB.y=b2ContactSolver.s_worldManifold.m_points[k].y-bodyB.m_sweep.c.y,rnA=rAX*normalY-rAY*normalX,rnB=rBX*normalY-rBY*normalX;rnA*=rnA;rnB*=rnB;var kNormal=bodyA.m_invMass+bodyB.m_invMass+bodyA.m_invI*rnA+bodyB.m_invI*rnB;ccp.normalMass=1/kNormal;var kEqualized=bodyA.m_mass*bodyA.m_invMass+bodyB.m_mass*bodyB.m_invMass;kEqualized+=bodyA.m_mass*bodyA.m_invI*rnA+bodyB.m_mass*bodyB.m_invI*rnB;ccp.equalizedMass=1/kEqualized;var tangentX=normalY,tangentY=-normalX,rtA=rAX*tangentY-rAY*tangentX,rtB=rBX*tangentY-rBY*tangentX;rtA*=rtA;rtB*=rtB;var kTangent=bodyA.m_invMass+bodyB.m_invMass+bodyA.m_invI*rtA+bodyB.m_invI*rtB;ccp.tangentMass=1/kTangent;ccp.velocityBias=0;var tX=vBX+-wB*rBY-vAX- -wA*rAY,tY=vBY+wB*rBX-vAY-wA*rAX,vRel=cc.normal.x*tX+cc.normal.y*tY;if(vRel<-b2Settings.b2_velocityThreshold){ccp.velocityBias+=-cc.restitution*vRel}}if(cc.pointCount===2){var ccp1=cc.points[0],ccp2=cc.points[1],invMassA=bodyA.m_invMass,invIA=bodyA.m_invI,invMassB=bodyB.m_invMass,invIB=bodyB.m_invI,rn1A=ccp1.rA.x*normalY-ccp1.rA.y*normalX,rn1B=ccp1.rB.x*normalY-ccp1.rB.y*normalX,rn2A=ccp2.rA.x*normalY-ccp2.rA.y*normalX,rn2B=ccp2.rB.x*normalY-ccp2.rB.y*normalX,k11=invMassA+invMassB+invIA*rn1A*rn1A+invIB*rn1B*rn1B,k22=invMassA+invMassB+invIA*rn2A*rn2A+invIB*rn2B*rn2B,k12=invMassA+invMassB+invIA*rn1A*rn2A+invIB*rn1B*rn2B,k_maxConditionNumber=100;if(k11*k11<k_maxConditionNumber*(k11*k22-k12*k12)){cc.K.col1.Set(k11,k12);cc.K.col2.Set(k12,k22);cc.K.GetInverse(cc.normalMass)}else{cc.pointCount=1}}}};b2ContactSolver.prototype.InitVelocityConstraints=function(step){var tVec,tVec2,tMat;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i],bodyA=c.bodyA,bodyB=c.bodyB,invMassA=bodyA.m_invMass,invIA=bodyA.m_invI,invMassB=bodyB.m_invMass,invIB=bodyB.m_invI,normalX=c.normal.x,normalY=c.normal.y,tangentX=normalY,tangentY=-normalX,tX=0,j=0,tCount=0;if(step.warmStarting){tCount=c.pointCount;for(j=0;j<tCount;++j){var ccp=c.points[j];ccp.normalImpulse*=step.dtRatio;ccp.tangentImpulse*=step.dtRatio;var PX=ccp.normalImpulse*normalX+ccp.tangentImpulse*tangentX,PY=ccp.normalImpulse*normalY+ccp.tangentImpulse*tangentY;bodyA.m_angularVelocity-=invIA*(ccp.rA.x*PY-ccp.rA.y*PX);bodyA.m_linearVelocity.x-=invMassA*PX;bodyA.m_linearVelocity.y-=invMassA*PY;bodyB.m_angularVelocity+=invIB*(ccp.rB.x*PY-ccp.rB.y*PX);bodyB.m_linearVelocity.x+=invMassB*PX;bodyB.m_linearVelocity.y+=invMassB*PY}}else{tCount=c.pointCount;for(j=0;j<tCount;++j){var ccp2=c.points[j];ccp2.normalImpulse=0;ccp2.tangentImpulse=0}}}};b2ContactSolver.prototype.SolveVelocityConstraints=function(){var j=0,ccp,rAX=0,rAY=0,rBX=0,rBY=0,dvX=0,dvY=0,vn=0,vt=0,lambda=0,maxFriction=0,newImpulse=0,PX=0,PY=0,dX=0,dY=0,P1X=0,P1Y=0,P2X=0,P2Y=0,tMat,tVec;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i],bodyA=c.bodyA,bodyB=c.bodyB,wA=bodyA.m_angularVelocity,wB=bodyB.m_angularVelocity,vA=bodyA.m_linearVelocity,vB=bodyB.m_linearVelocity,invMassA=bodyA.m_invMass,invIA=bodyA.m_invI,invMassB=bodyB.m_invMass,invIB=bodyB.m_invI,normalX=c.normal.x,normalY=c.normal.y,tangentX=normalY,tangentY=-normalX,friction=c.friction,tX=0;for(j=0;j<c.pointCount;j++){ccp=c.points[j];dvX=vB.x-wB*ccp.rB.y-vA.x+wA*ccp.rA.y;dvY=vB.y+wB*ccp.rB.x-vA.y-wA*ccp.rA.x;vt=dvX*tangentX+dvY*tangentY;lambda=ccp.tangentMass*-vt;maxFriction=friction*ccp.normalImpulse;newImpulse=b2Math.Clamp(ccp.tangentImpulse+lambda,-maxFriction,maxFriction);lambda=newImpulse-ccp.tangentImpulse;PX=lambda*tangentX;PY=lambda*tangentY;vA.x-=invMassA*PX;vA.y-=invMassA*PY;wA-=invIA*(ccp.rA.x*PY-ccp.rA.y*PX);vB.x+=invMassB*PX;vB.y+=invMassB*PY;wB+=invIB*(ccp.rB.x*PY-ccp.rB.y*PX);ccp.tangentImpulse=newImpulse}var tCount=c.pointCount;if(c.pointCount===1){ccp=c.points[0];dvX=vB.x+-wB*ccp.rB.y-vA.x- -wA*ccp.rA.y;dvY=vB.y+wB*ccp.rB.x-vA.y-wA*ccp.rA.x;vn=dvX*normalX+dvY*normalY;lambda=-ccp.normalMass*(vn-ccp.velocityBias);newImpulse=ccp.normalImpulse+lambda;newImpulse=newImpulse>0?newImpulse:0;lambda=newImpulse-ccp.normalImpulse;PX=lambda*normalX;PY=lambda*normalY;vA.x-=invMassA*PX;vA.y-=invMassA*PY;wA-=invIA*(ccp.rA.x*PY-ccp.rA.y*PX);vB.x+=invMassB*PX;vB.y+=invMassB*PY;wB+=invIB*(ccp.rB.x*PY-ccp.rB.y*PX);ccp.normalImpulse=newImpulse}else{var cp1=c.points[0],cp2=c.points[1],aX=cp1.normalImpulse,aY=cp2.normalImpulse,dv1X=vB.x-wB*cp1.rB.y-vA.x+wA*cp1.rA.y,dv1Y=vB.y+wB*cp1.rB.x-vA.y-wA*cp1.rA.x,dv2X=vB.x-wB*cp2.rB.y-vA.x+wA*cp2.rA.y,dv2Y=vB.y+wB*cp2.rB.x-vA.y-wA*cp2.rA.x,vn1=dv1X*normalX+dv1Y*normalY,vn2=dv2X*normalX+dv2Y*normalY,bX=vn1-cp1.velocityBias,bY=vn2-cp2.velocityBias;tMat=c.K;bX-=tMat.col1.x*aX+tMat.col2.x*aY;bY-=tMat.col1.y*aX+tMat.col2.y*aY;var k_errorTol=.001;for(;;){tMat=c.normalMass;var xX=-(tMat.col1.x*bX+tMat.col2.x*bY),xY=-(tMat.col1.y*bX+tMat.col2.y*bY);if(xX>=0&&xY>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}xX=-cp1.normalMass*bX;xY=0;vn1=0;vn2=c.K.col1.y*xX+bY;if(xX>=0&&vn2>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}xX=0;xY=-cp2.normalMass*bY;vn1=c.K.col2.x*xY+bX;vn2=0;if(xY>=0&&vn1>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}xX=0;xY=0;vn1=bX;vn2=bY;if(vn1>=0&&vn2>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}break}}bodyA.m_angularVelocity=wA;bodyB.m_angularVelocity=wB}};b2ContactSolver.prototype.FinalizeVelocityConstraints=function(){for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i],m=c.manifold;for(var j=0;j<c.pointCount;++j){var point1=m.m_points[j],point2=c.points[j];point1.m_normalImpulse=point2.normalImpulse;point1.m_tangentImpulse=point2.tangentImpulse}}};b2ContactSolver.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var minSeparation=0;for(var i=0;i<this.m_constraintCount;i++){var c=this.m_constraints[i],bodyA=c.bodyA,bodyB=c.bodyB,invMassA=bodyA.m_mass*bodyA.m_invMass,invIA=bodyA.m_mass*bodyA.m_invI,invMassB=bodyB.m_mass*bodyB.m_invMass,invIB=bodyB.m_mass*bodyB.m_invI;b2ContactSolver.s_psm.Initialize(c);var normal=b2ContactSolver.s_psm.m_normal;for(var j=0;j<c.pointCount;j++){var ccp=c.points[j],point=b2ContactSolver.s_psm.m_points[j],separation=b2ContactSolver.s_psm.m_separations[j],rAX=point.x-bodyA.m_sweep.c.x,rAY=point.y-bodyA.m_sweep.c.y,rBX=point.x-bodyB.m_sweep.c.x,rBY=point.y-bodyB.m_sweep.c.y;minSeparation=minSeparation<separation?minSeparation:separation;var C=b2Math.Clamp(baumgarte*(separation+b2Settings.b2_linearSlop),-b2Settings.b2_maxLinearCorrection,0),impulse=-ccp.equalizedMass*C,PX=impulse*normal.x,PY=impulse*normal.y;bodyA.m_sweep.c.x-=invMassA*PX;bodyA.m_sweep.c.y-=invMassA*PY;bodyA.m_sweep.a-=invIA*(rAX*PY-rAY*PX);bodyA.SynchronizeTransform();bodyB.m_sweep.c.x+=invMassB*PX;bodyB.m_sweep.c.y+=invMassB*PY;bodyB.m_sweep.a+=invIB*(rBX*PY-rBY*PX);bodyB.SynchronizeTransform()}}return minSeparation>-1.5*b2Settings.b2_linearSlop};b2EdgeAndCircleContact=Box2D.Dynamics.Contacts.b2EdgeAndCircleContact=function b2EdgeAndCircleContact(){b2Contact.call(this)};b2EdgeAndCircleContact.constructor=b2EdgeAndCircleContact;b2EdgeAndCircleContact.prototype=Object.create(b2Contact.prototype);b2EdgeAndCircleContact.Create=function(allocator){return new b2EdgeAndCircleContact};b2EdgeAndCircleContact.Destroy=function(contact,allocator){};b2EdgeAndCircleContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB)};b2EdgeAndCircleContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2EdgeShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2CircleShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2EdgeAndCircleContact.prototype.b2CollideEdgeAndCircle=function(manifold,edge,xf1,circle,xf2){};b2EdgeAndCircleContact.prototype.GetManifold=function(){return this.m_manifold};b2EdgeAndCircleContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2EdgeAndCircleContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2EdgeAndCircleContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2EdgeAndCircleContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2EdgeAndCircleContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2EdgeAndCircleContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2EdgeAndCircleContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2EdgeAndCircleContact.prototype.GetNext=function(){return this.m_next};b2EdgeAndCircleContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2EdgeAndCircleContact.prototype.GetFixtureB=function(){return this.m_fixtureB
};b2EdgeAndCircleContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2EdgeAndCircleContact.prototype.b2Contact=function(){};b2EdgeAndCircleContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2EdgeAndCircleContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2NullContact=Box2D.Dynamics.Contacts.b2NullContact=function b2NullContact(){b2Contact.call(this)};b2NullContact.constructor=b2NullContact;b2NullContact.prototype=Object.create(b2Contact.prototype);b2NullContact.prototype.Evaluate=function(){};b2NullContact.prototype.GetManifold=function(){return this.m_manifold};b2NullContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2NullContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2NullContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2NullContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2NullContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2NullContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2NullContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2NullContact.prototype.GetNext=function(){return this.m_next};b2NullContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2NullContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2NullContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2NullContact.prototype.b2Contact=function(){};b2NullContact.prototype.Reset=function(fixtureA,fixtureB){fixtureA=fixtureA||null;fixtureB=fixtureB||null;this.m_flags=b2Contact.e_enabledFlag;if(!fixtureA||!fixtureB){this.m_fixtureA=null;this.m_fixtureB=null;return}if(fixtureA.IsSensor()||fixtureB.IsSensor()){this.m_flags|=b2Contact.e_sensorFlag}var bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}this.m_fixtureA=fixtureA;this.m_fixtureB=fixtureB;this.m_manifold.m_pointCount=0;this.m_prev=null;this.m_next=null;this.m_nodeA.contact=null;this.m_nodeA.prev=null;this.m_nodeA.next=null;this.m_nodeA.other=null;this.m_nodeB.contact=null;this.m_nodeB.prev=null;this.m_nodeB.next=null;this.m_nodeB.other=null};b2NullContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2NullContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PolyAndCircleContact=Box2D.Dynamics.Contacts.b2PolyAndCircleContact=function b2PolyAndCircleContact(){b2Contact.call(this)};b2PolyAndCircleContact.constructor=b2PolyAndCircleContact;b2PolyAndCircleContact.prototype=Object.create(b2Contact.prototype);b2PolyAndCircleContact.Create=function(allocator){return new b2PolyAndCircleContact};b2PolyAndCircleContact.Destroy=function(contact,allocator){};b2PolyAndCircleContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB);b2Assert(fixtureA.GetType()===b2Shape.e_polygonShape);b2Assert(fixtureB.GetType()===b2Shape.e_circleShape)};b2PolyAndCircleContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.m_body,bB=this.m_fixtureB.m_body;b2Collision.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2PolygonShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2CircleShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2PolyAndCircleContact.prototype.GetManifold=function(){return this.m_manifold};b2PolyAndCircleContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2PolyAndCircleContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2PolyAndCircleContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2PolyAndCircleContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2PolyAndCircleContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2PolyAndCircleContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2PolyAndCircleContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2PolyAndCircleContact.prototype.GetNext=function(){return this.m_next};b2PolyAndCircleContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2PolyAndCircleContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2PolyAndCircleContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2PolyAndCircleContact.prototype.b2Contact=function(){};b2PolyAndCircleContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2PolyAndCircleContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PolyAndEdgeContact=Box2D.Dynamics.Contacts.b2PolyAndEdgeContact=function b2PolyAndEdgeContact(){b2Contact.call(this)};b2PolyAndEdgeContact.constructor=b2PolyAndEdgeContact;b2PolyAndEdgeContact.prototype=Object.create(b2Contact.prototype);b2PolyAndEdgeContact.Create=function(allocator){return new b2PolyAndEdgeContact};b2PolyAndEdgeContact.Destroy=function(contact,allocator){};b2PolyAndEdgeContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB);b2Assert(fixtureA.GetType()===b2Shape.e_polygonShape);b2Assert(fixtureB.GetType()===b2Shape.e_edgeShape)};b2PolyAndEdgeContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2PolygonShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2EdgeShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2PolyAndEdgeContact.prototype.b2CollidePolyAndEdge=function(manifold,polygon,xf1,edge,xf2){};b2PolyAndEdgeContact.prototype.GetManifold=function(){return this.m_manifold};b2PolyAndEdgeContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2PolyAndEdgeContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2PolyAndEdgeContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2PolyAndEdgeContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2PolyAndEdgeContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2PolyAndEdgeContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2PolyAndEdgeContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2PolyAndEdgeContact.prototype.GetNext=function(){return this.m_next};b2PolyAndEdgeContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2PolyAndEdgeContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2PolyAndEdgeContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2PolyAndEdgeContact.prototype.b2Contact=function(){};b2PolyAndEdgeContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2PolyAndEdgeContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PolygonContact=Box2D.Dynamics.Contacts.b2PolygonContact=function b2PolygonContact(){b2Contact.call(this)};b2PolygonContact.constructor=b2PolygonContact;b2PolygonContact.prototype=Object.create(b2Contact.prototype);b2PolygonContact.Create=function(allocator){return new b2PolygonContact};b2PolygonContact.Destroy=function(contact,allocator){};b2PolygonContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB)};b2PolygonContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();b2Collision.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2PolygonShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2PolygonShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2PolygonContact.prototype.GetManifold=function(){return this.m_manifold};b2PolygonContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2PolygonContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag};b2PolygonContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)===b2Contact.e_continuousFlag};b2PolygonContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2PolygonContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)===b2Contact.e_sensorFlag};b2PolygonContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2PolygonContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)===b2Contact.e_enabledFlag};b2PolygonContact.prototype.GetNext=function(){return this.m_next};b2PolygonContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2PolygonContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2PolygonContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2PolygonContact.prototype.b2Contact=function(){};b2PolygonContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)===b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!==b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!==b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key===id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!==wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching===false&&touching===true){listener.BeginContact(this)}if(wasTouching===true&&touching===false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)===0){listener.PreSolve(this,this.m_oldManifold)}};b2PolygonContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2ContactFactory=Box2D.Dynamics.Contacts.b2ContactFactory=function b2ContactFactory(allocator){this.m_allocator=allocator;this.InitializeRegisters()};b2ContactFactory.constructor=b2ContactFactory;b2ContactFactory.prototype.m_allocator=null;b2ContactFactory.prototype.m_registers=null;b2ContactFactory.prototype.AddType=function(createFcn,destroyFcn,type1,type2){this.m_registers[type1][type2].createFcn=createFcn;this.m_registers[type1][type2].destroyFcn=destroyFcn;this.m_registers[type1][type2].primary=true;if(type1!==type2){this.m_registers[type2][type1].createFcn=createFcn;this.m_registers[type2][type1].destroyFcn=destroyFcn;this.m_registers[type2][type1].primary=false}};b2ContactFactory.prototype.InitializeRegisters=function(){this.m_registers=[];for(var i=0;i<b2Shape.e_shapeTypeCount;i++){this.m_registers.push([]);for(var j=0;j<b2Shape.e_shapeTypeCount;j++){this.m_registers[i].push(new b2ContactRegister)}}this.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape);this.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_circleShape);this.AddType(b2PolygonContact.Create,b2PolygonContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_polygonShape);this.AddType(b2EdgeAndCircleContact.Create,b2EdgeAndCircleContact.Destroy,b2Shape.e_edgeShape,b2Shape.e_circleShape);this.AddType(b2PolyAndEdgeContact.Create,b2PolyAndEdgeContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_edgeShape)};b2ContactFactory.prototype.Create=function(fixtureA,fixtureB){var type1=fixtureA.GetType(),type2=fixtureB.GetType(),reg=this.m_registers[type1][type2],c;if(reg.pool){c=reg.pool;reg.pool=c.m_next;reg.poolCount--;c.Reset(fixtureA,fixtureB);return c}var createFcn=reg.createFcn;if(createFcn!=null){if(reg.primary){c=createFcn(this.m_allocator);c.Reset(fixtureA,fixtureB);return c}else{c=createFcn(this.m_allocator);c.Reset(fixtureB,fixtureA);return c}}else{return null}};b2ContactFactory.prototype.Destroy=function(contact){if(contact.m_manifold.m_pointCount>0){contact.m_fixtureA.m_body.SetAwake(true);contact.m_fixtureB.m_body.SetAwake(true)}var type1=contact.m_fixtureA.GetType(),type2=contact.m_fixtureB.GetType(),reg=this.m_registers[type1][type2];reg.poolCount++;contact.m_next=reg.pool;reg.pool=contact;var destroyFcn=reg.destroyFcn;destroyFcn(contact,this.m_allocator)};b2ControllerEdge=Box2D.Dynamics.Controllers.b2ControllerEdge=function b2ControllerEdge(){};b2ControllerEdge.constructor=b2ControllerEdge;b2Controller=Box2D.Dynamics.Controllers.b2Controller=function b2Controller(){};b2Controller.constructor=b2Controller;b2Controller.prototype.m_bodyList=null;b2Controller.prototype.m_bodyCount=0;b2Controller.prototype.m_next=null;b2Controller.prototype.m_world=null;b2Controller.prototype.Step=function(step){};b2Controller.prototype.Draw=function(debugDraw){};b2Controller.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2Controller.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!==this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList===edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList===edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2Controller.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2Controller.prototype.GetNext=function(){return this.m_next};b2Controller.prototype.GetWorld=function(){return this.m_world};b2Controller.prototype.GetBodyList=function(){return this.m_bodyList};b2BuoyancyController=Box2D.Dynamics.Controllers.b2BuoyancyController=function b2BuoyancyController(){this.normal=new b2Vec2(0,-1);this.velocity=new b2Vec2(0,0)};b2BuoyancyController.constructor=b2BuoyancyController;b2BuoyancyController.prototype=Object.create(b2Controller.prototype);b2BuoyancyController.prototype.normal=null;b2BuoyancyController.prototype.offset=0;b2BuoyancyController.prototype.density=0;b2BuoyancyController.prototype.velocity=null;b2BuoyancyController.prototype.linearDrag=2;b2BuoyancyController.prototype.angularDrag=1;b2BuoyancyController.prototype.useDensity=false;b2BuoyancyController.prototype.useWorldGravity=true;b2BuoyancyController.prototype.gravity=null;b2BuoyancyController.prototype.Step=function(step){if(!this.m_bodyList)return;if(this.useWorldGravity){this.gravity=this.GetWorld().GetGravity().Copy()}for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(body.IsAwake()===false){continue}var areac=new b2Vec2(0,0),massc=new b2Vec2(0,0),area=0,mass=0;for(var fixture=body.GetFixtureList();fixture;fixture=fixture.GetNext()){var sc=new b2Vec2(0,0),sarea=fixture.GetShape().ComputeSubmergedArea(this.normal,this.offset,body.GetTransform(),sc);area+=sarea;areac.x+=sarea*sc.x;areac.y+=sarea*sc.y;var shapeDensity=0;if(this.useDensity){shapeDensity=1}else{shapeDensity=1}mass+=sarea*shapeDensity;massc.x+=sarea*sc.x*shapeDensity;massc.y+=sarea*sc.y*shapeDensity}areac.x/=area;areac.y/=area;massc.x/=mass;massc.y/=mass;if(area<b2Settings.b2_epsilon)continue;var buoyancyForce=this.gravity.GetNegative();buoyancyForce.Multiply(this.density*area);body.ApplyForce(buoyancyForce,massc);var dragForce=body.GetLinearVelocityFromWorldPoint(areac);dragForce.Subtract(this.velocity);dragForce.Multiply(-this.linearDrag*area);body.ApplyForce(dragForce,areac);body.ApplyTorque(-body.GetInertia()/body.GetMass()*area*body.GetAngularVelocity()*this.angularDrag)}};b2BuoyancyController.prototype.Draw=function(debugDraw){var r=1e3,p1=new b2Vec2(0,0),p2=new b2Vec2(0,0);p1.x=this.normal.x*this.offset+this.normal.y*r;p1.y=this.normal.y*this.offset-this.normal.x*r;p2.x=this.normal.x*this.offset-this.normal.y*r;p2.y=this.normal.y*this.offset+this.normal.x*r;var color=new b2Color(0,0,1);debugDraw.DrawSegment(p1,p2,color)};b2BuoyancyController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2BuoyancyController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!==this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList===edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList===edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2BuoyancyController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2BuoyancyController.prototype.GetNext=function(){return this.m_next};b2BuoyancyController.prototype.GetWorld=function(){return this.m_world};b2BuoyancyController.prototype.GetBodyList=function(){return this.m_bodyList};b2ConstantAccelController=Box2D.Dynamics.Controllers.b2ConstantAccelController=function b2ConstantAccelController(){this.A=new b2Vec2(0,0)};b2ConstantAccelController.constructor=b2ConstantAccelController;b2ConstantAccelController.prototype=Object.create(b2Controller.prototype);b2ConstantAccelController.prototype.A=null;b2ConstantAccelController.prototype.Step=function(step){var smallA=new b2Vec2(this.A.x*step.dt,this.A.y*step.dt);for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(!body.IsAwake())continue;body.SetLinearVelocity(new b2Vec2(body.GetLinearVelocity().x+smallA.x,body.GetLinearVelocity().y+smallA.y))}};b2ConstantAccelController.prototype.Draw=function(debugDraw){};b2ConstantAccelController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2ConstantAccelController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!==this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList===edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList===edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2ConstantAccelController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2ConstantAccelController.prototype.GetNext=function(){return this.m_next};b2ConstantAccelController.prototype.GetWorld=function(){return this.m_world};b2ConstantAccelController.prototype.GetBodyList=function(){return this.m_bodyList};b2ConstantForceController=Box2D.Dynamics.Controllers.b2ConstantForceController=function b2ConstantForceController(){this.F=new b2Vec2(0,0)};b2ConstantForceController.constructor=b2ConstantForceController;b2ConstantForceController.prototype=Object.create(b2Controller.prototype);b2ConstantForceController.prototype.F=null;b2ConstantForceController.prototype.Step=function(step){for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(!body.IsAwake())continue;body.ApplyForce(this.F,body.GetWorldCenter())}};b2ConstantForceController.prototype.Draw=function(debugDraw){};b2ConstantForceController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2ConstantForceController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!==this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;
if(this.m_bodyList===edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList===edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2ConstantForceController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2ConstantForceController.prototype.GetNext=function(){return this.m_next};b2ConstantForceController.prototype.GetWorld=function(){return this.m_world};b2ConstantForceController.prototype.GetBodyList=function(){return this.m_bodyList};b2GravityController=Box2D.Dynamics.Controllers.b2GravityController=function b2GravityController(){};b2GravityController.constructor=b2GravityController;b2GravityController.prototype=Object.create(b2Controller.prototype);b2GravityController.prototype.G=1;b2GravityController.prototype.invSqr=true;b2GravityController.prototype.Step=function(step){var i=null,body1=null,p1=null,mass1=0,j=null,body2=null,p2=null,dx=0,dy=0,r2=0,f=null;if(this.invSqr){for(i=this.m_bodyList;i;i=i.nextBody){body1=i.body;p1=body1.GetWorldCenter();mass1=body1.GetMass();for(j=this.m_bodyList;j!==i;j=j.nextBody){body2=j.body;p2=body2.GetWorldCenter();dx=p2.x-p1.x;dy=p2.y-p1.y;r2=dx*dx+dy*dy;if(r2<b2Settings.b2_epsilon)continue;f=new b2Vec2(dx,dy);f.Multiply(this.G/r2/Math.sqrt(r2)*mass1*body2.GetMass());if(body1.IsAwake())body1.ApplyForce(f,p1);f.Multiply(-1);if(body2.IsAwake())body2.ApplyForce(f,p2)}}}else{for(i=this.m_bodyList;i;i=i.nextBody){body1=i.body;p1=body1.GetWorldCenter();mass1=body1.GetMass();for(j=this.m_bodyList;j!==i;j=j.nextBody){body2=j.body;p2=body2.GetWorldCenter();dx=p2.x-p1.x;dy=p2.y-p1.y;r2=dx*dx+dy*dy;if(r2<b2Settings.b2_epsilon)continue;f=new b2Vec2(dx,dy);f.Multiply(this.G/r2*mass1*body2.GetMass());if(body1.IsAwake())body1.ApplyForce(f,p1);f.Multiply(-1);if(body2.IsAwake())body2.ApplyForce(f,p2)}}}};b2GravityController.prototype.Draw=function(debugDraw){};b2GravityController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2GravityController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!==this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList===edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList===edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2GravityController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2GravityController.prototype.GetNext=function(){return this.m_next};b2GravityController.prototype.GetWorld=function(){return this.m_world};b2GravityController.prototype.GetBodyList=function(){return this.m_bodyList};b2TensorDampingController=Box2D.Dynamics.Controllers.b2TensorDampingController=function b2TensorDampingController(){this.T=new b2Mat22};b2TensorDampingController.constructor=b2TensorDampingController;b2TensorDampingController.prototype=Object.create(b2Controller.prototype);b2TensorDampingController.prototype.T=null;b2TensorDampingController.prototype.maxTimestep=0;b2TensorDampingController.prototype.SetAxisAligned=function(xDamping,yDamping){xDamping=xDamping||0;yDamping=yDamping||0;this.T.col1.x=-xDamping;this.T.col1.y=0;this.T.col2.x=0;this.T.col2.y=-yDamping;if(xDamping>0||yDamping>0){this.maxTimestep=1/Math.max(xDamping,yDamping)}else{this.maxTimestep=0}};b2TensorDampingController.prototype.Step=function(step){var timestep=step.dt;if(timestep<=b2Settings.b2_epsilon)return;if(timestep>this.maxTimestep&&this.maxTimestep>0)timestep=this.maxTimestep;for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(!body.IsAwake()){continue}var damping=body.GetWorldVector(b2Math.MulMV(this.T,body.GetLocalVector(body.GetLinearVelocity())));body.SetLinearVelocity(new b2Vec2(body.GetLinearVelocity().x+damping.x*timestep,body.GetLinearVelocity().y+damping.y*timestep))}};b2TensorDampingController.prototype.Draw=function(debugDraw){};b2TensorDampingController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2TensorDampingController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!==this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList===edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList===edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2TensorDampingController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2TensorDampingController.prototype.GetNext=function(){return this.m_next};b2TensorDampingController.prototype.GetWorld=function(){return this.m_world};b2TensorDampingController.prototype.GetBodyList=function(){return this.m_bodyList};b2Joint=Box2D.Dynamics.Joints.b2Joint=function b2Joint(def){this.m_edgeA=new b2JointEdge;this.m_edgeB=new b2JointEdge;this.m_localCenterA=new b2Vec2(0,0);this.m_localCenterB=new b2Vec2(0,0);b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_userData=def.userData};b2Joint.constructor=b2Joint;b2Joint.e_unknownJoint=0;b2Joint.e_revoluteJoint=1;b2Joint.e_prismaticJoint=2;b2Joint.e_distanceJoint=3;b2Joint.e_pulleyJoint=4;b2Joint.e_mouseJoint=5;b2Joint.e_gearJoint=6;b2Joint.e_lineJoint=7;b2Joint.e_weldJoint=8;b2Joint.e_frictionJoint=9;b2Joint.e_inactiveLimit=0;b2Joint.e_atLowerLimit=1;b2Joint.e_atUpperLimit=2;b2Joint.e_equalLimits=3;b2Joint.prototype.m_type=b2Joint.e_unknownJoint;b2Joint.prototype.m_edgeA=null;b2Joint.prototype.m_edgeB=null;b2Joint.prototype.m_localAnchor1=null;b2Joint.prototype.m_localAnchor2=null;b2Joint.prototype.m_localCenterA=null;b2Joint.prototype.m_localCenterB=null;b2Joint.prototype.m_prev=null;b2Joint.prototype.m_next=null;b2Joint.prototype.m_bodyA=null;b2Joint.prototype.m_bodyB=null;b2Joint.prototype.m_collideConnected=false;b2Joint.prototype.m_islandFlag=false;b2Joint.prototype.m_userData=null;b2Joint.Create=function(def,allocator){var joint=null;switch(def.type){case b2Joint.e_distanceJoint:{joint=new b2DistanceJoint(def instanceof b2DistanceJointDef?def:null)}break;case b2Joint.e_mouseJoint:{joint=new b2MouseJoint(def instanceof b2MouseJointDef?def:null)}break;case b2Joint.e_prismaticJoint:{joint=new b2PrismaticJoint(def instanceof b2PrismaticJointDef?def:null)}break;case b2Joint.e_revoluteJoint:{joint=new b2RevoluteJoint(def instanceof b2RevoluteJointDef?def:null)}break;case b2Joint.e_pulleyJoint:{joint=new b2PulleyJoint(def instanceof b2PulleyJointDef?def:null)}break;case b2Joint.e_gearJoint:{joint=new b2GearJoint(def instanceof b2GearJointDef?def:null)}break;case b2Joint.e_lineJoint:{joint=new b2LineJoint(def instanceof b2LineJointDef?def:null)}break;case b2Joint.e_weldJoint:{joint=new b2WeldJoint(def instanceof b2WeldJointDef?def:null)}break;case b2Joint.e_frictionJoint:{joint=new b2FrictionJoint(def instanceof b2FrictionJointDef?def:null)}break;default:break}return joint};b2Joint.Destroy=function(joint,allocator){};b2Joint.prototype.GetType=function(){return this.m_type};b2Joint.prototype.GetAnchorA=function(){return null};b2Joint.prototype.GetAnchorB=function(){return null};b2Joint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return null};b2Joint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2Joint.prototype.GetBodyA=function(){return this.m_bodyA};b2Joint.prototype.GetBodyB=function(){return this.m_bodyB};b2Joint.prototype.GetNext=function(){return this.m_next};b2Joint.prototype.GetUserData=function(){return this.m_userData};b2Joint.prototype.SetUserData=function(data){this.m_userData=data};b2Joint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2Joint.prototype.InitVelocityConstraints=function(step){};b2Joint.prototype.SolveVelocityConstraints=function(step){};b2Joint.prototype.FinalizeVelocityConstraints=function(){};b2Joint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;return false};b2JointDef=Box2D.Dynamics.Joints.b2JointDef=function b2JointDef(){};b2JointDef.constructor=b2JointDef;b2JointDef.prototype.type=b2Joint.e_unknownJoint;b2JointDef.prototype.userData=null;b2JointDef.prototype.bodyA=null;b2JointDef.prototype.bodyB=null;b2JointDef.prototype.collideConnected=false;b2JointEdge=Box2D.Dynamics.Joints.b2JointEdge=function b2JointEdge(){};b2JointEdge.constructor=b2JointEdge;b2Jacobian=Box2D.Dynamics.Joints.b2Jacobian=function b2Jacobian(){this.linearA=new b2Vec2(0,0);this.linearB=new b2Vec2(0,0)};b2Jacobian.constructor=b2Jacobian;b2Jacobian.prototype.linearA=null;b2Jacobian.prototype.linearB=null;b2Jacobian.prototype.angularA=null;b2Jacobian.prototype.angularB=null;b2Jacobian.prototype.SetZero=function(){this.linearA.SetZero();this.angularA=0;this.linearB.SetZero();this.angularB=0};b2Jacobian.prototype.Set=function(x1,a1,x2,a2){a1=a1||0;a2=a2||0;this.linearA.SetV(x1);this.angularA=a1;this.linearB.SetV(x2);this.angularB=a2};b2Jacobian.prototype.Compute=function(x1,a1,x2,a2){a1=a1||0;a2=a2||0;return this.linearA.x*x1.x+this.linearA.y*x1.y+this.angularA*a1+(this.linearB.x*x2.x+this.linearB.y*x2.y)+this.angularB*a2};b2DistanceJoint=Box2D.Dynamics.Joints.b2DistanceJoint=function b2DistanceJoint(def){this.m_localAnchor1=new b2Vec2(0,0);this.m_localAnchor2=new b2Vec2(0,0);this.m_u=new b2Vec2(0,0);b2Joint.call(this,def);this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_length=def.length;this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio};b2DistanceJoint.constructor=b2DistanceJoint;b2DistanceJoint.prototype=Object.create(b2Joint.prototype);b2DistanceJoint.prototype.m_u=null;b2DistanceJoint.prototype.m_length=0;b2DistanceJoint.prototype.m_frequencyHz=0;b2DistanceJoint.prototype.m_dampingRatio=0;b2DistanceJoint.prototype.m_impulse=0;b2DistanceJoint.prototype.m_gamma=0;b2DistanceJoint.prototype.m_bias=0;b2DistanceJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2DistanceJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2DistanceJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse*this.m_u.x,inv_dt*this.m_impulse*this.m_u.y)};b2DistanceJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2DistanceJoint.prototype.GetLength=function(){return this.m_length};b2DistanceJoint.prototype.SetLength=function(length){length=length||0;this.m_length=length};b2DistanceJoint.prototype.GetFrequency=function(){return this.m_frequencyHz};b2DistanceJoint.prototype.SetFrequency=function(hz){hz=hz||0;this.m_frequencyHz=hz};b2DistanceJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio};b2DistanceJoint.prototype.SetDampingRatio=function(ratio){ratio=ratio||0;this.m_dampingRatio=ratio};b2DistanceJoint.prototype.InitVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;this.m_u.x=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X;this.m_u.y=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y;var length=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);if(length>b2Settings.b2_linearSlop){this.m_u.Multiply(1/length)}else{this.m_u.SetZero()}var cr1u=r1X*this.m_u.y-r1Y*this.m_u.x,cr2u=r2X*this.m_u.y-r2Y*this.m_u.x,invMass=bA.m_invMass+bA.m_invI*cr1u*cr1u+bB.m_invMass+bB.m_invI*cr2u*cr2u;this.m_mass=invMass!==0?1/invMass:0;if(this.m_frequencyHz>0){var C=length-this.m_length,omega=2*Math.PI*this.m_frequencyHz,d=2*this.m_mass*this.m_dampingRatio*omega,k=this.m_mass*omega*omega;this.m_gamma=step.dt*(d+step.dt*k);this.m_gamma=this.m_gamma!==0?1/this.m_gamma:0;this.m_bias=C*step.dt*k*this.m_gamma;this.m_mass=invMass+this.m_gamma;this.m_mass=this.m_mass!==0?1/this.m_mass:0}if(step.warmStarting){this.m_impulse*=step.dtRatio;var PX=this.m_impulse*this.m_u.x,PY=this.m_impulse*this.m_u.y;bA.m_linearVelocity.x-=bA.m_invMass*PX;bA.m_linearVelocity.y-=bA.m_invMass*PY;bA.m_angularVelocity-=bA.m_invI*(r1X*PY-r1Y*PX);bB.m_linearVelocity.x+=bB.m_invMass*PX;bB.m_linearVelocity.y+=bB.m_invMass*PY;bB.m_angularVelocity+=bB.m_invI*(r2X*PY-r2Y*PX)}else{this.m_impulse=0}};b2DistanceJoint.prototype.SolveVelocityConstraints=function(step){var tMat,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var v1X=bA.m_linearVelocity.x+-bA.m_angularVelocity*r1Y,v1Y=bA.m_linearVelocity.y+bA.m_angularVelocity*r1X,v2X=bB.m_linearVelocity.x+-bB.m_angularVelocity*r2Y,v2Y=bB.m_linearVelocity.y+bB.m_angularVelocity*r2X,Cdot=this.m_u.x*(v2X-v1X)+this.m_u.y*(v2Y-v1Y),impulse=-this.m_mass*(Cdot+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=impulse;var PX=impulse*this.m_u.x,PY=impulse*this.m_u.y;bA.m_linearVelocity.x-=bA.m_invMass*PX;bA.m_linearVelocity.y-=bA.m_invMass*PY;bA.m_angularVelocity-=bA.m_invI*(r1X*PY-r1Y*PX);bB.m_linearVelocity.x+=bB.m_invMass*PX;bB.m_linearVelocity.y+=bB.m_invMass*PY;bB.m_angularVelocity+=bB.m_invI*(r2X*PY-r2Y*PX)};b2DistanceJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var tMat;if(this.m_frequencyHz>0){return true}var bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,dY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y,length=Math.sqrt(dX*dX+dY*dY);dX/=length;dY/=length;var C=length-this.m_length;C=b2Math.Clamp(C,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var impulse=-this.m_mass*C;this.m_u.Set(dX,dY);var PX=impulse*this.m_u.x,PY=impulse*this.m_u.y;bA.m_sweep.c.x-=bA.m_invMass*PX;bA.m_sweep.c.y-=bA.m_invMass*PY;bA.m_sweep.a-=bA.m_invI*(r1X*PY-r1Y*PX);bB.m_sweep.c.x+=bB.m_invMass*PX;bB.m_sweep.c.y+=bB.m_invMass*PY;bB.m_sweep.a+=bB.m_invI*(r2X*PY-r2Y*PX);bA.SynchronizeTransform();bB.SynchronizeTransform();return b2Math.Abs(C)<b2Settings.b2_linearSlop};b2DistanceJoint.prototype.GetType=function(){return this.m_type};b2DistanceJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2DistanceJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2DistanceJoint.prototype.GetNext=function(){return this.m_next};b2DistanceJoint.prototype.GetUserData=function(){return this.m_userData};b2DistanceJoint.prototype.SetUserData=function(data){this.m_userData=data};b2DistanceJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2DistanceJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2DistanceJoint.prototype.FinalizeVelocityConstraints=function(){};b2DistanceJointDef=Box2D.Dynamics.Joints.b2DistanceJointDef=function b2DistanceJointDef(){this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0)};b2DistanceJointDef.constructor=b2DistanceJointDef;b2DistanceJointDef.prototype=Object.create(b2JointDef.prototype);b2DistanceJointDef.prototype.type=b2Joint.e_distanceJoint;b2DistanceJointDef.prototype.localAnchorA=null;b2DistanceJointDef.prototype.localAnchorB=null;b2DistanceJointDef.prototype.length=1;b2DistanceJointDef.prototype.frequencyHz=0;b2DistanceJointDef.prototype.dampingRatio=0;b2DistanceJointDef.prototype.Initialize=function(bA,bB,anchorA,anchorB){this.bodyA=bA;this.bodyB=bB;this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchorA));this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchorB));var dX=anchorB.x-anchorA.x,dY=anchorB.y-anchorA.y;this.length=Math.sqrt(dX*dX+dY*dY);this.frequencyHz=0;this.dampingRatio=0};b2DistanceJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2FrictionJoint=Box2D.Dynamics.Joints.b2FrictionJoint=function b2FrictionJoint(def){this.m_localAnchorA=new b2Vec2(0,0);this.m_localAnchorB=new b2Vec2(0,0);this.m_linearMass=new b2Mat22;this.m_linearImpulse=new b2Vec2(0,0);b2Joint.call(this,def);this.m_localAnchorA.SetV(def.localAnchorA);this.m_localAnchorB.SetV(def.localAnchorB);this.m_linearMass.SetZero();this.m_linearImpulse.SetZero();this.m_maxForce=def.maxForce;this.m_maxTorque=def.maxTorque};b2FrictionJoint.constructor=b2FrictionJoint;b2FrictionJoint.prototype=Object.create(b2Joint.prototype);b2FrictionJoint.prototype.m_linearMass=null;b2FrictionJoint.prototype.m_linearImpulse=null;b2FrictionJoint.prototype.m_angularMass=0;b2FrictionJoint.prototype.m_angularImpulse=0;b2FrictionJoint.prototype.m_maxForce=0;b2FrictionJoint.prototype.m_maxTorque=0;b2FrictionJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)};b2FrictionJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)};b2FrictionJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_linearImpulse.x,inv_dt*this.m_linearImpulse.y)};b2FrictionJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_angularImpulse};b2FrictionJoint.prototype.SetMaxForce=function(force){force=force||0;this.m_maxForce=force};b2FrictionJoint.prototype.GetMaxForce=function(){return this.m_maxForce};b2FrictionJoint.prototype.SetMaxTorque=function(torque){torque=torque||0;this.m_maxTorque=torque};b2FrictionJoint.prototype.GetMaxTorque=function(){return this.m_maxTorque};b2FrictionJoint.prototype.InitVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI,K=new b2Mat22;K.col1.x=mA+mB;K.col2.x=0;K.col1.y=0;K.col2.y=mA+mB;K.col1.x+=iA*rAY*rAY;K.col2.x+=-iA*rAX*rAY;K.col1.y+=-iA*rAX*rAY;K.col2.y+=iA*rAX*rAX;K.col1.x+=iB*rBY*rBY;K.col2.x+=-iB*rBX*rBY;K.col1.y+=-iB*rBX*rBY;K.col2.y+=iB*rBX*rBX;K.GetInverse(this.m_linearMass);this.m_angularMass=iA+iB;if(this.m_angularMass>0){this.m_angularMass=1/this.m_angularMass}if(step.warmStarting){this.m_linearImpulse.x*=step.dtRatio;this.m_linearImpulse.y*=step.dtRatio;this.m_angularImpulse*=step.dtRatio;var P=this.m_linearImpulse;bA.m_linearVelocity.x-=mA*P.x;bA.m_linearVelocity.y-=mA*P.y;bA.m_angularVelocity-=iA*(rAX*P.y-rAY*P.x+this.m_angularImpulse);bB.m_linearVelocity.x+=mB*P.x;bB.m_linearVelocity.y+=mB*P.y;bB.m_angularVelocity+=iB*(rBX*P.y-rBY*P.x+this.m_angularImpulse)}else{this.m_linearImpulse.SetZero();this.m_angularImpulse=0}};b2FrictionJoint.prototype.SolveVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB,vA=bA.m_linearVelocity,wA=bA.m_angularVelocity,vB=bB.m_linearVelocity,wB=bB.m_angularVelocity,mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var maxImpulse=0;{var Cdot=wB-wA,impulse=-this.m_angularMass*Cdot,oldImpulse=this.m_angularImpulse;maxImpulse=step.dt*this.m_maxTorque;this.m_angularImpulse=b2Math.Clamp(this.m_angularImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_angularImpulse-oldImpulse;wA-=iA*impulse;wB+=iB*impulse}{var CdotX=vB.x-wB*rBY-vA.x+wA*rAY,CdotY=vB.y+wB*rBX-vA.y-wA*rAX,impulseV=b2Math.MulMV(this.m_linearMass,new b2Vec2(-CdotX,-CdotY)),oldImpulseV=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(impulseV);maxImpulse=step.dt*this.m_maxForce;if(this.m_linearImpulse.LengthSquared()>maxImpulse*maxImpulse){this.m_linearImpulse.Normalize();this.m_linearImpulse.Multiply(maxImpulse)}impulseV=b2Math.SubtractVV(this.m_linearImpulse,oldImpulseV);vA.x-=mA*impulseV.x;vA.y-=mA*impulseV.y;wA-=iA*(rAX*impulseV.y-rAY*impulseV.x);vB.x+=mB*impulseV.x;vB.y+=mB*impulseV.y;wB+=iB*(rBX*impulseV.y-rBY*impulseV.x)}bA.m_angularVelocity=wA;bB.m_angularVelocity=wB};b2FrictionJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;return true};b2FrictionJoint.prototype.GetType=function(){return this.m_type};b2FrictionJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2FrictionJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2FrictionJoint.prototype.GetNext=function(){return this.m_next};b2FrictionJoint.prototype.GetUserData=function(){return this.m_userData};b2FrictionJoint.prototype.SetUserData=function(data){this.m_userData=data};b2FrictionJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2FrictionJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2FrictionJoint.prototype.FinalizeVelocityConstraints=function(){};b2FrictionJointDef=Box2D.Dynamics.Joints.b2FrictionJointDef=function b2FrictionJointDef(){this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0)};b2FrictionJointDef.constructor=b2FrictionJointDef;b2FrictionJointDef.prototype=Object.create(b2JointDef.prototype);b2FrictionJointDef.prototype.type=b2Joint.e_frictionJoint;b2FrictionJointDef.prototype.localAnchorA=null;b2FrictionJointDef.prototype.localAnchorB=null;b2FrictionJointDef.prototype.maxForce=0;b2FrictionJointDef.prototype.maxTorque=0;b2FrictionJointDef.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchor));this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchor))};b2FrictionJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2GearJoint=Box2D.Dynamics.Joints.b2GearJoint=function b2GearJoint(def){this.m_groundAnchor1=new b2Vec2(0,0);this.m_groundAnchor2=new b2Vec2(0,0);this.m_localAnchor1=new b2Vec2(0,0);this.m_localAnchor2=new b2Vec2(0,0);this.m_J=new b2Jacobian;b2Joint.call(this,def);var type1=def.joint1.m_type,type2=def.joint2.m_type;var coordinate1=0,coordinate2=0;this.m_ground1=def.joint1.GetBodyA();this.m_bodyA=def.joint1.GetBodyB();if(type1===b2Joint.e_revoluteJoint){this.m_revolute1=def.joint1 instanceof b2RevoluteJoint?def.joint1:null;this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2);coordinate1=this.m_revolute1.GetJointAngle()}else{this.m_prismatic1=def.joint1 instanceof b2PrismaticJoint?def.joint1:null;this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2);coordinate1=this.m_prismatic1.GetJointTranslation()}this.m_ground2=def.joint2.GetBodyA();this.m_bodyB=def.joint2.GetBodyB();if(type2===b2Joint.e_revoluteJoint){this.m_revolute2=def.joint2 instanceof b2RevoluteJoint?def.joint2:null;this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2);coordinate2=this.m_revolute2.GetJointAngle()}else{this.m_prismatic2=def.joint2 instanceof b2PrismaticJoint?def.joint2:null;this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2);coordinate2=this.m_prismatic2.GetJointTranslation()}this.m_ratio=def.ratio;this.m_constant=coordinate1+this.m_ratio*coordinate2};b2GearJoint.constructor=b2GearJoint;b2GearJoint.prototype=Object.create(b2Joint.prototype);b2GearJoint.prototype.m_groundAnchor1=null;b2GearJoint.prototype.m_groundAnchor2=null;b2GearJoint.prototype.m_J=null;b2GearJoint.prototype.m_revolute1=null;b2GearJoint.prototype.m_prismatic1=null;b2GearJoint.prototype.m_revolute2=null;b2GearJoint.prototype.m_prismatic2=null;b2GearJoint.prototype.m_ground1=null;b2GearJoint.prototype.m_ground2=null;b2GearJoint.prototype.m_ratio=0;b2GearJoint.prototype.m_constant=0;b2GearJoint.prototype.m_impulse=0;b2GearJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2GearJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2GearJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse*this.m_J.linearB.x,inv_dt*this.m_impulse*this.m_J.linearB.y)};b2GearJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;var tMat=this.m_bodyB.m_xf.R,rX=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,rY=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;var PX=this.m_impulse*this.m_J.linearB.x,PY=this.m_impulse*this.m_J.linearB.y;return inv_dt*(this.m_impulse*this.m_J.angularB-rX*PY+rY*PX)};b2GearJoint.prototype.GetRatio=function(){return this.m_ratio};b2GearJoint.prototype.SetRatio=function(ratio){ratio=ratio||0;this.m_ratio=ratio};b2GearJoint.prototype.InitVelocityConstraints=function(step){var g1=this.m_ground1,g2=this.m_ground2,bA=this.m_bodyA,bB=this.m_bodyB,ugX=0,ugY=0,rX=0,rY=0,tMat,tVec,crug=0,tX=0,K=0;this.m_J.SetZero();if(this.m_revolute1){this.m_J.angularA=-1;K+=bA.m_invI}else{tMat=g1.m_xf.R;tVec=this.m_prismatic1.m_localXAxis1;ugX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;ugY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=bA.m_xf.R;rX=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;rY=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;crug=rX*ugY-rY*ugX;this.m_J.linearA.Set(-ugX,-ugY);this.m_J.angularA=-crug;K+=bA.m_invMass+bA.m_invI*crug*crug}if(this.m_revolute2){this.m_J.angularB=-this.m_ratio;K+=this.m_ratio*this.m_ratio*bB.m_invI}else{tMat=g2.m_xf.R;tVec=this.m_prismatic2.m_localXAxis1;ugX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;ugY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=bB.m_xf.R;rX=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;rY=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;crug=rX*ugY-rY*ugX;this.m_J.linearB.Set(-this.m_ratio*ugX,-this.m_ratio*ugY);this.m_J.angularB=-this.m_ratio*crug;K+=this.m_ratio*this.m_ratio*(bB.m_invMass+bB.m_invI*crug*crug)}this.m_mass=K>0?1/K:0;if(step.warmStarting){bA.m_linearVelocity.x+=bA.m_invMass*this.m_impulse*this.m_J.linearA.x;bA.m_linearVelocity.y+=bA.m_invMass*this.m_impulse*this.m_J.linearA.y;bA.m_angularVelocity+=bA.m_invI*this.m_impulse*this.m_J.angularA;bB.m_linearVelocity.x+=bB.m_invMass*this.m_impulse*this.m_J.linearB.x;bB.m_linearVelocity.y+=bB.m_invMass*this.m_impulse*this.m_J.linearB.y;bB.m_angularVelocity+=bB.m_invI*this.m_impulse*this.m_J.angularB}else{this.m_impulse=0}};b2GearJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,Cdot=this.m_J.Compute(bA.m_linearVelocity,bA.m_angularVelocity,bB.m_linearVelocity,bB.m_angularVelocity),impulse=-this.m_mass*Cdot;this.m_impulse+=impulse;bA.m_linearVelocity.x+=bA.m_invMass*impulse*this.m_J.linearA.x;bA.m_linearVelocity.y+=bA.m_invMass*impulse*this.m_J.linearA.y;bA.m_angularVelocity+=bA.m_invI*impulse*this.m_J.angularA;bB.m_linearVelocity.x+=bB.m_invMass*impulse*this.m_J.linearB.x;bB.m_linearVelocity.y+=bB.m_invMass*impulse*this.m_J.linearB.y;bB.m_angularVelocity+=bB.m_invI*impulse*this.m_J.angularB};b2GearJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var linearError=0,bA=this.m_bodyA,bB=this.m_bodyB,coordinate1=0,coordinate2=0;if(this.m_revolute1){coordinate1=this.m_revolute1.GetJointAngle()}else{coordinate1=this.m_prismatic1.GetJointTranslation()}if(this.m_revolute2){coordinate2=this.m_revolute2.GetJointAngle()}else{coordinate2=this.m_prismatic2.GetJointTranslation()}var C=this.m_constant-(coordinate1+this.m_ratio*coordinate2),impulse=-this.m_mass*C;bA.m_sweep.c.x+=bA.m_invMass*impulse*this.m_J.linearA.x;bA.m_sweep.c.y+=bA.m_invMass*impulse*this.m_J.linearA.y;bA.m_sweep.a+=bA.m_invI*impulse*this.m_J.angularA;bB.m_sweep.c.x+=bB.m_invMass*impulse*this.m_J.linearB.x;bB.m_sweep.c.y+=bB.m_invMass*impulse*this.m_J.linearB.y;bB.m_sweep.a+=bB.m_invI*impulse*this.m_J.angularB;bA.SynchronizeTransform();bB.SynchronizeTransform();return linearError<b2Settings.b2_linearSlop};b2GearJoint.prototype.GetType=function(){return this.m_type};b2GearJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2GearJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2GearJoint.prototype.GetNext=function(){return this.m_next};b2GearJoint.prototype.GetUserData=function(){return this.m_userData};b2GearJoint.prototype.SetUserData=function(data){this.m_userData=data};b2GearJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2GearJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2GearJoint.prototype.FinalizeVelocityConstraints=function(){};b2GearJointDef=Box2D.Dynamics.Joints.b2GearJointDef=function b2GearJointDef(){};b2GearJointDef.constructor=b2GearJointDef;b2GearJointDef.prototype=Object.create(b2JointDef.prototype);b2GearJointDef.prototype.type=b2Joint.e_gearJoint;b2GearJointDef.prototype.joint1=null;
b2GearJointDef.prototype.joint2=null;b2GearJointDef.prototype.ratio=1;b2LineJoint=Box2D.Dynamics.Joints.b2LineJoint=function b2LineJoint(def){this.m_localAnchor1=new b2Vec2(0,0);this.m_localAnchor2=new b2Vec2(0,0);this.m_localXAxis1=new b2Vec2(0,0);this.m_localYAxis1=new b2Vec2(0,0);this.m_axis=new b2Vec2(0,0);this.m_perp=new b2Vec2(0,0);this.m_K=new b2Mat22;this.m_impulse=new b2Vec2(0,0);b2Joint.call(this,def);this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_localXAxis1.SetV(def.localAxisA);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_impulse.SetZero();this.m_lowerTranslation=def.lowerTranslation;this.m_upperTranslation=def.upperTranslation;this.m_maxMotorForce=def.maxMotorForce;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=b2Joint.e_inactiveLimit;this.m_axis.SetZero();this.m_perp.SetZero()};b2LineJoint.constructor=b2LineJoint;b2LineJoint.prototype=Object.create(b2Joint.prototype);b2LineJoint.prototype.m_localXAxis1=null;b2LineJoint.prototype.m_localYAxis1=null;b2LineJoint.prototype.m_axis=null;b2LineJoint.prototype.m_perp=null;b2LineJoint.prototype.m_K=null;b2LineJoint.prototype.m_impulse=null;b2LineJoint.prototype.m_motorMass=0;b2LineJoint.prototype.m_motorImpulse=0;b2LineJoint.prototype.m_lowerTranslation=0;b2LineJoint.prototype.m_upperTranslation=0;b2LineJoint.prototype.m_maxMotorForce=0;b2LineJoint.prototype.m_motorSpeed=0;b2LineJoint.prototype.m_enableLimit=false;b2LineJoint.prototype.m_enableMotor=false;b2LineJoint.prototype.m_limitState=b2Joint.e_inactiveLimit;b2LineJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2LineJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2LineJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),inv_dt*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))};b2LineJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_impulse.y};b2LineJoint.prototype.GetJointTranslation=function(){var bA=this.m_bodyA,bB=this.m_bodyB,p1=bA.GetWorldPoint(this.m_localAnchor1),p2=bB.GetWorldPoint(this.m_localAnchor2),dX=p2.x-p1.x,dY=p2.y-p1.y,axis=bA.GetWorldVector(this.m_localXAxis1);return axis.x*dX+axis.y*dY};b2LineJoint.prototype.GetJointSpeed=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var p1X=bA.m_sweep.c.x+r1X,p1Y=bA.m_sweep.c.y+r1Y,p2X=bB.m_sweep.c.x+r2X,p2Y=bB.m_sweep.c.y+r2Y,dX=p2X-p1X,dY=p2Y-p1Y,axis=bA.GetWorldVector(this.m_localXAxis1),v1=bA.m_linearVelocity,v2=bB.m_linearVelocity,w1=bA.m_angularVelocity,w2=bB.m_angularVelocity;return dX*(-w1*axis.y)+dY*(w1*axis.x)+(axis.x*(v2.x+-w2*r2Y-v1.x- -w1*r1Y)+axis.y*(v2.y+w2*r2X-v1.y-w1*r1X))};b2LineJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit};b2LineJoint.prototype.EnableLimit=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableLimit=flag};b2LineJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation};b2LineJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation};b2LineJoint.prototype.SetLimits=function(lower,upper){lower=lower||0;upper=upper||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_lowerTranslation=lower;this.m_upperTranslation=upper};b2LineJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor};b2LineJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag};b2LineJoint.prototype.SetMotorSpeed=function(speed){speed=speed||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed};b2LineJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed};b2LineJoint.prototype.SetMaxMotorForce=function(force){force=force||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorForce=force};b2LineJoint.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce};b2LineJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse};b2LineJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0;this.m_localCenterA.SetV(bA.GetLocalCenter());this.m_localCenterB.SetV(bB.GetLocalCenter());var xf1=bA.GetTransform(),xf2=bB.GetTransform();tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,dY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y;this.m_invMassA=bA.m_invMass;this.m_invMassB=bB.m_invMass;this.m_invIA=bA.m_invI;this.m_invIB=bB.m_invI;{this.m_axis.SetV(b2Math.MulMV(xf1.R,this.m_localXAxis1));this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2;this.m_motorMass=this.m_motorMass>b2Settings.b2_epsilon?1/this.m_motorMass:0}{this.m_perp.SetV(b2Math.MulMV(xf1.R,this.m_localYAxis1));this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var m1=this.m_invMassA,m2=this.m_invMassB,i1=this.m_invIA,i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2}if(this.m_enableLimit){var jointTransition=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointTransition<=this.m_lowerTranslation){if(this.m_limitState!==b2Joint.e_atLowerLimit){this.m_limitState=b2Joint.e_atLowerLimit;this.m_impulse.y=0}}else if(jointTransition>=this.m_upperTranslation){if(this.m_limitState!==b2Joint.e_atUpperLimit){this.m_limitState=b2Joint.e_atUpperLimit;this.m_impulse.y=0}}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_impulse.y=0}}else{this.m_limitState=b2Joint.e_inactiveLimit}if(this.m_enableMotor===false){this.m_motorImpulse=0}if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_motorImpulse*=step.dtRatio;var PX=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,PY=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,L1=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,L2=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;bA.m_linearVelocity.x-=this.m_invMassA*PX;bA.m_linearVelocity.y-=this.m_invMassA*PY;bA.m_angularVelocity-=this.m_invIA*L1;bB.m_linearVelocity.x+=this.m_invMassB*PX;bB.m_linearVelocity.y+=this.m_invMassB*PY;bB.m_angularVelocity+=this.m_invIB*L2}else{this.m_impulse.SetZero();this.m_motorImpulse=0}};b2LineJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,v1=bA.m_linearVelocity,w1=bA.m_angularVelocity,v2=bB.m_linearVelocity,w2=bB.m_angularVelocity,PX=0,PY=0,L1=0,L2=0;if(this.m_enableMotor&&this.m_limitState!==b2Joint.e_equalLimits){var Cdot=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,impulse=this.m_motorMass*(this.m_motorSpeed-Cdot),oldImpulse=this.m_motorImpulse,maxImpulse=step.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;PX=impulse*this.m_axis.x;PY=impulse*this.m_axis.y;L1=impulse*this.m_a1;L2=impulse*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}var Cdot1=this.m_perp.x*(v2.x-v1.x)+this.m_perp.y*(v2.y-v1.y)+this.m_s2*w2-this.m_s1*w1;if(this.m_enableLimit&&this.m_limitState!==b2Joint.e_inactiveLimit){var Cdot2=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,f1=this.m_impulse.Copy(),df=this.m_K.Solve(new b2Vec2(0,0),-Cdot1,-Cdot2);this.m_impulse.Add(df);if(this.m_limitState===b2Joint.e_atLowerLimit){this.m_impulse.y=b2Math.Max(this.m_impulse.y,0)}else if(this.m_limitState===b2Joint.e_atUpperLimit){this.m_impulse.y=b2Math.Min(this.m_impulse.y,0)}var b=-Cdot1-(this.m_impulse.y-f1.y)*this.m_K.col2.x,f2r=0;if(this.m_K.col1.x!==0){f2r=b/this.m_K.col1.x+f1.x}else{f2r=f1.x}this.m_impulse.x=f2r;df.x=this.m_impulse.x-f1.x;df.y=this.m_impulse.y-f1.y;PX=df.x*this.m_perp.x+df.y*this.m_axis.x;PY=df.x*this.m_perp.y+df.y*this.m_axis.y;L1=df.x*this.m_s1+df.y*this.m_a1;L2=df.x*this.m_s2+df.y*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}else{var df2=0;if(this.m_K.col1.x!==0){df2=-Cdot1/this.m_K.col1.x}else{df2=0}this.m_impulse.x+=df2;PX=df2*this.m_perp.x;PY=df2*this.m_perp.y;L1=df2*this.m_s1;L2=df2*this.m_s2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}bA.m_linearVelocity.SetV(v1);bA.m_angularVelocity=w1;bB.m_linearVelocity.SetV(v2);bB.m_angularVelocity=w2};b2LineJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var limitC=0,oldLimitImpulse=0,bA=this.m_bodyA,bB=this.m_bodyB,c1=bA.m_sweep.c,a1=bA.m_sweep.a,c2=bB.m_sweep.c,a2=bB.m_sweep.a,tMat,tX=0,m1=0,m2=0,i1=0,i2=0,linearError=0,angularError=0,active=false,C2=0,R1=b2Mat22.FromAngle(a1),R2=b2Mat22.FromAngle(a2);tMat=R1;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=R2;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=c2.x+r2X-c1.x-r1X,dY=c2.y+r2Y-c1.y-r1Y;if(this.m_enableLimit){this.m_axis=b2Math.MulMV(R1,this.m_localXAxis1);this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;var translation=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){C2=b2Math.Clamp(translation,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);linearError=b2Math.Abs(translation);active=true}else if(translation<=this.m_lowerTranslation){C2=b2Math.Clamp(translation-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);linearError=this.m_lowerTranslation-translation;active=true}else if(translation>=this.m_upperTranslation){C2=b2Math.Clamp(translation-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection);linearError=translation-this.m_upperTranslation;active=true}}this.m_perp=b2Math.MulMV(R1,this.m_localYAxis1);this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var impulse=new b2Vec2(0,0),C1=this.m_perp.x*dX+this.m_perp.y*dY;linearError=b2Math.Max(linearError,b2Math.Abs(C1));angularError=0;if(active){m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2;this.m_K.Solve(impulse,-C1,-C2)}else{m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;var k11=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2,impulse1=0;if(k11!==0){impulse1=-C1/k11}else{impulse1=0}impulse.x=impulse1;impulse.y=0}var PX=impulse.x*this.m_perp.x+impulse.y*this.m_axis.x,PY=impulse.x*this.m_perp.y+impulse.y*this.m_axis.y,L1=impulse.x*this.m_s1+impulse.y*this.m_a1,L2=impulse.x*this.m_s2+impulse.y*this.m_a2;c1.x-=this.m_invMassA*PX;c1.y-=this.m_invMassA*PY;a1-=this.m_invIA*L1;c2.x+=this.m_invMassB*PX;c2.y+=this.m_invMassB*PY;a2+=this.m_invIB*L2;bA.m_sweep.a=a1;bB.m_sweep.a=a2;bA.SynchronizeTransform();bB.SynchronizeTransform();return linearError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2LineJoint.prototype.GetType=function(){return this.m_type};b2LineJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2LineJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2LineJoint.prototype.GetNext=function(){return this.m_next};b2LineJoint.prototype.GetUserData=function(){return this.m_userData};b2LineJoint.prototype.SetUserData=function(data){this.m_userData=data};b2LineJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2LineJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2LineJoint.prototype.FinalizeVelocityConstraints=function(){};b2LineJointDef=Box2D.Dynamics.Joints.b2LineJointDef=function b2LineJointDef(){this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0);this.localAxisA=new b2Vec2(0,0);this.localAxisA.Set(1,0)};b2LineJointDef.constructor=b2LineJointDef;b2LineJointDef.prototype=Object.create(b2JointDef.prototype);b2LineJointDef.prototype.type=b2Joint.e_lineJoint;b2LineJointDef.prototype.localAnchorA=null;b2LineJointDef.prototype.localAnchorB=null;b2LineJointDef.prototype.localAxisA=null;b2LineJointDef.prototype.enableLimit=false;b2LineJointDef.prototype.lowerTranslation=0;b2LineJointDef.prototype.upperTranslation=0;b2LineJointDef.prototype.enableMotor=false;b2LineJointDef.prototype.maxMotorForce=0;b2LineJointDef.prototype.motorSpeed=0;b2LineJointDef.prototype.Initialize=function(bA,bB,anchor,axis){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.localAxisA=this.bodyA.GetLocalVector(axis)};b2LineJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2MouseJoint=Box2D.Dynamics.Joints.b2MouseJoint=function b2MouseJoint(def){this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.m_localAnchor=new b2Vec2(0,0);this.m_target=new b2Vec2(0,0);this.m_impulse=new b2Vec2(0,0);this.m_mass=new b2Mat22;this.m_C=new b2Vec2(0,0);b2Joint.call(this,def);this.m_target.SetV(def.target);var tX=this.m_target.x-this.m_bodyB.m_xf.position.x,tY=this.m_target.y-this.m_bodyB.m_xf.position.y,tMat=this.m_bodyB.m_xf.R;this.m_localAnchor.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor.y=tX*tMat.col2.x+tY*tMat.col2.y;this.m_maxForce=def.maxForce;this.m_impulse.SetZero();this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio};b2MouseJoint.constructor=b2MouseJoint;b2MouseJoint.prototype=Object.create(b2Joint.prototype);b2MouseJoint.prototype.K=null;b2MouseJoint.prototype.K1=null;b2MouseJoint.prototype.K2=null;b2MouseJoint.prototype.m_localAnchor=null;b2MouseJoint.prototype.m_target=null;b2MouseJoint.prototype.m_impulse=null;b2MouseJoint.prototype.m_mass=null;b2MouseJoint.prototype.m_C=null;b2MouseJoint.prototype.m_frequencyHz=0;b2MouseJoint.prototype.m_dampingRatio=0;b2MouseJoint.prototype.m_beta=0;b2MouseJoint.prototype.m_gamma=0;b2MouseJoint.prototype.GetAnchorA=function(){return this.m_target};b2MouseJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)};b2MouseJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse.x,inv_dt*this.m_impulse.y)};b2MouseJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2MouseJoint.prototype.GetTarget=function(){return this.m_target};b2MouseJoint.prototype.SetTarget=function(target){if(this.m_bodyB.IsAwake()===false){this.m_bodyB.SetAwake(true)}this.m_target=target};b2MouseJoint.prototype.GetMaxForce=function(){return this.m_maxForce};b2MouseJoint.prototype.SetMaxForce=function(maxForce){maxForce=maxForce||0;this.m_maxForce=maxForce};b2MouseJoint.prototype.GetFrequency=function(){return this.m_frequencyHz};b2MouseJoint.prototype.SetFrequency=function(hz){hz=hz||0;this.m_frequencyHz=hz};b2MouseJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio};b2MouseJoint.prototype.SetDampingRatio=function(ratio){ratio=ratio||0;this.m_dampingRatio=ratio};b2MouseJoint.prototype.InitVelocityConstraints=function(step){var b=this.m_bodyB,mass=b.GetMass(),omega=2*Math.PI*this.m_frequencyHz,d=2*mass*this.m_dampingRatio*omega,k=mass*omega*omega,rX,rY,tX;this.m_gamma=step.dt*(d+step.dt*k);this.m_gamma=this.m_gamma!==0?1/this.m_gamma:0;this.m_beta=step.dt*k*this.m_gamma;var tMat;tMat=b.m_xf.R,rX=this.m_localAnchor.x-b.m_sweep.localCenter.x,rY=this.m_localAnchor.y-b.m_sweep.localCenter.y,tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;var invMass=b.m_invMass,invI=b.m_invI;this.K1.col1.x=invMass;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass;this.K2.col1.x=invI*rY*rY;this.K2.col2.x=-invI*rX*rY;this.K2.col1.y=-invI*rX*rY;this.K2.col2.y=invI*rX*rX;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.col1.x+=this.m_gamma;this.K.col2.y+=this.m_gamma;this.K.GetInverse(this.m_mass);this.m_C.x=b.m_sweep.c.x+rX-this.m_target.x;this.m_C.y=b.m_sweep.c.y+rY-this.m_target.y;b.m_angularVelocity*=.98;this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;b.m_linearVelocity.x+=invMass*this.m_impulse.x;b.m_linearVelocity.y+=invMass*this.m_impulse.y;b.m_angularVelocity+=invI*(rX*this.m_impulse.y-rY*this.m_impulse.x)};b2MouseJoint.prototype.SolveVelocityConstraints=function(step){var b=this.m_bodyB,tMat,tX=0,tY=0;tMat=b.m_xf.R;var rX=this.m_localAnchor.x-b.m_sweep.localCenter.x,rY=this.m_localAnchor.y-b.m_sweep.localCenter.y;tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;var CdotX=b.m_linearVelocity.x+-b.m_angularVelocity*rY,CdotY=b.m_linearVelocity.y+b.m_angularVelocity*rX;tMat=this.m_mass;tX=CdotX+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x;tY=CdotY+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var impulseX=-(tMat.col1.x*tX+tMat.col2.x*tY),impulseY=-(tMat.col1.y*tX+tMat.col2.y*tY),oldImpulseX=this.m_impulse.x,oldImpulseY=this.m_impulse.y;this.m_impulse.x+=impulseX;this.m_impulse.y+=impulseY;var maxImpulse=step.dt*this.m_maxForce;if(this.m_impulse.LengthSquared()>maxImpulse*maxImpulse){this.m_impulse.Multiply(maxImpulse/this.m_impulse.Length())}impulseX=this.m_impulse.x-oldImpulseX;impulseY=this.m_impulse.y-oldImpulseY;b.m_linearVelocity.x+=b.m_invMass*impulseX;b.m_linearVelocity.y+=b.m_invMass*impulseY;b.m_angularVelocity+=b.m_invI*(rX*impulseY-rY*impulseX)};b2MouseJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;return true};b2MouseJoint.prototype.GetType=function(){return this.m_type};b2MouseJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2MouseJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2MouseJoint.prototype.GetNext=function(){return this.m_next};b2MouseJoint.prototype.GetUserData=function(){return this.m_userData};b2MouseJoint.prototype.SetUserData=function(data){this.m_userData=data};b2MouseJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2MouseJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2MouseJoint.prototype.FinalizeVelocityConstraints=function(){};b2MouseJointDef=Box2D.Dynamics.Joints.b2MouseJointDef=function b2MouseJointDef(){this.target=new b2Vec2(0,0)};b2MouseJointDef.constructor=b2MouseJointDef;b2MouseJointDef.prototype=Object.create(b2JointDef.prototype);b2MouseJointDef.prototype.type=b2Joint.e_mouseJoint;b2MouseJointDef.prototype.target=null;b2MouseJointDef.prototype.maxForce=0;b2MouseJointDef.prototype.frequencyHz=5;b2MouseJointDef.prototype.dampingRatio=.7;b2MouseJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2PrismaticJoint=Box2D.Dynamics.Joints.b2PrismaticJoint=function b2PrismaticJoint(def){this.m_localAnchor1=new b2Vec2(0,0);this.m_localAnchor2=new b2Vec2(0,0);this.m_localXAxis1=new b2Vec2(0,0);this.m_localYAxis1=new b2Vec2(0,0);this.m_axis=new b2Vec2(0,0);this.m_perp=new b2Vec2(0,0);this.m_K=new b2Mat33;this.m_impulse=new b2Vec3(0,0,0);b2Joint.call(this,def);this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_localXAxis1.SetV(def.localAxisA);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_refAngle=def.referenceAngle;this.m_impulse.SetZero();this.m_lowerTranslation=def.lowerTranslation;this.m_upperTranslation=def.upperTranslation;this.m_maxMotorForce=def.maxMotorForce;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=b2Joint.e_inactiveLimit;this.m_axis.SetZero();this.m_perp.SetZero()};b2PrismaticJoint.constructor=b2PrismaticJoint;b2PrismaticJoint.prototype=Object.create(b2Joint.prototype);b2PrismaticJoint.prototype.m_localXAxis1=null;b2PrismaticJoint.prototype.m_localYAxis1=null;b2PrismaticJoint.prototype.m_axis=null;b2PrismaticJoint.prototype.m_perp=null;b2PrismaticJoint.prototype.m_K=null;b2PrismaticJoint.prototype.m_refAngle=null;b2PrismaticJoint.prototype.m_impulse=null;b2PrismaticJoint.prototype.m_motorMass=0;b2PrismaticJoint.prototype.m_motorImpulse=0;b2PrismaticJoint.prototype.m_lowerTranslation=0;b2PrismaticJoint.prototype.m_upperTranslation=0;b2PrismaticJoint.prototype.m_maxMotorForce=0;b2PrismaticJoint.prototype.m_motorSpeed=0;b2PrismaticJoint.prototype.m_enableLimit=false;b2PrismaticJoint.prototype.m_enableMotor=false;b2PrismaticJoint.prototype.m_limitState=b2Joint.e_inactiveLimit;b2PrismaticJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2PrismaticJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2PrismaticJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),inv_dt*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))};b2PrismaticJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.y};b2PrismaticJoint.prototype.GetJointTranslation=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,p1=bA.GetWorldPoint(this.m_localAnchor1),p2=bB.GetWorldPoint(this.m_localAnchor2),dX=p2.x-p1.x,dY=p2.y-p1.y,axis=bA.GetWorldVector(this.m_localXAxis1);return axis.x*dX+axis.y*dY};b2PrismaticJoint.prototype.GetJointSpeed=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var p1X=bA.m_sweep.c.x+r1X,p1Y=bA.m_sweep.c.y+r1Y,p2X=bB.m_sweep.c.x+r2X,p2Y=bB.m_sweep.c.y+r2Y,dX=p2X-p1X,dY=p2Y-p1Y,axis=bA.GetWorldVector(this.m_localXAxis1),v1=bA.m_linearVelocity,v2=bB.m_linearVelocity,w1=bA.m_angularVelocity,w2=bB.m_angularVelocity;return dX*(-w1*axis.y)+dY*(w1*axis.x)+(axis.x*(v2.x+-w2*r2Y-v1.x- -w1*r1Y)+axis.y*(v2.y+w2*r2X-v1.y-w1*r1X))};b2PrismaticJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit};b2PrismaticJoint.prototype.EnableLimit=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableLimit=flag};b2PrismaticJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation};b2PrismaticJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation};b2PrismaticJoint.prototype.SetLimits=function(lower,upper){lower=lower||0;upper=upper||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_lowerTranslation=lower;this.m_upperTranslation=upper};b2PrismaticJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor};b2PrismaticJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag};b2PrismaticJoint.prototype.SetMotorSpeed=function(speed){speed=speed||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed};b2PrismaticJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed};b2PrismaticJoint.prototype.SetMaxMotorForce=function(force){force=force||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorForce=force};b2PrismaticJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse};b2PrismaticJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0;this.m_localCenterA.SetV(bA.GetLocalCenter());this.m_localCenterB.SetV(bB.GetLocalCenter());var xf1=bA.GetTransform(),xf2=bB.GetTransform();tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,dY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y;this.m_invMassA=bA.m_invMass;this.m_invMassB=bB.m_invMass;this.m_invIA=bA.m_invI;this.m_invIB=bB.m_invI;{this.m_axis.SetV(b2Math.MulMV(xf1.R,this.m_localXAxis1));this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2;if(this.m_motorMass>b2Settings.b2_epsilon)this.m_motorMass=1/this.m_motorMass}{this.m_perp.SetV(b2Math.MulMV(xf1.R,this.m_localYAxis1));this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var m1=this.m_invMassA,m2=this.m_invMassB,i1=this.m_invIA,i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1+i2*this.m_s2;this.m_K.col1.z=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=i1+i2;this.m_K.col2.z=i1*this.m_a1+i2*this.m_a2;this.m_K.col3.x=this.m_K.col1.z;this.m_K.col3.y=this.m_K.col2.z;this.m_K.col3.z=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2}if(this.m_enableLimit){var jointTransition=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointTransition<=this.m_lowerTranslation){if(this.m_limitState!==b2Joint.e_atLowerLimit){this.m_limitState=b2Joint.e_atLowerLimit;this.m_impulse.z=0}}else if(jointTransition>=this.m_upperTranslation){if(this.m_limitState!==b2Joint.e_atUpperLimit){this.m_limitState=b2Joint.e_atUpperLimit;this.m_impulse.z=0}}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_impulse.z=0}}else{this.m_limitState=b2Joint.e_inactiveLimit}if(this.m_enableMotor===false){this.m_motorImpulse=0}if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_motorImpulse*=step.dtRatio;var PX=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,PY=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,L1=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,L2=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;bA.m_linearVelocity.x-=this.m_invMassA*PX;bA.m_linearVelocity.y-=this.m_invMassA*PY;bA.m_angularVelocity-=this.m_invIA*L1;bB.m_linearVelocity.x+=this.m_invMassB*PX;bB.m_linearVelocity.y+=this.m_invMassB*PY;bB.m_angularVelocity+=this.m_invIB*L2}else{this.m_impulse.SetZero();this.m_motorImpulse=0}};b2PrismaticJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,v1=bA.m_linearVelocity,w1=bA.m_angularVelocity,v2=bB.m_linearVelocity,w2=bB.m_angularVelocity,PX=0,PY=0,L1=0,L2=0;if(this.m_enableMotor&&this.m_limitState!==b2Joint.e_equalLimits){var Cdot=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,impulse=this.m_motorMass*(this.m_motorSpeed-Cdot),oldImpulse=this.m_motorImpulse,maxImpulse=step.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;PX=impulse*this.m_axis.x;PY=impulse*this.m_axis.y;L1=impulse*this.m_a1;L2=impulse*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}var Cdot1X=this.m_perp.x*(v2.x-v1.x)+this.m_perp.y*(v2.y-v1.y)+this.m_s2*w2-this.m_s1*w1,Cdot1Y=w2-w1;if(this.m_enableLimit&&this.m_limitState!==b2Joint.e_inactiveLimit){var Cdot2=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,f1=this.m_impulse.Copy(),df=this.m_K.Solve33(new b2Vec3(0,0,0),-Cdot1X,-Cdot1Y,-Cdot2);this.m_impulse.Add(df);if(this.m_limitState===b2Joint.e_atLowerLimit){this.m_impulse.z=b2Math.Max(this.m_impulse.z,0)}else if(this.m_limitState===b2Joint.e_atUpperLimit){this.m_impulse.z=b2Math.Min(this.m_impulse.z,0)}var bX=-Cdot1X-(this.m_impulse.z-f1.z)*this.m_K.col3.x,bY=-Cdot1Y-(this.m_impulse.z-f1.z)*this.m_K.col3.y,f2r=this.m_K.Solve22(new b2Vec2(0,0),bX,bY);f2r.x+=f1.x;f2r.y+=f1.y;this.m_impulse.x=f2r.x;this.m_impulse.y=f2r.y;df.x=this.m_impulse.x-f1.x;df.y=this.m_impulse.y-f1.y;df.z=this.m_impulse.z-f1.z;PX=df.x*this.m_perp.x+df.z*this.m_axis.x;PY=df.x*this.m_perp.y+df.z*this.m_axis.y;L1=df.x*this.m_s1+df.y+df.z*this.m_a1;L2=df.x*this.m_s2+df.y+df.z*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}else{var df2=this.m_K.Solve22(new b2Vec2(0,0),-Cdot1X,-Cdot1Y);this.m_impulse.x+=df2.x;this.m_impulse.y+=df2.y;PX=df2.x*this.m_perp.x;PY=df2.x*this.m_perp.y;L1=df2.x*this.m_s1+df2.y;L2=df2.x*this.m_s2+df2.y;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}bA.m_linearVelocity.SetV(v1);bA.m_angularVelocity=w1;bB.m_linearVelocity.SetV(v2);bB.m_angularVelocity=w2};b2PrismaticJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var limitC=0,oldLimitImpulse=0,bA=this.m_bodyA,bB=this.m_bodyB,c1=bA.m_sweep.c,a1=bA.m_sweep.a,c2=bB.m_sweep.c,a2=bB.m_sweep.a,tMat,tX=0,m1=0,m2=0,i1=0,i2=0,linearError=0,angularError=0,active=false,C2=0,R1=b2Mat22.FromAngle(a1),R2=b2Mat22.FromAngle(a2);
tMat=R1;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=R2;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=c2.x+r2X-c1.x-r1X,dY=c2.y+r2Y-c1.y-r1Y;if(this.m_enableLimit){this.m_axis=b2Math.MulMV(R1,this.m_localXAxis1);this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;var translation=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){C2=b2Math.Clamp(translation,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);linearError=b2Math.Abs(translation);active=true}else if(translation<=this.m_lowerTranslation){C2=b2Math.Clamp(translation-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);linearError=this.m_lowerTranslation-translation;active=true}else if(translation>=this.m_upperTranslation){C2=b2Math.Clamp(translation-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection);linearError=translation-this.m_upperTranslation;active=true}}this.m_perp=b2Math.MulMV(R1,this.m_localYAxis1);this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var impulse=new b2Vec3(0,0,0),C1X=this.m_perp.x*dX+this.m_perp.y*dY,C1Y=a2-a1-this.m_refAngle;linearError=b2Math.Max(linearError,b2Math.Abs(C1X));angularError=b2Math.Abs(C1Y);if(active){m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1+i2*this.m_s2;this.m_K.col1.z=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=i1+i2;this.m_K.col2.z=i1*this.m_a1+i2*this.m_a2;this.m_K.col3.x=this.m_K.col1.z;this.m_K.col3.y=this.m_K.col2.z;this.m_K.col3.z=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2;this.m_K.Solve33(impulse,-C1X,-C1Y,-C2)}else{m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;var k11=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2,k12=i1*this.m_s1+i2*this.m_s2,k22=i1+i2;this.m_K.col1.Set(k11,k12,0);this.m_K.col2.Set(k12,k22,0);var impulse1=this.m_K.Solve22(new b2Vec2(0,0),-C1X,-C1Y);impulse.x=impulse1.x;impulse.y=impulse1.y;impulse.z=0}var PX=impulse.x*this.m_perp.x+impulse.z*this.m_axis.x,PY=impulse.x*this.m_perp.y+impulse.z*this.m_axis.y,L1=impulse.x*this.m_s1+impulse.y+impulse.z*this.m_a1,L2=impulse.x*this.m_s2+impulse.y+impulse.z*this.m_a2;c1.x-=this.m_invMassA*PX;c1.y-=this.m_invMassA*PY;a1-=this.m_invIA*L1;c2.x+=this.m_invMassB*PX;c2.y+=this.m_invMassB*PY;a2+=this.m_invIB*L2;bA.m_sweep.a=a1;bB.m_sweep.a=a2;bA.SynchronizeTransform();bB.SynchronizeTransform();return linearError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2PrismaticJoint.prototype.GetType=function(){return this.m_type};b2PrismaticJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2PrismaticJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2PrismaticJoint.prototype.GetNext=function(){return this.m_next};b2PrismaticJoint.prototype.GetUserData=function(){return this.m_userData};b2PrismaticJoint.prototype.SetUserData=function(data){this.m_userData=data};b2PrismaticJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2PrismaticJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2PrismaticJoint.prototype.FinalizeVelocityConstraints=function(){};b2PrismaticJointDef=Box2D.Dynamics.Joints.b2PrismaticJointDef=function b2PrismaticJointDef(){this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0);this.localAxisA=new b2Vec2(0,0);b2JointDef.call(this);this.type=b2Joint.e_prismaticJoint;this.localAxisA.Set(1,0)};b2PrismaticJointDef.constructor=b2PrismaticJointDef;b2PrismaticJointDef.prototype=Object.create(b2JointDef.prototype);b2PrismaticJointDef.prototype.type=b2Joint.e_prismaticJoint;b2PrismaticJointDef.prototype.localAnchorA=null;b2PrismaticJointDef.prototype.localAnchorB=null;b2PrismaticJointDef.prototype.localAxisA=null;b2PrismaticJointDef.prototype.referenceAngle=0;b2PrismaticJointDef.prototype.enableLimit=false;b2PrismaticJointDef.prototype.lowerTranslation=0;b2PrismaticJointDef.prototype.upperTranslation=0;b2PrismaticJointDef.prototype.enableMotor=false;b2PrismaticJointDef.prototype.maxMotorForce=0;b2PrismaticJointDef.prototype.motorSpeed=0;b2PrismaticJointDef.prototype.Initialize=function(bA,bB,anchor,axis){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.localAxisA=this.bodyA.GetLocalVector(axis);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()};b2PrismaticJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2PulleyJoint=Box2D.Dynamics.Joints.b2PulleyJoint=function b2PulleyJoint(def){this.m_groundAnchor1=new b2Vec2(0,0);this.m_groundAnchor2=new b2Vec2(0,0);this.m_localAnchor1=new b2Vec2(0,0);this.m_localAnchor2=new b2Vec2(0,0);this.m_u1=new b2Vec2(0,0);this.m_u2=new b2Vec2(0,0);b2Joint.call(this,def);this.m_ground=this.m_bodyA.m_world.m_groundBody;this.m_groundAnchor1.x=def.groundAnchorA.x-this.m_ground.m_xf.position.x;this.m_groundAnchor1.y=def.groundAnchorA.y-this.m_ground.m_xf.position.y;this.m_groundAnchor2.x=def.groundAnchorB.x-this.m_ground.m_xf.position.x;this.m_groundAnchor2.y=def.groundAnchorB.y-this.m_ground.m_xf.position.y;this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_ratio=def.ratio;this.m_constant=def.lengthA+this.m_ratio*def.lengthB;this.m_maxLength1=b2Math.Min(def.maxLengthA,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength);this.m_maxLength2=b2Math.Min(def.maxLengthB,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio)};b2PulleyJoint.constructor=b2PulleyJoint;b2PulleyJoint.b2_minPulleyLength=2;b2PulleyJoint.prototype=Object.create(b2Joint.prototype);b2PulleyJoint.prototype.m_localXAxis1=null;b2PulleyJoint.prototype.m_localYAxis1=null;b2PulleyJoint.prototype.m_u1=null;b2PulleyJoint.prototype.m_u2=null;b2PulleyJoint.prototype.m_ground=null;b2PulleyJoint.prototype.m_ratio=0;b2PulleyJoint.prototype.m_constant=0;b2PulleyJoint.prototype.m_maxLength1=0;b2PulleyJoint.prototype.m_maxLength2=0;b2PulleyJoint.prototype.m_impulse=0;b2PulleyJoint.prototype.m_limitImpulse1=0;b2PulleyJoint.prototype.m_limitImpulse2=0;b2PulleyJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2PulleyJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2PulleyJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse*this.m_u2.x,inv_dt*this.m_impulse*this.m_u2.y)};b2PulleyJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2PulleyJoint.prototype.GetGroundAnchorA=function(){var a=this.m_ground.m_xf.position.Copy();a.Add(this.m_groundAnchor1);return a};b2PulleyJoint.prototype.GetGroundAnchorB=function(){var a=this.m_ground.m_xf.position.Copy();a.Add(this.m_groundAnchor2);return a};b2PulleyJoint.prototype.GetLength1=function(){var p=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),sX=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,sY=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,dX=p.x-sX,dY=p.y-sY;return Math.sqrt(dX*dX+dY*dY)};b2PulleyJoint.prototype.GetLength2=function(){var p=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),sX=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,sY=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,dX=p.x-sX,dY=p.y-sY;return Math.sqrt(dX*dX+dY*dY)};b2PulleyJoint.prototype.GetRatio=function(){return this.m_ratio};b2PulleyJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var p1X=bA.m_sweep.c.x+r1X,p1Y=bA.m_sweep.c.y+r1Y,p2X=bB.m_sweep.c.x+r2X,p2Y=bB.m_sweep.c.y+r2Y,s1X=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,s1Y=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,s2X=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,s2Y=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);this.m_u2.Set(p2X-s2X,p2Y-s2Y);var length1=this.m_u1.Length(),length2=this.m_u2.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.Multiply(1/length1)}else{this.m_u1.SetZero()}if(length2>b2Settings.b2_linearSlop){this.m_u2.Multiply(1/length2)}else{this.m_u2.SetZero()}var C=this.m_constant-length1-this.m_ratio*length2;if(C>0){this.m_state=b2Joint.e_inactiveLimit;this.m_impulse=0}else{this.m_state=b2Joint.e_atUpperLimit}if(length1<this.m_maxLength1){this.m_limitState1=b2Joint.e_inactiveLimit;this.m_limitImpulse1=0}else{this.m_limitState1=b2Joint.e_atUpperLimit}if(length2<this.m_maxLength2){this.m_limitState2=b2Joint.e_inactiveLimit;this.m_limitImpulse2=0}else{this.m_limitState2=b2Joint.e_atUpperLimit}var cr1u1=r1X*this.m_u1.y-r1Y*this.m_u1.x,cr2u2=r2X*this.m_u2.y-r2Y*this.m_u2.x;this.m_limitMass1=bA.m_invMass+bA.m_invI*cr1u1*cr1u1;this.m_limitMass2=bB.m_invMass+bB.m_invI*cr2u2*cr2u2;this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2;this.m_limitMass1=1/this.m_limitMass1;this.m_limitMass2=1/this.m_limitMass2;this.m_pulleyMass=1/this.m_pulleyMass;if(step.warmStarting){this.m_impulse*=step.dtRatio;this.m_limitImpulse1*=step.dtRatio;this.m_limitImpulse2*=step.dtRatio;var P1X=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,P1Y=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,P2X=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,P2Y=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;bA.m_linearVelocity.x+=bA.m_invMass*P1X;bA.m_linearVelocity.y+=bA.m_invMass*P1Y;bA.m_angularVelocity+=bA.m_invI*(r1X*P1Y-r1Y*P1X);bB.m_linearVelocity.x+=bB.m_invMass*P2X;bB.m_linearVelocity.y+=bB.m_invMass*P2Y;bB.m_angularVelocity+=bB.m_invI*(r2X*P2Y-r2Y*P2X)}else{this.m_impulse=0;this.m_limitImpulse1=0;this.m_limitImpulse2=0}};b2PulleyJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var v1X=0,v1Y=0,v2X=0,v2Y=0,P1X=0,P1Y=0,P2X=0,P2Y=0,Cdot=0,impulse=0,oldImpulse=0;if(this.m_state===b2Joint.e_atUpperLimit){v1X=bA.m_linearVelocity.x+-bA.m_angularVelocity*r1Y;v1Y=bA.m_linearVelocity.y+bA.m_angularVelocity*r1X;v2X=bB.m_linearVelocity.x+-bB.m_angularVelocity*r2Y;v2Y=bB.m_linearVelocity.y+bB.m_angularVelocity*r2X;Cdot=-(this.m_u1.x*v1X+this.m_u1.y*v1Y)-this.m_ratio*(this.m_u2.x*v2X+this.m_u2.y*v2Y);impulse=this.m_pulleyMass*-Cdot;oldImpulse=this.m_impulse;this.m_impulse=b2Math.Max(0,this.m_impulse+impulse);impulse=this.m_impulse-oldImpulse;P1X=-impulse*this.m_u1.x;P1Y=-impulse*this.m_u1.y;P2X=-this.m_ratio*impulse*this.m_u2.x;P2Y=-this.m_ratio*impulse*this.m_u2.y;bA.m_linearVelocity.x+=bA.m_invMass*P1X;bA.m_linearVelocity.y+=bA.m_invMass*P1Y;bA.m_angularVelocity+=bA.m_invI*(r1X*P1Y-r1Y*P1X);bB.m_linearVelocity.x+=bB.m_invMass*P2X;bB.m_linearVelocity.y+=bB.m_invMass*P2Y;bB.m_angularVelocity+=bB.m_invI*(r2X*P2Y-r2Y*P2X)}if(this.m_limitState1===b2Joint.e_atUpperLimit){v1X=bA.m_linearVelocity.x+-bA.m_angularVelocity*r1Y;v1Y=bA.m_linearVelocity.y+bA.m_angularVelocity*r1X;Cdot=-(this.m_u1.x*v1X+this.m_u1.y*v1Y);impulse=-this.m_limitMass1*Cdot;oldImpulse=this.m_limitImpulse1;this.m_limitImpulse1=b2Math.Max(0,this.m_limitImpulse1+impulse);impulse=this.m_limitImpulse1-oldImpulse;P1X=-impulse*this.m_u1.x;P1Y=-impulse*this.m_u1.y;bA.m_linearVelocity.x+=bA.m_invMass*P1X;bA.m_linearVelocity.y+=bA.m_invMass*P1Y;bA.m_angularVelocity+=bA.m_invI*(r1X*P1Y-r1Y*P1X)}if(this.m_limitState2===b2Joint.e_atUpperLimit){v2X=bB.m_linearVelocity.x+-bB.m_angularVelocity*r2Y;v2Y=bB.m_linearVelocity.y+bB.m_angularVelocity*r2X;Cdot=-(this.m_u2.x*v2X+this.m_u2.y*v2Y);impulse=-this.m_limitMass2*Cdot;oldImpulse=this.m_limitImpulse2;this.m_limitImpulse2=b2Math.Max(0,this.m_limitImpulse2+impulse);impulse=this.m_limitImpulse2-oldImpulse;P2X=-impulse*this.m_u2.x;P2Y=-impulse*this.m_u2.y;bB.m_linearVelocity.x+=bB.m_invMass*P2X;bB.m_linearVelocity.y+=bB.m_invMass*P2Y;bB.m_angularVelocity+=bB.m_invI*(r2X*P2Y-r2Y*P2X)}};b2PulleyJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var bA=this.m_bodyA,bB=this.m_bodyB,tMat,s1X=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,s1Y=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,s2X=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,s2Y=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,r1X=0,r1Y=0,r2X=0,r2Y=0,p1X=0,p1Y=0,p2X=0,p2Y=0,length1=0,length2=0,C=0,impulse=0,oldImpulse=0,oldLimitPositionImpulse=0,tX=0,linearError=0;if(this.m_state===b2Joint.e_atUpperLimit){tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;p1X=bA.m_sweep.c.x+r1X;p1Y=bA.m_sweep.c.y+r1Y;p2X=bB.m_sweep.c.x+r2X;p2Y=bB.m_sweep.c.y+r2Y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);this.m_u2.Set(p2X-s2X,p2Y-s2Y);length1=this.m_u1.Length();length2=this.m_u2.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.Multiply(1/length1)}else{this.m_u1.SetZero()}if(length2>b2Settings.b2_linearSlop){this.m_u2.Multiply(1/length2)}else{this.m_u2.SetZero()}C=this.m_constant-length1-this.m_ratio*length2;linearError=b2Math.Max(linearError,-C);C=b2Math.Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_pulleyMass*C;p1X=-impulse*this.m_u1.x;p1Y=-impulse*this.m_u1.y;p2X=-this.m_ratio*impulse*this.m_u2.x;p2Y=-this.m_ratio*impulse*this.m_u2.y;bA.m_sweep.c.x+=bA.m_invMass*p1X;bA.m_sweep.c.y+=bA.m_invMass*p1Y;bA.m_sweep.a+=bA.m_invI*(r1X*p1Y-r1Y*p1X);bB.m_sweep.c.x+=bB.m_invMass*p2X;bB.m_sweep.c.y+=bB.m_invMass*p2Y;bB.m_sweep.a+=bB.m_invI*(r2X*p2Y-r2Y*p2X);bA.SynchronizeTransform();bB.SynchronizeTransform()}if(this.m_limitState1===b2Joint.e_atUpperLimit){tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;p1X=bA.m_sweep.c.x+r1X;p1Y=bA.m_sweep.c.y+r1Y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);length1=this.m_u1.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.x*=1/length1;this.m_u1.y*=1/length1}else{this.m_u1.SetZero()}C=this.m_maxLength1-length1;linearError=b2Math.Max(linearError,-C);C=b2Math.Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_limitMass1*C;p1X=-impulse*this.m_u1.x;p1Y=-impulse*this.m_u1.y;bA.m_sweep.c.x+=bA.m_invMass*p1X;bA.m_sweep.c.y+=bA.m_invMass*p1Y;bA.m_sweep.a+=bA.m_invI*(r1X*p1Y-r1Y*p1X);bA.SynchronizeTransform()}if(this.m_limitState2===b2Joint.e_atUpperLimit){tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;p2X=bB.m_sweep.c.x+r2X;p2Y=bB.m_sweep.c.y+r2Y;this.m_u2.Set(p2X-s2X,p2Y-s2Y);length2=this.m_u2.Length();if(length2>b2Settings.b2_linearSlop){this.m_u2.x*=1/length2;this.m_u2.y*=1/length2}else{this.m_u2.SetZero()}C=this.m_maxLength2-length2;linearError=b2Math.Max(linearError,-C);C=b2Math.Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_limitMass2*C;p2X=-impulse*this.m_u2.x;p2Y=-impulse*this.m_u2.y;bB.m_sweep.c.x+=bB.m_invMass*p2X;bB.m_sweep.c.y+=bB.m_invMass*p2Y;bB.m_sweep.a+=bB.m_invI*(r2X*p2Y-r2Y*p2X);bB.SynchronizeTransform()}return linearError<b2Settings.b2_linearSlop};b2PulleyJoint.prototype.GetType=function(){return this.m_type};b2PulleyJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2PulleyJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2PulleyJoint.prototype.GetNext=function(){return this.m_next};b2PulleyJoint.prototype.GetUserData=function(){return this.m_userData};b2PulleyJoint.prototype.SetUserData=function(data){this.m_userData=data};b2PulleyJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2PulleyJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2PulleyJoint.prototype.FinalizeVelocityConstraints=function(){};b2PulleyJointDef=Box2D.Dynamics.Joints.b2PulleyJointDef=function b2PulleyJointDef(){this.groundAnchorA=new b2Vec2(0,0);this.groundAnchorB=new b2Vec2(0,0);this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0);this.groundAnchorA.Set(-1,1);this.groundAnchorB.Set(1,1);this.localAnchorA.Set(-1,0);this.localAnchorB.Set(1,0)};b2PulleyJointDef.constructor=b2PulleyJointDef;b2PulleyJointDef.prototype=Object.create(b2JointDef.prototype);b2PulleyJointDef.prototype.type=b2Joint.e_pulleyJoint;b2PulleyJointDef.prototype.groundAnchorA=null;b2PulleyJointDef.prototype.groundAnchorB=null;b2PulleyJointDef.prototype.localAnchorA=null;b2PulleyJointDef.prototype.localAnchorB=null;b2PulleyJointDef.prototype.lengthA=0;b2PulleyJointDef.prototype.maxLengthA=0;b2PulleyJointDef.prototype.lengthB=0;b2PulleyJointDef.prototype.maxLengthB=0;b2PulleyJointDef.prototype.ratio=1;b2PulleyJointDef.prototype.collideConnected=true;b2PulleyJointDef.prototype.Initialize=function(bA,bB,gaA,gaB,anchorA,anchorB,r){r=r||0;this.bodyA=bA;this.bodyB=bB;this.groundAnchorA.SetV(gaA);this.groundAnchorB.SetV(gaB);this.localAnchorA=this.bodyA.GetLocalPoint(anchorA);this.localAnchorB=this.bodyB.GetLocalPoint(anchorB);var d1X=anchorA.x-gaA.x,d1Y=anchorA.y-gaA.y;this.lengthA=Math.sqrt(d1X*d1X+d1Y*d1Y);var d2X=anchorB.x-gaB.x,d2Y=anchorB.y-gaB.y;this.lengthB=Math.sqrt(d2X*d2X+d2Y*d2Y);this.ratio=r;var C=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=C-this.ratio*b2PulleyJoint.b2_minPulleyLength;this.maxLengthB=(C-b2PulleyJoint.b2_minPulleyLength)/this.ratio};b2PulleyJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2RevoluteJoint=Box2D.Dynamics.Joints.b2RevoluteJoint=function b2RevoluteJoint(def){this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.K3=new b2Mat22;this.impulse3=new b2Vec3(0,0,0);this.impulse2=new b2Vec2(0,0);this.reduced=new b2Vec2(0,0);this.m_localAnchor1=new b2Vec2(0,0);this.m_localAnchor2=new b2Vec2(0,0);this.m_impulse=new b2Vec3(0,0,0);this.m_mass=new b2Mat33;b2Joint.call(this,def);this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_referenceAngle=def.referenceAngle;this.m_impulse.SetZero();this.m_lowerAngle=def.lowerAngle;this.m_upperAngle=def.upperAngle;this.m_maxMotorTorque=def.maxMotorTorque;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=b2Joint.e_inactiveLimit};b2RevoluteJoint.constructor=b2RevoluteJoint;b2RevoluteJoint.prototype=Object.create(b2Joint.prototype);b2RevoluteJoint.prototype.K=null;b2RevoluteJoint.prototype.K1=null;b2RevoluteJoint.prototype.K2=null;b2RevoluteJoint.prototype.K3=null;b2RevoluteJoint.prototype.impulse2=null;b2RevoluteJoint.prototype.impulse3=null;b2RevoluteJoint.prototype.reduced=null;b2RevoluteJoint.prototype.m_impulse=null;b2RevoluteJoint.prototype.m_mass=0;b2RevoluteJoint.prototype.m_referenceAngle=0;b2RevoluteJoint.prototype.m_motorImpulse=0;b2RevoluteJoint.prototype.m_lowerAngle=0;b2RevoluteJoint.prototype.m_upperAngle=0;b2RevoluteJoint.prototype.m_maxMotorTorque=0;b2RevoluteJoint.prototype.m_motorSpeed=0;b2RevoluteJoint.prototype.m_enableLimit=0;b2RevoluteJoint.prototype.m_enableMotor=false;b2RevoluteJoint.prototype.m_limitState=b2Joint.e_inactiveLimit;b2RevoluteJoint.tImpulse=new b2Vec2(0,0);b2RevoluteJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2RevoluteJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2RevoluteJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse.x,inv_dt*this.m_impulse.y)};b2RevoluteJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.z};b2RevoluteJoint.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle};b2RevoluteJoint.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity};b2RevoluteJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit};b2RevoluteJoint.prototype.EnableLimit=function(flag){this.m_enableLimit=flag};b2RevoluteJoint.prototype.GetLowerLimit=function(){return this.m_lowerAngle};b2RevoluteJoint.prototype.GetUpperLimit=function(){return this.m_upperAngle};b2RevoluteJoint.prototype.SetLimits=function(lower,upper){lower=lower||0;upper=upper||0;this.m_lowerAngle=lower;this.m_upperAngle=upper};b2RevoluteJoint.prototype.IsMotorEnabled=function(){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);return this.m_enableMotor};b2RevoluteJoint.prototype.EnableMotor=function(flag){this.m_enableMotor=flag};b2RevoluteJoint.prototype.SetMotorSpeed=function(speed){speed=speed||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed};b2RevoluteJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed};b2RevoluteJoint.prototype.SetMaxMotorTorque=function(torque){torque=torque||0;this.m_maxMotorTorque=torque};b2RevoluteJoint.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque};b2RevoluteJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0;if(this.m_enableMotor||this.m_enableLimit){b2Assert(bA.m_invI>0||bB.m_invI>0)}tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var m1=bA.m_invMass,m2=bB.m_invMass,i1=bA.m_invI,i2=bB.m_invI;this.m_mass.col1.x=m1+m2+r1Y*r1Y*i1+r2Y*r2Y*i2;this.m_mass.col2.x=-r1Y*r1X*i1-r2Y*r2X*i2;this.m_mass.col3.x=-r1Y*i1-r2Y*i2;this.m_mass.col1.y=this.m_mass.col2.x;this.m_mass.col2.y=m1+m2+r1X*r1X*i1+r2X*r2X*i2;this.m_mass.col3.y=r1X*i1+r2X*i2;this.m_mass.col1.z=this.m_mass.col3.x;this.m_mass.col2.z=this.m_mass.col3.y;this.m_mass.col3.z=i1+i2;this.m_motorMass=1/(i1+i2);if(this.m_enableMotor===false){this.m_motorImpulse=0}if(this.m_enableLimit){var jointAngle=bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle;if(b2Math.Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointAngle<=this.m_lowerAngle){if(this.m_limitState!==b2Joint.e_atLowerLimit){this.m_impulse.z=0}this.m_limitState=b2Joint.e_atLowerLimit}else if(jointAngle>=this.m_upperAngle){if(this.m_limitState!==b2Joint.e_atUpperLimit){this.m_impulse.z=0}this.m_limitState=b2Joint.e_atUpperLimit}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_impulse.z=0}}else{this.m_limitState=b2Joint.e_inactiveLimit}if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_motorImpulse*=step.dtRatio;var PX=this.m_impulse.x,PY=this.m_impulse.y;bA.m_linearVelocity.x-=m1*PX;bA.m_linearVelocity.y-=m1*PY;bA.m_angularVelocity-=i1*(r1X*PY-r1Y*PX+this.m_motorImpulse+this.m_impulse.z);bB.m_linearVelocity.x+=m2*PX;bB.m_linearVelocity.y+=m2*PY;bB.m_angularVelocity+=i2*(r2X*PY-r2Y*PX+this.m_motorImpulse+this.m_impulse.z)}else{this.m_impulse.SetZero();this.m_motorImpulse=0}};b2RevoluteJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0,newImpulse=0,r1X=0,r1Y=0,r2X=0,r2Y=0,v1=bA.m_linearVelocity,w1=bA.m_angularVelocity,v2=bB.m_linearVelocity,w2=bB.m_angularVelocity,m1=bA.m_invMass,m2=bB.m_invMass,i1=bA.m_invI,i2=bB.m_invI;if(this.m_enableMotor&&this.m_limitState!==b2Joint.e_equalLimits){var Cdot=w2-w1-this.m_motorSpeed,impulse=this.m_motorMass*-Cdot,oldImpulse=this.m_motorImpulse,maxImpulse=step.dt*this.m_maxMotorTorque;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;w1-=i1*impulse;w2+=i2*impulse}if(this.m_enableLimit&&this.m_limitState!==b2Joint.e_inactiveLimit){tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var Cdot1X=v2.x+-w2*r2Y-v1.x- -w1*r1Y,Cdot1Y=v2.y+w2*r2X-v1.y-w1*r1X,Cdot2=w2-w1;this.m_mass.Solve33(this.impulse3,-Cdot1X,-Cdot1Y,-Cdot2);if(this.m_limitState===b2Joint.e_equalLimits){this.m_impulse.Add(this.impulse3)}else if(this.m_limitState===b2Joint.e_atLowerLimit){newImpulse=this.m_impulse.z+this.impulse3.z;if(newImpulse<0){this.m_mass.Solve22(this.reduced,-Cdot1X,-Cdot1Y);this.impulse3.x=this.reduced.x;this.impulse3.y=this.reduced.y;this.impulse3.z=-this.m_impulse.z;this.m_impulse.x+=this.reduced.x;this.m_impulse.y+=this.reduced.y;this.m_impulse.z=0}}else if(this.m_limitState===b2Joint.e_atUpperLimit){newImpulse=this.m_impulse.z+this.impulse3.z;if(newImpulse>0){this.m_mass.Solve22(this.reduced,-Cdot1X,-Cdot1Y);this.impulse3.x=this.reduced.x;this.impulse3.y=this.reduced.y;this.impulse3.z=-this.m_impulse.z;this.m_impulse.x+=this.reduced.x;this.m_impulse.y+=this.reduced.y;this.m_impulse.z=0}}v1.x-=m1*this.impulse3.x;v1.y-=m1*this.impulse3.y;w1-=i1*(r1X*this.impulse3.y-r1Y*this.impulse3.x+this.impulse3.z);v2.x+=m2*this.impulse3.x;v2.y+=m2*this.impulse3.y;w2+=i2*(r2X*this.impulse3.y-r2Y*this.impulse3.x+this.impulse3.z)}else{tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var CdotX=v2.x+-w2*r2Y-v1.x- -w1*r1Y,CdotY=v2.y+w2*r2X-v1.y-w1*r1X;this.m_mass.Solve22(this.impulse2,-CdotX,-CdotY);this.m_impulse.x+=this.impulse2.x;this.m_impulse.y+=this.impulse2.y;v1.x-=m1*this.impulse2.x;v1.y-=m1*this.impulse2.y;w1-=i1*(r1X*this.impulse2.y-r1Y*this.impulse2.x);v2.x+=m2*this.impulse2.x;v2.y+=m2*this.impulse2.y;w2+=i2*(r2X*this.impulse2.y-r2Y*this.impulse2.x)}bA.m_linearVelocity.SetV(v1);bA.m_angularVelocity=w1;bB.m_linearVelocity.SetV(v2);bB.m_angularVelocity=w2};b2RevoluteJoint.prototype.SolvePositionConstraints=function(baumgarte){var oldLimitImpulse=0,C=0,tMat,bA=this.m_bodyA,bB=this.m_bodyB,angularError=0,positionError=0,tX=0,impulseX=0,impulseY=0;if(this.m_enableLimit&&this.m_limitState!==b2Joint.e_inactiveLimit){var angle=bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle,limitImpulse=0;if(this.m_limitState===b2Joint.e_equalLimits){C=b2Math.Clamp(angle-this.m_lowerAngle,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection);limitImpulse=-this.m_motorMass*C;angularError=b2Math.Abs(C)}else if(this.m_limitState===b2Joint.e_atLowerLimit){C=angle-this.m_lowerAngle;angularError=-C;C=b2Math.Clamp(C+b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0);limitImpulse=-this.m_motorMass*C}else if(this.m_limitState===b2Joint.e_atUpperLimit){C=angle-this.m_upperAngle;angularError=C;C=b2Math.Clamp(C-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection);limitImpulse=-this.m_motorMass*C}bA.m_sweep.a-=bA.m_invI*limitImpulse;bB.m_sweep.a+=bB.m_invI*limitImpulse;bA.SynchronizeTransform();bB.SynchronizeTransform()}{tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var CX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,CY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y,CLengthSquared=CX*CX+CY*CY,CLength=Math.sqrt(CLengthSquared);positionError=CLength;var invMass1=bA.m_invMass,invMass2=bB.m_invMass,invI1=bA.m_invI,invI2=bB.m_invI,k_allowedStretch=10*b2Settings.b2_linearSlop;if(CLengthSquared>k_allowedStretch*k_allowedStretch){var uX=CX/CLength,uY=CY/CLength,k=invMass1+invMass2,m=1/k;impulseX=m*-CX;impulseY=m*-CY;var k_beta=.5;bA.m_sweep.c.x-=k_beta*invMass1*impulseX;bA.m_sweep.c.y-=k_beta*invMass1*impulseY;bB.m_sweep.c.x+=k_beta*invMass2*impulseX;bB.m_sweep.c.y+=k_beta*invMass2*impulseY;CX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X;CY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y}this.K1.col1.x=invMass1+invMass2;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass1+invMass2;this.K2.col1.x=invI1*r1Y*r1Y;this.K2.col2.x=-invI1*r1X*r1Y;this.K2.col1.y=-invI1*r1X*r1Y;this.K2.col2.y=invI1*r1X*r1X;this.K3.col1.x=invI2*r2Y*r2Y;this.K3.col2.x=-invI2*r2X*r2Y;this.K3.col1.y=-invI2*r2X*r2Y;this.K3.col2.y=invI2*r2X*r2X;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Solve(b2RevoluteJoint.tImpulse,-CX,-CY);impulseX=b2RevoluteJoint.tImpulse.x;impulseY=b2RevoluteJoint.tImpulse.y;bA.m_sweep.c.x-=bA.m_invMass*impulseX;bA.m_sweep.c.y-=bA.m_invMass*impulseY;bA.m_sweep.a-=bA.m_invI*(r1X*impulseY-r1Y*impulseX);bB.m_sweep.c.x+=bB.m_invMass*impulseX;bB.m_sweep.c.y+=bB.m_invMass*impulseY;bB.m_sweep.a+=bB.m_invI*(r2X*impulseY-r2Y*impulseX);bA.SynchronizeTransform();bB.SynchronizeTransform()}return positionError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2RevoluteJoint.prototype.GetType=function(){return this.m_type};b2RevoluteJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2RevoluteJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2RevoluteJoint.prototype.GetNext=function(){return this.m_next};b2RevoluteJoint.prototype.GetUserData=function(){return this.m_userData};b2RevoluteJoint.prototype.SetUserData=function(data){this.m_userData=data};b2RevoluteJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2RevoluteJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);
this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2RevoluteJoint.prototype.FinalizeVelocityConstraints=function(){};b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef=function b2RevoluteJointDef(){this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0);b2JointDef.call(this);this.type=b2Joint.e_revoluteJoint;this.localAnchorA.Set(0,0);this.localAnchorB.Set(0,0)};b2RevoluteJointDef.constructor=b2RevoluteJointDef;b2RevoluteJointDef.prototype=Object.create(b2JointDef.prototype);b2RevoluteJointDef.prototype.type=b2Joint.e_revoluteJoint;b2RevoluteJointDef.prototype.localAnchorA=null;b2RevoluteJointDef.prototype.localAnchorB=null;b2RevoluteJointDef.prototype.referenceAngle=0;b2RevoluteJointDef.prototype.lowerAngle=0;b2RevoluteJointDef.prototype.upperAngle=0;b2RevoluteJointDef.prototype.maxMotorTorque=0;b2RevoluteJointDef.prototype.motorSpeed=0;b2RevoluteJointDef.prototype.enableLimit=false;b2RevoluteJointDef.prototype.enableMotor=false;b2RevoluteJointDef.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()};b2RevoluteJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2WeldJoint=Box2D.Dynamics.Joints.b2WeldJoint=function b2WeldJoint(def){this.m_localAnchorA=new b2Vec2(0,0);this.m_localAnchorB=new b2Vec2(0,0);this.m_impulse=new b2Vec3(0,0,0);this.m_mass=new b2Mat33;b2Joint.call(this,def);this.m_localAnchorA.SetV(def.localAnchorA);this.m_localAnchorB.SetV(def.localAnchorB);this.m_referenceAngle=def.referenceAngle;this.m_impulse.SetZero();this.m_mass=new b2Mat33};b2WeldJoint.constructor=b2WeldJoint;b2WeldJoint.prototype=Object.create(b2Joint.prototype);b2WeldJoint.prototype.m_impulse=null;b2WeldJoint.prototype.m_mass=null;b2WeldJoint.prototype.m_referenceAngle=0;b2WeldJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)};b2WeldJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)};b2WeldJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse.x,inv_dt*this.m_impulse.y)};b2WeldJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.z};b2WeldJoint.prototype.InitVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI;this.m_mass.col1.x=mA+mB+rAY*rAY*iA+rBY*rBY*iB;this.m_mass.col2.x=-rAY*rAX*iA-rBY*rBX*iB;this.m_mass.col3.x=-rAY*iA-rBY*iB;this.m_mass.col1.y=this.m_mass.col2.x;this.m_mass.col2.y=mA+mB+rAX*rAX*iA+rBX*rBX*iB;this.m_mass.col3.y=rAX*iA+rBX*iB;this.m_mass.col1.z=this.m_mass.col3.x;this.m_mass.col2.z=this.m_mass.col3.y;this.m_mass.col3.z=iA+iB;if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_impulse.z*=step.dtRatio;bA.m_linearVelocity.x-=mA*this.m_impulse.x;bA.m_linearVelocity.y-=mA*this.m_impulse.y;bA.m_angularVelocity-=iA*(rAX*this.m_impulse.y-rAY*this.m_impulse.x+this.m_impulse.z);bB.m_linearVelocity.x+=mB*this.m_impulse.x;bB.m_linearVelocity.y+=mB*this.m_impulse.y;bB.m_angularVelocity+=iB*(rBX*this.m_impulse.y-rBY*this.m_impulse.x+this.m_impulse.z)}else{this.m_impulse.SetZero()}};b2WeldJoint.prototype.SolveVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB,vA=bA.m_linearVelocity,wA=bA.m_angularVelocity,vB=bB.m_linearVelocity,wB=bB.m_angularVelocity,mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var Cdot1X=vB.x-wB*rBY-vA.x+wA*rAY,Cdot1Y=vB.y+wB*rBX-vA.y-wA*rAX,Cdot2=wB-wA,impulse=new b2Vec3(0,0,0);this.m_mass.Solve33(impulse,-Cdot1X,-Cdot1Y,-Cdot2);this.m_impulse.Add(impulse);vA.x-=mA*impulse.x;vA.y-=mA*impulse.y;wA-=iA*(rAX*impulse.y-rAY*impulse.x+impulse.z);vB.x+=mB*impulse.x;vB.y+=mB*impulse.y;wB+=iB*(rBX*impulse.y-rBY*impulse.x+impulse.z);bA.m_angularVelocity=wA;bB.m_angularVelocity=wB};b2WeldJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI,C1X=bB.m_sweep.c.x+rBX-bA.m_sweep.c.x-rAX,C1Y=bB.m_sweep.c.y+rBY-bA.m_sweep.c.y-rAY,C2=bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle,k_allowedStretch=10*b2Settings.b2_linearSlop,positionError=Math.sqrt(C1X*C1X+C1Y*C1Y),angularError=b2Math.Abs(C2);if(positionError>k_allowedStretch){iA*=1;iB*=1}this.m_mass.col1.x=mA+mB+rAY*rAY*iA+rBY*rBY*iB;this.m_mass.col2.x=-rAY*rAX*iA-rBY*rBX*iB;this.m_mass.col3.x=-rAY*iA-rBY*iB;this.m_mass.col1.y=this.m_mass.col2.x;this.m_mass.col2.y=mA+mB+rAX*rAX*iA+rBX*rBX*iB;this.m_mass.col3.y=rAX*iA+rBX*iB;this.m_mass.col1.z=this.m_mass.col3.x;this.m_mass.col2.z=this.m_mass.col3.y;this.m_mass.col3.z=iA+iB;var impulse=new b2Vec3(0,0,0);this.m_mass.Solve33(impulse,-C1X,-C1Y,-C2);bA.m_sweep.c.x-=mA*impulse.x;bA.m_sweep.c.y-=mA*impulse.y;bA.m_sweep.a-=iA*(rAX*impulse.y-rAY*impulse.x+impulse.z);bB.m_sweep.c.x+=mB*impulse.x;bB.m_sweep.c.y+=mB*impulse.y;bB.m_sweep.a+=iB*(rBX*impulse.y-rBY*impulse.x+impulse.z);bA.SynchronizeTransform();bB.SynchronizeTransform();return positionError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2WeldJoint.prototype.GetType=function(){return this.m_type};b2WeldJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2WeldJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2WeldJoint.prototype.GetNext=function(){return this.m_next};b2WeldJoint.prototype.GetUserData=function(){return this.m_userData};b2WeldJoint.prototype.SetUserData=function(data){this.m_userData=data};b2WeldJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2WeldJoint.prototype.b2Joint=function(def){b2Assert(def.bodyA!==def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2WeldJoint.prototype.FinalizeVelocityConstraints=function(){};b2WeldJointDef=Box2D.Dynamics.Joints.b2WeldJointDef=function b2WeldJointDef(){this.localAnchorA=new b2Vec2(0,0);this.localAnchorB=new b2Vec2(0,0)};b2WeldJointDef.constructor=b2WeldJointDef;b2WeldJointDef.prototype=Object.create(b2JointDef.prototype);b2WeldJointDef.prototype.type=b2Joint.e_weldJoint;b2WeldJointDef.prototype.referenceAngle=0;b2WeldJointDef.prototype.localAnchorA=null;b2WeldJointDef.prototype.localAnchorB=null;b2WeldJointDef.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchor));this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchor));this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()};b2WeldJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2ContactListener=Box2D.Dynamics.b2ContactListener=function b2ContactListener(){};b2ContactListener.constructor=b2ContactListener;b2ContactListener.prototype={BeginContact:function(contact){},EndContact:function(contact){},PreSolve:function(contact,oldManifold){},PostSolve:function(contact,impulse){}};b2ContactListener.b2_defaultListener=new b2ContactListener;b2ContactFilter=Box2D.Dynamics.b2ContactFilter=function b2ContactFilter(){};b2ContactFilter.constructor=b2ContactFilter;b2ContactFilter.prototype={ShouldCollide:function(fixtureA,fixtureB){var filter1=fixtureA.GetFilterData(),filter2=fixtureB.GetFilterData();if(filter1.groupIndex===filter2.groupIndex&&filter1.groupIndex!==0){return filter1.groupIndex>0}return(filter1.maskBits&filter2.categoryBits)!==0&&(filter1.categoryBits&filter2.maskBits)!==0},RayCollide:function(userData,fixture){if(!userData)return true;return this.ShouldCollide(userData instanceof b2Fixture?userData:null,fixture)}};b2ContactFilter.b2_defaultFilter=new b2ContactFilter;b2Fixture=Box2D.Dynamics.b2Fixture=function b2Fixture(){this.m_filter=new b2FilterData;this.m_aabb=new b2AABB};b2Fixture.constructor=b2Fixture;b2Fixture.prototype={m_filter:null,m_shape:null,m_isSensor:false,m_body:null,m_next:null,m_userData:null,m_density:0,m_friction:0,m_restitution:0,m_aabb:null,m_proxy:null,GetType:function(){return this.m_shape.GetType()},GetShape:function(){return this.m_shape},SetSensor:function(sensor){if(this.m_isSensor===sensor)return;this.m_isSensor=sensor;if(this.m_body==null)return;var edge=this.m_body.GetContactList();while(edge){var contact=edge.contact,fixtureA=contact.GetFixtureA(),fixtureB=contact.GetFixtureB();if(fixtureA===this||fixtureB===this)contact.SetSensor(fixtureA.IsSensor()||fixtureB.IsSensor());edge=edge.next}},IsSensor:function(){return this.m_isSensor},SetFilterData:function(filter){this.m_filter=filter.Copy();if(this.m_body)return;var edge=this.m_body.GetContactList();while(edge){var contact=edge.contact,fixtureA=contact.GetFixtureA(),fixtureB=contact.GetFixtureB();if(fixtureA===this||fixtureB===this)contact.FlagForFiltering();edge=edge.next}},GetFilterData:function(){return this.m_filter.Copy()},GetBody:function(){return this.m_body},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},SetUserData:function(data){this.m_userData=data},TestPoint:function(p){return this.m_shape.TestPoint(this.m_body.GetTransform(),p)},RayCast:function(output,input){return this.m_shape.RayCast(output,input,this.m_body.GetTransform())},GetMassData:function(massData){massData=massData||null;if(massData==null){massData=new b2MassData}this.m_shape.ComputeMass(massData,this.m_density);return massData},SetDensity:function(density){density=density||0;this.m_density=density},GetDensity:function(){return this.m_density},GetFriction:function(){return this.m_friction},SetFriction:function(friction){friction=friction||0;this.m_friction=friction},GetRestitution:function(){return this.m_restitution},SetRestitution:function(restitution){restitution=restitution||0;this.m_restitution=restitution},GetAABB:function(){return this.m_aabb},Create:function(body,xf,def){this.m_userData=def.userData;this.m_friction=def.friction;this.m_restitution=def.restitution;this.m_body=body;this.m_next=null;this.m_filter=def.filter.Copy();this.m_isSensor=def.isSensor;this.m_shape=def.shape.Copy();this.m_density=def.density},Destroy:function(){this.m_shape=null},CreateProxy:function(broadPhase,xf){this.m_shape.ComputeAABB(this.m_aabb,xf);this.m_proxy=broadPhase.CreateProxy(this.m_aabb,this)},DestroyProxy:function(broadPhase){if(this.m_proxy==null){return}broadPhase.DestroyProxy(this.m_proxy);this.m_proxy=null},Synchronize:function(broadPhase,transform1,transform2){if(!this.m_proxy)return;var aabb1=new b2AABB,aabb2=new b2AABB;this.m_shape.ComputeAABB(aabb1,transform1);this.m_shape.ComputeAABB(aabb2,transform2);this.m_aabb.Combine(aabb1,aabb2);var displacement=b2Math.SubtractVV(transform2.position,transform1.position);broadPhase.MoveProxy(this.m_proxy,this.m_aabb,displacement)}};b2ContactManager=Box2D.Dynamics.b2ContactManager=function b2ContactManager(){this.m_world=null;this.m_contactCount=0;this.m_contactFilter=b2ContactFilter.b2_defaultFilter;this.m_contactListener=b2ContactListener.b2_defaultListener;this.m_contactFactory=new b2ContactFactory(this.m_allocator);this.m_broadPhase=new b2DynamicTreeBroadPhase};b2ContactManager.s_evalCP=new b2ContactPoint;b2ContactManager.constructor=b2ContactManager;b2ContactManager.prototype={m_world:null,m_contactCount:null,m_contactFilter:null,m_contactListener:null,m_contactFactory:null,m_broadPhase:null,AddPair:function(proxyUserDataA,proxyUserDataB){var fixtureA=proxyUserDataA instanceof b2Fixture?proxyUserDataA:null,fixtureB=proxyUserDataB instanceof b2Fixture?proxyUserDataB:null,bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA===bodyB)return;var edge=bodyB.GetContactList();while(edge){if(edge.other===bodyA){var fA=edge.contact.GetFixtureA(),fB=edge.contact.GetFixtureB();if(fA===fixtureA&&fB===fixtureB)return;if(fA===fixtureB&&fB===fixtureA)return}edge=edge.next}if(bodyB.ShouldCollide(bodyA)===false){return}if(this.m_contactFilter.ShouldCollide(fixtureA,fixtureB)===false){return}var c=this.m_contactFactory.Create(fixtureA,fixtureB);fixtureA=c.GetFixtureA();fixtureB=c.GetFixtureB();bodyA=fixtureA.m_body;bodyB=fixtureB.m_body;c.m_prev=null;c.m_next=this.m_world.m_contactList;if(this.m_world.m_contactList!=null){this.m_world.m_contactList.m_prev=c}this.m_world.m_contactList=c;c.m_nodeA.contact=c;c.m_nodeA.other=bodyB;c.m_nodeA.prev=null;c.m_nodeA.next=bodyA.m_contactList;if(bodyA.m_contactList!=null){bodyA.m_contactList.prev=c.m_nodeA}bodyA.m_contactList=c.m_nodeA;c.m_nodeB.contact=c;c.m_nodeB.other=bodyA;c.m_nodeB.prev=null;c.m_nodeB.next=bodyB.m_contactList;if(bodyB.m_contactList!=null){bodyB.m_contactList.prev=c.m_nodeB}bodyB.m_contactList=c.m_nodeB;++this.m_world.m_contactCount},FindNewContacts:function(){var generateCallback=function(context,cb){return function(){cb.apply(context,arguments)}};this.m_broadPhase.UpdatePairs(generateCallback(this,this.AddPair))},Destroy:function(c){var fixtureA=c.GetFixtureA(),fixtureB=c.GetFixtureB(),bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(c.IsTouching()){this.m_contactListener.EndContact(c)}if(c.m_prev){c.m_prev.m_next=c.m_next}if(c.m_next){c.m_next.m_prev=c.m_prev}if(c===this.m_world.m_contactList){this.m_world.m_contactList=c.m_next}if(c.m_nodeA.prev){c.m_nodeA.prev.next=c.m_nodeA.next}if(c.m_nodeA.next){c.m_nodeA.next.prev=c.m_nodeA.prev}if(c.m_nodeA===bodyA.m_contactList){bodyA.m_contactList=c.m_nodeA.next}if(c.m_nodeB.prev){c.m_nodeB.prev.next=c.m_nodeB.next}if(c.m_nodeB.next){c.m_nodeB.next.prev=c.m_nodeB.prev}if(c.m_nodeB===bodyB.m_contactList){bodyB.m_contactList=c.m_nodeB.next}this.m_contactFactory.Destroy(c);--this.m_contactCount},Collide:function(){var c=this.m_world.m_contactList;while(c){var fixtureA=c.GetFixtureA(),fixtureB=c.GetFixtureB(),bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA.IsAwake()===false&&bodyB.IsAwake()===false){c=c.GetNext();continue}if(c.m_flags&b2Contact.e_filterFlag){if(bodyB.ShouldCollide(bodyA)===false){var cNuke=c;c=cNuke.GetNext();this.Destroy(cNuke);continue}if(this.m_contactFilter.ShouldCollide(fixtureA,fixtureB)===false){cNuke=c;c=cNuke.GetNext();this.Destroy(cNuke);continue}c.m_flags&=~b2Contact.e_filterFlag}var proxyA=fixtureA.m_proxy,proxyB=fixtureB.m_proxy,overlap=this.m_broadPhase.TestOverlap(proxyA,proxyB);if(overlap===false){cNuke=c;c=cNuke.GetNext();this.Destroy(cNuke);continue}c.Update(this.m_contactListener);c=c.GetNext()}}};b2Body=Box2D.Dynamics.b2Body=function b2Body(bd,world){this.m_xf=new b2Transform;this.m_sweep=new b2Sweep;this.m_linearVelocity=new b2Vec2(0,0);this.m_force=new b2Vec2(0,0);if(bd.bullet){this.m_flags|=b2Body.e_bulletFlag}if(bd.fixedRotation){this.m_flags|=b2Body.e_fixedRotationFlag}if(bd.allowSleep){this.m_flags|=b2Body.e_allowSleepFlag}if(bd.awake){this.m_flags|=b2Body.e_awakeFlag}if(bd.active){this.m_flags|=b2Body.e_activeFlag}this.m_world=world;this.m_xf.position.SetV(bd.position);this.m_xf.R.Set(bd.angle);this.m_sweep.localCenter.SetZero();this.m_sweep.t0=1;this.m_sweep.a0=this.m_sweep.a=bd.angle;var tMat=this.m_xf.R,tVec=this.m_sweep.localCenter;this.m_sweep.c.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_sweep.c.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_sweep.c.x+=this.m_xf.position.x;this.m_sweep.c.y+=this.m_xf.position.y;this.m_sweep.c0.SetV(this.m_sweep.c);this.m_linearVelocity.SetV(bd.linearVelocity);this.m_angularVelocity=bd.angularVelocity;this.m_linearDamping=bd.linearDamping;this.m_angularDamping=bd.angularDamping;this.m_force.Set(0,0);this.m_type=bd.type;if(this.m_type===b2Body.b2_dynamicBody){this.m_mass=1;this.m_invMass=1}this.m_inertiaScale=bd.inertiaScale;this.m_userData=bd.userData};b2Body.s_xf1=new b2Transform;b2Body.e_islandFlag=1;b2Body.e_awakeFlag=2;b2Body.e_allowSleepFlag=4;b2Body.e_bulletFlag=8;b2Body.e_fixedRotationFlag=16;b2Body.e_activeFlag=32;b2Body.b2_staticBody=0;b2Body.b2_kinematicBody=1;b2Body.b2_dynamicBody=2;b2Body.constructor=b2Body;b2Body.prototype={m_xf:null,m_sweep:null,m_flags:0,m_world:null,m_jointList:null,m_controllerList:null,m_contactList:null,m_controllerCount:0,m_prev:null,m_next:null,m_linearVelocity:null,m_angularVelocity:null,m_linearDamping:null,m_angularDamping:null,m_force:null,m_torque:0,m_sleepTime:0,m_type:0,m_mass:0,m_invMass:0,m_I:0,m_invI:0,m_inertiaScale:0,m_userData:null,m_fixtureList:null,m_fixtureCount:0,connectEdges:function(s1,s2,angle1){angle1=angle1||0;var angle2=Math.atan2(s2.GetDirectionVector().y,s2.GetDirectionVector().x),coreOffset=Math.tan((angle2-angle1)*.5),core=b2Math.MulFV(coreOffset,s2.GetDirectionVector());core=b2Math.SubtractVV(core,s2.GetNormalVector());core=b2Math.MulFV(b2Settings.b2_toiSlop,core);core=b2Math.AddVV(core,s2.GetVertex1());var cornerDir=b2Math.AddVV(s1.GetDirectionVector(),s2.GetDirectionVector());cornerDir.Normalize();var convex=b2Math.Dot(s1.GetDirectionVector(),s2.GetNormalVector())>0;s1.SetNextEdge(s2,core,cornerDir,convex);s2.SetPrevEdge(s1,core,cornerDir,convex);return angle2},CreateFixture:function(def){if(this.m_world.IsLocked()===true){return null}var fixture=new b2Fixture;fixture.Create(this,this.m_xf,def);if(this.m_flags&b2Body.e_activeFlag){var broadPhase=this.m_world.m_contactManager.m_broadPhase;fixture.CreateProxy(broadPhase,this.m_xf)}fixture.m_next=this.m_fixtureList;this.m_fixtureList=fixture;++this.m_fixtureCount;fixture.m_body=this;if(fixture.m_density>0){this.ResetMassData()}this.m_world.m_flags|=b2World.e_newFixture;return fixture},CreateFixture2:function(shape,density){density=density||0;var def=new b2FixtureDef;def.shape=shape;def.density=density;return this.CreateFixture(def)},DestroyFixture:function(fixture){if(this.m_world.IsLocked()===true){return}var node=this.m_fixtureList,ppF=null,found=false;while(node!=null){if(node===fixture){if(ppF)ppF.m_next=fixture.m_next;else this.m_fixtureList=fixture.m_next;found=true;break}ppF=node;node=node.m_next}var edge=this.m_contactList;while(edge){var c=edge.contact;edge=edge.next;var fixtureA=c.GetFixtureA(),fixtureB=c.GetFixtureB();if(fixture===fixtureA||fixture===fixtureB){this.m_world.m_contactManager.Destroy(c)}}if(this.m_flags&b2Body.e_activeFlag){var broadPhase=this.m_world.m_contactManager.m_broadPhase;fixture.DestroyProxy(broadPhase)}else{}fixture.Destroy();fixture.m_body=null;fixture.m_next=null;--this.m_fixtureCount;this.ResetMassData()},SetPositionAndAngle:function(position,angle){angle=angle||0;var f;if(this.m_world.IsLocked()===true){return}this.m_xf.R.Set(angle);this.m_xf.position.SetV(position);var tMat=this.m_xf.R,tVec=this.m_sweep.localCenter;this.m_sweep.c.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_sweep.c.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_sweep.c.x+=this.m_xf.position.x;this.m_sweep.c.y+=this.m_xf.position.y;this.m_sweep.c0.SetV(this.m_sweep.c);this.m_sweep.a0=this.m_sweep.a=angle;var broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.Synchronize(broadPhase,this.m_xf,this.m_xf)}this.m_world.m_contactManager.FindNewContacts()},SetTransform:function(xf){this.SetPositionAndAngle(xf.position,xf.GetAngle())},GetTransform:function(){return this.m_xf},GetPosition:function(){return this.m_xf.position},SetPosition:function(position){this.SetPositionAndAngle(position,this.GetAngle())},GetAngle:function(){return this.m_sweep.a},SetAngle:function(angle){angle=angle||0;this.SetPositionAndAngle(this.GetPosition(),angle)},GetWorldCenter:function(){return this.m_sweep.c},GetLocalCenter:function(){return this.m_sweep.localCenter},SetLinearVelocity:function(v){if(this.m_type===b2Body.b2_staticBody){return}this.m_linearVelocity.SetV(v)},GetLinearVelocity:function(){return this.m_linearVelocity},SetAngularVelocity:function(omega){if(this.m_type===b2Body.b2_staticBody){return}this.m_angularVelocity=omega},GetAngularVelocity:function(){return this.m_angularVelocity},GetDefinition:function(){var bd=new b2BodyDef;bd.type=this.GetType();bd.allowSleep=(this.m_flags&b2Body.e_allowSleepFlag)===b2Body.e_allowSleepFlag;bd.angle=this.GetAngle();bd.angularDamping=this.m_angularDamping;bd.angularVelocity=this.m_angularVelocity;bd.fixedRotation=(this.m_flags&b2Body.e_fixedRotationFlag)===b2Body.e_fixedRotationFlag;bd.bullet=(this.m_flags&b2Body.e_bulletFlag)===b2Body.e_bulletFlag;bd.awake=(this.m_flags&b2Body.e_awakeFlag)===b2Body.e_awakeFlag;bd.linearDamping=this.m_linearDamping;bd.linearVelocity.SetV(this.GetLinearVelocity());bd.position=this.GetPosition();bd.userData=this.GetUserData();return bd},ApplyForce:function(force,point){if(this.m_type!==b2Body.b2_dynamicBody){return}if(this.IsAwake()===false){this.SetAwake(true)}this.m_force.x+=force.x;this.m_force.y+=force.y;this.m_torque+=(point.x-this.m_sweep.c.x)*force.y-(point.y-this.m_sweep.c.y)*force.x},ApplyTorque:function(torque){if(this.m_type!==b2Body.b2_dynamicBody){return}if(this.IsAwake()===false){this.SetAwake(true)}this.m_torque+=torque},ApplyImpulse:function(impulse,point){if(this.m_type!==b2Body.b2_dynamicBody){return}if(this.IsAwake()===false){this.SetAwake(true)}this.m_linearVelocity.x+=this.m_invMass*impulse.x;this.m_linearVelocity.y+=this.m_invMass*impulse.y;this.m_angularVelocity+=this.m_invI*((point.x-this.m_sweep.c.x)*impulse.y-(point.y-this.m_sweep.c.y)*impulse.x)},Split:function(callback){var linearVelocity=this.GetLinearVelocity().Copy(),angularVelocity=this.GetAngularVelocity(),center=this.GetWorldCenter(),body1=this,body2=this.m_world.CreateBody(this.GetDefinition()),prev;for(var f=body1.m_fixtureList;f;){if(callback(f)){var next=f.m_next;if(prev){prev.m_next=next}else{body1.m_fixtureList=next}body1.m_fixtureCount--;f.m_next=body2.m_fixtureList;body2.m_fixtureList=f;body2.m_fixtureCount++;f.m_body=body2;f=next}else{prev=f;f=f.m_next}}body1.ResetMassData();body2.ResetMassData();var center1=body1.GetWorldCenter(),center2=body2.GetWorldCenter(),velocity1=b2Math.AddVV(linearVelocity,b2Math.CrossFV(angularVelocity,b2Math.SubtractVV(center1,center))),velocity2=b2Math.AddVV(linearVelocity,b2Math.CrossFV(angularVelocity,b2Math.SubtractVV(center2,center)));body1.SetLinearVelocity(velocity1);body2.SetLinearVelocity(velocity2);body1.SetAngularVelocity(angularVelocity);body2.SetAngularVelocity(angularVelocity);body1.SynchronizeFixtures();body2.SynchronizeFixtures();return body2},Merge:function(other){var f;for(f=other.m_fixtureList;f;){var next=f.m_next;other.m_fixtureCount--;f.m_next=this.m_fixtureList;this.m_fixtureList=f;this.m_fixtureCount++;f.m_body=body2;f=next}body1.m_fixtureCount=0;var body1=this,body2=other,center1=body1.GetWorldCenter(),center2=body2.GetWorldCenter(),velocity1=body1.GetLinearVelocity().Copy(),velocity2=body2.GetLinearVelocity().Copy(),angular1=body1.GetAngularVelocity(),angular=body2.GetAngularVelocity();body1.ResetMassData();this.SynchronizeFixtures()},GetMass:function(){return this.m_mass},GetInertia:function(){return this.m_I},GetMassData:function(data){data.mass=this.m_mass;data.I=this.m_I;data.center.SetV(this.m_sweep.localCenter)},SetMassData:function(massData){b2Assert(this.m_world.IsLocked()===false);if(this.m_world.IsLocked()===true){return}if(this.m_type!==b2Body.b2_dynamicBody){return}this.m_invMass=0;this.m_I=0;this.m_invI=0;this.m_mass=massData.mass;if(this.m_mass<=0){this.m_mass=1}this.m_invMass=1/this.m_mass;if(massData.I>0&&(this.m_flags&b2Body.e_fixedRotationFlag)===0){this.m_I=massData.I-this.m_mass*(massData.center.x*massData.center.x+massData.center.y*massData.center.y);this.m_invI=1/this.m_I}var oldCenter=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(massData.center);this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter));this.m_sweep.c.SetV(this.m_sweep.c0);this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-oldCenter.y);this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-oldCenter.x)},ResetMassData:function(){this.m_mass=0;this.m_invMass=0;this.m_I=0;this.m_invI=0;this.m_sweep.localCenter.SetZero();if(this.m_type===b2Body.b2_staticBody||this.m_type===b2Body.b2_kinematicBody){return}var center=b2Vec2.Make(0,0);for(var f=this.m_fixtureList;f;f=f.m_next){if(f.m_density===0){continue}var massData=f.GetMassData();this.m_mass+=massData.mass;center.x+=massData.center.x*massData.mass;center.y+=massData.center.y*massData.mass;this.m_I+=massData.I}if(this.m_mass>0){this.m_invMass=1/this.m_mass;center.x*=this.m_invMass;center.y*=this.m_invMass}else{this.m_mass=1;this.m_invMass=1}if(this.m_I>0&&(this.m_flags&b2Body.e_fixedRotationFlag)===0){this.m_I-=this.m_mass*(center.x*center.x+center.y*center.y);this.m_I*=this.m_inertiaScale;b2Assert(this.m_I>0);this.m_invI=1/this.m_I}else{this.m_I=0;this.m_invI=0}var oldCenter=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(center);this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter));this.m_sweep.c.SetV(this.m_sweep.c0);this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-oldCenter.y);this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-oldCenter.x)},GetWorldPoint:function(localPoint){var A=this.m_xf.R,u=new b2Vec2(A.col1.x*localPoint.x+A.col2.x*localPoint.y,A.col1.y*localPoint.x+A.col2.y*localPoint.y);u.x+=this.m_xf.position.x;u.y+=this.m_xf.position.y;return u},GetWorldVector:function(localVector){return b2Math.MulMV(this.m_xf.R,localVector)},GetLocalPoint:function(worldPoint){return b2Math.MulXT(this.m_xf,worldPoint)},GetLocalVector:function(worldVector){return b2Math.MulTMV(this.m_xf.R,worldVector)},GetLinearVelocityFromWorldPoint:function(worldPoint){return new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(worldPoint.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(worldPoint.x-this.m_sweep.c.x))},GetLinearVelocityFromLocalPoint:function(localPoint){var A=this.m_xf.R,worldPoint=new b2Vec2(A.col1.x*localPoint.x+A.col2.x*localPoint.y,A.col1.y*localPoint.x+A.col2.y*localPoint.y);worldPoint.x+=this.m_xf.position.x;worldPoint.y+=this.m_xf.position.y;return new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(worldPoint.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(worldPoint.x-this.m_sweep.c.x))},GetLinearDamping:function(){return this.m_linearDamping},SetLinearDamping:function(linearDamping){linearDamping=linearDamping||0;this.m_linearDamping=linearDamping},GetAngularDamping:function(){return this.m_angularDamping},SetAngularDamping:function(angularDamping){angularDamping=angularDamping||0;this.m_angularDamping=angularDamping},SetType:function(type){type=type||0;if(this.m_type===type){return}this.m_type=type;this.ResetMassData();if(this.m_type===b2Body.b2_staticBody){this.m_linearVelocity.SetZero();this.m_angularVelocity=0}this.SetAwake(true);this.m_force.SetZero();this.m_torque=0;for(var ce=this.m_contactList;ce;ce=ce.next){ce.contact.FlagForFiltering()}},GetType:function(){return this.m_type},SetBullet:function(flag){if(flag){this.m_flags|=b2Body.e_bulletFlag}else{this.m_flags&=~b2Body.e_bulletFlag}},IsBullet:function(){return(this.m_flags&b2Body.e_bulletFlag)===b2Body.e_bulletFlag},SetSleepingAllowed:function(flag){if(flag){this.m_flags|=b2Body.e_allowSleepFlag}else{this.m_flags&=~b2Body.e_allowSleepFlag;this.SetAwake(true)}},SetAwake:function(flag){if(flag){this.m_flags|=b2Body.e_awakeFlag;this.m_sleepTime=0}else{this.m_flags&=~b2Body.e_awakeFlag;this.m_sleepTime=0;this.m_linearVelocity.SetZero();this.m_angularVelocity=0;this.m_force.SetZero();this.m_torque=0}},IsAwake:function(){return(this.m_flags&b2Body.e_awakeFlag)===b2Body.e_awakeFlag},SetFixedRotation:function(fixed){if(fixed){this.m_flags|=b2Body.e_fixedRotationFlag}else{this.m_flags&=~b2Body.e_fixedRotationFlag}this.ResetMassData()},IsFixedRotation:function(){return(this.m_flags&b2Body.e_fixedRotationFlag)===b2Body.e_fixedRotationFlag},SetActive:function(flag){if(flag===this.IsActive()){return}var broadPhase,f;if(flag){this.m_flags|=b2Body.e_activeFlag;broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.CreateProxy(broadPhase,this.m_xf)}}else{this.m_flags&=~b2Body.e_activeFlag;broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.DestroyProxy(broadPhase)}var ce=this.m_contactList;while(ce){var ce0=ce;ce=ce.next;this.m_world.m_contactManager.Destroy(ce0.contact)}this.m_contactList=null}},IsActive:function(){return(this.m_flags&b2Body.e_activeFlag)===b2Body.e_activeFlag},IsSleepingAllowed:function(){return(this.m_flags&b2Body.e_allowSleepFlag)===b2Body.e_allowSleepFlag},GetFixtureList:function(){return this.m_fixtureList},GetJointList:function(){return this.m_jointList},GetControllerList:function(){return this.m_controllerList},GetContactList:function(){return this.m_contactList},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},SetUserData:function(data){this.m_userData=data},GetWorld:function(){return this.m_world},SynchronizeFixtures:function(){var xf1=b2Body.s_xf1;xf1.R.Set(this.m_sweep.a0);var tMat=xf1.R,tVec=this.m_sweep.localCenter;xf1.position.x=this.m_sweep.c0.x-(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);xf1.position.y=this.m_sweep.c0.y-(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);var f,broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.Synchronize(broadPhase,xf1,this.m_xf)}},SynchronizeTransform:function(){this.m_xf.R.Set(this.m_sweep.a);var tMat=this.m_xf.R,tVec=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);this.m_xf.position.y=this.m_sweep.c.y-(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y)},ShouldCollide:function(other){if(this.m_type!==b2Body.b2_dynamicBody&&other.m_type!==b2Body.b2_dynamicBody){return false}for(var jn=this.m_jointList;jn;jn=jn.next){if(jn.other===other)if(jn.joint.m_collideConnected===false){return false}}return true},Advance:function(t){t=t||0;this.m_sweep.Advance(t);this.m_sweep.c.SetV(this.m_sweep.c0);this.m_sweep.a=this.m_sweep.a0;this.SynchronizeTransform()}};b2DebugDraw=Box2D.Dynamics.b2DebugDraw=function b2DebugDraw(){this.m_drawScale=1;this.m_lineThickness=1;this.m_alpha=1;this.m_fillAlpha=1;this.m_xformScale=1;var __this=this;this.m_sprite={graphics:{clear:function(){__this.m_ctx.clearRect(0,0,__this.m_ctx.canvas.width,__this.m_ctx.canvas.height)}}};this.m_drawFlags=0};b2DebugDraw.e_shapeBit=1;b2DebugDraw.e_jointBit=2;b2DebugDraw.e_aabbBit=4;b2DebugDraw.e_pairBit=8;b2DebugDraw.e_centerOfMassBit=16;b2DebugDraw.e_controllerBit=32;b2DebugDraw.constructor=b2DebugDraw;
b2DebugDraw.prototype={m_drawScale:1,m_lineThickness:1,m_alpha:1,m_fillAlpha:1,m_xformScale:1,m_drawFlags:0,m_ctx:null,SetFlags:function(flags){flags=flags||0;this.m_drawFlags=flags},GetFlags:function(){return this.m_drawFlags},AppendFlags:function(flags){flags=flags||0;this.m_drawFlags|=flags},ClearFlags:function(flags){flags=flags||0;this.m_drawFlags&=~flags},SetSprite:function(sprite){this.m_ctx=sprite},GetSprite:function(){return this.m_ctx},SetDrawScale:function(drawScale){drawScale=drawScale||0;this.m_drawScale=drawScale},GetDrawScale:function(){return this.m_drawScale},SetLineThickness:function(lineThickness){lineThickness=lineThickness||0;this.m_lineThickness=lineThickness;this.m_ctx.strokeWidth=lineThickness},GetLineThickness:function(){return this.m_lineThickness},SetAlpha:function(alpha){alpha=alpha||0;this.m_alpha=alpha},GetAlpha:function(){return this.m_alpha},SetFillAlpha:function(alpha){alpha=alpha||0;this.m_fillAlpha=alpha},GetFillAlpha:function(){return this.m_fillAlpha},SetXFormScale:function(xformScale){xformScale=xformScale||0;this.m_xformScale=xformScale},GetXFormScale:function(){return this.m_xformScale},DrawPolygon:function(vertices,vertexCount,color){if(!vertexCount)return;var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.moveTo(vertices[0].x*drawScale,vertices[0].y*drawScale);for(var i=1;i<vertexCount;i++){s.lineTo(vertices[i].x*drawScale,vertices[i].y*drawScale)}s.lineTo(vertices[0].x*drawScale,vertices[0].y*drawScale);s.closePath();s.stroke()},DrawSolidPolygon:function(vertices,vertexCount,color){if(!vertexCount)return;var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.fillStyle=this._color(color.color,this.m_fillAlpha);s.moveTo(vertices[0].x*drawScale,vertices[0].y*drawScale);for(var i=1;i<vertexCount;i++){s.lineTo(vertices[i].x*drawScale,vertices[i].y*drawScale)}s.lineTo(vertices[0].x*drawScale,vertices[0].y*drawScale);s.closePath();s.fill();s.stroke()},DrawCircle:function(center,radius,color){if(!radius)return;var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.arc(center.x*drawScale,center.y*drawScale,radius*drawScale,0,Math.PI*2,true);s.closePath();s.stroke()},DrawSolidCircle:function(center,radius,axis,color){if(!radius)return;var s=this.m_ctx,drawScale=this.m_drawScale,cx=center.x*drawScale,cy=center.y*drawScale;s.moveTo(0,0);s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.fillStyle=this._color(color.color,this.m_fillAlpha);s.arc(cx,cy,radius*drawScale,0,Math.PI*2,true);s.moveTo(cx,cy);s.lineTo((center.x+axis.x*radius)*drawScale,(center.y+axis.y*radius)*drawScale);s.closePath();s.fill();s.stroke()},DrawSegment:function(p1,p2,color){var s=this.m_ctx,drawScale=this.m_drawScale;s.strokeStyle=this._color(color.color,this.m_alpha);s.beginPath();s.moveTo(p1.x*drawScale,p1.y*drawScale);s.lineTo(p2.x*drawScale,p2.y*drawScale);s.closePath();s.stroke()},DrawTransform:function(xf){var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(16711680,this.m_alpha);s.moveTo(xf.position.x*drawScale,xf.position.y*drawScale);s.lineTo((xf.position.x+this.m_xformScale*xf.R.col1.x)*drawScale,(xf.position.y+this.m_xformScale*xf.R.col1.y)*drawScale);s.strokeStyle=this._color(65280,this.m_alpha);s.moveTo(xf.position.x*drawScale,xf.position.y*drawScale);s.lineTo((xf.position.x+this.m_xformScale*xf.R.col2.x)*drawScale,(xf.position.y+this.m_xformScale*xf.R.col2.y)*drawScale);s.closePath();s.stroke()},_color:function(color,alpha){return"rgba("+((color&16711680)>>16)+","+((color&65280)>>8)+","+(color&255)+","+alpha+")"}};b2BodyDef=Box2D.Dynamics.b2BodyDef=function b2BodyDef(){this.position=new b2Vec2(0,0);this.linearVelocity=new b2Vec2(0,0);this.position.Set(0,0);this.linearVelocity.Set(0,0)};b2BodyDef.prototype={position:null,userData:null,angle:0,linearVelocity:null,angularVelocity:0,linearDamping:0,angularDamping:0,allowSleep:true,awake:true,fixedRotation:false,bullet:false,type:b2Body.b2_staticBody,active:true,inertiaScale:1};b2ContactImpulse=Box2D.Dynamics.b2ContactImpulse=function b2ContactImpulse(){this.normalImpulses=[];this.tangentImpulses=[];for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.normalImpulses.push(0);this.tangentImpulses.push(0)}};b2ContactImpulse.constructor=b2ContactImpulse;b2ContactImpulse.prototype={normalImpulses:null,tangentImpulses:null};b2FixtureDef=Box2D.Dynamics.b2FixtureDef=function b2FixtureDef(){this.filter=new b2FilterData};b2FixtureDef.prototype={shape:null,userData:null,friction:.2,restitution:0,density:0,isSensor:false,filter:null};b2Island=Box2D.Dynamics.b2Island=function b2Island(){this.m_bodies=[];this.m_contacts=[];this.m_joints=[]};b2Island.s_impulse=new b2ContactImpulse;b2Island.constructor=b2Island;b2Island.prototype={m_bodies:null,m_contacts:null,m_joints:null,m_bodyCapacity:0,m_contactCapacity:0,m_jointCapacity:0,m_bodyCount:0,m_contactCount:0,m_jointCount:0,m_allocator:null,m_listener:null,m_contactSolver:null,Initialize:function(bodyCapacity,contactCapacity,jointCapacity,allocator,listener,contactSolver){var i;this.m_bodyCapacity=bodyCapacity;this.m_contactCapacity=contactCapacity;this.m_jointCapacity=jointCapacity;this.m_allocator=allocator;this.m_listener=listener;this.m_contactSolver=contactSolver;for(i=this.m_bodies.length;i<bodyCapacity;i++)this.m_bodies[i]=null;for(i=this.m_contacts.length;i<contactCapacity;i++)this.m_contacts[i]=null;for(i=this.m_joints.length;i<jointCapacity;i++)this.m_joints[i]=null},Clear:function(){this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0},Solve:function(step,gravity,allowSleep){var i=0,j=0,b,joint;for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.GetType()!==b2Body.b2_dynamicBody)continue;b.m_linearVelocity.x+=step.dt*(gravity.x+b.m_invMass*b.m_force.x);b.m_linearVelocity.y+=step.dt*(gravity.y+b.m_invMass*b.m_force.y);b.m_angularVelocity+=step.dt*b.m_invI*b.m_torque;b.m_linearVelocity.Multiply(b2Math.Clamp(1-step.dt*b.m_linearDamping,0,1));b.m_angularVelocity*=b2Math.Clamp(1-step.dt*b.m_angularDamping,0,1)}this.m_contactSolver.Initialize(step,this.m_contacts,this.m_contactCount,this.m_allocator);var contactSolver=this.m_contactSolver;contactSolver.InitVelocityConstraints(step);for(i=0;i<this.m_jointCount;++i){joint=this.m_joints[i];joint.InitVelocityConstraints(step)}for(i=0;i<step.velocityIterations;++i){for(j=0;j<this.m_jointCount;++j){joint=this.m_joints[j];joint.SolveVelocityConstraints(step)}contactSolver.SolveVelocityConstraints()}for(i=0;i<this.m_jointCount;++i){joint=this.m_joints[i];joint.FinalizeVelocityConstraints()}contactSolver.FinalizeVelocityConstraints();for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.GetType()===b2Body.b2_staticBody)continue;var translationX=step.dt*b.m_linearVelocity.x,translationY=step.dt*b.m_linearVelocity.y;if(translationX*translationX+translationY*translationY>b2Settings.b2_maxTranslationSquared){b.m_linearVelocity.Normalize();b.m_linearVelocity.x*=b2Settings.b2_maxTranslation*step.inv_dt;b.m_linearVelocity.y*=b2Settings.b2_maxTranslation*step.inv_dt}var rotation=step.dt*b.m_angularVelocity;if(rotation*rotation>b2Settings.b2_maxRotationSquared){if(b.m_angularVelocity<0){b.m_angularVelocity=-b2Settings.b2_maxRotation*step.inv_dt}else{b.m_angularVelocity=b2Settings.b2_maxRotation*step.inv_dt}}b.m_sweep.c0.SetV(b.m_sweep.c);b.m_sweep.a0=b.m_sweep.a;b.m_sweep.c.x+=step.dt*b.m_linearVelocity.x;b.m_sweep.c.y+=step.dt*b.m_linearVelocity.y;b.m_sweep.a+=step.dt*b.m_angularVelocity;b.SynchronizeTransform()}for(i=0;i<step.positionIterations;++i){var contactsOkay=contactSolver.SolvePositionConstraints(b2Settings.b2_contactBaumgarte),jointsOkay=true;for(j=0;j<this.m_jointCount;++j){joint=this.m_joints[j];var jointOkay=joint.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);jointsOkay=jointsOkay&&jointOkay}if(contactsOkay&&jointsOkay){break}}this.Report(contactSolver.m_constraints);if(allowSleep){var minSleepTime=b2Settings.b2_maxFloat,linTolSqr=b2Settings.b2_linearSleepTolerance*b2Settings.b2_linearSleepTolerance,angTolSqr=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance;for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.GetType()===b2Body.b2_staticBody){continue}if((b.m_flags&b2Body.e_allowSleepFlag)===0){b.m_sleepTime=0;minSleepTime=0}if((b.m_flags&b2Body.e_allowSleepFlag)===0||b.m_angularVelocity*b.m_angularVelocity>angTolSqr||b2Math.Dot(b.m_linearVelocity,b.m_linearVelocity)>linTolSqr){b.m_sleepTime=0;minSleepTime=0}else{b.m_sleepTime+=step.dt;minSleepTime=b2Math.Min(minSleepTime,b.m_sleepTime)}}if(minSleepTime>=b2Settings.b2_timeToSleep){for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];b.SetAwake(false)}}}},SolveTOI:function(subStep){var i=0,j=0;this.m_contactSolver.Initialize(subStep,this.m_contacts,this.m_contactCount,this.m_allocator);var contactSolver=this.m_contactSolver;for(i=0;i<this.m_jointCount;++i){this.m_joints[i].InitVelocityConstraints(subStep)}for(i=0;i<subStep.velocityIterations;++i){contactSolver.SolveVelocityConstraints();for(j=0;j<this.m_jointCount;++j){this.m_joints[j].SolveVelocityConstraints(subStep)}}for(i=0;i<this.m_bodyCount;++i){var b=this.m_bodies[i];if(b.GetType()===b2Body.b2_staticBody)continue;var translationX=subStep.dt*b.m_linearVelocity.x,translationY=subStep.dt*b.m_linearVelocity.y;if(translationX*translationX+translationY*translationY>b2Settings.b2_maxTranslationSquared){b.m_linearVelocity.Normalize();b.m_linearVelocity.x*=b2Settings.b2_maxTranslation*subStep.inv_dt;b.m_linearVelocity.y*=b2Settings.b2_maxTranslation*subStep.inv_dt}var rotation=subStep.dt*b.m_angularVelocity;if(rotation*rotation>b2Settings.b2_maxRotationSquared){if(b.m_angularVelocity<0){b.m_angularVelocity=-b2Settings.b2_maxRotation*subStep.inv_dt}else{b.m_angularVelocity=b2Settings.b2_maxRotation*subStep.inv_dt}}b.m_sweep.c0.SetV(b.m_sweep.c);b.m_sweep.a0=b.m_sweep.a;b.m_sweep.c.x+=subStep.dt*b.m_linearVelocity.x;b.m_sweep.c.y+=subStep.dt*b.m_linearVelocity.y;b.m_sweep.a+=subStep.dt*b.m_angularVelocity;b.SynchronizeTransform()}var k_toiBaumgarte=.75;for(i=0;i<subStep.positionIterations;++i){var contactsOkay=contactSolver.SolvePositionConstraints(k_toiBaumgarte),jointsOkay=true;for(j=0;j<this.m_jointCount;++j){var jointOkay=this.m_joints[j].SolvePositionConstraints(b2Settings.b2_contactBaumgarte);jointsOkay=jointsOkay&&jointOkay}if(contactsOkay&&jointsOkay){break}}this.Report(contactSolver.m_constraints)},Report:function(constraints){if(this.m_listener==null){return}for(var i=0;i<this.m_contactCount;++i){var c=this.m_contacts[i],cc=constraints[i];for(var j=0;j<cc.pointCount;++j){b2Island.s_impulse.normalImpulses[j]=cc.points[j].normalImpulse;b2Island.s_impulse.tangentImpulses[j]=cc.points[j].tangentImpulse}this.m_listener.PostSolve(c,b2Island.s_impulse)}},AddBody:function(body){body.m_islandIndex=this.m_bodyCount;this.m_bodies[this.m_bodyCount++]=body},AddContact:function(contact){this.m_contacts[this.m_contactCount++]=contact},AddJoint:function(joint){this.m_joints[this.m_jointCount++]=joint}};b2World=Box2D.Dynamics.b2World=function b2World(gravity,doSleep){this.m_stack=[];this.m_contactManager=new b2ContactManager;this.m_contactSolver=new b2ContactSolver;this.m_island=new b2Island;this.m_allowSleep=doSleep;this.m_gravity=gravity;this.m_contactManager.m_world=this;var bd=new b2BodyDef;this.m_groundBody=this.CreateBody(bd)};b2World.s_timestep2=new b2TimeStep;b2World.s_xf=new b2Transform;b2World.s_backupA=new b2Sweep;b2World.s_backupB=new b2Sweep;b2World.s_timestep=new b2TimeStep;b2World.s_queue=[];b2World.s_jointColor=new b2Color(.5,.8,.8);b2World.e_newFixture=1;b2World.e_locked=2;b2World.constructor=b2World;b2World.prototype={m_stack:null,m_contactManager:null,m_contactSolver:null,m_island:null,m_destructionListener:null,m_debugDraw:null,m_bodyList:null,m_contactList:null,m_jointList:null,m_controllerList:null,m_bodyCount:0,m_contactCount:0,m_jointCount:0,m_controllerCount:0,m_allowSleep:null,m_gravity:null,m_inv_dt0:0,m_groundBody:null,m_warmStarting:true,m_continuousPhysics:true,SetDestructionListener:function(listener){this.m_destructionListener=listener},SetContactFilter:function(filter){this.m_contactManager.m_contactFilter=filter},SetContactListener:function(listener){this.m_contactManager.m_contactListener=listener},SetDebugDraw:function(debugDraw){this.m_debugDraw=debugDraw},SetBroadPhase:function(broadPhase){var oldBroadPhase=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=broadPhase;for(var b=this.m_bodyList;b;b=b.m_next){for(var f=b.m_fixtureList;f;f=f.m_next){f.m_proxy=broadPhase.CreateProxy(oldBroadPhase.GetFatAABB(f.m_proxy),f)}}},Validate:function(){this.m_contactManager.m_broadPhase.Validate()},GetProxyCount:function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},CreateBody:function(def){if(this.IsLocked()===true){return null}var b=new b2Body(def,this);b.m_prev=null;b.m_next=this.m_bodyList;if(this.m_bodyList){this.m_bodyList.m_prev=b}this.m_bodyList=b;++this.m_bodyCount;return b},DestroyBody:function(b){if(this.IsLocked()===true){return}var jn=b.m_jointList;while(jn){var jn0=jn;jn=jn.next;if(this.m_destructionListener){this.m_destructionListener.SayGoodbyeJoint(jn0.joint)}this.DestroyJoint(jn0.joint)}var coe=b.m_controllerList;while(coe){var coe0=coe;coe=coe.nextController;coe0.controller.RemoveBody(b)}var ce=b.m_contactList;while(ce){var ce0=ce;ce=ce.next;this.m_contactManager.Destroy(ce0.contact)}b.m_contactList=null;var f=b.m_fixtureList;while(f){var f0=f;f=f.m_next;if(this.m_destructionListener){this.m_destructionListener.SayGoodbyeFixture(f0)}f0.DestroyProxy(this.m_contactManager.m_broadPhase);f0.Destroy()}b.m_fixtureList=null;b.m_fixtureCount=0;if(b.m_prev){b.m_prev.m_next=b.m_next}if(b.m_next){b.m_next.m_prev=b.m_prev}if(b===this.m_bodyList){this.m_bodyList=b.m_next}--this.m_bodyCount},CreateJoint:function(def){var j=b2Joint.Create(def,null);j.m_prev=null;j.m_next=this.m_jointList;if(this.m_jointList){this.m_jointList.m_prev=j}this.m_jointList=j;++this.m_jointCount;j.m_edgeA.joint=j;j.m_edgeA.other=j.m_bodyB;j.m_edgeA.prev=null;j.m_edgeA.next=j.m_bodyA.m_jointList;if(j.m_bodyA.m_jointList)j.m_bodyA.m_jointList.prev=j.m_edgeA;j.m_bodyA.m_jointList=j.m_edgeA;j.m_edgeB.joint=j;j.m_edgeB.other=j.m_bodyA;j.m_edgeB.prev=null;j.m_edgeB.next=j.m_bodyB.m_jointList;if(j.m_bodyB.m_jointList)j.m_bodyB.m_jointList.prev=j.m_edgeB;j.m_bodyB.m_jointList=j.m_edgeB;var bodyA=def.bodyA,bodyB=def.bodyB;if(def.collideConnected===false){var edge=bodyB.GetContactList();while(edge){if(edge.other===bodyA){edge.contact.FlagForFiltering()}edge=edge.next}}return j},DestroyJoint:function(j){var collideConnected=j.m_collideConnected;if(j.m_prev){j.m_prev.m_next=j.m_next}if(j.m_next){j.m_next.m_prev=j.m_prev}if(j===this.m_jointList){this.m_jointList=j.m_next}var bodyA=j.m_bodyA,bodyB=j.m_bodyB;bodyA.SetAwake(true);bodyB.SetAwake(true);if(j.m_edgeA.prev){j.m_edgeA.prev.next=j.m_edgeA.next}if(j.m_edgeA.next){j.m_edgeA.next.prev=j.m_edgeA.prev}if(j.m_edgeA===bodyA.m_jointList){bodyA.m_jointList=j.m_edgeA.next}j.m_edgeA.prev=null;j.m_edgeA.next=null;if(j.m_edgeB.prev){j.m_edgeB.prev.next=j.m_edgeB.next}if(j.m_edgeB.next){j.m_edgeB.next.prev=j.m_edgeB.prev}if(j.m_edgeB===bodyB.m_jointList){bodyB.m_jointList=j.m_edgeB.next}j.m_edgeB.prev=null;j.m_edgeB.next=null;b2Joint.Destroy(j,null);--this.m_jointCount;if(collideConnected===false){var edge=bodyB.GetContactList();while(edge){if(edge.other===bodyA){edge.contact.FlagForFiltering()}edge=edge.next}}},AddController:function(c){c.m_next=this.m_controllerList;c.m_prev=null;this.m_controllerList=c;c.m_world=this;this.m_controllerCount++;return c},RemoveController:function(c){if(c.m_prev)c.m_prev.m_next=c.m_next;if(c.m_next)c.m_next.m_prev=c.m_prev;if(this.m_controllerList===c)this.m_controllerList=c.m_next;this.m_controllerCount--},CreateController:function(controller){if(controller.m_world!==this)throw new Error("Controller can only be a member of one world");controller.m_next=this.m_controllerList;controller.m_prev=null;if(this.m_controllerList)this.m_controllerList.m_prev=controller;this.m_controllerList=controller;++this.m_controllerCount;controller.m_world=this;return controller},DestroyController:function(controller){controller.Clear();if(controller.m_next)controller.m_next.m_prev=controller.m_prev;if(controller.m_prev)controller.m_prev.m_next=controller.m_next;if(controller===this.m_controllerList)this.m_controllerList=controller.m_next;--this.m_controllerCount},SetWarmStarting:function(flag){this.m_warmStarting=flag},SetContinuousPhysics:function(flag){this.m_continuousPhysics=flag},GetBodyCount:function(){return this.m_bodyCount},GetJointCount:function(){return this.m_jointCount},GetContactCount:function(){return this.m_contactCount},SetGravity:function(gravity){this.m_gravity=gravity},GetGravity:function(){return this.m_gravity},GetGroundBody:function(){return this.m_groundBody},Step:function(dt,velocityIterations,positionIterations){dt=dt||0;velocityIterations=velocityIterations||0;positionIterations=positionIterations||0;if(this.m_flags&b2World.e_newFixture){this.m_contactManager.FindNewContacts();this.m_flags&=~b2World.e_newFixture}this.m_flags|=b2World.e_locked;var step=b2World.s_timestep2;step.dt=dt;step.velocityIterations=velocityIterations;step.positionIterations=positionIterations;if(dt>0){step.inv_dt=1/dt}else{step.inv_dt=0}step.dtRatio=this.m_inv_dt0*dt;step.warmStarting=this.m_warmStarting;this.m_contactManager.Collide();if(step.dt>0){this.Solve(step)}if(this.m_continuousPhysics&&step.dt>0){this.SolveTOI(step)}if(step.dt>0){this.m_inv_dt0=step.inv_dt}this.m_flags&=~b2World.e_locked},ClearForces:function(){for(var body=this.m_bodyList;body;body=body.m_next){body.m_force.SetZero();body.m_torque=0}},DrawDebugData:function(){if(this.m_debugDraw==null){return}this.m_debugDraw.m_sprite.graphics.clear();var flags=this.m_debugDraw.GetFlags(),i=0,b,f,s,j,bp,invQ=new b2Vec2,x1=new b2Vec2,x2=new b2Vec2,xf,b1=new b2AABB,b2=new b2AABB,vs=[new b2Vec2(0,0),new b2Vec2(0,0),new b2Vec2(0,0),new b2Vec2(0,0)],color=new b2Color(0,0,0);if(flags&b2DebugDraw.e_shapeBit){for(b=this.m_bodyList;b;b=b.m_next){xf=b.m_xf;for(f=b.GetFixtureList();f;f=f.m_next){s=f.GetShape();if(b.IsActive()===false){color.Set(.5,.5,.3);this.DrawShape(s,xf,color)}else if(b.GetType()===b2Body.b2_staticBody){color.Set(.5,.9,.5);this.DrawShape(s,xf,color)}else if(b.GetType()===b2Body.b2_kinematicBody){color.Set(.5,.5,.9);this.DrawShape(s,xf,color)}else if(b.IsAwake()===false){color.Set(.6,.6,.6);this.DrawShape(s,xf,color)}else{color.Set(.9,.7,.7);this.DrawShape(s,xf,color)}}}}if(flags&b2DebugDraw.e_jointBit){for(j=this.m_jointList;j;j=j.m_next){this.DrawJoint(j)}}if(flags&b2DebugDraw.e_controllerBit){for(var c=this.m_controllerList;c;c=c.m_next){c.Draw(this.m_debugDraw)}}if(flags&b2DebugDraw.e_pairBit){color.Set(.3,.9,.9);for(var contact=this.m_contactManager.m_contactList;contact;contact=contact.GetNext()){var fixtureA=contact.GetFixtureA(),fixtureB=contact.GetFixtureB(),cA=fixtureA.GetAABB().GetCenter(),cB=fixtureB.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(cA,cB,color)}}if(flags&b2DebugDraw.e_aabbBit){bp=this.m_contactManager.m_broadPhase;vs=[new b2Vec2(0,0),new b2Vec2(0,0),new b2Vec2(0,0),new b2Vec2(0,0)];for(b=this.m_bodyList;b;b=b.GetNext()){if(b.IsActive()===false){continue}for(f=b.GetFixtureList();f;f=f.GetNext()){var aabb=bp.GetFatAABB(f.m_proxy);vs[0].Set(aabb.lowerBound.x,aabb.lowerBound.y);vs[1].Set(aabb.upperBound.x,aabb.lowerBound.y);vs[2].Set(aabb.upperBound.x,aabb.upperBound.y);vs[3].Set(aabb.lowerBound.x,aabb.upperBound.y);this.m_debugDraw.DrawPolygon(vs,4,color)}}}if(flags&b2DebugDraw.e_centerOfMassBit){for(b=this.m_bodyList;b;b=b.m_next){xf=b2World.s_xf;xf.R=b.m_xf.R;xf.position=b.GetWorldCenter();this.m_debugDraw.DrawTransform(xf)}}},QueryAABB:function(callback,aabb){var __this=this,broadPhase=__this.m_contactManager.m_broadPhase;function WorldQueryWrapper(proxy){return callback(broadPhase.GetUserData(proxy))}broadPhase.Query(WorldQueryWrapper,aabb)},QueryShape:function(callback,shape,transform){var __this=this;transform=transform||null;if(transform==null){transform=new b2Transform;transform.SetIdentity()}var broadPhase=__this.m_contactManager.m_broadPhase;function WorldQueryWrapper(proxy){var fixture=broadPhase.GetUserData(proxy)instanceof b2Fixture?broadPhase.GetUserData(proxy):null;if(b2Shape.TestOverlap(shape,transform,fixture.GetShape(),fixture.GetBody().GetTransform()))return callback(fixture);return true}var aabb=new b2AABB;shape.ComputeAABB(aabb,transform);broadPhase.Query(WorldQueryWrapper,aabb)},QueryPoint:function(callback,p){var __this=this,broadPhase=__this.m_contactManager.m_broadPhase;function WorldQueryWrapper(proxy){var fixture=broadPhase.GetUserData(proxy)instanceof b2Fixture?broadPhase.GetUserData(proxy):null;if(fixture.TestPoint(p))return callback(fixture);return true}var aabb=new b2AABB;aabb.lowerBound.Set(p.x-b2Settings.b2_linearSlop,p.y-b2Settings.b2_linearSlop);aabb.upperBound.Set(p.x+b2Settings.b2_linearSlop,p.y+b2Settings.b2_linearSlop);broadPhase.Query(WorldQueryWrapper,aabb)},RayCast:function(callback,point1,point2){var __this=this,broadPhase=__this.m_contactManager.m_broadPhase,output=new b2RayCastOutput;function RayCastWrapper(input,proxy){var userData=broadPhase.GetUserData(proxy),fixture=userData instanceof b2Fixture?userData:null,hit=fixture.RayCast(output,input);if(hit){var fraction=output.fraction,point=new b2Vec2((1-fraction)*point1.x+fraction*point2.x,(1-fraction)*point1.y+fraction*point2.y);return callback(fixture,point,output.normal,fraction)}return input.maxFraction}var input=new b2RayCastInput(point1,point2);broadPhase.RayCast(RayCastWrapper,input)},RayCastOne:function(point1,point2){var __this=this,result;function RayCastOneWrapper(fixture,point,normal,fraction){fraction=fraction||0;result=fixture;return fraction}__this.RayCast(RayCastOneWrapper,point1,point2);return result},RayCastAll:function(point1,point2){var __this=this,result=[];function RayCastAllWrapper(fixture,point,normal,fraction){fraction=fraction||0;result[result.length]=fixture;return 1}__this.RayCast(RayCastAllWrapper,point1,point2);return result},GetBodyList:function(){return this.m_bodyList},GetJointList:function(){return this.m_jointList},GetContactList:function(){return this.m_contactList},IsLocked:function(){return(this.m_flags&b2World.e_locked)>0},Solve:function(step){var b;for(var controller=this.m_controllerList;controller;controller=controller.m_next){controller.Step(step)}var island=this.m_island;island.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver);for(b=this.m_bodyList;b;b=b.m_next){b.m_flags&=~b2Body.e_islandFlag}for(var c=this.m_contactList;c;c=c.m_next){c.m_flags&=~b2Contact.e_islandFlag}for(var j=this.m_jointList;j;j=j.m_next){j.m_islandFlag=false}var stackSize=this.m_bodyCount,stack=this.m_stack;for(var seed=this.m_bodyList;seed;seed=seed.m_next){if(seed.m_flags&b2Body.e_islandFlag){continue}if(seed.IsAwake()===false||seed.IsActive()===false){continue}if(seed.GetType()===b2Body.b2_staticBody){continue}island.Clear();var stackCount=0;stack[stackCount++]=seed;seed.m_flags|=b2Body.e_islandFlag;while(stackCount>0){b=stack[--stackCount];island.AddBody(b);if(b.IsAwake()===false){b.SetAwake(true)}if(b.GetType()===b2Body.b2_staticBody){continue}var other;for(var ce=b.m_contactList;ce;ce=ce.next){if(ce.contact.m_flags&b2Contact.e_islandFlag){continue}if(ce.contact.IsSensor()===true||ce.contact.IsEnabled()===false||ce.contact.IsTouching()===false){continue}island.AddContact(ce.contact);ce.contact.m_flags|=b2Contact.e_islandFlag;other=ce.other;if(other.m_flags&b2Body.e_islandFlag){continue}stack[stackCount++]=other;other.m_flags|=b2Body.e_islandFlag}for(var jn=b.m_jointList;jn;jn=jn.next){if(jn.joint.m_islandFlag===true){continue}other=jn.other;if(other.IsActive()===false){continue}island.AddJoint(jn.joint);jn.joint.m_islandFlag=true;if(other.m_flags&b2Body.e_islandFlag){continue}stack[stackCount++]=other;other.m_flags|=b2Body.e_islandFlag}}island.Solve(step,this.m_gravity,this.m_allowSleep);for(var i=0;i<island.m_bodyCount;++i){b=island.m_bodies[i];if(b.GetType()===b2Body.b2_staticBody){b.m_flags&=~b2Body.e_islandFlag}}}for(i=0;i<stack.length;++i){if(!stack[i])break;stack[i]=null}for(b=this.m_bodyList;b;b=b.m_next){if(b.IsAwake()===false||b.IsActive()===false){continue}if(b.GetType()===b2Body.b2_staticBody){continue}b.SynchronizeFixtures()}this.m_contactManager.FindNewContacts()},SolveTOI:function(step){var b,fA,fB,bA,bB,cEdge,j,island=this.m_island;island.Initialize(this.m_bodyCount,b2Settings.b2_maxTOIContactsPerIsland,b2Settings.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var queue=b2World.s_queue;for(b=this.m_bodyList;b;b=b.m_next){b.m_flags&=~b2Body.e_islandFlag;b.m_sweep.t0=0}var c;for(c=this.m_contactList;c;c=c.m_next){c.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag)}for(j=this.m_jointList;j;j=j.m_next){j.m_islandFlag=false}for(;;){var minContact=null,minTOI=1;for(c=this.m_contactList;c;c=c.m_next){if(c.IsSensor()===true||c.IsEnabled()===false||c.IsContinuous()===false){continue}var toi=1;if(c.m_flags&b2Contact.e_toiFlag){toi=c.m_toi}else{fA=c.m_fixtureA;fB=c.m_fixtureB;bA=fA.m_body;bB=fB.m_body;if((bA.GetType()!==b2Body.b2_dynamicBody||bA.IsAwake()===false)&&(bB.GetType()!==b2Body.b2_dynamicBody||bB.IsAwake()===false)){continue}var t0=bA.m_sweep.t0;if(bA.m_sweep.t0<bB.m_sweep.t0){t0=bB.m_sweep.t0;bA.m_sweep.Advance(t0)}else if(bB.m_sweep.t0<bA.m_sweep.t0){t0=bA.m_sweep.t0;bB.m_sweep.Advance(t0)}toi=c.ComputeTOI(bA.m_sweep,bB.m_sweep);b2Assert(0<=toi&&toi<=1);if(toi>0&&toi<1){toi=(1-toi)*t0+toi;if(toi>1)toi=1}c.m_toi=toi;c.m_flags|=b2Contact.e_toiFlag}if(b2Settings.b2_epsilon<toi&&toi<minTOI){minContact=c;minTOI=toi}}if(minContact==null||1-100*b2Settings.b2_epsilon<minTOI){break}fA=minContact.m_fixtureA;fB=minContact.m_fixtureB;bA=fA.m_body;bB=fB.m_body;b2World.s_backupA.Set(bA.m_sweep);b2World.s_backupB.Set(bB.m_sweep);bA.Advance(minTOI);bB.Advance(minTOI);minContact.Update(this.m_contactManager.m_contactListener);minContact.m_flags&=~b2Contact.e_toiFlag;if(minContact.IsSensor()===true||minContact.IsEnabled()===false){bA.m_sweep.Set(b2World.s_backupA);bB.m_sweep.Set(b2World.s_backupB);bA.SynchronizeTransform();bB.SynchronizeTransform();continue}if(minContact.IsTouching()===false){continue}var seed=bA;if(seed.GetType()!==b2Body.b2_dynamicBody){seed=bB}island.Clear();var queueStart=0,queueSize=0;queue[queueStart+queueSize++]=seed;seed.m_flags|=b2Body.e_islandFlag;while(queueSize>0){b=queue[queueStart++];--queueSize;island.AddBody(b);if(b.IsAwake()===false){b.SetAwake(true)}if(b.GetType()!==b2Body.b2_dynamicBody){continue}for(cEdge=b.m_contactList;cEdge;cEdge=cEdge.next){if(island.m_contactCount===island.m_contactCapacity){break}if(cEdge.contact.m_flags&b2Contact.e_islandFlag){continue}if(cEdge.contact.IsSensor()===true||cEdge.contact.IsEnabled()===false||cEdge.contact.IsTouching()===false){continue}island.AddContact(cEdge.contact);cEdge.contact.m_flags|=b2Contact.e_islandFlag;var other=cEdge.other;if(other.m_flags&b2Body.e_islandFlag){continue}if(other.GetType()!==b2Body.b2_staticBody){other.Advance(minTOI);other.SetAwake(true)}queue[queueStart+queueSize]=other;++queueSize;other.m_flags|=b2Body.e_islandFlag}for(var jEdge=b.m_jointList;jEdge;jEdge=jEdge.next){if(island.m_jointCount===island.m_jointCapacity)continue;if(jEdge.joint.m_islandFlag===true)continue;other=jEdge.other;if(other.IsActive()===false){continue}island.AddJoint(jEdge.joint);jEdge.joint.m_islandFlag=true;if(other.m_flags&b2Body.e_islandFlag)continue;if(other.GetType()!==b2Body.b2_staticBody){other.Advance(minTOI);other.SetAwake(true)}queue[queueStart+queueSize]=other;++queueSize;other.m_flags|=b2Body.e_islandFlag}}var subStep=b2World.s_timestep;subStep.warmStarting=false;subStep.dt=(1-minTOI)*step.dt;subStep.inv_dt=1/subStep.dt;subStep.dtRatio=0;subStep.velocityIterations=step.velocityIterations;subStep.positionIterations=step.positionIterations;island.SolveTOI(subStep);var i=0;for(i=0;i<island.m_bodyCount;++i){b=island.m_bodies[i];b.m_flags&=~b2Body.e_islandFlag;if(b.IsAwake()===false){continue}if(b.GetType()!==b2Body.b2_dynamicBody){continue}b.SynchronizeFixtures();for(cEdge=b.m_contactList;cEdge;cEdge=cEdge.next){cEdge.contact.m_flags&=~b2Contact.e_toiFlag}}for(i=0;i<island.m_contactCount;++i){c=island.m_contacts[i];c.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag)}for(i=0;i<island.m_jointCount;++i){j=island.m_joints[i];j.m_islandFlag=false}this.m_contactManager.FindNewContacts()}},DrawJoint:function(joint){var b1=joint.GetBodyA(),b2=joint.GetBodyB(),xf1=b1.m_xf,xf2=b2.m_xf,x1=xf1.position,x2=xf2.position,p1=joint.GetAnchorA(),p2=joint.GetAnchorB(),color=b2World.s_jointColor;switch(joint.m_type){case b2Joint.e_distanceJoint:this.m_debugDraw.DrawSegment(p1,p2,color);break;case b2Joint.e_pulleyJoint:{var pulley=joint instanceof b2PulleyJoint?joint:null,s1=pulley.GetGroundAnchorA(),s2=pulley.GetGroundAnchorB();this.m_debugDraw.DrawSegment(s1,p1,color);this.m_debugDraw.DrawSegment(s2,p2,color);this.m_debugDraw.DrawSegment(s1,s2,color)}break;case b2Joint.e_mouseJoint:this.m_debugDraw.DrawSegment(p1,p2,color);break;default:if(b1!==this.m_groundBody)this.m_debugDraw.DrawSegment(x1,p1,color);this.m_debugDraw.DrawSegment(p1,p2,color);if(b2!==this.m_groundBody)this.m_debugDraw.DrawSegment(x2,p2,color)}},DrawShape:function(shape,xf,color){switch(shape.m_type){case b2Shape.e_circleShape:{var circle=shape instanceof b2CircleShape?shape:null,center=b2Math.MulX(xf,circle.m_p),radius=circle.m_radius,axis=xf.R.col1;this.m_debugDraw.DrawSolidCircle(center,radius,axis,color)}break;case b2Shape.e_polygonShape:{var i=0,poly=shape instanceof b2PolygonShape?shape:null,vertexCount=poly.GetVertexCount(),localVertices=poly.GetVertices(),vertices=[];for(i=0;i<vertexCount;++i){vertices.push(b2Math.MulX(xf,localVertices[i]))}this.m_debugDraw.DrawSolidPolygon(vertices,vertexCount,color)}break;case b2Shape.e_edgeShape:{var edge=shape instanceof b2EdgeShape?shape:null;this.m_debugDraw.DrawSegment(b2Math.MulX(xf,edge.GetVertex1()),b2Math.MulX(xf,edge.GetVertex2()),color)}break}}};b2DestructionListener=Box2D.Dynamics.b2DestructionListener=function b2DestructionListener(){};b2DestructionListener.constructor=b2DestructionListener;b2DestructionListener.prototype={SayGoodbyeJoint:function(joint){},SayGoodbyeFixture:function(fixture){}};return Box2D}.call(this);if("undefined"!==typeof module){module.exports=Box2D}(function(){"use strict";var ComponentInstanceProvider,ComponentMatchingFamily,ComponentPool,ComponentSingletonProvider,ComponentTypeProvider,Dictionary,DynamicComponentProvider,DynamicSystemProvider,Engine,EngineState,EngineStateMachine,Entity,EntityList,EntityState,EntityStateMachine,Family,FrameTickProvider,ListIteratingSystem,ListenerNode,ListenerNodePool,Node,NodeList,NodePool,PhaserEngine,Signal0,Signal1,Signal2,Signal3,SignalBase,StateComponentMapping,StateSystemMapping,System,SystemInstanceProvider,SystemList,SystemSingletonProvider,ash,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};ash={signals:{},core:{},fsm:{},tick:{},tools:{}};Dictionary=function(){function Dictionary(){}return Dictionary}();ash.signals.ListenerNode=ListenerNode=function(){function ListenerNode(){}ListenerNode.prototype.previous=null;ListenerNode.prototype.next=null;ListenerNode.prototype.listener=null;
ListenerNode.prototype.once=false;return ListenerNode}();ash.signals.ListenerNodePool=ListenerNodePool=function(){function ListenerNodePool(){}ListenerNodePool.prototype.tail=null;ListenerNodePool.prototype.cacheTail=null;ListenerNodePool.prototype.get=function(){var node;if(this.tail!==null){node=this.tail;this.tail=this.tail.previous;node.previous=null;return node}else{return new ListenerNode}};ListenerNodePool.prototype.dispose=function(node){node.listener=null;node.once=false;node.next=null;node.previous=this.tail;this.tail=node};ListenerNodePool.prototype.cache=function(node){node.listener=null;node.previous=this.cacheTail;this.cacheTail=node};ListenerNodePool.prototype.releaseCache=function(){var node;while(this.cacheTail!==null){node=this.cacheTail;this.cacheTail=node.previous;node.next=null;node.previous=this.tail;this.tail=node}};return ListenerNodePool}();ash.signals.SignalBase=SignalBase=function(){SignalBase.prototype.head=null;SignalBase.prototype.tail=null;SignalBase.prototype.numListeners=0;SignalBase.prototype.keys=null;SignalBase.prototype.nodes=null;SignalBase.prototype.listenerNodePool=null;SignalBase.prototype.toAddHead=null;SignalBase.prototype.toAddTail=null;SignalBase.prototype.dispatching=false;function SignalBase(){this.nodes=[];this.keys=[];this.listenerNodePool=new ListenerNodePool;this.numListeners=0}SignalBase.prototype.startDispatch=function(){this.dispatching=true};SignalBase.prototype.endDispatch=function(){this.dispatching=false;if(this.toAddHead){if(!this.head){this.head=this.toAddHead;this.tail=this.toAddTail}else{this.tail.next=this.toAddHead;this.toAddHead.previous=this.tail;this.tail=this.toAddTail}this.toAddHead=null;this.toAddTail=null}this.listenerNodePool.releaseCache()};SignalBase.prototype.getNode=function(listener){var node;node=this.head;while(node!==null){if(node.listener===listener){break}node=node.next}if(node===null){node=this.toAddHead;while(node!==null){if(node.listener===listener){break}node=node.next}}return node};SignalBase.prototype.add=function(listener){var node;if(this.keys.indexOf(listener)!==-1){return}node=this.listenerNodePool.get();node.listener=listener;this.nodes.push(node);this.keys.push(listener);this.addNode(node)};SignalBase.prototype.addOnce=function(listener){var node;if(this.keys.indexOf(listener)!==-1){return}node=this.listenerNodePool.get();node.listener=listener;node.once=true;this.nodes.push(node);this.keys.push(listener);this.addNode(node)};SignalBase.prototype.addNode=function(node){if(this.dispatching){if(this.toAddHead===null){this.toAddHead=this.toAddTail=node}else{this.toAddTail.next=node;node.previous=this.toAddTail;this.toAddTail=node}}else{if(this.head===null){this.head=this.tail=node}else{this.tail.next=node;node.previous=this.tail;this.tail=node}}this.numListeners++};SignalBase.prototype.remove=function(listener){var index,node;index=this.keys.indexOf(listener);node=this.nodes[index];if(node){if(this.head===node){this.head=this.head.next}if(this.tail===node){this.tail=this.tail.previous}if(this.toAddHead===node){this.toAddHead=this.toAddHead.next}if(this.toAddTail===node){this.toAddTail=this.toAddTail.previous}if(node.previous){node.previous.next=node.next}if(node.next){node.next.previous=node.previous}this.nodes.splice(index,1);this.keys.splice(index,1);if(this.dispatching){this.listenerNodePool.cache(node)}else{this.listenerNodePool.dispose(node)}this.numListeners--}};SignalBase.prototype.removeAll=function(){var node;while(this.head){node=this.head;this.head=this.head.next;this.nodes.splice(index,1);this.listenerNodePool.dispose(node)}this.nodes=[];this.keys=[];this.tail=null;this.toAddHead=null;this.toAddTail=null;this.numListeners=0};return SignalBase}();ash.signals.Signal0=Signal0=function(_super){__extends(Signal0,_super);function Signal0(){return Signal0.__super__.constructor.apply(this,arguments)}Signal0.prototype.dispatch=function(){var node;this.startDispatch();node=this.head;while(node!==null){node.listener();if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal0}(SignalBase);ash.signals.Signal1=Signal1=function(_super){__extends(Signal1,_super);function Signal1(){return Signal1.__super__.constructor.apply(this,arguments)}Signal1.prototype.dispatch=function($1){var node;this.startDispatch();node=this.head;while(node!==null){node.listener($1);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal1}(SignalBase);ash.signals.Signal2=Signal2=function(_super){__extends(Signal2,_super);function Signal2(){return Signal2.__super__.constructor.apply(this,arguments)}Signal2.prototype.dispatch=function($1,$2){var node;this.startDispatch();node=this.head;while(node){node.listener($1,$2);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal2}(SignalBase);ash.signals.Signal3=Signal3=function(_super){__extends(Signal3,_super);function Signal3(){return Signal3.__super__.constructor.apply(this,arguments)}Signal3.prototype.dispatch=function($1,$2,$3){var node;this.startDispatch();node=this.head;while(node!==null){node.listener($1,$2,$3);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal3}(SignalBase);ash.core.Entity=Entity=function(){var nameCount;nameCount=0;Entity.prototype._name="";Entity.prototype.componentAdded=null;Entity.prototype.componentRemoved=null;Entity.prototype.nameChanged=null;Entity.prototype.previous=null;Entity.prototype.next=null;Entity.prototype.components=null;function Entity(name){if(name==null){name=""}Object.defineProperties(this,{name:{get:function(){return this._name},set:function(value){var previous;if(this._name!==value){previous=this._name;this._name=value;return this.nameChanged.dispatch(this,previous)}}}});this.componentAdded=new Signal2;this.componentRemoved=new Signal2;this.nameChanged=new Signal2;this.components=new Dictionary;if(name!==""){this._name=name}else{this._name="_entity"+ ++nameCount}}Entity.prototype.add=function(component,componentClass){if(componentClass==null){componentClass=component.constructor}if(componentClass.name in this.components){this.remove(componentClass)}this.components[componentClass.name]=component;this.componentAdded.dispatch(this,componentClass);return this};Entity.prototype.remove=function(componentClass){var component,name;name=componentClass.name!=null?componentClass.name:componentClass;component=this.components[name];if(component){delete this.components[name];this.componentRemoved.dispatch(this,name);return component}return null};Entity.prototype.get=function(componentClass){return this.components[componentClass.name]};Entity.prototype.getAll=function(){var component,componentArray,_i,_len,_ref;componentArray=[];_ref=this.components;for(_i=0,_len=_ref.length;_i<_len;_i++){component=_ref[_i];componentArray.push(component)}return componentArray};Entity.prototype.has=function(componentClass){return componentClass.name in this.components};return Entity}();ash.core.EntityList=EntityList=function(){function EntityList(){}EntityList.prototype.head=null;EntityList.prototype.tail=null;EntityList.prototype.add=function(entity){if(!this.head){this.head=this.tail=entity;entity.next=entity.previous=null}else{this.tail.next=entity;entity.previous=this.tail;entity.next=null;this.tail=entity}};EntityList.prototype.remove=function(entity){if(this.head===entity){this.head=this.head.next}if(this.tail===entity){this.tail=this.tail.previous}if(entity.previous){entity.previous.next=entity.next}if(entity.next){entity.next.previous=entity.previous}};EntityList.prototype.removeAll=function(){var entity;while(this.head){entity=this.head;this.head=this.head.next;entity.previous=null;entity.next=null}this.tail=null};return EntityList}();ash.core.Node=Node=function(){function Node(){}Node.prototype.entity=null;Node.prototype.previous=null;Node.prototype.next=null;return Node}();ash.core.NodeList=NodeList=function(){NodeList.prototype.head=null;NodeList.prototype.tail=null;NodeList.prototype.nodeAdded=null;NodeList.prototype.nodeRemoved=null;function NodeList(){this.nodeAdded=new Signal1;this.nodeRemoved=new Signal1}NodeList.prototype.add=function(node){if(!this.head){this.head=this.tail=node;node.next=node.previous=null}else{this.tail.next=node;node.previous=this.tail;node.next=null;this.tail=node}this.nodeAdded.dispatch(node)};NodeList.prototype.remove=function(node){if(this.head===node){this.head=this.head.next}if(this.tail===node){this.tail=this.tail.previous}if(node.previous){node.previous.next=node.next}if(node.next){node.next.previous=node.previous}this.nodeRemoved.dispatch(node)};NodeList.prototype.removeAll=function(){var node;while(this.head){node=this.head;this.head=this.head.next;node.previous=null;node.next=null;this.nodeRemoved.dispatch(node)}this.tail=null};Object.defineProperties(NodeList.prototype,{empty:{get:function(){return this.head===null}}});NodeList.prototype.swap=function(node1,node2){var temp;if(node1.previous===node2){node1.previous=node2.previous;node2.previous=node1;node2.next=node1.next;node1.next=node2}else if(node2.previous===node1){node2.previous=node1.previous;node1.previous=node2;node1.next=node2.next;node2.next=node1}else{temp=node1.previous;node1.previous=node2.previous;node2.previous=temp;temp=node1.next;node1.next=node2.next;node2.next=temp}if(this.head===node1){this.head=node2}else if(this.head===node2){this.head=node1}if(this.tail===node1){this.tail=node2}else if(this.tail===node2){this.tail=node1}if(node1.previous!==null){node1.previous.next=node1}if(node2.previous!==null){node2.previous.next=node2}if(node1.next!==null){node1.next.previous=node1}if(node2.next!==null){node2.next.previous=node2}};NodeList.prototype.insertionSort=function(sortFunction){var node,other,remains;if(this.head===this.tail){return}remains=this.head.next;node=remains;while(node!==null){remains=node.next;other=node.previous;while(other!==null){if(sortFunction(node,other)>=0){if(node!==other.next){if(this.tail===node){this.tail=node.previous}node.previous.next=node.next;if(node.next!==null){node.next.previous=node.previous}node.next=other.next;node.previous=other;node.next.previous=node;other.next=node}break}other=other.previous}if(other===null){if(this.tail===node){this.tail=node.previous}node.previous.next=node.next;if(node.next!==null){node.next.previous=node.previous}node.next=this.head;this.head.previous=node;node.previous=null;this.head=node}node=remains}};NodeList.prototype.mergeSort=function(sortFunction){var end,lists,next,start;if(this.head===this.tail){return}lists=[];start=this.head;while(start!==null){end=start;while(end.next!==null&&sortFunction(end,end.next)<=0){end=end.next}next=end.next;start.previous=end.next=null;lists.push(start);start=next}while(lists.length>1){lists.push(this.merge(lists.shift(),lists.shift(),sortFunction))}this.tail=this.head=lists[0];while(this.tail.next!==null){this.tail=this.tail.next}};NodeList.prototype.merge=function(head1,head2,sortFunction){var head,node;if(sortFunction(head1,head2)<=0){head=node=head1;head1=head1.next}else{head=node=head2;head2=head2.next}while(head1!==null&&head2!==null){if(sortFunction(head1,head2)<=0){node.next=head1;head1.previous=node;node=head1;head1=head1.next}else{node.next=head2;head2.previous=node;node=head2;head2=head2.next}}if(head1!==null){node.next=head1;head1.previous=node}else{node.next=head2;head2.previous=node}return head};return NodeList}();ash.core.NodePool=NodePool=function(){NodePool.prototype.tail=null;NodePool.prototype.nodeClass=null;NodePool.prototype.cacheTail=null;NodePool.prototype.components=null;function NodePool(nodeClass,components){this.nodeClass=nodeClass;this.components=components}NodePool.prototype.get=function(){var node;if(this.tail){node=this.tail;this.tail=this.tail.previous;node.previous=null;return node}else{return new this.nodeClass}};NodePool.prototype.dispose=function(node){var componentName;for(componentName in this.components){node[componentName]=null}node.entity=null;node.next=null;node.previous=this.tail;this.tail=node};NodePool.prototype.cache=function(node){node.previous=this.cacheTail;this.cacheTail=node};NodePool.prototype.releaseCache=function(){var node;while(this.cacheTail){node=this.cacheTail;this.cacheTail=node.previous;this.dispose(node)}};return NodePool}();ash.core.System=System=function(){function System(){this.update=__bind(this.update,this)}System.prototype.previous=null;System.prototype.next=null;System.prototype.priority=0;System.prototype.addToEngine=function(engine){};System.prototype.removeFromEngine=function(engine){};System.prototype.update=function(time){};return System}();ash.core.SystemList=SystemList=function(){function SystemList(){}SystemList.prototype.head=null;SystemList.prototype.tail=null;SystemList.prototype.add=function(system){var node;if(!this.head){this.head=this.tail=system;system.next=system.previous=null}else{node=this.tail;while(node){if(node.priority<=system.priority){break}node=node.previous}if(node===this.tail){this.tail.next=system;system.previous=this.tail;system.next=null;this.tail=system}else if(!node){system.next=this.head;system.previous=null;this.head.previous=system;this.head=system}else{system.next=node.next;system.previous=node;node.next.previous=system;node.next=system}}};SystemList.prototype.remove=function(system){if(this.head===system){this.head=this.head.next}if(this.tail===system){this.tail=this.tail.previous}if(system.previous){system.previous.next=system.next}if(system.next){system.next.previous=system.previous}};SystemList.prototype.removeAll=function(){var system;while(this.head){system=this.head;this.head=this.head.next;system.previous=null;system.next=null}this.tail=null};SystemList.prototype.get=function(type){var system;system=this.head;while(system){if(system.constructor===type){return system}system=system.next}return null};return SystemList}();ash.core.Family=Family=function(){Family.prototype.nodes=null;function Family(){Object.defineProperties(this,{nodeList:{get:function(){return this.nodes}}})}Family.prototype.newEntity=function(entity){throw new Error("Method must be overriden")};Family.prototype.removeEntity=function(entity){throw new Error("Method must be overriden")};Family.prototype.componentAddedToEntity=function(entity,componentClass){throw new Error("Method must be overriden")};Family.prototype.componentRemovedFromEntity=function(entity,componentClass){throw new Error("Method must be overriden")};Family.prototype.cleanUp=function(){throw new Error("Method must be overriden")};return Family}();ash.core.ComponentMatchingFamily=ComponentMatchingFamily=function(){ComponentMatchingFamily.prototype.nodes=null;ComponentMatchingFamily.prototype.entities=null;ComponentMatchingFamily.prototype.nodeClass=null;ComponentMatchingFamily.prototype.components=null;ComponentMatchingFamily.prototype.nodePool=null;ComponentMatchingFamily.prototype.engine=null;function ComponentMatchingFamily(nodeClass,engine){this.nodeClass=nodeClass;this.engine=engine;this.releaseNodePoolCache=__bind(this.releaseNodePoolCache,this);this.init()}ComponentMatchingFamily.prototype.init=function(){var name,type,_ref;this.nodes=new NodeList;this.entities=new Dictionary;this.components=new Dictionary;this.nodePool=new NodePool(this.nodeClass,this.nodeClass.components);_ref=this.nodeClass.components;for(name in _ref){type=_ref[name];this.components[type.name]=type}};Object.defineProperties(ComponentMatchingFamily.prototype,{nodeList:{get:function(){return this.nodes}}});ComponentMatchingFamily.prototype.newEntity=function(entity){this.addIfMatch(entity)};ComponentMatchingFamily.prototype.componentAddedToEntity=function(entity,componentClass){this.addIfMatch(entity)};ComponentMatchingFamily.prototype.componentRemovedFromEntity=function(entity,componentClass){var name;name=componentClass.name!=null?componentClass.name:componentClass;if(name in this.components){this.removeIfMatch(entity)}};ComponentMatchingFamily.prototype.removeEntity=function(entity){this.removeIfMatch(entity)};ComponentMatchingFamily.prototype.addIfMatch=function(entity){var componentClass,name,node,_ref,_ref1;if(this.entities[entity.name]==null){_ref=this.nodeClass.components;for(name in _ref){componentClass=_ref[name];if(!entity.has(componentClass)){return}}node=this.nodePool.get();node.entity=entity;_ref1=this.nodeClass.components;for(name in _ref1){componentClass=_ref1[name];node[name]=entity.get(componentClass)}this.entities[entity.name]=node;this.nodes.add(node)}};ComponentMatchingFamily.prototype.removeIfMatch=function(entity){var node;if(entity.name in this.entities){node=this.entities[entity.name];delete this.entities[entity.name];this.nodes.remove(node);if(this.engine.updating){this.nodePool.cache(node);this.engine.updateComplete.add(this.releaseNodePoolCache)}else{this.nodePool.dispose(node)}}};ComponentMatchingFamily.prototype.releaseNodePoolCache=function(){this.engine.updateComplete.remove(this.releaseNodePoolCache);this.nodePool.releaseCache()};ComponentMatchingFamily.prototype.cleanUp=function(){var node;node=this.nodes.head;while(node){this.entities.remove(node.entity);node=node.next}this.nodes.removeAll()};return ComponentMatchingFamily}();ash.core.Engine=Engine=function(){Engine.prototype.entityNames=null;Engine.prototype.entityList=null;Engine.prototype.systemList=null;Engine.prototype.families=null;Engine.prototype.updating=false;Engine.prototype.updateComplete=null;Engine.prototype.familyClass=ComponentMatchingFamily;function Engine(){this.update=__bind(this.update,this);this.componentRemoved=__bind(this.componentRemoved,this);this.componentAdded=__bind(this.componentAdded,this);this.entityNameChanged=__bind(this.entityNameChanged,this);this.entityList=new EntityList;this.entityNames=new Dictionary;this.systemList=new SystemList;this.families=new Dictionary;this.updateComplete=new Signal0}Object.defineProperties(Engine.prototype,{entities:{get:function(){var entities,entity;entities=[];entity=this.entityList.head;while(entity){this.entities.push(entity);entity=entity.next}return entities}},systems:{get:function(){var system,systems;systems=[];system=this.systemList.head;while(system){systems.push(system);system=system.next}return systems}}});Engine.prototype.addEntity=function(entity){var each,family,_ref;if(this.entityNames[entity.name]){throw"The entity name "+entity.name+" is already in use by another entity."}this.entityList.add(entity);this.entityNames[entity.name]=entity;entity.componentAdded.add(this.componentAdded);entity.componentRemoved.add(this.componentRemoved);entity.nameChanged.add(this.entityNameChanged);_ref=this.families;for(each in _ref){family=_ref[each];family.newEntity(entity)}};Engine.prototype.removeEntity=function(entity){var each,family,_ref;entity.componentAdded.remove(this.componentAdded);entity.componentRemoved.remove(this.componentRemoved);entity.nameChanged.remove(this.entityNameChanged);_ref=this.families;for(each in _ref){family=_ref[each];family.removeEntity(entity)}delete this.entityNames[entity.name];this.entityList.remove(entity)};Engine.prototype.entityNameChanged=function(entity,oldName){if(this.entityNames[oldName]===entity){delete this.entityNames[oldName];this.entityNames[entity.name]=entity}};Engine.prototype.getEntityByName=function(name){return this.entityNames[name]};Engine.prototype.removeAllEntities=function(){while(this.entityList.head!==null){this.removeEntity(this.entityList.head)}};Engine.prototype.componentAdded=function(entity,componentClass){var each,family,_ref;_ref=this.families;for(each in _ref){family=_ref[each];family.componentAddedToEntity(entity,componentClass)}};Engine.prototype.componentRemoved=function(entity,componentClass){var each,family,_ref;_ref=this.families;for(each in _ref){family=_ref[each];family.componentRemovedFromEntity(entity,componentClass)}};Engine.prototype.getNodeList=function(nodeClass){var entity,family;if(nodeClass.name in this.families){return this.families[nodeClass.name].nodeList}family=new this.familyClass(nodeClass,this);this.families[nodeClass.name]=family;entity=this.entityList.head;while(entity){family.newEntity(entity);entity=entity.next}return family.nodeList};Engine.prototype.releaseNodeList=function(nodeClass){if(nodeClass.name in this.families){this.families[nodeClass.name].cleanUp();delete this.families[nodeClass.name]}};Engine.prototype.addSystem=function(system,priority){system.priority=priority;system.addToEngine(this);this.systemList.add(system)};Engine.prototype.getSystem=function(type){return systemList.get(type)};Engine.prototype.removeSystem=function(system){this.systemList.remove(system);system.removeFromEngine(this)};Engine.prototype.removeAllSystems=function(){while(this.systemList.head!==null){this.removeSystem(this.systemList.head)}};Engine.prototype.update=function(time){var system;this.updating=true;system=this.systemList.head;while(system){system.update(time);system=system.next}this.updating=false;this.updateComplete.dispatch()};return Engine}();ash.core.PhaserEngine=PhaserEngine=function(_super){__extends(PhaserEngine,_super);PhaserEngine.prototype.entityNames=null;PhaserEngine.prototype.entityList=null;PhaserEngine.prototype.systemList=null;PhaserEngine.prototype.families=null;PhaserEngine.prototype.nodes=null;PhaserEngine.prototype.components=null;PhaserEngine.prototype.game=null;PhaserEngine.prototype.parent=null;PhaserEngine.prototype.active=true;PhaserEngine.prototype.visible=true;PhaserEngine.prototype.hasPostRender=true;PhaserEngine.prototype.updating=false;PhaserEngine.prototype.updateComplete=null;PhaserEngine.prototype.familyClass=ComponentMatchingFamily;function PhaserEngine(game,parent){this.postRender=__bind(this.postRender,this);this.removeAllSystems=__bind(this.removeAllSystems,this);this.removeSystem=__bind(this.removeSystem,this);this.getSystem=__bind(this.getSystem,this);this.addSystem=__bind(this.addSystem,this);this.releaseNodeList=__bind(this.releaseNodeList,this);this.getNodeList=__bind(this.getNodeList,this);this.componentRemoved=__bind(this.componentRemoved,this);this.componentAdded=__bind(this.componentAdded,this);this.removeAllEntities=__bind(this.removeAllEntities,this);this.getEntityByName=__bind(this.getEntityByName,this);this.entityNameChanged=__bind(this.entityNameChanged,this);this.removeEntity=__bind(this.removeEntity,this);this.addEntity=__bind(this.addEntity,this);this.init=__bind(this.init,this);PhaserEngine.__super__.constructor.call(this,game,parent);this.nodes={};this.components={};this.entityList=new EntityList;this.entityNames=new Dictionary;this.systemList=new SystemList;this.families=new Dictionary;this.updateComplete=new Signal0}PhaserEngine.prototype.addNode=function(name,def){var property,type,_ref;if(def.components==null){def.components={};_ref=def.prototype;for(property in _ref){if(!__hasProp.call(_ref,property))continue;type=_ref[property];def.components[property]=type;def.prototype[property]=null}def.prototype.entity=null;def.prototype.previous=null;def.prototype.next=null}return this.nodes[name]=def};PhaserEngine.prototype.init=function(nodes,components){var klass,name,property,type,_ref,_results;if(components!=null){for(name in components){klass=components[name];this.components[name]=klass}}if(nodes!=null){_results=[];for(name in nodes){klass=nodes[name];if(klass.components==null){klass.components={};_ref=klass.prototype;for(property in _ref){if(!__hasProp.call(_ref,property))continue;type=_ref[property];klass.components[property]=type;klass.prototype[property]=null}klass.prototype.entity=null;klass.prototype.previous=null;klass.prototype.next=null}if(components!=null){_results.push(this.nodes[name]=klass)}else{_results.push(void 0)}}return _results}};Object.defineProperties(PhaserEngine.prototype,{entities:{get:function(){var entities,entity;entities=[];entity=this.entityList.head;while(entity){this.entities.push(entity);entity=entity.next}return entities}},systems:{get:function(){var system,systems;systems=[];system=this.systemList.head;while(system){systems.push(system);system=system.next}return systems}}});PhaserEngine.prototype.addEntity=function(entity){var each,family,_ref;if(this.entityNames[entity.name]){throw"The entity name "+entity.name+" is already in use by another entity."}this.entityList.add(entity);this.entityNames[entity.name]=entity;entity.componentAdded.add(this.componentAdded);entity.componentRemoved.add(this.componentRemoved);entity.nameChanged.add(this.entityNameChanged);_ref=this.families;for(each in _ref){family=_ref[each];family.newEntity(entity)}};PhaserEngine.prototype.removeEntity=function(entity){var each,family,_ref;entity.componentAdded.remove(this.componentAdded);entity.componentRemoved.remove(this.componentRemoved);entity.nameChanged.remove(this.entityNameChanged);_ref=this.families;for(each in _ref){family=_ref[each];family.removeEntity(entity)}delete this.entityNames[entity.name];this.entityList.remove(entity)};PhaserEngine.prototype.entityNameChanged=function(entity,oldName){if(this.entityNames[oldName]===entity){delete this.entityNames[oldName];this.entityNames[entity.name]=entity}};PhaserEngine.prototype.getEntityByName=function(name){return this.entityNames[name]};PhaserEngine.prototype.removeAllEntities=function(){while(this.entityList.head!==null){this.removeEntity(this.entityList.head)}};PhaserEngine.prototype.componentAdded=function(entity,componentClass){var each,family,_ref;_ref=this.families;for(each in _ref){family=_ref[each];family.componentAddedToEntity(entity,componentClass)}};PhaserEngine.prototype.componentRemoved=function(entity,componentClass){var each,family,_ref;_ref=this.families;for(each in _ref){family=_ref[each];family.componentRemovedFromEntity(entity,componentClass)}};PhaserEngine.prototype.getNodeList=function(nodeClass){var entity,family;if(nodeClass.name in this.families){return this.families[nodeClass.name].nodeList}family=new this.familyClass(nodeClass,this);this.families[nodeClass.name]=family;entity=this.entityList.head;while(entity){family.newEntity(entity);entity=entity.next}return family.nodeList};PhaserEngine.prototype.releaseNodeList=function(nodeClass){if(nodeClass.name in this.families){this.families[nodeClass.name].cleanUp();delete this.families[nodeClass.name]}};PhaserEngine.prototype.addSystem=function(system,priority){system.priority=priority;system.addToEngine(this);this.systemList.add(system)};PhaserEngine.prototype.getSystem=function(type){return systemList.get(type)};PhaserEngine.prototype.removeSystem=function(system){this.systemList.remove(system);system.removeFromEngine(this)};PhaserEngine.prototype.removeAllSystems=function(){while(this.systemList.head!==null){this.removeSystem(this.systemList.head)}};PhaserEngine.prototype.postRender=function(){var system,time;time=this.game.time.elapsed*.001;this.updating=true;system=this.systemList.head;while(system){system.update(time);system=system.next}this.updating=false;this.updateComplete.dispatch()};return PhaserEngine}(Phaser.Plugin);ash.fsm.ComponentInstanceProvider=ComponentInstanceProvider=function(){ComponentInstanceProvider.prototype.instance=null;function ComponentInstanceProvider(instance){this.instance=instance}ComponentInstanceProvider.prototype.getComponent=function(){return this.instance};Object.defineProperties(ComponentInstanceProvider.prototype,{identifier:{get:function(){return this.instance}}});return ComponentInstanceProvider}();ash.fsm.ComponentSingletonProvider=ComponentSingletonProvider=function(){ComponentSingletonProvider.prototype.componentType=null;ComponentSingletonProvider.prototype.instance=null;function ComponentSingletonProvider(type){this.componentType=type}ComponentSingletonProvider.prototype.getComponent=function(){if(this.instance==null){this.instance=new this.componentType}return this.instance};Object.defineProperties(ComponentSingletonProvider.prototype,{identifier:{get:function(){return this.getComponent()}}});return ComponentSingletonProvider}();ash.fsm.ComponentTypeProvider=ComponentTypeProvider=function(){ComponentTypeProvider.prototype.componentType=null;function ComponentTypeProvider(type){this.componentType=type}ComponentTypeProvider.prototype.getComponent=function(){return new this.componentType};Object.defineProperties(ComponentTypeProvider.prototype,{identifier:{get:function(){return this.componentType}}});return ComponentTypeProvider}();ash.fsm.DynamicComponentProvider=DynamicComponentProvider=function(){DynamicComponentProvider.prototype._closure=null;function DynamicComponentProvider(closure){this._closure=closure}DynamicComponentProvider.prototype.getComponent=function(){return this._closure};Object.defineProperties(DynamicComponentProvider.prototype,{identifier:{get:function(){return this._closure}}});return DynamicComponentProvider}();ash.fsm.DynamicSystemProvider=DynamicSystemProvider=function(){DynamicSystemProvider.prototype.method=function(){};DynamicSystemProvider.prototype.systemPriority=0;function DynamicSystemProvider(method){this.method=method}DynamicSystemProvider.prototype.getSystem=function(){return this.method()};Object.defineProperties(DynamicSystemProvider.prototype,{identifier:{get:function(){return this.method}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return DynamicSystemProvider}();ash.fsm.EngineState=EngineState=function(){EngineState.prototype.providers=null;function EngineState(){this.providers=[]}EngineState.prototype.addInstance=function(system){return this.addProvider(new SystemInstanceProvider(system))};EngineState.prototype.addSingleton=function(type){return this.addProvider(new SystemSingletonProvider(type))};EngineState.prototype.addMethod=function(method){return this.addProvider(new DynamicSystemProvider(method))};EngineState.prototype.addProvider=function(provider){var mapping;mapping=new StateSystemMapping(this,provider);this.providers.push(provider);return mapping};return EngineState}();ash.fsm.StateComponentMapping=StateComponentMapping=function(){StateComponentMapping.prototype.componentType=null;StateComponentMapping.prototype.creatingState=null;StateComponentMapping.prototype.provider=null;function StateComponentMapping(creatingState,type){this.creatingState=creatingState;this.componentType=type;this.withType(type)}StateComponentMapping.prototype.withInstance=function(component){this.setProvider(new ComponentInstanceProvider(component));return this};StateComponentMapping.prototype.withType=function(type){this.setProvider(new ComponentTypeProvider(type));return this};StateComponentMapping.prototype.withSingleton=function(type){if(type==null){type=this.componentType}this.setProvider(new ComponentSingletonProvider(type));return this};StateComponentMapping.prototype.withMethod=function(method){this.setProvider(new DynamicComponentProvider(method));return this};StateComponentMapping.prototype.withProvider=function(provider){this.setProvider(provider);return this};StateComponentMapping.prototype.add=function(type){return this.creatingState.add(type)};StateComponentMapping.prototype.setProvider=function(provider){this.provider=provider;return this.creatingState.providers[this.componentType]=provider};return StateComponentMapping}();ash.fsm.EngineStateMachine=EngineStateMachine=function(){EngineStateMachine.prototype.engine=null;EngineStateMachine.prototype.states=null;EngineStateMachine.prototype.currentState=null;function EngineStateMachine(engine){this.engine=engine;this.states=new Dictionary}EngineStateMachine.prototype.addState=function(name,state){this.states[name]=state;return this};EngineStateMachine.prototype.createState=function(name){var state;state=new EngineState;this.states[name]=state;return this};EngineStateMachine.prototype.changeState=function(name){var each,id,newState,other,provider,toAdd,_ref,_ref1;newState=this.states[name];if(newState==null){throw new Error("Engine state "+name+" doesn't exist")}if(newState===this.currentState){newState=null;return}toAdd=new Dictionary;_ref=newState.providers;
for(each in _ref){provider=_ref[each];id=provider.identifier;toAdd[id]=provider}if(currentState){_ref1=this.currentState.providers;for(each in _ref1){provider=_ref1[each];id=provider.identifier;other=toAdd[id];if(other){delete toAdd[id]}else{this.engine.removeSystem(provider.getSystem())}}}for(each in toAdd){provider=toAdd[each];this.engine.addSystem(provider.getSystem(),provider.priority)}return this.currentState=newState};return EngineStateMachine}();ash.fsm.EntityState=EntityState=function(){EntityState.prototype.providers=null;function EntityState(){this.providers=new Dictionary}EntityState.prototype.add=function(type){return new StateComponentMapping(this,type.name)};EntityState.prototype.get=function(type){return this.providers[type]};EntityState.prototype.has=function(type){return this.providers[type]!==null};return EntityState}();ash.fsm.EntityStateMachine=EntityStateMachine=function(){EntityStateMachine.prototype.states=null;EntityStateMachine.prototype.currentState=null;EntityStateMachine.prototype.entity=null;function EntityStateMachine(entity){this.entity=entity;this.states=new Dictionary}EntityStateMachine.prototype.addState=function(name,state){this.states[name]=state;return this};EntityStateMachine.prototype.createState=function(name){var state;state=new EntityState;this.states[name]=state;return state};EntityStateMachine.prototype.changeState=function(name){var newState,other,toAdd,type;newState=this.states[name];if(!newState){throw new Error("Entity state "+name+" doesn't exist")}if(newState===this.currentState){newState=null;return}if(this.currentState){toAdd=new Dictionary;for(type in newState.providers){toAdd[type]=newState.providers[type]}for(type in this.currentState.providers){other=toAdd[type];if(other&&other.identifier===this.currentState.providers[type].identifier){delete toAdd[type]}else{this.entity.remove(type)}}}else{toAdd=newState.providers}for(type in toAdd){this.entity.add(toAdd[type].getComponent())}return this.currentState=newState};return EntityStateMachine}();ash.fsm.StateSystemMapping=StateSystemMapping=function(){StateSystemMapping.prototype.creatingState=null;StateSystemMapping.prototype.provider=null;function StateSystemMapping(creatingState,provider){this.creatingState=creatingState;this.provider=provider}StateSystemMapping.prototype.withPriority=function(priority){this.provider.priority=priority;return this};StateSystemMapping.prototype.addInstance=function(system){return creatingState.addInstance(system)};StateSystemMapping.prototype.addSingleton=function(type){return creatingState.addSingleton(type)};StateSystemMapping.prototype.addMethod=function(method){return creatingState.addMethod(method)};StateSystemMapping.prototype.addProvider=function(provider){return creatingState.addProvider(provider)};return StateSystemMapping}();ash.fsm.SystemInstanceProvider=SystemInstanceProvider=function(){SystemInstanceProvider.prototype.instance=null;SystemInstanceProvider.prototype.systemPriority=0;function SystemInstanceProvider(instance){this.instance=instance}SystemInstanceProvider.prototype.getSystem=function(){return this.instance};Object.defineProperties(SystemInstanceProvider.prototype,{identifier:{get:function(){return this.instance}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return SystemInstanceProvider}();ash.fsm.SystemSingletonProvider=SystemSingletonProvider=function(){SystemSingletonProvider.prototype.componentType=null;SystemSingletonProvider.prototype.instance=null;SystemSingletonProvider.prototype.systemPriority=0;function SystemSingletonProvider(type){this.componentType=type}SystemSingletonProvider.prototype.getSystem=function(){if(!this.instance){this.instance=new this.componentType}return this.instance};Object.defineProperties(SystemSingletonProvider.prototype,{identifier:{get:function(){return this.getSystem()}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return SystemSingletonProvider}();ash.tick.FrameTickProvider=FrameTickProvider=function(_super){__extends(FrameTickProvider,_super);FrameTickProvider.prototype.displayObject=null;FrameTickProvider.prototype.previousTime=0;FrameTickProvider.prototype.maximumFrameTime=0;FrameTickProvider.prototype.isPlaying=false;FrameTickProvider.prototype.request=null;FrameTickProvider.prototype.timeAdjustment=1;function FrameTickProvider(displayObject,maximumFrameTime){this.displayObject=displayObject;this.maximumFrameTime=maximumFrameTime;this.dispatchTick=__bind(this.dispatchTick,this);FrameTickProvider.__super__.constructor.apply(this,arguments)}Object.defineProperties(FrameTickProvider.prototype,{playing:{get:function(){return this.isPlaying}}});FrameTickProvider.prototype.start=function(){this.request=requestAnimationFrame(this.dispatchTick);this.isPlaying=true};FrameTickProvider.prototype.stop=function(){cancelRequestAnimationFrame(this.request);this.isPlaying=false};FrameTickProvider.prototype.dispatchTick=function(timestamp){var frameTime,temp;if(timestamp==null){timestamp=Date.now()}if(this.displayObject){this.displayObject.begin()}temp=this.previousTime||timestamp;this.previousTime=timestamp;frameTime=(timestamp-temp)*.001;this.dispatch(frameTime);requestAnimationFrame(this.dispatchTick);if(this.displayObject){this.displayObject.end()}};return FrameTickProvider}(Signal1);ash.tools.ComponentPool=ComponentPool=function(){var getPool,pools;function ComponentPool(){}pools=new Dictionary;getPool=function(componentClass){var _ref;if(_ref=componentClass.name,__indexOf.call(pools,_ref)>=0){return pools[componentClass.name]}else{return pools[componentClass.name]=[]}};ComponentPool.get=function(componentClass){var pool;pool=getPool(componentClass);if(pool.length>0){return pool.pop()}else{return new componentClass}};ComponentPool.dispose=function(component){var pool,type;if(component){type=component.constructor;pool=getPool(type);pool.push(component)}};ComponentPool.empty=function(){return pools=new Dictionary};return ComponentPool}();ash.tools.ListIteratingSystem=ListIteratingSystem=function(_super){__extends(ListIteratingSystem,_super);ListIteratingSystem.prototype.nodeList=null;ListIteratingSystem.prototype.nodeClass=null;ListIteratingSystem.prototype.nodeUpdateFunction=null;ListIteratingSystem.prototype.nodeAddedFunction=null;ListIteratingSystem.prototype.nodeRemovedFunction=null;function ListIteratingSystem(nodeClass,nodeUpdateFunction,nodeAddedFunction,nodeRemovedFunction){if(nodeAddedFunction==null){nodeAddedFunction=null}if(nodeRemovedFunction==null){nodeRemovedFunction=null}this.nodeClass=nodeClass;this.nodeUpdateFunction=nodeUpdateFunction;this.nodeAddedFunction=nodeAddedFunction;this.nodeRemovedFunction=nodeRemovedFunction}ListIteratingSystem.prototype.addToEngine=function(engine){var node;this.nodeList=engine.getNodeList(this.nodeClass);if(this.nodeAddedFunction!==null){node=this.nodeList.head;while(node){this.nodeAddedFunction(node);node=node.next}this.nodeList.nodeAdded.add(this.nodeAddedFunction)}if(this.nodeRemovedFunction!==null){this.nodeList.nodeRemoved.add(this.nodeRemovedFunction)}};ListIteratingSystem.prototype.removeFromEngine=function(engine){if(this.nodeAddedFunction!==null){this.nodeList.nodeAdded.remove(this.nodeAddedFunction)}if(this.nodeRemovedFunction!==null){this.nodeList.nodeRemoved.remove(this.nodeRemovedFunction)}this.nodeList=null};ListIteratingSystem.prototype.update=function(time){var node;node=this.nodeList.head;while(node){this.nodeUpdateFunction(node,time);node=node.next}};return ListIteratingSystem}(System);if(typeof module!=="undefined"&&module!==null){module.exports=ash}else{window.ash=ash}}).call(this);var Stats=function(){var l=Date.now(),m=l,g=0,n=Infinity,o=0,h=0,p=Infinity,q=0,r=0,s=0,f=document.createElement("div");f.id="stats";f.addEventListener("mousedown",function(b){b.preventDefault();t(++s%2)},!1);f.style.cssText="width:80px;opacity:0.9;cursor:pointer";var a=document.createElement("div");a.id="fps";a.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002";f.appendChild(a);var i=document.createElement("div");i.id="fpsText";i.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";i.innerHTML="FPS";a.appendChild(i);var c=document.createElement("div");c.id="fpsGraph";c.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";for(a.appendChild(c);74>c.children.length;){var j=document.createElement("span");j.style.cssText="width:1px;height:30px;float:left;background-color:#113";c.appendChild(j)}var d=document.createElement("div");d.id="ms";d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none";f.appendChild(d);var k=document.createElement("div");k.id="msText";k.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";k.innerHTML="MS";d.appendChild(k);var e=document.createElement("div");e.id="msGraph";e.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";for(d.appendChild(e);74>e.children.length;)j=document.createElement("span"),j.style.cssText="width:1px;height:30px;float:left;background-color:#131",e.appendChild(j);var t=function(b){s=b;switch(s){case 0:a.style.display="block";d.style.display="none";break;case 1:a.style.display="none",d.style.display="block"}};return{REVISION:12,domElement:f,setMode:t,begin:function(){l=Date.now()},end:function(){var b=Date.now();g=b-l;n=Math.min(n,g);o=Math.max(o,g);k.textContent=g+" MS ("+n+"-"+o+")";var a=Math.min(30,30-30*(g/200));e.appendChild(e.firstChild).style.height=a+"px";r++;b>m+1e3&&(h=Math.round(1e3*r/(b-m)),p=Math.min(p,h),q=Math.max(q,h),i.textContent=h+" FPS ("+p+"-"+q+")",a=Math.min(30,30-30*(h/100)),c.appendChild(c.firstChild).style.height=a+"px",m=b,r=0);return b},update:function(){l=this.end()}}};"object"===typeof module&&(module.exports=Stats);!function(_global,undefined){function localStorageDB(db_name,engine){var db_prefix="db_",db_id=db_prefix+db_name,db_new=false,db=null;try{var storage=engine==sessionStorage?sessionStorage:localStorage}catch(e){var storage=engine}db=storage[db_id];if(!(db&&(db=JSON.parse(db))&&db.tables&&db.data)){if(!validateName(db_name)){error("The name '"+db_name+"' contains invalid characters")}else{db={tables:{},data:{}};commit();db_new=true}}function drop(){if(storage.hasOwnProperty(db_id)){delete storage[db_id]}db=null}function tableCount(){var count=0;for(var table in db.tables){if(db.tables.hasOwnProperty(table)){count++}}return count}function tableFields(table_name){return db.tables[table_name].fields}function tableExists(table_name){return db.tables[table_name]?true:false}function tableExistsWarn(table_name){if(!tableExists(table_name)){error("The table '"+table_name+"' does not exist")}}function columnExists(table_name,field_name){var exists=false;var table_fields=db.tables[table_name].fields;for(var field in table_fields){if(table_fields[field]==field_name){exists=true;break}}return exists}function createTable(table_name,fields){db.tables[table_name]={fields:fields,auto_increment:1};db.data[table_name]={}}function dropTable(table_name){delete db.tables[table_name];delete db.data[table_name]}function truncate(table_name){db.tables[table_name].auto_increment=1;db.data[table_name]={}}function alterTable(table_name,new_fields,default_values){db.tables[table_name].fields=db.tables[table_name].fields.concat(new_fields);if(typeof default_values!="undefined"){for(var ID in db.data[table_name]){if(!db.data[table_name].hasOwnProperty(ID)){continue}for(var field in new_fields){if(typeof default_values=="object"){db.data[table_name][ID][new_fields[field]]=default_values[new_fields[field]]}else{db.data[table_name][ID][new_fields[field]]=default_values}}}}}function rowCount(table_name){var count=0;for(var ID in db.data[table_name]){if(db.data[table_name].hasOwnProperty(ID)){count++}}return count}function insert(table_name,data){data.ID=db.tables[table_name].auto_increment;db.data[table_name][db.tables[table_name].auto_increment]=data;db.tables[table_name].auto_increment++;return data.ID}function select(table_name,ids,start,limit,sort,distinct){var ID=null,results=[],row=null;for(var i=0;i<ids.length;i++){ID=ids[i];row=db.data[table_name][ID];results.push(clone(row))}if(sort&&sort instanceof Array){for(var i=0;i<sort.length;i++){results.sort(sort_results(sort[i][0],sort[i].length>1?sort[i][1]:null))}}if(distinct&&distinct instanceof Array){for(var j=0;j<distinct.length;j++){var seen={},d=distinct[j];for(var i=0;i<results.length;i++){if(results[i]===undefined){continue}if(results[i].hasOwnProperty(d)&&seen.hasOwnProperty(results[i][d])){delete results[i]}else{seen[results[i][d]]=1}}}var new_results=[];for(var i=0;i<results.length;i++){if(results[i]!==undefined){new_results.push(results[i])}}results=new_results}start=start&&typeof start==="number"?start:null;limit=limit&&typeof limit==="number"?limit:null;if(start&&limit){results=results.slice(start,start+limit)}else if(start){results=results.slice(start)}else if(limit){results=results.slice(start,limit)}return results}function sort_results(field,order){return function(x,y){var v1=typeof x[field]==="string"?x[field].toLowerCase():x[field],v2=typeof y[field]==="string"?y[field].toLowerCase():y[field];if(order==="DESC"){return v1==v2?0:v1<v2?1:-1}else{return v1==v2?0:v1>v2?1:-1}}}function queryByValues(table_name,data){var result_ids=[],exists=false,row=null;for(var ID in db.data[table_name]){if(!db.data[table_name].hasOwnProperty(ID)){continue}row=db.data[table_name][ID];exists=true;for(var field in data){if(!data.hasOwnProperty(field)){continue}if(typeof data[field]=="string"){if(row[field].toString().toLowerCase()!=data[field].toString().toLowerCase()){exists=false;break}}else{if(row[field]!=data[field]){exists=false;break}}}if(exists){result_ids.push(ID)}}return result_ids}function queryByFunction(table_name,query_function){var result_ids=[],exists=false,row=null;for(var ID in db.data[table_name]){if(!db.data[table_name].hasOwnProperty(ID)){continue}row=db.data[table_name][ID];if(query_function(clone(row))==true){result_ids.push(ID)}}return result_ids}function getIDs(table_name){var result_ids=[];for(var ID in db.data[table_name]){if(db.data[table_name].hasOwnProperty(ID)){result_ids.push(ID)}}return result_ids}function deleteRows(table_name,ids){for(var i=0;i<ids.length;i++){if(db.data[table_name].hasOwnProperty(ids[i])){delete db.data[table_name][ids[i]]}}return ids.length}function update(table_name,ids,update_function){var ID="",num=0;for(var i=0;i<ids.length;i++){ID=ids[i];var updated_data=update_function(clone(db.data[table_name][ID]));if(updated_data){delete updated_data["ID"];var new_data=db.data[table_name][ID];for(var field in updated_data){if(updated_data.hasOwnProperty(field)){new_data[field]=updated_data[field]}}db.data[table_name][ID]=validFields(table_name,new_data);num++}}return num}function commit(){try{storage.setItem(db_id,JSON.stringify(db));return true}catch(e){return false}}function serialize(){return JSON.stringify(db)}function error(msg){throw new Error(msg)}function clone(obj){var new_obj={};for(var key in obj){if(obj.hasOwnProperty(key)){new_obj[key]=obj[key]}}return new_obj}function validateName(name){return name.toString().match(/[^a-z_0-9]/gi)?false:true}function validFields(table_name,data){var field="",new_data={};for(var i=0;i<db.tables[table_name].fields.length;i++){field=db.tables[table_name].fields[i];if(data[field]!==undefined){new_data[field]=data[field]}}return new_data}function validateData(table_name,data){var field="",new_data={};for(var i=0;i<db.tables[table_name].fields.length;i++){field=db.tables[table_name].fields[i];new_data[field]=data[field]===null||data[field]===undefined?null:data[field]}return new_data}return{commit:function(){return commit()},isNew:function(){return db_new},drop:function(){drop()},serialize:function(){return serialize()},tableExists:function(table_name){return tableExists(table_name)},tableFields:function(table_name){return tableFields(table_name)},tableCount:function(){return tableCount()},columnExists:function(table_name,field_name){return columnExists(table_name,field_name)},createTable:function(table_name,fields){var result=false;if(!validateName(table_name)){error("The database name '"+table_name+"' contains invalid characters.")}else if(this.tableExists(table_name)){error("The table name '"+table_name+"' already exists.")}else{var is_valid=true;for(var i=0;i<fields.length;i++){if(!validateName(fields[i])){is_valid=false;break}}if(is_valid){var fields_literal={};for(var i=0;i<fields.length;i++){fields_literal[fields[i]]=true}delete fields_literal["ID"];fields=["ID"];for(var field in fields_literal){if(fields_literal.hasOwnProperty(field)){fields.push(field)}}createTable(table_name,fields);result=true}else{error("One or more field names in the table definition contains invalid characters")}}return result},createTableWithData:function(table_name,data){if(typeof data!=="object"||!data.length||data.length<1){error("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]")}var fields=Object.keys(data[0]);if(this.createTable(table_name,fields)){this.commit();for(var i=0;i<data.length;i++){if(!insert(table_name,data[i])){error("Failed to insert record: ["+JSON.stringify(data[i])+"]")}}this.commit()}return true},dropTable:function(table_name){tableExistsWarn(table_name);dropTable(table_name)},truncate:function(table_name){tableExistsWarn(table_name);truncate(table_name)},alterTable:function(table_name,new_fields,default_values){var result=false;if(!validateName(table_name)){error("The database name '"+table_name+"' contains invalid characters")}else{if(typeof new_fields=="object"){var is_valid=true;for(var i=0;i<new_fields.length;i++){if(!validateName(new_fields[i])){is_valid=false;break}}if(is_valid){var fields_literal={};for(var i=0;i<new_fields.length;i++){fields_literal[new_fields[i]]=true}delete fields_literal["ID"];new_fields=[];for(var field in fields_literal){if(fields_literal.hasOwnProperty(field)){new_fields.push(field)}}alterTable(table_name,new_fields,default_values);result=true}else{error("One or more field names in the table definition contains invalid characters")}}else if(typeof new_fields=="string"){if(validateName(new_fields)){var new_fields_array=[];new_fields_array.push(new_fields);alterTable(table_name,new_fields_array,default_values);result=true}else{error("One or more field names in the table definition contains invalid characters")}}}return result},rowCount:function(table_name){tableExistsWarn(table_name);return rowCount(table_name)},insert:function(table_name,data){tableExistsWarn(table_name);return insert(table_name,validateData(table_name,data))},insertOrUpdate:function(table_name,query,data){tableExistsWarn(table_name);var result_ids=[];if(!query){result_ids=getIDs(table_name)}else if(typeof query=="object"){result_ids=queryByValues(table_name,validFields(table_name,query))}else if(typeof query=="function"){result_ids=queryByFunction(table_name,query)}if(result_ids.length==0){return insert(table_name,validateData(table_name,data))}else{var ids=[];for(var n=0;n<result_ids.length;n++){update(table_name,result_ids,function(o){ids.push(o.ID);return data})}return ids}},update:function(table_name,query,update_function){tableExistsWarn(table_name);var result_ids=[];if(!query){result_ids=getIDs(table_name)}else if(typeof query=="object"){result_ids=queryByValues(table_name,validFields(table_name,query))}else if(typeof query=="function"){result_ids=queryByFunction(table_name,query)}return update(table_name,result_ids,update_function)},query:function(table_name,query,limit,start,sort,distinct){tableExistsWarn(table_name);var result_ids=[];if(!query){result_ids=getIDs(table_name,limit,start)}else if(typeof query=="object"){result_ids=queryByValues(table_name,validFields(table_name,query),limit,start)}else if(typeof query=="function"){result_ids=queryByFunction(table_name,query,limit,start)}return select(table_name,result_ids,start,limit,sort,distinct)},queryAll:function(table_name,params){if(!params){return this.query(table_name)}else{return this.query(table_name,params.hasOwnProperty("query")?params.query:null,params.hasOwnProperty("limit")?params.limit:null,params.hasOwnProperty("start")?params.start:null,params.hasOwnProperty("sort")?params.sort:null,params.hasOwnProperty("distinct")?params.distinct:null)}},deleteRows:function(table_name,query){tableExistsWarn(table_name);var result_ids=[];if(!query){result_ids=getIDs(table_name)}else if(typeof query=="object"){result_ids=queryByValues(table_name,validFields(table_name,query))}else if(typeof query=="function"){result_ids=queryByFunction(table_name,query)}return deleteRows(table_name,result_ids)}}}if(typeof define==="function"&&define.amd){define(function(){return localStorageDB})}else{_global["localStorageDB"]=localStorageDB}}(window);(function(){"use strict";var AnimationSystem,AsteroidDeathView,AsteroidView,Asteroids,AudioSystem,BulletAgeSystem,BulletView,CollisionSystem,Components,DeathThroesSystem,Dot,Entities,ExplodeAsteroid,ExplodeShip,FixedPhysicsSystem,GameManager,GunControlSystem,HudSystem,HudView,KeyPoll,MersenneTwister,Nodes,Point,RenderSystem,ShipControlSystem,ShootGun,SmoothPhysicsSystem,Sound,SpaceshipDeathView,SpaceshipView,SystemPriorities,WaitForStartSystem,WaitForStartView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};MersenneTwister=function(){var LOWER_MASK,M,MATRIX_A,N,UPPER_MASK;N=624;M=397;MATRIX_A=2567483615;UPPER_MASK=2147483648;LOWER_MASK=2147483647;MersenneTwister.prototype.mt=null;MersenneTwister.prototype.mti=N+1;function MersenneTwister(seed){var _i,_results;this.mt=function(){_results=[];for(var _i=0;0<=N?_i<N:_i>N;0<=N?_i++:_i--){_results.push(_i)}return _results}.apply(this);switch(typeof seed){case"number":this.init_genrand(seed);break;case"object":this.init_genrand(seed,seed.length);break;default:this.init_genrand(Date.now()%LOWER_MASK)}}MersenneTwister.prototype.nextBool=function(){return(this.genrand_int32()&1)===1};MersenneTwister.prototype.nextDouble=function(){return this.genrand_res53()};MersenneTwister.prototype.nextInt=function(max){return~~(this.genrand_res53()*max)};MersenneTwister.prototype.init_genrand=function(s){this.mt[0]=s&4294967295;this.mti=1;while(this.mti<N){this.mt[this.mti]=1812433253*(this.mt[this.mti-1]^this.mt[this.mti-1]>>30)+this.mti;this.mt[this.mti]&=4294967295;this.mti++}};MersenneTwister.prototype.init_by_array=function(init_key,key_length){var i,j,k;this.init_genrand(19650218);i=1;j=0;k=N>key_length?N:key_length;while(k>0){this.mt[i]=(this.mt[i]^(this.mt[i-1]^this.mt[i-1]>>30)*1664525)+init_key[j]+j;this.mt[i]&=4294967295;i++;j++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}if(j>=key_length){j=0}k--}k=N-1;while(k>0){this.mt[i]=(this.mt[i]^(this.mt[i-1]^this.mt[i-1]>>30)*1566083941)-i;this.mt[i]&=4294967295;i++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}k--}this.mt[0]=2147483648};MersenneTwister.prototype.genrand_int32=function(){var kk,mag01,y;mag01=[0,MATRIX_A];if(this.mti>=N){if(this.mti===N+1){this.init_genrand(5489)}kk=0;while(kk<N-M){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+M]^y>>1^mag01[y&1];kk++}while(kk<N-1){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+(M-N)]^y>>1^mag01[y&1];kk++}y=this.mt[N-1]&UPPER_MASK|this.mt[0]&LOWER_MASK;this.mt[N-1]=this.mt[M-1]^y>>1^mag01[y&1];this.mti=0}y=this.mt[this.mti++];y^=y>>11;y^=y<<7&2636928640;y^=y<<15&4022730752;y^=y>>18;return y>>0};MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>1};MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967296)};MersenneTwister.prototype.genrand_real2=function(){return this.genrand_int32()*(1/4294967296)};MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)};MersenneTwister.prototype.genrand_res53=function(){var a,b;a=this.genrand_int32()>>5;b=this.genrand_int32()>>6;return(a*67108864+b)*(1/9007199254740992)};return MersenneTwister}();Point=function(){Point.prototype.x=0;Point.prototype.y=0;function Point(x,y){this.x=x!=null?x:0;this.y=y!=null?y:0}Point.distance=function(point1,point2){var dx,dy;dx=point1.x-point2.x;dy=point1.y-point2.y;return Math.sqrt(dx*dx+dy*dy)};Point.prototype.distanceSquaredTo=function(targetPoint){var dx,dy;dx=this.x-targetPoint.x;dy=this.y-targetPoint.y;return dx*dx+dy*dy};Point.prototype.distanceTo=function(targetPoint){var dx,dy;dx=this.x-targetPoint.x;dy=this.y-targetPoint.y;return Math.sqrt(dx*dx+dy*dy)};return Point}();KeyPoll=function(){KeyPoll.KEY_LEFT=37;KeyPoll.KEY_UP=38;KeyPoll.KEY_RIGHT=39;KeyPoll.KEY_Z=90;KeyPoll.KEY_W=87;KeyPoll.KEY_SPACE=32;KeyPoll.prototype.states=null;KeyPoll.prototype.keys=[KeyPoll.KEY_LEFT,KeyPoll.KEY_RIGHT,KeyPoll.KEY_Z,KeyPoll.KEY_UP,KeyPoll.KEY_SPACE];function KeyPoll(parent){this.parent=parent;this.isUp=__bind(this.isUp,this);this.isDown=__bind(this.isDown,this);this.keyUpListener=__bind(this.keyUpListener,this);this.keyDownListener=__bind(this.keyDownListener,this);this.states={};window.addEventListener("keydown",this.keyDownListener);window.addEventListener("keyup",this.keyUpListener)}KeyPoll.prototype.keyDownListener=function(event){this.states[event.keyCode]=true};KeyPoll.prototype.keyUpListener=function(event){if(this.states[event.keyCode]){this.states[event.keyCode]=false}};KeyPoll.prototype.isDown=function(keyCode){return this.states[keyCode]};KeyPoll.prototype.isUp=function(keyCode){return!this.states[keyCode]};KeyPoll.prototype.buttons=function(game,config){var btn2,btn4;btn2=game.add.button(config.width-100,config.height-50,"round");btn2.onInputDown.add(function(_this){return function(){_this.states[_this.keys[2]]=true}}(this));btn2.onInputUp.add(function(_this){return function(){_this.states[_this.keys[2]]=false}}(this));btn4=game.add.button(config.width/2,config.height-50,"square");btn4.anchor.x=.5;btn4.onInputDown.add(function(_this){return function(){_this.states[_this.keys[4]]=true}}(this));return btn4.onInputUp.add(function(_this){return function(){_this.states[_this.keys[4]]=false}}(this))};return KeyPoll}();Sound=function(){Sound.volume=.5;Sound.enabled=true;Sound.FACTOR=2;Sound.preload=function(src){var audio;audio=new window.Audio;audio.src=src;audio.volume=0;audio.play();return src};Sound.prototype.src="";Sound.prototype.audio=null;function Sound(){this.audio=new window.Audio;this.audio.src=this.src;this.audio.load()}Sound.prototype.loop=function(){return this};Sound.prototype.play=function(){if(Sound.enabled){this.audio.volume=Sound.volume;this.audio.play()}return this};Sound.prototype.pause=function(){this.audio.pause();return this};return Sound}();ExplodeAsteroid=function(){function ExplodeAsteroid(){}ExplodeAsteroid.prototype.src=Sound.preload("res/sounds/asteroid.wav");ExplodeAsteroid.prototype.play=function(){return ExplodeAsteroid.audio.play("",0,Sound.volume/Sound.FACTOR)};return ExplodeAsteroid}();ExplodeShip=function(){function ExplodeShip(){}ExplodeShip.prototype.src=Sound.preload("res/sounds/ship.wav");ExplodeShip.prototype.play=function(){return ExplodeShip.audio.play("",0,Sound.volume/Sound.FACTOR)};return ExplodeShip}();ShootGun=function(){function ShootGun(){}ShootGun.prototype.src=Sound.preload("res/sounds/shoot.wav");ShootGun.prototype.play=function(){return ShootGun.audio.play("",0,Sound.volume/Sound.FACTOR)};return ShootGun}();AsteroidView=function(){AsteroidView.prototype.graphics=null;Object.defineProperties(AsteroidView.prototype,{x:{get:function(){return this.graphics.x},set:function(x){return this.graphics.x=x}},y:{get:function(){return this.graphics.x},set:function(y){return this.graphics.y=y}},rotation:{get:function(){return this.graphics.rotation},set:function(rotation){return this.graphics.rotation=rotation}}});function AsteroidView(parent,radius){var angle,game,length,posX,posY,rnd;game=parent.game;rnd=parent.rnd;this.graphics=game.add.graphics(0,0);this.graphics.clear();angle=0;this.graphics.beginFill(16777215);this.graphics.moveTo(radius,0);while(angle<Math.PI*2){length=(.75+rnd.nextDouble()*.25)*radius;posX=Math.cos(angle)*length;posY=Math.sin(angle)*length;this.graphics.lineTo(posX,posY);angle+=rnd.nextDouble()*.5}this.graphics.moveTo(radius,0);this.graphics.endFill()}AsteroidView.prototype.dispose=function(){return this.graphics.destroy()};return AsteroidView}();AsteroidDeathView=function(){AsteroidDeathView.prototype.dots=null;AsteroidDeathView.prototype.x=0;AsteroidDeathView.prototype.y=0;AsteroidDeathView.prototype.rotation=0;AsteroidDeathView.prototype.stage=null;AsteroidDeathView.prototype.first=true;function AsteroidDeathView(parent,radius){this.animate=__bind(this.animate,this);var dot,i,_i;this.dots=[];for(i=_i=0;_i<8;i=++_i){dot=new Dot(parent.game,parent.rnd,radius);this.dots.push(dot)}}AsteroidDeathView.prototype.animate=function(time){var dot,_i,_j,_len,_len1,_ref,_ref1,_results;if(this.first){this.first=false;_ref=this.dots;for(_i=0,_len=_ref.length;_i<_len;_i++){dot=_ref[_i];dot.graphics.x=this.x;dot.graphics.y=this.y}}_ref1=this.dots;_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){dot=_ref1[_j];dot.graphics.x+=dot.velocity.x*time;_results.push(dot.graphics.y+=dot.velocity.y*time)}return _results};AsteroidDeathView.prototype.dispose=function(){var dot,_i,_len,_ref,_results;_ref=this.dots;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){dot=_ref[_i];_results.push(dot.graphics.destroy())}return _results};return AsteroidDeathView}();Dot=function(){Dot.prototype.velocity=null;Dot.prototype.graphics=null;Dot.prototype.x=0;Dot.prototype.y=0;function Dot(game,rnd,maxDistance){var angle,distance,speed;this.graphics=game.add.graphics(0,0);this.graphics.beginFill(16777215);this.graphics.drawCircle(0,0,1);this.graphics.endFill();angle=rnd.nextDouble()*2*Math.PI;distance=rnd.nextDouble()*maxDistance;this.graphics.x=Math.cos(angle)*distance;this.graphics.y=Math.sin(angle)*distance;speed=rnd.nextDouble()*10+10;this.velocity=new Point(Math.cos(angle)*speed,Math.sin(angle)*speed)}return Dot}();BulletView=function(){BulletView.prototype.graphics=null;Object.defineProperties(BulletView.prototype,{x:{get:function(){return this.graphics.x},set:function(x){return this.graphics.x=x}},y:{get:function(){return this.graphics.x},set:function(y){return this.graphics.y=y}},rotation:{get:function(){return this.graphics.rotation},set:function(rotation){return this.graphics.rotation=rotation}}});function BulletView(game){this.graphics=game.add.graphics(0,0);this.graphics.beginFill(16777215);this.graphics.drawCircle(0,0,2);this.graphics.endFill()}BulletView.prototype.dispose=function(){return this.graphics.destroy()};return BulletView}();HudView=function(){HudView.prototype.graphics=null;HudView.prototype.score=null;HudView.prototype.lives=null;HudView.prototype.x=0;HudView.prototype.y=0;HudView.prototype.rotation=0;function HudView(game,stage){this.setScore=__bind(this.setScore,this);this.setLives=__bind(this.setLives,this);this.graphics=game.add.graphics(0,100);this.graphics.beginFill(12632256);this.graphics.drawRect(0,0,30,40);this.graphics.endFill();this.graphics.alpha=.5;this.score=game.add.text(window.innerWidth-130,20,"",{font:"bold 18px opendyslexic",fill:"white"});this.setScore(0);this.setLives(3)}HudView.prototype.dispose=function(){this.graphics.destroy();return this.score.destroy()};HudView.prototype.setLives=function(lives){var c,i,_i;this.graphics.clear();this.graphics.beginFill(12632256);this.graphics.drawRect(0,0,30,40);this.graphics.endFill();this.graphics.beginFill(0);for(i=_i=0;0<=lives?_i<lives:_i>lives;i=0<=lives?++_i:--_i){c=i*10+10;
this.graphics.moveTo(10+10,c);this.graphics.lineTo(-7+10,7+c);this.graphics.lineTo(-4+10,c);this.graphics.lineTo(-7+10,-7+c);this.graphics.lineTo(10+10,c)}this.graphics.endFill();this.graphics.alpha=.5};HudView.prototype.setScore=function(score){this.score.setText("SCORE: "+score)};return HudView}();SpaceshipDeathView=function(){SpaceshipDeathView.prototype.shape1=null;SpaceshipDeathView.prototype.shape2=null;SpaceshipDeathView.prototype.vel1=null;SpaceshipDeathView.prototype.vel2=null;SpaceshipDeathView.prototype.rot1=null;SpaceshipDeathView.prototype.rot2=null;SpaceshipDeathView.prototype.first=true;SpaceshipDeathView.prototype.x=0;SpaceshipDeathView.prototype.y=0;SpaceshipDeathView.prototype.rotation=0;SpaceshipDeathView.prototype.check=true;function SpaceshipDeathView(parent){this.animate=__bind(this.animate,this);var game,rnd;game=parent.game;rnd=parent.rnd;this.shape1=game.add.graphics(0,0);this.shape1.clear();this.shape1.beginFill(16777215);this.shape1.moveTo(10,0);this.shape1.lineTo(-7,7);this.shape1.lineTo(-4,0);this.shape1.lineTo(10,0);this.shape1.endFill();this.shape2=game.add.graphics(0,0);this.shape2.clear();this.shape2.beginFill(16777215);this.shape2.moveTo(10,0);this.shape2.lineTo(-7,-7);this.shape2.lineTo(-4,0);this.shape2.lineTo(10,0);this.shape2.endFill();this.vel1=new Point(rnd.nextDouble()*10-5,rnd.nextDouble()*10+10);this.vel2=new Point(rnd.nextDouble()*10-5,-(rnd.nextDouble()*10+10));this.rot1=rnd.nextDouble()*300-150;this.rot2=rnd.nextDouble()*300-150}SpaceshipDeathView.prototype.dispose=function(){this.shape1.destroy();return this.shape2.destroy()};SpaceshipDeathView.prototype.animate=function(time){if(this.first){this.first=false;this.shape1.x=this.shape2.x=this.x;this.shape1.y=this.shape2.y=this.y;this.shape1.rotation=this.shape2.rotation=this.rotation}this.shape1.x+=this.vel1.x*time;this.shape1.y+=this.vel1.y*time;this.shape1.rotation+=this.rot1*time;this.shape2.x+=this.vel2.x*time;this.shape2.y+=this.vel2.y*time;this.shape2.rotation+=this.rot2*time};return SpaceshipDeathView}();SpaceshipView=function(){SpaceshipView.prototype.graphics=null;Object.defineProperties(SpaceshipView.prototype,{x:{get:function(){return this.graphics.x},set:function(x){return this.graphics.x=x}},y:{get:function(){return this.graphics.x},set:function(y){return this.graphics.y=y}},rotation:{get:function(){return this.graphics.rotation},set:function(rotation){return this.graphics.rotation=rotation}}});function SpaceshipView(game){this.graphics=game.add.graphics(0,0);this.draw(16777215)}SpaceshipView.prototype.dispose=function(){return this.graphics.destroy()};SpaceshipView.prototype.draw=function(color){this.graphics.clear();this.graphics.beginFill(color);this.graphics.moveTo(10,0);this.graphics.lineTo(-7,7);this.graphics.lineTo(-4,0);this.graphics.lineTo(-7,-7);this.graphics.lineTo(10,0);return this.graphics.endFill()};return SpaceshipView}();WaitForStartView=function(){var Signal0;WaitForStartView.count=0;Signal0=ash.signals.Signal0;WaitForStartView.prototype.x=0;WaitForStartView.prototype.y=0;WaitForStartView.prototype.rotation=0;WaitForStartView.prototype.text1=null;WaitForStartView.prototype.text2=null;WaitForStartView.prototype.text3=null;WaitForStartView.prototype.click=null;function WaitForStartView(game,parent){var x,y;this.game=game;this.parent=parent;this.start1=__bind(this.start1,this);this.start=__bind(this.start,this);this.click=new Signal0;x=Math.floor(window.innerWidth/2);y=window.innerHeight-40;if(WaitForStartView.count++===1){this.text1=this.game.add.text(x,85,"GAME OVER",{font:"bold 60px opendyslexic",fill:"white",stroke:"black",strokeThickness:30})}else{this.text1=this.game.add.text(x,85,"ASTEROIDS",{font:"bold 60px opendyslexic",fill:"white",stroke:"black",strokeThickness:30})}if(this.game.device.touch){this.text2=this.game.add.text(x,175,"TOUCH TO START",{font:"bold 12px opendyslexic",fill:"white"})}else{this.text2=this.game.add.text(x,175,"CLICK TO START",{font:"bold 12px opendyslexic",fill:"white"})}this.text1.anchor.x=.5;this.text2.anchor.x=.5;if(this.game.device.desktop){this.text3=this.game.add.text(x,y,"Z ~ Fire  |  SPACE ~ Warp  |  Left/Right ~ Turn  |  Up ~ Accelerate",{font:"bold 10px opendyslexic",fill:"white"});this.text3.anchor.x=.5}this.text1.inputEnabled=true;this.text2.inputEnabled=true;this.text1.events.onInputDown.add(this.start);this.text2.events.onInputDown.add(this.start)}WaitForStartView.prototype.start=function(data){var fader;this.faderBitmap=this.game.make.bitmapData(this.game.width,this.game.height);this.faderBitmap.rect(0,0,this.game.width,this.game.height,"rgb(0,0,0)");this.faderSprite=this.game.add.sprite(0,0,this.faderBitmap);this.faderSprite.alpha=0;fader=this.game.add.tween(this.faderSprite);fader.to({alpha:1},1e3);fader.onComplete.add(this.start1);return fader.start()};WaitForStartView.prototype.start1=function(){var fader,_ref,_ref1;this.text1.destroy();this.text2.destroy();if((_ref=this.text3)!=null){_ref.destroy()}fader=this.game.add.tween(this.faderSprite);fader.to({alpha:0},1e3);fader.onComplete.add(function(_this){return function(){return _this.click.dispatch()}}(this));fader.start();return(_ref1=this.parent.controller)!=null?_ref1.start():void 0};return WaitForStartView}();Components=function(){var Animation,Asteroid,Audio,Bullet,Collision,DeathThroes,Display,GameState,Gun,GunControls,Hud,MotionControls,Physics,Position,Spaceship,WaitForStart;return{Animation:Animation=function(){Animation.prototype.animation=null;function Animation(animation){this.animation=animation}return Animation}(),Asteroid:Asteroid=function(){Asteroid.prototype.fsm=null;function Asteroid(fsm){this.fsm=fsm}return Asteroid}(),Audio:Audio=function(){Audio.prototype.toPlay=null;function Audio(){this.toPlay=[]}Audio.prototype.play=function(sound){return this.toPlay.push(sound)};return Audio}(),Bullet:Bullet=function(){Bullet.prototype.lifeRemaining=0;function Bullet(lifeRemaining){this.lifeRemaining=lifeRemaining}return Bullet}(),Collision:Collision=function(){Collision.prototype.radius=0;function Collision(radius){this.radius=radius}return Collision}(),DeathThroes:DeathThroes=function(){DeathThroes.prototype.countdown=0;DeathThroes.prototype.body=null;function DeathThroes(duration){this.countdown=duration}return DeathThroes}(),Display:Display=function(){Display.prototype.graphic=0;function Display(graphic){this.graphic=graphic}return Display}(),GameState:GameState=function(){function GameState(){}GameState.prototype.lives=3;GameState.prototype.level=0;GameState.prototype.hits=0;GameState.prototype.playing=false;GameState.prototype.setForStart=function(){this.lives=3;this.level=0;this.hits=0;this.playing=true};return GameState}(),Gun:Gun=function(){Gun.prototype.shooting=false;Gun.prototype.offsetFromParent=null;Gun.prototype.timeSinceLastShot=0;Gun.prototype.offsetFromParent=null;function Gun(offsetX,offsetY,minimumShotInterval,bulletLifetime){this.minimumShotInterval=minimumShotInterval;this.bulletLifetime=bulletLifetime;this.shooting=false;this.offsetFromParent=null;this.timeSinceLastShot=0;this.offsetFromParent=new Point(offsetX,offsetY)}return Gun}(),GunControls:GunControls=function(){GunControls.prototype.trigger=0;function GunControls(trigger){this.trigger=trigger}return GunControls}(),Hud:Hud=function(){Hud.prototype.view=null;Hud.prototype.leaderboard=false;function Hud(view){this.view=view}return Hud}(),MotionControls:MotionControls=function(){MotionControls.prototype.left=0;MotionControls.prototype.right=0;MotionControls.prototype.accelerate=0;MotionControls.prototype.warp=0;MotionControls.prototype.accelerationRate=0;MotionControls.prototype.rotationRate=0;function MotionControls(left,right,accelerate,warp,accelerationRate,rotationRate){this.left=left;this.right=right;this.accelerate=accelerate;this.warp=warp;this.accelerationRate=accelerationRate;this.rotationRate=rotationRate}return MotionControls}(),Physics:Physics=function(){Physics.prototype.body=null;Physics.prototype.previousX=0;Physics.prototype.previousY=0;Physics.prototype.previousAngle=0;function Physics(body){this.body=body}return Physics}(),Position:Position=function(){Position.prototype.position=null;Position.prototype.rotation=0;function Position(x,y,rotation){this.rotation=rotation;this.position=new Point(x,y)}return Position}(),Spaceship:Spaceship=function(){Spaceship.prototype.fsm=null;function Spaceship(fsm){this.fsm=fsm}return Spaceship}(),WaitForStart:WaitForStart=function(){WaitForStart.prototype.waitForStart=null;WaitForStart.prototype.startGame=false;function WaitForStart(waitForStart){this.waitForStart=waitForStart;this.setStartGame=__bind(this.setStartGame,this);this.waitForStart.click.add(this.setStartGame)}WaitForStart.prototype.setStartGame=function(){this.startGame=true};return WaitForStart}()}}();Nodes=function(){var AnimationNode,AsteroidCollisionNode,AudioNode,BulletAgeNode,BulletCollisionNode,DeathThroesNode,GameNode,GunControlNode,HudNode,MovementNode,PhysicsControlNode,PhysicsNode,RenderNode,SpaceshipNode,WaitForStartNode;return{AnimationNode:AnimationNode=function(){function AnimationNode(){}AnimationNode.prototype.animation=Components.Animation;return AnimationNode}(),AsteroidCollisionNode:AsteroidCollisionNode=function(){function AsteroidCollisionNode(){}AsteroidCollisionNode.prototype.asteroid=Components.Asteroid;AsteroidCollisionNode.prototype.position=Components.Position;AsteroidCollisionNode.prototype.collision=Components.Collision;AsteroidCollisionNode.prototype.audio=Components.Audio;AsteroidCollisionNode.prototype.physics=Components.Physics;return AsteroidCollisionNode}(),AudioNode:AudioNode=function(){function AudioNode(){}AudioNode.prototype.audio=Components.Audio;return AudioNode}(),BulletAgeNode:BulletAgeNode=function(){function BulletAgeNode(){}BulletAgeNode.prototype.bullet=Components.Bullet;BulletAgeNode.prototype.physics=Components.Physics;BulletAgeNode.prototype.display=Components.Display;return BulletAgeNode}(),BulletCollisionNode:BulletCollisionNode=function(){function BulletCollisionNode(){}BulletCollisionNode.prototype.bullet=Components.Bullet;BulletCollisionNode.prototype.position=Components.Position;BulletCollisionNode.prototype.physics=Components.Physics;return BulletCollisionNode}(),DeathThroesNode:DeathThroesNode=function(){function DeathThroesNode(){}DeathThroesNode.prototype.dead=Components.DeathThroes;DeathThroesNode.prototype.display=Components.Display;return DeathThroesNode}(),GameNode:GameNode=function(){function GameNode(){}GameNode.prototype.state=Components.GameState;return GameNode}(),GunControlNode:GunControlNode=function(){function GunControlNode(){}GunControlNode.prototype.audio=Components.Audio;GunControlNode.prototype.control=Components.GunControls;GunControlNode.prototype.gun=Components.Gun;GunControlNode.prototype.position=Components.Position;return GunControlNode}(),HudNode:HudNode=function(){function HudNode(){}HudNode.prototype.state=Components.GameState;HudNode.prototype.hud=Components.Hud;return HudNode}(),MovementNode:MovementNode=function(){function MovementNode(){}MovementNode.prototype.position=Components.Position;return MovementNode}(),PhysicsControlNode:PhysicsControlNode=function(){function PhysicsControlNode(){}PhysicsControlNode.prototype.control=Components.MotionControls;PhysicsControlNode.prototype.physics=Components.Physics;PhysicsControlNode.prototype.display=Components.Display;return PhysicsControlNode}(),PhysicsNode:PhysicsNode=function(){function PhysicsNode(){}PhysicsNode.prototype.position=Components.Position;PhysicsNode.prototype.physics=Components.Physics;return PhysicsNode}(),RenderNode:RenderNode=function(){function RenderNode(){}RenderNode.prototype.position=Components.Position;RenderNode.prototype.display=Components.Display;return RenderNode}(),SpaceshipNode:SpaceshipNode=function(){function SpaceshipNode(){}SpaceshipNode.prototype.spaceship=Components.Spaceship;SpaceshipNode.prototype.position=Components.Position;return SpaceshipNode}(),WaitForStartNode:WaitForStartNode=function(){function WaitForStartNode(){}WaitForStartNode.prototype.wait=Components.WaitForStart;return WaitForStartNode}()}}();FixedPhysicsSystem=function(_super){var POSITION_ITERATIONS,TIME_STEP,VELOCITY_ITERATIONS,b2Body,b2Vec2;__extends(FixedPhysicsSystem,_super);b2Body=Box2D.Dynamics.b2Body;b2Vec2=Box2D.Common.Math.b2Vec2;TIME_STEP=1/60;VELOCITY_ITERATIONS=8;POSITION_ITERATIONS=3;FixedPhysicsSystem.prototype.handle=0;FixedPhysicsSystem.prototype.config=null;FixedPhysicsSystem.prototype.world=null;FixedPhysicsSystem.prototype.entities=null;FixedPhysicsSystem.prototype.nodes=null;FixedPhysicsSystem.prototype.enabled=true;FixedPhysicsSystem.prototype.game=null;FixedPhysicsSystem.prototype.width=0;FixedPhysicsSystem.prototype.height=0;FixedPhysicsSystem.deadPool=[];function FixedPhysicsSystem(parent){this.updateNode=__bind(this.updateNode,this);this.update=__bind(this.update,this);this.process=__bind(this.process,this);this.world=parent.world;this.game=parent.game;this.width=parent.width;this.height=parent.height;this.nodes=parent.ash.nodes}FixedPhysicsSystem.prototype.addToEngine=function(engine){this.nodes=engine.getNodeList(this.nodes.PhysicsNode);this.handle=setInterval(this.process,TIME_STEP)};FixedPhysicsSystem.prototype.removeFromEngine=function(engine){if(this.handle!==0){clearInterval(this.handle)}this.handle=0;this.nodes=null};FixedPhysicsSystem.prototype.process=function(){if(this.game.paused){return}if(!this.enabled){return}this.world.Step(TIME_STEP,VELOCITY_ITERATIONS,POSITION_ITERATIONS);this.world.ClearForces()};FixedPhysicsSystem.prototype.update=function(time){var body,node,ud;if(this.game.paused){return}if(!this.enabled){return}node=this.nodes.head;while(node){this.updateNode(node,time);node=node.next}while(body=FixedPhysicsSystem.deadPool.pop()){ud=body.GetUserData();if(ud.entity!=null){delete ud.entity}body.SetUserData(ud);this.world.DestroyBody(body)}};FixedPhysicsSystem.prototype.updateNode=function(node,time){var body,physics,position,x,x1,y,y1,_ref;position=node.position;physics=node.physics;body=physics.body;_ref=body.GetPosition(),x=_ref.x,y=_ref.y;x1=x>this.width?0:x<0?this.width:x;y1=y>this.height?0:y<0?this.height:y;if(x1!==x||y1!==y){body.SetPosition(new b2Vec2(x1,y1))}position.position.x=x1;position.position.y=y1;position.rotation=body.GetAngularVelocity()};return FixedPhysicsSystem}(ash.core.System);SmoothPhysicsSystem=function(_super){var FIXED_TIMESTEP,MAX_STEPS,b2Body,b2Vec2,positionIterations,velocityIterations;__extends(SmoothPhysicsSystem,_super);b2Body=Box2D.Dynamics.b2Body;b2Vec2=Box2D.Common.Math.b2Vec2;FIXED_TIMESTEP=1/60;MAX_STEPS=5;velocityIterations=8;positionIterations=1;SmoothPhysicsSystem.prototype.fixedTimestepAccumulator=0;SmoothPhysicsSystem.prototype.fixedTimestepAccumulatorRatio=0;SmoothPhysicsSystem.prototype.config=null;SmoothPhysicsSystem.prototype.world=null;SmoothPhysicsSystem.prototype.entities=null;SmoothPhysicsSystem.prototype.nodes=null;SmoothPhysicsSystem.prototype.enabled=true;SmoothPhysicsSystem.prototype.game=null;SmoothPhysicsSystem.prototype.width=0;SmoothPhysicsSystem.prototype.height=0;SmoothPhysicsSystem.deadPool=[];function SmoothPhysicsSystem(parent){this.smoothStates=__bind(this.smoothStates,this);this.resetSmoothStates=__bind(this.resetSmoothStates,this);this.update=__bind(this.update,this);this.width=parent.width;this.height=parent.height;this.world=parent.world;this.game=parent.game;this.nodes=parent.ash.nodes}SmoothPhysicsSystem.prototype.addToEngine=function(engine){this.nodes=engine.getNodeList(this.nodes.PhysicsNode)};SmoothPhysicsSystem.prototype.removeFromEngine=function(engine){this.nodes=null};SmoothPhysicsSystem.prototype.update=function(dt){var body,i,nSteps,nStepsClamped,ud;if(this.game.paused){return}if(!this.enabled){return}this.fixedTimestepAccumulator+=dt;nSteps=Math.floor(this.fixedTimestepAccumulator/FIXED_TIMESTEP);if(nSteps>0){this.fixedTimestepAccumulator-=nSteps*FIXED_TIMESTEP}this.fixedTimestepAccumulatorRatio=this.fixedTimestepAccumulator/FIXED_TIMESTEP;nStepsClamped=Math.min(nSteps,MAX_STEPS);i=0;while(i<nStepsClamped){this.resetSmoothStates();this.world.Step(dt,velocityIterations,positionIterations);i++}this.world.ClearForces();this.smoothStates();while(body=SmoothPhysicsSystem.deadPool.pop()){ud=body.GetUserData();if(ud.entity!=null){delete ud.entity}body.SetUserData(ud);this.world.DestroyBody(body)}};SmoothPhysicsSystem.prototype.resetSmoothStates=function(){var body,node,physics,position,x,x1,y,y1,_ref;node=this.nodes.head;while(node){position=node.position;physics=node.physics;body=physics.body;_ref=body.GetPosition(),x=_ref.x,y=_ref.y;position.position.x=physics.previousX=x;position.position.y=physics.previousY=y;position.rotation=physics.previousAngle=body.GetAngularVelocity();x1=x>this.width?0:x<0?this.width:x;y1=y>this.height?0:y<0?this.height:y;if(x1!==x||y1!==y){body.SetPosition(new b2Vec2(x1,y1))}node=node.next}};SmoothPhysicsSystem.prototype.smoothStates=function(){var body,node,oneMinusRatio,physics,position,x,x1,y,y1,_ref;oneMinusRatio=1-this.fixedTimestepAccumulatorRatio;node=this.nodes.head;while(node){position=node.position;physics=node.physics;body=physics.body;_ref=body.GetPosition(),x=_ref.x,y=_ref.y;position.position.x=this.fixedTimestepAccumulatorRatio*x+oneMinusRatio*physics.previousX;position.position.y=this.fixedTimestepAccumulatorRatio*y+oneMinusRatio*physics.previousY;position.rotation=body.GetAngularVelocity()*this.fixedTimestepAccumulatorRatio+oneMinusRatio*physics.previousAngle;x1=x>this.width?0:x<0?this.width:x;y1=y>this.height?0:y<0?this.height:y;if(x1!==x||y1!==y){body.SetPosition(new b2Vec2(x1,y1))}node=node.next}};return SmoothPhysicsSystem}(ash.core.System);AnimationSystem=function(_super){__extends(AnimationSystem,_super);function AnimationSystem(parent){this.updateNode=__bind(this.updateNode,this);AnimationSystem.__super__.constructor.call(this,parent.ash.nodes.AnimationNode,this.updateNode)}AnimationSystem.prototype.updateNode=function(node,time){node.animation.animation.animate(time)};return AnimationSystem}(ash.tools.ListIteratingSystem);AudioSystem=function(_super){__extends(AudioSystem,_super);function AudioSystem(parent){this.updateNode=__bind(this.updateNode,this);AudioSystem.__super__.constructor.call(this,parent.ash.nodes.AudioNode,this.updateNode)}AudioSystem.prototype.updateNode=function(node,time){var each,sound,type,_ref;_ref=node.audio.toPlay;for(each in _ref){type=_ref[each];sound=new type;sound.play(0,1)}node.audio.toPlay=[]};return AudioSystem}(ash.tools.ListIteratingSystem);BulletAgeSystem=function(_super){__extends(BulletAgeSystem,_super);BulletAgeSystem.prototype.entities=null;BulletAgeSystem.prototype.PhysicsSystem=null;function BulletAgeSystem(parent,PhysicsSystem){this.PhysicsSystem=PhysicsSystem;this.updateNode=__bind(this.updateNode,this);BulletAgeSystem.__super__.constructor.call(this,parent.ash.nodes.BulletAgeNode,this.updateNode);this.entities=parent.entities}BulletAgeSystem.prototype.updateNode=function(node,time){var bullet;bullet=node.bullet;bullet.lifeRemaining-=time;if(bullet.lifeRemaining<=0){node.display.graphic.dispose();this.PhysicsSystem.deadPool.push(node.physics.body);this.entities.destroyEntity(node.entity)}};return BulletAgeSystem}(ash.tools.ListIteratingSystem);CollisionSystem=function(_super){var Asteroid,AsteroidHitShip,Audio,BulletHitAsteroid,Collision,DeathThroes,Display,Physics,Position,Spaceship,b2ContactListener;__extends(CollisionSystem,_super);Asteroid=Components.Asteroid;Audio=Components.Audio;Collision=Components.Collision;DeathThroes=Components.DeathThroes;Display=Components.Display;Physics=Components.Physics;Position=Components.Position;Spaceship=Components.Spaceship;b2ContactListener=Box2D.Dynamics.b2ContactListener;BulletHitAsteroid=1;AsteroidHitShip=2;CollisionSystem.prototype.world=null;CollisionSystem.prototype.entities=null;CollisionSystem.prototype.games=null;CollisionSystem.prototype.rnd=null;CollisionSystem.prototype.collisions=null;CollisionSystem.prototype.PhysicsSystem=null;function CollisionSystem(parent,PhysicsSystem){this.PhysicsSystem=PhysicsSystem;this.PostSolve=__bind(this.PostSolve,this);this.PreSolve=__bind(this.PreSolve,this);this.EndContact=__bind(this.EndContact,this);this.BeginContact=__bind(this.BeginContact,this);this.update=__bind(this.update,this);this.world=parent.world;this.entities=parent.entities;this.rnd=parent.rnd;this.components=parent.ash.components;this.collisions=[];this.world.SetContactListener(this)}CollisionSystem.prototype.update=function(time){var a,b,body,position,radius,type,_ref;while(this.collisions.length){_ref=this.collisions.pop(),type=_ref.type,a=_ref.a,b=_ref.b;if(type===BulletHitAsteroid){if(a.get(Physics)!=null){this.entities.destroyEntity(a);a.get(Display).graphic.dispose();this.PhysicsSystem.deadPool.push(a.get(Physics).body)}if(b.get(Physics)!=null){radius=b.get(Collision).radius;position=b.get(Position).position;if(radius>10){this.entities.createAsteroid(radius-10,position.x+this.rnd.nextDouble()*10-5,position.y+this.rnd.nextDouble()*10-5);this.entities.createAsteroid(radius-10,position.x+this.rnd.nextDouble()*10-5,position.y+this.rnd.nextDouble()*10-5)}body=b.get(Physics).body;b.get(Display).graphic.dispose();b.get(Asteroid).fsm.changeState("destroyed");b.get(DeathThroes).body=body;b.get(Audio).play(ExplodeAsteroid);if(this.games.head){this.games.head.state.hits++}}}else if(type===AsteroidHitShip){if(b.get(Physics)!=null){body=b.get(Physics).body;b.get(Display).graphic.dispose();b.get(Spaceship).fsm.changeState("destroyed");b.get(DeathThroes).body=body;b.get(Audio).play(ExplodeShip);if(this.games.head){this.games.head.state.lives--}}}}};CollisionSystem.prototype.addToEngine=function(engine){this.games=engine.getNodeList(Nodes.GameNode)};CollisionSystem.prototype.removeFromEngine=function(engine){this.games=null};CollisionSystem.prototype.BeginContact=function(contact){var a,b;a=contact.GetFixtureA().GetBody().GetUserData();b=contact.GetFixtureB().GetBody().GetUserData();switch(a.type){case Entities.ASTEROID:switch(b.type){case Entities.BULLET:this.collisions.push({type:BulletHitAsteroid,a:b.entity,b:a.entity});break;case Entities.SPACESHIP:this.collisions.push({type:AsteroidHitShip,a:a.entity,b:b.entity})}break;case Entities.BULLET:if(b.type===Entities.ASTEROID){this.collisions.push({type:BulletHitAsteroid,a:a.entity,b:b.entity})}break;case Entities.SPACESHIP:if(b.type===Entities.ASTEROID){this.collisions.push({type:AsteroidHitShip,a:b.entity,b:a.entity})}}};CollisionSystem.prototype.EndContact=function(contact){};CollisionSystem.prototype.PreSolve=function(contact,oldManifold){};CollisionSystem.prototype.PostSolve=function(contact,impulse){};return CollisionSystem}(ash.core.System);DeathThroesSystem=function(_super){__extends(DeathThroesSystem,_super);DeathThroesSystem.prototype.entities=null;DeathThroesSystem.prototype.PhysicsSystem=null;function DeathThroesSystem(parent,PhysicsSystem){this.PhysicsSystem=PhysicsSystem;this.updateNode=__bind(this.updateNode,this);DeathThroesSystem.__super__.constructor.call(this,parent.ash.nodes.DeathThroesNode,this.updateNode);this.entities=parent.entities}DeathThroesSystem.prototype.updateNode=function(node,time){var dead;dead=node.dead;dead.countdown-=time;if(dead.countdown<=0){this.entities.destroyEntity(node.entity);node.display.graphic.dispose();this.PhysicsSystem.deadPool.push(dead.body)}};return DeathThroesSystem}(ash.tools.ListIteratingSystem);GameManager=function(_super){__extends(GameManager,_super);GameManager.prototype.config=null;GameManager.prototype.entities=null;GameManager.prototype.rnd=null;GameManager.prototype.gameNodes=null;GameManager.prototype.spaceships=null;GameManager.prototype.asteroids=null;GameManager.prototype.bullets=null;GameManager.prototype.width=0;GameManager.prototype.height=0;function GameManager(parent){this.update=__bind(this.update,this);this.entities=parent.entities;this.rnd=parent.rnd;this.width=parent.width;this.height=parent.height;this.nodes=parent.ash.nodes}GameManager.prototype.addToEngine=function(engine){this.gameNodes=engine.getNodeList(this.nodes.GameNode);this.spaceships=engine.getNodeList(this.nodes.SpaceshipNode);this.asteroids=engine.getNodeList(this.nodes.AsteroidCollisionNode);this.bullets=engine.getNodeList(this.nodes.BulletCollisionNode)};GameManager.prototype.update=function(time){var asteroid,asteroidCount,clearToAddSpaceship,dd,i,mm,newSpaceshipPosition,node,position,spaceship,today,yyyy,yyyymmdd;node=this.gameNodes.head;if(node&&node.state.playing){if(this.spaceships.empty){if(node.state.lives>0){newSpaceshipPosition=new Point(this.width*.5,this.height*.5);clearToAddSpaceship=true;asteroid=this.asteroids.head;while(asteroid){if(Point.distance(asteroid.position.position,newSpaceshipPosition)<=asteroid.collision.radius+50){clearToAddSpaceship=false;break}asteroid=asteroid.next}if(clearToAddSpaceship){this.entities.createSpaceship()}}else{node.state.playing=false;today=new Date;mm=(today.getMonth()+1).toString();if(mm.length===1){mm="0"+mm}dd=today.getDate().toString();if(dd.length===1){dd="0"+dd}yyyy=today.getFullYear().toString();yyyymmdd=yyyy+mm+dd;if(0===Db.queryAll("leaderboard",{query:{date:yyyymmdd}}).length){Db.insert("leaderboard",{date:yyyymmdd,score:node.state.hits})}else{Db.update("leaderboard",{date:yyyymmdd},function(row){if(node.state.hits>row.score){row.score=node.state.hits}return row})}Db.commit();this.entities.createWaitForClick()}}if(this.asteroids.empty&&this.bullets.empty&&!this.spaceships.empty){spaceship=this.spaceships.head;node.state.level++;asteroidCount=2+node.state.level;i=0;while(i<asteroidCount){while(true){position=new Point(this.rnd.nextDouble()*this.width,this.rnd.nextDouble()*this.height);if(!(Point.distance(position,spaceship.position.position)<=80)){break}}this.entities.createAsteroid(30,position.x,position.y);++i}}}};GameManager.prototype.removeFromEngine=function(engine){this.gameNodes=null;this.spaceships=null;this.asteroids=null;this.bullets=null};return GameManager}(ash.core.System);GunControlSystem=function(_super){__extends(GunControlSystem,_super);GunControlSystem.prototype.keyPoll=null;GunControlSystem.prototype.entities=null;GunControlSystem.prototype.buttons=null;function GunControlSystem(parent){var _ref;this.parent=parent;this.updateNode=__bind(this.updateNode,this);GunControlSystem.__super__.constructor.call(this,this.parent.ash.nodes.GunControlNode,this.updateNode);this.keyPoll=this.parent.keyPoll;this.entities=this.parent.entities;this.buttons=(_ref=this.parent.controller)!=null?_ref.buttons:void 0}GunControlSystem.prototype.updateNode=function(node,time){var control,gun,position,_ref;control=node.control;position=node.position;gun=node.gun;gun.shooting=this.keyPoll.isDown(control.trigger)||((_ref=this.buttons)!=null?_ref.fire:void 0);gun.timeSinceLastShot+=time;if(gun.shooting&&gun.timeSinceLastShot>=gun.minimumShotInterval){this.entities.createUserBullet(gun,position);node.audio.play(ShootGun);gun.timeSinceLastShot=0}};return GunControlSystem}(ash.tools.ListIteratingSystem);HudSystem=function(_super){__extends(HudSystem,_super);function HudSystem(parent){this.updateNode=__bind(this.updateNode,this);HudSystem.__super__.constructor.call(this,parent.ash.nodes.HudNode,this.updateNode)}HudSystem.prototype.updateNode=function(node,time){node.hud.view.setLives(node.state.lives);node.hud.view.setScore(node.state.hits)};return HudSystem}(ash.tools.ListIteratingSystem);ShipControlSystem=function(_super){var IDTK,R,b2Vec2,colors,_ref;__extends(ShipControlSystem,_super);R=window.devicePixelRatio;IDTK=((_ref=window.ext)!=null?_ref.IDTK_SRV_BOX2D:void 0)!=null;b2Vec2=Box2D.Common.Math.b2Vec2;colors=[16711680,65280,255,16711935,65535,16776960];ShipControlSystem.prototype.keyPoll=null;ShipControlSystem.prototype.rnd=null;ShipControlSystem.prototype.warping=0;ShipControlSystem.prototype.kount=0;ShipControlSystem.prototype.width=0;ShipControlSystem.prototype.height=0;function ShipControlSystem(parent){this.updateNode=__bind(this.updateNode,this);ShipControlSystem.__super__.constructor.call(this,parent.ash.nodes.PhysicsControlNode,this.updateNode);this.keyPoll=parent.keyPoll;this.rnd=parent.rnd;this.width=parent.width;this.height=parent.height;this.game=parent.game;this.controller=parent.controller}ShipControlSystem.prototype.updateNode=function(node,time){var a1,angle,body,control,dpad,joystick,rotation,speed,v,x,y,_ref1,_ref2,_ref3,_ref4;control=node.control;body=node.physics.body;if(this.warping){this.warping--;x=this.rnd.nextInt(this.width);y=this.rnd.nextInt(this.height);body.SetPosition({x:x,y:y});if(this.warping===0){node.display.graphic.draw(16777215)}else{node.display.graphic.draw(colors[this.rnd.nextInt(6)])}return}if(this.keyPoll.isDown(control.warp)||((_ref1=this.controller)!=null?(_ref2=_ref1.buttons)!=null?_ref2.warp:void 0:void 0)){this.controller.warp=false;this.warping=this.rnd.nextInt(30)+30;return}dpad=(_ref3=this.controller)!=null?_ref3.dpad:void 0;if(dpad!=null){if(dpad.left){rotation=body.GetAngularVelocity();body.SetAngularVelocity(rotation-control.rotationRate*time)}if(dpad.right){rotation=rotation||body.GetAngularVelocity();body.SetAngularVelocity(rotation+control.rotationRate*time)}if(dpad.up){rotation=rotation||body.GetAngularVelocity();v=body.GetLinearVelocity();v.x+=Math.cos(rotation)*control.accelerationRate*time*R;v.y+=Math.sin(rotation)*control.accelerationRate*time*R;if(!IDTK){body.SetAwake(true)}body.SetLinearVelocity(v)}}joystick=(_ref4=this.controller)!=null?_ref4.joystick:void 0;if(joystick!=null){angle=Math.atan2(joystick.normalizedY,joystick.normalizedX)/Math.PI*180;a1=Math.abs(angle);rotation=body.GetAngularVelocity();if(a1>135&&a1<179){body.SetAngularVelocity(rotation-control.rotationRate*time)}else if(a1>1&&a1<45){body.SetAngularVelocity(rotation+control.rotationRate*time)}else if(angle>45&&angle<135){speed=127/Math.sqrt(joystick.normalizedX*joystick.normalizedX+joystick.normalizedY*joystick.normalizedY);v=body.GetLinearVelocity();v.x+=Math.cos(rotation)*speed*time*R;v.y+=Math.sin(rotation)*speed*time*R;if(!IDTK){body.SetAwake(true)}body.SetLinearVelocity(v)}}if(this.keyPoll.isDown(control.left)){rotation=body.GetAngularVelocity();body.SetAngularVelocity(rotation-control.rotationRate*time)}if(this.keyPoll.isDown(control.right)){rotation=rotation||body.GetAngularVelocity();body.SetAngularVelocity(rotation+control.rotationRate*time)}if(this.keyPoll.isDown(control.accelerate)){rotation=rotation||body.GetAngularVelocity();v=body.GetLinearVelocity();v.x+=Math.cos(rotation)*control.accelerationRate*time*R;v.y+=Math.sin(rotation)*control.accelerationRate*time*R;if(!IDTK){body.SetAwake(true)}body.SetLinearVelocity(v)}};return ShipControlSystem}(ash.tools.ListIteratingSystem);RenderSystem=function(_super){__extends(RenderSystem,_super);RenderSystem.prototype.stage=null;RenderSystem.prototype.renderer=null;RenderSystem.prototype.nodes=null;function RenderSystem(parent){this.update=__bind(this.update,this);this.nodes=parent.ash.nodes}RenderSystem.prototype.addToEngine=function(engine){var node;this.nodes=engine.getNodeList(this.nodes.RenderNode);node=this.nodes.head;while(node){this.addToDisplay(node);node=node.next}};RenderSystem.prototype.addToDisplay=function(node){};RenderSystem.prototype.removeFromDisplay=function(node){};RenderSystem.prototype.removeFromEngine=function(engine){this.nodes=null};RenderSystem.prototype.update=function(time){var display,graphic,node,position;node=this.nodes.head;while(node){display=node.display;graphic=display.graphic;position=node.position;graphic.x=position.position.x;graphic.y=position.position.y;graphic.rotation=position.rotation;node=node.next}};return RenderSystem}(ash.core.System);SystemPriorities=function(){function SystemPriorities(){}SystemPriorities.preUpdate=1;SystemPriorities.update=2;SystemPriorities.move=3;SystemPriorities.resolveCollisions=4;SystemPriorities.stateMachines=5;SystemPriorities.render=6;SystemPriorities.animate=7;return SystemPriorities}();
WaitForStartSystem=function(_super){__extends(WaitForStartSystem,_super);WaitForStartSystem.prototype.engine=null;WaitForStartSystem.prototype.entities=null;WaitForStartSystem.prototype.gameNodes=null;WaitForStartSystem.prototype.waitNodes=null;WaitForStartSystem.prototype.asteroids=null;function WaitForStartSystem(parent){this.update=__bind(this.update,this);this.entities=parent.entities}WaitForStartSystem.prototype.addToEngine=function(engine){this.ash=engine;this.waitNodes=engine.getNodeList(Nodes.WaitForStartNode);this.gameNodes=engine.getNodeList(Nodes.GameNode);this.asteroids=engine.getNodeList(Nodes.AsteroidCollisionNode)};WaitForStartSystem.prototype.removeFromEngine=function(engine){this.waitNodes=null;this.gameNodes=null;this.asteroids=null};WaitForStartSystem.prototype.update=function(time){var asteroid,game,graphic,node;node=this.waitNodes.head;game=this.gameNodes.head;if(node&&node.wait.startGame&&game){asteroid=this.asteroids.head;while(asteroid){graphic=asteroid.entity.get(Display).graphic;this.entities.destroyEntity(asteroid.entity);graphic.dispose();asteroid=asteroid.next}game.state.setForStart();node.wait.startGame=false;this.ash.removeEntity(node.entity)}};return WaitForStartSystem}(ash.core.System);Entities=function(){var Animation,Asteroid,Audio,Bullet,Collision,DeathThroes,Display,Entity,EntityStateMachine,GameState,Gun,GunControls,Hud,MotionControls,Physics,Position,Spaceship,WaitForStart,b2Body,b2BodyDef,b2CircleShape,b2FixtureDef,b2PolygonShape,b2Vec2,get;Animation=Components.Animation;Asteroid=Components.Asteroid;Audio=Components.Audio;Bullet=Components.Bullet;Collision=Components.Collision;DeathThroes=Components.DeathThroes;Display=Components.Display;GameState=Components.GameState;Gun=Components.Gun;GunControls=Components.GunControls;Hud=Components.Hud;MotionControls=Components.MotionControls;Physics=Components.Physics;Position=Components.Position;Spaceship=Components.Spaceship;WaitForStart=Components.WaitForStart;Entity=ash.core.Entity;EntityStateMachine=ash.fsm.EntityStateMachine;Entities.ASTEROID=1;Entities.SPACESHIP=2;Entities.BULLET=3;Entities.prototype.LEFT=KeyPoll.KEY_LEFT;Entities.prototype.RIGHT=KeyPoll.KEY_RIGHT;Entities.prototype.THRUST=KeyPoll.KEY_UP;Entities.prototype.FIRE=KeyPoll.KEY_Z;Entities.prototype.WARP=KeyPoll.KEY_SPACE;get=function(prop){return parseFloat(asteroids.get(prop))};b2Body=Box2D.Dynamics.b2Body;b2BodyDef=Box2D.Dynamics.b2BodyDef;b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;b2FixtureDef=Box2D.Dynamics.b2FixtureDef;b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;b2Vec2=Box2D.Common.Math.b2Vec2;Entities.prototype.game=null;Entities.prototype.ash=null;Entities.prototype.world=null;Entities.prototype.waitEntity=null;Entities.prototype.rnd=null;Entities.prototype.bulletId=0;Entities.prototype.asteroidId=0;Entities.prototype.spaceshipId=0;function Entities(parent){this.parent=parent;this.createUserBullet=__bind(this.createUserBullet,this);this.createSpaceship=__bind(this.createSpaceship,this);this.game=this.parent.game;this.ash=this.parent.ash;this.world=this.parent.world;this.rnd=this.parent.rnd}Entities.prototype.destroyEntity=function(entity){this.ash.removeEntity(entity)};Entities.prototype.createGame=function(){var gameEntity,hud;hud=new HudView(this.game);gameEntity=new Entity("game").add(new GameState).add(new Hud(hud)).add(new Display(hud)).add(new Position(0,0,0,0));this.ash.addEntity(gameEntity);return gameEntity};Entities.prototype.createWaitForClick=function(){var waitView;waitView=new WaitForStartView(this.game,this.parent);this.waitEntity=new Entity("wait").add(new WaitForStart(waitView)).add(new Display(waitView)).add(new Position(0,0,0,0));this.waitEntity.get(WaitForStart).startGame=false;this.ash.addEntity(this.waitEntity);return this.waitEntity};Entities.prototype.createAsteroid=function(radius,x,y){var asteroid,body,bodyDef,deathView,fixDef,fsm,liveView,v1,v2;bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=true;bodyDef.position.x=x;bodyDef.position.y=y;v1=(this.rnd.nextDouble()-.5)*get("asteroidLinearVelocity")*(50-radius);v2=(this.rnd.nextDouble()-.5)*get("asteroidLinearVelocity")*(50-radius);bodyDef.linearVelocity.Set(v1,v2);bodyDef.angularVelocity=this.rnd.nextDouble()*get("asteroidAngularVelocity")-1;bodyDef.linearDamping=get("asteroidDamping");fixDef=new b2FixtureDef;fixDef.density=get("asteroidDensity");fixDef.friction=get("asteroidFriction");fixDef.restitution=get("asteroidRestitution");fixDef.shape=new b2CircleShape(radius);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);asteroid=new Entity;fsm=new EntityStateMachine(asteroid);liveView=new AsteroidView(this.parent,radius);fsm.createState("alive").add(Physics).withInstance(new Physics(body)).add(Collision).withInstance(new Collision(radius)).add(Display).withInstance(new Display(liveView));deathView=new AsteroidDeathView(this.parent,radius);fsm.createState("destroyed").add(DeathThroes).withInstance(new DeathThroes(3)).add(Display).withInstance(new Display(deathView)).add(Animation).withInstance(new Animation(deathView));asteroid.add(new Asteroid(fsm)).add(new Position(x,y,0)).add(new Audio);body.SetUserData({type:Entities.ASTEROID,entity:asteroid});fsm.changeState("alive");this.ash.addEntity(asteroid);return asteroid};Entities.prototype.createSpaceship=function(){var body,bodyDef,deathView,fixDef,fsm,liveView,spaceship,x,y;x=this.rnd.nextInt(this.parent.width);y=this.rnd.nextInt(this.parent.height);bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=false;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set(0,0);bodyDef.angularVelocity=0;bodyDef.linearDamping=get("spaceshipDamping");fixDef=new b2FixtureDef;fixDef.density=get("spaceshipDensity");fixDef.friction=get("spaceshipFriction");fixDef.restitution=get("spaceshipRestitution");fixDef.shape=new b2PolygonShape;fixDef.shape.SetAsArray([new b2Vec2(.45,0),new b2Vec2(-.25,.25),new b2Vec2(-.25,-.25)],3);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);spaceship=new Entity;fsm=new EntityStateMachine(spaceship);liveView=new SpaceshipView(this.game);fsm.createState("playing").add(Physics).withInstance(new Physics(body)).add(MotionControls).withInstance(new MotionControls(this.LEFT,this.RIGHT,this.THRUST,this.WARP,100,3)).add(Gun).withInstance(new Gun(8,0,.3,2)).add(GunControls).withInstance(new GunControls(this.FIRE)).add(Collision).withInstance(new Collision(9)).add(Display).withInstance(new Display(liveView));deathView=new SpaceshipDeathView(this.parent);fsm.createState("destroyed").add(DeathThroes).withInstance(new DeathThroes(5)).add(Display).withInstance(new Display(deathView)).add(Animation).withInstance(new Animation(deathView));spaceship.add(new Spaceship(fsm)).add(new Position(x,y,0)).add(new Audio);body.SetUserData({type:Entities.SPACESHIP,entity:spaceship});fsm.changeState("playing");this.ash.addEntity(spaceship);console.log(spaceship);return spaceship};Entities.prototype.createUserBullet=function(gun,parentPosition){var body,bodyDef,bullet,bulletView,cos,fixDef,sin,x,y;cos=Math.cos(parentPosition.rotation);sin=Math.sin(parentPosition.rotation);x=cos*gun.offsetFromParent.x-sin*gun.offsetFromParent.y+parentPosition.position.x;y=sin*gun.offsetFromParent.x+cos*gun.offsetFromParent.y+parentPosition.position.y;bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=true;bodyDef.bullet=true;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set(cos*get("bulletLinearVelocity"),sin*get("bulletLinearVelocity"));bodyDef.angularVelocity=0;bodyDef.linearDamping=get("bulletDamping");fixDef=new b2FixtureDef;fixDef.density=get("bulletDensity");fixDef.friction=get("bulletFriction");fixDef.restitution=get("bulletRestitution");fixDef.shape=new b2CircleShape(0);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);bulletView=new BulletView(this.game);bullet=(new Entity).add(new Bullet(gun.bulletLifetime)).add(new Position(x,y,0)).add(new Collision(0)).add(new Physics(body)).add(new Display(bulletView));body.SetUserData({type:Entities.BULLET,entity:bullet});this.ash.addEntity(bullet);return bullet};return Entities}();Asteroids=function(){var b2Vec2,b2World,ucfirst;b2Vec2=Box2D.Common.Math.b2Vec2;b2World=Box2D.Dynamics.b2World;ucfirst=function(s){return s.charAt(0).toUpperCase()+s.substr(1)};Asteroids.prototype.game=null;Asteroids.prototype.pad=null;Asteroids.prototype.profiler=null;Asteroids.prototype.engine=null;Asteroids.prototype.entities=null;Asteroids.prototype.keyPoll=null;Asteroids.prototype.config=null;Asteroids.prototype.world=null;Asteroids.prototype.background=null;Asteroids.prototype.physics=null;Asteroids.prototype.faderBitmap=null;Asteroids.prototype.faderSprite=null;Asteroids.prototype.bgdColor=6970061;Asteroids.prototype.height=window.innerHeight;Asteroids.prototype.width=window.innerWidth;Asteroids.prototype.scale=window.devicePixelRatio;Asteroids.prototype.playMusic=localStorage.playMusic;Asteroids.prototype.playSfx=localStorage.playSfx;Asteroids.prototype.optBgd=localStorage.background||"blue";function Asteroids(){this.initializeDb=__bind(this.initializeDb,this);this.setPlaySfx=__bind(this.setPlaySfx,this);this.setPlayMusic=__bind(this.setPlayMusic,this);this.setBackground=__bind(this.setBackground,this);this.getBackground=__bind(this.getBackground,this);this.set=__bind(this.set,this);this.get=__bind(this.get,this);this.showLeaderboard=__bind(this.showLeaderboard,this);this.pause=__bind(this.pause,this);this.fade=__bind(this.fade,this);this.getFaderSprite=__bind(this.getFaderSprite,this);this.create=__bind(this.create,this);this.onLeaderboard=__bind(this.onLeaderboard,this);this.onSettings=__bind(this.onSettings,this);this.preload=__bind(this.preload,this);this.init=__bind(this.init,this);this.game=new Phaser.Game(this.width*this.scale,this.height*this.scale,Phaser.CANVAS,"",{init:this.init,preload:this.preload,create:this.create});this.rnd=new MersenneTwister;this.initializeDb();Cocoon.App.WebView.on("load",{success:function(_this){return function(){return Cocoon.App.showTheWebView()}}(this),error:function(_this){return function(){return console.log("Cannot show the Webview: "+JSON.stringify(arguments))}}(this)})}Asteroids.prototype.init=function(){this.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL;this.game.scale.minWidth=this.width*this.scale;this.game.scale.minHeight=this.height*this.scale;this.game.scale.maxWidth=this.width*this.scale;this.game.scale.maxHeight=this.height*this.scale;this.game.scale.pageAlignVertically=true;this.game.scale.pageAlignHorizontally=true};Asteroids.prototype.preload=function(){this.game.load.image("dialog-blue","res/dialog-box.png");this.game.load.image("dialog-star","res/black-dialog.png");this.game.load.image("button-blue","res/standard-button-on.png");this.game.load.image("button-star","res/black-button-on.png");this.game.load.image("background","res/BackdropBlackLittleSparkBlack.png");this.game.load.image("leaderboard","res/icons/b_Leaderboard.png");this.game.load.image("settings","res/icons/b_Parameters.png");this.game.load.image("round","res/round48.png");this.game.load.image("square","res/square48.png");this.game.load.audio("asteroid",[ExplodeAsteroid.prototype.src]);this.game.load.audio("ship",[ExplodeShip.prototype.src]);this.game.load.audio("shoot",[ShootGun.prototype.src])};Asteroids.prototype.onSettings=function(){this.pause(function(_this){return function(){return Cocoon.App.loadInTheWebView("settings.html")}}(this))};Asteroids.prototype.onLeaderboard=function(){this.pause(function(_this){return function(){return _this.showLeaderboard()}}(this))};Asteroids.prototype.create=function(){var PhysicsSystem,useBox2dPlugin;this.profiler=this.game.plugins.add(Phaser.Plugin.PerformanceMonitor,{profiler:this.get("profiler")});this.optBgd=Db.queryAll("settings",{query:{name:"background"}})[0].value;this.game.stage.backgroundColor=this.bgdColor;this.background=this.game.add.sprite(0,0,"background");this.background.width=this.width;this.background.height=this.height;this.background.alpha=this.optBgd==="blue"?0:1;console.log(this.background);this.game.add.button(this.width-50,50,"settings",this.onSettings);this.game.add.button(this.width-50,125,"leaderboard",this.onLeaderboard);ExplodeAsteroid.audio=this.game.add.audio("asteroid");ExplodeAsteroid.audio.play("",0,0);ExplodeShip.audio=this.game.add.audio("ship");ExplodeShip.audio.play("",0,0);ShootGun.audio=this.game.add.audio("shoot");ShootGun.audio.play("",0,0);this.keyPoll=new KeyPoll(this);this.world=new b2World(new b2Vec2(0,0),true);this.world.SetContinuousPhysics(true);this.ash=this.game.plugins.add(ash.core.PhaserEngine,Nodes,Components);this.entities=new Entities(this);this.controller=this.game.plugins.add(Phaser.Plugin.GameControllerPlugin,{force:true});this.controller.addDPad("left",60,this.height-60,{up:{width:"10%",height:"7%"},left:{width:"7%",height:"10%"},right:{width:"7%",height:"10%"},down:false});this.controller.addButtons("right",this.width-180,this.height-80,{1:{title:"warp",color:"yellow"},3:{title:"FIRE",color:"red"}});useBox2dPlugin=!(!window.ext||typeof window.ext.IDTK_SRV_BOX2D==="undefined");PhysicsSystem=useBox2dPlugin?FixedPhysicsSystem:SmoothPhysicsSystem;this.physics=new PhysicsSystem(this);this.ash.addSystem(this.physics,SystemPriorities.move);this.ash.addSystem(new BulletAgeSystem(this,PhysicsSystem),SystemPriorities.update);this.ash.addSystem(new DeathThroesSystem(this,PhysicsSystem),SystemPriorities.update);this.ash.addSystem(new CollisionSystem(this,PhysicsSystem),SystemPriorities.resolveCollisions);this.ash.addSystem(new AnimationSystem(this),SystemPriorities.animate);this.ash.addSystem(new HudSystem(this),SystemPriorities.animate);this.ash.addSystem(new RenderSystem(this),SystemPriorities.render);this.ash.addSystem(new AudioSystem(this),SystemPriorities.render);this.ash.addSystem(new WaitForStartSystem(this),SystemPriorities.preUpdate);this.ash.addSystem(new GameManager(this),SystemPriorities.preUpdate);this.ash.addSystem(new ShipControlSystem(this),SystemPriorities.update);this.ash.addSystem(new GunControlSystem(this),SystemPriorities.update);this.entities.createWaitForClick();this.entities.createGame()};Asteroids.prototype.getFaderSprite=function(){if(this.faderSprite==null){this.faderBitmap=this.game.make.bitmapData(this.game.width,this.game.height);this.faderBitmap.rect(0,0,this.game.width,this.game.height,"rgb(0,0,0)");this.faderSprite=this.game.add.sprite(0,0,this.faderBitmap);this.faderSprite.alpha=0}return this.faderSprite.bringToTop()};Asteroids.prototype.fade=function(next){var fader,sprite;sprite=this.getFaderSprite();fader=this.game.add.tween(sprite);if(sprite.alpha===0){fader.to({alpha:1},500);fader.onComplete.add(next,this);fader.start()}else{this.game.paused=false;fader.to({alpha:0},500);fader.onComplete.add(next,this);fader.start()}};Asteroids.prototype.pause=function(next){if(next!=null){this.faderSprite=null;this.physics.enabled=false;this.fade(next)}else{this.fade(function(_this){return function(){return _this.physics.enabled=true}}(this))}};Asteroids.prototype.showLeaderboard=function(){var big,board,button,dialog,label,mmddyyyy,normal,row,title,y,_i,_len,_ref;board=this.game.add.group();dialog=new Phaser.Sprite(this.game,0,0,"dialog-"+this.optBgd);dialog.width=this.width;dialog.height=this.height;board.add(dialog);big={font:"bold 30px opendyslexic",fill:"#ffffff"};normal={font:"bold 20px opendyslexic",fill:"#ffffff"};title=new Phaser.Text(this.game,this.width/2,20,"Asteroids",big);title.anchor.x=.5;board.add(title);board.add(new Phaser.Text(this.game,200,80,"Date",normal));board.add(new Phaser.Text(this.game,400,80,"Score",normal));board.add(new Phaser.Text(this.game,200,100,"--------",normal));board.add(new Phaser.Text(this.game,400,100,"--------",normal));y=120;_ref=Db.queryAll("leaderboard",{limit:10,sort:[["score","DESC"]]});for(_i=0,_len=_ref.length;_i<_len;_i++){row=_ref[_i];mmddyyyy=row.date.substr(4,2)+"/"+row.date.substr(6,2)+"/"+row.date.substr(0,4);board.add(new Phaser.Text(this.game,200,y,mmddyyyy,normal));board.add(new Phaser.Text(this.game,400,y,row.score,normal));y+=20}button=new Phaser.Button(this.game,this.width/2,this.height-64,"button-"+this.optBgd,function(_this){return function(){board.destroy();board=null;_this.pause()}}(this));button.anchor.x=.5;board.add(button);label=new Phaser.Text(this.game,0,button.height/2,"continue",big);label.anchor.x=.5;label.anchor.y=.5;button.addChild(label)};Asteroids.prototype.get=function(prop){var n;n="get"+ucfirst(prop);if(this[n]!=null){return this[n]()}else{return Db.queryAll("settings",{query:{name:prop}})[0].value}};Asteroids.prototype.set=function(prop,value){var n;n="set"+ucfirst(prop);if(this[n]!=null){this[n](value)}else{Db.update("settings",{name:prop},function(row){row.value=value;return row});Db.commit()}};Asteroids.prototype.getBackground=function(){if("blue"===Db.queryAll("settings",{query:{name:"background"}})[0].value){return 0}else{return 1}};Asteroids.prototype.setBackground=function(value){var background;background=["blue","star"];this.background.alpha=value;this.optBgd=background[value];Db.update("settings",{name:"background"},function(row){row.value=background[value];return row});Db.commit()};Asteroids.prototype.setPlayMusic=function(value){Db.update("settings",{name:"playMusic"},function(row){row.value=value;return row});Db.commit();this.playMusic=value};Asteroids.prototype.setPlaySfx=function(value){Db.update("settings",{name:"playSfx"},function(row){row.value=value;return row});Db.commit();this.playSfx=value;Sound.volume=value/100};Asteroids.prototype.initializeDb=function(){window.Db=new localStorageDB("asteroids",localStorage);if(Db.isNew()){Db.createTable("leaderboard",["date","score"]);Db.createTable("settings",["name","value"]);Db.insert("settings",{name:"profiler",value:"on"});Db.insert("settings",{name:"background",value:"blue"});Db.insert("settings",{name:"playMusic",value:"50"});Db.insert("settings",{name:"playSfx",value:"50"});Db.insert("settings",{name:"asteroidDensity",value:"1.0"});Db.insert("settings",{name:"asteroidFriction",value:"1.0"});Db.insert("settings",{name:"asteroidRestitution",value:"0.2"});Db.insert("settings",{name:"asteroidDamping",value:"0.0"});Db.insert("settings",{name:"asteroidLinearVelocity",value:"4.0"});Db.insert("settings",{name:"asteroidAngularVelocity",value:"2.0"});Db.insert("settings",{name:"spaceshipDensity",value:"1.0"});Db.insert("settings",{name:"spaceshipFriction",value:"1.0"});Db.insert("settings",{name:"spaceshipRestitution",value:"0.2"});Db.insert("settings",{name:"spaceshipDamping",value:"0.75"});Db.insert("settings",{name:"bulletDensity",value:"1.0"});Db.insert("settings",{name:"bulletFriction",value:"0.0"});Db.insert("settings",{name:"bulletRestitution",value:"0.0"});Db.insert("settings",{name:"bulletDamping",value:"0.0"});Db.insert("settings",{name:"bulletLinearVelocity",value:"150"});Db.commit()}if(Db.queryAll("settings",{query:{name:"profiler"}}).length===0){Db.insert("settings",{name:"profiler",value:"off"})}};return Asteroids}();Phaser.Plugin.PerformanceMonitor=function(_super){__extends(PerformanceMonitor,_super);PerformanceMonitor.prototype.stats=null;PerformanceMonitor.prototype.visible=false;PerformanceMonitor.prototype.active=false;PerformanceMonitor.prototype.hasPreUpdate=false;PerformanceMonitor.prototype.hasPostRender=false;function PerformanceMonitor(game,parent){PerformanceMonitor.__super__.constructor.call(this,game,parent)}PerformanceMonitor.prototype.init=function(options){var container,x,y,_ref,_ref1,_ref2;if(navigator.isCocoonJS||options.profiler==="off"){this.preUpdate=this.nop;return this.postRender=this.nop}else{if(typeof Stats!=="undefined"&&Stats!==null){if(options.container!=null){container=options.container}else{container=document.createElement("div");document.body.appendChild(container)}this.stats=new Stats;container.appendChild(this.stats.domElement);this.stats.domElement.style.position="absolute";x=(_ref=options.x)!=null?_ref:0;y=(_ref1=options.y)!=null?_ref1:0;this.stats.setMode((_ref2=options.mode)!=null?_ref2:0);this.stats.domElement.style.position="absolute";this.stats.domElement.style.left=""+x+"px";this.stats.domElement.style.top=""+y+"px";this.active=true;this.visible=true;this.hasPreUpdate=true;return this.hasPostRender=true}else{this.preUpdate=this.nop;return this.postRender=this.nop}}};PerformanceMonitor.prototype.preUpdate=function(){this.stats.begin()};PerformanceMonitor.prototype.postRender=function(){this.stats.end()};PerformanceMonitor.prototype.nop=function(){};return PerformanceMonitor}(Phaser.Plugin);(function(){return window.addEventListener("load",function(){return window.asteroids=new Asteroids})})()}).call(this);