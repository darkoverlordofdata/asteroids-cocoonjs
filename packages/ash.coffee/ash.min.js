(function(){"use strict";var ComponentInstanceProvider,ComponentMatchingFamily,ComponentPool,ComponentSingletonProvider,ComponentTypeProvider,Dictionary,DynamicComponentProvider,DynamicSystemProvider,Engine,EngineState,EngineStateMachine,Entity,EntityList,EntityState,EntityStateMachine,Family,FrameTickProvider,ListIteratingSystem,ListenerNode,ListenerNodePool,Node,NodeList,NodePool,Signal0,Signal1,Signal2,Signal3,SignalBase,StateComponentMapping,StateSystemMapping,System,SystemInstanceProvider,SystemList,SystemSingletonProvider,ash,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};ash={signals:{},core:{},fsm:{},tick:{},tools:{}};Dictionary=function(){function Dictionary(){}return Dictionary}();ash.signals.ListenerNode=ListenerNode=function(){function ListenerNode(){}ListenerNode.prototype.previous=null;ListenerNode.prototype.next=null;ListenerNode.prototype.listener=null;ListenerNode.prototype.once=false;return ListenerNode}();ash.signals.ListenerNodePool=ListenerNodePool=function(){function ListenerNodePool(){}ListenerNodePool.prototype.tail=null;ListenerNodePool.prototype.cacheTail=null;ListenerNodePool.prototype.get=function(){var node;if(this.tail!==null){node=this.tail;this.tail=this.tail.previous;node.previous=null;return node}else{return new ListenerNode}};ListenerNodePool.prototype.dispose=function(node){node.listener=null;node.once=false;node.next=null;node.previous=this.tail;this.tail=node};ListenerNodePool.prototype.cache=function(node){node.listener=null;node.previous=this.cacheTail;this.cacheTail=node};ListenerNodePool.prototype.releaseCache=function(){var node;while(this.cacheTail!==null){node=this.cacheTail;this.cacheTail=node.previous;node.next=null;node.previous=this.tail;this.tail=node}};return ListenerNodePool}();ash.signals.SignalBase=SignalBase=function(){SignalBase.prototype.head=null;SignalBase.prototype.tail=null;SignalBase.prototype.numListeners=0;SignalBase.prototype.keys=null;SignalBase.prototype.nodes=null;SignalBase.prototype.listenerNodePool=null;SignalBase.prototype.toAddHead=null;SignalBase.prototype.toAddTail=null;SignalBase.prototype.dispatching=false;function SignalBase(){this.nodes=[];this.keys=[];this.listenerNodePool=new ListenerNodePool;this.numListeners=0}SignalBase.prototype.startDispatch=function(){this.dispatching=true};SignalBase.prototype.endDispatch=function(){this.dispatching=false;if(this.toAddHead){if(!this.head){this.head=this.toAddHead;this.tail=this.toAddTail}else{this.tail.next=this.toAddHead;this.toAddHead.previous=this.tail;this.tail=this.toAddTail}this.toAddHead=null;this.toAddTail=null}this.listenerNodePool.releaseCache()};SignalBase.prototype.getNode=function(listener){var node;node=this.head;while(node!==null){if(node.listener===listener){break}node=node.next}if(node===null){node=this.toAddHead;while(node!==null){if(node.listener===listener){break}node=node.next}}return node};SignalBase.prototype.add=function(listener){var node;if(this.keys.indexOf(listener)!==-1){return}node=this.listenerNodePool.get();node.listener=listener;this.nodes.push(node);this.keys.push(listener);this.addNode(node)};SignalBase.prototype.addOnce=function(listener){var node;if(this.keys.indexOf(listener)!==-1){return}node=this.listenerNodePool.get();node.listener=listener;node.once=true;this.nodes.push(node);this.keys.push(listener);this.addNode(node)};SignalBase.prototype.addNode=function(node){if(this.dispatching){if(this.toAddHead===null){this.toAddHead=this.toAddTail=node}else{this.toAddTail.next=node;node.previous=this.toAddTail;this.toAddTail=node}}else{if(this.head===null){this.head=this.tail=node}else{this.tail.next=node;node.previous=this.tail;this.tail=node}}this.numListeners++};SignalBase.prototype.remove=function(listener){var index,node;index=this.keys.indexOf(listener);node=this.nodes[index];if(node){if(this.head===node){this.head=this.head.next}if(this.tail===node){this.tail=this.tail.previous}if(this.toAddHead===node){this.toAddHead=this.toAddHead.next}if(this.toAddTail===node){this.toAddTail=this.toAddTail.previous}if(node.previous){node.previous.next=node.next}if(node.next){node.next.previous=node.previous}this.nodes.splice(index,1);this.keys.splice(index,1);if(this.dispatching){this.listenerNodePool.cache(node)}else{this.listenerNodePool.dispose(node)}this.numListeners--}};SignalBase.prototype.removeAll=function(){var node;while(this.head){node=this.head;this.head=this.head.next;this.nodes.splice(index,1);this.listenerNodePool.dispose(node)}this.nodes=[];this.keys=[];this.tail=null;this.toAddHead=null;this.toAddTail=null;this.numListeners=0};return SignalBase}();ash.signals.Signal0=Signal0=function(superClass){extend(Signal0,superClass);function Signal0(){return Signal0.__super__.constructor.apply(this,arguments)}Signal0.prototype.dispatch=function(){var node;this.startDispatch();node=this.head;while(node!==null){node.listener();if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal0}(SignalBase);ash.signals.Signal1=Signal1=function(superClass){extend(Signal1,superClass);function Signal1(){return Signal1.__super__.constructor.apply(this,arguments)}Signal1.prototype.dispatch=function($1){var node;this.startDispatch();node=this.head;while(node!==null){node.listener($1);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal1}(SignalBase);ash.signals.Signal2=Signal2=function(superClass){extend(Signal2,superClass);function Signal2(){return Signal2.__super__.constructor.apply(this,arguments)}Signal2.prototype.dispatch=function($1,$2){var node;this.startDispatch();node=this.head;while(node){node.listener($1,$2);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal2}(SignalBase);ash.signals.Signal3=Signal3=function(superClass){extend(Signal3,superClass);function Signal3(){return Signal3.__super__.constructor.apply(this,arguments)}Signal3.prototype.dispatch=function($1,$2,$3){var node;this.startDispatch();node=this.head;while(node!==null){node.listener($1,$2,$3);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal3}(SignalBase);ash.core.Entity=Entity=function(){var nameCount;nameCount=0;Entity.prototype._name="";Entity.prototype.componentAdded=null;Entity.prototype.componentRemoved=null;Entity.prototype.nameChanged=null;Entity.prototype.previous=null;Entity.prototype.next=null;Entity.prototype.components=null;function Entity(name){if(name==null){name=""}Object.defineProperties(this,{name:{get:function(){return this._name},set:function(value){var previous;if(this._name!==value){previous=this._name;this._name=value;return this.nameChanged.dispatch(this,previous)}}}});this.componentAdded=new Signal2;this.componentRemoved=new Signal2;this.nameChanged=new Signal2;this.components=new Dictionary;if(name!==""){this._name=name}else{this._name="_entity"+ ++nameCount}}Entity.prototype.add=function(component,componentClass){if(componentClass==null){componentClass=component.constructor}if(componentClass.name in this.components){this.remove(componentClass)}this.components[componentClass.name]=component;this.componentAdded.dispatch(this,componentClass);return this};Entity.prototype.remove=function(componentClass){var component,name;name=componentClass.name!=null?componentClass.name:componentClass;component=this.components[name];if(component){delete this.components[name];this.componentRemoved.dispatch(this,name);return component}return null};Entity.prototype.get=function(componentClass){return this.components[componentClass.name]};Entity.prototype.getAll=function(){var component,componentArray,i,len,ref;componentArray=[];ref=this.components;for(i=0,len=ref.length;i<len;i++){component=ref[i];componentArray.push(component)}return componentArray};Entity.prototype.has=function(componentClass){return componentClass.name in this.components};return Entity}();ash.core.EntityList=EntityList=function(){function EntityList(){}EntityList.prototype.head=null;EntityList.prototype.tail=null;EntityList.prototype.add=function(entity){if(!this.head){this.head=this.tail=entity;entity.next=entity.previous=null}else{this.tail.next=entity;entity.previous=this.tail;entity.next=null;this.tail=entity}};EntityList.prototype.remove=function(entity){if(this.head===entity){this.head=this.head.next}if(this.tail===entity){this.tail=this.tail.previous}if(entity.previous){entity.previous.next=entity.next}if(entity.next){entity.next.previous=entity.previous}};EntityList.prototype.removeAll=function(){var entity;while(this.head){entity=this.head;this.head=this.head.next;entity.previous=null;entity.next=null}this.tail=null};return EntityList}();ash.core.Node=Node=function(){function Node(){}Node.prototype.entity=null;Node.prototype.previous=null;Node.prototype.next=null;return Node}();ash.core.NodeList=NodeList=function(){NodeList.prototype.head=null;NodeList.prototype.tail=null;NodeList.prototype.nodeAdded=null;NodeList.prototype.nodeRemoved=null;function NodeList(){this.nodeAdded=new Signal1;this.nodeRemoved=new Signal1}NodeList.prototype.add=function(node){if(!this.head){this.head=this.tail=node;node.next=node.previous=null}else{this.tail.next=node;node.previous=this.tail;node.next=null;this.tail=node}this.nodeAdded.dispatch(node)};NodeList.prototype.remove=function(node){if(this.head===node){this.head=this.head.next}if(this.tail===node){this.tail=this.tail.previous}if(node.previous){node.previous.next=node.next}if(node.next){node.next.previous=node.previous}this.nodeRemoved.dispatch(node)};NodeList.prototype.removeAll=function(){var node;while(this.head){node=this.head;this.head=this.head.next;node.previous=null;node.next=null;this.nodeRemoved.dispatch(node)}this.tail=null};Object.defineProperties(NodeList.prototype,{empty:{get:function(){return this.head===null}}});NodeList.prototype.swap=function(node1,node2){var temp;if(node1.previous===node2){node1.previous=node2.previous;node2.previous=node1;node2.next=node1.next;node1.next=node2}else if(node2.previous===node1){node2.previous=node1.previous;node1.previous=node2;node1.next=node2.next;node2.next=node1}else{temp=node1.previous;node1.previous=node2.previous;node2.previous=temp;temp=node1.next;node1.next=node2.next;node2.next=temp}if(this.head===node1){this.head=node2}else if(this.head===node2){this.head=node1}if(this.tail===node1){this.tail=node2}else if(this.tail===node2){this.tail=node1}if(node1.previous!==null){node1.previous.next=node1}if(node2.previous!==null){node2.previous.next=node2}if(node1.next!==null){node1.next.previous=node1}if(node2.next!==null){node2.next.previous=node2}};NodeList.prototype.insertionSort=function(sortFunction){var node,other,remains;if(this.head===this.tail){return}remains=this.head.next;node=remains;while(node!==null){remains=node.next;other=node.previous;while(other!==null){if(sortFunction(node,other)>=0){if(node!==other.next){if(this.tail===node){this.tail=node.previous}node.previous.next=node.next;if(node.next!==null){node.next.previous=node.previous}node.next=other.next;node.previous=other;node.next.previous=node;other.next=node}break}other=other.previous}if(other===null){if(this.tail===node){this.tail=node.previous}node.previous.next=node.next;if(node.next!==null){node.next.previous=node.previous}node.next=this.head;this.head.previous=node;node.previous=null;this.head=node}node=remains}};NodeList.prototype.mergeSort=function(sortFunction){var end,lists,next,start;if(this.head===this.tail){return}lists=[];start=this.head;while(start!==null){end=start;while(end.next!==null&&sortFunction(end,end.next)<=0){end=end.next}next=end.next;start.previous=end.next=null;lists.push(start);start=next}while(lists.length>1){lists.push(this.merge(lists.shift(),lists.shift(),sortFunction))}this.tail=this.head=lists[0];while(this.tail.next!==null){this.tail=this.tail.next}};NodeList.prototype.merge=function(head1,head2,sortFunction){var head,node;if(sortFunction(head1,head2)<=0){head=node=head1;head1=head1.next}else{head=node=head2;head2=head2.next}while(head1!==null&&head2!==null){if(sortFunction(head1,head2)<=0){node.next=head1;head1.previous=node;node=head1;head1=head1.next}else{node.next=head2;head2.previous=node;node=head2;head2=head2.next}}if(head1!==null){node.next=head1;head1.previous=node}else{node.next=head2;head2.previous=node}return head};return NodeList}();ash.core.NodePool=NodePool=function(){NodePool.prototype.tail=null;NodePool.prototype.nodeClass=null;NodePool.prototype.cacheTail=null;NodePool.prototype.components=null;function NodePool(nodeClass1,components){this.nodeClass=nodeClass1;this.components=components}NodePool.prototype.get=function(){var node;if(this.tail){node=this.tail;this.tail=this.tail.previous;node.previous=null;return node}else{return new this.nodeClass}};NodePool.prototype.dispose=function(node){var componentName;for(componentName in this.components){node[componentName]=null}node.entity=null;node.next=null;node.previous=this.tail;this.tail=node};NodePool.prototype.cache=function(node){node.previous=this.cacheTail;this.cacheTail=node};NodePool.prototype.releaseCache=function(){var node;while(this.cacheTail){node=this.cacheTail;this.cacheTail=node.previous;this.dispose(node)}};return NodePool}();ash.core.System=System=function(){function System(){this.update=bind(this.update,this)}System.prototype.previous=null;System.prototype.next=null;System.prototype.priority=0;System.prototype.addToEngine=function(engine){};System.prototype.removeFromEngine=function(engine){};System.prototype.update=function(time){};return System}();ash.core.SystemList=SystemList=function(){function SystemList(){}SystemList.prototype.head=null;SystemList.prototype.tail=null;SystemList.prototype.add=function(system){var node;if(!this.head){this.head=this.tail=system;system.next=system.previous=null}else{node=this.tail;while(node){if(node.priority<=system.priority){break}node=node.previous}if(node===this.tail){this.tail.next=system;system.previous=this.tail;system.next=null;this.tail=system}else if(!node){system.next=this.head;system.previous=null;this.head.previous=system;this.head=system}else{system.next=node.next;system.previous=node;node.next.previous=system;node.next=system}}};SystemList.prototype.remove=function(system){if(this.head===system){this.head=this.head.next}if(this.tail===system){this.tail=this.tail.previous}if(system.previous){system.previous.next=system.next}if(system.next){system.next.previous=system.previous}};SystemList.prototype.removeAll=function(){var system;while(this.head){system=this.head;this.head=this.head.next;system.previous=null;system.next=null}this.tail=null};SystemList.prototype.get=function(type){var system;system=this.head;while(system){if(system.constructor===type){return system}system=system.next}return null};return SystemList}();ash.core.Family=Family=function(){Family.prototype.nodes=null;function Family(){Object.defineProperties(this,{nodeList:{get:function(){return this.nodes}}})}Family.prototype.newEntity=function(entity){throw new Error("Method must be overriden")};Family.prototype.removeEntity=function(entity){throw new Error("Method must be overriden")};Family.prototype.componentAddedToEntity=function(entity,componentClass){throw new Error("Method must be overriden")};Family.prototype.componentRemovedFromEntity=function(entity,componentClass){throw new Error("Method must be overriden")};Family.prototype.cleanUp=function(){throw new Error("Method must be overriden")};return Family}();ash.core.ComponentMatchingFamily=ComponentMatchingFamily=function(){ComponentMatchingFamily.prototype.nodes=null;ComponentMatchingFamily.prototype.entities=null;ComponentMatchingFamily.prototype.nodeClass=null;ComponentMatchingFamily.prototype.components=null;ComponentMatchingFamily.prototype.nodePool=null;ComponentMatchingFamily.prototype.engine=null;function ComponentMatchingFamily(nodeClass1,engine1){this.nodeClass=nodeClass1;this.engine=engine1;this.releaseNodePoolCache=bind(this.releaseNodePoolCache,this);this.init()}ComponentMatchingFamily.prototype.init=function(){var name,ref,type;this.nodes=new NodeList;this.entities=new Dictionary;this.components=new Dictionary;this.nodePool=new NodePool(this.nodeClass,this.nodeClass.components);ref=this.nodeClass.components;for(name in ref){type=ref[name];this.components[type.name]=type}};Object.defineProperties(ComponentMatchingFamily.prototype,{nodeList:{get:function(){return this.nodes}}});ComponentMatchingFamily.prototype.newEntity=function(entity){this.addIfMatch(entity)};ComponentMatchingFamily.prototype.componentAddedToEntity=function(entity,componentClass){this.addIfMatch(entity)};ComponentMatchingFamily.prototype.componentRemovedFromEntity=function(entity,componentClass){var name;name=componentClass.name!=null?componentClass.name:componentClass;if(name in this.components){this.removeIfMatch(entity)}};ComponentMatchingFamily.prototype.removeEntity=function(entity){this.removeIfMatch(entity)};ComponentMatchingFamily.prototype.addIfMatch=function(entity){var componentClass,name,node,ref,ref1;if(this.entities[entity.name]==null){ref=this.nodeClass.components;for(name in ref){componentClass=ref[name];if(!entity.has(componentClass)){return}}node=this.nodePool.get();node.entity=entity;ref1=this.nodeClass.components;for(name in ref1){componentClass=ref1[name];node[name]=entity.get(componentClass)}this.entities[entity.name]=node;this.nodes.add(node)}};ComponentMatchingFamily.prototype.removeIfMatch=function(entity){var node;if(entity.name in this.entities){node=this.entities[entity.name];delete this.entities[entity.name];this.nodes.remove(node);if(this.engine.updating){this.nodePool.cache(node);this.engine.updateComplete.add(this.releaseNodePoolCache)}else{this.nodePool.dispose(node)}}};ComponentMatchingFamily.prototype.releaseNodePoolCache=function(){this.engine.updateComplete.remove(this.releaseNodePoolCache);this.nodePool.releaseCache()};ComponentMatchingFamily.prototype.cleanUp=function(){var node;node=this.nodes.head;while(node){this.entities.remove(node.entity);node=node.next}this.nodes.removeAll()};return ComponentMatchingFamily}();ash.core.Engine=Engine=function(){Engine.prototype.entityNames=null;Engine.prototype.entityList=null;Engine.prototype.systemList=null;Engine.prototype.families=null;Engine.prototype.updating=false;Engine.prototype.updateComplete=null;Engine.prototype.familyClass=ComponentMatchingFamily;function Engine(){this.update=bind(this.update,this);this.componentRemoved=bind(this.componentRemoved,this);this.componentAdded=bind(this.componentAdded,this);this.entityNameChanged=bind(this.entityNameChanged,this);this.entityList=new EntityList;this.entityNames=new Dictionary;this.systemList=new SystemList;this.families=new Dictionary;this.updateComplete=new Signal0}Object.defineProperties(Engine.prototype,{entities:{get:function(){var entities,entity;entities=[];entity=this.entityList.head;while(entity){this.entities.push(entity);entity=entity.next}return entities}},systems:{get:function(){var system,systems;systems=[];system=this.systemList.head;while(system){systems.push(system);system=system.next}return systems}}});Engine.prototype.addEntity=function(entity){var each,family,ref;if(this.entityNames[entity.name]){throw"The entity name "+entity.name+" is already in use by another entity."}this.entityList.add(entity);this.entityNames[entity.name]=entity;entity.componentAdded.add(this.componentAdded);entity.componentRemoved.add(this.componentRemoved);entity.nameChanged.add(this.entityNameChanged);ref=this.families;for(each in ref){family=ref[each];family.newEntity(entity)}};Engine.prototype.removeEntity=function(entity){var each,family,ref;entity.componentAdded.remove(this.componentAdded);entity.componentRemoved.remove(this.componentRemoved);entity.nameChanged.remove(this.entityNameChanged);ref=this.families;for(each in ref){family=ref[each];family.removeEntity(entity)}delete this.entityNames[entity.name];this.entityList.remove(entity)};Engine.prototype.entityNameChanged=function(entity,oldName){if(this.entityNames[oldName]===entity){delete this.entityNames[oldName];this.entityNames[entity.name]=entity}};Engine.prototype.getEntityByName=function(name){return this.entityNames[name]};Engine.prototype.removeAllEntities=function(){while(this.entityList.head!==null){this.removeEntity(this.entityList.head)}};Engine.prototype.componentAdded=function(entity,componentClass){var each,family,ref;ref=this.families;for(each in ref){family=ref[each];family.componentAddedToEntity(entity,componentClass)}};Engine.prototype.componentRemoved=function(entity,componentClass){var each,family,ref;ref=this.families;for(each in ref){family=ref[each];family.componentRemovedFromEntity(entity,componentClass)}};Engine.prototype.getNodeList=function(nodeClass){var entity,family;if(nodeClass.name in this.families){return this.families[nodeClass.name].nodeList}family=new this.familyClass(nodeClass,this);this.families[nodeClass.name]=family;entity=this.entityList.head;while(entity){family.newEntity(entity);entity=entity.next}return family.nodeList};Engine.prototype.releaseNodeList=function(nodeClass){if(nodeClass.name in this.families){this.families[nodeClass.name].cleanUp();delete this.families[nodeClass.name]}};Engine.prototype.addSystem=function(system,priority){system.priority=priority;system.addToEngine(this);this.systemList.add(system)};Engine.prototype.getSystem=function(type){return systemList.get(type)};Engine.prototype.removeSystem=function(system){this.systemList.remove(system);system.removeFromEngine(this)};Engine.prototype.removeAllSystems=function(){while(this.systemList.head!==null){this.removeSystem(this.systemList.head)}};Engine.prototype.update=function(time){var system;this.updating=true;system=this.systemList.head;while(system){system.update(time);system=system.next}this.updating=false;this.updateComplete.dispatch()};return Engine}();ash.fsm.ComponentInstanceProvider=ComponentInstanceProvider=function(){ComponentInstanceProvider.prototype.instance=null;function ComponentInstanceProvider(instance){this.instance=instance}ComponentInstanceProvider.prototype.getComponent=function(){return this.instance};Object.defineProperties(ComponentInstanceProvider.prototype,{identifier:{get:function(){return this.instance}}});return ComponentInstanceProvider}();ash.fsm.ComponentSingletonProvider=ComponentSingletonProvider=function(){ComponentSingletonProvider.prototype.componentType=null;ComponentSingletonProvider.prototype.instance=null;function ComponentSingletonProvider(type){this.componentType=type}ComponentSingletonProvider.prototype.getComponent=function(){if(this.instance==null){this.instance=new this.componentType}return this.instance};Object.defineProperties(ComponentSingletonProvider.prototype,{identifier:{get:function(){return this.getComponent()}}});return ComponentSingletonProvider}();ash.fsm.ComponentTypeProvider=ComponentTypeProvider=function(){ComponentTypeProvider.prototype.componentType=null;function ComponentTypeProvider(type){this.componentType=type}ComponentTypeProvider.prototype.getComponent=function(){return new this.componentType};Object.defineProperties(ComponentTypeProvider.prototype,{identifier:{get:function(){return this.componentType}}});return ComponentTypeProvider}();ash.fsm.DynamicComponentProvider=DynamicComponentProvider=function(){DynamicComponentProvider.prototype._closure=null;function DynamicComponentProvider(closure){this._closure=closure}DynamicComponentProvider.prototype.getComponent=function(){return this._closure};Object.defineProperties(DynamicComponentProvider.prototype,{identifier:{get:function(){return this._closure}}});return DynamicComponentProvider}();ash.fsm.DynamicSystemProvider=DynamicSystemProvider=function(){DynamicSystemProvider.prototype.method=function(){};DynamicSystemProvider.prototype.systemPriority=0;function DynamicSystemProvider(method1){this.method=method1}DynamicSystemProvider.prototype.getSystem=function(){return this.method()};Object.defineProperties(DynamicSystemProvider.prototype,{identifier:{get:function(){return this.method}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return DynamicSystemProvider}();ash.fsm.EngineState=EngineState=function(){EngineState.prototype.providers=null;function EngineState(){this.providers=[]}EngineState.prototype.addInstance=function(system){return this.addProvider(new SystemInstanceProvider(system))};EngineState.prototype.addSingleton=function(type){return this.addProvider(new SystemSingletonProvider(type))};EngineState.prototype.addMethod=function(method){return this.addProvider(new DynamicSystemProvider(method))};EngineState.prototype.addProvider=function(provider){var mapping;mapping=new StateSystemMapping(this,provider);this.providers.push(provider);return mapping};return EngineState}();ash.fsm.StateComponentMapping=StateComponentMapping=function(){StateComponentMapping.prototype.componentType=null;StateComponentMapping.prototype.creatingState=null;StateComponentMapping.prototype.provider=null;function StateComponentMapping(creatingState1,type){this.creatingState=creatingState1;this.componentType=type;this.withType(type)}StateComponentMapping.prototype.withInstance=function(component){this.setProvider(new ComponentInstanceProvider(component));return this};StateComponentMapping.prototype.withType=function(type){this.setProvider(new ComponentTypeProvider(type));return this};StateComponentMapping.prototype.withSingleton=function(type){if(type==null){type=this.componentType}this.setProvider(new ComponentSingletonProvider(type));return this};StateComponentMapping.prototype.withMethod=function(method){this.setProvider(new DynamicComponentProvider(method));return this};StateComponentMapping.prototype.withProvider=function(provider){this.setProvider(provider);return this};StateComponentMapping.prototype.add=function(type){return this.creatingState.add(type)};StateComponentMapping.prototype.setProvider=function(provider){this.provider=provider;return this.creatingState.providers[this.componentType]=provider};return StateComponentMapping}();ash.fsm.EngineStateMachine=EngineStateMachine=function(){EngineStateMachine.prototype.engine=null;EngineStateMachine.prototype.states=null;EngineStateMachine.prototype.currentState=null;function EngineStateMachine(engine1){this.engine=engine1;this.states=new Dictionary}EngineStateMachine.prototype.addState=function(name,state){this.states[name]=state;return this};EngineStateMachine.prototype.createState=function(name){var state;state=new EngineState;this.states[name]=state;return this};EngineStateMachine.prototype.changeState=function(name){var each,id,newState,other,provider,ref,ref1,toAdd;newState=this.states[name];if(newState==null){throw new Error("Engine state "+name+" doesn't exist")}if(newState===this.currentState){newState=null;return}toAdd=new Dictionary;ref=newState.providers;for(each in ref){provider=ref[each];id=provider.identifier;toAdd[id]=provider}if(currentState){ref1=this.currentState.providers;for(each in ref1){provider=ref1[each];id=provider.identifier;other=toAdd[id];if(other){delete toAdd[id]}else{this.engine.removeSystem(provider.getSystem())}}}for(each in toAdd){provider=toAdd[each];this.engine.addSystem(provider.getSystem(),provider.priority)}return this.currentState=newState};return EngineStateMachine}();ash.fsm.EntityState=EntityState=function(){EntityState.prototype.providers=null;function EntityState(){this.providers=new Dictionary}EntityState.prototype.add=function(type){return new StateComponentMapping(this,type.name)};EntityState.prototype.get=function(type){return this.providers[type]};EntityState.prototype.has=function(type){return this.providers[type]!==null};return EntityState}();ash.fsm.EntityStateMachine=EntityStateMachine=function(){EntityStateMachine.prototype.states=null;EntityStateMachine.prototype.currentState=null;EntityStateMachine.prototype.entity=null;function EntityStateMachine(entity1){this.entity=entity1;this.states=new Dictionary}EntityStateMachine.prototype.addState=function(name,state){this.states[name]=state;return this};EntityStateMachine.prototype.createState=function(name){var state;state=new EntityState;this.states[name]=state;return state};EntityStateMachine.prototype.changeState=function(name){var newState,other,toAdd,type;newState=this.states[name];if(!newState){throw new Error("Entity state "+name+" doesn't exist")}if(newState===this.currentState){newState=null;return}if(this.currentState){toAdd=new Dictionary;for(type in newState.providers){toAdd[type]=newState.providers[type]}for(type in this.currentState.providers){other=toAdd[type];if(other&&other.identifier===this.currentState.providers[type].identifier){delete toAdd[type]}else{this.entity.remove(type)}}}else{toAdd=newState.providers}for(type in toAdd){this.entity.add(toAdd[type].getComponent())}return this.currentState=newState};return EntityStateMachine}();ash.fsm.StateSystemMapping=StateSystemMapping=function(){StateSystemMapping.prototype.creatingState=null;StateSystemMapping.prototype.provider=null;function StateSystemMapping(creatingState1,provider1){this.creatingState=creatingState1;this.provider=provider1}StateSystemMapping.prototype.withPriority=function(priority){this.provider.priority=priority;return this};StateSystemMapping.prototype.addInstance=function(system){return creatingState.addInstance(system)};StateSystemMapping.prototype.addSingleton=function(type){return creatingState.addSingleton(type)};StateSystemMapping.prototype.addMethod=function(method){return creatingState.addMethod(method)};StateSystemMapping.prototype.addProvider=function(provider){return creatingState.addProvider(provider)};return StateSystemMapping}();ash.fsm.SystemInstanceProvider=SystemInstanceProvider=function(){SystemInstanceProvider.prototype.instance=null;SystemInstanceProvider.prototype.systemPriority=0;function SystemInstanceProvider(instance){this.instance=instance}SystemInstanceProvider.prototype.getSystem=function(){return this.instance};Object.defineProperties(SystemInstanceProvider.prototype,{identifier:{get:function(){return this.instance}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return SystemInstanceProvider}();ash.fsm.SystemSingletonProvider=SystemSingletonProvider=function(){SystemSingletonProvider.prototype.componentType=null;SystemSingletonProvider.prototype.instance=null;SystemSingletonProvider.prototype.systemPriority=0;function SystemSingletonProvider(type){this.componentType=type}SystemSingletonProvider.prototype.getSystem=function(){if(!this.instance){this.instance=new this.componentType}return this.instance};Object.defineProperties(SystemSingletonProvider.prototype,{identifier:{get:function(){return this.getSystem()}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return SystemSingletonProvider}();ash.tick.FrameTickProvider=FrameTickProvider=function(superClass){extend(FrameTickProvider,superClass);FrameTickProvider.prototype.displayObject=null;FrameTickProvider.prototype.previousTime=0;FrameTickProvider.prototype.maximumFrameTime=0;FrameTickProvider.prototype.isPlaying=false;FrameTickProvider.prototype.request=null;FrameTickProvider.prototype.timeAdjustment=1;function FrameTickProvider(displayObject,maximumFrameTime){this.displayObject=displayObject;this.maximumFrameTime=maximumFrameTime;this.dispatchTick=bind(this.dispatchTick,this);FrameTickProvider.__super__.constructor.apply(this,arguments)}Object.defineProperties(FrameTickProvider.prototype,{playing:{get:function(){return this.isPlaying
}}});FrameTickProvider.prototype.start=function(){this.request=requestAnimationFrame(this.dispatchTick);this.isPlaying=true};FrameTickProvider.prototype.stop=function(){cancelRequestAnimationFrame(this.request);this.isPlaying=false};FrameTickProvider.prototype.dispatchTick=function(timestamp){var frameTime,temp;if(timestamp==null){timestamp=Date.now()}if(this.displayObject){this.displayObject.begin()}temp=this.previousTime||timestamp;this.previousTime=timestamp;frameTime=(timestamp-temp)*.001;this.dispatch(frameTime);requestAnimationFrame(this.dispatchTick);if(this.displayObject){this.displayObject.end()}};return FrameTickProvider}(Signal1);ash.tools.ComponentPool=ComponentPool=function(){var getPool,pools;function ComponentPool(){}pools=new Dictionary;getPool=function(componentClass){var ref;if(ref=componentClass.name,indexOf.call(pools,ref)>=0){return pools[componentClass.name]}else{return pools[componentClass.name]=[]}};ComponentPool.get=function(componentClass){var pool;pool=getPool(componentClass);if(pool.length>0){return pool.pop()}else{return new componentClass}};ComponentPool.dispose=function(component){var pool,type;if(component){type=component.constructor;pool=getPool(type);pool.push(component)}};ComponentPool.empty=function(){return pools=new Dictionary};return ComponentPool}();ash.tools.ListIteratingSystem=ListIteratingSystem=function(superClass){extend(ListIteratingSystem,superClass);ListIteratingSystem.prototype.nodeList=null;ListIteratingSystem.prototype.nodeClass=null;ListIteratingSystem.prototype.nodeUpdateFunction=null;ListIteratingSystem.prototype.nodeAddedFunction=null;ListIteratingSystem.prototype.nodeRemovedFunction=null;function ListIteratingSystem(nodeClass,nodeUpdateFunction,nodeAddedFunction,nodeRemovedFunction){if(nodeAddedFunction==null){nodeAddedFunction=null}if(nodeRemovedFunction==null){nodeRemovedFunction=null}this.nodeClass=nodeClass;this.nodeUpdateFunction=nodeUpdateFunction;this.nodeAddedFunction=nodeAddedFunction;this.nodeRemovedFunction=nodeRemovedFunction}ListIteratingSystem.prototype.addToEngine=function(engine){var node;this.nodeList=engine.getNodeList(this.nodeClass);if(this.nodeAddedFunction!==null){node=this.nodeList.head;while(node){this.nodeAddedFunction(node);node=node.next}this.nodeList.nodeAdded.add(this.nodeAddedFunction)}if(this.nodeRemovedFunction!==null){this.nodeList.nodeRemoved.add(this.nodeRemovedFunction)}};ListIteratingSystem.prototype.removeFromEngine=function(engine){if(this.nodeAddedFunction!==null){this.nodeList.nodeAdded.remove(this.nodeAddedFunction)}if(this.nodeRemovedFunction!==null){this.nodeList.nodeRemoved.remove(this.nodeRemovedFunction)}this.nodeList=null};ListIteratingSystem.prototype.update=function(time){var node;node=this.nodeList.head;while(node){this.nodeUpdateFunction(node,time);node=node.next}};return ListIteratingSystem}(System);if(typeof module!=="undefined"&&module!==null){module.exports=ash}else{window.ash=ash}}).call(this);