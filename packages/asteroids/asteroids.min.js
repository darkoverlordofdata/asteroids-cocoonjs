(function(){"use strict";var Animation,AnimationNode,AnimationSystem,Asteroid,AsteroidCollisionNode,AsteroidDeathView,AsteroidView,Asteroids,Audio,AudioNode,AudioSystem,Bullet,BulletAgeNode,BulletAgeSystem,BulletCollisionNode,BulletView,Collision,CollisionSystem,DeathThroes,DeathThroesNode,DeathThroesSystem,Display,Dot,EntityCreator,GameConfig,GameManager,GameNode,GameState,Gun,GunControlNode,GunControlSystem,GunControls,Hud,HudNode,HudSystem,HudView,KeyPoll,MersenneTwister,MotionControls,MovementNode,Physics,PhysicsControlNode,PhysicsControlSystem,PhysicsNode,PhysicsSystem,Point,Position,RenderNode,RenderSystem,Spaceship,SpaceshipDeathView,SpaceshipNode,SpaceshipView,SystemPriorities,WaitForStart,WaitForStartNode,WaitForStartSystem,WaitForStartView,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;MersenneTwister=function(){var LOWER_MASK,M,MATRIX_A,N,UPPER_MASK;N=624;M=397;MATRIX_A=2567483615;UPPER_MASK=2147483648;LOWER_MASK=2147483647;MersenneTwister.prototype.mt=null;MersenneTwister.prototype.mti=N+1;function MersenneTwister(seed){var m,results;this.mt=function(){results=[];for(var m=0;0<=N?m<N:m>N;0<=N?m++:m--){results.push(m)}return results}.apply(this);switch(typeof seed){case"number":this.init_genrand(seed);break;case"object":this.init_genrand(seed,seed.length);break;default:this.init_genrand(Date.now()%LOWER_MASK)}}MersenneTwister.prototype.nextBool=function(){return(this.genrand_int32()&1)===1};MersenneTwister.prototype.nextDouble=function(){return this.genrand_res53()};MersenneTwister.prototype.nextInt=function(max){return Math.floor(this.genrand_res53()*max)};MersenneTwister.prototype.init_genrand=function(s){this.mt[0]=s&4294967295;this.mti=1;while(this.mti<N){this.mt[this.mti]=1812433253*(this.mt[this.mti-1]^this.mt[this.mti-1]>>30)+this.mti;this.mt[this.mti]&=4294967295;this.mti++}};MersenneTwister.prototype.init_by_array=function(init_key,key_length){var i,j,k;this.init_genrand(19650218);i=1;j=0;k=N>key_length?N:key_length;while(k>0){this.mt[i]=(this.mt[i]^(this.mt[i-1]^this.mt[i-1]>>30)*1664525)+init_key[j]+j;this.mt[i]&=4294967295;i++;j++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}if(j>=key_length){j=0}k--}k=N-1;while(k>0){this.mt[i]=(this.mt[i]^(this.mt[i-1]^this.mt[i-1]>>30)*1566083941)-i;this.mt[i]&=4294967295;i++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}k--}this.mt[0]=2147483648};MersenneTwister.prototype.genrand_int32=function(){var kk,mag01,y;mag01=[0,MATRIX_A];if(this.mti>=N){if(this.mti===N+1){this.init_genrand(5489)}kk=0;while(kk<N-M){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+M]^y>>1^mag01[y&1];kk++}while(kk<N-1){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+(M-N)]^y>>1^mag01[y&1];kk++}y=this.mt[N-1]&UPPER_MASK|this.mt[0]&LOWER_MASK;this.mt[N-1]=this.mt[M-1]^y>>1^mag01[y&1];this.mti=0}y=this.mt[this.mti++];y^=y>>11;y^=y<<7&2636928640;y^=y<<15&4022730752;y^=y>>18;return y>>0};MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>1};MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967296)};MersenneTwister.prototype.genrand_real2=function(){return this.genrand_int32()*(1/4294967296)};MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)};MersenneTwister.prototype.genrand_res53=function(){var a,b;a=this.genrand_int32()>>5;b=this.genrand_int32()>>6;return(a*67108864+b)*(1/9007199254740992)};return MersenneTwister}();Point=function(){Point.prototype.x=0;Point.prototype.y=0;function Point(x2,y2){this.x=x2!=null?x2:0;this.y=y2!=null?y2:0}Point.distance=function(point1,point2){var dx,dy;dx=point1.x-point2.x;dy=point1.y-point2.y;return Math.sqrt(dx*dx+dy*dy)};Point.prototype.distanceSquaredTo=function(targetPoint){var dx,dy;dx=this.x-targetPoint.x;dy=this.y-targetPoint.y;return dx*dx+dy*dy};Point.prototype.distanceTo=function(targetPoint){var dx,dy;dx=this.x-targetPoint.x;dy=this.y-targetPoint.y;return Math.sqrt(dx*dx+dy*dy)};return Point}();KeyPoll=function(){var displayObj,states;states=null;displayObj=null;function KeyPoll(displayObj1){this.displayObj=displayObj1;this.isUp=bind(this.isUp,this);this.isDown=bind(this.isDown,this);this.keyUpListener=bind(this.keyUpListener,this);this.keyDownListener=bind(this.keyDownListener,this);this.states={};this.displayObj.addEventListener("keydown",this.keyDownListener);this.displayObj.addEventListener("keyup",this.keyUpListener)}KeyPoll.prototype.keyDownListener=function(event){this.states[event.keyCode]=true};KeyPoll.prototype.keyUpListener=function(event){if(this.states[event.keyCode]){this.states[event.keyCode]=false}};KeyPoll.prototype.isDown=function(keyCode){return this.states[keyCode]};KeyPoll.prototype.isUp=function(keyCode){return!this.states[keyCode]};return KeyPoll}();AsteroidView=function(){AsteroidView.prototype.x=0;AsteroidView.prototype.y=0;AsteroidView.prototype.rotation=0;AsteroidView.prototype.radius=0;AsteroidView.prototype.points=null;function AsteroidView(radius1){var angle,length,posX,posY;this.radius=radius1;this.draw=bind(this.draw,this);this.width=this.radius;this.height=this.radius;this.points=[];angle=0;while(angle<Math.PI*2){length=(.75+rnd.nextDouble()*.25)*this.radius;posX=Math.cos(angle)*length;posY=Math.sin(angle)*length;this.points.push({x:posX,y:posY});angle+=rnd.nextDouble()*.5}}AsteroidView.prototype.draw=function(ctx){var i;ctx.save();ctx.beginPath();ctx.translate(this.x,this.y);ctx.rotate(this.rotation);ctx.fillStyle="#FFFFFF";ctx.moveTo(this.radius,0);i=0;while(i<this.points.length){ctx.lineTo(this.points[i].x,this.points[i].y);++i}ctx.lineTo(this.radius,0);ctx.fill();ctx.restore()};return AsteroidView}();AsteroidDeathView=function(){AsteroidDeathView.prototype.x=0;AsteroidDeathView.prototype.y=0;AsteroidDeathView.prototype.rotation=0;AsteroidDeathView.prototype.radius=0;AsteroidDeathView.prototype.points=null;AsteroidDeathView.prototype.first=true;AsteroidDeathView.prototype.dots=null;function AsteroidDeathView(radius1){this.radius=radius1;this.draw=bind(this.draw,this);this.dots=[]}AsteroidDeathView.prototype.draw=function(ctx){var dot,len,m,ref,results;ref=this.dots;results=[];for(m=0,len=ref.length;m<len;m++){dot=ref[m];results.push(dot.draw(ctx,this.x,this.y))}return results};AsteroidDeathView.prototype.animate=function(time){var dot,i,len,m,n,ref,results;if(this.first){this.first=false;for(i=m=0;m<8;i=++m){dot=new Dot(this.radius);this.dots.push(dot)}}ref=this.dots;results=[];for(n=0,len=ref.length;n<len;n++){dot=ref[n];dot.x+=dot.velocity.x*time;results.push(dot.y+=dot.velocity.y*time)}return results};return AsteroidDeathView}();Dot=function(){Dot.prototype.velocity=null;Dot.prototype.x=0;Dot.prototype.y=0;function Dot(maxDistance){var angle,distance,speed;angle=rnd.nextDouble()*2*Math.PI;distance=rnd.nextDouble()*maxDistance;this.x=Math.cos(angle)*distance;this.y=Math.sin(angle)*distance;speed=rnd.nextDouble()*10+10;this.velocity=new Point(Math.cos(angle)*speed,Math.sin(angle)*speed)}Dot.prototype.draw=function(ctx,x,y){ctx.save();ctx.beginPath();ctx.translate(x,y);ctx.rotate(this.rotation);ctx.fillStyle="#FFFFFF";ctx.arc(this.x,this.y,2,0,Math.PI*2,false);ctx.fill();ctx.restore()};return Dot}();BulletView=function(){function BulletView(){this.draw=bind(this.draw,this)}BulletView.prototype.x=0;BulletView.prototype.y=0;BulletView.prototype.rotation=0;BulletView.prototype.draw=function(ctx){ctx.save();ctx.beginPath();ctx.rotate(this.rotation);ctx.fillStyle="#FFFFFF";ctx.arc(this.x,this.y,2,0,Math.PI*2,false);ctx.fill();ctx.restore()};return BulletView}();HudView=function(){function HudView(){this.draw=bind(this.draw,this);this.setScore=bind(this.setScore,this);this.setLives=bind(this.setLives,this)}HudView.prototype.x=0;HudView.prototype.y=0;HudView.prototype.rotation=0;HudView.prototype.score=0;HudView.prototype.lives=3;HudView.prototype.setLives=function(lives){this.lives=lives};HudView.prototype.setScore=function(score){this.score=score};HudView.prototype.draw=function(ctx){var l,s,x,y;ctx.save();ctx.beginPath();ctx.font="bold 18px opendyslexic";ctx.fillStyle="#00FFFF";ctx.textAlign="center";s="LIVES: "+this.lives;l=ctx.measureText(s);x=l.width;y=20;ctx.fillText(s,x,y);ctx.fill();ctx.restore();ctx.save();ctx.beginPath();ctx.font="bold 18px opendyslexic";ctx.fillStyle="#00FFFF";ctx.textAlign="center";s="SCORE: "+this.score;l=ctx.measureText(s);x=window.window.innerWidth*window.devicePixelRatio-l.width;y=20;ctx.fillText(s,x,y);ctx.fill();ctx.restore()};return HudView}();SpaceshipDeathView=function(){function SpaceshipDeathView(){this.draw=bind(this.draw,this)}SpaceshipDeathView.prototype.x=0;SpaceshipDeathView.prototype.y=0;SpaceshipDeathView.prototype.rotation=0;SpaceshipDeathView.prototype.vel1=null;SpaceshipDeathView.prototype.vel2=null;SpaceshipDeathView.prototype.rot1=null;SpaceshipDeathView.prototype.rot2=null;SpaceshipDeathView.prototype.x1=0;SpaceshipDeathView.prototype.y2=0;SpaceshipDeathView.prototype.y1=0;SpaceshipDeathView.prototype.y2=0;SpaceshipDeathView.prototype.first=true;SpaceshipDeathView.prototype.animate=function(time){if(this.first){this.first=false;this.vel1=new Point(rnd.nextDouble()*10-5,rnd.nextDouble()*10+10);this.vel2=new Point(rnd.nextDouble()*10-5,-(rnd.nextDouble()*10+10));this.rot1=rnd.nextDouble()*300-150;this.rot2=rnd.nextDouble()*300-150;this.x1=this.x2=this.x;this.y1=this.y2=this.y;this.r1=this.r2=this.rotation}this.x1+=this.vel1.x*time;this.y1+=this.vel1.y*time;this.r1+=this.rot1*time;this.x2+=this.vel2.x*time;this.y2+=this.vel2.y*time;this.r2+=this.rot2*time};SpaceshipDeathView.prototype.draw=function(ctx){ctx.save();ctx.beginPath();ctx.translate(this.x+this.x1,this.y+this.y1);ctx.rotate(this.r1);ctx.fillStyle="#FFFFFF";ctx.moveTo(10,0);ctx.lineTo(-7,7);ctx.lineTo(-4,0);ctx.lineTo(10,0);ctx.fill();ctx.restore();ctx.save();ctx.beginPath();ctx.translate(this.x+this.x2,this.y+this.y2);ctx.rotate(this.r2);ctx.fillStyle="#FFFFFF";ctx.moveTo(10,0);ctx.lineTo(-7,7);ctx.lineTo(-4,0);ctx.lineTo(10,0);ctx.fill();ctx.restore()};return SpaceshipDeathView}();SpaceshipView=function(){function SpaceshipView(){this.draw=bind(this.draw,this)}SpaceshipView.prototype.x=0;SpaceshipView.prototype.y=0;SpaceshipView.prototype.rotation=0;SpaceshipView.prototype.draw=function(ctx){ctx.save();ctx.beginPath();ctx.translate(this.x,this.y);ctx.rotate(this.rotation);ctx.fillStyle="#FFFFFF";ctx.moveTo(10,0);ctx.lineTo(-7,7);ctx.lineTo(-4,0);ctx.lineTo(-7,-7);ctx.lineTo(10,0);ctx.fill();ctx.restore()};return SpaceshipView}();WaitForStartView=function(){var Signal0;Signal0=ash.signals.Signal0;WaitForStartView.prototype.x=0;WaitForStartView.prototype.y=0;WaitForStartView.prototype.rotation=0;WaitForStartView.prototype.first=true;WaitForStartView.prototype.click=null;function WaitForStartView(){this.draw=bind(this.draw,this);this.click=new Signal0}WaitForStartView.prototype.draw=function(ctx){var l,s,x,y;if(this.first){this.first=false;ctx.canvas.addEventListener("click",function(_this){return function(event){return _this.click.dispatch()}}(this))}ctx.save();ctx.beginPath();ctx.font="bold 40px opendyslexic";ctx.fillStyle="#FFFFFF";s="ASTEROIDS";l=ctx.measureText(s);x=Math.floor((window.innerWidth*window.devicePixelRatio-l.width)/2);y=175;ctx.fillText(s,x,y);ctx.fill();ctx.restore();ctx.save();ctx.beginPath();ctx.font="bold 18px opendyslexic";ctx.fillStyle="#FFFFFF";s="CLICK TO START";l=ctx.measureText(s);x=Math.floor((window.innerWidth*window.devicePixelRatio-l.width)/2);y=225;ctx.fillText(s,x,y);ctx.fill();ctx.restore();ctx.save();ctx.beginPath();ctx.font="bold 14px opendyslexic";ctx.fillStyle="#FFFFFF";s="Z to Fire  ~  Arrow Keys to Move";l=ctx.measureText(s);x=10;y=window.innerHeight*window.devicePixelRatio-20;ctx.fillText(s,x,y);ctx.fill();ctx.restore()};return WaitForStartView}();Animation=function(){Animation.prototype.animation=null;function Animation(animation){this.animation=animation}return Animation}();Asteroid=function(){Asteroid.prototype.fsm=null;function Asteroid(fsm1){this.fsm=fsm1}return Asteroid}();Audio=function(){Audio.prototype.toPlay=null;function Audio(){this.toPlay=[]}Audio.prototype.play=function(sound){return this.toPlay.push(sound)};return Audio}();Bullet=function(){Bullet.prototype.lifeRemaining=0;function Bullet(lifeRemaining){this.lifeRemaining=lifeRemaining}return Bullet}();Collision=function(){Collision.prototype.radius=0;function Collision(radius1){this.radius=radius1}return Collision}();DeathThroes=function(){DeathThroes.prototype.countdown=0;DeathThroes.prototype.body=null;function DeathThroes(duration){this.countdown=duration}return DeathThroes}();Display=function(){Display.prototype.graphic=0;function Display(graphic1){this.graphic=graphic1}return Display}();GameState=function(){function GameState(){}GameState.prototype.lives=3;GameState.prototype.level=0;GameState.prototype.hits=0;GameState.prototype.playing=false;GameState.prototype.setForStart=function(){this.lives=3;this.level=0;this.hits=0;this.playing=true};return GameState}();Gun=function(){Gun.prototype.shooting=false;Gun.prototype.offsetFromParent=null;Gun.prototype.timeSinceLastShot=0;Gun.prototype.offsetFromParent=null;function Gun(offsetX,offsetY,minimumShotInterval,bulletLifetime){this.minimumShotInterval=minimumShotInterval;this.bulletLifetime=bulletLifetime;this.shooting=false;this.offsetFromParent=null;this.timeSinceLastShot=0;this.offsetFromParent=new Point(offsetX,offsetY)}return Gun}();GunControls=function(){GunControls.prototype.trigger=0;function GunControls(trigger){this.trigger=trigger}return GunControls}();Hud=function(){Hud.prototype.view=null;function Hud(view){this.view=view}return Hud}();MotionControls=function(){MotionControls.prototype.left=0;MotionControls.prototype.right=0;MotionControls.prototype.accelerate=0;MotionControls.prototype.accelerationRate=0;MotionControls.prototype.rotationRate=0;function MotionControls(left,right,accelerate,accelerationRate,rotationRate){this.left=left;this.right=right;this.accelerate=accelerate;this.accelerationRate=accelerationRate;this.rotationRate=rotationRate}return MotionControls}();Physics=function(){Physics.prototype.body=null;function Physics(body1){this.body=body1}return Physics}();Position=function(){Position.prototype.position=null;Position.prototype.rotation=0;function Position(x,y,rotation1){this.rotation=rotation1;this.position=new Point(x,y)}return Position}();Spaceship=function(){Spaceship.prototype.fsm=null;function Spaceship(fsm1){this.fsm=fsm1}return Spaceship}();WaitForStart=function(){WaitForStart.prototype.waitForStart=null;WaitForStart.prototype.startGame=false;function WaitForStart(waitForStart){this.waitForStart=waitForStart;this.setStartGame=bind(this.setStartGame,this);this.waitForStart.click.add(this.setStartGame)}WaitForStart.prototype.setStartGame=function(){this.startGame=true};return WaitForStart}();AnimationNode=function(superClass){extend(AnimationNode,superClass);function AnimationNode(){return AnimationNode.__super__.constructor.apply(this,arguments)}AnimationNode.components={animation:Animation};AnimationNode.prototype.animation=null;return AnimationNode}(ash.core.Node);AsteroidCollisionNode=function(superClass){extend(AsteroidCollisionNode,superClass);function AsteroidCollisionNode(){return AsteroidCollisionNode.__super__.constructor.apply(this,arguments)}AsteroidCollisionNode.components={asteroid:Asteroid,position:Position,collision:Collision,physics:Physics};AsteroidCollisionNode.prototype.asteroid=null;AsteroidCollisionNode.prototype.physics=null;return AsteroidCollisionNode}(ash.core.Node);AudioNode=function(superClass){extend(AudioNode,superClass);function AudioNode(){return AudioNode.__super__.constructor.apply(this,arguments)}AudioNode.components={audio:Audio};AudioNode.prototype.audio=null;return AudioNode}(ash.core.Node);BulletAgeNode=function(superClass){extend(BulletAgeNode,superClass);function BulletAgeNode(){return BulletAgeNode.__super__.constructor.apply(this,arguments)}BulletAgeNode.components={bullet:Bullet,physics:Physics};BulletAgeNode.prototype.bullet=null;BulletAgeNode.prototype.physics=null;return BulletAgeNode}(ash.core.Node);BulletCollisionNode=function(superClass){extend(BulletCollisionNode,superClass);function BulletCollisionNode(){return BulletCollisionNode.__super__.constructor.apply(this,arguments)}BulletCollisionNode.components={bullet:Bullet,position:Position,physics:Physics};BulletCollisionNode.prototype.bullet=null;BulletCollisionNode.prototype.physics=null;return BulletCollisionNode}(ash.core.Node);DeathThroesNode=function(superClass){extend(DeathThroesNode,superClass);function DeathThroesNode(){return DeathThroesNode.__super__.constructor.apply(this,arguments)}DeathThroesNode.components={dead:DeathThroes};DeathThroesNode.prototype.dead=null;return DeathThroesNode}(ash.core.Node);GameNode=function(superClass){extend(GameNode,superClass);function GameNode(){return GameNode.__super__.constructor.apply(this,arguments)}GameNode.components={state:GameState};GameNode.prototype.state=null;return GameNode}(ash.core.Node);GunControlNode=function(superClass){extend(GunControlNode,superClass);function GunControlNode(){return GunControlNode.__super__.constructor.apply(this,arguments)}GunControlNode.components={audio:Audio,control:GunControls,gun:Gun,position:Position};GunControlNode.prototype.control=null;GunControlNode.prototype.gun=null;GunControlNode.prototype.position=null;GunControlNode.prototype.audio=null;return GunControlNode}(ash.core.Node);HudNode=function(superClass){extend(HudNode,superClass);function HudNode(){return HudNode.__super__.constructor.apply(this,arguments)}HudNode.components={state:GameState,hud:Hud};HudNode.prototype.state=null;HudNode.prototype.hud=null;return HudNode}(ash.core.Node);MovementNode=function(superClass){extend(MovementNode,superClass);function MovementNode(){return MovementNode.__super__.constructor.apply(this,arguments)}MovementNode.components={position:Position};MovementNode.prototype.position=null;return MovementNode}(ash.core.Node);PhysicsControlNode=function(superClass){extend(PhysicsControlNode,superClass);function PhysicsControlNode(){return PhysicsControlNode.__super__.constructor.apply(this,arguments)}PhysicsControlNode.components={control:MotionControls,physics:Physics};PhysicsControlNode.prototype.control=null;PhysicsControlNode.prototype.physics=null;return PhysicsControlNode}(ash.core.Node);PhysicsNode=function(superClass){extend(PhysicsNode,superClass);function PhysicsNode(){return PhysicsNode.__super__.constructor.apply(this,arguments)}PhysicsNode.components={position:Position,physics:Physics};PhysicsNode.prototype.position=null;PhysicsNode.prototype.physics=null;return PhysicsNode}(ash.core.Node);RenderNode=function(superClass){extend(RenderNode,superClass);function RenderNode(){return RenderNode.__super__.constructor.apply(this,arguments)}RenderNode.components={position:Position,display:Display};RenderNode.prototype.position=null;RenderNode.prototype.display=null;return RenderNode}(ash.core.Node);SpaceshipNode=function(superClass){extend(SpaceshipNode,superClass);function SpaceshipNode(){return SpaceshipNode.__super__.constructor.apply(this,arguments)}SpaceshipNode.components={spaceship:Spaceship,position:Position};SpaceshipNode.prototype.spaceship=0;SpaceshipNode.prototype.position=0;return SpaceshipNode}(ash.core.Node);WaitForStartNode=function(superClass){extend(WaitForStartNode,superClass);function WaitForStartNode(){return WaitForStartNode.__super__.constructor.apply(this,arguments)}WaitForStartNode.components={wait:WaitForStart};WaitForStartNode.prototype.wait=null;return WaitForStartNode}(ash.core.Node);PhysicsSystem=function(superClass){var b2Body,b2Vec2;extend(PhysicsSystem,superClass);b2Body=Box2D.Dynamics.b2Body;b2Vec2=Box2D.Common.Math.b2Vec2;PhysicsSystem.prototype.config=null;PhysicsSystem.prototype.world=null;PhysicsSystem.prototype.creator=null;PhysicsSystem.prototype.nodes=null;PhysicsSystem.deadPool=[];function PhysicsSystem(config,world){this.config=config;this.world=world;this.updateNode=bind(this.updateNode,this);this.update=bind(this.update,this)}PhysicsSystem.prototype.addToEngine=function(engine){this.nodes=engine.getNodeList(PhysicsNode)};PhysicsSystem.prototype.removeFromEngine=function(engine){this.nodes=null};PhysicsSystem.prototype.update=function(time){var body,node,ud;this.world.Step(time,10,10);this.world.ClearForces();node=this.nodes.head;while(node){this.updateNode(node,time);node=node.next}while(body=PhysicsSystem.deadPool.pop()){ud=body.GetUserData();if(ud.entity!=null){delete ud.entity}body.SetUserData(ud);this.world.DestroyBody(body)}};PhysicsSystem.prototype.updateNode=function(node,time){var body,physics,position,ref,x,x1,y,y1;position=node.position;physics=node.physics;body=physics.body;ref=body.GetPosition(),x=ref.x,y=ref.y;x1=x>this.config.width?0:x<0?this.config.width:x;y1=y>this.config.height?0:y<0?this.config.height:y;if(x1!==x||y1!==y){body.SetPosition(new b2Vec2(x1,y1))}position.position.x=x1;position.position.y=y1;position.rotation=body.GetAngularVelocity()};return PhysicsSystem}(ash.core.System);AnimationSystem=function(superClass){extend(AnimationSystem,superClass);function AnimationSystem(){this.updateNode=bind(this.updateNode,this);AnimationSystem.__super__.constructor.call(this,AnimationNode,this.updateNode)}AnimationSystem.prototype.updateNode=function(node,time){node.animation.animation.animate(time)};return AnimationSystem}(ash.tools.ListIteratingSystem);AudioSystem=function(superClass){extend(AudioSystem,superClass);function AudioSystem(){this.updateNode=bind(this.updateNode,this);AudioSystem.__super__.constructor.call(this,AudioNode,this.updateNode)}AudioSystem.prototype.updateNode=function(node,time){var each,ref,sound,type;ref=node.audio.toPlay;for(each in ref){type=ref[each];sound=new type;sound.play(0,1)}node.audio.toPlay.length=0};return AudioSystem}(ash.tools.ListIteratingSystem);BulletAgeSystem=function(superClass){extend(BulletAgeSystem,superClass);BulletAgeSystem.prototype.creator=null;function BulletAgeSystem(creator){this.creator=creator;this.updateNode=bind(this.updateNode,this);BulletAgeSystem.__super__.constructor.call(this,BulletAgeNode,this.updateNode)}BulletAgeSystem.prototype.updateNode=function(node,time){var bullet;bullet=node.bullet;bullet.lifeRemaining-=time;if(bullet.lifeRemaining<=0){PhysicsSystem.deadPool.push(node.physics.body);this.creator.destroyEntity(node.entity)}};return BulletAgeSystem}(ash.tools.ListIteratingSystem);CollisionSystem=function(superClass){var AsteroidHitShip,BulletHitAsteroid,b2ContactListener;extend(CollisionSystem,superClass);b2ContactListener=Box2D.Dynamics.b2ContactListener;BulletHitAsteroid=1;AsteroidHitShip=2;CollisionSystem.prototype.world=null;CollisionSystem.prototype.creator=null;CollisionSystem.prototype.games=null;CollisionSystem.prototype.collisions=null;function CollisionSystem(world,creator){this.world=world;this.creator=creator;this.PostSolve=bind(this.PostSolve,this);this.PreSolve=bind(this.PreSolve,this);this.EndContact=bind(this.EndContact,this);this.BeginContact=bind(this.BeginContact,this);this.update=bind(this.update,this);this.collisions=[];this.world.SetContactListener(this)}CollisionSystem.prototype.update=function(time){var a,b,body,position,radius,ref,type;while(this.collisions.length){ref=this.collisions.pop(),type=ref.type,a=ref.a,b=ref.b;if(type===BulletHitAsteroid){if(a.get(Physics)!=null){this.creator.destroyEntity(a);PhysicsSystem.deadPool.push(a.get(Physics).body)}if(b.get(Physics)!=null){radius=b.get(Collision).radius;position=b.get(Position).position;if(radius>10){this.creator.createAsteroid(radius-10,position.x+rnd.nextDouble()*10-5,position.y+rnd.nextDouble()*10-5);this.creator.createAsteroid(radius-10,position.x+rnd.nextDouble()*10-5,position.y+rnd.nextDouble()*10-5)}body=b.get(Physics).body;b.get(Asteroid).fsm.changeState("destroyed");b.get(DeathThroes).body=body;if(this.games.head){this.games.head.state.hits++}}}else if(type===AsteroidHitShip){if(b.get(Physics)!=null){body=b.get(Physics).body;b.get(Spaceship).fsm.changeState("destroyed");b.get(DeathThroes).body=body;if(this.games.head){this.games.head.state.lives--}}}}};CollisionSystem.prototype.addToEngine=function(engine){this.games=engine.getNodeList(GameNode)};CollisionSystem.prototype.removeFromEngine=function(engine){this.games=null};CollisionSystem.prototype.BeginContact=function(contact){var a,b;a=contact.GetFixtureA().GetBody().GetUserData();b=contact.GetFixtureB().GetBody().GetUserData();switch(a.type){case"asteroid":switch(b.type){case"bullet":this.collisions.push({type:BulletHitAsteroid,a:b.entity,b:a.entity});break;case"spaceship":this.collisions.push({type:AsteroidHitShip,a:a.entity,b:b.entity})}break;case"bullet":if(b.type==="asteroid"){this.collisions.push({type:BulletHitAsteroid,a:a.entity,b:b.entity})}break;case"spaceship":if(b.type==="asteroid"){this.collisions.push({type:AsteroidHitShip,a:b.entity,b:a.entity})}}};CollisionSystem.prototype.EndContact=function(contact){};CollisionSystem.prototype.PreSolve=function(contact,oldManifold){};CollisionSystem.prototype.PostSolve=function(contact,impulse){};return CollisionSystem}(ash.core.System);DeathThroesSystem=function(superClass){extend(DeathThroesSystem,superClass);DeathThroesSystem.prototype.creator=null;function DeathThroesSystem(creator){this.creator=creator;this.updateNode=bind(this.updateNode,this);DeathThroesSystem.__super__.constructor.call(this,DeathThroesNode,this.updateNode)}DeathThroesSystem.prototype.updateNode=function(node,time){var dead;dead=node.dead;dead.countdown-=time;if(dead.countdown<=0){this.creator.destroyEntity(node.entity);PhysicsSystem.deadPool.push(dead.body)}};return DeathThroesSystem}(ash.tools.ListIteratingSystem);GameManager=function(superClass){extend(GameManager,superClass);GameManager.prototype.config=null;GameManager.prototype.creator=null;GameManager.prototype.gameNodes=null;GameManager.prototype.spaceships=null;GameManager.prototype.asteroids=null;GameManager.prototype.bullets=null;function GameManager(creator,config){this.creator=creator;this.config=config;this.update=bind(this.update,this)}GameManager.prototype.addToEngine=function(engine){this.gameNodes=engine.getNodeList(GameNode);this.spaceships=engine.getNodeList(SpaceshipNode);this.asteroids=engine.getNodeList(AsteroidCollisionNode);this.bullets=engine.getNodeList(BulletCollisionNode)};GameManager.prototype.update=function(time){var asteroid,asteroidCount,clearToAddSpaceship,i,newSpaceshipPosition,node,position,spaceship;node=this.gameNodes.head;if(node&&node.state.playing){if(this.spaceships.empty){if(node.state.lives>0){newSpaceshipPosition=new Point(this.config.width*.5,this.config.height*.5);clearToAddSpaceship=true;asteroid=this.asteroids.head;while(asteroid){if(Point.distance(asteroid.position.position,newSpaceshipPosition)<=asteroid.collision.radius+50){clearToAddSpaceship=false;break}asteroid=asteroid.next}if(clearToAddSpaceship){this.creator.createSpaceship()}}else{node.state.playing=false;this.creator.createWaitForClick()}}if(this.asteroids.empty&&this.bullets.empty&&!this.spaceships.empty){spaceship=this.spaceships.head;node.state.level++;asteroidCount=2+node.state.level;i=0;while(i<asteroidCount){while(true){position=new Point(rnd.nextDouble()*this.config.width,rnd.nextDouble()*this.config.height);if(!(Point.distance(position,spaceship.position.position)<=80)){break}}this.creator.createAsteroid(30,position.x,position.y);++i}}}};GameManager.prototype.removeFromEngine=function(engine){this.gameNodes=null;this.spaceships=null;this.asteroids=null;this.bullets=null};return GameManager}(ash.core.System);GunControlSystem=function(superClass){extend(GunControlSystem,superClass);GunControlSystem.prototype.keyPoll=null;GunControlSystem.prototype.creator=null;function GunControlSystem(keyPoll,creator){this.keyPoll=keyPoll;this.creator=creator;this.updateNode=bind(this.updateNode,this);GunControlSystem.__super__.constructor.call(this,GunControlNode,this.updateNode)}GunControlSystem.prototype.updateNode=function(node,time){var control,gun,position;control=node.control;position=node.position;gun=node.gun;gun.shooting=this.keyPoll.isDown(control.trigger);gun.timeSinceLastShot+=time;if(gun.shooting&&gun.timeSinceLastShot>=gun.minimumShotInterval){this.creator.createUserBullet(gun,position);gun.timeSinceLastShot=0}};return GunControlSystem}(ash.tools.ListIteratingSystem);HudSystem=function(superClass){extend(HudSystem,superClass);function HudSystem(){this.updateNode=bind(this.updateNode,this);HudSystem.__super__.constructor.call(this,HudNode,this.updateNode)}HudSystem.prototype.updateNode=function(node,time){node.hud.view.setLives(node.state.lives);node.hud.view.setScore(node.state.hits)};return HudSystem}(ash.tools.ListIteratingSystem);PhysicsControlSystem=function(superClass){var b2Vec2;extend(PhysicsControlSystem,superClass);b2Vec2=Box2D.Common.Math.b2Vec2;PhysicsControlSystem.prototype.keyPoll=null;function PhysicsControlSystem(keyPoll){this.keyPoll=keyPoll;this.updateNode=bind(this.updateNode,this);PhysicsControlSystem.__super__.constructor.call(this,PhysicsControlNode,this.updateNode)}PhysicsControlSystem.prototype.updateNode=function(node,time){var body,control,ref,rotation,x,y;control=node.control;body=node.physics.body;rotation=body.GetAngularVelocity();if(this.keyPoll.isDown(control.left)&&rotation<10){body.ApplyTorque(rotation/1e3-control.rotationRate/Math.PI*time)}if(this.keyPoll.isDown(control.right)&&rotation<10){body.ApplyTorque(rotation/1e3+control.rotationRate/Math.PI*time)}if(this.keyPoll.isDown(control.accelerate)){ref=body.GetLinearVelocity(),x=ref.x,y=ref.y;x+=Math.cos(rotation)*control.accelerationRate*time;y+=Math.sin(rotation)*control.accelerationRate*time;body.ApplyForce(new b2Vec2(x,y),body.GetWorldCenter())}};return PhysicsControlSystem}(ash.tools.ListIteratingSystem);RenderSystem=function(superClass){extend(RenderSystem,superClass);RenderSystem.prototype.graphic=null;RenderSystem.prototype.nodes=null;function RenderSystem(ctx1){this.ctx=ctx1;this.update=bind(this.update,this)}RenderSystem.prototype.addToEngine=function(engine){var node;this.nodes=engine.getNodeList(RenderNode);node=this.nodes.head;while(node){this.addToDisplay(node);node=node.next}};RenderSystem.prototype.addToDisplay=function(node){};RenderSystem.prototype.removeFromDisplay=function(node){};RenderSystem.prototype.removeFromEngine=function(engine){this.nodes=null};RenderSystem.prototype.update=function(time){var display,graphic,node,position;this.ctx.save();this.ctx.translate(0,0);this.ctx.rotate(0);this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);node=this.nodes.head;while(node){display=node.display;graphic=display.graphic;position=node.position;graphic.x=position.position.x;graphic.y=position.position.y;graphic.rotation=position.rotation;graphic.draw(this.ctx);node=node.next}this.ctx.restore()};return RenderSystem}(ash.core.System);SystemPriorities=function(){function SystemPriorities(){}SystemPriorities.preUpdate=1;SystemPriorities.update=2;SystemPriorities.move=3;SystemPriorities.resolveCollisions=4;SystemPriorities.stateMachines=5;SystemPriorities.animate=6;SystemPriorities.render=7;return SystemPriorities}();WaitForStartSystem=function(superClass){extend(WaitForStartSystem,superClass);WaitForStartSystem.prototype.engine=null;WaitForStartSystem.prototype.creator=null;WaitForStartSystem.prototype.gameNodes=null;WaitForStartSystem.prototype.waitNodes=null;WaitForStartSystem.prototype.asteroids=null;function WaitForStartSystem(creator){this.creator=creator;this.update=bind(this.update,this)}WaitForStartSystem.prototype.addToEngine=function(engine){this.engine=engine;this.waitNodes=engine.getNodeList(WaitForStartNode);
this.gameNodes=engine.getNodeList(GameNode);this.asteroids=engine.getNodeList(AsteroidCollisionNode)};WaitForStartSystem.prototype.removeFromEngine=function(engine){this.waitNodes=null;this.gameNodes=null};WaitForStartSystem.prototype.update=function(time){var asteroid,game,node;node=this.waitNodes.head;game=this.gameNodes.head;if(node&&node.wait.startGame&&game){asteroid=this.asteroids.head;while(asteroid){this.creator.destroyEntity(asteroid.entity);asteroid=asteroid.next}game.state.setForStart();node.wait.startGame=false;this.engine.removeEntity(node.entity)}};return WaitForStartSystem}(ash.core.System);EntityCreator=function(){var Entity,EntityStateMachine,KEY_LEFT,KEY_RIGHT,KEY_UP,KEY_Z,b2Body,b2BodyDef,b2CircleShape,b2FixtureDef,b2PolygonShape,b2Vec2;Entity=ash.core.Entity;EntityStateMachine=ash.fsm.EntityStateMachine;b2Body=Box2D.Dynamics.b2Body;b2BodyDef=Box2D.Dynamics.b2BodyDef;b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;b2FixtureDef=Box2D.Dynamics.b2FixtureDef;b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;b2Vec2=Box2D.Common.Math.b2Vec2;KEY_LEFT=37;KEY_UP=38;KEY_RIGHT=39;KEY_Z=90;EntityCreator.prototype.engine=null;EntityCreator.prototype.world=null;EntityCreator.prototype.waitEntity=null;EntityCreator.prototype.bulletId=0;EntityCreator.prototype.asteroidId=0;EntityCreator.prototype.spaceshipId=0;function EntityCreator(engine1,world,config){this.engine=engine1;this.world=world;this.config=config}EntityCreator.prototype.destroyEntity=function(entity){this.engine.removeEntity(entity)};EntityCreator.prototype.createGame=function(){var gameEntity,hud;hud=new HudView;gameEntity=new Entity("game").add(new GameState).add(new Hud(hud)).add(new Display(hud)).add(new Position(0,0,0,0));this.engine.addEntity(gameEntity);return gameEntity};EntityCreator.prototype.createWaitForClick=function(){var waitView;if(!this.waitEntity){waitView=new WaitForStartView;this.waitEntity=new Entity("wait").add(new WaitForStart(waitView)).add(new Display(waitView)).add(new Position(0,0,0,0))}this.waitEntity.get(WaitForStart).startGame=false;this.engine.addEntity(this.waitEntity);return this.waitEntity};EntityCreator.prototype.createAsteroid=function(radius,x,y){var asteroid,body,bodyDef,deathView,fixDef,fsm;bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=true;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set((rnd.nextDouble()-.5)*4*(50-radius),(rnd.nextDouble()-.5)*4*(50-radius));bodyDef.angularVelocity=rnd.nextDouble()*2-1;fixDef=new b2FixtureDef;fixDef.density=1;fixDef.friction=1;fixDef.restitution=.2;fixDef.shape=new b2CircleShape(radius);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);asteroid=new Entity;fsm=new EntityStateMachine(asteroid);fsm.createState("alive").add(Physics).withInstance(new Physics(body)).add(Collision).withInstance(new Collision(radius)).add(Display).withInstance(new Display(new AsteroidView(radius)));deathView=new AsteroidDeathView(radius);fsm.createState("destroyed").add(DeathThroes).withInstance(new DeathThroes(3)).add(Display).withInstance(new Display(deathView)).add(Animation).withInstance(new Animation(deathView));asteroid.add(new Asteroid(fsm)).add(new Position(x,y,0)).add(new Audio);body.SetUserData({type:"asteroid",entity:asteroid});fsm.changeState("alive");this.engine.addEntity(asteroid);return asteroid};EntityCreator.prototype.createSpaceship=function(){var body,bodyDef,deathView,fixDef,fsm,spaceship,x,y;x=rnd.nextInt(this.config.width);y=rnd.nextInt(this.config.height);bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=false;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set(0,0);bodyDef.angularVelocity=0;bodyDef.linearDamping=.75;fixDef=new b2FixtureDef;fixDef.density=1;fixDef.friction=1;fixDef.restitution=.2;fixDef.shape=new b2PolygonShape;fixDef.shape.SetAsArray([new b2Vec2(.45,0),new b2Vec2(-.25,.25),new b2Vec2(-.25,-.25)],3);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);spaceship=new Entity;fsm=new EntityStateMachine(spaceship);fsm.createState("playing").add(Physics).withInstance(new Physics(body)).add(MotionControls).withInstance(new MotionControls(KEY_LEFT,KEY_RIGHT,KEY_UP,100,3)).add(Gun).withInstance(new Gun(8,0,.3,2)).add(GunControls).withInstance(new GunControls(KEY_Z)).add(Collision).withInstance(new Collision(9)).add(Display).withInstance(new Display(new SpaceshipView));deathView=new SpaceshipDeathView;fsm.createState("destroyed").add(DeathThroes).withInstance(new DeathThroes(5)).add(Display).withInstance(new Display(deathView)).add(Animation).withInstance(new Animation(deathView));spaceship.add(new Spaceship(fsm)).add(new Position(x,y,0)).add(new Audio);body.SetUserData({type:"spaceship",entity:spaceship});fsm.changeState("playing");this.engine.addEntity(spaceship);return spaceship};EntityCreator.prototype.createUserBullet=function(gun,parentPosition){var body,bodyDef,bullet,cos,fixDef,sin,x,y;cos=Math.cos(parentPosition.rotation);sin=Math.sin(parentPosition.rotation);x=cos*gun.offsetFromParent.x-sin*gun.offsetFromParent.y+parentPosition.position.x;y=sin*gun.offsetFromParent.x+cos*gun.offsetFromParent.y+parentPosition.position.y;bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=true;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set(cos*150,sin*150);bodyDef.angularVelocity=0;fixDef=new b2FixtureDef;fixDef.density=1;fixDef.friction=0;fixDef.restitution=.2;fixDef.shape=new b2CircleShape(0);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);bullet=(new Entity).add(new Bullet(gun.bulletLifetime)).add(new Position(x,y,0)).add(new Collision(0)).add(new Physics(body)).add(new Display(new BulletView));body.SetUserData({type:"bullet",entity:bullet});this.engine.addEntity(bullet);return bullet};return EntityCreator}();GameConfig=function(){function GameConfig(){}GameConfig.prototype.width=0;GameConfig.prototype.height=0;return GameConfig}();Asteroids=function(){var Engine,FrameTickProvider,b2DebugDraw,b2Vec2,b2World;b2Vec2=Box2D.Common.Math.b2Vec2;b2World=Box2D.Dynamics.b2World;b2DebugDraw=Box2D.Dynamics.b2DebugDraw;Engine=ash.core.Engine;FrameTickProvider=ash.tick.FrameTickProvider;Asteroids.prototype.container=null;Asteroids.prototype.engine=null;Asteroids.prototype.tickProvider=null;Asteroids.prototype.creator=null;Asteroids.prototype.keyPoll=null;Asteroids.prototype.config=null;Asteroids.prototype.world=null;function Asteroids(container,width,height){this.container=container;this.prepare(width,height)}Asteroids.prototype.prepare=function(width,height){this.config=new GameConfig;this.config.height=height;this.config.width=width;this.world=new b2World(new b2Vec2(0,0),true);this.engine=new Engine;this.creator=new EntityCreator(this.engine,this.world,this.config);this.keyPoll=new KeyPoll(window);this.engine.addSystem(new WaitForStartSystem(this.creator),SystemPriorities.preUpdate);this.engine.addSystem(new GameManager(this.creator,this.config),SystemPriorities.preUpdate);this.engine.addSystem(new PhysicsControlSystem(this.keyPoll),SystemPriorities.update);this.engine.addSystem(new GunControlSystem(this.keyPoll,this.creator),SystemPriorities.update);this.engine.addSystem(new BulletAgeSystem(this.creator),SystemPriorities.update);this.engine.addSystem(new DeathThroesSystem(this.creator),SystemPriorities.update);this.engine.addSystem(new PhysicsSystem(this.config,this.world),SystemPriorities.move);this.engine.addSystem(new CollisionSystem(this.world,this.creator),SystemPriorities.resolveCollisions);this.engine.addSystem(new AnimationSystem,SystemPriorities.animate);this.engine.addSystem(new HudSystem,SystemPriorities.animate);this.engine.addSystem(new RenderSystem(this.container),SystemPriorities.render);this.engine.addSystem(new AudioSystem,SystemPriorities.render);this.creator.createWaitForClick();this.creator.createGame()};Asteroids.prototype.start=function(){var stats,x,y;if(navigator.isCocoonJS){stats=null}else{x=Math.floor(this.config.width/2)-40;y=0;stats=new Stats;stats.setMode(0);stats.domElement.style.position="absolute";stats.domElement.style.left=x+"px";stats.domElement.style.top=y+"px";document.body.appendChild(stats.domElement)}this.tickProvider=new FrameTickProvider(stats);this.tickProvider.add(this.engine.update);this.tickProvider.start()};Asteroids.main=function(){var asteroids,canvas;window.rnd=new MersenneTwister;canvas=document.createElement(navigator.isCocoonJS?"screencanvas":"canvas");canvas.width=window.innerWidth*window.devicePixelRatio;canvas.height=window.innerHeight*window.devicePixelRatio;canvas.style.width="100%";canvas.style.height="100%";canvas.style.backgroundColor="#6A5ACD";document.body.appendChild(canvas);asteroids=new Asteroids(canvas.getContext("2d"),canvas.width,canvas.height);asteroids.start()};return Asteroids}();if(typeof module!=="undefined"&&module!==null){module.exports=Asteroids}else{window.Asteroids=Asteroids}}).call(this);