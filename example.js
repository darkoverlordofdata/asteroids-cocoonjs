(function(){Cocoon=window.Cocoon?window.Cocoon:{};Cocoon.version="3.0.5";Cocoon.nativeAvailable=!!window.ext;Cocoon.extend=function(subc,superc){var subcp=subc.prototype;var CocoonJSExtendHierarchyChainClass=function(){};CocoonJSExtendHierarchyChainClass.prototype=superc.prototype;subc.prototype=new CocoonJSExtendHierarchyChainClass;subc.superclass=superc.prototype;subc.prototype.constructor=subc;if(superc.prototype.constructor===Object.prototype.constructor){superc.prototype.constructor=superc}for(var method in subcp){if(subcp.hasOwnProperty(method)){subc.prototype[method]=subcp[method]}}};Cocoon.clone=function(obj,copy){if(null==obj||"object"!=typeof obj)return obj;var arr=[];for(var attr in obj){if(copy.hasOwnProperty(attr)){arr.push(copy[attr])}else{arr.push(obj[attr])}}return arr};Cocoon.callNative=function(nativeExtensionObjectName,nativeFunctionName,args,async){if(Cocoon.nativeAvailable){var argumentsArray=Array.prototype.slice.call(args);argumentsArray.unshift(nativeFunctionName);var nativeExtensionObject=ext[nativeExtensionObjectName];var makeCallFunction=async?nativeExtensionObject.makeCallAsync:nativeExtensionObject.makeCall;var ret=makeCallFunction.apply(nativeExtensionObject,argumentsArray);var finalRet=ret;if(typeof ret==="string"){try{finalRet=JSON.parse(ret)}catch(error){console.log(error)}}return finalRet}};Cocoon.getObjectFromPath=function(baseObject,objectPath){var parts=objectPath.split(".");var obj=baseObject;for(var i=0,len=parts.length;i<len;++i){obj[parts[i]]=obj[parts[i]]||undefined;obj=obj[parts[i]]}return obj};Cocoon.EventHandler=function(nativeExtensionObjectName,CocoonExtensionObjectName,nativeEventName,chainFunction){this.listeners=[];this.listenersOnce=[];this.chainFunction=chainFunction;this.addEventListener=function(listener){if(chainFunction){var f=function(){chainFunction.call(this,arguments.callee.sourceListener,Array.prototype.slice.call(arguments))};listener.CocoonEventHandlerChainFunction=f;f.sourceListener=listener;listener=f}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject&&CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].addEventListener(nativeEventName,listener)}else{var indexOfListener=this.listeners.indexOf(listener);if(indexOfListener<0){this.listeners.push(listener)}}};this.addEventListenerOnce=function(listener){if(chainFunction){var f=function(){chainFunction(arguments.callee.sourceListener,Array.prototype.slice.call(arguments))};f.sourceListener=listener;listener=f}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].addEventListenerOnce(nativeEventName,listener)}else{var indexOfListener=this.listeners.indexOf(listener);if(indexOfListener<0){this.listenersOnce.push(listener)}}};this.removeEventListener=function(listener){if(chainFunction){listener=listener.CocoonEventHandlerChainFunction;delete listener.CocoonEventHandlerChainFunction}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].removeEventListener(nativeEventName,listener)}else{var indexOfListener=this.listeners.indexOf(listener);if(indexOfListener>=0){this.listeners.splice(indexOfListener,1)}}};this.removeEventListenerOnce=function(listener){if(chainFunction){listener=listener.CocoonEventHandlerChainFunction;delete listener.CocoonEventHandlerChainFunction}var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].removeEventListenerOnce(nativeEventName,listener)}else{var indexOfListener=this.listenersOnce.indexOf(listener);if(indexOfListener>=0){this.listenersOnce.splice(indexOfListener,1)}}};this.notifyEventListeners=function(){var CocoonExtensionObject=Cocoon.getObjectFromPath(Cocoon,CocoonExtensionObjectName);if(CocoonExtensionObject&&CocoonExtensionObject.nativeAvailable){ext[nativeExtensionObjectName].notifyEventListeners(nativeEventName)}else{var argumentsArray=Array.prototype.slice.call(arguments);var listeners=Array.prototype.slice.call(this.listeners);var listenersOnce=Array.prototype.slice.call(this.listenersOnce);var _this=this;setTimeout(function(){for(var i=0;i<listeners.length;i++){listeners[i].apply(_this,argumentsArray)}for(var i=0;i<listenersOnce.length;i++){listenersOnce[i].apply(_this,argumentsArray)}},0);_this.listenersOnce=[]}};return this};Cocoon.define=function(extName,ext){var namespace=extName.substring(0,7)=="Cocoon."?extName.substr(7):extName;var base=window.Cocoon;var parts=namespace.split(".");var object=base;for(var i=0;i<parts.length;i++){var part=parts[i];!object[part]?console.log("Created namespace: "+extName):console.log("Updated namespace: - "+extName);object=object[part]=i==parts.length-1?ext(object[part]||{}):{};if(!object){throw"Unable to create class "+extName}}return true};console.log("Created namespace: Cocoon")})();Cocoon.define("Cocoon.Signal",function(extension){"use strict";extension.createSignal=function(){this.handle=null;this.signals={};this.register=function(namespace,handle){if(!namespace&&!handle)throw new Error("Can't create signal "+(namespace||""));if(handle.addEventListener){this.signals[namespace]=handle;return true}if(!handle.addEventListener){this.signals[namespace]={};for(var prop in handle){if(handle.hasOwnProperty(prop)){this.signals[namespace][prop]=handle[prop]}}return true}throw new Error("Can't create handler for "+namespace+" signal.");return false},this.expose=function(){return function(signal,callback,params){var once=false;if(arguments.length===1){var that=this;var fnc=function(signal){this.signal=signal};fnc.prototype.remove=function(functionListener){var handle=that.signals[this.signal];if(handle&&handle.removeEventListener){handle.removeEventListener.apply(that,[functionListener]);that.signals[this.signal]=undefined}};return new fnc(signal)}if(params&&params.once){once=true}if(!this.signals[signal])throw new Error("The signal "+signal+" does not exists.");var handle=this.signals[signal];if(handle.addEventListener){if(once){handle.addEventListenerOnce(function(){callback.apply(this||window,arguments)})}else{handle.addEventListener(function(){callback.apply(this||window,arguments)})}}if(!this.signals[signal].addEventListener){for(var prop in this.signals[signal]){if(!this.signals[signal].hasOwnProperty(prop))continue;var handle=this.signals[signal][prop];if(once){handle.addEventListenerOnce(function(){this.clbk[this.name].apply(this||window,arguments)}.bind({name:prop,clbk:callback}))}else{handle.addEventListener(function(){this.clbk[this.name].apply(this||window,arguments)}.bind({name:prop,clbk:callback}))}}}}.bind(this)}};return extension});Cocoon.define("Cocoon.App",function(extension){extension.nativeAvailable=!!window.ext&&!!window.ext.IDTK_APP;extension.isBridgeAvailable=function(){if(Cocoon.App.forward.nativeAvailable==="boolean"){return Cocoon.App.forward.nativeAvailable}else{var available=Cocoon.callNative("IDTK_APP","forwardAvailable",arguments);available=!!available;Cocoon.App.forward.nativeAvailable=available;return available}};extension.forward=function(javaScriptCode){if(Cocoon.App.nativeAvailable&&Cocoon.App.isBridgeAvailable()){return Cocoon.callNative("IDTK_APP","forward",arguments)}else if(!navigator.isCocoonJS){if(window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"){return window.parent.eval(javaScriptCode)}else{return window.frames["CocoonJS_App_ForCocoonJS_WebViewIFrame"].window.eval(javaScriptCode)}}};extension.forwardAsync=function(javaScriptCode,returnCallback){if(Cocoon.App.nativeAvailable&&Cocoon.App.isBridgeAvailable()){if(typeof returnCallback!=="undefined"){return ext.IDTK_APP.makeCallAsync("forward",javaScriptCode,returnCallback)}else{return ext.IDTK_APP.makeCallAsync("forward",javaScriptCode)}}else{setTimeout(function(){var res;window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"?(res=window.parent.eval(javaScriptCode),typeof returnCallback==="function"&&returnCallback(res)):(res=window.parent.frames["CocoonJS_App_ForCocoonJS_WebViewIFrame"].window.eval(javaScriptCode),typeof returnCallback==="function"&&returnCallback(res))},1)}};extension.load=function(path,storageType){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","loadPath",arguments)}else if(!navigator.isCocoonJS){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(event){if(xhr.readyState===4){if(xhr.status===200){var jsCode;if(!Cocoon.App.EmulatedWebViewIFrame){jsCode="window.Cocoon && window.Cocoon.App.onLoadInTheWebViewSucceed.notifyEventListeners('"+path+"');"}else{jsCode="window.Cocoon && window.Cocoon.App.onLoadInCocoonJSSucceed.notifyEventListeners('"+path+"');"}Cocoon.App.forwardAsync(jsCode);window.location.href=path}else if(xhr.status===404){this.onreadystatechange=null;var jsCode;if(!Cocoon.App.EmulatedWebViewIFrame){jsCode="Cocoon && Cocoon.App.onLoadInTheWebViewFailed.notifyEventListeners('"+path+"');"}else{jsCode="Cocoon && Cocoon.App.onLoadInCocoonJSFailed.notifyEventListeners('"+path+"');"}Cocoon.App.forwardAsync(jsCode)}}};xhr.open("GET",path,true);xhr.send()}};extension.reload=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","reload",arguments)}else if(!navigator.isCocoonJS){if(window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"){return window.parent.location.reload()}else{return window.parent.frames["CocoonJS_App_ForCocoonJS_WebViewIFrame"].window.location.reload()}}};extension.openURL=function(url){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","openURL",arguments,true)}else if(!navigator.isCocoonJS){window.open(url,"_blank")}};extension.exit=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","forceToFinish",arguments)}else if(!navigator.isCocoonJS){window.close()}};extension.StorageType={APP_STORAGE:"APP_STORAGE",INTERNAL_STORAGE:"INTERNAL_STORAGE",EXTERNAL_STORAGE:"EXTERNAL_STORAGE",TEMPORARY_STORAGE:"TEMPORARY_STORAGE"};extension.onSuspended=new Cocoon.EventHandler("IDTK_APP","App","onsuspended");extension.onActivated=new Cocoon.EventHandler("IDTK_APP","App","onactivated");extension.onSuspending=new Cocoon.EventHandler("IDTK_APP","App","onsuspending");extension.onMemoryWarning=new Cocoon.EventHandler("IDTK_APP","App","onmemorywarning");var signal=new Cocoon.Signal.createSignal;signal.register("suspended",extension.onSuspended);signal.register("activated",extension.onActivated);signal.register("suspending",extension.onSuspending);signal.register("memorywarning",extension.onMemoryWarning);extension.on=signal.expose();return extension});Cocoon.define("Cocoon.App",function(extension){function checkEmulatedWebViewReady(){var emulatedWB=Cocoon.App.EmulatedWebView;if(emulatedWB){return}emulatedWB=document.createElement("div");emulatedWB.setAttribute("id","CocoonJS_App_ForCocoonJS_WebViewDiv");emulatedWB.style.width=0;emulatedWB.style.height=0;emulatedWB.style.position="absolute";emulatedWB.style.left=0;emulatedWB.style.top=0;emulatedWB.style.backgroundColor="transparent";emulatedWB.style.border="0px solid #000";var frame=document.createElement("IFRAME");frame.setAttribute("id","CocoonJS_App_ForCocoonJS_WebViewIFrame");frame.setAttribute("name","CocoonJS_App_ForCocoonJS_WebViewIFrame");frame.style.width=0;frame.style.height=0;frame.frameBorder=0;frame.allowtransparency=true;emulatedWB.appendChild(frame);Cocoon.App.EmulatedWebView=emulatedWB;Cocoon.App.EmulatedWebViewIFrame=frame;if(!document.body){document.body=document.createElement("body")}document.body.appendChild(Cocoon.App.EmulatedWebView)}extension.pause=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","pause",arguments)}};extension.resume=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","resume",arguments)}};extension.loadInTheWebView=function(path,storageType){if(navigator.isCocoonJS&&Cocoon.App.nativeAvailable){Cocoon.callNative("IDTK_APP","loadInTheWebView",arguments)}else{var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(event){if(xhr.readyState===4){if(xhr.status>=200&&xhr.status<=299||xhr.status===0){checkEmulatedWebViewReady();var callback=function(event){Cocoon.App.onLoadInTheWebViewSucceed.notifyEventListeners(path);Cocoon.App.EmulatedWebViewIFrame.removeEventListener("load",callback)};Cocoon.App.EmulatedWebViewIFrame.addEventListener("load",callback);Cocoon.App.EmulatedWebViewIFrame.contentWindow.location.href=path}else{this.onreadystatechange=null;Cocoon.App.onLoadInTheWebViewFailed.notifyEventListeners(path)}}};xhr.open("GET",path,true);xhr.send()}};extension.reloadWebView=function(){if(Cocoon.App.nativeAvailable&&navigator.isCocoonJS){Cocoon.callNative("IDTK_APP","reloadWebView",arguments)}else{checkEmulatedWebViewReady();Cocoon.App.EmulatedWebViewIFrame.contentWindow.location.reload()}};extension.showTheWebView=function(x,y,width,height){if(Cocoon.App.nativeAvailable&&navigator.isCocoonJS){Cocoon.callNative("IDTK_APP","showTheWebView",arguments)}else{checkEmulatedWebViewReady();Cocoon.App.EmulatedWebViewIFrame.style.width=(width?width/window.devicePixelRatio:window.innerWidth)+"px";Cocoon.App.EmulatedWebViewIFrame.style.height=(height?height/window.devicePixelRatio:window.innerHeight)+"px";Cocoon.App.EmulatedWebView.style.left=(x?x:0)+"px";Cocoon.App.EmulatedWebView.style.top=(y?y:0)+"px";Cocoon.App.EmulatedWebView.style.width=(width?width/window.devicePixelRatio:window.innerWidth)+"px";Cocoon.App.EmulatedWebView.style.height=(height?height/window.devicePixelRatio:window.innerHeight)+"px";Cocoon.App.EmulatedWebView.style.display="block"}};extension.hideTheWebView=function(){if(Cocoon.App.nativeAvailable&&navigator.isCocoonJS){var javaScriptCodeToForward="ext.IDTK_APP.makeCall('hide');";return Cocoon.App.forwardAsync(javaScriptCodeToForward)}else{checkEmulatedWebViewReady();Cocoon.App.EmulatedWebView.style.display="none"}};extension.exitCallback=function(appShouldFinishCallback){if(navigator.isCocoonJS&&Cocoon.App.nativeAvailable){window.onidtkappfinish=appShouldFinishCallback}};extension.forwardedEventFromTheWebView=function(eventName,eventDataString){var eventData=JSON.parse(eventDataString);eventData.target=window;var event=new Event(eventName);for(var att in eventData){event[att]=eventData[att]}event.target=window;window.dispatchEvent(event);var canvases=document.getElementsByTagName("canvas");for(var i=0;i<canvases.length;i++){event.target=canvases[i];canvases[i].dispatchEvent(event)}};extension.onLoadInTheWebViewSucceed=new Cocoon.EventHandler("IDTK_APP","App","forwardpageload");extension.onLoadInTheWebViewFailed=new Cocoon.EventHandler("IDTK_APP","App","forwardpagefail");var signal=new Cocoon.Signal.createSignal;signal.register("load",{success:extension.onLoadInTheWebViewSucceed,error:extension.onLoadInTheWebViewFailed});extension.WebView=Cocoon.WebView||{};extension.WebView.on=signal.expose();return extension});Cocoon.define("Cocoon.Utils",function(extension){"use strict";extension.logMemoryInfo=function(){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","logMemoryInfo",arguments)}};extension.textureReduction=function(sizeThreshold,applyTo,forbidFor){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","setDefaultTextureReducerThreshold",arguments)}};extension.markAsMusic=function(audioFilePath){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","addForceMusic",arguments)}};extension.captureScreen=function(fileName,storageType,captureType,saveToGallery){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","captureScreen",arguments)}};extension.captureScreenAsync=function(fileName,storageType,captureType,saveToGallery,callback){if(Cocoon.nativeAvailable){Cocoon.callNative("IDTK_APP","captureScreen",arguments,true)}};extension.setAntialias=function(enable){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","setDefaultAntialias",arguments)}};extension.setWebGLEnabled=function(enabled){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","setDefaultAntialias",arguments)}};extension.setNPOTEnabled=function(enabled){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return window.ext.IDTK_APP.makeCall("setNPOTEnabled",enabled)}};extension.setMaxMemory=function(memoryInMBs){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return window.ext.IDTK_APP.makeCall("setMaxMemory",memoryInMBs)}};extension.CaptureType={EVERYTHING:0,COCOONJS_GL_SURFACE:1,JUST_SYSTEM_VIEWS:2};extension.existsPath=function(path,storageType){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","existsPath",arguments)}return false};extension.setTextCacheSize=function(size){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_APP","setTextCacheSize",arguments)}};return extension});Cocoon.define("Cocoon.Dialog",function(extension){"use strict";extension.keyboardType={TEXT:"text",NUMBER:"num",PHONE:"phone",EMAIL:"email",URL:"url"};extension.prompt=function(params,callbacks){if(!callbacks)throw"Callback missing for Cocoon.Dialog.prompt();";var defaultKeyboard=Cocoon.Dialog.keyboardType.TEXT;switch(params.type){case Cocoon.Dialog.keyboardType.TEXT:defaultKeyboard=Cocoon.Dialog.keyboardType.TEXT;break;case Cocoon.Dialog.keyboardType.NUMBER:defaultKeyboard=Cocoon.Dialog.keyboardType.NUMBER;break;case Cocoon.Dialog.keyboardType.PHONE:defaultKeyboard=Cocoon.Dialog.keyboardType.PHONE;break;case Cocoon.Dialog.keyboardType.EMAIL:defaultKeyboard=Cocoon.Dialog.keyboardType.EMAIL;break;case Cocoon.Dialog.keyboardType.URL:defaultKeyboard=Cocoon.Dialog.keyboardType.URL;break}var properties={title:"",message:"",text:"",type:defaultKeyboard,cancelText:"Cancel",confirmText:"Ok"};var args=Cocoon.clone(properties,params);var succedListener=function(){Cocoon.Dialog.onTextDialogCancelled.removeEventListener(errorListener);Cocoon.Dialog.onTextDialogFinished.removeEventListener(succedListener);callbacks.success.apply(window,Array.prototype.slice.call(arguments))};var errorListener=function(){Cocoon.Dialog.onTextDialogCancelled.removeEventListener(errorListener);Cocoon.Dialog.onTextDialogFinished.removeEventListener(succedListener);callbacks.cancel.apply(window,Array.prototype.slice.call(arguments))};Cocoon.Dialog.onTextDialogCancelled.addEventListener(errorListener);Cocoon.Dialog.onTextDialogFinished.addEventListener(succedListener);if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","showTextDialog",args,true)}else{setTimeout(function(){var result=prompt(properties.message,properties.text);var eventObject=result?Cocoon.Dialog.onTextDialogFinished:Cocoon.Dialog.onTextDialogCancelled;eventObject.notifyEventListeners(result)},0)}};extension.confirm=function(params,callback){if(!callback)throw"Callback missing for Cocoon.Dialog.confirm();";var properties={title:"",message:"",cancelText:"Cancel",confirmText:"Ok"};var args=Cocoon.clone(properties,params);var succedListener=function(){Cocoon.Dialog.onMessageBoxDenied.removeEventListenerOnce(errorListener);callback(true)};var errorListener=function(){Cocoon.Dialog.onMessageBoxConfirmed.removeEventListenerOnce(succedListener);callback(false)};Cocoon.Dialog.onMessageBoxDenied.addEventListenerOnce(errorListener);Cocoon.Dialog.onMessageBoxConfirmed.addEventListenerOnce(succedListener);if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","showMessageBox",args,true)}else{setTimeout(function(){var result=confirm(properties.message);var eventObject=result?Cocoon.Dialog.onMessageBoxConfirmed:Cocoon.Dialog.onMessageBoxDenied;eventObject.notifyEventListeners()},0)}};extension.showKeyboard=function(params,callbacks){params=params||{};params.type=params.type||Cocoon.Dialog.keyboardType.TEXT;var insertCallback=callbacks&&callbacks.insertText;var deleteCallback=callbacks&&callbacks.deleteBackward;var doneCallback=callbacks&&callbacks.done;var cancelCallback=callbacks&&callbacks.cancel;if(Cocoon.nativeAvailable){Cocoon.callNative("IDTK_APP","showKeyboard",[params,insertCallback,deleteCallback,doneCallback,cancelCallback],true)}};extension.dismissKeyboard=function(){if(Cocoon.nativeAvailable){Cocoon.callNative("IDTK_APP","dismissKeyboard",[],true)}};extension.onTextDialogFinished=new Cocoon.EventHandler("IDTK_APP","App","ontextdialogfinish");extension.onTextDialogCancelled=new Cocoon.EventHandler("IDTK_APP","App","ontextdialogcancel");extension.onMessageBoxConfirmed=new Cocoon.EventHandler("IDTK_APP","App","onmessageboxconfirmed");extension.onMessageBoxDenied=new Cocoon.EventHandler("IDTK_APP","App","onmessageboxdenied");return extension});Cocoon.define("Cocoon.WebView",function(extension){if(typeof Cocoon==="undefined"||Cocoon===null)return extension;if(typeof Cocoon.App==="undefined"||Cocoon.App===null)return extension;if(navigator.isCocoonJS)return extension;extension.show=function(x,y,width,height){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","show",arguments)}else{var div=window.parent.document.getElementById("CocoonJS_App_ForCocoonJS_WebViewDiv");div.style.left=(x?x:div.style.left)+"px";div.style.top=(y?y:div.style.top)+"px";div.style.width=(width?width/window.devicePixelRatio:window.parent.innerWidth)+"px";div.style.height=(height?height/window.devicePixelRatio:window.parent.innerHeight)+"px";div.style.display="block";var iframe=window.parent.document.getElementById("CocoonJS_App_ForCocoonJS_WebViewIFrame");iframe.style.width=(width?width/window.devicePixelRatio:window.parent.innerWidth)+"px";iframe.style.height=(height?height/window.devicePixelRatio:window.parent.innerHeight)+"px"}};extension.hide=function(){if(Cocoon.App.nativeAvailable){return Cocoon.callNative("IDTK_APP","hide",arguments)}else{window.parent.document.getElementById("CocoonJS_App_ForCocoonJS_WebViewDiv").style.display="none"}};extension.loadInCocoon=function(path,callbacks,storageType){if(Cocoon.App.nativeAvailable){var javaScriptCodeToForward="ext.IDTK_APP.makeCall('loadPath'";if(typeof path!=="undefined"){javaScriptCodeToForward+=", '"+path+"'";if(typeof storageType!=="undefined"){javaScriptCodeToForward+=", '"+storageType+"'"}}javaScriptCodeToForward+=");";return Cocoon.App.forwardAsync(javaScriptCodeToForward)}else{Cocoon.App.forwardAsync("Cocoon.App.load('"+path+"');")}};extension.reloadCocoonJS=function(){if(Cocoon.App.nativeAvailable){return Cocoon.App.forwardAsync("ext.IDTK_APP.makeCall('reload');")}else if(!navigator.isCocoonJS){window.parent.location.reload()}};window.addEventListener("load",function(){if(!Cocoon.App.nativeAvailable&&window.name=="CocoonJS_App_ForCocoonJS_WebViewIFrame"){Cocoon.App.forwardEventsToCocoonJSEnabled=false;var EVENT_ATTRIBUTES=["timeStamp","button","type","x","y","pageX","pageY","clientX","clientY","offsetX","offsetY"];var EVENTS=["dblclick","touchmove","mousemove","touchend","touchcancel","mouseup","touchstart","mousedown","release","dragleft","dragright","swipeleft","swiperight"];function forwardEventToCocoonJS(eventName,event){var eventData={};var att,i;for(var att in event){i=EVENT_ATTRIBUTES.indexOf(att);if(i>=0){eventData[att]=event[att]}}var jsCode="Cocoon && Cocoon.App && Cocoon.App.forwardedEventFromTheWebView && Cocoon.App.forwardedEventFromTheWebView("+JSON.stringify(eventName)+", '"+JSON.stringify(eventData)+"');";Cocoon.App.forward(jsCode)}for(i=0;i<EVENTS.length;i++){window.addEventListener(EVENTS[i],function(eventName){return function(event){if(Cocoon.App.forwardEventsToCocoonJSEnabled){forwardEventToCocoonJS(eventName,event)}}}(EVENTS[i]))}}});extension.onLoadInCocoonJSSucceed=new Cocoon.EventHandler("IDTK_APP","App","forwardpageload");extension.onLoadInCocoonJSFailed=new Cocoon.EventHandler("IDTK_APP","App","forwardpagefail");return extension});Cocoon.define("Cocoon.Proxify",function(extension){"use strict";extension.getKeyForValueInDictionary=function(dictionary,value){var finalKey=null;for(var key in dictionary){if(dictionary[key]===value){finalKey=key;break}}return finalKey};extension.setupOriginProxyType=function(typeName,attributeNames,functionNames,eventHandlerNames){if(Cocoon.nativeAvailable){if(!typeName)throw"The given typeName must be valid.";if(!attributeNames&&!functionNames&&!eventHandlerNames)throw"There is no point on setting up a proxy for no attributes, functions nor eventHandlers.";attributeNames=attributeNames?attributeNames:[];functionNames=functionNames?functionNames:[];eventHandlerNames=eventHandlerNames?eventHandlerNames:[];var parentObject=window;var jsCode="Cocoon.Proxify.setupDestinationProxyType("+JSON.stringify(typeName)+", "+JSON.stringify(eventHandlerNames)+");";Cocoon.App.forward(jsCode);var originalType=parentObject[typeName];parentObject[typeName]=function(){var _this=this;this._cocoonjs_proxy_object_data={};var jsCode="Cocoon.Proxify.newDestinationProxyObject("+JSON.stringify(typeName)+");";this._cocoonjs_proxy_object_data.id=Cocoon.App.forward(jsCode);this._cocoonjs_proxy_object_data.eventHandlers={};this._cocoonjs_proxy_object_data.typeName=typeName;this._cocoonjs_proxy_object_data.eventListeners={};parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[this._cocoonjs_proxy_object_data.id]=this;for(var i=0;i<attributeNames.length;i++){(function(attributeName){_this.__defineSetter__(attributeName,function(value){var jsCode="Cocoon.Proxify.setDestinationProxyObjectAttribute("+JSON.stringify(typeName)+", "+_this._cocoonjs_proxy_object_data.id+", "+JSON.stringify(attributeName)+", "+JSON.stringify(value)+");";return Cocoon.App.forward(jsCode)});_this.__defineGetter__(attributeName,function(){var jsCode="Cocoon.Proxify.getDestinationProxyObjectAttribute("+JSON.stringify(typeName)+", "+_this._cocoonjs_proxy_object_data.id+", "+JSON.stringify(attributeName)+");";return Cocoon.App.forward(jsCode)})})(attributeNames[i])}for(var i=0;i<functionNames.length;i++){(function(functionName){_this[functionName]=function(){var argumentsArray=Array.prototype.slice.call(arguments);argumentsArray.unshift(functionName);argumentsArray.unshift(this._cocoonjs_proxy_object_data.id);argumentsArray.unshift(typeName);var jsCode="Cocoon.Proxify.callDestinationProxyObjectFunction(";for(var i=0;i<argumentsArray.length;i++){jsCode+=(i!==1?JSON.stringify(argumentsArray[i]):argumentsArray[i])+(i<argumentsArray.length-1?", ":"")}jsCode+=");";var ret=Cocoon.App.forwardAsync(jsCode);return ret}})(functionNames[i])}for(var i=0;i<eventHandlerNames.length;i++){(function(eventHandlerName){_this.__defineSetter__(eventHandlerName,function(value){_this._cocoonjs_proxy_object_data.eventHandlers[eventHandlerName]=value});_this.__defineGetter__(eventHandlerName,function(){return _this._cocoonjs_proxy_object_data.eventHandlers[eventHandlerName]})})(eventHandlerNames[i])}_this.addEventListener=function(eventTypeName,eventCallback){var addEventCallback=true;var eventListeners=_this._cocoonjs_proxy_object_data.eventListeners[eventTypeName];if(eventListeners){addEventCallback=eventListeners.indexOf(eventCallback)<0}else{eventListeners=[];_this._cocoonjs_proxy_object_data.eventListeners[eventTypeName]=eventListeners;var jsCode="Cocoon.Proxify.addDestinationProxyObjectEventListener("+JSON.stringify(_this._cocoonjs_proxy_object_data.typeName)+", "+_this._cocoonjs_proxy_object_data.id+", "+JSON.stringify(eventTypeName)+");";Cocoon.App.forwardAsync(jsCode)}if(addEventCallback){eventListeners.push(eventCallback)}};_this.removeEventListener=function(eventTypeName,eventCallback){var eventListeners=_this._cocoonjs_proxy_object_data.eventListeners[eventTypeName];if(eventListeners){var eventCallbackIndex=eventListeners.indexOf(eventCallback);if(eventCallbackIndex>=0){eventListeners.splice(eventCallbackIndex,1)}}};return this};parentObject[typeName]._cocoonjs_proxy_type_data={originalType:originalType,proxyObjects:[]};parentObject[typeName]._cocoonjs_proxy_type_data.deleteProxyObject=function(object){var proxyObjectKey=extension.getKeyForValueInDictionary(this.proxyObjects,object);if(proxyObjectKey){var jsCode="Cocoon.Proxify.deleteDestinationProxyObject("+JSON.stringify(typeName)+", "+object._cocoonjs_proxy_object_data.id+");";Cocoon.App.forwardAsync(jsCode);object._cocoonjs_proxy_object_data=null;delete this.proxyObjects[proxyObjectKey]}};parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventHandler=function(id,eventHandlerName){var object=this.proxyObjects[id];var eventHandler=object._cocoonjs_proxy_object_data.eventHandlers[eventHandlerName];if(eventHandler){eventHandler({target:object})}};parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventListeners=function(id,eventTypeName){var object=this.proxyObjects[id];var eventListeners=object._cocoonjs_proxy_object_data.eventListeners[eventTypeName].slice();for(var i=0;i<eventListeners.length;i++){eventListeners[i]({target:object})}}}};extension.takedownOriginProxyType=function(typeName){if(Cocoon.App.nativeAvailable){var parentObject=window;if(parentObject[typeName]&&parentObject[typeName]._cocoonjs_proxy_type_data){parentObject[typeName]=parentObject[typeName]._cocoonjs_proxy_type_data.originalType}}};extension.deleteOriginProxyObject=function(object){if(Cocoon.App.nativeAvailable){var parentObject=window;if(object&&object._cocoonjs_proxy_object_data){parentObject[object._cocoonjs_proxy_object_data.typeName]._cocoonjs_proxy_type_data.deleteProxyObject(object)}}};extension.callOriginProxyObjectEventHandler=function(typeName,id,eventHandlerName){if(Cocoon.App.nativeAvailable){var parentObject=window;parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventHandler(id,eventHandlerName)}};extension.callOriginProxyObjectEventListeners=function(typeName,id,eventTypeName){if(Cocoon.App.nativeAvailable){var parentObject=window;parentObject[typeName]._cocoonjs_proxy_type_data.callProxyObjectEventListeners(id,eventTypeName)}};extension.setupDestinationProxyType=function(typeName,eventHandlerNames){if(Cocoon.App.nativeAvailable){var parentObject=window;parentObject[typeName]._cocoonjs_proxy_type_data={nextId:0,proxyObjects:{},eventHandlerNames:eventHandlerNames}}};extension.takedownDestinationProxyType=function(typeName){if(Cocoon.App.nativeAvailable){var parentObject=window;if(parent[typeName]&&parentObject[typeName]._cocoonjs_proxy_type_data){delete parentObject[typeName]._cocoonjs_proxy_type_data}}};extension.newDestinationProxyObject=function(typeName){if(Cocoon.App.nativeAvailable){var parentObject=window;var proxyObject=new parentObject[typeName];proxyObject._cocoonjs_proxy_object_data={};proxyObject._cocoonjs_proxy_object_data.typeName=typeName;var proxyObjectId=parentObject[typeName]._cocoonjs_proxy_type_data.nextId;parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[proxyObjectId]=proxyObject;proxyObject._cocoonjs_proxy_object_data.id=proxyObjectId;parentObject[typeName]._cocoonjs_proxy_type_data.nextId++;for(var i=0;i<parentObject[typeName]._cocoonjs_proxy_type_data.eventHandlerNames.length;i++){(function(eventHandlerName){proxyObject[eventHandlerName]=function(event){var proxyObject=this;var jsCode="Cocoon.App.callOriginProxyObjectEventHandler("+JSON.stringify(proxyObject._cocoonjs_proxy_object_data.typeName)+", "+proxyObject._cocoonjs_proxy_object_data.id+", "+JSON.stringify(eventHandlerName)+");";Cocoon.App.forwardAsync(jsCode)}})(parentObject[typeName]._cocoonjs_proxy_type_data.eventHandlerNames[i])}proxyObject._cocoonjs_proxy_object_data.eventListeners={};return proxyObjectId}};extension.callDestinationProxyObjectFunction=function(typeName,id,functionName){if(Cocoon.App.nativeAvailable){var parentObject=window;var argumentsArray=Array.prototype.slice.call(arguments);argumentsArray.splice(0,3);var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];var result=proxyObject[functionName].apply(proxyObject,argumentsArray);return result}};extension.setDestinationProxyObjectAttribute=function(typeName,id,attributeName,attributeValue){if(Cocoon.App.nativeAvailable){var parentObject=window;
var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];proxyObject[attributeName]=attributeValue}};extension.getDestinationProxyObjectAttribute=function(typeName,id,attributeName){if(Cocoon.App.nativeAvailable){var parentObject=window;var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];return proxyObject[attributeName]}};extension.deleteDestinationProxyObject=function(typeName,id){if(Cocoon.App.nativeAvailable){var parentObject=window;delete parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id]}};extension.addDestinationProxyObjectEventListener=function(typeName,id,eventTypeName){if(Cocoon.App.nativeAvailable){var parentObject=window;var proxyObject=parentObject[typeName]._cocoonjs_proxy_type_data.proxyObjects[id];var callback=function(event){var proxyObject=this;var jsCode="Cocoon.Proxify.callOriginProxyObjectEventListeners("+JSON.stringify(proxyObject._cocoonjs_proxy_object_data.typeName)+", "+proxyObject._cocoonjs_proxy_object_data.id+", "+JSON.stringify(eventTypeName)+");";Cocoon.App.forwardAsync(jsCode)};proxyObject._cocoonjs_proxy_object_data.eventListeners[eventTypeName]=callback;proxyObject.addEventListener(eventTypeName,callback)}};extension.xhr=function(){var ATTRIBUTE_NAMES=["timeout","withCredentials","upload","status","statusText","responseType","response","responseText","responseXML","readyState"];var FUNCTION_NAMES=["open","setRequestHeader","send","abort","getResponseHeader","getAllResponseHeaders","overrideMimeType"];var EVENT_HANDLER_NAMES=["onloadstart","onprogress","onabort","onerror","onload","ontimeout","onloadend","onreadystatechange"];Cocoon.Proxify.setupOriginProxyType("XMLHttpRequest",ATTRIBUTE_NAMES,FUNCTION_NAMES,EVENT_HANDLER_NAMES)};extension.audio=function(){var ATTRIBUTE_NAMES=["src","loop","volume","preload"];var FUNCTION_NAMES=["play","pause","load","canPlayType"];var EVENT_HANDLER_NAMES=["onended","oncanplay","oncanplaythrough","onerror"];Cocoon.Proxify.setupOriginProxyType("Audio",ATTRIBUTE_NAMES,FUNCTION_NAMES,EVENT_HANDLER_NAMES)};extension.console=function(){if(!Cocoon.nativeAvailable)return;if(typeof Cocoon.originalConsole==="undefined"){Cocoon.originalConsole=window.console}var functions=["log","error","info","debug","warn"];var newConsole={};for(var i=0;i<functions.length;i++){newConsole[functions[i]]=function(functionName){return function(message){try{var jsCode="Proxified log: "+JSON.stringify(message);Cocoon.originalConsole.log(jsCode);ext.IDTK_APP.makeCallAsync("forward",jsCode)}catch(e){console.log("Proxified log: "+e)}}}(functions[i])}if(!newConsole.assert){newConsole.assert=function assert(){if(arguments.length>0&&!arguments[0]){var str="Assertion failed: "+(arguments.length>1?arguments[1]:"");newConsole.error(str)}}}window.console=newConsole};extension.deproxifyConsole=function(){if(window.navigator.isCocoonJS||!Cocoon.nativeAvailable)return;if(typeof Cocoon.originalConsole!=="undefined"){window.console=Cocoon.originalConsole;Cocoon.originalConsole=undefined}};return extension});Cocoon.define("Cocoon.Device",function(extension){"use strict";extension.DeviceInfo={os:null,version:null,dpi:null,brand:null,model:null,imei:null,platformId:null,odin:null,openudid:null};extension.getDeviceId=function(){if(Cocoon.nativeAvailable){return window.ext.IDTK_APP.makeCall("getDeviceId")}};extension.getDeviceInfo=function(){if(Cocoon.nativeAvailable){return window.ext.IDTK_APP.makeCall("getDeviceInfo")}};extension.getOrientation=function(){if(Cocoon.nativeAvailable){return window.ext.IDTK_APP.makeCall("getPreferredOrientation")}else{return 0}};extension.setOrientation=function(preferredOrientation){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("setPreferredOrientation",preferredOrientation)}};extension.Orientations={PORTRAIT:1,PORTRAIT_UPSIDE_DOWN:2,LANDSCAPE_LEFT:4,LANDSCAPE_RIGHT:8,LANDSCAPE:4|8,BOTH:1|2|4|8};extension.autoLock=function(enabled){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","setAutoLockEnabled",arguments)}};return extension});Cocoon.define("Cocoon.Motion",function(extension){"use strict";extension.nativeAvailable=Cocoon.nativeAvailable;extension.setAccelerometerInterval=function(updateIntervalInSeconds){if(Cocoon.Motion.nativeAvailable){return window.ext.IDTK_APP.makeCall("setAccelerometerUpdateIntervalInSeconds",updateIntervalInSeconds)}};extension.getAccelerometerInterval=function(){if(Cocoon.Motion.nativeAvailable){return window.ext.IDTK_APP.makeCall("getAccelerometerUpdateIntervalInSeconds")}};extension.setGyroscopeInterval=function(updateIntervalInSeconds){if(Cocoon.Motion.nativeAvailable){return window.ext.IDTK_APP.makeCall("setGyroscopeUpdateIntervalInSeconds",updateIntervalInSeconds)}};extension.getGyroscopeInterval=function(){if(Cocoon.Motion.nativeAvailable){window.ext.IDTK_APP.makeCall("getGyroscopeUpdateIntervalInSeconds")}};return extension});Cocoon.define("Cocoon.Touch",function(extension){extension.addADivToDisableInput=function(){var div=document.createElement("div");div.id="CocoonJSInputBlockingDiv";div.style.left=0;div.style.top=0;div.style.width="100%";div.style.height="100%";div.style.position="absolute";div.style.backgroundColor="transparent";div.style.border="0px solid #000";div.style.zIndex=999999999;document.body.appendChild(div)};extension.removeTheDivToEnableInput=function(){var div=document.getElementById("CocoonJSInputBlockingDiv");if(div)document.body.removeChild(div)};extension.disable=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("disableTouchLayer","CocoonJSView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.App.forwardEventsToCocoonJSEnabled=false;Cocoon.App.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.disable();")}}};extension.enable=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("enableTouchLayer","CocoonJSView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.App.forwardEventsToCocoonJSEnabled=true;Cocoon.App.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.enable();")}}};extension.disableInWebView=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("disableTouchLayer","WebView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.Touch.addADivToDisableInput()}else{Cocoon.App.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.disableInWebView();")}}};extension.enableInWebView=function(){if(Cocoon.nativeAvailable){window.ext.IDTK_APP.makeCall("enableTouchLayer","WebView")}else if(!navigator.isCocoonJS){if(!Cocoon.App.EmulatedWebViewIFrame){Cocoon.Touch.removeTheDivToEnableInput()}else{Cocoon.Touch.forwardAsync("Cocoon && Cocoon.Touch && Cocoon.Touch.enableInWebView();")}}};return extension});Cocoon.define("Cocoon.Widget",function(extension){"use strict";extension.WebDialog=function(){if(Cocoon.App.nativeAvailable){this.webDialogID=window.ext.IDTK_APP.makeCall("createWebDialog")}else{var iframe=document.createElement("iframe");iframe.id="CocoonJSWebDialogIFrame";iframe.name="CocoonJSWebDialogIFrame";iframe.style.cssText="position:fixed;left:0;top:0;bottom:0;right:0; width:100%; height:100%;margin:0;padding:0;";var me=this;iframe.onload=function(){me.iframeloaded=true;var js="Cocoon = {}; Cocoon.Widget = {}; Cocoon.Widget.WebDialog = {} Cocoon.Widget.WebDialog.close = function()"+"{"+"   window.parent.CocoonJSCloseWebDialog();"+"};";me.evalIframe(js);for(var i=0;i<me.pendingEvals.length;++i){me.evalIframe(me.pendingEvals[i])}me.pendingEvals=[]};iframe.onerror=function(){me.close()};this.iframe=iframe;this.pendingEvals=[];window.CocoonJSCloseWebDialog=function(){me.close()}}};extension.WebDialog.prototype={show:function(url,callback){this.closeCallback=function(){Cocoon.Touch.enable();if(callback)callback()};if(Cocoon.App.nativeAvailable){Cocoon.Touch.disable();return window.ext.IDTK_APP.makeCallAsync("showWebDialog",this.webDialogID,url,this.closeCallback)}else{this.iframe.src=url;document.body.appendChild(this.iframe)}},close:function(){if(Cocoon.App.nativeAvailable){return window.ext.IDTK_APP.makeCallAsync("closeWebDialog",this.webDialogID)}else{if(this.iframe.parentNode){this.iframe.parentNode.removeChild(this.iframe)}}if(this.closeCallback)this.closeCallback()},evalIframe:function(js){window.frames["CocoonJSWebDialogIFrame"].eval(js)},eval:function(js){if(Cocoon.App.nativeAvailable){return window.ext.IDTK_APP.makeCallAsync("evalWebDialog",this.webDialogID,js)}else{if(this.iframeloaded)this.evalIframe(js);else this.pendingEvals.push(js)}}};return extension});Cocoon.define("Cocoon.Camera",function(extension){navigator.getUserMedia_=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;extension.CameraType={FRONT:"FRONT",BACK:"BACK"};extension.CaptureFormatType={JPEG:"JPEG",RGB_565:"RGB_565",NV21:"NV21",NV16:"NV16",YUY2:"YUY2",YV12:"YV12",BGRA32:"32BGRA"};extension.CameraInfo={cameraIndex:0,cameraType:extension.CameraType.BACK,supportedVideoSizes:[],supportedVideoFrameRates:[],supportedVideoCaptureImageFormats:[]};extension.getNumberOfCameras=function(){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getNumberOfCameras",arguments)}else{return navigator.getUserMedia_?1:0}};extension.getAllCamerasInfo=function(){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getAllCamerasInfo",arguments)}};extension.getCameraInfoByIndex=function(cameraIndex){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getCameraInfoByIndex",arguments)}};extension.getCameraInfoByType=function(cameraType){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","getCameraInfoByType",arguments)}};extension.start=function(params){if(!(Boolean(params.success)&&Boolean(params.error)))throw new Error("Missing callbacks for Cocoon.Camera.start();");if(Cocoon.nativeAvailable){var properties={cameraIndex:0,width:50,height:50,frameRate:25};var args=Cocoon.clone(properties,params);var img=Cocoon.callNative("IDTK_SRV_CAMERA","startCapturing",args);if(Boolean(img)){params.success(img)}else{params.error(false)}}else{navigator.getUserMedia_({video:true,audio:false},function(stream){params.success(stream)},function(error){params.error(error)})}};extension.stop=function(cameraIndex){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","stopCapturing",arguments)}};extension.isCapturing=function(cameraIndex){if(Cocoon.nativeAvailable&&navigator.isCocoonJS){return Cocoon.callNative("IDTK_SRV_CAMERA","isCapturing",arguments)}};return extension});Cocoon.define("Cocoon.Ad",function(extension){"use strict";extension.nativeAvailable=!!Cocoon.nativeAvailable&&!!window.ext.IDTK_SRV_AD;extension.BannerLayout={TOP_CENTER:"TOP_CENTER",BOTTOM_CENTER:"BOTTOM_CENTER"};extension.Rectangle=function(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height};extension.Banner=function(id){if(typeof id!=="number")throw"The given ad ID is not a number.";this.id=id;var me=this;this.onBannerShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannershow",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onBannerHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerhide",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onBannerReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerready",function(sourceListener,args){if(me.id===args[0]){sourceListener(args[1],args[2])}});var signal=new Cocoon.Signal.createSignal;signal.register("ready",this.onBannerReady);signal.register("shown",this.onBannerShown);signal.register("hidden",this.onBannerHidden);this.on=signal.expose()};extension.Banner.prototype={showBanner:function(){if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","showBanner",[this.id],true)}},hideBanner:function(){if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","hideBanner",[this.id],true)}},load:function(){if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","refreshBanner",[this.id],true)}},getRectangle:function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","getRectangle",[this.id])}},setRectangle:function(rect){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setRectangle",[this.id,rect])}},setBannerLayout:function(bannerLayout){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setBannerLayout",[this.id,bannerLayout])}}};extension.Interstitial=function(id){if(typeof id!=="number")throw"The given ad ID is not a number.";this.id=id;var me=this;this.onFullScreenShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenshow",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onFullScreenHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenhide",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});this.onFullScreenReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenready",function(sourceListener,args){if(me.id===args[0]){sourceListener()}});var signal=new Cocoon.Signal.createSignal;signal.register("ready",this.onFullScreenReady);signal.register("shown",this.onFullScreenShown);signal.register("hidden",this.onFullScreenHidden);this.on=signal.expose()};extension.Interstitial.prototype={showInterstitial:function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","showFullScreen",[this.id],true)}},refreshInterstitial:function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","refreshFullScreen",[this.id],true)}}};extension.configure=function(parameters){if(typeof parameters==="undefined"){parameters={}}if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","requestInitialization",arguments,true)}};extension.createBanner=function(parameters){if(typeof parameters==="undefined"){parameters={}}if(Cocoon.Ad.nativeAvailable){var adId=Cocoon.callNative("IDTK_SRV_AD","createBanner",[parameters]);var banner=new extension.Banner(adId);return banner}};extension.releaseBanner=function(banner){if(typeof banner==="undefined"){throw"The banner ad object to be released is undefined"}if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","releaseBanner",[banner.id])}};extension.createInterstitial=function(parameters){if(typeof parameters==="undefined"){parameters={}}if(Cocoon.Ad.nativeAvailable){var adId=Cocoon.callNative("IDTK_SRV_AD","createFullscreen",[parameters]);var fullscreen=new Cocoon.Ad.Interstitial(adId);return fullscreen}};extension.releaseInterstitial=function(fullscreen){if(!fullscreen){throw"The fullscreen ad object to be released is undefined"}if(Cocoon.Ad.nativeAvailable){Cocoon.callNative("IDTK_SRV_AD","releaseFullscreen",[fullscreen.id])}};extension.showBanner=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","showBanner",arguments,true)}};extension.hideBanner=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","hideBanner",arguments,true)}};extension.refreshBanner=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","refreshBanner",arguments,true)}};extension.showInterstitial=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","showFullScreen",arguments,true)}};extension.refreshInterstitial=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","refreshFullScreen",arguments,true)}};extension.preloadedBanner=false;extension.loadBanner=function(){if(Cocoon.Ad.nativeAvailable){if(Cocoon.Ad.preloadedBanner){return Cocoon.Ad.refreshBanner()}else{Cocoon.Ad.preloadedBanner=true;return Cocoon.callNative("IDTK_SRV_AD","preloadBanner",arguments,true)}}};extension.preloadedInterstitial=false;extension.loadInterstitial=function(){if(Cocoon.Ad.nativeAvailable){if(Cocoon.Ad.preloadedInterstitial){return Cocoon.Ad.refreshInterstitial()}else{Cocoon.Ad.preloadedInterstitial=true;return Cocoon.callNative("IDTK_SRV_AD","preloadFullScreen",arguments,true)}}};extension.setRectangle=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setRectangle",arguments)}};extension.getRectangle=function(){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","getRectangle",arguments)}};extension.setBannerLayout=function(bannerLayout){if(Cocoon.Ad.nativeAvailable){return Cocoon.callNative("IDTK_SRV_AD","setBannerLayout",arguments)}};extension.onBannerShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannershow");extension.onBannerHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerhide");extension.onBannerReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onbannerready");extension.onFullScreenShown=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenshow");extension.onFullScreenHidden=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenhide");extension.onFullScreenReady=new Cocoon.EventHandler("IDTK_SRV_AD","Ad","onfullscreenready");var signal=new Cocoon.Signal.createSignal;signal.register("ready",extension.onBannerReady);signal.register("shown",extension.onBannerShown);signal.register("hidden",extension.onBannerHidden);extension.banner={};extension.banner.on=signal.expose();var signal=new Cocoon.Signal.createSignal;signal.register("ready",extension.onFullScreenReady);signal.register("shown",extension.onFullScreenShown);signal.register("hidden",extension.onFullScreenHidden);extension.interstitial={};extension.interstitial.on=signal.expose();return extension});Cocoon.define("Cocoon.Store",function(extension){"use strict";extension.nativeAvailable=!!Cocoon.nativeAvailable&&!!window.ext.IDTK_SRV_STORE;extension.ProductInfo={productId:"productId",productAlias:"productAlias",productType:"productType",title:"title",description:"description",price:"price",localizedPrice:"localizedPrice",downloadURL:"downloadURL"};extension.ProductType={CONSUMABLE:0,NON_CONSUMABLE:1,AUTO_RENEWABLE_SUBSCRIPTION:2,FREE_SUBSCRIPTION:3,NON_RENEWABLE_SUBSCRIPTION:4};extension.StoreType={APP_STORE:0,PLAY_STORE:1,MOCK_STORE:2,CHROME_STORE:3,AMAZON_STORE:4,NOOK_STORE:5};extension.PurchaseInfo=function(transactionId,purchaseTime,purchaseState,productId,quantity){this.transactionId=transactionId;this.purchaseTime=purchaseTime;this.purchaseState=purchaseState;this.productId=productId;this.quantity=quantity;return this};extension.PurchaseState={PURCHASED:0,CANCELED:1,REFUNDED:2,EXPIRED:3};extension.getStoreType=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","getStoreType",arguments)}else{return false}};extension.initialize=function(params){params=params||{};var properties={sandbox:false,managed:true};var args=Cocoon.clone(properties,params);Cocoon.Store.requestInitialization({sandbox:args[0],managed:args[1]});Cocoon.Store.start()};extension.requestInitialization=function(parameters){if(typeof parameters==="undefined"){parameters={}}else{if(parameters["managed"]!==undefined)parameters["remote"]=parameters["managed"];if(parameters["sandbox"]!==undefined)parameters["debug"]=parameters["sandbox"]}if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","requestInitialization",arguments,true)}};extension.start=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","start",arguments)}};extension.canPurchase=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","canPurchase",arguments)}else{return false}};extension.fetchProductsFromServer=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","fetchProductsFromServer",arguments,true)}};extension.loadProducts=function(productIds){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","fetchProductsFromStore",arguments,true)}};extension.finish=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","finishPurchase",arguments,true)}};extension.consume=function(transactionId,productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","consumePurchase",arguments,true)}};extension.purchase=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","purchaseFeature",arguments,true)}};extension.puchaseProductModal=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","purchaseFeatureModal",arguments,true)}};extension.purchaseProductModalWithPreview=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","purchaseFeatureModalWithPreview",arguments,true)}};extension.isProductPurchased=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","isFeaturePurchased",arguments)}};extension.restore=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","restorePurchases",arguments,true)}};extension.restorePurchasesModal=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","restorePurchasesModal",arguments,true)}};extension.getProducts=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","getProducts",arguments)}};extension.addProduct=function(product){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","addProduct",arguments)}};extension.removeProduct=function(productId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","removeProduct",arguments)}};extension.getPurchases=function(){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","getPurchases",arguments)}};extension.addPurchase=function(purchase){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","addPurchase",arguments)}};extension.removePurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","removePurchase",arguments)}};extension.cancelPurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","cancelPurchase",arguments)}};extension.refundPurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","refundPurchase",arguments)}};extension.expirePurchase=function(transactionId){if(Cocoon.Store.nativeAvailable){return Cocoon.callNative("IDTK_SRV_STORE","expirePurchase",arguments)}};extension.onProductsFetchStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductsFetchStarted");extension.onProductsFetchCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductsFetchCompleted");extension.onProductsFetchFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductsFetchFailed");extension.onProductPurchaseStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseStarted");extension.onProductPurchaseVerificationRequestReceived=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseVerificationRequestReceived");extension.onProductPurchaseCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseCompleted");extension.onProductPurchaseFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onProductPurchaseFailed");extension.onRestorePurchasesStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onRestorePurchasesStarted");extension.onRestorePurchasesCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onRestorePurchasesCompleted");extension.onRestorePurchasesFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onRestorePurchasesFailed");extension.onConsumePurchaseStarted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onConsumePurchaseStarted");extension.onConsumePurchaseCompleted=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onConsumePurchaseCompleted");extension.onConsumePurchaseFailed=new Cocoon.EventHandler("IDTK_SRV_STORE","Store","onConsumePurchaseFailed");var signal=new Cocoon.Signal.createSignal;signal.register("load",{started:extension.onProductsFetchStarted,success:extension.onProductsFetchCompleted,error:extension.onProductsFetchFailed});signal.register("purchase",{started:extension.onProductPurchaseStarted,success:extension.onProductPurchaseCompleted,verification:extension.onProductPurchaseVerificationRequestReceived,error:extension.onProductPurchaseFailed});signal.register("consume",{started:extension.onConsumePurchaseStarted,success:extension.onConsumePurchaseCompleted,error:extension.onConsumePurchaseFailed});signal.register("restore",{started:extension.onRestorePurchasesStarted,success:extension.onRestorePurchasesCompleted,error:extension.onRestorePurchasesFailed});extension.on=signal.expose();return extension});Cocoon.define("Cocoon.Notification",function(extension){extension.nativeAvailable=!!window.ext&&!!window.ext.IDTK_SRV_NOTIFICATION;extension.Local={};extension.Push={};extension.Local.create=function(params){var properties={message:"",soundEnabled:true,badgeNumber:0,userData:{},contentBody:"",contentTitle:"",date:(new Date).valueOf()+1e3};var args=Cocoon.clone(properties,params);if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","createLocalNotification",args)}};extension.Push.create=function(params){var properties={message:"",soundEnabled:true,badgeNumber:0,userData:{},channels:[],expirationTime:0,expirationTimeInterval:0};for(var prop in properties){if(!params[prop]){params[prop]=properties[prop]}}return params};extension.start=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","start",arguments)}};extension.Push.register=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","registerForPushNotifications",arguments,true)}};extension.Push.unregister=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","unregisterForPushNotifications",arguments,true)}};extension.Local.cancel=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","cancelLocalNotification",arguments)}};extension.Local.cancelLast=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","cancelLocalNotification",arguments,true)}};extension.Local.cancelAllNotifications=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","cancelAllLocalNotifications",arguments)}};extension.Local.send=function(localNotification){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","sendLocalNotification",arguments,true)}};extension.subscribe=function(channel){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","subscribe",arguments,true)}};extension.unsubscribe=function(channel){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","unsubscribe",arguments,true)}};extension.Push.send=function(pushNotification){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","sendPushNotification",arguments,true)}};extension.setBadgeNumber=function(badgeNumber){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","setBadgeNumber",arguments)}};extension.getBadgeNumber=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","getBadgeNumber",arguments)}};extension.Local.getLastNotificationData=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","getLastReceivedLocalNotificationData",arguments)}};extension.Push.getLastNotificationData=function(){if(Cocoon.Notification.nativeAvailable){return Cocoon.callNative("IDTK_SRV_NOTIFICATION","getLastReceivedPushNotificationData",arguments)}};extension.onRegisterForPushNotificationsSucceed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationServiceRegistered");extension.onUnregisterForPushNotificationsSucceed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationServiceUnregistered");extension.onRegisterForPushNotificationsFailed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationServiceFailedToRegister");extension.onPushNotificationReceived=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationReceived");extension.onLocalNotificationReceived=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","localNotificationReceived");extension.onPushNotificationDeliverySucceed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationSuccessfullyDelivered");extension.onPushNotificationDeliveryFailed=new Cocoon.EventHandler("IDTK_SRV_NOTIFICATION","Notification","pushNotificationDeliveryError");var signal=new Cocoon.Signal.createSignal;signal.register("notification",{received:extension.onLocalNotificationReceived});extension.Local.on=signal.expose();var signal=new Cocoon.Signal.createSignal;signal.register("register",{success:extension.onRegisterForPushNotificationsSucceed,unregister:extension.onUnregisterForPushNotificationsSucceed,error:extension.onRegisterForPushNotificationsFailed});signal.register("notification",{received:extension.onPushNotificationReceived});signal.register("deliver",{success:extension.onPushNotificationDeliverySucceed,error:extension.onPushNotificationDeliveryFailed});extension.Push.on=signal.expose();return extension});Cocoon.define("Cocoon.Social",function(extension){extension.Interface=function(){this.onLoginStatusChanged=new Cocoon.EventHandler("","dummy","onLoginStatusChanged");var signal=new Cocoon.Signal.createSignal;signal.register("loginStatusChanged",this.onLoginStatusChanged);this.on=signal.expose();return this};extension.Interface.prototype={isLoggedIn:function(){return false},login:function(callback){if(callback)callback(false,{message:"Not implemented!"})},logout:function(callback){if(callback)callback({message:"Not implemented!"})},getLoggedInUser:function(){return null},hasPublishPermissions:function(callback){callback(true)},requestPublishPermissions:function(callback){if(callback)callback(true,null)},requestUser:function(callback,userID){callback(null,{message:"Not implemented!"})},requestUserImage:function(callback,userID,imageSize){callback("",{message:"Not implemented!"})},requestFriends:function(callback,userID){callback([],{message:"Not implemented!"})},publishMessage:function(message,callback){callback({message:"Not implemented!"})},publishMessageWithDialog:function(message,callback){callback({message:"Not implemented!"})}};extension.SocialGamingService=function(){Cocoon.Social.SocialGamingService.superclass.constructor.call(this);return this};extension.SocialGamingService.prototype={_cachedAchievements:null,_achievementsMap:null,_leaderboardsTemplate:null,_achievementsTemplate:null,requestScore:function(callback,params){callback(null,{message:"Not implemented!"})},submitScore:function(score,callback,params){if(callback)callback({message:"Not implemented!"})},showLeaderboard:function(callback,params){if(callback)callback({message:"Not implemented!"})},requestAllAchievements:function(callback){callback([],{message:"Not implemented!"})},requestAchievements:function(callback,userID){callback([],{message:"Not implemented!"})},submitAchievement:function(achievementID,callback){if(callback)callback({message:"Not implemented!"})},resetAchievements:function(callback){if(callback)callback([],{message:"Not implemented!"})},showAchievements:function(callback){if(!this._achievementsTemplate)throw"Please, provide a html template for achievements with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._achievementsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;this.requestAchievements(function(achievements,error){if(dialog.closed)return;
if(error){callbackSent=true;if(callback)callback(error);return}var achs=[];if(me._cachedAchievements){for(var i=0;i<me._cachedAchievements.length;++i){var ach=me._cachedAchievements[i];achs.push(ach);if(achievements&&achievements.length){for(var j=0;j<achievements.length;++j){if(achievements[j].achievementID===ach.achievementID){ach.achieved=true;break}}}}}var js="addAchievements("+JSON.stringify(achs)+");";dialog.eval(js)})},setAchievementsMap:function(map){this._achievementsMap=map;if(this._cachedAchievements){this.syncAchievementsMap(this._cachedAchievements)}},setTemplates:function(leaderboardsTemplate,achievementsTemplate){this._leaderboardsTemplate=leaderboardsTemplate;this._achievementsTemplate=achievementsTemplate},setCachedAchievements:function(achievements){this._cachedAchievements=achievements;if(achievements&&this._achievementsMap){this.syncAchievementsMap(this._cachedAchievements)}},findAchievement:function(id){if(!this._cachedAchievements)return null;for(var i=0;i<this._cachedAchievements.length;++i){if(id===this._cachedAchievements[i].achievementID){return this._cachedAchievements[i]}}return null},translateAchievementID:function(id){if(this._achievementsMap){for(var customID in this._achievementsMap){if(customID==id){return this._achievementsMap[customID]}}}return id},syncAchievementsMap:function(achievements){if(!this._achievementsMap)return;for(var i=0;i<achievements.length;++i){for(var customID in this._achievementsMap){if(this._achievementsMap[customID]===achievements[i].achievementID){achievements[i].customID=customID}}}}};Cocoon.extend(extension.SocialGamingService,extension.Interface);extension.ImageSize={THUMB:"thumb",SMALL:"small",MEDIUM:"medium",LARGE:"large"};extension.User=function(userID,userName,userImage){this.userID=userID;this.userName=userName;this.userImage=userImage;return this};extension.Message=function(message,mediaURL,linkURL,linkText,linkCaption){this.message=message;this.mediaURL=mediaURL;this.linkURL=linkURL;this.linkText=linkText;this.linkCaption=linkCaption;return this};extension.Score=function(userID,score,userName,imageURL,leaderboardID){this.userID=userID;this.score=score||0;this.userName=userName;this.imageURL=imageURL;this.leaderboardID=leaderboardID;return this};extension.ScoreParams=function(userID,leaderboardID,friends,timeScope){this.userID=userID;this.leaderboardID=leaderboardID;this.friends=!!friends;this.timeScope=timeScope||2};extension.TimeScope={ALL_TIME:0,WEEK:1,TODAY:2};extension.Achievement=function(achievementID,title,description,imageURL,points){this.achievementID=achievementID;this.customID=achievementID;this.title=title;this.description=description;this.imageURL=imageURL;this.points=points||0;return this};extension.share=function(textToShare){if(Cocoon.nativeAvailable){return Cocoon.callNative("IDTK_APP","share",arguments,true)}else{}};return extension});Cocoon.define("Cocoon.Social",function(extension){extension.ManagerService=function(){this.services=[]};extension.ManagerService.prototype={services:null,registerSocialService:function(service){this.services.push(service)},submitAchievement:function(achievementID){for(var i=0;i<this.services.length;++i){var service=this.services[i];if(!service.readOnlyHint&&service.isLoggedIn()){service.submitAchievement(achievementID,function(error){if(error)console.error("Error submitting achievement: "+error.message)})}}},submitScore:function(score,params){for(var i=0;i<this.services.length;++i){var service=this.services[i];if(!service.readOnlyHint&&service.isLoggedIn()){service.submitScore(score,function(error){if(error)console.error("Error submitting score: "+error.message)},params)}}},getLoggedInServices:function(){var result=[];for(var i=0;i<this.services.length;++i){var service=this.services[i];if(!service.fakeSocialService&&service.isLoggedIn()){result.push(service)}}return result},isLoggedInAnySocialService:function(){return this.getLoggedInServices().length>0}};extension.Manager=new extension.ManagerService;return extension});Cocoon.define("Cocoon.Social",function(extension){extension.LocalStorageService=function(){Cocoon.Social.LocalStorageService.superclass.constructor.call(this);this.fakeSocialService=true};extension.LocalStorageService.prototype={loggedIn:false,keys:{score:"Cocoon.Social.LocalStorageService.score",earnedAchievements:"Cocoon.Social.LocalStorageService.earned"},isLoggedIn:function(){return this.loggedIn},login:function(callback){if(!this.loggedIn)this.onLoginStatusChanged.notifyEventListeners(true);this.loggedIn=true;if(callback)setTimeout(function(){callback(true)},0)},logout:function(callback){if(this.loggedIn)this.onLoginStatusChanged.notifyEventListeners(true);this.loggedIn=false;if(callback)setTimeout(function(){callback()},0)},getLoggedInUser:function(){return new Cocoon.Social.User("me","LocalStorage")},requestUser:function(callback,userID){var user=new Cocoon.Social.User(userID||"me","LocalStorage");if(callback)setTimeout(function(){callback(user)},0)},requestScore:function(callback,params){var scoreItem=localStorage.getItem(this.keys.score);var score=parseInt(scoreItem)||0;setTimeout(function(){callback(new Cocoon.Social.Score("me",score))},0)},submitScore:function(score,callback,params){var scoreItem=localStorage.getItem(this.keys.score);var topScore=parseInt(scoreItem)||0;if(score>topScore)localStorage.setItem(this.keys.score,score);if(callback)setTimeout(function(){callback()},0)},getLocalStorageEarnedAchievements:function(){var achievementsItem=localStorage.getItem(this.keys.earnedAchievements);var earned=[];if(achievementsItem){var array=JSON.stringify(achievementsItem);if(array&&array.length){earned=array}}return earned},requestAchievements:function(callback,userID){var earned=this.getLocalStorageEarnedAchievements();setTimeout(function(){callback(earned)},0)},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var earned=this.getLocalStorageEarnedAchievements();var exists=false;for(var i=0;i<earned.length;++i){if(earned[i]===achievementID){exists=true;break}}if(!exists){earned.push(achievementID);localStorage.setItem(this.keys.earnedAchievements,JSON.stringify(earned))}if(callback)setTimeout(function(){callback()},0)},resetAchievements:function(callback){localStorage.removeItem(this.keys.earnedAchievements);if(callback)setTimeout(function(){callback()},0)}};Cocoon.extend(extension.LocalStorageService,extension.SocialGamingService);extension.LocalStorage=new extension.LocalStorageService;return extension});Cocoon.define("Cocoon.Social",function(extension){extension.GooglePlayGamesExtension=function(){this.nativeExtensionName="IDTK_SRV_GOOGLE_PLAY_GAMES";this.extensionName="Social.GooglePlayGames";this.nativeAvailable=Cocoon.nativeAvailable&&typeof window.ext[this.nativeExtensionName]!=="undefined";this.auth=new Cocoon.Social.GooglePlayGamesAuthExtension(this);this.client=new Cocoon.Social.GooglePlayGamesClientExtension(this);this.defaultScopes=["https://www.googleapis.com/auth/games","https://www.googleapis.com/auth/plus.login"];this.gamesAPI="/games/v1";this.plusAPI="/plus/v1";this.onSessionChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onSessionChanged");Cocoon.Social.GooglePlayGames=this;var me=this;this.onSessionChanged.addEventListener(function(session,error){me.token=fromSessionToAuthTokenObject(session,error);if(session&&session.access_token){me.client.request({path:me.gamesAPI+"/players/me",callback:function(response){me.currentPlayer=response}})}});return this};extension.GooglePlayGamesExtension.prototype={token:null,settings:{},socialService:null,currentPlayer:null,initialized:false,auth:null,client:null,init:function(params){if(!params||typeof params!=="object")throw"Invalid params argument";this.settings=params;this.initialized=true;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"init",[this.settings.clientId],true)}else{var me=this;var initWebAPi=function(){gapi.auth.authorize({immediate:true,scope:me.defaultScopes,client_id:me.settings.clientId},function(response){me.token=response;if(response&&response.access_token){me.onSessionChanged.notifyEventListeners(response)}})};if(!window.gapi){window.onGapiLoadCallback=function(){window.setTimeout(initWebAPi,1)};var script=document.createElement("script");script.src="https://apis.google.com/js/client.js?onload=onGapiLoadCallback";document.getElementsByTagName("head")[0].appendChild(script)}else{initWebAPi()}}},getSocialInterface:function(){if(!this.initialized){throw"You must call init() before getting the Social Interface"}if(!this.socialService){this.socialService=new Cocoon.Social.SocialGamingServiceGooglePlayGames(this)}return this.socialService},getMultiplayerInterface:function(){return Cocoon.Multiplayer.GooglePlayGames},share:function(){window.open(this.href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600");return false}};extension.GooglePlayGamesAuthExtension=function(extension){this.extension=extension;return this};extension.GooglePlayGamesAuthExtension.prototype={authorize:function(params,callback){var me=this;if(this.extension.nativeAvailable){Cocoon.callNative(this.extension.nativeExtensionName,"authorize",[params,function(response,error){me.extension.token=fromSessionToAuthTokenObject(response,error);if(callback){callback(me.extension.token)}}],true)}else{gapi.auth.authorize(params,function(response){me.extension.token=response;me.extension.onSessionChanged.notifyEventListeners(response,response?response.error:null);if(callback)callback(response)})}},disconnect:function(callback){if(this.extension.nativeAvailable){Cocoon.callNative(this.extension.nativeExtensionName,"disconnect",[callback],true)}else{if(callback)callback({error:"Not implemented yet"})}},init:function(callback){if(this.extension.nativeAvailable){callback()}else{gapi.auth.init(callback)}},getToken:function(){if(this.extension.nativeAvailable){return this.extension.token}else{return gapi.auth.getToken()}},setToken:function(token){if(this.extension.nativeAvailable){this.extension.token=token}else{gapi.auth.setToken(token)}}};extension.GooglePlayGamesClientExtension=function(extension){this.extension=extension;return this};extension.GooglePlayGamesClientExtension.prototype={setApiKey:function(apiKey){if(this.extension.nativeAvailable){Cocoon.callNative(this.extension.nativeExtensionName,"setApiKey",[apiKey],true)}else{gapi.client.setApiKey(apiKey)}},request:function(args){if(this.extension.nativeAvailable){if(args.callback){Cocoon.callNative(this.extension.nativeExtensionName,"request",[args,function(response,error){var result=response;if(error){result=response||{};result.error=error}args.callback(result)}],true);return null}else{var me=this;var httpRequest={execute:function(callback){Cocoon.callNative(me.extension.nativeExtensionName,"request",[args,function(response,error){var result=response;if(error){result=response||{};result.error=error}callback(result)}],true)}};return httpRequest}}else{return gapi.client.request(args)}}};extension.GooglePlayGames=new Cocoon.Social.GooglePlayGamesExtension;function fromSessionToAuthTokenObject(response,error){var obj=response||{};return{access_token:response.access_token,state:response.state,error:error,expires_in:response.expirationDate?response.expirationDate-Date.now():0,player_id:response.playerId}}extension.SocialGamingServiceGooglePlayGames=function(apiObject){Cocoon.Social.SocialGamingServiceGooglePlayGames.superclass.constructor.call(this);this.gapi=apiObject;var me=this;this.gapi.onSessionChanged.addEventListener(function(session){var obj=session||{};me.onLoginStatusChanged.notifyEventListeners(!!obj.access_token,obj.error)});return this};extension.SocialGamingServiceGooglePlayGames.prototype={isLoggedIn:function(){return this.gapi.token&&this.gapi.token.access_token?true:false},login:function(callback){var me=this;this.gapi.auth.authorize({client_id:this.gapi.settings.clientId,scope:this.gapi.defaultScopes},function(response){if(callback){callback(me.isLoggedIn(),response.error)}})},logout:function(callback){this.gapi.auth.disconnect(callback)},getLoggedInUser:function(){return this.gapi.currentPlayer?fromGPUserToCocoonUser(this.gapi.currentPlayer):null},requestUser:function(callback,userId){var playerId=userId||"me";this.gapi.client.request({path:this.gapi.gamesAPI+"/players/"+playerId,callback:function(response){var user=response&&!response.error?fromGPPlayerToCocoonUser(response):null;callback(user,response.error)}})},requestUserImage:function(callback,userID,imageSize){this.requestUser(function(user,error){if(user&&user.userImage){var pixelSize=fromImageSizeToGPSize(imageSize||Cocoon.Social.ImageSize.MEDIUM);if(user.userImage.indexOf("sz=")===-1){user.userImage+="?sz="+pixelSize}else{user.userImage=user.userImage.replace(/sz=\d+/g,"sz="+pixelSize)}}callback(user?user.userImage:null,error)},userID)},requestFriends:function(callback,userId){var params={orderBy:"best"};var playerId=userId||"me";this.gapi.client.request({path:this.gapi.plusAPI+"/people/"+playerId+"/people/visible",params:params,callback:function(response){if(response&&!response.error){var friends=[];for(var i=0;i<response.items.length;++i){friends.push(fromGPPersonToCocoonUser(response.items[i]))}callback(friends)}else{callback([],response?response.error:null)}}})},publishMessage:function(message,callback){if(callback)callback("Not supported... use publishMessageWithDialog method instead")},publishMessageWithDialog:function(message,callback){if(this.gapi.nativeAvailable){var params={prefilledText:message.message,mediaUrl:message.mediaURL,mediaTitle:message.linkCaption,mediaDescription:message.linkText,url:message.linkURL};Cocoon.callNative(this.gapi.nativeExtensionName,"shareMessage",[params,callback],true)}else{var me=this;var share=function(){var options={contenturl:"https://plus.google.com/pages/",contentdeeplinkid:"/pages",clientid:me.gapi.settings.clientId,cookiepolicy:"single_host_origin",prefilltext:message.message,calltoactionlabel:"CREATE",calltoactionurl:"http://plus.google.com/pages/create",calltoactiondeeplinkid:"/pages/create"};gapi.interactivepost.render("sharePost",options)};if(!gapi.interactivepost){var script=document.createElement("script");script.type="text/javascript";script.async=true;script.src="https://apis.google.com/js/plusone.js";script.onload=function(){share()};document.getElementsByTagName("head")[0].appendChild(script)}else{share()}}},requestScore:function(callback,params){params=params||{};var playerId=params.userID||"me";var leaderboardID=params.leaderboardID||this.gapi.settings.defaultLeaderboard;if(!leaderboardID)throw"leaderboardID not provided in the params. You can also set the default leaderboard in the init method";this.gapi.client.request({path:this.gapi.gamesAPI+"/players/"+playerId+"/leaderboards/"+leaderboardID+"/scores/ALL_TIME",callback:function(response){if(response&&response.error){callback(null,response.error)}else if(response&&response.items&&response.items.length>0){var item=response.items[0];var data=new Cocoon.Social.Score(playerId,item.scoreValue,"","",item.leaderboard_id);callback(data,null)}else{callback(null,null)}}})},submitScore:function(score,callback,params){params=params||{};var leaderboardID=params.leaderboardID||this.gapi.settings.defaultLeaderboard;if(!leaderboardID)throw"leaderboardID not provided in the params. You can also set the default leaderboard in the init method";this.gapi.client.request({path:this.gapi.gamesAPI+"/leaderboards/"+leaderboardID+"/scores",method:"POST",params:{score:score},callback:function(response){if(callback){callback(response?response.error:null)}}})},showLeaderboard:function(callback,params){params=params||{};var leaderboardID=params.leaderboardID||this.gapi.settings.defaultLeaderboard;if(!leaderboardID)throw"leaderboardID not provided in the params. You can also set the default leaderboard in the init method";var ios=/(iPad|iPhone|iPod)/gi.test(navigator.userAgent);if(!ios&&this.gapi.nativeAvailable){var timeScope=params.timeScope||0;Cocoon.callNative(this.gapi.nativeExtensionName,"showLeaderboard",[leaderboardID,timeScope,callback],true)}else{if(!this._leaderboardsTemplate)throw"Please, provide a html template for leaderboards with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._leaderboardsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;var collection=params.friends?"SOCIAL":"PUBLIC";var timeSpan="ALL_TIME";if(params.timeScope===Cocoon.Social.TimeScope.WEEK){timeSpan="WEEKLY"}else if(params.timeScope===Cocoon.Social.TimeScope.TODAY){timeSpan="DAILY"}this.gapi.client.request({path:this.gapi.gamesAPI+"/leaderboards/"+leaderboardID+"/window/"+collection,method:"GET",params:{timeSpan:timeSpan},callback:function(response){if(dialog.closed)return;if(response.error){if(callback){callbackSent=true;callback(response.error);dialog.close()}return}var scores=[];var items=[];if(response&&response.items){items=response.items.slice(0)}if(response&&response.playerScore){items.push(response.playerScore)}for(var i=0;i<items.length;++i){var item=items[i];var score=fromGPScoreToCocoonScore(item,leaderboardID);score.imageURL+="?sz=50";score.position=item.scoreRank||i+1;score.me=false;scores.push(score)}var js="addScores("+JSON.stringify(scores)+")";dialog.eval(js)}})}},prepareAchievements:function(reload,callback){if(!this._cachedAchievements||reload){var me=this;this.gapi.client.request({path:this.gapi.gamesAPI+"/achievements",callback:function(response){if(response&&!response.error){var achievements=[];if(response&&response.items){for(var i=0;i<response.items.length;i++){achievements.push(fromGPAchievementToCocoonAchievement(response.items[i]))}}me.setCachedAchievements(achievements);callback(achievements,null)}else{callback([],response?response.error:null)}}})}else{callback(this._cachedAchievements,null)}},requestAllAchievements:function(callback){this.prepareAchievements(true,callback)},requestAchievements:function(callback,userID){var me=this;this.prepareAchievements(false,function(allAchievements,error){if(error){callback([],error);return}var playerID=userID||"me";me.gapi.client.request({path:me.gapi.gamesAPI+"/players/"+playerID+"/achievements",params:{state:"UNLOCKED"},callback:function(response){if(response&&!response.error){var achievements=[];if(response.items){for(var i=0;i<response.items.length;i++){var ach=me.findAchievement(response.items[i].id);if(ach)achievements.push(ach)}}callback(achievements,null)}else{callback([],response?response.error:null)}}})})},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var achID=this.translateAchievementID(achievementID);if(this.gapi.nativeAvailable){var showNotification=!!this.gapi.settings.showAchievementNotifications;Cocoon.callNative(this.gapi.nativeExtensionName,"unlockAchievement",[achID,showNotification,callback],true)}else{this.gapi.client.request({path:this.gapi.gamesAPI+"/achievements/"+achID+"/unlock",method:"POST",callback:function(response){if(callback){callback(response?response.error:null)}}})}},resetAchievements:function(callback){this.gapi.client.request({path:"/games/v1management/achievements/reset",method:"POST",callback:function(response){if(callback){callback(response?response.error:null)}}})},showAchievements:function(callback){var ios=/(iPad|iPhone|iPod)/gi.test(navigator.userAgent);if(!ios&&this.gapi.nativeAvailable){Cocoon.callNative(this.gapi.nativeExtensionName,"showAchievements",[callback],true)}else{Cocoon.Social.SocialGamingServiceGooglePlayGames.superclass.showAchievements.call(this)}}};Cocoon.extend(Cocoon.Social.SocialGamingServiceGooglePlayGames,Cocoon.Social.SocialGamingService);function fromGPPlayerToCocoonUser(gpPlayer){return new Cocoon.Social.User(gpPlayer.playerId,gpPlayer.displayName,gpPlayer.avatarImageUrl)}function fromGPPersonToCocoonUser(gpUser){var avatar=gpUser.image?gpUser.image.url:"";avatar=avatar.replace(/sz=\d+/g,"sz=100");return new Cocoon.Social.User(gpUser.id,gpUser.displayName,avatar)}function fromImageSizeToGPSize(imageSize){if(imageSize===Cocoon.Social.ImageSize.THUMB){return 100}else if(imageSize===Cocoon.Social.ImageSize.MEDIUM){return 200}else if(imageSize===Cocoon.Social.ImageSize.LARGE){return 512}}function fromGPAchievementToCocoonAchievement(gpItem){var result=new Cocoon.Social.Achievement(gpItem.id,gpItem.name,gpItem.description,gpItem.revealedIconUrl,0);result.gpAchievementData=gpItem;return result}function fromGPScoreToCocoonScore(gpItem,leaderboardID){return new Cocoon.Social.Score(gpItem.player.playerId,gpItem.scoreValue,gpItem.player.displayName,gpItem.player.avatarImageUrl,leaderboardID)}return extension});Cocoon.define("Cocoon.Social",function(extension){extension.GameCenterExtension=function(){this.nativeExtensionName="IDTK_SRV_GAMECENTER";this.extensionName="Social.GameCenter";this.nativeAvailable=!!window.ext&&!!window.ext[this.nativeExtensionName];var me=this;if(this.nativeAvailable){this.onGameCenterLoginStateChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onGameCenterLoginStateChanged");this.onGameCenterLoginStateChanged.addEventListener(function(localPlayer,error){me._currentPlayer=localPlayer})}return this};extension.GameCenterExtension.prototype={_currentPlayer:null,getSocialInterface:function(){if(!this._socialService){this._socialService=new Cocoon.Social.SocialGamingServiceGameCenter(this)}return this._socialService},getMultiplayerInterface:function(){return Cocoon.Multiplayer.GameCenter},isLoggedIn:function(){return this._currentPlayer&&this._currentPlayer.isAuthenticated},login:function(callback){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"login",[function(response,error){me._currentPlayer=response;if(callback){callback(response,error)}}],true)}else{throw"Game Center not available"}},getLocalPlayer:function(){if(this._currentPlayer)return this._currentPlayer;if(this.nativeAvailable){this._currentPlayer=Cocoon.callNative(this.nativeExtensionName,"getLocalPlayer",[]);return this._currentPlayer}else{throw"Game Center not available"}},loadPlayers:function(playerIDs,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadPlayers",[playerIDs,callback],true)}else{throw"Game Center not available"}},loadFriends:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadFriends",[callback],true)}else{throw"Game Center not available"}},loadAchievements:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadAchievements",[callback],true)}else{throw"Game Center not available"}},loadAchievementDescriptions:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadAchievementDescriptions",[callback],true)}else{throw"Game Center not available"}},loadScores:function(callback,query){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"loadScores",[query,callback],true)}else{throw"Game Center not available"}},submitScore:function(score,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"submitScore",[score,callback],true)}else{throw"Game Center not available"}},submitAchievements:function(achievements,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"submitAchievements",[achievements,callback],true)}else{throw"Game Center not available"}},resetAchievements:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"resetAchievements",[callback],true)}else{throw"Game Center not available"}},showAchievements:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showAchievements",[callback],true)}else{throw"Game Center not available"}},showLeaderboards:function(callback,query){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showLeaderboards",[query,callback],true)}else{throw"Game Center not available"}}};extension.GameCenter=new extension.GameCenterExtension;extension.GameCenter.Player=function(){this.playerID="";this.alias="";this.isFriend=false};extension.GameCenter.LocalPlayer=function(){this.playerID="";this.alias="";this.isAuthenticated=false};extension.GameCenter.Achievement=function(identifier,percentComplete){this.identifier=identifier;this.percentComplete=percentComplete;this.lastReportedDate=0};extension.GameCenter.AchievementDescription=function(){this.identifier="";this.title="";this.achievedDescription="";this.unachievedDescription="";this.maximumPoints=0};extension.GameCenter.Score=function(userID,score,userName,imageURL,leaderboardID,originalScoreObject){this.userID=userID;this.score=score||0;this.userName=userName;this.imageURL=imageURL;this.leaderboardID=leaderboardID;this.rank=originalScoreObject.rank;this.originalScoreObject=originalScoreObject;return this};extension.GameCenter.Leaderboard=function(category,playerIDs,timeScope,playerScope,rangeStart,rangeLength){this.category=category;this.playerIDs=playerIDs;this.timeScope=timeScope;this.playerScope=playerScope;this.rangeStart=rangeStart;this.rangeLength=rangeLength;this.scores=[];this.localPlayerScore=[];this.localizedTitle=localizedTitle};extension.GameCenter.TimeScope={TODAY:0,WEEK:1,ALL_TIME:2};extension.GameCenter.PlayerScope={GLOBAL:0,FRIENDS:1};extension.SocialGamingServiceGameCenter=function(gcExtension){Cocoon.Social.SocialGamingServiceGameCenter.superclass.constructor.call(this);this.gc=gcExtension;var me=this;this.gc.onGameCenterLoginStateChanged.addEventListener(function(localPlayer,error){me.onLoginStatusChanged.notifyEventListeners(localPlayer.isAuthenticated,error)});return this};extension.SocialGamingServiceGameCenter.prototype={_cachedAchievements:null,isLoggedIn:function(){return this.gc.isLoggedIn()},login:function(callback){this.gc.login(function(localPlayer,error){if(callback)callback(localPlayer.isAuthenticated,error)})},logout:function(callback){if(callback)callback({message:"User has to logout from the Game Center APP"})},getLoggedInUser:function(){return fromGCPLayerToCocoonUser(this.gc._currentPlayer?this.gc._currentPlayer:this.gc.getLocalPlayer())},requestUser:function(callback,userId){if(userId){this.gc.loadPlayers([userId],function(response,error){var user=response&&response.length?fromGCPLayerToCocoonUser(response[0]):null;callback(user,error)})}else{var me=this;setTimeout(function(){callback(me.getLoggedInUser())})}},requestFriends:function(callback,userId){this.gc.loadFriends(function(friends,error){var users=[];if(friends&&friends.length){for(var i=0;i<friends.length;++i){users.push(fromGCPLayerToCocoonUser(friends[i]))}}callback(users,error)})},requestScore:function(callback,params){var query={};var options=params||{};if(options.leaderboardID)query.category=options.leaderboardID;query.playerIDs=[options.userID||this.getLoggedInUser().userID];this.gc.loadScores(function(response,error){var gcScore=null;if(options.userID&&response&&response.scores&&response.scores.length)gcScore=response.scores[0];else if(response&&response.localPlayerScore)gcScore=response.localPlayerScore;var loadedScore=gcScore?new Cocoon.Social.GameCenter.Score(gcScore.playerID,gcScore.value,"","",gcScore.category,gcScore):null;callback(loadedScore,error)},query)},submitScore:function(score,callback,params){var options=params||{};this.gc.submitScore({value:score,category:options.leaderboardID||""},function(error){if(callback)callback(error)})},showLeaderboard:function(callback,params){var options=params||{};this.gc.showLeaderboards(function(error){if(callback)callback(error)},{category:options.leaderboardID||""})},prepareAchievements:function(reload,callback){if(!this._cachedAchievements||reload){var me=this;this.gc.loadAchievementDescriptions(function(response,error){if(error){callback([],error)}else{var achievements=[];if(response&&response.length){for(var i=0;i<response.length;i++){achievements.push(fromGCAchievementDescriptionToCocoonAchievement(response[i]))}}me.setCachedAchievements(achievements);callback(achievements,null)}})}else{callback(this._cachedAchievements,null)}},requestAllAchievements:function(callback){this.prepareAchievements(true,callback)},requestAchievements:function(callback,userID){var me=this;this.prepareAchievements(false,function(allAchievements,error){if(error){callback([],error);return}me.gc.loadAchievements(function(response,error){if(!error){var achievements=[];if(response&&response.length){for(var i=0;i<response.length;i++){var ach=me.findAchievement(response[i].identifier);if(ach)achievements.push(ach)}}callback(achievements,null)}else{callback([],response.error)}})})},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var achID=this.translateAchievementID(achievementID);this.gc.submitAchievements([{identifier:achID,percentComplete:100}],callback)},resetAchievements:function(callback){this.gc.resetAchievements(callback)},showAchievements:function(callback){this.gc.showAchievements(function(error){if(callback)callback(error)})}};Cocoon.extend(extension.SocialGamingServiceGameCenter,extension.SocialGamingService);function fromGCPLayerToCocoonUser(player){return new Cocoon.Social.User(player.playerID,player.alias)}function fromGCAchievementDescriptionToCocoonAchievement(ach){return new Cocoon.Social.GameCenter.Achievement(ach.identifier,ach.title,ach.achievedDescription,"",ach.maximumPoints)}return extension});Cocoon.define("Cocoon.Social",function(extension){extension.FacebookExtension=function(){this.nativeExtensionName="IDTK_SRV_FACEBOOK";this.extensionName="Social.Facebook";this.nativeAvailable=!!window.ext&&!!window.ext[this.nativeExtensionName];this.Event=new Cocoon.Social.FacebookEvent(this.nativeAvailable);var me=this;if(this.nativeAvailable){this.onFacebookSessionStateChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onFacebookSessionStateChanged");Cocoon.Social.Facebook=this;this.onFacebookSessionStateChanged.addEventListener(function(session,error){var data=fromCocoonFBSessionToFBAPISession(session,error);if(session.state==0){me.Event.notify("auth.login",data)}me.Event.notify("auth.authResponseChange",data);me.Event.notify("auth.statusChange",data)})}return this};extension.FacebookExtension.prototype={_currentSession:null,_appId:null,_socialService:null,init:function(options){if(!options||!options.appId){throw"appId must be specified!"}this._appId=options.appId;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"init",[options],true)}else{FB.init(options)}var me=this;this.Event.subscribe("auth.authResponseChange",function(session){me._currentSession=session;if(session.authResponse&&!session.authResponse.user){me.api("me?fields=username",function(response){me._currentSession.authResponse.user=response})}})},getSocialInterface:function(){if(!this._appId){throw"You must call init() before getting the Social Interface"}if(!this._socialService){this._socialService=new Cocoon.Social.SocialGamingServiceFacebook(this)}return this._socialService},login:function(callback,options){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"login",[options,function(response,error){me._currentSession=fromCocoonFBSessionToFBAPISession(response,error);if(callback){callback(me._currentSession)}}],true)}else{FB.login(function(response){me._currentSession=response;if(callback)callback(response)},options)}},logout:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"logout",[function(response,error){if(callback){callback(fromCocoonFBSessionToFBAPISession(response,error))}}],true)}else{FB.logout(function(response){if(callback){callback(response)}})}},getAuthResponse:function(){if(this.nativeAvailable){var response=Cocoon.callNative(this.nativeExtensionName,"getFacebookSession",[]);
return fromCocoonFBSessionToFBAPISession(response)}else{return FB.getAuthResponse()}},getLoginStatus:function(callback,force){if(this.nativeAvailable){var me=this;setTimeout(function(){var response=Cocoon.callNative(me.nativeExtensionName,"getFacebookSession",[]);if(callback){callback(fromCocoonFBSessionToFBAPISession(response))}},50)}else{FB.getLoginStatus(callback,force)}},api:function(path,method,params,cb){if(this.nativeAvailable){var openGraph=arguments[0];var httpMethod=arguments.length>3?arguments[1]:"GET";var options=null;if(arguments.length==3)options=arguments[1];if(arguments.length==4)options=arguments[2];var callback=arguments.length>1?arguments[arguments.length-1]:function(){};return Cocoon.callNative(this.nativeExtensionName,"api",[openGraph,httpMethod,options,callback],true)}else{FB.api(path,method,params,cb)}},ui:function(params,cb){if(this.nativeAvailable){var params=arguments[0];var callback=arguments.length>1?arguments[1]:function(){};return Cocoon.callNative(this.nativeExtensionName,"ui",[params,callback],true)}else if(!navigator.isCocoonJS){FB.ui(params,cb)}},requestAdditionalPermissions:function(permissionsType,permissions,callback){if(this.nativeAvailable){var permsArray=permissions.split(",");Cocoon.callNative(this.nativeExtensionName,"requestAdditionalPermissions",[permissionsType,permsArray,function(session,error){if(callback){callback(fromCocoonFBSessionToFBAPISession(session,error))}}],true)}else{FB.login(callback,{scope:permissions})}},getPermissions:function(callback){this.api("me/permissions",function(response){callback(response.data&&response.data[0]?response.data[0]:{})})},showShareDialog:function(params,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showShareDialog",[params,callback],true)}else{params.method="feed";FB.ui(params,callback)}},uploadPhoto:function(file,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"uploadPhoto",[file,callback],true)}else{callback({error:{message:"Not implemented"}})}},showFriendPicker:function(callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"showFriendPicker",[callback],true)}else{callback({error:{message:"Not implemented"}})}}};extension.FacebookEvent=function(nativeAvailable){this.nativeAvailable=nativeAvailable;return this};extension.FacebookEvent.prototype={subscribe:function(name,callback){if(this.nativeAvailable){var eventKey=name+"listeners";this[eventKey]=this[eventKey]||[];this[eventKey].push(callback)}else if(!navigator.isCocoonJS){FB.Event.subscribe(name,callback)}},unsubscribe:function(name,callback){if(this.nativeAvailable){var eventKey=name+"listeners";var array=this[eventKey];if(array){var index=array.indexOf(callback);if(index!==-1){array.splice(index,1)}}}else if(!navigator.isCocoonJS){FB.Event.unsubscribe(name,callback)}},notify:function(name,param){var eventKey=name+"listeners";var array=this[eventKey];if(array){for(var i=0;i<array.length;++i){array[i](param)}}}};extension.Facebook=new extension.FacebookExtension;function fromCocoonFBStatusToFBAPIState(state){if(state===0){return"connected"}else if(state===1){return"not_authorized"}else{return"unknown"}}function fromCocoonFBSessionToFBAPISession(response,error){var authResponse=null;if(response.state===0){authResponse={accessToken:response.accessToken,expirationDate:response.expirationDate,userID:response.user?response.userID:null,permissions:response.permissions,user:response.user}}return{status:fromCocoonFBStatusToFBAPIState(response.state),authResponse:authResponse,error:error}}extension.SocialGamingServiceFacebook=function(fbExtension){Cocoon.Social.SocialGamingServiceFacebook.superclass.constructor.call(this);this.fb=fbExtension;var me=this;this.fb.Event.subscribe("auth.authResponseChange",function(session){me.onLoginStatusChanged.notifyEventListeners(session.status=="connected",session.error)});return this};extension.SocialGamingServiceFacebook.prototype={currentPermissions:null,isLoggedIn:function(){return this.fb._currentSession&&this.fb._currentSession.status==="connected"},login:function(callback){var me=this;this.fb.login(function(response){if(callback)callback(me.isLoggedIn(),response.error)})},logout:function(callback){this.fb.logout(function(response){if(callback)callback(response.error)})},getLoggedInUser:function(){var authResponse=this.fb._currentSession?this.fb._currentSession.authResponse:null;if(authResponse&&authResponse.user){return fromFBUserToCocoonUser(authResponse.user)}else if(authResponse&&authResponse.userID){return new Cocoon.Social.Facebook.User(authResponse.userID,"Loading...")}return null},hasPublishPermissions:function(callback){this.fb.getPermissions(function(perms,error){callback(perms.publish_actions,error)})},requestPublishPermissions:function(callback){var me=this;this.fb.requestAdditionalPermissions("publish","publish_actions",function(response){if(response.error)callback(false,error);else{me.hasPublishPermissions(function(granted,error){callback(granted,error)})}})},requestUser:function(calback,userId){var apiCall=userId||"me";this.fb.api(apiCall,function(response){var user=response.error?null:fromFBUserToCocoonUser(response);calback(user,response.error)})},requestUserImage:function(callback,userID,imageSize){if(!userID&&this.isLoggedIn()){userID=this.fb._currentSession.authResponse.userID}var fbPictureSize="small";if(imageSize===Cocoon.Social.ImageSize.THUMB){fbPictureSize="square"}else if(imageSize===Cocoon.Social.ImageSize.MEDIUM){fbPictureSize="normal"}else if(imageSize===Cocoon.Social.ImageSize.LARGE){fbPictureSize="large"}var url="https://graph.facebook.com/"+userID+"/picture?type="+fbPictureSize;callback(url)},requestFriends:function(callback,userId){var apiCall=(userId||"me")+"/friends";this.fb.api(apiCall,function(response){var friends=[];if(!response.error){for(var i=0;i<response.data.length;i++){friends.push(fromFBUserToCocoonUser(response.data[i]))}}callback(friends,response.error)})},preparePublishAction:function(callback){if(!this.currentPermissions){var me=this;this.fb.getPermissions(function(perms){me.currentPermissions=perms;if(perms)me.preparePublishAction(callback)})}else if(this.currentPermissions.publish_actions){callback(true)}else{this.currentPermissions=null;this.fb.requestAdditionalPermissions("publish","publish_actions",function(response){callback(response.error?false:true)})}},publishMessage:function(message,callback){this.preparePublishAction(function(granted){if(granted){var params=fromCocoonMessageToFBMessage(message);var apiCall="me/feed";this.fb.api(apiCall,params,function(response){if(callback)callback(response.error)})}else{if(callback)callback({message:"No publish_actions permission granted"})}})},publishMessageWithDialog:function(message,callback){this.fb.showShareDialog(fromCocoonMessageToFBMessage(message),function(response){if(callback){callback(response.error)}})},requestScore:function(callback,params){var apiCall=(params&&params.userID?params.userID:"me")+"/scores";this.fb.api(apiCall,function(response){if(response.error){callback(null,response.error)}else if(response.data&&response.data.length>0){var data=fromFBScoreToCocoonScore(response.data[0]);callback(data,null)}else{callback(null,null)}})},submitScore:function(score,callback,params){var me=this;this.preparePublishAction(function(granted){if(granted){me.requestScore(function(currentScore,error){if(error){if(callback)callback(error);return}var topScore=currentScore?currentScore.score:0;if(score<=topScore){if(callback)callback(null);return}var apiCall="/"+(params&&params.userID?params.userID:"me")+"/scores";me.fb.api(apiCall,"POST",{score:score},function(response){if(callback)callback(response.error)})},params)}else{if(callback)callback({message:"No publish_actions permission granted"})}})},showLeaderboard:function(callback,params){if(!this._leaderboardsTemplate)throw"Please, provide a html template for leaderboards with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._leaderboardsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;this.fb.api(me.fb._appId+"/scores",function(response){if(dialog.closed)return;if(response.error){if(callback){callbackSent=true;callback(response.error);dialog.close()}return}var scores=[];if(response.data&&response.data.length){for(var i=0;i<response.data.length;++i){var score=fromFBScoreToCocoonScore(response.data[i]);score.position=i;score.imageURL="https://graph.facebook.com/"+score.userID+"/picture";score.me=score.userID===me.fb._currentSession.authResponse.userID;scores.push(score)}}var js="addScores("+JSON.stringify(scores)+")";dialog.eval(js)})},prepareAchievements:function(reload,callback){if(!this._cachedAchievements||reload){var me=this;this.fb.api(this.fb._appId+"/achievements",function(response){if(!response.error){var achievements=[];if(response.data){for(var i=0;i<response.data.length;i++){achievements.push(fromFBAchievementToCocoonAchievement(response.data[i]))}}me.setCachedAchievements(achievements);callback(achievements,null)}else{callback([],response.error)}})}else{callback(this._cachedAchievements,null)}},requestAllAchievements:function(callback){this.prepareAchievements(true,callback)},requestAchievements:function(callback,userID){var me=this;this.prepareAchievements(false,function(allAchievements,error){if(error){callback([],error);return}var apiCall=(userID||"me")+"/achievements";me.fb.api(apiCall,function(response){if(!response.error){var achievements=[];if(response.data){for(var i=0;i<response.data.length;i++){var ach=me.findAchievement((response.data[i].achievement||response.data[i].data.achievement).id);if(ach)achievements.push(ach)}}callback(achievements,null)}else{callback([],response.error)}})})},submitAchievement:function(achievementID,callback){if(achievementID===null||typeof achievementID==="undefined")throw"No achievementID specified";var achID=this.translateAchievementID(achievementID);var me=this;this.preparePublishAction(function(granted){if(granted){me.fb.api("me/achievements","POST",{achievement:achID},function(response){if(callback){callback(response.error)}})}else{if(callback)callback({message:"No publish_actions permission granted"})}})},resetAchievements:function(callback){var me=this;this.preparePublishAction(function(granted){if(granted){me.requestAchievements(function(achievements,error){if(error){if(callback)callback(error);return}var someError=null;var remaining=achievements.length;for(var i=0;i<achievements.length;++i){me.fb.api("me/achievements","DELETE",{achievement:achievements[i].fbAchievementData.url},function(response){if(response.error){someError=response.error}remaining--;if(remaining==0&&callback){callback(someError)}})}})}else{if(callback)callback({message:"No publish_actions permission granted"})}})},showAchievements:function(callback){if(!this._achievementsTemplate)throw"Please, provide a html template for achievements with the setTemplates method";var dialog=new Cocoon.Widget.WebDialog;var callbackSent=false;dialog.show(this._achievementsTemplate,function(error){dialog.closed=true;if(!callbackSent&&callback)callback(error)});var me=this;this.requestAchievements(function(achievements,error){if(dialog.closed)return;if(error){callbackSent=true;if(callback)callback(error);return}var achs=[];if(me._cachedAchievements){for(var i=0;i<me._cachedAchievements.length;++i){var ach=me._cachedAchievements[i];achs.push(ach);if(achievements&&achievements.length){for(var j=0;j<achievements.length;++j){if(achievements[j].achievementID===ach.achievementID){ach.achieved=true;break}}}}}var js="addAchievements("+JSON.stringify(achs)+");";dialog.eval(js)})}};Cocoon.extend(extension.SocialGamingServiceFacebook,extension.SocialGamingService);function fromFBUserToCocoonUser(facebookUser){return new Cocoon.Social.User(facebookUser.id,facebookUser.username?facebookUser.username:facebookUser.first_name+" "+facebookUser.last_name)}function fromCocoonMessageToFBMessage(message){return{link:message.linkURL,description:message.message,name:message.linkText,caption:message.linkCaption,picture:message.mediaURL}}function fromFBScoreToCocoonScore(fbResponse,requestScoreParams){var result=new Cocoon.Social.Score(fbResponse.user.id,fbResponse.score,fbResponse.user.name);if(requestScoreParams){result.leaderboardID=requestScoreParams.leaderboardID}result.imageURL="https://graph.facebook.com/"+fbResponse.user.id+"/picture";return result}function fromFBAchievementToCocoonAchievement(fbResponse){var result=new Cocoon.Social.Achievement(fbResponse.id,fbResponse.title,fbResponse.description,fbResponse.image[0].url,fbResponse.data.points);result.fbAchievementData=fbResponse;return result}if(!navigator.isCocoonJS&&!(typeof module!=="undefined"&&module.exports)){var parent=document.getElementsByTagName("script")[0];var script=document.createElement("script");var prot=location.protocol?location.protocol:"http:";script.src=prot+"//connect.facebook.net/en_US/all.js";parent.parentNode.insertBefore(script,parent)}return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){extension.MultiplayerService=function(nativeExtensionName,extensionName){this.nativeExtensionName=nativeExtensionName;this.extensionName=extensionName;this.nativeAvailable=!!window.ext&&!!window.ext[this.nativeExtensionName];var me=this;this.onInvitationReceived=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onInvitationReceived");this.onInvitationLoaded=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onInvitationLoaded",function(sourceListener,args){var matchID=args[0];var error=args[1];if(matchID&&!error){me.currentMatch=new Cocoon.Multiplayer.Match(me.nativeExtensionName,me.extensionName,matchID);sourceListener(me.currentMatch,null)}else{sourceListener(null,error)}});var signal=new Cocoon.Signal.createSignal;signal.register("invitation",{received:this.onInvitationReceived,loaded:this.onInvitationLoaded});this.on=signal.expose();return this};extension.MultiplayerService.prototype={currentMatch:null,findMatch:function(matchRequest,callback){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"findMatch",[matchRequest,function(matchID,error){if(matchID&&!error){me.currentMatch=new Cocoon.Multiplayer.Match(me.nativeExtensionName,me.extensionName,matchID);callback(me.currentMatch,null)}else{callback(null,error)}}],true)}},findAutoMatch:function(matchRequest,callback){var me=this;if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"findAutoMatch",[matchRequest,function(matchID,error){if(matchID&&!error){me.currentMatch=new Cocoon.Multiplayer.Match(me.nativeExtensionName,me.extensionName,matchID);callback(me.currentMatch,null)}else{callback(null,error)}}],true)}},cancelAutoMatch:function(){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"cancelAutoMatch",[],true)}},addPlayersToMatch:function(matchRequest,match,callback){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"addPlayersToMatch",[matchRequest,match.matchID,callback],true)}},getMatch:function(){return this.currentMatch}};extension.Match=function(nativeExtensionName,extensionName,matchID){if(typeof nativeExtensionName!=="string")throw"The given native extension name '"+nativeExtensionName+"' is not a string.";if(typeof extensionName!=="string")throw"The given extension name '"+nativeExtensionName+"' is not a string.";this.nativeExtensionName=nativeExtensionName;this.extensionName=extensionName;this.nativeAvailable=Cocoon.nativeAvailable&&typeof window.ext[nativeExtensionName]!=="undefined";this.matchID=matchID;var me=this;this.onMatchDataReceived=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchDataReceived",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1],args[2])}});this.onMatchStateChanged=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchStateChanged",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1],args[2])}});this.onMatchConnectionWithPlayerFailed=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchConnectionWithPlayerFailed",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1],args[2])}});this.onMatchFailed=new Cocoon.EventHandler(this.nativeExtensionName,this.extensionName,"onMatchFailed",function(sourceListener,args){if(me.matchID===args[0]){sourceListener(me,args[1])}});var signal=new Cocoon.Signal.createSignal;signal.register("match",{dataReceived:this.onMatchDataReceived,stateChanged:this.onMatchStateChanged,connectionWithPlayerFailed:this.onMatchConnectionWithPlayerFailed,failed:this.onMatchFailed});this.on=signal.expose()};extension.Match.prototype={start:function(){if(this.nativeAvailable){Cocoon.callNative(this.nativeExtensionName,"startMatch",[this.matchID],true)}},sendDataToAllPlayers:function(data,sendMode){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"sendDataToAllPlayers",[this.matchID,data,sendMode])}},sendData:function(data,playerIDs,sendMode){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"sendData",[this.matchID,data,playerIDs,sendMode])}},disconnect:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"disconnect",[this.matchID],true)}},requestPlayersInfo:function(callback){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"requestPlayersInfo",[this.matchID,callback],true)}},getExpectedPlayerCount:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"getExpectedPlayerCount",[this.matchID])}},getPlayerIDs:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"getPlayerIDs",[this.matchID])}},getLocalPlayerID:function(){if(this.nativeAvailable){return Cocoon.callNative(this.nativeExtensionName,"getLocalPlayerID",[this.matchID])}return""}};extension.SendDataMode={RELIABLE:0,UNRELIABLE:1};extension.ConnectionState={UNKNOWN:0,CONNECTED:1,DISCONNECTED:2};extension.PlayerInfo=function(userID,userName){this.userID=userID;this.userName=userName};extension.MatchRequest=function(minPlayers,maxPlayers,playersToInvite,playerGroup,playerAttributes){this.minPlayers=minPlayers;this.maxPlayers=maxPlayers;this.playersToInvite=playersToInvite;this.playerGroup=playerGroup;this.playerAttributes=playerAttributes;return this};return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){var loopbackServices=[];var indexCounter=0;var matchServices=[];var matchCounter=0;extension.LoopbackService=function(){Cocoon.Multiplayer.LoopbackService.superclass.constructor.call(this,"dummy","dummy");loopbackServices.push(this);this.playerID=""+indexCounter;indexCounter++};extension.LoopbackService.prototype={findMatch:function(request,callback){this.findMatchCallback=callback;var exists=false;for(var i=0;i<matchServices.length;++i){if(matchServices[i]===this){exists=true;break}}if(!exists)matchServices.push(this);if(matchServices.length>=request.minPlayers){var playerIDs=[];for(var i=0;i<matchServices.length;++i){playerIDs.push(matchServices[i].getPlayerID())}for(var i=0;i<matchServices.length;++i){var match=new LoopbackMatch(matchServices[i]);match.playerIDs=playerIDs.slice();matchServices[i].currentMatch=match;matchServices[i].findMatchCallback(match,null)}matchServices=[]}},findAutoMatch:function(matchRequest,callback){this.findMatch(matchRequest,callback)},cancelAutoMatch:function(){},addPlayersToMatch:function(matchRequest,match,callback){callback({message:"Not implemmented"})},getPlayerID:function(){return this.playerID},getMatch:function(){return this.currentMatch}};Cocoon.extend(extension.LoopbackService,extension.MultiplayerService);var LoopbackMatch=function(service){matchCounter++;LoopbackMatch.superclass.constructor.call(this,"","",matchCounter);this.started=false;this.disconnected=false;this.pendingData=[];this.service=service};LoopbackMatch.prototype={start:function(){var me=this;setTimeout(function(){me.started=true;for(var i=0;i<me.pendingData.length;++i){me.onMatchDataReceived.notifyEventListeners(me.matchID,me.pendingData[i].data,me.pendingData[i].player)}},0)},sendDataToAllPlayers:function(data,sendMode){this.sendData(data,this.playerIDs,sendMode)},sendData:function(data,playerIDs,sendMode){var me=this;setTimeout(function(){for(var i=0;i<loopbackServices.length;++i){var destService=null;for(var j=0;j<playerIDs.length;++j){if(playerIDs[j]===loopbackServices[i].getPlayerID()){destService=loopbackServices[i]}}if(destService){destService.getMatch().notifyDataReceived(data,me.service.getPlayerID())}}},0)},disconnect:function(){this.disconnected=true;for(var i=0;i<this.playerIDs.length;++i){var p=this.playerIDs[i];for(var j=0;j<loopbackServices.length;++j){if(loopbackServices[j].getPlayerID()===p){var match=loopbackServices[i].getMatch();if(!match.disconnected){match.onMatchStateChanged.notifyEventListeners(match,this.service.getPlayerID(),Cocoon.Multiplayer.ConnectionState.DISCONNECTED)}}}}},requestPlayersInfo:function(callback){var me=this;setTimeout(function(){var playersInfo=[];for(var i=0;i<me.playerIDs.length;++i){playersInfo[i]={userID:me.playerIDs[i],userName:"Player"+me.playerIDs[i]}}callback(playersInfo)},1)},getExpectedPlayerCount:function(){return 0},getPlayerIDs:function(){return this.playerIDs},getLocalPlayerID:function(){return this.service.playerID},notifyDataReceived:function(data,fromPlayer){if(!this.started){this.pendingData.push({data:data,player:fromPlayer})}else{this.onMatchDataReceived.notifyEventListeners(this.matchID,data,fromPlayer)}}};Cocoon.extend(LoopbackMatch,Cocoon.Multiplayer.Match);return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){extension.GooglePlayGames=new Cocoon.Multiplayer.MultiplayerService("IDTK_SRV_MULTIPLAYER_GPG","Multiplayer.GooglePlayGames");return extension});Cocoon.define("Cocoon.Multiplayer",function(extension){extension.GameCenter=new Cocoon.Multiplayer.MultiplayerService("IDTK_SRV_MULTIPLAYER_GAMECENTER","Multiplayer.GameCenter");return extension});(function(){var root=this;var PIXI=PIXI||{};PIXI.WEBGL_RENDERER=0;PIXI.CANVAS_RENDERER=1;PIXI.VERSION="v2.2.8";PIXI.blendModes={NORMAL:0,ADD:1,MULTIPLY:2,SCREEN:3,OVERLAY:4,DARKEN:5,LIGHTEN:6,COLOR_DODGE:7,COLOR_BURN:8,HARD_LIGHT:9,SOFT_LIGHT:10,DIFFERENCE:11,EXCLUSION:12,HUE:13,SATURATION:14,COLOR:15,LUMINOSITY:16};PIXI.scaleModes={DEFAULT:0,LINEAR:0,NEAREST:1};PIXI._UID=0;if(typeof Float32Array!="undefined"){PIXI.Float32Array=Float32Array;PIXI.Uint16Array=Uint16Array;PIXI.Uint32Array=Uint32Array;PIXI.ArrayBuffer=ArrayBuffer}else{PIXI.Float32Array=Array;PIXI.Uint16Array=Array}PIXI.INTERACTION_FREQUENCY=30;PIXI.AUTO_PREVENT_DEFAULT=true;PIXI.PI_2=Math.PI*2;PIXI.RAD_TO_DEG=180/Math.PI;PIXI.DEG_TO_RAD=Math.PI/180;PIXI.RETINA_PREFIX="@2x";PIXI.dontSayHello=false;PIXI.defaultRenderOptions={view:null,transparent:false,antialias:false,preserveDrawingBuffer:false,resolution:1,clearBeforeRender:true,autoResize:false};PIXI.sayHello=function(type){if(PIXI.dontSayHello)return;if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var args=["%c %c %c Pixi.js "+PIXI.VERSION+" - "+type+"  %c "+" %c "+" http://www.pixijs.com/  %c %c %c%c ","background: #ff66a5","background: #ff66a5","color: #ff66a5; background: #030307;","background: #ff66a5","background: #ffc3dc","background: #ff66a5","color: #ff2424; background: #fff","color: #ff2424; background: #fff","color: #ff2424; background: #fff"];console.log.apply(console,args)}else if(window["console"]){console.log("Pixi.js "+PIXI.VERSION+" - http://www.pixijs.com/")}PIXI.dontSayHello=true};PIXI.Point=function(x,y){this.x=x||0;this.y=y||0};PIXI.Point.prototype.clone=function(){return new PIXI.Point(this.x,this.y)};PIXI.Point.prototype.set=function(x,y){this.x=x||0;this.y=y||(y!==0?this.x:0)};PIXI.Point.prototype.constructor=PIXI.Point;PIXI.Rectangle=function(x,y,width,height){this.x=x||0;this.y=y||0;this.width=width||0;this.height=height||0};PIXI.Rectangle.prototype.clone=function(){return new PIXI.Rectangle(this.x,this.y,this.width,this.height)};PIXI.Rectangle.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var x1=this.x;if(x>=x1&&x<=x1+this.width){var y1=this.y;if(y>=y1&&y<=y1+this.height){return true}}return false};PIXI.Rectangle.prototype.constructor=PIXI.Rectangle;PIXI.EmptyRectangle=new PIXI.Rectangle(0,0,0,0);PIXI.Polygon=function(points){if(!(points instanceof Array))points=Array.prototype.slice.call(arguments);if(points[0]instanceof PIXI.Point){var p=[];for(var i=0,il=points.length;i<il;i++){p.push(points[i].x,points[i].y)}points=p}this.closed=true;this.points=points};PIXI.Polygon.prototype.clone=function(){var points=this.points.slice();return new PIXI.Polygon(points)};PIXI.Polygon.prototype.contains=function(x,y){var inside=false;var length=this.points.length/2;for(var i=0,j=length-1;i<length;j=i++){var xi=this.points[i*2],yi=this.points[i*2+1],xj=this.points[j*2],yj=this.points[j*2+1],intersect=yi>y!==yj>y&&x<(xj-xi)*(y-yi)/(yj-yi)+xi;if(intersect)inside=!inside}return inside};PIXI.Polygon.prototype.constructor=PIXI.Polygon;PIXI.Circle=function(x,y,radius){this.x=x||0;this.y=y||0;this.radius=radius||0};PIXI.Circle.prototype.clone=function(){return new PIXI.Circle(this.x,this.y,this.radius)};PIXI.Circle.prototype.contains=function(x,y){if(this.radius<=0)return false;var dx=this.x-x,dy=this.y-y,r2=this.radius*this.radius;dx*=dx;dy*=dy;return dx+dy<=r2};PIXI.Circle.prototype.getBounds=function(){return new PIXI.Rectangle(this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2)};PIXI.Circle.prototype.constructor=PIXI.Circle;PIXI.Ellipse=function(x,y,width,height){this.x=x||0;this.y=y||0;this.width=width||0;this.height=height||0};PIXI.Ellipse.prototype.clone=function(){return new PIXI.Ellipse(this.x,this.y,this.width,this.height)};PIXI.Ellipse.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var normx=(x-this.x)/this.width,normy=(y-this.y)/this.height;normx*=normx;normy*=normy;return normx+normy<=1};PIXI.Ellipse.prototype.getBounds=function(){return new PIXI.Rectangle(this.x-this.width,this.y-this.height,this.width,this.height)};PIXI.Ellipse.prototype.constructor=PIXI.Ellipse;PIXI.RoundedRectangle=function(x,y,width,height,radius){this.x=x||0;this.y=y||0;this.width=width||0;this.height=height||0;this.radius=radius||20};PIXI.RoundedRectangle.prototype.clone=function(){return new PIXI.RoundedRectangle(this.x,this.y,this.width,this.height,this.radius)};PIXI.RoundedRectangle.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var x1=this.x;if(x>=x1&&x<=x1+this.width){var y1=this.y;if(y>=y1&&y<=y1+this.height){return true}}return false};PIXI.RoundedRectangle.prototype.constructor=PIXI.RoundedRectangle;PIXI.Matrix=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0};PIXI.Matrix.prototype.fromArray=function(array){this.a=array[0];this.b=array[1];this.c=array[3];this.d=array[4];this.tx=array[2];this.ty=array[5]};PIXI.Matrix.prototype.toArray=function(transpose){if(!this.array)this.array=new PIXI.Float32Array(9);var array=this.array;if(transpose){array[0]=this.a;array[1]=this.b;array[2]=0;array[3]=this.c;array[4]=this.d;array[5]=0;array[6]=this.tx;array[7]=this.ty;array[8]=1}else{array[0]=this.a;array[1]=this.c;array[2]=this.tx;array[3]=this.b;array[4]=this.d;array[5]=this.ty;array[6]=0;array[7]=0;array[8]=1}return array};PIXI.Matrix.prototype.apply=function(pos,newPos){newPos=newPos||new PIXI.Point;newPos.x=this.a*pos.x+this.c*pos.y+this.tx;newPos.y=this.b*pos.x+this.d*pos.y+this.ty;return newPos};PIXI.Matrix.prototype.applyInverse=function(pos,newPos){newPos=newPos||new PIXI.Point;var id=1/(this.a*this.d+this.c*-this.b);newPos.x=this.d*id*pos.x+-this.c*id*pos.y+(this.ty*this.c-this.tx*this.d)*id;newPos.y=this.a*id*pos.y+-this.b*id*pos.x+(-this.ty*this.a+this.tx*this.b)*id;return newPos};PIXI.Matrix.prototype.translate=function(x,y){this.tx+=x;this.ty+=y;return this};PIXI.Matrix.prototype.scale=function(x,y){this.a*=x;this.d*=y;this.c*=x;this.b*=y;this.tx*=x;this.ty*=y;return this};PIXI.Matrix.prototype.rotate=function(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var a1=this.a;var c1=this.c;var tx1=this.tx;this.a=a1*cos-this.b*sin;this.b=a1*sin+this.b*cos;this.c=c1*cos-this.d*sin;this.d=c1*sin+this.d*cos;this.tx=tx1*cos-this.ty*sin;this.ty=tx1*sin+this.ty*cos;return this};PIXI.Matrix.prototype.append=function(matrix){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;this.a=matrix.a*a1+matrix.b*c1;this.b=matrix.a*b1+matrix.b*d1;this.c=matrix.c*a1+matrix.d*c1;this.d=matrix.c*b1+matrix.d*d1;this.tx=matrix.tx*a1+matrix.ty*c1+this.tx;this.ty=matrix.tx*b1+matrix.ty*d1+this.ty;return this};PIXI.Matrix.prototype.identity=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0;return this};PIXI.identityMatrix=new PIXI.Matrix;PIXI.DisplayObject=function(){this.position=new PIXI.Point;this.scale=new PIXI.Point(1,1);this.pivot=new PIXI.Point(0,0);this.rotation=0;this.alpha=1;this.visible=true;this.hitArea=null;this.buttonMode=false;this.renderable=false;this.parent=null;this.stage=null;this.worldAlpha=1;this._interactive=false;this.defaultCursor="pointer";this.worldTransform=new PIXI.Matrix;this._sr=0;this._cr=1;this.filterArea=null;this._bounds=new PIXI.Rectangle(0,0,1,1);this._currentBounds=null;this._mask=null;this._cacheAsBitmap=false;this._cacheIsDirty=false};PIXI.DisplayObject.prototype.constructor=PIXI.DisplayObject;Object.defineProperty(PIXI.DisplayObject.prototype,"interactive",{get:function(){return this._interactive},set:function(value){this._interactive=value;if(this.stage)this.stage.dirty=true}});Object.defineProperty(PIXI.DisplayObject.prototype,"worldVisible",{get:function(){var item=this;do{if(!item.visible)return false;item=item.parent}while(item);return true}});Object.defineProperty(PIXI.DisplayObject.prototype,"mask",{get:function(){return this._mask},set:function(value){if(this._mask)this._mask.isMask=false;this._mask=value;if(this._mask)this._mask.isMask=true}});Object.defineProperty(PIXI.DisplayObject.prototype,"filters",{get:function(){return this._filters},set:function(value){if(value){var passes=[];for(var i=0;i<value.length;i++){var filterPasses=value[i].passes;for(var j=0;j<filterPasses.length;j++){passes.push(filterPasses[j])}}this._filterBlock={target:this,filterPasses:passes}}this._filters=value}});Object.defineProperty(PIXI.DisplayObject.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap},set:function(value){if(this._cacheAsBitmap===value)return;if(value){this._generateCachedSprite()}else{this._destroyCachedSprite()}this._cacheAsBitmap=value}});PIXI.DisplayObject.prototype.updateTransform=function(){var pt=this.parent.worldTransform;var wt=this.worldTransform;var a,b,c,d,tx,ty;if(this.rotation%PIXI.PI_2){if(this.rotation!==this.rotationCache){this.rotationCache=this.rotation;this._sr=Math.sin(this.rotation);this._cr=Math.cos(this.rotation)}a=this._cr*this.scale.x;b=this._sr*this.scale.x;c=-this._sr*this.scale.y;d=this._cr*this.scale.y;tx=this.position.x;ty=this.position.y;if(this.pivot.x||this.pivot.y){tx-=this.pivot.x*a+this.pivot.y*c;ty-=this.pivot.x*b+this.pivot.y*d}wt.a=a*pt.a+b*pt.c;wt.b=a*pt.b+b*pt.d;wt.c=c*pt.a+d*pt.c;wt.d=c*pt.b+d*pt.d;wt.tx=tx*pt.a+ty*pt.c+pt.tx;wt.ty=tx*pt.b+ty*pt.d+pt.ty}else{a=this.scale.x;d=this.scale.y;tx=this.position.x-this.pivot.x*a;ty=this.position.y-this.pivot.y*d;wt.a=a*pt.a;wt.b=a*pt.b;wt.c=d*pt.c;wt.d=d*pt.d;wt.tx=tx*pt.a+ty*pt.c+pt.tx;wt.ty=tx*pt.b+ty*pt.d+pt.ty}this.worldAlpha=this.alpha*this.parent.worldAlpha};PIXI.DisplayObject.prototype.displayObjectUpdateTransform=PIXI.DisplayObject.prototype.updateTransform;PIXI.DisplayObject.prototype.getBounds=function(matrix){matrix=matrix;return PIXI.EmptyRectangle};PIXI.DisplayObject.prototype.getLocalBounds=function(){return this.getBounds(PIXI.identityMatrix)
};PIXI.DisplayObject.prototype.setStageReference=function(stage){this.stage=stage;if(this._interactive)this.stage.dirty=true};PIXI.DisplayObject.prototype.generateTexture=function(resolution,scaleMode,renderer){var bounds=this.getLocalBounds();var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0,renderer,scaleMode,resolution);PIXI.DisplayObject._tempMatrix.tx=-bounds.x;PIXI.DisplayObject._tempMatrix.ty=-bounds.y;renderTexture.render(this,PIXI.DisplayObject._tempMatrix);return renderTexture};PIXI.DisplayObject.prototype.updateCache=function(){this._generateCachedSprite()};PIXI.DisplayObject.prototype.toGlobal=function(position){this.displayObjectUpdateTransform();return this.worldTransform.apply(position)};PIXI.DisplayObject.prototype.toLocal=function(position,from){if(from){position=from.toGlobal(position)}this.displayObjectUpdateTransform();return this.worldTransform.applyInverse(position)};PIXI.DisplayObject.prototype._renderCachedSprite=function(renderSession){this._cachedSprite.worldAlpha=this.worldAlpha;if(renderSession.gl){PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession)}else{PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession)}};PIXI.DisplayObject.prototype._generateCachedSprite=function(){this._cacheAsBitmap=false;var bounds=this.getLocalBounds();if(!this._cachedSprite){var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0);this._cachedSprite=new PIXI.Sprite(renderTexture);this._cachedSprite.worldTransform=this.worldTransform}else{this._cachedSprite.texture.resize(bounds.width|0,bounds.height|0)}var tempFilters=this._filters;this._filters=null;this._cachedSprite.filters=tempFilters;PIXI.DisplayObject._tempMatrix.tx=-bounds.x;PIXI.DisplayObject._tempMatrix.ty=-bounds.y;this._cachedSprite.texture.render(this,PIXI.DisplayObject._tempMatrix,true);this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._filters=tempFilters;this._cacheAsBitmap=true};PIXI.DisplayObject.prototype._destroyCachedSprite=function(){if(!this._cachedSprite)return;this._cachedSprite.texture.destroy(true);this._cachedSprite=null};PIXI.DisplayObject.prototype._renderWebGL=function(renderSession){renderSession=renderSession};PIXI.DisplayObject.prototype._renderCanvas=function(renderSession){renderSession=renderSession};PIXI.DisplayObject._tempMatrix=new PIXI.Matrix;Object.defineProperty(PIXI.DisplayObject.prototype,"x",{get:function(){return this.position.x},set:function(value){this.position.x=value}});Object.defineProperty(PIXI.DisplayObject.prototype,"y",{get:function(){return this.position.y},set:function(value){this.position.y=value}});PIXI.DisplayObjectContainer=function(){PIXI.DisplayObject.call(this);this.children=[]};PIXI.DisplayObjectContainer.prototype=Object.create(PIXI.DisplayObject.prototype);PIXI.DisplayObjectContainer.prototype.constructor=PIXI.DisplayObjectContainer;Object.defineProperty(PIXI.DisplayObjectContainer.prototype,"width",{get:function(){return this.scale.x*this.getLocalBounds().width},set:function(value){var width=this.getLocalBounds().width;if(width!==0){this.scale.x=value/width}else{this.scale.x=1}this._width=value}});Object.defineProperty(PIXI.DisplayObjectContainer.prototype,"height",{get:function(){return this.scale.y*this.getLocalBounds().height},set:function(value){var height=this.getLocalBounds().height;if(height!==0){this.scale.y=value/height}else{this.scale.y=1}this._height=value}});PIXI.DisplayObjectContainer.prototype.addChild=function(child){return this.addChildAt(child,this.children.length)};PIXI.DisplayObjectContainer.prototype.addChildAt=function(child,index){if(index>=0&&index<=this.children.length){if(child.parent){child.parent.removeChild(child)}child.parent=this;this.children.splice(index,0,child);if(this.stage)child.setStageReference(this.stage);return child}else{throw new Error(child+"addChildAt: The index "+index+" supplied is out of bounds "+this.children.length)}};PIXI.DisplayObjectContainer.prototype.swapChildren=function(child,child2){if(child===child2){return}var index1=this.getChildIndex(child);var index2=this.getChildIndex(child2);if(index1<0||index2<0){throw new Error("swapChildren: Both the supplied DisplayObjects must be a child of the caller.")}this.children[index1]=child2;this.children[index2]=child};PIXI.DisplayObjectContainer.prototype.getChildIndex=function(child){var index=this.children.indexOf(child);if(index===-1){throw new Error("The supplied DisplayObject must be a child of the caller")}return index};PIXI.DisplayObjectContainer.prototype.setChildIndex=function(child,index){if(index<0||index>=this.children.length){throw new Error("The supplied index is out of bounds")}var currentIndex=this.getChildIndex(child);this.children.splice(currentIndex,1);this.children.splice(index,0,child)};PIXI.DisplayObjectContainer.prototype.getChildAt=function(index){if(index<0||index>=this.children.length){throw new Error("getChildAt: Supplied index "+index+" does not exist in the child list, or the supplied DisplayObject must be a child of the caller")}return this.children[index]};PIXI.DisplayObjectContainer.prototype.removeChild=function(child){var index=this.children.indexOf(child);if(index===-1)return;return this.removeChildAt(index)};PIXI.DisplayObjectContainer.prototype.removeChildAt=function(index){var child=this.getChildAt(index);if(this.stage)child.removeStageReference();child.parent=undefined;this.children.splice(index,1);return child};PIXI.DisplayObjectContainer.prototype.removeChildren=function(beginIndex,endIndex){var begin=beginIndex||0;var end=typeof endIndex==="number"?endIndex:this.children.length;var range=end-begin;if(range>0&&range<=end){var removed=this.children.splice(begin,range);for(var i=0;i<removed.length;i++){var child=removed[i];if(this.stage)child.removeStageReference();child.parent=undefined}return removed}else if(range===0&&this.children.length===0){return[]}else{throw new Error("removeChildren: Range Error, numeric values are outside the acceptable range")}};PIXI.DisplayObjectContainer.prototype.updateTransform=function(){if(!this.visible)return;this.displayObjectUpdateTransform();if(this._cacheAsBitmap)return;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}};PIXI.DisplayObjectContainer.prototype.displayObjectContainerUpdateTransform=PIXI.DisplayObjectContainer.prototype.updateTransform;PIXI.DisplayObjectContainer.prototype.getBounds=function(){if(this.children.length===0)return PIXI.EmptyRectangle;var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;var childBounds;var childMaxX;var childMaxY;var childVisible=false;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];if(!child.visible)continue;childVisible=true;childBounds=this.children[i].getBounds();minX=minX<childBounds.x?minX:childBounds.x;minY=minY<childBounds.y?minY:childBounds.y;childMaxX=childBounds.width+childBounds.x;childMaxY=childBounds.height+childBounds.y;maxX=maxX>childMaxX?maxX:childMaxX;maxY=maxY>childMaxY?maxY:childMaxY}if(!childVisible)return PIXI.EmptyRectangle;var bounds=this._bounds;bounds.x=minX;bounds.y=minY;bounds.width=maxX-minX;bounds.height=maxY-minY;return bounds};PIXI.DisplayObjectContainer.prototype.getLocalBounds=function(){var matrixCache=this.worldTransform;this.worldTransform=PIXI.identityMatrix;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}var bounds=this.getBounds();this.worldTransform=matrixCache;return bounds};PIXI.DisplayObjectContainer.prototype.setStageReference=function(stage){this.stage=stage;if(this._interactive)this.stage.dirty=true;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child.setStageReference(stage)}};PIXI.DisplayObjectContainer.prototype.removeStageReference=function(){for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child.removeStageReference()}if(this._interactive)this.stage.dirty=true;this.stage=null};PIXI.DisplayObjectContainer.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return}var i,j;if(this._mask||this._filters){if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start()}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.popFilter();renderSession.spriteBatch.start()}else{for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}}};PIXI.DisplayObjectContainer.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession)}};PIXI.Sprite=function(texture){PIXI.DisplayObjectContainer.call(this);this.anchor=new PIXI.Point;this.texture=texture||PIXI.Texture.emptyTexture;this._width=0;this._height=0;this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL;this.shader=null;if(this.texture.baseTexture.hasLoaded){this.onTextureUpdate()}else{this.texture.on("update",this.onTextureUpdate.bind(this))}this.renderable=true};PIXI.Sprite.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Sprite.prototype.constructor=PIXI.Sprite;Object.defineProperty(PIXI.Sprite.prototype,"width",{get:function(){return this.scale.x*this.texture.frame.width},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value}});Object.defineProperty(PIXI.Sprite.prototype,"height",{get:function(){return this.scale.y*this.texture.frame.height},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value}});PIXI.Sprite.prototype.setTexture=function(texture){this.texture=texture;this.cachedTint=16777215};PIXI.Sprite.prototype.onTextureUpdate=function(){if(this._width)this.scale.x=this._width/this.texture.frame.width;if(this._height)this.scale.y=this._height/this.texture.frame.height};PIXI.Sprite.prototype.getBounds=function(matrix){var width=this.texture.frame.width;var height=this.texture.frame.height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;if(b===0&&c===0){if(a<0)a*=-1;if(d<0)d*=-1;minX=a*w1+tx;maxX=a*w0+tx;minY=d*h1+ty;maxY=d*h0+ty}else{var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY}var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.Sprite.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;var i,j;if(this._mask||this._filters){var spriteBatch=renderSession.spriteBatch;if(this._filters){spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(this._mask){spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);spriteBatch.start()}spriteBatch.render(this);for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}spriteBatch.stop();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.popFilter();spriteBatch.start()}else{renderSession.spriteBatch.render(this);for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}}};PIXI.Sprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0||this.texture.crop.width<=0||this.texture.crop.height<=0)return;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;renderSession.context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}if(this.texture.valid){var resolution=this.texture.baseTexture.resolution/renderSession.resolution;renderSession.context.globalAlpha=this.worldAlpha;if(renderSession.smoothProperty&&renderSession.scaleMode!==this.texture.baseTexture.scaleMode){renderSession.scaleMode=this.texture.baseTexture.scaleMode;renderSession.context[renderSession.smoothProperty]=renderSession.scaleMode===PIXI.scaleModes.LINEAR}var dx=this.texture.trim?this.texture.trim.x-this.anchor.x*this.texture.trim.width:this.anchor.x*-this.texture.frame.width;var dy=this.texture.trim?this.texture.trim.y-this.anchor.y*this.texture.trim.height:this.anchor.y*-this.texture.frame.height;if(renderSession.roundPixels){renderSession.context.setTransform(this.worldTransform.a,this.worldTransform.b,this.worldTransform.c,this.worldTransform.d,this.worldTransform.tx*renderSession.resolution|0,this.worldTransform.ty*renderSession.resolution|0);dx=dx|0;dy=dy|0}else{renderSession.context.setTransform(this.worldTransform.a,this.worldTransform.b,this.worldTransform.c,this.worldTransform.d,this.worldTransform.tx*renderSession.resolution,this.worldTransform.ty*renderSession.resolution)}if(this.tint!==16777215){if(this.cachedTint!==this.tint){this.cachedTint=this.tint;this.tintedTexture=PIXI.CanvasTinter.getTintedTexture(this,this.tint)}renderSession.context.drawImage(this.tintedTexture,0,0,this.texture.crop.width,this.texture.crop.height,dx/resolution,dy/resolution,this.texture.crop.width/resolution,this.texture.crop.height/resolution)}else{renderSession.context.drawImage(this.texture.baseTexture.source,this.texture.crop.x,this.texture.crop.y,this.texture.crop.width,this.texture.crop.height,dx/resolution,dy/resolution,this.texture.crop.width/resolution,this.texture.crop.height/resolution)}}for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession)}};PIXI.Sprite.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache'+this);return new PIXI.Sprite(texture)};PIXI.Sprite.fromImage=function(imageId,crossorigin,scaleMode){var texture=PIXI.Texture.fromImage(imageId,crossorigin,scaleMode);return new PIXI.Sprite(texture)};PIXI.SpriteBatch=function(texture){PIXI.DisplayObjectContainer.call(this);this.textureThing=texture;this.ready=false};PIXI.SpriteBatch.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.SpriteBatch.prototype.constructor=PIXI.SpriteBatch;PIXI.SpriteBatch.prototype.initWebGL=function(gl){this.fastSpriteBatch=new PIXI.WebGLFastSpriteBatch(gl);this.ready=true};PIXI.SpriteBatch.prototype.updateTransform=function(){this.displayObjectUpdateTransform()};PIXI.SpriteBatch.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;if(!this.ready)this.initWebGL(renderSession.gl);if(this.fastSpriteBatch.gl!==renderSession.gl)this.fastSpriteBatch.setContext(renderSession.gl);renderSession.spriteBatch.stop();renderSession.shaderManager.setShader(renderSession.shaderManager.fastShader);this.fastSpriteBatch.begin(this,renderSession);this.fastSpriteBatch.render(this);renderSession.spriteBatch.start()};PIXI.SpriteBatch.prototype._renderCanvas=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;var context=renderSession.context;context.globalAlpha=this.worldAlpha;this.displayObjectUpdateTransform();var transform=this.worldTransform;var isRotated=true;for(var i=0;i<this.children.length;i++){var child=this.children[i];if(!child.visible)continue;var texture=child.texture;var frame=texture.frame;context.globalAlpha=this.worldAlpha*child.alpha;if(child.rotation%(Math.PI*2)===0){if(isRotated){context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx,transform.ty);isRotated=false}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*(-frame.width*child.scale.x)+child.position.x+.5|0,child.anchor.y*(-frame.height*child.scale.y)+child.position.y+.5|0,frame.width*child.scale.x,frame.height*child.scale.y)}else{if(!isRotated)isRotated=true;child.displayObjectUpdateTransform();var childTransform=child.worldTransform;if(renderSession.roundPixels){context.setTransform(childTransform.a,childTransform.b,childTransform.c,childTransform.d,childTransform.tx|0,childTransform.ty|0)}else{context.setTransform(childTransform.a,childTransform.b,childTransform.c,childTransform.d,childTransform.tx,childTransform.ty)}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*-frame.width+.5|0,child.anchor.y*-frame.height+.5|0,frame.width,frame.height)}}};PIXI.MovieClip=function(textures){PIXI.Sprite.call(this,textures[0]);this.textures=textures;this.animationSpeed=1;this.loop=true;this.onComplete=null;this.currentFrame=0;this.playing=false};PIXI.MovieClip.prototype=Object.create(PIXI.Sprite.prototype);PIXI.MovieClip.prototype.constructor=PIXI.MovieClip;Object.defineProperty(PIXI.MovieClip.prototype,"totalFrames",{get:function(){return this.textures.length}});PIXI.MovieClip.prototype.stop=function(){this.playing=false};PIXI.MovieClip.prototype.play=function(){this.playing=true};PIXI.MovieClip.prototype.gotoAndStop=function(frameNumber){this.playing=false;this.currentFrame=frameNumber;var round=this.currentFrame+.5|0;this.setTexture(this.textures[round%this.textures.length])};PIXI.MovieClip.prototype.gotoAndPlay=function(frameNumber){this.currentFrame=frameNumber;this.playing=true};PIXI.MovieClip.prototype.updateTransform=function(){this.displayObjectContainerUpdateTransform();if(!this.playing)return;this.currentFrame+=this.animationSpeed;var round=this.currentFrame+.5|0;this.currentFrame=this.currentFrame%this.textures.length;if(this.loop||round<this.textures.length){this.setTexture(this.textures[round%this.textures.length])}else if(round>=this.textures.length){this.gotoAndStop(this.textures.length-1);if(this.onComplete){this.onComplete()}}};PIXI.MovieClip.fromFrames=function(frames){var textures=[];for(var i=0;i<frames.length;i++){textures.push(new PIXI.Texture.fromFrame(frames[i]))}return new PIXI.MovieClip(textures)};PIXI.MovieClip.fromImages=function(images){var textures=[];for(var i=0;i<images.length;i++){textures.push(new PIXI.Texture.fromImage(images[i]))}return new PIXI.MovieClip(textures)};PIXI.FilterBlock=function(){this.visible=true;this.renderable=true};PIXI.FilterBlock.prototype.constructor=PIXI.FilterBlock;PIXI.Text=function(text,style){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.resolution=1;PIXI.Sprite.call(this,PIXI.Texture.fromCanvas(this.canvas));this.setText(text);this.setStyle(style)};PIXI.Text.prototype=Object.create(PIXI.Sprite.prototype);PIXI.Text.prototype.constructor=PIXI.Text;Object.defineProperty(PIXI.Text.prototype,"width",{get:function(){if(this.dirty){this.updateText();this.dirty=false}return this.scale.x*this.texture.frame.width},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value}});Object.defineProperty(PIXI.Text.prototype,"height",{get:function(){if(this.dirty){this.updateText();this.dirty=false}return this.scale.y*this.texture.frame.height},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value}});PIXI.Text.prototype.setStyle=function(style){style=style||{};style.font=style.font||"bold 20pt Arial";style.fill=style.fill||"black";style.align=style.align||"left";style.stroke=style.stroke||"black";style.strokeThickness=style.strokeThickness||0;style.wordWrap=style.wordWrap||false;style.wordWrapWidth=style.wordWrapWidth||100;style.dropShadow=style.dropShadow||false;style.dropShadowAngle=style.dropShadowAngle||Math.PI/6;style.dropShadowDistance=style.dropShadowDistance||4;style.dropShadowColor=style.dropShadowColor||"black";style.lineJoin=style.lineJoin||"miter";this.style=style;this.dirty=true};PIXI.Text.prototype.setText=function(text){this.text=text.toString()||" ";this.dirty=true};PIXI.Text.prototype.updateText=function(){this.texture.baseTexture.resolution=this.resolution;this.context.font=this.style.font;var outputText=this.text;if(this.style.wordWrap)outputText=this.wordWrap(this.text);var lines=outputText.split(/(?:\r\n|\r|\n)/);var lineWidths=[];var maxLineWidth=0;var fontProperties=this.determineFontProperties(this.style.font);for(var i=0;i<lines.length;i++){var lineWidth=this.context.measureText(lines[i]).width;lineWidths[i]=lineWidth;maxLineWidth=Math.max(maxLineWidth,lineWidth)}var width=maxLineWidth+this.style.strokeThickness;if(this.style.dropShadow)width+=this.style.dropShadowDistance;this.canvas.width=(width+this.context.lineWidth)*this.resolution;var lineHeight=fontProperties.fontSize+this.style.strokeThickness;var height=lineHeight*lines.length;if(this.style.dropShadow)height+=this.style.dropShadowDistance;this.canvas.height=height*this.resolution;this.context.scale(this.resolution,this.resolution);if(navigator.isCocoonJS)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.font=this.style.font;this.context.strokeStyle=this.style.stroke;this.context.lineWidth=this.style.strokeThickness;this.context.textBaseline="alphabetic";this.context.lineJoin=this.style.lineJoin;var linePositionX;var linePositionY;if(this.style.dropShadow){this.context.fillStyle=this.style.dropShadowColor;var xShadowOffset=Math.sin(this.style.dropShadowAngle)*this.style.dropShadowDistance;var yShadowOffset=Math.cos(this.style.dropShadowAngle)*this.style.dropShadowDistance;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.style.fill){this.context.fillText(lines[i],linePositionX+xShadowOffset,linePositionY+yShadowOffset)}}}this.context.fillStyle=this.style.fill;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.style.stroke&&this.style.strokeThickness){this.context.strokeText(lines[i],linePositionX,linePositionY)}if(this.style.fill){this.context.fillText(lines[i],linePositionX,linePositionY)}}this.updateTexture()};PIXI.Text.prototype.updateTexture=function(){this.texture.baseTexture.width=this.canvas.width;this.texture.baseTexture.height=this.canvas.height;this.texture.crop.width=this.texture.frame.width=this.canvas.width;this.texture.crop.height=this.texture.frame.height=this.canvas.height;this._width=this.canvas.width;this._height=this.canvas.height;this.texture.baseTexture.dirty()};PIXI.Text.prototype._renderWebGL=function(renderSession){if(this.dirty){this.resolution=renderSession.resolution;this.updateText();this.dirty=false}PIXI.Sprite.prototype._renderWebGL.call(this,renderSession)};PIXI.Text.prototype._renderCanvas=function(renderSession){if(this.dirty){this.resolution=renderSession.resolution;this.updateText();this.dirty=false}PIXI.Sprite.prototype._renderCanvas.call(this,renderSession)};PIXI.Text.prototype.determineFontProperties=function(fontStyle){var properties=PIXI.Text.fontPropertiesCache[fontStyle];if(!properties){properties={};var canvas=PIXI.Text.fontPropertiesCanvas;var context=PIXI.Text.fontPropertiesContext;context.font=fontStyle;var width=Math.ceil(context.measureText("|Mq").width);var baseline=Math.ceil(context.measureText("M").width);var height=2*baseline;baseline=baseline*1.4|0;canvas.width=width;canvas.height=height;context.fillStyle="#f00";context.fillRect(0,0,width,height);context.font=fontStyle;context.textBaseline="alphabetic";context.fillStyle="#000";context.fillText("|Mq",0,baseline);var imagedata=context.getImageData(0,0,width,height).data;var pixels=imagedata.length;var line=width*4;var i,j;var idx=0;var stop=false;for(i=0;i<baseline;i++){for(j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break}}if(!stop){idx+=line}else{break}}properties.ascent=baseline-i;idx=pixels-line;stop=false;for(i=height;i>baseline;i--){for(j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break}}if(!stop){idx-=line}else{break}}properties.descent=i-baseline;properties.descent+=6;properties.fontSize=properties.ascent+properties.descent;PIXI.Text.fontPropertiesCache[fontStyle]=properties}return properties};PIXI.Text.prototype.wordWrap=function(text){var result="";var lines=text.split("\n");for(var i=0;i<lines.length;i++){var spaceLeft=this.style.wordWrapWidth;var words=lines[i].split(" ");for(var j=0;j<words.length;j++){var wordWidth=this.context.measureText(words[j]).width;var wordWidthWithSpace=wordWidth+this.context.measureText(" ").width;if(j===0||wordWidthWithSpace>spaceLeft){if(j>0){result+="\n"}result+=words[j];spaceLeft=this.style.wordWrapWidth-wordWidth}else{spaceLeft-=wordWidthWithSpace;result+=" "+words[j]}}if(i<lines.length-1){result+="\n"}}return result};PIXI.Text.prototype.getBounds=function(matrix){if(this.dirty){this.updateText();this.dirty=false}return PIXI.Sprite.prototype.getBounds.call(this,matrix)};PIXI.Text.prototype.destroy=function(destroyBaseTexture){this.context=null;this.canvas=null;this.texture.destroy(destroyBaseTexture===undefined?true:destroyBaseTexture)};PIXI.Text.fontPropertiesCache={};PIXI.Text.fontPropertiesCanvas=document.createElement("canvas");PIXI.Text.fontPropertiesContext=PIXI.Text.fontPropertiesCanvas.getContext("2d");PIXI.BitmapText=function(text,style){PIXI.DisplayObjectContainer.call(this);this.textWidth=0;this.textHeight=0;this._pool=[];this.setText(text);this.setStyle(style);this.updateText();this.dirty=false};PIXI.BitmapText.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.BitmapText.prototype.constructor=PIXI.BitmapText;PIXI.BitmapText.prototype.setText=function(text){this.text=text||" ";this.dirty=true};PIXI.BitmapText.prototype.setStyle=function(style){style=style||{};style.align=style.align||"left";this.style=style;var font=style.font.split(" ");this.fontName=font[font.length-1];this.fontSize=font.length>=2?parseInt(font[font.length-2],10):PIXI.BitmapText.fonts[this.fontName].size;this.dirty=true;this.tint=style.tint};PIXI.BitmapText.prototype.updateText=function(){var data=PIXI.BitmapText.fonts[this.fontName];var pos=new PIXI.Point;var prevCharCode=null;var chars=[];var maxLineWidth=0;var lineWidths=[];var line=0;var scale=this.fontSize/data.size;for(var i=0;i<this.text.length;i++){var charCode=this.text.charCodeAt(i);if(/(?:\r\n|\r|\n)/.test(this.text.charAt(i))){lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue}var charData=data.chars[charCode];if(!charData)continue;if(prevCharCode&&charData.kerning[prevCharCode]){pos.x+=charData.kerning[prevCharCode]}chars.push({texture:charData.texture,line:line,charCode:charCode,position:new PIXI.Point(pos.x+charData.xOffset,pos.y+charData.yOffset)});pos.x+=charData.xAdvance;prevCharCode=charCode}lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);var lineAlignOffsets=[];for(i=0;i<=line;i++){var alignOffset=0;if(this.style.align==="right"){alignOffset=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){alignOffset=(maxLineWidth-lineWidths[i])/2}lineAlignOffsets.push(alignOffset)}var lenChildren=this.children.length;var lenChars=chars.length;var tint=this.tint||16777215;for(i=0;i<lenChars;i++){var c=i<lenChildren?this.children[i]:this._pool.pop();if(c)c.setTexture(chars[i].texture);else c=new PIXI.Sprite(chars[i].texture);c.position.x=(chars[i].position.x+lineAlignOffsets[chars[i].line])*scale;c.position.y=chars[i].position.y*scale;c.scale.x=c.scale.y=scale;c.tint=tint;if(!c.parent)this.addChild(c)}while(this.children.length>lenChars){var child=this.getChildAt(this.children.length-1);this._pool.push(child);this.removeChild(child)}this.textWidth=maxLineWidth*scale;this.textHeight=(pos.y+data.lineHeight)*scale};PIXI.BitmapText.prototype.updateTransform=function(){if(this.dirty){this.updateText();this.dirty=false}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.BitmapText.fonts={};PIXI.InteractionData=function(){this.global=new PIXI.Point;this.target=null;this.originalEvent=null};PIXI.InteractionData.prototype.getLocalPosition=function(displayObject,point,globalPos){var worldTransform=displayObject.worldTransform;var global=globalPos?globalPos:this.global;var a00=worldTransform.a,a01=worldTransform.c,a02=worldTransform.tx,a10=worldTransform.b,a11=worldTransform.d,a12=worldTransform.ty,id=1/(a00*a11+a01*-a10);point=point||new PIXI.Point;point.x=a11*id*global.x+-a01*id*global.y+(a12*a01-a02*a11)*id;point.y=a00*id*global.y+-a10*id*global.x+(-a12*a00+a02*a10)*id;return point};PIXI.InteractionData.prototype.constructor=PIXI.InteractionData;PIXI.InteractionManager=function(stage){this.stage=stage;this.mouse=new PIXI.InteractionData;this.touches={};this.tempPoint=new PIXI.Point;this.mouseoverEnabled=true;this.pool=[];this.interactiveItems=[];this.interactionDOMElement=null;this.onMouseMove=this.onMouseMove.bind(this);this.onMouseDown=this.onMouseDown.bind(this);this.onMouseOut=this.onMouseOut.bind(this);this.onMouseUp=this.onMouseUp.bind(this);this.onTouchStart=this.onTouchStart.bind(this);this.onTouchEnd=this.onTouchEnd.bind(this);this.onTouchCancel=this.onTouchCancel.bind(this);this.onTouchMove=this.onTouchMove.bind(this);this.last=0;this.currentCursorStyle="inherit";this.mouseOut=false;this.resolution=1;this._tempPoint=new PIXI.Point};PIXI.InteractionManager.prototype.constructor=PIXI.InteractionManager;PIXI.InteractionManager.prototype.collectInteractiveSprite=function(displayObject,iParent){var children=displayObject.children;var length=children.length;for(var i=length-1;i>=0;i--){var child=children[i];if(child._interactive){iParent.interactiveChildren=true;this.interactiveItems.push(child);if(child.children.length>0){this.collectInteractiveSprite(child,child)}}else{child.__iParent=null;if(child.children.length>0){this.collectInteractiveSprite(child,iParent)}}}};PIXI.InteractionManager.prototype.setTarget=function(target){this.target=target;this.resolution=target.resolution;if(this.interactionDOMElement!==null)return;this.setTargetDomElement(target.view)};PIXI.InteractionManager.prototype.setTargetDomElement=function(domElement){this.removeEvents();if(window.navigator.msPointerEnabled){domElement.style["-ms-content-zooming"]="none";domElement.style["-ms-touch-action"]="none"}this.interactionDOMElement=domElement;domElement.addEventListener("mousemove",this.onMouseMove,true);domElement.addEventListener("mousedown",this.onMouseDown,true);domElement.addEventListener("mouseout",this.onMouseOut,true);domElement.addEventListener("touchstart",this.onTouchStart,true);
domElement.addEventListener("touchend",this.onTouchEnd,true);domElement.addEventListener("touchleave",this.onTouchCancel,true);domElement.addEventListener("touchcancel",this.onTouchCancel,true);domElement.addEventListener("touchmove",this.onTouchMove,true);window.addEventListener("mouseup",this.onMouseUp,true)};PIXI.InteractionManager.prototype.removeEvents=function(){if(!this.interactionDOMElement)return;this.interactionDOMElement.style["-ms-content-zooming"]="";this.interactionDOMElement.style["-ms-touch-action"]="";this.interactionDOMElement.removeEventListener("mousemove",this.onMouseMove,true);this.interactionDOMElement.removeEventListener("mousedown",this.onMouseDown,true);this.interactionDOMElement.removeEventListener("mouseout",this.onMouseOut,true);this.interactionDOMElement.removeEventListener("touchstart",this.onTouchStart,true);this.interactionDOMElement.removeEventListener("touchend",this.onTouchEnd,true);this.interactionDOMElement.removeEventListener("touchleave",this.onTouchCancel,true);this.interactionDOMElement.removeEventListener("touchcancel",this.onTouchCancel,true);this.interactionDOMElement.removeEventListener("touchmove",this.onTouchMove,true);this.interactionDOMElement=null;window.removeEventListener("mouseup",this.onMouseUp,true)};PIXI.InteractionManager.prototype.update=function(){if(!this.target)return;var now=Date.now();var diff=now-this.last;diff=diff*PIXI.INTERACTION_FREQUENCY/1e3;if(diff<1)return;this.last=now;var i=0;if(this.dirty){this.rebuildInteractiveGraph()}var length=this.interactiveItems.length;var cursor="inherit";var over=false;for(i=0;i<length;i++){var item=this.interactiveItems[i];item.__hit=this.hitTest(item,this.mouse);this.mouse.target=item;if(item.__hit&&!over){if(item.buttonMode)cursor=item.defaultCursor;if(!item.interactiveChildren){over=true}if(!item.__isOver){if(item.mouseover){item.mouseover(this.mouse)}item.__isOver=true}}else{if(item.__isOver){if(item.mouseout){item.mouseout(this.mouse)}item.__isOver=false}}}if(this.currentCursorStyle!==cursor){this.currentCursorStyle=cursor;this.interactionDOMElement.style.cursor=cursor}};PIXI.InteractionManager.prototype.rebuildInteractiveGraph=function(){this.dirty=false;var len=this.interactiveItems.length;for(var i=0;i<len;i++){this.interactiveItems[i].interactiveChildren=false}this.interactiveItems=[];if(this.stage.interactive){this.interactiveItems.push(this.stage)}this.collectInteractiveSprite(this.stage,this.stage)};PIXI.InteractionManager.prototype.onMouseMove=function(event){if(this.dirty){this.rebuildInteractiveGraph()}this.mouse.originalEvent=event;var rect=this.interactionDOMElement.getBoundingClientRect();this.mouse.global.x=(event.clientX-rect.left)*(this.target.width/rect.width)/this.resolution;this.mouse.global.y=(event.clientY-rect.top)*(this.target.height/rect.height)/this.resolution;var length=this.interactiveItems.length;for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item.mousemove){item.mousemove(this.mouse)}}};PIXI.InteractionManager.prototype.onMouseDown=function(event){if(this.dirty){this.rebuildInteractiveGraph()}this.mouse.originalEvent=event;if(PIXI.AUTO_PREVENT_DEFAULT){this.mouse.originalEvent.preventDefault()}var length=this.interactiveItems.length;var e=this.mouse.originalEvent;var isRightButton=e.button===2||e.which===3;var downFunction=isRightButton?"rightdown":"mousedown";var clickFunction=isRightButton?"rightclick":"click";var buttonIsDown=isRightButton?"__rightIsDown":"__mouseIsDown";var isDown=isRightButton?"__isRightDown":"__isDown";for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item[downFunction]||item[clickFunction]){item[buttonIsDown]=true;item.__hit=this.hitTest(item,this.mouse);if(item.__hit){if(item[downFunction]){item[downFunction](this.mouse)}item[isDown]=true;if(!item.interactiveChildren)break}}}};PIXI.InteractionManager.prototype.onMouseOut=function(event){if(this.dirty){this.rebuildInteractiveGraph()}this.mouse.originalEvent=event;var length=this.interactiveItems.length;this.interactionDOMElement.style.cursor="inherit";for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item.__isOver){this.mouse.target=item;if(item.mouseout){item.mouseout(this.mouse)}item.__isOver=false}}this.mouseOut=true;this.mouse.global.x=-1e4;this.mouse.global.y=-1e4};PIXI.InteractionManager.prototype.onMouseUp=function(event){if(this.dirty){this.rebuildInteractiveGraph()}this.mouse.originalEvent=event;var length=this.interactiveItems.length;var up=false;var e=this.mouse.originalEvent;var isRightButton=e.button===2||e.which===3;var upFunction=isRightButton?"rightup":"mouseup";var clickFunction=isRightButton?"rightclick":"click";var upOutsideFunction=isRightButton?"rightupoutside":"mouseupoutside";var isDown=isRightButton?"__isRightDown":"__isDown";for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item[clickFunction]||item[upFunction]||item[upOutsideFunction]){item.__hit=this.hitTest(item,this.mouse);if(item.__hit&&!up){if(item[upFunction]){item[upFunction](this.mouse)}if(item[isDown]){if(item[clickFunction]){item[clickFunction](this.mouse)}}if(!item.interactiveChildren){up=true}}else{if(item[isDown]){if(item[upOutsideFunction])item[upOutsideFunction](this.mouse)}}item[isDown]=false}}};PIXI.InteractionManager.prototype.hitTest=function(item,interactionData){var global=interactionData.global;if(!item.worldVisible){return false}item.worldTransform.applyInverse(global,this._tempPoint);var x=this._tempPoint.x,y=this._tempPoint.y,i;interactionData.target=item;if(item.hitArea&&item.hitArea.contains){return item.hitArea.contains(x,y)}else if(item instanceof PIXI.Sprite){var width=item.texture.frame.width;var height=item.texture.frame.height;var x1=-width*item.anchor.x;var y1;if(x>x1&&x<x1+width){y1=-height*item.anchor.y;if(y>y1&&y<y1+height){return true}}}else if(item instanceof PIXI.Graphics){var graphicsData=item.graphicsData;for(i=0;i<graphicsData.length;i++){var data=graphicsData[i];if(!data.fill)continue;if(data.shape){if(data.shape.contains(x,y)){return true}}}}var length=item.children.length;for(i=0;i<length;i++){var tempItem=item.children[i];var hit=this.hitTest(tempItem,interactionData);if(hit){interactionData.target=item;return true}}return false};PIXI.InteractionManager.prototype.onTouchMove=function(event){if(this.dirty){this.rebuildInteractiveGraph()}var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var touchData;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];touchData=this.touches[touchEvent.identifier];touchData.originalEvent=event;if(!isSupportCocoonJS){touchEvent.globalX=touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}for(var j=0;j<this.interactiveItems.length;j++){var item=this.interactiveItems[j];if(item.touchmove&&item.__touchData&&item.__touchData[touchEvent.identifier]){item.touchmove(touchData)}}}};PIXI.InteractionManager.prototype.onTouchStart=function(event){if(this.dirty){this.rebuildInteractiveGraph()}var rect=this.interactionDOMElement.getBoundingClientRect();if(PIXI.AUTO_PREVENT_DEFAULT){event.preventDefault()}var changedTouches=event.changedTouches;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];var touchData=this.pool.pop();if(!touchData){touchData=new PIXI.InteractionData}touchData.originalEvent=event;this.touches[touchEvent.identifier]=touchData;if(!isSupportCocoonJS){touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.touchstart||item.tap){item.__hit=this.hitTest(item,touchData);if(item.__hit){if(item.touchstart)item.touchstart(touchData);item.__isDown=true;item.__touchData=item.__touchData||{};item.__touchData[touchEvent.identifier]=touchData;if(!item.interactiveChildren)break}}}}};PIXI.InteractionManager.prototype.onTouchEnd=function(event){if(this.dirty){this.rebuildInteractiveGraph()}var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];var touchData=this.touches[touchEvent.identifier];var up=false;if(!isSupportCocoonJS){touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.__touchData&&item.__touchData[touchEvent.identifier]){item.__hit=this.hitTest(item,item.__touchData[touchEvent.identifier]);touchData.originalEvent=event;if(item.touchend||item.tap){if(item.__hit&&!up){if(item.touchend){item.touchend(touchData)}if(item.__isDown&&item.tap){item.tap(touchData)}if(!item.interactiveChildren){up=true}}else{if(item.__isDown&&item.touchendoutside){item.touchendoutside(touchData)}}item.__isDown=false}item.__touchData[touchEvent.identifier]=null}}this.pool.push(touchData);this.touches[touchEvent.identifier]=null}};PIXI.InteractionManager.prototype.onTouchCancel=function(event){if(this.dirty){this.rebuildInteractiveGraph()}var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];var touchData=this.touches[touchEvent.identifier];var up=false;if(!isSupportCocoonJS){touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution}else{touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.__touchData&&item.__touchData[touchEvent.identifier]){item.__hit=this.hitTest(item,item.__touchData[touchEvent.identifier]);touchData.originalEvent=event;if(item.touchcancel&&!up){item.touchcancel(touchData);if(!item.interactiveChildren){up=true}}item.__isDown=false;item.__touchData[touchEvent.identifier]=null}}this.pool.push(touchData);this.touches[touchEvent.identifier]=null}};PIXI.Stage=function(backgroundColor){PIXI.DisplayObjectContainer.call(this);this.worldTransform=new PIXI.Matrix;this.interactive=true;this.interactionManager=new PIXI.InteractionManager(this);this.dirty=true;this.stage=this;this.stage.hitArea=new PIXI.Rectangle(0,0,1e5,1e5);this.setBackgroundColor(backgroundColor)};PIXI.Stage.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Stage.prototype.constructor=PIXI.Stage;PIXI.Stage.prototype.setInteractionDelegate=function(domElement){this.interactionManager.setTargetDomElement(domElement)};PIXI.Stage.prototype.updateTransform=function(){this.worldAlpha=1;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}if(this.dirty){this.dirty=false;this.interactionManager.dirty=true}if(this.interactive)this.interactionManager.update()};PIXI.Stage.prototype.setBackgroundColor=function(backgroundColor){this.backgroundColor=backgroundColor||0;this.backgroundColorSplit=PIXI.hex2rgb(this.backgroundColor);var hex=this.backgroundColor.toString(16);hex="000000".substr(0,6-hex.length)+hex;this.backgroundColorString="#"+hex};PIXI.Stage.prototype.getMousePosition=function(){return this.interactionManager.mouse.global};(function(window){var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(id){clearTimeout(id)}}window.requestAnimFrame=window.requestAnimationFrame})(this);PIXI.hex2rgb=function(hex){return[(hex>>16&255)/255,(hex>>8&255)/255,(hex&255)/255]};PIXI.rgb2hex=function(rgb){return(rgb[0]*255<<16)+(rgb[1]*255<<8)+rgb[2]*255};if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(){return function(thisArg){var target=this,i=arguments.length-1,boundArgs=[];if(i>0){boundArgs.length=i;while(i--)boundArgs[i]=arguments[i+1]}if(typeof target!=="function")throw new TypeError;function bound(){var i=arguments.length,args=new Array(i);while(i--)args[i]=arguments[i];args=boundArgs.concat(args);return target.apply(this instanceof bound?this:thisArg,args)}bound.prototype=function F(proto){if(proto)F.prototype=proto;if(!(this instanceof F))return new F}(target.prototype);return bound}}()}PIXI.AjaxRequest=function(){var activexmodes=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];if(window.ActiveXObject){for(var i=0;i<activexmodes.length;i++){try{return new window.ActiveXObject(activexmodes[i])}catch(e){}}}else if(window.XMLHttpRequest){return new window.XMLHttpRequest}else{return false}};PIXI.canUseNewCanvasBlendModes=function(){if(typeof document==="undefined")return false;var canvas=document.createElement("canvas");canvas.width=1;canvas.height=1;var context=canvas.getContext("2d");context.fillStyle="#000";context.fillRect(0,0,1,1);context.globalCompositeOperation="multiply";context.fillStyle="#fff";context.fillRect(0,0,1,1);return context.getImageData(0,0,1,1).data[0]===0};PIXI.getNextPowerOfTwo=function(number){if(number>0&&(number&number-1)===0)return number;else{var result=1;while(result<number)result<<=1;return result}};PIXI.isPowerOfTwo=function(width,height){return width>0&&(width&width-1)===0&&height>0&&(height&height-1)===0};PIXI.EventTarget={call:function callCompat(obj){if(obj){obj=obj.prototype||obj;PIXI.EventTarget.mixin(obj)}},mixin:function mixin(obj){obj.listeners=function listeners(eventName){this._listeners=this._listeners||{};return this._listeners[eventName]?this._listeners[eventName].slice():[]};obj.emit=obj.dispatchEvent=function emit(eventName,data){this._listeners=this._listeners||{};if(typeof eventName==="object"){data=eventName;eventName=eventName.type}if(!data||data.__isEventObject!==true){data=new PIXI.Event(this,eventName,data)}if(this._listeners&&this._listeners[eventName]){var listeners=this._listeners[eventName].slice(0),length=listeners.length,fn=listeners[0],i;for(i=0;i<length;fn=listeners[++i]){fn.call(this,data);if(data.stoppedImmediate){return this}}if(data.stopped){return this}}if(this.parent&&this.parent.emit){this.parent.emit.call(this.parent,eventName,data)}return this};obj.on=obj.addEventListener=function on(eventName,fn){this._listeners=this._listeners||{};(this._listeners[eventName]=this._listeners[eventName]||[]).push(fn);return this};obj.once=function once(eventName,fn){this._listeners=this._listeners||{};var self=this;function onceHandlerWrapper(){fn.apply(self.off(eventName,onceHandlerWrapper),arguments)}onceHandlerWrapper._originalHandler=fn;return this.on(eventName,onceHandlerWrapper)};obj.off=obj.removeEventListener=function off(eventName,fn){this._listeners=this._listeners||{};if(!this._listeners[eventName])return this;var list=this._listeners[eventName],i=fn?list.length:0;while(i-->0){if(list[i]===fn||list[i]._originalHandler===fn){list.splice(i,1)}}if(list.length===0){delete this._listeners[eventName]}return this};obj.removeAllListeners=function removeAllListeners(eventName){this._listeners=this._listeners||{};if(!this._listeners[eventName])return this;delete this._listeners[eventName];return this}}};PIXI.Event=function(target,name,data){this.__isEventObject=true;this.stopped=false;this.stoppedImmediate=false;this.target=target;this.type=name;this.data=data;this.content=data;this.timeStamp=Date.now()};PIXI.Event.prototype.stopPropagation=function stopPropagation(){this.stopped=true};PIXI.Event.prototype.stopImmediatePropagation=function stopImmediatePropagation(){this.stoppedImmediate=true};PIXI.autoDetectRenderer=function(width,height,options){if(!width)width=800;if(!height)height=600;var webgl=function(){try{var canvas=document.createElement("canvas");return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}();if(webgl){return new PIXI.WebGLRenderer(width,height,options)}return new PIXI.CanvasRenderer(width,height,options)};PIXI.autoDetectRecommendedRenderer=function(width,height,options){if(!width)width=800;if(!height)height=600;var webgl=function(){try{var canvas=document.createElement("canvas");return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}();var isAndroid=/Android/i.test(navigator.userAgent);if(webgl&&!isAndroid){return new PIXI.WebGLRenderer(width,height,options)}return new PIXI.CanvasRenderer(width,height,options)};PIXI.PolyK={};PIXI.PolyK.Triangulate=function(p){var sign=true;var n=p.length>>1;if(n<3)return[];var tgs=[];var avl=[];for(var i=0;i<n;i++)avl.push(i);i=0;var al=n;while(al>3){var i0=avl[(i+0)%al];var i1=avl[(i+1)%al];var i2=avl[(i+2)%al];var ax=p[2*i0],ay=p[2*i0+1];var bx=p[2*i1],by=p[2*i1+1];var cx=p[2*i2],cy=p[2*i2+1];var earFound=false;if(PIXI.PolyK._convex(ax,ay,bx,by,cx,cy,sign)){earFound=true;for(var j=0;j<al;j++){var vi=avl[j];if(vi===i0||vi===i1||vi===i2)continue;if(PIXI.PolyK._PointInTriangle(p[2*vi],p[2*vi+1],ax,ay,bx,by,cx,cy)){earFound=false;break}}}if(earFound){tgs.push(i0,i1,i2);avl.splice((i+1)%al,1);al--;i=0}else if(i++>3*al){if(sign){tgs=[];avl=[];for(i=0;i<n;i++)avl.push(i);i=0;al=n;sign=false}else{return null}}}tgs.push(avl[0],avl[1],avl[2]);return tgs};PIXI.PolyK._PointInTriangle=function(px,py,ax,ay,bx,by,cx,cy){var v0x=cx-ax;var v0y=cy-ay;var v1x=bx-ax;var v1y=by-ay;var v2x=px-ax;var v2y=py-ay;var dot00=v0x*v0x+v0y*v0y;var dot01=v0x*v1x+v0y*v1y;var dot02=v0x*v2x+v0y*v2y;var dot11=v1x*v1x+v1y*v1y;var dot12=v1x*v2x+v1y*v2y;var invDenom=1/(dot00*dot11-dot01*dot01);var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;return u>=0&&v>=0&&u+v<1};PIXI.PolyK._convex=function(ax,ay,bx,by,cx,cy,sign){return(ay-by)*(cx-bx)+(bx-ax)*(cy-by)>=0===sign};PIXI.initDefaultShaders=function(){};PIXI.CompileVertexShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.VERTEX_SHADER)};PIXI.CompileFragmentShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.FRAGMENT_SHADER)};PIXI._CompileShader=function(gl,shaderSrc,shaderType){var src=shaderSrc.join("\n");var shader=gl.createShader(shaderType);gl.shaderSource(shader,src);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){window.console.log(gl.getShaderInfoLog(shader));return null}return shader};PIXI.compileProgram=function(gl,vertexSrc,fragmentSrc){var fragmentShader=PIXI.CompileFragmentShader(gl,fragmentSrc);var vertexShader=PIXI.CompileVertexShader(gl,vertexSrc);var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);if(!gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)){window.console.log("Could not initialise shaders")}return shaderProgram};PIXI.PixiShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision lowp float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"];this.textureCount=0;this.firstRun=true;this.dirty=true;this.attributes=[];this.init()};PIXI.PixiShader.prototype.constructor=PIXI.PixiShader;PIXI.PixiShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc||PIXI.PixiShader.defaultVertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.dimensions=gl.getUniformLocation(program,"dimensions");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.colorAttribute=gl.getAttribLocation(program,"aColor");if(this.colorAttribute===-1){this.colorAttribute=2}this.attributes=[this.aVertexPosition,this.aTextureCoord,this.colorAttribute];for(var key in this.uniforms){this.uniforms[key].uniformLocation=gl.getUniformLocation(program,key)}this.initUniforms();this.program=program};PIXI.PixiShader.prototype.initUniforms=function(){this.textureCount=1;var gl=this.gl;var uniform;for(var key in this.uniforms){uniform=this.uniforms[key];var type=uniform.type;if(type==="sampler2D"){uniform._init=false;if(uniform.value!==null){this.initSampler2D(uniform)}}else if(type==="mat2"||type==="mat3"||type==="mat4"){uniform.glMatrix=true;uniform.glValueLength=1;if(type==="mat2"){uniform.glFunc=gl.uniformMatrix2fv}else if(type==="mat3"){uniform.glFunc=gl.uniformMatrix3fv}else if(type==="mat4"){uniform.glFunc=gl.uniformMatrix4fv}}else{uniform.glFunc=gl["uniform"+type];if(type==="2f"||type==="2i"){uniform.glValueLength=2}else if(type==="3f"||type==="3i"){uniform.glValueLength=3}else if(type==="4f"||type==="4i"){uniform.glValueLength=4}else{uniform.glValueLength=1}}}};PIXI.PixiShader.prototype.initSampler2D=function(uniform){if(!uniform.value||!uniform.value.baseTexture||!uniform.value.baseTexture.hasLoaded){return}var gl=this.gl;gl.activeTexture(gl["TEXTURE"+this.textureCount]);gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id]);if(uniform.textureData){var data=uniform.textureData;var magFilter=data.magFilter?data.magFilter:gl.LINEAR;var minFilter=data.minFilter?data.minFilter:gl.LINEAR;var wrapS=data.wrapS?data.wrapS:gl.CLAMP_TO_EDGE;var wrapT=data.wrapT?data.wrapT:gl.CLAMP_TO_EDGE;var format=data.luminance?gl.LUMINANCE:gl.RGBA;if(data.repeat){wrapS=gl.REPEAT;wrapT=gl.REPEAT}gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!!data.flipY);if(data.width){var width=data.width?data.width:512;var height=data.height?data.height:2;var border=data.border?data.border:0;gl.texImage2D(gl.TEXTURE_2D,0,format,width,height,border,format,gl.UNSIGNED_BYTE,null)}else{gl.texImage2D(gl.TEXTURE_2D,0,format,gl.RGBA,gl.UNSIGNED_BYTE,uniform.value.baseTexture.source)}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,magFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrapS);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrapT)}gl.uniform1i(uniform.uniformLocation,this.textureCount);uniform._init=true;this.textureCount++};PIXI.PixiShader.prototype.syncUniforms=function(){this.textureCount=1;var uniform;var gl=this.gl;for(var key in this.uniforms){uniform=this.uniforms[key];if(uniform.glValueLength===1){if(uniform.glMatrix===true){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.transpose,uniform.value)}else{uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value)}}else if(uniform.glValueLength===2){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y)}else if(uniform.glValueLength===3){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z)}else if(uniform.glValueLength===4){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z,uniform.value.w)}else if(uniform.type==="sampler2D"){if(uniform._init){gl.activeTexture(gl["TEXTURE"+this.textureCount]);if(uniform.value.baseTexture._dirty[gl.id]){PIXI.instances[gl.id].updateTexture(uniform.value.baseTexture)}else{gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id])}gl.uniform1i(uniform.uniformLocation,this.textureCount);this.textureCount++}else{this.initSampler2D(uniform)}}}};PIXI.PixiShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.PixiShader.defaultVertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","varying vec2 vTextureCoord;","varying vec4 vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   gl_Position = vec4( ((aVertexPosition + offsetVector) / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = vec4(aColor.rgb * aColor.a, aColor.a);","}"];PIXI.PixiFastShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision lowp float;","varying vec2 vTextureCoord;","varying float vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aPositionCoord;","attribute vec2 aScale;","attribute float aRotation;","attribute vec2 aTextureCoord;","attribute float aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform mat3 uMatrix;","varying vec2 vTextureCoord;","varying float vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   vec2 v;","   vec2 sv = aVertexPosition * aScale;","   v.x = (sv.x) * cos(aRotation) - (sv.y) * sin(aRotation);","   v.y = (sv.x) * sin(aRotation) + (sv.y) * cos(aRotation);","   v = ( uMatrix * vec3(v + aPositionCoord , 1.0) ).xy ;","   gl_Position = vec4( ( v / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = aColor;","}"];this.textureCount=0;this.init()};PIXI.PixiFastShader.prototype.constructor=PIXI.PixiFastShader;PIXI.PixiFastShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.dimensions=gl.getUniformLocation(program,"dimensions");this.uMatrix=gl.getUniformLocation(program,"uMatrix");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aPositionCoord=gl.getAttribLocation(program,"aPositionCoord");this.aScale=gl.getAttribLocation(program,"aScale");this.aRotation=gl.getAttribLocation(program,"aRotation");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.colorAttribute=gl.getAttribLocation(program,"aColor");if(this.colorAttribute===-1){this.colorAttribute=2}this.attributes=[this.aVertexPosition,this.aPositionCoord,this.aScale,this.aRotation,this.aTextureCoord,this.colorAttribute];this.program=program};PIXI.PixiFastShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.StripShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","uniform float alpha;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * alpha;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","varying vec2 vTextureCoord;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, v.y / -projectionVector.y + 1.0 , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","}"];this.init()};PIXI.StripShader.prototype.constructor=PIXI.StripShader;PIXI.StripShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.colorAttribute=gl.getAttribLocation(program,"aColor");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.attributes=[this.aVertexPosition,this.aTextureCoord];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.StripShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null};PIXI.PrimitiveShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec4 aColor;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform float alpha;","uniform float flipY;","uniform vec3 tint;","varying vec4 vColor;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, (v.y / projectionVector.y * -flipY) + flipY , 0.0, 1.0);","   vColor = aColor * vec4(tint * alpha, alpha);","}"];this.init()};PIXI.PrimitiveShader.prototype.constructor=PIXI.PrimitiveShader;PIXI.PrimitiveShader.prototype.init=function(){var gl=this.gl;
var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.tintColor=gl.getUniformLocation(program,"tint");this.flipY=gl.getUniformLocation(program,"flipY");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.colorAttribute=gl.getAttribLocation(program,"aColor");this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.PrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.ComplexPrimitiveShader=function(gl){this._UID=PIXI._UID++;this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform vec3 tint;","uniform float alpha;","uniform vec3 color;","uniform float flipY;","varying vec4 vColor;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, (v.y / projectionVector.y * -flipY) + flipY , 0.0, 1.0);","   vColor = vec4(color * alpha * tint, alpha);","}"];this.init()};PIXI.ComplexPrimitiveShader.prototype.constructor=PIXI.ComplexPrimitiveShader;PIXI.ComplexPrimitiveShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.tintColor=gl.getUniformLocation(program,"tint");this.color=gl.getUniformLocation(program,"color");this.flipY=gl.getUniformLocation(program,"flipY");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.ComplexPrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null};PIXI.WebGLGraphics=function(){};PIXI.WebGLGraphics.renderGraphics=function(graphics,renderSession){var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.primitiveShader,webGLData;if(graphics.dirty){PIXI.WebGLGraphics.updateGraphics(graphics,gl)}var webGL=graphics._webGL[gl.id];for(var i=0;i<webGL.data.length;i++){if(webGL.data[i].mode===1){webGLData=webGL.data[i];renderSession.stencilManager.pushStencil(graphics,webGLData,renderSession);gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);renderSession.stencilManager.popStencil(graphics,webGLData,renderSession)}else{webGLData=webGL.data[i];renderSession.shaderManager.setShader(shader);shader=renderSession.shaderManager.primitiveShader;gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform1f(shader.flipY,1);gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer);gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0)}}};PIXI.WebGLGraphics.updateGraphics=function(graphics,gl){var webGL=graphics._webGL[gl.id];if(!webGL)webGL=graphics._webGL[gl.id]={lastIndex:0,data:[],gl:gl};graphics.dirty=false;var i;if(graphics.clearDirty){graphics.clearDirty=false;for(i=0;i<webGL.data.length;i++){var graphicsData=webGL.data[i];graphicsData.reset();PIXI.WebGLGraphics.graphicsDataPool.push(graphicsData)}webGL.data=[];webGL.lastIndex=0}var webGLData;for(i=webGL.lastIndex;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];if(data.type===PIXI.Graphics.POLY){data.points=data.shape.points.slice();if(data.shape.closed){if(data.points[0]!==data.points[data.points.length-2]||data.points[1]!==data.points[data.points.length-1]){data.points.push(data.points[0],data.points[1])}}if(data.fill){if(data.points.length>=6){if(data.points.length<6*2){webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);var canDrawUsingSimple=PIXI.WebGLGraphics.buildPoly(data,webGLData);if(!canDrawUsingSimple){webGLData=PIXI.WebGLGraphics.switchMode(webGL,1);PIXI.WebGLGraphics.buildComplexPoly(data,webGLData)}}else{webGLData=PIXI.WebGLGraphics.switchMode(webGL,1);PIXI.WebGLGraphics.buildComplexPoly(data,webGLData)}}}if(data.lineWidth>0){webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);PIXI.WebGLGraphics.buildLine(data,webGLData)}}else{webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);if(data.type===PIXI.Graphics.RECT){PIXI.WebGLGraphics.buildRectangle(data,webGLData)}else if(data.type===PIXI.Graphics.CIRC||data.type===PIXI.Graphics.ELIP){PIXI.WebGLGraphics.buildCircle(data,webGLData)}else if(data.type===PIXI.Graphics.RREC){PIXI.WebGLGraphics.buildRoundedRectangle(data,webGLData)}}webGL.lastIndex++}for(i=0;i<webGL.data.length;i++){webGLData=webGL.data[i];if(webGLData.dirty)webGLData.upload()}};PIXI.WebGLGraphics.switchMode=function(webGL,type){var webGLData;if(!webGL.data.length){webGLData=PIXI.WebGLGraphics.graphicsDataPool.pop()||new PIXI.WebGLGraphicsData(webGL.gl);webGLData.mode=type;webGL.data.push(webGLData)}else{webGLData=webGL.data[webGL.data.length-1];if(webGLData.mode!==type||type===1){webGLData=PIXI.WebGLGraphics.graphicsDataPool.pop()||new PIXI.WebGLGraphicsData(webGL.gl);webGLData.mode=type;webGL.data.push(webGLData)}}webGLData.dirty=true;return webGLData};PIXI.WebGLGraphics.buildRectangle=function(graphicsData,webGLData){var rectData=graphicsData.shape;var x=rectData.x;var y=rectData.y;var width=rectData.width;var height=rectData.height;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vertPos=verts.length/6;verts.push(x,y);verts.push(r,g,b,alpha);verts.push(x+width,y);verts.push(r,g,b,alpha);verts.push(x,y+height);verts.push(r,g,b,alpha);verts.push(x+width,y+height);verts.push(r,g,b,alpha);indices.push(vertPos,vertPos,vertPos+1,vertPos+2,vertPos+3,vertPos+3)}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[x,y,x+width,y,x+width,y+height,x,y+height,x,y];PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.buildRoundedRectangle=function(graphicsData,webGLData){var rrectData=graphicsData.shape;var x=rrectData.x;var y=rrectData.y;var width=rrectData.width;var height=rrectData.height;var radius=rrectData.radius;var recPoints=[];recPoints.push(x,y+radius);recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x,y+height-radius,x,y+height,x+radius,y+height));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+width-radius,y+height,x+width,y+height,x+width,y+height-radius));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+width,y+radius,x+width,y,x+width-radius,y));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+radius,y,x,y,x,y+radius));if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;var triangles=PIXI.PolyK.Triangulate(recPoints);var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vecPos);indices.push(triangles[i]+vecPos);indices.push(triangles[i+1]+vecPos);indices.push(triangles[i+2]+vecPos);indices.push(triangles[i+2]+vecPos)}for(i=0;i<recPoints.length;i++){verts.push(recPoints[i],recPoints[++i],r,g,b,alpha)}}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=recPoints;PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.quadraticBezierCurve=function(fromX,fromY,cpX,cpY,toX,toY){var xa,ya,xb,yb,x,y,n=20,points=[];function getPt(n1,n2,perc){var diff=n2-n1;return n1+diff*perc}var j=0;for(var i=0;i<=n;i++){j=i/n;xa=getPt(fromX,cpX,j);ya=getPt(fromY,cpY,j);xb=getPt(cpX,toX,j);yb=getPt(cpY,toY,j);x=getPt(xa,xb,j);y=getPt(ya,yb,j);points.push(x,y)}return points};PIXI.WebGLGraphics.buildCircle=function(graphicsData,webGLData){var circleData=graphicsData.shape;var x=circleData.x;var y=circleData.y;var width;var height;if(graphicsData.type===PIXI.Graphics.CIRC){width=circleData.radius;height=circleData.radius}else{width=circleData.width;height=circleData.height}var totalSegs=40;var seg=Math.PI*2/totalSegs;var i=0;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;indices.push(vecPos);for(i=0;i<totalSegs+1;i++){verts.push(x,y,r,g,b,alpha);verts.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height,r,g,b,alpha);indices.push(vecPos++,vecPos++)}indices.push(vecPos-1)}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[];for(i=0;i<totalSegs+1;i++){graphicsData.points.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height)}PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.buildLine=function(graphicsData,webGLData){var i=0;var points=graphicsData.points;if(points.length===0)return;if(graphicsData.lineWidth%2){for(i=0;i<points.length;i++){points[i]+=.5}}var firstPoint=new PIXI.Point(points[0],points[1]);var lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);if(firstPoint.x===lastPoint.x&&firstPoint.y===lastPoint.y){points=points.slice();points.pop();points.pop();lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);var midPointX=lastPoint.x+(firstPoint.x-lastPoint.x)*.5;var midPointY=lastPoint.y+(firstPoint.y-lastPoint.y)*.5;points.unshift(midPointX,midPointY);points.push(midPointX,midPointY)}var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var indexCount=points.length;var indexStart=verts.length/6;var width=graphicsData.lineWidth/2;var color=PIXI.hex2rgb(graphicsData.lineColor);var alpha=graphicsData.lineAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var px,py,p1x,p1y,p2x,p2y,p3x,p3y;var perpx,perpy,perp2x,perp2y,perp3x,perp3y;var a1,b1,c1,a2,b2,c2;var denom,pdist,dist;p1x=points[0];p1y=points[1];p2x=points[2];p2y=points[3];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p1x-perpx,p1y-perpy,r,g,b,alpha);verts.push(p1x+perpx,p1y+perpy,r,g,b,alpha);for(i=1;i<length-1;i++){p1x=points[(i-1)*2];p1y=points[(i-1)*2+1];p2x=points[i*2];p2y=points[i*2+1];p3x=points[(i+1)*2];p3y=points[(i+1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;perp2x=-(p2y-p3y);perp2y=p2x-p3x;dist=Math.sqrt(perp2x*perp2x+perp2y*perp2y);perp2x/=dist;perp2y/=dist;perp2x*=width;perp2y*=width;a1=-perpy+p1y-(-perpy+p2y);b1=-perpx+p2x-(-perpx+p1x);c1=(-perpx+p1x)*(-perpy+p2y)-(-perpx+p2x)*(-perpy+p1y);a2=-perp2y+p3y-(-perp2y+p2y);b2=-perp2x+p2x-(-perp2x+p3x);c2=(-perp2x+p3x)*(-perp2y+p2y)-(-perp2x+p2x)*(-perp2y+p3y);denom=a1*b2-a2*b1;if(Math.abs(denom)<.1){denom+=10.1;verts.push(p2x-perpx,p2y-perpy,r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy,r,g,b,alpha);continue}px=(b1*c2-b2*c1)/denom;py=(a2*c1-a1*c2)/denom;pdist=(px-p2x)*(px-p2x)+(py-p2y)+(py-p2y);if(pdist>140*140){perp3x=perpx-perp2x;perp3y=perpy-perp2y;dist=Math.sqrt(perp3x*perp3x+perp3y*perp3y);perp3x/=dist;perp3y/=dist;perp3x*=width;perp3y*=width;verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);verts.push(p2x+perp3x,p2y+perp3y);verts.push(r,g,b,alpha);verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);indexCount++}else{verts.push(px,py);verts.push(r,g,b,alpha);verts.push(p2x-(px-p2x),p2y-(py-p2y));verts.push(r,g,b,alpha)}}p1x=points[(length-2)*2];p1y=points[(length-2)*2+1];p2x=points[(length-1)*2];p2y=points[(length-1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p2x-perpx,p2y-perpy);verts.push(r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy);verts.push(r,g,b,alpha);indices.push(indexStart);for(i=0;i<indexCount;i++){indices.push(indexStart++)}indices.push(indexStart-1)};PIXI.WebGLGraphics.buildComplexPoly=function(graphicsData,webGLData){var points=graphicsData.points.slice();if(points.length<6)return;var indices=webGLData.indices;webGLData.points=points;webGLData.alpha=graphicsData.fillAlpha;webGLData.color=PIXI.hex2rgb(graphicsData.fillColor);var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;var x,y;for(var i=0;i<points.length;i+=2){x=points[i];y=points[i+1];minX=x<minX?x:minX;maxX=x>maxX?x:maxX;minY=y<minY?y:minY;maxY=y>maxY?y:maxY}points.push(minX,minY,maxX,minY,maxX,maxY,minX,maxY);var length=points.length/2;for(i=0;i<length;i++){indices.push(i)}};PIXI.WebGLGraphics.buildPoly=function(graphicsData,webGLData){var points=graphicsData.points;if(points.length<6)return;var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var triangles=PIXI.PolyK.Triangulate(points);if(!triangles)return false;var vertPos=verts.length/6;var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vertPos);indices.push(triangles[i]+vertPos);indices.push(triangles[i+1]+vertPos);indices.push(triangles[i+2]+vertPos);indices.push(triangles[i+2]+vertPos)}for(i=0;i<length;i++){verts.push(points[i*2],points[i*2+1],r,g,b,alpha)}return true};PIXI.WebGLGraphics.graphicsDataPool=[];PIXI.WebGLGraphicsData=function(gl){this.gl=gl;this.color=[0,0,0];this.points=[];this.indices=[];this.buffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.mode=1;this.alpha=1;this.dirty=true};PIXI.WebGLGraphicsData.prototype.reset=function(){this.points=[];this.indices=[]};PIXI.WebGLGraphicsData.prototype.upload=function(){var gl=this.gl;this.glPoints=new PIXI.Float32Array(this.points);gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer);gl.bufferData(gl.ARRAY_BUFFER,this.glPoints,gl.STATIC_DRAW);this.glIndicies=new PIXI.Uint16Array(this.indices);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.glIndicies,gl.STATIC_DRAW);this.dirty=false};PIXI.glContexts=[];PIXI.instances=[];PIXI.WebGLRenderer=function(width,height,options){if(options){for(var i in PIXI.defaultRenderOptions){if(typeof options[i]==="undefined")options[i]=PIXI.defaultRenderOptions[i]}}else{options=PIXI.defaultRenderOptions}if(!PIXI.defaultRenderer){PIXI.sayHello("webGL");PIXI.defaultRenderer=this}this.type=PIXI.WEBGL_RENDERER;this.resolution=options.resolution;this.transparent=options.transparent;this.autoResize=options.autoResize||false;this.preserveDrawingBuffer=options.preserveDrawingBuffer;this.clearBeforeRender=options.clearBeforeRender;this.width=width||800;this.height=height||600;this.view=options.view||document.createElement("canvas");this.contextLostBound=this.handleContextLost.bind(this);this.contextRestoredBound=this.handleContextRestored.bind(this);this.view.addEventListener("webglcontextlost",this.contextLostBound,false);this.view.addEventListener("webglcontextrestored",this.contextRestoredBound,false);this._contextOptions={alpha:this.transparent,antialias:options.antialias,premultipliedAlpha:this.transparent&&this.transparent!=="notMultiplied",stencil:true,preserveDrawingBuffer:options.preserveDrawingBuffer};this.projection=new PIXI.Point;this.offset=new PIXI.Point(0,0);this.shaderManager=new PIXI.WebGLShaderManager;this.spriteBatch=new PIXI.WebGLSpriteBatch;this.maskManager=new PIXI.WebGLMaskManager;this.filterManager=new PIXI.WebGLFilterManager;this.stencilManager=new PIXI.WebGLStencilManager;this.blendModeManager=new PIXI.WebGLBlendModeManager;this.renderSession={};this.renderSession.gl=this.gl;this.renderSession.drawCount=0;this.renderSession.shaderManager=this.shaderManager;this.renderSession.maskManager=this.maskManager;this.renderSession.filterManager=this.filterManager;this.renderSession.blendModeManager=this.blendModeManager;this.renderSession.spriteBatch=this.spriteBatch;this.renderSession.stencilManager=this.stencilManager;this.renderSession.renderer=this;this.renderSession.resolution=this.resolution;this.initContext();this.mapBlendModes()};PIXI.WebGLRenderer.prototype.constructor=PIXI.WebGLRenderer;PIXI.WebGLRenderer.prototype.initContext=function(){var gl=this.view.getContext("webgl",this._contextOptions)||this.view.getContext("experimental-webgl",this._contextOptions);this.gl=gl;if(!gl){throw new Error("This browser does not support webGL. Try using the canvas renderer")}this.glContextId=gl.id=PIXI.WebGLRenderer.glContextId++;PIXI.glContexts[this.glContextId]=gl;PIXI.instances[this.glContextId]=this;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);this.shaderManager.setContext(gl);this.spriteBatch.setContext(gl);this.maskManager.setContext(gl);this.filterManager.setContext(gl);this.blendModeManager.setContext(gl);this.stencilManager.setContext(gl);this.renderSession.gl=this.gl;this.resize(this.width,this.height)};PIXI.WebGLRenderer.prototype.render=function(stage){if(this.contextLost)return;if(this.__stage!==stage){if(stage.interactive)stage.interactionManager.removeEvents();this.__stage=stage}stage.updateTransform();var gl=this.gl;if(stage._interactive){if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this)}}else{if(stage._interactiveEventsAdded){stage._interactiveEventsAdded=false;stage.interactionManager.setTarget(this)}}gl.viewport(0,0,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.clearBeforeRender){if(this.transparent){gl.clearColor(0,0,0,0)}else{gl.clearColor(stage.backgroundColorSplit[0],stage.backgroundColorSplit[1],stage.backgroundColorSplit[2],1)}gl.clear(gl.COLOR_BUFFER_BIT)}this.renderDisplayObject(stage,this.projection)};PIXI.WebGLRenderer.prototype.renderDisplayObject=function(displayObject,projection,buffer){this.renderSession.blendModeManager.setBlendMode(PIXI.blendModes.NORMAL);this.renderSession.drawCount=0;this.renderSession.flipY=buffer?-1:1;this.renderSession.projection=projection;this.renderSession.offset=this.offset;this.spriteBatch.begin(this.renderSession);this.filterManager.begin(this.renderSession,buffer);displayObject._renderWebGL(this.renderSession);this.spriteBatch.end()};PIXI.WebGLRenderer.prototype.resize=function(width,height){this.width=width*this.resolution;this.height=height*this.resolution;this.view.width=this.width;this.view.height=this.height;if(this.autoResize){this.view.style.width=this.width/this.resolution+"px";this.view.style.height=this.height/this.resolution+"px"}this.gl.viewport(0,0,this.width,this.height);this.projection.x=this.width/2/this.resolution;this.projection.y=-this.height/2/this.resolution};PIXI.WebGLRenderer.prototype.updateTexture=function(texture){if(!texture.hasLoaded)return;var gl=this.gl;if(!texture._glTextures[gl.id])texture._glTextures[gl.id]=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id]);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,texture.premultipliedAlpha);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.source);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);if(texture.mipmap&&PIXI.isPowerOfTwo(texture.width,texture.height)){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR_MIPMAP_LINEAR:gl.NEAREST_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D)}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST)}if(!texture._powerOf2){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT)}texture._dirty[gl.id]=false;return texture._glTextures[gl.id]};PIXI.WebGLRenderer.prototype.handleContextLost=function(event){event.preventDefault();this.contextLost=true};PIXI.WebGLRenderer.prototype.handleContextRestored=function(){this.initContext();for(var key in PIXI.TextureCache){var texture=PIXI.TextureCache[key].baseTexture;texture._glTextures=[]}this.contextLost=false};PIXI.WebGLRenderer.prototype.destroy=function(){this.view.removeEventListener("webglcontextlost",this.contextLostBound);this.view.removeEventListener("webglcontextrestored",this.contextRestoredBound);PIXI.glContexts[this.glContextId]=null;this.projection=null;this.offset=null;this.shaderManager.destroy();this.spriteBatch.destroy();this.maskManager.destroy();this.filterManager.destroy();this.shaderManager=null;this.spriteBatch=null;this.maskManager=null;this.filterManager=null;this.gl=null;this.renderSession=null};PIXI.WebGLRenderer.prototype.mapBlendModes=function(){var gl=this.gl;if(!PIXI.blendModesWebGL){PIXI.blendModesWebGL=[];PIXI.blendModesWebGL[PIXI.blendModes.NORMAL]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.ADD]=[gl.SRC_ALPHA,gl.DST_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.MULTIPLY]=[gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SCREEN]=[gl.SRC_ALPHA,gl.ONE];PIXI.blendModesWebGL[PIXI.blendModes.OVERLAY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DARKEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LIGHTEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_DODGE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_BURN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HARD_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SOFT_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DIFFERENCE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.EXCLUSION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HUE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SATURATION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LUMINOSITY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA]}};PIXI.WebGLRenderer.glContextId=0;PIXI.WebGLBlendModeManager=function(){this.currentBlendMode=99999};PIXI.WebGLBlendModeManager.prototype.constructor=PIXI.WebGLBlendModeManager;PIXI.WebGLBlendModeManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLBlendModeManager.prototype.setBlendMode=function(blendMode){if(this.currentBlendMode===blendMode)return false;this.currentBlendMode=blendMode;var blendModeWebGL=PIXI.blendModesWebGL[this.currentBlendMode];this.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1]);return true};PIXI.WebGLBlendModeManager.prototype.destroy=function(){this.gl=null};PIXI.WebGLMaskManager=function(){};PIXI.WebGLMaskManager.prototype.constructor=PIXI.WebGLMaskManager;PIXI.WebGLMaskManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLMaskManager.prototype.pushMask=function(maskData,renderSession){var gl=renderSession.gl;if(maskData.dirty){PIXI.WebGLGraphics.updateGraphics(maskData,gl)}if(!maskData._webGL[gl.id].data.length)return;renderSession.stencilManager.pushStencil(maskData,maskData._webGL[gl.id].data[0],renderSession)};PIXI.WebGLMaskManager.prototype.popMask=function(maskData,renderSession){var gl=this.gl;renderSession.stencilManager.popStencil(maskData,maskData._webGL[gl.id].data[0],renderSession)};PIXI.WebGLMaskManager.prototype.destroy=function(){this.gl=null};PIXI.WebGLStencilManager=function(){this.stencilStack=[];this.reverse=true;this.count=0};PIXI.WebGLStencilManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLStencilManager.prototype.pushStencil=function(graphics,webGLData,renderSession){var gl=this.gl;this.bindGraphics(graphics,webGLData,renderSession);if(this.stencilStack.length===0){gl.enable(gl.STENCIL_TEST);gl.clear(gl.STENCIL_BUFFER_BIT);this.reverse=true;this.count=0}this.stencilStack.push(webGLData);var level=this.count;gl.colorMask(false,false,false,false);gl.stencilFunc(gl.ALWAYS,0,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INVERT);if(webGLData.mode===1){gl.drawElements(gl.TRIANGLE_FAN,webGLData.indices.length-4,gl.UNSIGNED_SHORT,0);if(this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}else{gl.stencilFunc(gl.EQUAL,level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);if(this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255)}else{gl.stencilFunc(gl.EQUAL,level+1,255)}this.reverse=!this.reverse}else{if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}else{gl.stencilFunc(gl.EQUAL,level,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255)}else{gl.stencilFunc(gl.EQUAL,level+1,255)}}gl.colorMask(true,true,true,true);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP);this.count++};PIXI.WebGLStencilManager.prototype.bindGraphics=function(graphics,webGLData,renderSession){this._currentGraphics=graphics;var gl=this.gl;var projection=renderSession.projection,offset=renderSession.offset,shader;if(webGLData.mode===1){shader=renderSession.shaderManager.complexPrimitiveShader;renderSession.shaderManager.setShader(shader);gl.uniform1f(shader.flipY,renderSession.flipY);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform3fv(shader.color,webGLData.color);gl.uniform1f(shader.alpha,graphics.worldAlpha*webGLData.alpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*2,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer)}else{shader=renderSession.shaderManager.primitiveShader;renderSession.shaderManager.setShader(shader);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform1f(shader.flipY,renderSession.flipY);gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer)}};PIXI.WebGLStencilManager.prototype.popStencil=function(graphics,webGLData,renderSession){var gl=this.gl;this.stencilStack.pop();this.count--;if(this.stencilStack.length===0){gl.disable(gl.STENCIL_TEST)}else{var level=this.count;this.bindGraphics(graphics,webGLData,renderSession);gl.colorMask(false,false,false,false);if(webGLData.mode===1){this.reverse=!this.reverse;if(this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}else{gl.stencilFunc(gl.EQUAL,level+1,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);gl.stencilFunc(gl.ALWAYS,0,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INVERT);gl.drawElements(gl.TRIANGLE_FAN,webGLData.indices.length-4,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255)}else{gl.stencilFunc(gl.EQUAL,level,255)}}else{if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-(level+1),255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR)}else{gl.stencilFunc(gl.EQUAL,level+1,255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR)}gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,255-level,255)}else{gl.stencilFunc(gl.EQUAL,level,255)}}gl.colorMask(true,true,true,true);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP)}};PIXI.WebGLStencilManager.prototype.destroy=function(){this.stencilStack=null;this.gl=null};PIXI.WebGLShaderManager=function(){this.maxAttibs=10;this.attribState=[];this.tempAttribState=[];for(var i=0;i<this.maxAttibs;i++){this.attribState[i]=false}this.stack=[]};PIXI.WebGLShaderManager.prototype.constructor=PIXI.WebGLShaderManager;PIXI.WebGLShaderManager.prototype.setContext=function(gl){this.gl=gl;this.primitiveShader=new PIXI.PrimitiveShader(gl);this.complexPrimitiveShader=new PIXI.ComplexPrimitiveShader(gl);this.defaultShader=new PIXI.PixiShader(gl);this.fastShader=new PIXI.PixiFastShader(gl);this.stripShader=new PIXI.StripShader(gl);this.setShader(this.defaultShader)};PIXI.WebGLShaderManager.prototype.setAttribs=function(attribs){var i;for(i=0;i<this.tempAttribState.length;i++){this.tempAttribState[i]=false}for(i=0;i<attribs.length;i++){var attribId=attribs[i];this.tempAttribState[attribId]=true}var gl=this.gl;for(i=0;i<this.attribState.length;i++){if(this.attribState[i]!==this.tempAttribState[i]){this.attribState[i]=this.tempAttribState[i];if(this.tempAttribState[i]){gl.enableVertexAttribArray(i)}else{gl.disableVertexAttribArray(i)}}}};PIXI.WebGLShaderManager.prototype.setShader=function(shader){if(this._currentId===shader._UID)return false;this._currentId=shader._UID;this.currentShader=shader;this.gl.useProgram(shader.program);this.setAttribs(shader.attributes);return true};PIXI.WebGLShaderManager.prototype.destroy=function(){this.attribState=null;this.tempAttribState=null;this.primitiveShader.destroy();this.complexPrimitiveShader.destroy();this.defaultShader.destroy();this.fastShader.destroy();this.stripShader.destroy();this.gl=null};PIXI.WebGLSpriteBatch=function(){this.vertSize=5;this.size=2e3;var numVerts=this.size*4*4*this.vertSize;var numIndices=this.size*6;this.vertices=new PIXI.ArrayBuffer(numVerts);this.positions=new PIXI.Float32Array(this.vertices);this.colors=new PIXI.Uint32Array(this.vertices);this.indices=new PIXI.Uint16Array(numIndices);this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3}this.drawing=false;this.currentBatchSize=0;this.currentBaseTexture=null;this.dirty=true;this.textures=[];this.blendModes=[];this.shaders=[];this.sprites=[];this.defaultShader=new PIXI.AbstractFilter(["precision lowp float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"])};PIXI.WebGLSpriteBatch.prototype.setContext=function(gl){this.gl=gl;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);this.currentBlendMode=99999;var shader=new PIXI.PixiShader(gl);shader.fragmentSrc=this.defaultShader.fragmentSrc;shader.uniforms={};shader.init();this.defaultShader.shaders[gl.id]=shader};PIXI.WebGLSpriteBatch.prototype.begin=function(renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.defaultShader;this.start()};PIXI.WebGLSpriteBatch.prototype.end=function(){this.flush()};PIXI.WebGLSpriteBatch.prototype.render=function(sprite){var texture=sprite.texture;if(this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture}var uvs=texture._uvs;if(!uvs)return;var aX=sprite.anchor.x;var aY=sprite.anchor.y;var w0,w1,h0,h1;if(texture.trim){var trim=texture.trim;w1=trim.x-aX*trim.width;w0=w1+texture.crop.width;h1=trim.y-aY*trim.height;h0=h1+texture.crop.height}else{w0=texture.frame.width*(1-aX);w1=texture.frame.width*-aX;h0=texture.frame.height*(1-aY);h1=texture.frame.height*-aY}var index=this.currentBatchSize*4*this.vertSize;var resolution=texture.baseTexture.resolution;var worldTransform=sprite.worldTransform;var a=worldTransform.a/resolution;var b=worldTransform.b/resolution;var c=worldTransform.c/resolution;var d=worldTransform.d/resolution;var tx=worldTransform.tx;var ty=worldTransform.ty;var colors=this.colors;var positions=this.positions;if(this.renderSession.roundPixels){positions[index]=a*w1+c*h1+tx|0;positions[index+1]=d*h1+b*w1+ty|0;positions[index+5]=a*w0+c*h1+tx|0;positions[index+6]=d*h1+b*w0+ty|0;positions[index+10]=a*w0+c*h0+tx|0;positions[index+11]=d*h0+b*w0+ty|0;positions[index+15]=a*w1+c*h0+tx|0;positions[index+16]=d*h0+b*w1+ty|0}else{positions[index]=a*w1+c*h1+tx;positions[index+1]=d*h1+b*w1+ty;positions[index+5]=a*w0+c*h1+tx;positions[index+6]=d*h1+b*w0+ty;positions[index+10]=a*w0+c*h0+tx;positions[index+11]=d*h0+b*w0+ty;positions[index+15]=a*w1+c*h0+tx;positions[index+16]=d*h0+b*w1+ty}positions[index+2]=uvs.x0;positions[index+3]=uvs.y0;positions[index+7]=uvs.x1;positions[index+8]=uvs.y1;positions[index+12]=uvs.x2;positions[index+13]=uvs.y2;positions[index+17]=uvs.x3;positions[index+18]=uvs.y3;var tint=sprite.tint;colors[index+4]=colors[index+9]=colors[index+14]=colors[index+19]=(tint>>16)+(tint&65280)+((tint&255)<<16)+(sprite.worldAlpha*255<<24);this.sprites[this.currentBatchSize++]=sprite};PIXI.WebGLSpriteBatch.prototype.renderTilingSprite=function(tilingSprite){var texture=tilingSprite.tilingTexture;if(this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture}if(!tilingSprite._uvs)tilingSprite._uvs=new PIXI.TextureUvs;var uvs=tilingSprite._uvs;tilingSprite.tilePosition.x%=texture.baseTexture.width*tilingSprite.tileScaleOffset.x;tilingSprite.tilePosition.y%=texture.baseTexture.height*tilingSprite.tileScaleOffset.y;var offsetX=tilingSprite.tilePosition.x/(texture.baseTexture.width*tilingSprite.tileScaleOffset.x);var offsetY=tilingSprite.tilePosition.y/(texture.baseTexture.height*tilingSprite.tileScaleOffset.y);var scaleX=tilingSprite.width/texture.baseTexture.width/(tilingSprite.tileScale.x*tilingSprite.tileScaleOffset.x);var scaleY=tilingSprite.height/texture.baseTexture.height/(tilingSprite.tileScale.y*tilingSprite.tileScaleOffset.y);uvs.x0=0-offsetX;uvs.y0=0-offsetY;uvs.x1=1*scaleX-offsetX;uvs.y1=0-offsetY;uvs.x2=1*scaleX-offsetX;uvs.y2=1*scaleY-offsetY;uvs.x3=0-offsetX;uvs.y3=1*scaleY-offsetY;var tint=tilingSprite.tint;var color=(tint>>16)+(tint&65280)+((tint&255)<<16)+(tilingSprite.alpha*255<<24);var positions=this.positions;var colors=this.colors;var width=tilingSprite.width;var height=tilingSprite.height;var aX=tilingSprite.anchor.x;var aY=tilingSprite.anchor.y;var w0=width*(1-aX);var w1=width*-aX;var h0=height*(1-aY);var h1=height*-aY;var index=this.currentBatchSize*4*this.vertSize;var resolution=texture.baseTexture.resolution;var worldTransform=tilingSprite.worldTransform;var a=worldTransform.a/resolution;var b=worldTransform.b/resolution;var c=worldTransform.c/resolution;var d=worldTransform.d/resolution;var tx=worldTransform.tx;var ty=worldTransform.ty;positions[index++]=a*w1+c*h1+tx;positions[index++]=d*h1+b*w1+ty;positions[index++]=uvs.x0;positions[index++]=uvs.y0;colors[index++]=color;positions[index++]=a*w0+c*h1+tx;positions[index++]=d*h1+b*w0+ty;positions[index++]=uvs.x1;positions[index++]=uvs.y1;colors[index++]=color;positions[index++]=a*w0+c*h0+tx;positions[index++]=d*h0+b*w0+ty;positions[index++]=uvs.x2;positions[index++]=uvs.y2;colors[index++]=color;positions[index++]=a*w1+c*h0+tx;positions[index++]=d*h0+b*w1+ty;positions[index++]=uvs.x3;positions[index++]=uvs.y3;colors[index++]=color;this.sprites[this.currentBatchSize++]=tilingSprite};PIXI.WebGLSpriteBatch.prototype.flush=function(){if(this.currentBatchSize===0)return;var gl=this.gl;var shader;if(this.dirty){this.dirty=false;gl.activeTexture(gl.TEXTURE0);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);shader=this.defaultShader.shaders[gl.id];var stride=this.vertSize*4;gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(shader.colorAttribute,4,gl.UNSIGNED_BYTE,true,stride,4*4)}if(this.currentBatchSize>this.size*.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices)}else{var view=this.positions.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view)}var nextTexture,nextBlendMode,nextShader;var batchSize=0;var start=0;var currentBaseTexture=null;var currentBlendMode=this.renderSession.blendModeManager.currentBlendMode;var currentShader=null;var blendSwap=false;var shaderSwap=false;var sprite;for(var i=0,j=this.currentBatchSize;i<j;i++){sprite=this.sprites[i];nextTexture=sprite.texture.baseTexture;nextBlendMode=sprite.blendMode;nextShader=sprite.shader||this.defaultShader;blendSwap=currentBlendMode!==nextBlendMode;shaderSwap=currentShader!==nextShader;if(currentBaseTexture!==nextTexture||blendSwap||shaderSwap){this.renderBatch(currentBaseTexture,batchSize,start);start=i;batchSize=0;currentBaseTexture=nextTexture;if(blendSwap){currentBlendMode=nextBlendMode;this.renderSession.blendModeManager.setBlendMode(currentBlendMode)}if(shaderSwap){currentShader=nextShader;shader=currentShader.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=currentShader.fragmentSrc;shader.uniforms=currentShader.uniforms;shader.init();currentShader.shaders[gl.id]=shader}this.renderSession.shaderManager.setShader(shader);if(shader.dirty)shader.syncUniforms();var projection=this.renderSession.projection;gl.uniform2f(shader.projectionVector,projection.x,projection.y);var offsetVector=this.renderSession.offset;gl.uniform2f(shader.offsetVector,offsetVector.x,offsetVector.y)}}batchSize++}this.renderBatch(currentBaseTexture,batchSize,start);this.currentBatchSize=0};PIXI.WebGLSpriteBatch.prototype.renderBatch=function(texture,size,startIndex){if(size===0)return;var gl=this.gl;if(texture._dirty[gl.id]){this.renderSession.renderer.updateTexture(texture)}else{gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id])}gl.drawElements(gl.TRIANGLES,size*6,gl.UNSIGNED_SHORT,startIndex*6*2);this.renderSession.drawCount++};PIXI.WebGLSpriteBatch.prototype.stop=function(){this.flush();this.dirty=true};PIXI.WebGLSpriteBatch.prototype.start=function(){this.dirty=true};PIXI.WebGLSpriteBatch.prototype.destroy=function(){this.vertices=null;this.indices=null;this.gl.deleteBuffer(this.vertexBuffer);this.gl.deleteBuffer(this.indexBuffer);this.currentBaseTexture=null;this.gl=null};PIXI.WebGLFastSpriteBatch=function(gl){this.vertSize=10;this.maxSize=6e3;this.size=this.maxSize;var numVerts=this.size*4*this.vertSize;var numIndices=this.maxSize*6;this.vertices=new PIXI.Float32Array(numVerts);this.indices=new PIXI.Uint16Array(numIndices);this.vertexBuffer=null;this.indexBuffer=null;this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3}this.drawing=false;this.currentBatchSize=0;this.currentBaseTexture=null;this.currentBlendMode=0;this.renderSession=null;this.shader=null;this.matrix=null;this.setContext(gl)};PIXI.WebGLFastSpriteBatch.prototype.constructor=PIXI.WebGLFastSpriteBatch;PIXI.WebGLFastSpriteBatch.prototype.setContext=function(gl){this.gl=gl;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW)};PIXI.WebGLFastSpriteBatch.prototype.begin=function(spriteBatch,renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.fastShader;this.matrix=spriteBatch.worldTransform.toArray(true);this.start()};PIXI.WebGLFastSpriteBatch.prototype.end=function(){this.flush()};PIXI.WebGLFastSpriteBatch.prototype.render=function(spriteBatch){var children=spriteBatch.children;var sprite=children[0];if(!sprite.texture._uvs)return;this.currentBaseTexture=sprite.texture.baseTexture;if(sprite.blendMode!==this.renderSession.blendModeManager.currentBlendMode){this.flush();this.renderSession.blendModeManager.setBlendMode(sprite.blendMode)}for(var i=0,j=children.length;i<j;i++){this.renderSprite(children[i])}this.flush()};PIXI.WebGLFastSpriteBatch.prototype.renderSprite=function(sprite){if(!sprite.visible)return;if(sprite.texture.baseTexture!==this.currentBaseTexture){this.flush();this.currentBaseTexture=sprite.texture.baseTexture;if(!sprite.texture._uvs)return}var uvs,vertices=this.vertices,width,height,w0,w1,h0,h1,index;uvs=sprite.texture._uvs;width=sprite.texture.frame.width;height=sprite.texture.frame.height;if(sprite.texture.trim){var trim=sprite.texture.trim;w1=trim.x-sprite.anchor.x*trim.width;w0=w1+sprite.texture.crop.width;h1=trim.y-sprite.anchor.y*trim.height;h0=h1+sprite.texture.crop.height}else{w0=sprite.texture.frame.width*(1-sprite.anchor.x);w1=sprite.texture.frame.width*-sprite.anchor.x;h0=sprite.texture.frame.height*(1-sprite.anchor.y);h1=sprite.texture.frame.height*-sprite.anchor.y}index=this.currentBatchSize*4*this.vertSize;vertices[index++]=w1;vertices[index++]=h1;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x0;vertices[index++]=uvs.y1;vertices[index++]=sprite.alpha;vertices[index++]=w0;vertices[index++]=h1;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x1;vertices[index++]=uvs.y1;vertices[index++]=sprite.alpha;vertices[index++]=w0;vertices[index++]=h0;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x2;vertices[index++]=uvs.y2;vertices[index++]=sprite.alpha;vertices[index++]=w1;vertices[index++]=h0;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;vertices[index++]=sprite.rotation;vertices[index++]=uvs.x3;vertices[index++]=uvs.y3;vertices[index++]=sprite.alpha;this.currentBatchSize++;if(this.currentBatchSize>=this.size){this.flush()}};PIXI.WebGLFastSpriteBatch.prototype.flush=function(){if(this.currentBatchSize===0)return;var gl=this.gl;if(!this.currentBaseTexture._glTextures[gl.id])this.renderSession.renderer.updateTexture(this.currentBaseTexture,gl);gl.bindTexture(gl.TEXTURE_2D,this.currentBaseTexture._glTextures[gl.id]);if(this.currentBatchSize>this.size*.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices)}else{var view=this.vertices.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view)}gl.drawElements(gl.TRIANGLES,this.currentBatchSize*6,gl.UNSIGNED_SHORT,0);this.currentBatchSize=0;this.renderSession.drawCount++};PIXI.WebGLFastSpriteBatch.prototype.stop=function(){this.flush()};PIXI.WebGLFastSpriteBatch.prototype.start=function(){var gl=this.gl;gl.activeTexture(gl.TEXTURE0);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var projection=this.renderSession.projection;gl.uniform2f(this.shader.projectionVector,projection.x,projection.y);gl.uniformMatrix3fv(this.shader.uMatrix,false,this.matrix);var stride=this.vertSize*4;gl.vertexAttribPointer(this.shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(this.shader.aPositionCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(this.shader.aScale,2,gl.FLOAT,false,stride,4*4);gl.vertexAttribPointer(this.shader.aRotation,1,gl.FLOAT,false,stride,6*4);gl.vertexAttribPointer(this.shader.aTextureCoord,2,gl.FLOAT,false,stride,7*4);gl.vertexAttribPointer(this.shader.colorAttribute,1,gl.FLOAT,false,stride,9*4)};PIXI.WebGLFilterManager=function(){this.filterStack=[];this.offsetX=0;this.offsetY=0};PIXI.WebGLFilterManager.prototype.constructor=PIXI.WebGLFilterManager;PIXI.WebGLFilterManager.prototype.setContext=function(gl){this.gl=gl;this.texturePool=[];this.initShaderBuffers()};PIXI.WebGLFilterManager.prototype.begin=function(renderSession,buffer){this.renderSession=renderSession;this.defaultShader=renderSession.shaderManager.defaultShader;var projection=this.renderSession.projection;this.width=projection.x*2;this.height=-projection.y*2;this.buffer=buffer};PIXI.WebGLFilterManager.prototype.pushFilter=function(filterBlock){var gl=this.gl;var projection=this.renderSession.projection;var offset=this.renderSession.offset;filterBlock._filterArea=filterBlock.target.filterArea||filterBlock.target.getBounds();this.filterStack.push(filterBlock);var filter=filterBlock.filterPasses[0];this.offsetX+=filterBlock._filterArea.x;this.offsetY+=filterBlock._filterArea.y;var texture=this.texturePool.pop();if(!texture){texture=new PIXI.FilterTexture(this.gl,this.width,this.height)}else{texture.resize(this.width,this.height)}gl.bindTexture(gl.TEXTURE_2D,texture.texture);var filterArea=filterBlock._filterArea;var padding=filter.padding;filterArea.x-=padding;filterArea.y-=padding;filterArea.width+=padding*2;filterArea.height+=padding*2;if(filterArea.x<0)filterArea.x=0;if(filterArea.width>this.width)filterArea.width=this.width;if(filterArea.y<0)filterArea.y=0;if(filterArea.height>this.height)filterArea.height=this.height;gl.bindFramebuffer(gl.FRAMEBUFFER,texture.frameBuffer);gl.viewport(0,0,filterArea.width,filterArea.height);projection.x=filterArea.width/2;projection.y=-filterArea.height/2;offset.x=-filterArea.x;offset.y=-filterArea.y;gl.colorMask(true,true,true,true);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);filterBlock._glFilterTexture=texture};PIXI.WebGLFilterManager.prototype.popFilter=function(){var gl=this.gl;var filterBlock=this.filterStack.pop();var filterArea=filterBlock._filterArea;var texture=filterBlock._glFilterTexture;var projection=this.renderSession.projection;var offset=this.renderSession.offset;if(filterBlock.filterPasses.length>1){gl.viewport(0,0,filterArea.width,filterArea.height);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=0;this.vertexArray[1]=filterArea.height;this.vertexArray[2]=filterArea.width;this.vertexArray[3]=filterArea.height;this.vertexArray[4]=0;this.vertexArray[5]=0;this.vertexArray[6]=filterArea.width;this.vertexArray[7]=0;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);var inputTexture=texture;var outputTexture=this.texturePool.pop();if(!outputTexture)outputTexture=new PIXI.FilterTexture(this.gl,this.width,this.height);outputTexture.resize(this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.BLEND);for(var i=0;i<filterBlock.filterPasses.length-1;i++){var filterPass=filterBlock.filterPasses[i];gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,inputTexture.texture);this.applyFilterPass(filterPass,filterArea,filterArea.width,filterArea.height);var temp=inputTexture;inputTexture=outputTexture;outputTexture=temp}gl.enable(gl.BLEND);texture=inputTexture;this.texturePool.push(outputTexture)}var filter=filterBlock.filterPasses[filterBlock.filterPasses.length-1];this.offsetX-=filterArea.x;this.offsetY-=filterArea.y;var sizeX=this.width;var sizeY=this.height;var offsetX=0;var offsetY=0;var buffer=this.buffer;if(this.filterStack.length===0){gl.colorMask(true,true,true,true)}else{var currentFilter=this.filterStack[this.filterStack.length-1];filterArea=currentFilter._filterArea;sizeX=filterArea.width;sizeY=filterArea.height;offsetX=filterArea.x;offsetY=filterArea.y;buffer=currentFilter._glFilterTexture.frameBuffer}projection.x=sizeX/2;projection.y=-sizeY/2;offset.x=offsetX;offset.y=offsetY;filterArea=filterBlock._filterArea;var x=filterArea.x-offsetX;var y=filterArea.y-offsetY;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=x;this.vertexArray[1]=y+filterArea.height;this.vertexArray[2]=x+filterArea.width;this.vertexArray[3]=y+filterArea.height;this.vertexArray[4]=x;this.vertexArray[5]=y;this.vertexArray[6]=x+filterArea.width;this.vertexArray[7]=y;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);gl.viewport(0,0,sizeX*this.renderSession.resolution,sizeY*this.renderSession.resolution);gl.bindFramebuffer(gl.FRAMEBUFFER,buffer);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture.texture);this.applyFilterPass(filter,filterArea,sizeX,sizeY);this.texturePool.push(texture);filterBlock._glFilterTexture=null};PIXI.WebGLFilterManager.prototype.applyFilterPass=function(filter,filterArea,width,height){var gl=this.gl;var shader=filter.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=filter.fragmentSrc;shader.uniforms=filter.uniforms;shader.init();filter.shaders[gl.id]=shader}this.renderSession.shaderManager.setShader(shader);gl.uniform2f(shader.projectionVector,width/2,-height/2);gl.uniform2f(shader.offsetVector,0,0);if(filter.uniforms.dimensions){filter.uniforms.dimensions.value[0]=this.width;filter.uniforms.dimensions.value[1]=this.height;filter.uniforms.dimensions.value[2]=this.vertexArray[0];filter.uniforms.dimensions.value[3]=this.vertexArray[5]}shader.syncUniforms();gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.vertexAttribPointer(shader.colorAttribute,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0);this.renderSession.drawCount++};PIXI.WebGLFilterManager.prototype.initShaderBuffers=function(){var gl=this.gl;this.vertexBuffer=gl.createBuffer();this.uvBuffer=gl.createBuffer();this.colorBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.vertexArray=new PIXI.Float32Array([0,0,1,0,0,1,1,1]);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertexArray,gl.STATIC_DRAW);this.uvArray=new PIXI.Float32Array([0,0,1,0,0,1,1,1]);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvArray,gl.STATIC_DRAW);this.colorArray=new PIXI.Float32Array([1,16777215,1,16777215,1,16777215,1,16777215]);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colorArray,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,1,3,2]),gl.STATIC_DRAW)};PIXI.WebGLFilterManager.prototype.destroy=function(){var gl=this.gl;this.filterStack=null;this.offsetX=0;this.offsetY=0;for(var i=0;i<this.texturePool.length;i++){this.texturePool[i].destroy()}this.texturePool=null;gl.deleteBuffer(this.vertexBuffer);gl.deleteBuffer(this.uvBuffer);gl.deleteBuffer(this.colorBuffer);gl.deleteBuffer(this.indexBuffer)};PIXI.FilterTexture=function(gl,width,height,scaleMode){this.gl=gl;this.frameBuffer=gl.createFramebuffer();this.texture=gl.createTexture();scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);this.renderBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this.renderBuffer);this.resize(width,height)};PIXI.FilterTexture.prototype.constructor=PIXI.FilterTexture;PIXI.FilterTexture.prototype.clear=function(){var gl=this.gl;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT)};PIXI.FilterTexture.prototype.resize=function(width,height){if(this.width===width&&this.height===height)return;this.width=width;this.height=height;var gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height)};PIXI.FilterTexture.prototype.destroy=function(){var gl=this.gl;gl.deleteFramebuffer(this.frameBuffer);gl.deleteTexture(this.texture);this.frameBuffer=null;this.texture=null};PIXI.CanvasBuffer=function(width,height){this.width=width;this.height=height;this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=width;this.canvas.height=height};PIXI.CanvasBuffer.prototype.constructor=PIXI.CanvasBuffer;PIXI.CanvasBuffer.prototype.clear=function(){this.context.setTransform(1,0,0,1,0,0);this.context.clearRect(0,0,this.width,this.height)};PIXI.CanvasBuffer.prototype.resize=function(width,height){this.width=this.canvas.width=width;this.height=this.canvas.height=height};PIXI.CanvasMaskManager=function(){};PIXI.CanvasMaskManager.prototype.constructor=PIXI.CanvasMaskManager;PIXI.CanvasMaskManager.prototype.pushMask=function(maskData,renderSession){var context=renderSession.context;context.save();var cacheAlpha=maskData.alpha;var transform=maskData.worldTransform;var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);PIXI.CanvasGraphics.renderGraphicsMask(maskData,context);context.clip();maskData.worldAlpha=cacheAlpha};PIXI.CanvasMaskManager.prototype.popMask=function(renderSession){renderSession.context.restore()};PIXI.CanvasTinter=function(){};PIXI.CanvasTinter.getTintedTexture=function(sprite,color){var texture=sprite.texture;color=PIXI.CanvasTinter.roundColor(color);var stringColor="#"+("00000"+(color|0).toString(16)).substr(-6);texture.tintCache=texture.tintCache||{};if(texture.tintCache[stringColor])return texture.tintCache[stringColor];var canvas=PIXI.CanvasTinter.canvas||document.createElement("canvas");PIXI.CanvasTinter.tintMethod(texture,color,canvas);if(PIXI.CanvasTinter.convertTintToImage){var tintImage=new Image;tintImage.src=canvas.toDataURL();texture.tintCache[stringColor]=tintImage}else{texture.tintCache[stringColor]=canvas;PIXI.CanvasTinter.canvas=null}return canvas};PIXI.CanvasTinter.tintWithMultiply=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,crop.width,crop.height);context.globalCompositeOperation="multiply";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height)};PIXI.CanvasTinter.tintWithOverlay=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.globalCompositeOperation="copy";context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,crop.width,crop.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height)};PIXI.CanvasTinter.tintWithPerPixel=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.globalCompositeOperation="copy";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);var rgbValues=PIXI.hex2rgb(color);var r=rgbValues[0],g=rgbValues[1],b=rgbValues[2];var pixelData=context.getImageData(0,0,crop.width,crop.height);var pixels=pixelData.data;for(var i=0;i<pixels.length;i+=4){pixels[i+0]*=r;pixels[i+1]*=g;pixels[i+2]*=b}context.putImageData(pixelData,0,0)};PIXI.CanvasTinter.roundColor=function(color){var step=PIXI.CanvasTinter.cacheStepsPerColorChannel;var rgbValues=PIXI.hex2rgb(color);rgbValues[0]=Math.min(255,rgbValues[0]/step*step);rgbValues[1]=Math.min(255,rgbValues[1]/step*step);rgbValues[2]=Math.min(255,rgbValues[2]/step*step);return PIXI.rgb2hex(rgbValues)};PIXI.CanvasTinter.cacheStepsPerColorChannel=8;PIXI.CanvasTinter.convertTintToImage=false;PIXI.CanvasTinter.canUseMultiply=PIXI.canUseNewCanvasBlendModes();PIXI.CanvasTinter.tintMethod=PIXI.CanvasTinter.canUseMultiply?PIXI.CanvasTinter.tintWithMultiply:PIXI.CanvasTinter.tintWithPerPixel;PIXI.CanvasRenderer=function(width,height,options){if(options){for(var i in PIXI.defaultRenderOptions){if(typeof options[i]==="undefined")options[i]=PIXI.defaultRenderOptions[i]}}else{options=PIXI.defaultRenderOptions}if(!PIXI.defaultRenderer){PIXI.sayHello("Canvas");PIXI.defaultRenderer=this}this.type=PIXI.CANVAS_RENDERER;this.resolution=options.resolution;this.clearBeforeRender=options.clearBeforeRender;this.transparent=options.transparent;this.autoResize=options.autoResize||false;this.width=width||800;this.height=height||600;this.width*=this.resolution;this.height*=this.resolution;this.view=options.view||document.createElement("canvas");this.context=this.view.getContext("2d",{alpha:this.transparent});this.refresh=true;this.view.width=this.width*this.resolution;this.view.height=this.height*this.resolution;this.count=0;this.maskManager=new PIXI.CanvasMaskManager;this.renderSession={context:this.context,maskManager:this.maskManager,scaleMode:null,smoothProperty:null,roundPixels:false};this.mapBlendModes();this.resize(width,height);if("imageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="imageSmoothingEnabled";else if("webkitImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="webkitImageSmoothingEnabled";else if("mozImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="mozImageSmoothingEnabled";else if("oImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="oImageSmoothingEnabled";else if("msImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="msImageSmoothingEnabled"};PIXI.CanvasRenderer.prototype.constructor=PIXI.CanvasRenderer;PIXI.CanvasRenderer.prototype.render=function(stage){stage.updateTransform();this.context.setTransform(1,0,0,1,0,0);this.context.globalAlpha=1;this.renderSession.currentBlendMode=PIXI.blendModes.NORMAL;this.context.globalCompositeOperation=PIXI.blendModesCanvas[PIXI.blendModes.NORMAL];if(navigator.isCocoonJS&&this.view.screencanvas){this.context.fillStyle="black";this.context.clear()}if(this.clearBeforeRender){if(this.transparent){this.context.clearRect(0,0,this.width,this.height)}else{this.context.fillStyle=stage.backgroundColorString;this.context.fillRect(0,0,this.width,this.height)}}this.renderDisplayObject(stage);if(stage.interactive){if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this)}}};PIXI.CanvasRenderer.prototype.destroy=function(removeView){if(typeof removeView==="undefined"){removeView=true}if(removeView&&this.view.parent){this.view.parent.removeChild(this.view)}this.view=null;this.context=null;this.maskManager=null;this.renderSession=null};PIXI.CanvasRenderer.prototype.resize=function(width,height){this.width=width*this.resolution;this.height=height*this.resolution;this.view.width=this.width;this.view.height=this.height;if(this.autoResize){this.view.style.width=this.width/this.resolution+"px";this.view.style.height=this.height/this.resolution+"px"}};PIXI.CanvasRenderer.prototype.renderDisplayObject=function(displayObject,context){this.renderSession.context=context||this.context;this.renderSession.resolution=this.resolution;displayObject._renderCanvas(this.renderSession)};PIXI.CanvasRenderer.prototype.mapBlendModes=function(){if(!PIXI.blendModesCanvas){PIXI.blendModesCanvas=[];if(PIXI.canUseNewCanvasBlendModes()){PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="multiply";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="screen";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="overlay";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="darken";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="lighten";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="color-dodge";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="color-burn";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="hard-light";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="soft-light";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="difference";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="exclusion";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="hue";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="saturation";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="color";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="luminosity"}else{PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="source-over";
PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="source-over"}}};PIXI.CanvasGraphics=function(){};PIXI.CanvasGraphics.renderGraphics=function(graphics,context){var worldAlpha=graphics.worldAlpha;if(graphics.dirty){this.updateGraphicsTint(graphics);graphics.dirty=false}for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var shape=data.shape;var fillColor=data._fillTint;var lineColor=data._lineTint;context.lineWidth=data.lineWidth;if(data.type===PIXI.Graphics.POLY){context.beginPath();var points=shape.points;context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1])}if(shape.closed){context.lineTo(points[0],points[1])}if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath()}if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}else if(data.type===PIXI.Graphics.RECT){if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fillRect(shape.x,shape.y,shape.width,shape.height)}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.strokeRect(shape.x,shape.y,shape.width,shape.height)}}else if(data.type===PIXI.Graphics.CIRC){context.beginPath();context.arc(shape.x,shape.y,shape.radius,0,2*Math.PI);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}else if(data.type===PIXI.Graphics.ELIP){var w=shape.width*2;var h=shape.height*2;var x=shape.x-w/2;var y=shape.y-h/2;context.beginPath();var kappa=.5522848,ox=w/2*kappa,oy=h/2*kappa,xe=x+w,ye=y+h,xm=x+w/2,ym=y+h/2;context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}else if(data.type===PIXI.Graphics.RREC){var rx=shape.x;var ry=shape.y;var width=shape.width;var height=shape.height;var radius=shape.radius;var maxRadius=Math.min(width,height)/2|0;radius=radius>maxRadius?maxRadius:radius;context.beginPath();context.moveTo(rx,ry+radius);context.lineTo(rx,ry+height-radius);context.quadraticCurveTo(rx,ry+height,rx+radius,ry+height);context.lineTo(rx+width-radius,ry+height);context.quadraticCurveTo(rx+width,ry+height,rx+width,ry+height-radius);context.lineTo(rx+width,ry+radius);context.quadraticCurveTo(rx+width,ry,rx+width-radius,ry);context.lineTo(rx+radius,ry);context.quadraticCurveTo(rx,ry,rx,ry+radius);context.closePath();if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle="#"+("00000"+(fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle="#"+("00000"+(lineColor|0).toString(16)).substr(-6);context.stroke()}}}};PIXI.CanvasGraphics.renderGraphicsMask=function(graphics,context){var len=graphics.graphicsData.length;if(len===0)return;if(len>1){len=1;window.console.log("Pixi.js warning: masks in canvas can only mask using the first path in the graphics object")}for(var i=0;i<1;i++){var data=graphics.graphicsData[i];var shape=data.shape;if(data.type===PIXI.Graphics.POLY){context.beginPath();var points=shape.points;context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1])}if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath()}}else if(data.type===PIXI.Graphics.RECT){context.beginPath();context.rect(shape.x,shape.y,shape.width,shape.height);context.closePath()}else if(data.type===PIXI.Graphics.CIRC){context.beginPath();context.arc(shape.x,shape.y,shape.radius,0,2*Math.PI);context.closePath()}else if(data.type===PIXI.Graphics.ELIP){var w=shape.width*2;var h=shape.height*2;var x=shape.x-w/2;var y=shape.y-h/2;context.beginPath();var kappa=.5522848,ox=w/2*kappa,oy=h/2*kappa,xe=x+w,ye=y+h,xm=x+w/2,ym=y+h/2;context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath()}else if(data.type===PIXI.Graphics.RREC){var pts=shape.points;var rx=pts[0];var ry=pts[1];var width=pts[2];var height=pts[3];var radius=pts[4];var maxRadius=Math.min(width,height)/2|0;radius=radius>maxRadius?maxRadius:radius;context.beginPath();context.moveTo(rx,ry+radius);context.lineTo(rx,ry+height-radius);context.quadraticCurveTo(rx,ry+height,rx+radius,ry+height);context.lineTo(rx+width-radius,ry+height);context.quadraticCurveTo(rx+width,ry+height,rx+width,ry+height-radius);context.lineTo(rx+width,ry+radius);context.quadraticCurveTo(rx+width,ry,rx+width-radius,ry);context.lineTo(rx+radius,ry);context.quadraticCurveTo(rx,ry,rx,ry+radius);context.closePath()}}};PIXI.CanvasGraphics.updateGraphicsTint=function(graphics){if(graphics.tint===16777215)return;var tintR=(graphics.tint>>16&255)/255;var tintG=(graphics.tint>>8&255)/255;var tintB=(graphics.tint&255)/255;for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var fillColor=data.fillColor|0;var lineColor=data.lineColor|0;data._fillTint=((fillColor>>16&255)/255*tintR*255<<16)+((fillColor>>8&255)/255*tintG*255<<8)+(fillColor&255)/255*tintB*255;data._lineTint=((lineColor>>16&255)/255*tintR*255<<16)+((lineColor>>8&255)/255*tintG*255<<8)+(lineColor&255)/255*tintB*255}};PIXI.Graphics=function(){PIXI.DisplayObjectContainer.call(this);this.renderable=true;this.fillAlpha=1;this.lineWidth=0;this.lineColor=0;this.graphicsData=[];this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL;this.currentPath=null;this._webGL=[];this.isMask=false;this.boundsPadding=0;this._localBounds=new PIXI.Rectangle(0,0,1,1);this.dirty=true;this.webGLDirty=false;this.cachedSpriteDirty=false};PIXI.Graphics.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Graphics.prototype.constructor=PIXI.Graphics;Object.defineProperty(PIXI.Graphics.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap},set:function(value){this._cacheAsBitmap=value;if(this._cacheAsBitmap){this._generateCachedSprite()}else{this.destroyCachedSprite();this.dirty=true}}});PIXI.Graphics.prototype.lineStyle=function(lineWidth,color,alpha){this.lineWidth=lineWidth||0;this.lineColor=color||0;this.lineAlpha=arguments.length<3?1:alpha;if(this.currentPath){if(this.currentPath.shape.points.length){this.drawShape(new PIXI.Polygon(this.currentPath.shape.points.slice(-2)));return this}this.currentPath.lineWidth=this.lineWidth;this.currentPath.lineColor=this.lineColor;this.currentPath.lineAlpha=this.lineAlpha}return this};PIXI.Graphics.prototype.moveTo=function(x,y){this.drawShape(new PIXI.Polygon([x,y]));return this};PIXI.Graphics.prototype.lineTo=function(x,y){this.currentPath.shape.points.push(x,y);this.dirty=true;return this};PIXI.Graphics.prototype.quadraticCurveTo=function(cpX,cpY,toX,toY){if(this.currentPath){if(this.currentPath.shape.points.length===0)this.currentPath.shape.points=[0,0]}else{this.moveTo(0,0)}var xa,ya,n=20,points=this.currentPath.shape.points;if(points.length===0)this.moveTo(0,0);var fromX=points[points.length-2];var fromY=points[points.length-1];var j=0;for(var i=1;i<=n;i++){j=i/n;xa=fromX+(cpX-fromX)*j;ya=fromY+(cpY-fromY)*j;points.push(xa+(cpX+(toX-cpX)*j-xa)*j,ya+(cpY+(toY-cpY)*j-ya)*j)}this.dirty=true;return this};PIXI.Graphics.prototype.bezierCurveTo=function(cpX,cpY,cpX2,cpY2,toX,toY){if(this.currentPath){if(this.currentPath.shape.points.length===0)this.currentPath.shape.points=[0,0]}else{this.moveTo(0,0)}var n=20,dt,dt2,dt3,t2,t3,points=this.currentPath.shape.points;var fromX=points[points.length-2];var fromY=points[points.length-1];var j=0;for(var i=1;i<=n;i++){j=i/n;dt=1-j;dt2=dt*dt;dt3=dt2*dt;t2=j*j;t3=t2*j;points.push(dt3*fromX+3*dt2*j*cpX+3*dt*t2*cpX2+t3*toX,dt3*fromY+3*dt2*j*cpY+3*dt*t2*cpY2+t3*toY)}this.dirty=true;return this};PIXI.Graphics.prototype.arcTo=function(x1,y1,x2,y2,radius){if(this.currentPath){if(this.currentPath.shape.points.length===0){this.currentPath.shape.points.push(x1,y1)}}else{this.moveTo(x1,y1)}var points=this.currentPath.shape.points;var fromX=points[points.length-2];var fromY=points[points.length-1];var a1=fromY-y1;var b1=fromX-x1;var a2=y2-y1;var b2=x2-x1;var mm=Math.abs(a1*b2-b1*a2);if(mm<1e-8||radius===0){if(points[points.length-2]!==x1||points[points.length-1]!==y1){points.push(x1,y1)}}else{var dd=a1*a1+b1*b1;var cc=a2*a2+b2*b2;var tt=a1*a2+b1*b2;var k1=radius*Math.sqrt(dd)/mm;var k2=radius*Math.sqrt(cc)/mm;var j1=k1*tt/dd;var j2=k2*tt/cc;var cx=k1*b2+k2*b1;var cy=k1*a2+k2*a1;var px=b1*(k2+j1);var py=a1*(k2+j1);var qx=b2*(k1+j2);var qy=a2*(k1+j2);var startAngle=Math.atan2(py-cy,px-cx);var endAngle=Math.atan2(qy-cy,qx-cx);this.arc(cx+x1,cy+y1,radius,startAngle,endAngle,b1*a2>b2*a1)}this.dirty=true;return this};PIXI.Graphics.prototype.arc=function(cx,cy,radius,startAngle,endAngle,anticlockwise){var startX=cx+Math.cos(startAngle)*radius;var startY=cy+Math.sin(startAngle)*radius;var points;if(this.currentPath){points=this.currentPath.shape.points;if(points.length===0){points.push(startX,startY)}else if(points[points.length-2]!==startX||points[points.length-1]!==startY){points.push(startX,startY)}}else{this.moveTo(startX,startY);points=this.currentPath.shape.points}if(startAngle===endAngle)return this;if(!anticlockwise&&endAngle<=startAngle){endAngle+=Math.PI*2}else if(anticlockwise&&startAngle<=endAngle){startAngle+=Math.PI*2}var sweep=anticlockwise?(startAngle-endAngle)*-1:endAngle-startAngle;var segs=Math.abs(sweep)/(Math.PI*2)*40;if(sweep===0)return this;var theta=sweep/(segs*2);var theta2=theta*2;var cTheta=Math.cos(theta);var sTheta=Math.sin(theta);var segMinus=segs-1;var remainder=segMinus%1/segMinus;for(var i=0;i<=segMinus;i++){var real=i+remainder*i;var angle=theta+startAngle+theta2*real;var c=Math.cos(angle);var s=-Math.sin(angle);points.push((cTheta*c+sTheta*s)*radius+cx,(cTheta*-s+sTheta*c)*radius+cy)}this.dirty=true;return this};PIXI.Graphics.prototype.beginFill=function(color,alpha){this.filling=true;this.fillColor=color||0;this.fillAlpha=alpha===undefined?1:alpha;if(this.currentPath){if(this.currentPath.shape.points.length<=2){this.currentPath.fill=this.filling;this.currentPath.fillColor=this.fillColor;this.currentPath.fillAlpha=this.fillAlpha}}return this};PIXI.Graphics.prototype.endFill=function(){this.filling=false;this.fillColor=null;this.fillAlpha=1;return this};PIXI.Graphics.prototype.drawRect=function(x,y,width,height){this.drawShape(new PIXI.Rectangle(x,y,width,height));return this};PIXI.Graphics.prototype.drawRoundedRect=function(x,y,width,height,radius){this.drawShape(new PIXI.RoundedRectangle(x,y,width,height,radius));return this};PIXI.Graphics.prototype.drawCircle=function(x,y,radius){this.drawShape(new PIXI.Circle(x,y,radius));return this};PIXI.Graphics.prototype.drawEllipse=function(x,y,width,height){this.drawShape(new PIXI.Ellipse(x,y,width,height));return this};PIXI.Graphics.prototype.drawPolygon=function(path){if(!(path instanceof Array))path=Array.prototype.slice.call(arguments);this.drawShape(new PIXI.Polygon(path));return this};PIXI.Graphics.prototype.clear=function(){this.lineWidth=0;this.filling=false;this.dirty=true;this.clearDirty=true;this.graphicsData=[];return this};PIXI.Graphics.prototype.generateTexture=function(resolution,scaleMode){resolution=resolution||1;var bounds=this.getBounds();var canvasBuffer=new PIXI.CanvasBuffer(bounds.width*resolution,bounds.height*resolution);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas,scaleMode);texture.baseTexture.resolution=resolution;canvasBuffer.context.scale(resolution,resolution);canvasBuffer.context.translate(-bounds.x,-bounds.y);PIXI.CanvasGraphics.renderGraphics(this,canvasBuffer.context);return texture};PIXI.Graphics.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0||this.isMask===true)return;if(this._cacheAsBitmap){if(this.dirty||this.cachedSpriteDirty){this._generateCachedSprite();this.updateCachedSpriteTexture();this.cachedSpriteDirty=false;this.dirty=false}this._cachedSprite.worldAlpha=this.worldAlpha;PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession);return}else{renderSession.spriteBatch.stop();renderSession.blendModeManager.setBlendMode(this.blendMode);if(this._mask)renderSession.maskManager.pushMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.pushFilter(this._filterBlock);if(this.blendMode!==renderSession.spriteBatch.currentBlendMode){renderSession.spriteBatch.currentBlendMode=this.blendMode;var blendModeWebGL=PIXI.blendModesWebGL[renderSession.spriteBatch.currentBlendMode];renderSession.spriteBatch.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1])}if(this.webGLDirty){this.dirty=true;this.webGLDirty=false}PIXI.WebGLGraphics.renderGraphics(this,renderSession);if(this.children.length){renderSession.spriteBatch.start();for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop()}if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(this.mask,renderSession);renderSession.drawCount++;renderSession.spriteBatch.start()}};PIXI.Graphics.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0||this.isMask===true)return;if(this._cacheAsBitmap){if(this.dirty||this.cachedSpriteDirty){this._generateCachedSprite();this.updateCachedSpriteTexture();this.cachedSpriteDirty=false;this.dirty=false}this._cachedSprite.alpha=this.alpha;PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession);return}else{var context=renderSession.context;var transform=this.worldTransform;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);PIXI.CanvasGraphics.renderGraphics(this,context);for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession)}}};PIXI.Graphics.prototype.getBounds=function(matrix){if(this.isMask)return PIXI.EmptyRectangle;if(this.dirty){this.updateLocalBounds();this.webGLDirty=true;this.cachedSpriteDirty=true;this.dirty=false}var bounds=this._localBounds;var w0=bounds.x;var w1=bounds.width+bounds.x;var h0=bounds.y;var h1=bounds.height+bounds.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=x1;var maxY=y1;var minX=x1;var minY=y1;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;this._bounds.x=minX;this._bounds.width=maxX-minX;this._bounds.y=minY;this._bounds.height=maxY-minY;return this._bounds};PIXI.Graphics.prototype.updateLocalBounds=function(){var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;if(this.graphicsData.length){var shape,points,x,y,w,h;for(var i=0;i<this.graphicsData.length;i++){var data=this.graphicsData[i];var type=data.type;var lineWidth=data.lineWidth;shape=data.shape;if(type===PIXI.Graphics.RECT||type===PIXI.Graphics.RREC){x=shape.x-lineWidth/2;y=shape.y-lineWidth/2;w=shape.width+lineWidth;h=shape.height+lineWidth;minX=x<minX?x:minX;maxX=x+w>maxX?x+w:maxX;minY=y<minY?y:minY;maxY=y+h>maxY?y+h:maxY}else if(type===PIXI.Graphics.CIRC){x=shape.x;y=shape.y;w=shape.radius+lineWidth/2;h=shape.radius+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY}else if(type===PIXI.Graphics.ELIP){x=shape.x;y=shape.y;w=shape.width+lineWidth/2;h=shape.height+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY}else{points=shape.points;for(var j=0;j<points.length;j+=2){x=points[j];y=points[j+1];minX=x-lineWidth<minX?x-lineWidth:minX;maxX=x+lineWidth>maxX?x+lineWidth:maxX;minY=y-lineWidth<minY?y-lineWidth:minY;maxY=y+lineWidth>maxY?y+lineWidth:maxY}}}}else{minX=0;maxX=0;minY=0;maxY=0}var padding=this.boundsPadding;this._localBounds.x=minX-padding;this._localBounds.width=maxX-minX+padding*2;this._localBounds.y=minY-padding;this._localBounds.height=maxY-minY+padding*2};PIXI.Graphics.prototype._generateCachedSprite=function(){var bounds=this.getLocalBounds();if(!this._cachedSprite){var canvasBuffer=new PIXI.CanvasBuffer(bounds.width,bounds.height);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this._cachedSprite=new PIXI.Sprite(texture);this._cachedSprite.buffer=canvasBuffer;this._cachedSprite.worldTransform=this.worldTransform}else{this._cachedSprite.buffer.resize(bounds.width,bounds.height)}this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._cachedSprite.buffer.context.translate(-bounds.x,-bounds.y);this.worldAlpha=1;PIXI.CanvasGraphics.renderGraphics(this,this._cachedSprite.buffer.context);this._cachedSprite.alpha=this.alpha};PIXI.Graphics.prototype.updateCachedSpriteTexture=function(){var cachedSprite=this._cachedSprite;var texture=cachedSprite.texture;var canvas=cachedSprite.buffer.canvas;texture.baseTexture.width=canvas.width;texture.baseTexture.height=canvas.height;texture.crop.width=texture.frame.width=canvas.width;texture.crop.height=texture.frame.height=canvas.height;cachedSprite._width=canvas.width;cachedSprite._height=canvas.height;texture.baseTexture.dirty()};PIXI.Graphics.prototype.destroyCachedSprite=function(){this._cachedSprite.texture.destroy(true);this._cachedSprite=null};PIXI.Graphics.prototype.drawShape=function(shape){if(this.currentPath){if(this.currentPath.shape.points.length<=2)this.graphicsData.pop()}this.currentPath=null;var data=new PIXI.GraphicsData(this.lineWidth,this.lineColor,this.lineAlpha,this.fillColor,this.fillAlpha,this.filling,shape);this.graphicsData.push(data);if(data.type===PIXI.Graphics.POLY){data.shape.closed=this.filling;this.currentPath=data}this.dirty=true;return data};PIXI.GraphicsData=function(lineWidth,lineColor,lineAlpha,fillColor,fillAlpha,fill,shape){this.lineWidth=lineWidth;this.lineColor=lineColor;this.lineAlpha=lineAlpha;this._lineTint=lineColor;this.fillColor=fillColor;this.fillAlpha=fillAlpha;this._fillTint=fillColor;this.fill=fill;this.shape=shape;this.type=shape.type};PIXI.Graphics.POLY=0;PIXI.Graphics.RECT=1;PIXI.Graphics.CIRC=2;PIXI.Graphics.ELIP=3;PIXI.Graphics.RREC=4;PIXI.Polygon.prototype.type=PIXI.Graphics.POLY;PIXI.Rectangle.prototype.type=PIXI.Graphics.RECT;PIXI.Circle.prototype.type=PIXI.Graphics.CIRC;PIXI.Ellipse.prototype.type=PIXI.Graphics.ELIP;PIXI.RoundedRectangle.prototype.type=PIXI.Graphics.RREC;PIXI.Strip=function(texture){PIXI.DisplayObjectContainer.call(this);this.texture=texture;this.uvs=new PIXI.Float32Array([0,1,1,1,1,0,0,1]);this.vertices=new PIXI.Float32Array([0,0,100,0,100,100,0,100]);this.colors=new PIXI.Float32Array([1,1,1,1]);this.indices=new PIXI.Uint16Array([0,1,2,3]);this.dirty=true;this.blendMode=PIXI.blendModes.NORMAL;this.canvasPadding=0;this.drawMode=PIXI.Strip.DrawModes.TRIANGLE_STRIP};PIXI.Strip.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Strip.prototype.constructor=PIXI.Strip;PIXI.Strip.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;renderSession.spriteBatch.stop();if(!this._vertexBuffer)this._initWebGL(renderSession);renderSession.shaderManager.setShader(renderSession.shaderManager.stripShader);this._renderStrip(renderSession);renderSession.spriteBatch.start()};PIXI.Strip.prototype._initWebGL=function(renderSession){var gl=renderSession.gl;this._vertexBuffer=gl.createBuffer();this._indexBuffer=gl.createBuffer();this._uvBuffer=gl.createBuffer();this._colorBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvs,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this._colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colors,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW)};PIXI.Strip.prototype._renderStrip=function(renderSession){var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.stripShader;var drawMode=this.drawMode===PIXI.Strip.DrawModes.TRIANGLE_STRIP?gl.TRIANGLE_STRIP:gl.TRIANGLES;renderSession.blendModeManager.setBlendMode(this.blendMode);gl.uniformMatrix3fv(shader.translationMatrix,false,this.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform1f(shader.alpha,this.worldAlpha);if(!this.dirty){gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);if(this.texture.baseTexture._dirty[gl.id]){renderSession.renderer.updateTexture(this.texture.baseTexture)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture.baseTexture._glTextures[gl.id])}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer)}else{this.dirty=false;gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvs,gl.STATIC_DRAW);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);if(this.texture.baseTexture._dirty[gl.id]){renderSession.renderer.updateTexture(this.texture.baseTexture)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture.baseTexture._glTextures[gl.id])}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW)}gl.drawElements(drawMode,this.indices.length,gl.UNSIGNED_SHORT,0)};PIXI.Strip.prototype._renderCanvas=function(renderSession){var context=renderSession.context;var transform=this.worldTransform;if(renderSession.roundPixels){context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx|0,transform.ty|0)}else{context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx,transform.ty)}if(this.drawMode===PIXI.Strip.DrawModes.TRIANGLE_STRIP){this._renderCanvasTriangleStrip(context)}else{this._renderCanvasTriangles(context)}};PIXI.Strip.prototype._renderCanvasTriangleStrip=function(context){var vertices=this.vertices;var uvs=this.uvs;var length=vertices.length/2;this.count++;for(var i=0;i<length-2;i++){var index=i*2;this._renderCanvasDrawTriangle(context,vertices,uvs,index,index+2,index+4)}};PIXI.Strip.prototype._renderCanvasTriangles=function(context){var vertices=this.vertices;var uvs=this.uvs;var indices=this.indices;var length=indices.length;this.count++;for(var i=0;i<length;i+=3){var index0=indices[i]*2,index1=indices[i+1]*2,index2=indices[i+2]*2;this._renderCanvasDrawTriangle(context,vertices,uvs,index0,index1,index2)}};PIXI.Strip.prototype._renderCanvasDrawTriangle=function(context,vertices,uvs,index0,index1,index2){var textureSource=this.texture.baseTexture.source;var textureWidth=this.texture.width;var textureHeight=this.texture.height;var x0=vertices[index0],x1=vertices[index1],x2=vertices[index2];var y0=vertices[index0+1],y1=vertices[index1+1],y2=vertices[index2+1];var u0=uvs[index0]*textureWidth,u1=uvs[index1]*textureWidth,u2=uvs[index2]*textureWidth;var v0=uvs[index0+1]*textureHeight,v1=uvs[index1+1]*textureHeight,v2=uvs[index2+1]*textureHeight;if(this.canvasPadding>0){var paddingX=this.canvasPadding/this.worldTransform.a;var paddingY=this.canvasPadding/this.worldTransform.d;var centerX=(x0+x1+x2)/3;var centerY=(y0+y1+y2)/3;var normX=x0-centerX;var normY=y0-centerY;var dist=Math.sqrt(normX*normX+normY*normY);x0=centerX+normX/dist*(dist+paddingX);y0=centerY+normY/dist*(dist+paddingY);normX=x1-centerX;normY=y1-centerY;dist=Math.sqrt(normX*normX+normY*normY);x1=centerX+normX/dist*(dist+paddingX);y1=centerY+normY/dist*(dist+paddingY);normX=x2-centerX;normY=y2-centerY;dist=Math.sqrt(normX*normX+normY*normY);x2=centerX+normX/dist*(dist+paddingX);y2=centerY+normY/dist*(dist+paddingY)}context.save();context.beginPath();context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2);context.closePath();context.clip();var delta=u0*v1+v0*u2+u1*v2-v1*u2-v0*u1-u0*v2;var deltaA=x0*v1+v0*x2+x1*v2-v1*x2-v0*x1-x0*v2;var deltaB=u0*x1+x0*u2+u1*x2-x1*u2-x0*u1-u0*x2;var deltaC=u0*v1*x2+v0*x1*u2+x0*u1*v2-x0*v1*u2-v0*u1*x2-u0*x1*v2;var deltaD=y0*v1+v0*y2+y1*v2-v1*y2-v0*y1-y0*v2;var deltaE=u0*y1+y0*u2+u1*y2-y1*u2-y0*u1-u0*y2;var deltaF=u0*v1*y2+v0*y1*u2+y0*u1*v2-y0*v1*u2-v0*u1*y2-u0*y1*v2;context.transform(deltaA/delta,deltaD/delta,deltaB/delta,deltaE/delta,deltaC/delta,deltaF/delta);context.drawImage(textureSource,0,0);context.restore()};PIXI.Strip.prototype.renderStripFlat=function(strip){var context=this.context;var vertices=strip.vertices;var length=vertices.length/2;this.count++;context.beginPath();for(var i=1;i<length-2;i++){var index=i*2;var x0=vertices[index],x1=vertices[index+2],x2=vertices[index+4];var y0=vertices[index+1],y1=vertices[index+3],y2=vertices[index+5];context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2)}context.fillStyle="#FF0000";context.fill();context.closePath()};PIXI.Strip.prototype.onTextureUpdate=function(){this.updateFrame=true};PIXI.Strip.prototype.getBounds=function(matrix){var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;var vertices=this.vertices;for(var i=0,n=vertices.length;i<n;i+=2){var rawX=vertices[i],rawY=vertices[i+1];var x=a*rawX+c*rawY+tx;var y=d*rawY+b*rawX+ty;minX=x<minX?x:minX;minY=y<minY?y:minY;maxX=x>maxX?x:maxX;maxY=y>maxY?y:maxY}if(minX===-Infinity||maxY===Infinity){return PIXI.EmptyRectangle}var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.Strip.DrawModes={TRIANGLE_STRIP:0,TRIANGLES:1};PIXI.Rope=function(texture,points){PIXI.Strip.call(this,texture);this.points=points;this.vertices=new PIXI.Float32Array(points.length*4);this.uvs=new PIXI.Float32Array(points.length*4);this.colors=new PIXI.Float32Array(points.length*2);this.indices=new PIXI.Uint16Array(points.length*2);this.refresh()};PIXI.Rope.prototype=Object.create(PIXI.Strip.prototype);PIXI.Rope.prototype.constructor=PIXI.Rope;PIXI.Rope.prototype.refresh=function(){var points=this.points;if(points.length<1)return;var uvs=this.uvs;var lastPoint=points[0];var indices=this.indices;var colors=this.colors;this.count-=.2;uvs[0]=0;uvs[1]=0;uvs[2]=0;uvs[3]=1;colors[0]=1;colors[1]=1;indices[0]=0;indices[1]=1;var total=points.length,point,index,amount;for(var i=1;i<total;i++){point=points[i];index=i*4;amount=i/(total-1);if(i%2){uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1}else{uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1}index=i*2;colors[index]=1;colors[index+1]=1;index=i*2;indices[index]=index;indices[index+1]=index+1;lastPoint=point}};PIXI.Rope.prototype.updateTransform=function(){var points=this.points;if(points.length<1)return;var lastPoint=points[0];var nextPoint;var perp={x:0,y:0};this.count-=.2;var vertices=this.vertices;var total=points.length,point,index,ratio,perpLength,num;for(var i=0;i<total;i++){point=points[i];index=i*4;if(i<points.length-1){nextPoint=points[i+1]}else{nextPoint=point}perp.y=-(nextPoint.x-lastPoint.x);perp.x=nextPoint.y-lastPoint.y;ratio=(1-i/(total-1))*10;if(ratio>1)ratio=1;perpLength=Math.sqrt(perp.x*perp.x+perp.y*perp.y);num=this.texture.height/2;perp.x/=perpLength;perp.y/=perpLength;perp.x*=num;perp.y*=num;vertices[index]=point.x+perp.x;vertices[index+1]=point.y+perp.y;vertices[index+2]=point.x-perp.x;vertices[index+3]=point.y-perp.y;lastPoint=point}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.Rope.prototype.setTexture=function(texture){this.texture=texture};PIXI.TilingSprite=function(texture,width,height){PIXI.Sprite.call(this,texture);this._width=width||100;this._height=height||100;this.tileScale=new PIXI.Point(1,1);this.tileScaleOffset=new PIXI.Point(1,1);this.tilePosition=new PIXI.Point(0,0);this.renderable=true;this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL};PIXI.TilingSprite.prototype=Object.create(PIXI.Sprite.prototype);PIXI.TilingSprite.prototype.constructor=PIXI.TilingSprite;Object.defineProperty(PIXI.TilingSprite.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value}});Object.defineProperty(PIXI.TilingSprite.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value}});PIXI.TilingSprite.prototype.setTexture=function(texture){if(this.texture===texture)return;this.texture=texture;this.refreshTexture=true;this.cachedTint=16777215};PIXI.TilingSprite.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0)return;var i,j;if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start()}if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(!this.tilingTexture||this.refreshTexture){this.generateTilingTexture(true);if(this.tilingTexture&&this.tilingTexture.needsUpdate){renderSession.renderer.updateTexture(this.tilingTexture.baseTexture);this.tilingTexture.needsUpdate=false}}else{renderSession.spriteBatch.renderTilingSprite(this)}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop();if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);
renderSession.spriteBatch.start()};PIXI.TilingSprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;var context=renderSession.context;if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession)}context.globalAlpha=this.worldAlpha;var transform=this.worldTransform;var i,j;var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);if(!this.__tilePattern||this.refreshTexture){this.generateTilingTexture(false);if(this.tilingTexture){this.__tilePattern=context.createPattern(this.tilingTexture.baseTexture.source,"repeat")}else{return}}if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}var tilePosition=this.tilePosition;var tileScale=this.tileScale;tilePosition.x%=this.tilingTexture.baseTexture.width;tilePosition.y%=this.tilingTexture.baseTexture.height;context.scale(tileScale.x,tileScale.y);context.translate(tilePosition.x+this.anchor.x*-this._width,tilePosition.y+this.anchor.y*-this._height);context.fillStyle=this.__tilePattern;context.fillRect(-tilePosition.x,-tilePosition.y,this._width/tileScale.x,this._height/tileScale.y);context.scale(1/tileScale.x,1/tileScale.y);context.translate(-tilePosition.x+this.anchor.x*this._width,-tilePosition.y+this.anchor.y*this._height);if(this._mask){renderSession.maskManager.popMask(renderSession)}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession)}};PIXI.TilingSprite.prototype.getBounds=function(){var width=this._width;var height=this._height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.TilingSprite.prototype.onTextureUpdate=function(){};PIXI.TilingSprite.prototype.generateTilingTexture=function(forcePowerOfTwo){if(!this.texture.baseTexture.hasLoaded)return;var texture=this.originalTexture||this.texture;var frame=texture.frame;var targetWidth,targetHeight;var isFrame=frame.width!==texture.baseTexture.width||frame.height!==texture.baseTexture.height;var newTextureRequired=false;if(!forcePowerOfTwo){if(isFrame){if(texture.trim){targetWidth=texture.trim.width;targetHeight=texture.trim.height}else{targetWidth=frame.width;targetHeight=frame.height}newTextureRequired=true}}else{targetWidth=PIXI.getNextPowerOfTwo(frame.width);targetHeight=PIXI.getNextPowerOfTwo(frame.height);if(frame.width!==targetWidth||frame.height!==targetHeight||texture.baseTexture.width!==targetWidth||texture.baseTexture.height||targetHeight)newTextureRequired=true}if(newTextureRequired){var canvasBuffer;if(this.tilingTexture&&this.tilingTexture.isTiling){canvasBuffer=this.tilingTexture.canvasBuffer;canvasBuffer.resize(targetWidth,targetHeight);this.tilingTexture.baseTexture.width=targetWidth;this.tilingTexture.baseTexture.height=targetHeight;this.tilingTexture.needsUpdate=true}else{canvasBuffer=new PIXI.CanvasBuffer(targetWidth,targetHeight);this.tilingTexture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this.tilingTexture.canvasBuffer=canvasBuffer;this.tilingTexture.isTiling=true}canvasBuffer.context.drawImage(texture.baseTexture.source,texture.crop.x,texture.crop.y,texture.crop.width,texture.crop.height,0,0,targetWidth,targetHeight);this.tileScaleOffset.x=frame.width/targetWidth;this.tileScaleOffset.y=frame.height/targetHeight}else{if(this.tilingTexture&&this.tilingTexture.isTiling){this.tilingTexture.destroy(true)}this.tileScaleOffset.x=1;this.tileScaleOffset.y=1;this.tilingTexture=texture}this.refreshTexture=false;this.originalTexture=this.texture;this.texture=this.tilingTexture;this.tilingTexture.baseTexture._powerOf2=true};PIXI.TilingSprite.prototype.destroy=function(){PIXI.Sprite.prototype.destroy.call(this);this.tileScale=null;this.tileScaleOffset=null;this.tilePosition=null;if(this.tilingTexture){this.tilingTexture.destroy(true);this.tilingTexture=null}};var spine={radDeg:180/Math.PI,degRad:Math.PI/180,temp:[],Float32Array:typeof Float32Array==="undefined"?Array:Float32Array,Uint16Array:typeof Uint16Array==="undefined"?Array:Uint16Array};spine.BoneData=function(name,parent){this.name=name;this.parent=parent};spine.BoneData.prototype={length:0,x:0,y:0,rotation:0,scaleX:1,scaleY:1,inheritScale:true,inheritRotation:true,flipX:false,flipY:false};spine.SlotData=function(name,boneData){this.name=name;this.boneData=boneData};spine.SlotData.prototype={r:1,g:1,b:1,a:1,attachmentName:null,additiveBlending:false};spine.IkConstraintData=function(name){this.name=name;this.bones=[]};spine.IkConstraintData.prototype={target:null,bendDirection:1,mix:1};spine.Bone=function(boneData,skeleton,parent){this.data=boneData;this.skeleton=skeleton;this.parent=parent;this.setToSetupPose()};spine.Bone.yDown=false;spine.Bone.prototype={x:0,y:0,rotation:0,rotationIK:0,scaleX:1,scaleY:1,flipX:false,flipY:false,m00:0,m01:0,worldX:0,m10:0,m11:0,worldY:0,worldRotation:0,worldScaleX:1,worldScaleY:1,worldFlipX:false,worldFlipY:false,updateWorldTransform:function(){var parent=this.parent;if(parent){this.worldX=this.x*parent.m00+this.y*parent.m01+parent.worldX;this.worldY=this.x*parent.m10+this.y*parent.m11+parent.worldY;if(this.data.inheritScale){this.worldScaleX=parent.worldScaleX*this.scaleX;this.worldScaleY=parent.worldScaleY*this.scaleY}else{this.worldScaleX=this.scaleX;this.worldScaleY=this.scaleY}this.worldRotation=this.data.inheritRotation?parent.worldRotation+this.rotationIK:this.rotationIK;this.worldFlipX=parent.worldFlipX!=this.flipX;this.worldFlipY=parent.worldFlipY!=this.flipY}else{var skeletonFlipX=this.skeleton.flipX,skeletonFlipY=this.skeleton.flipY;this.worldX=skeletonFlipX?-this.x:this.x;this.worldY=skeletonFlipY!=spine.Bone.yDown?-this.y:this.y;this.worldScaleX=this.scaleX;this.worldScaleY=this.scaleY;this.worldRotation=this.rotationIK;this.worldFlipX=skeletonFlipX!=this.flipX;this.worldFlipY=skeletonFlipY!=this.flipY}var radians=this.worldRotation*spine.degRad;var cos=Math.cos(radians);var sin=Math.sin(radians);if(this.worldFlipX){this.m00=-cos*this.worldScaleX;this.m01=sin*this.worldScaleY}else{this.m00=cos*this.worldScaleX;this.m01=-sin*this.worldScaleY}if(this.worldFlipY!=spine.Bone.yDown){this.m10=-sin*this.worldScaleX;this.m11=-cos*this.worldScaleY}else{this.m10=sin*this.worldScaleX;this.m11=cos*this.worldScaleY}},setToSetupPose:function(){var data=this.data;this.x=data.x;this.y=data.y;this.rotation=data.rotation;this.rotationIK=this.rotation;this.scaleX=data.scaleX;this.scaleY=data.scaleY;this.flipX=data.flipX;this.flipY=data.flipY},worldToLocal:function(world){var dx=world[0]-this.worldX,dy=world[1]-this.worldY;var m00=this.m00,m10=this.m10,m01=this.m01,m11=this.m11;if(this.worldFlipX!=(this.worldFlipY!=spine.Bone.yDown)){m00=-m00;m11=-m11}var invDet=1/(m00*m11-m01*m10);world[0]=dx*m00*invDet-dy*m01*invDet;world[1]=dy*m11*invDet-dx*m10*invDet},localToWorld:function(local){var localX=local[0],localY=local[1];local[0]=localX*this.m00+localY*this.m01+this.worldX;local[1]=localX*this.m10+localY*this.m11+this.worldY}};spine.Slot=function(slotData,bone){this.data=slotData;this.bone=bone;this.setToSetupPose()};spine.Slot.prototype={r:1,g:1,b:1,a:1,_attachmentTime:0,attachment:null,attachmentVertices:[],setAttachment:function(attachment){this.attachment=attachment;this._attachmentTime=this.bone.skeleton.time;this.attachmentVertices.length=0},setAttachmentTime:function(time){this._attachmentTime=this.bone.skeleton.time-time},getAttachmentTime:function(){return this.bone.skeleton.time-this._attachmentTime},setToSetupPose:function(){var data=this.data;this.r=data.r;this.g=data.g;this.b=data.b;this.a=data.a;var slotDatas=this.bone.skeleton.data.slots;for(var i=0,n=slotDatas.length;i<n;i++){if(slotDatas[i]==data){this.setAttachment(!data.attachmentName?null:this.bone.skeleton.getAttachmentBySlotIndex(i,data.attachmentName));break}}}};spine.IkConstraint=function(data,skeleton){this.data=data;this.mix=data.mix;this.bendDirection=data.bendDirection;this.bones=[];for(var i=0,n=data.bones.length;i<n;i++)this.bones.push(skeleton.findBone(data.bones[i].name));this.target=skeleton.findBone(data.target.name)};spine.IkConstraint.prototype={apply:function(){var target=this.target;var bones=this.bones;switch(bones.length){case 1:spine.IkConstraint.apply1(bones[0],target.worldX,target.worldY,this.mix);break;case 2:spine.IkConstraint.apply2(bones[0],bones[1],target.worldX,target.worldY,this.bendDirection,this.mix);break}}};spine.IkConstraint.apply1=function(bone,targetX,targetY,alpha){var parentRotation=!bone.data.inheritRotation||!bone.parent?0:bone.parent.worldRotation;var rotation=bone.rotation;var rotationIK=Math.atan2(targetY-bone.worldY,targetX-bone.worldX)*spine.radDeg-parentRotation;bone.rotationIK=rotation+(rotationIK-rotation)*alpha};spine.IkConstraint.apply2=function(parent,child,targetX,targetY,bendDirection,alpha){var childRotation=child.rotation,parentRotation=parent.rotation;if(!alpha){child.rotationIK=childRotation;parent.rotationIK=parentRotation;return}var positionX,positionY,tempPosition=spine.temp;var parentParent=parent.parent;if(parentParent){tempPosition[0]=targetX;tempPosition[1]=targetY;parentParent.worldToLocal(tempPosition);targetX=(tempPosition[0]-parent.x)*parentParent.worldScaleX;targetY=(tempPosition[1]-parent.y)*parentParent.worldScaleY}else{targetX-=parent.x;targetY-=parent.y}if(child.parent==parent){positionX=child.x;positionY=child.y}else{tempPosition[0]=child.x;tempPosition[1]=child.y;child.parent.localToWorld(tempPosition);parent.worldToLocal(tempPosition);positionX=tempPosition[0];positionY=tempPosition[1]}var childX=positionX*parent.worldScaleX,childY=positionY*parent.worldScaleY;var offset=Math.atan2(childY,childX);var len1=Math.sqrt(childX*childX+childY*childY),len2=child.data.length*child.worldScaleX;var cosDenom=2*len1*len2;if(cosDenom<1e-4){child.rotationIK=childRotation+(Math.atan2(targetY,targetX)*spine.radDeg-parentRotation-childRotation)*alpha;return}var cos=(targetX*targetX+targetY*targetY-len1*len1-len2*len2)/cosDenom;if(cos<-1)cos=-1;else if(cos>1)cos=1;var childAngle=Math.acos(cos)*bendDirection;var adjacent=len1+len2*cos,opposite=len2*Math.sin(childAngle);var parentAngle=Math.atan2(targetY*adjacent-targetX*opposite,targetX*adjacent+targetY*opposite);var rotation=(parentAngle-offset)*spine.radDeg-parentRotation;if(rotation>180)rotation-=360;else if(rotation<-180)rotation+=360;parent.rotationIK=parentRotation+rotation*alpha;rotation=(childAngle+offset)*spine.radDeg-childRotation;if(rotation>180)rotation-=360;else if(rotation<-180)rotation+=360;child.rotationIK=childRotation+(rotation+parent.worldRotation-child.parent.worldRotation)*alpha};spine.Skin=function(name){this.name=name;this.attachments={}};spine.Skin.prototype={addAttachment:function(slotIndex,name,attachment){this.attachments[slotIndex+":"+name]=attachment},getAttachment:function(slotIndex,name){return this.attachments[slotIndex+":"+name]},_attachAll:function(skeleton,oldSkin){for(var key in oldSkin.attachments){var colon=key.indexOf(":");var slotIndex=parseInt(key.substring(0,colon));var name=key.substring(colon+1);var slot=skeleton.slots[slotIndex];if(slot.attachment&&slot.attachment.name==name){var attachment=this.getAttachment(slotIndex,name);if(attachment)slot.setAttachment(attachment)}}}};spine.Animation=function(name,timelines,duration){this.name=name;this.timelines=timelines;this.duration=duration};spine.Animation.prototype={apply:function(skeleton,lastTime,time,loop,events){if(loop&&this.duration!=0){time%=this.duration;lastTime%=this.duration}var timelines=this.timelines;for(var i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,lastTime,time,events,1)},mix:function(skeleton,lastTime,time,loop,events,alpha){if(loop&&this.duration!=0){time%=this.duration;lastTime%=this.duration}var timelines=this.timelines;for(var i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,lastTime,time,events,alpha)}};spine.Animation.binarySearch=function(values,target,step){var low=0;var high=Math.floor(values.length/step)-2;if(!high)return step;var current=high>>>1;while(true){if(values[(current+1)*step]<=target)low=current+1;else high=current;if(low==high)return(low+1)*step;current=low+high>>>1}};spine.Animation.binarySearch1=function(values,target){var low=0;var high=values.length-2;if(!high)return 1;var current=high>>>1;while(true){if(values[current+1]<=target)low=current+1;else high=current;if(low==high)return low+1;current=low+high>>>1}};spine.Animation.linearSearch=function(values,target,step){for(var i=0,last=values.length-step;i<=last;i+=step)if(values[i]>target)return i;return-1};spine.Curves=function(frameCount){this.curves=[]};spine.Curves.prototype={setLinear:function(frameIndex){this.curves[frameIndex*19]=0},setStepped:function(frameIndex){this.curves[frameIndex*19]=1},setCurve:function(frameIndex,cx1,cy1,cx2,cy2){var subdiv1=1/10,subdiv2=subdiv1*subdiv1,subdiv3=subdiv2*subdiv1;var pre1=3*subdiv1,pre2=3*subdiv2,pre4=6*subdiv2,pre5=6*subdiv3;var tmp1x=-cx1*2+cx2,tmp1y=-cy1*2+cy2,tmp2x=(cx1-cx2)*3+1,tmp2y=(cy1-cy2)*3+1;var dfx=cx1*pre1+tmp1x*pre2+tmp2x*subdiv3,dfy=cy1*pre1+tmp1y*pre2+tmp2y*subdiv3;var ddfx=tmp1x*pre4+tmp2x*pre5,ddfy=tmp1y*pre4+tmp2y*pre5;var dddfx=tmp2x*pre5,dddfy=tmp2y*pre5;var i=frameIndex*19;var curves=this.curves;curves[i++]=2;var x=dfx,y=dfy;for(var n=i+19-1;i<n;i+=2){curves[i]=x;curves[i+1]=y;dfx+=ddfx;dfy+=ddfy;ddfx+=dddfx;ddfy+=dddfy;x+=dfx;y+=dfy}},getCurvePercent:function(frameIndex,percent){percent=percent<0?0:percent>1?1:percent;var curves=this.curves;var i=frameIndex*19;var type=curves[i];if(type===0)return percent;if(type==1)return 0;i++;var x=0;for(var start=i,n=i+19-1;i<n;i+=2){x=curves[i];if(x>=percent){var prevX,prevY;if(i==start){prevX=0;prevY=0}else{prevX=curves[i-2];prevY=curves[i-1]}return prevY+(curves[i+1]-prevY)*(percent-prevX)/(x-prevX)}}var y=curves[i-1];return y+(1-y)*(percent-x)/(1-x)}};spine.RotateTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*2};spine.RotateTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2},setFrame:function(frameIndex,time,angle){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=angle},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-2]){var amount=bone.data.rotation+frames[frames.length-1]-bone.rotation;while(amount>180)amount-=360;while(amount<-180)amount+=360;bone.rotation+=amount*alpha;return}var frameIndex=spine.Animation.binarySearch(frames,time,2);var prevFrameValue=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-2]-frameTime);percent=this.curves.getCurvePercent(frameIndex/2-1,percent);var amount=frames[frameIndex+1]-prevFrameValue;while(amount>180)amount-=360;while(amount<-180)amount+=360;amount=bone.data.rotation+(prevFrameValue+amount*percent)-bone.rotation;while(amount>180)amount-=360;while(amount<-180)amount+=360;bone.rotation+=amount*alpha}};spine.TranslateTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*3};spine.TranslateTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/3},setFrame:function(frameIndex,time,x,y){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=x;this.frames[frameIndex+2]=y},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-3]){bone.x+=(bone.data.x+frames[frames.length-2]-bone.x)*alpha;bone.y+=(bone.data.y+frames[frames.length-1]-bone.y)*alpha;return}var frameIndex=spine.Animation.binarySearch(frames,time,3);var prevFrameX=frames[frameIndex-2];var prevFrameY=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);bone.x+=(bone.data.x+prevFrameX+(frames[frameIndex+1]-prevFrameX)*percent-bone.x)*alpha;bone.y+=(bone.data.y+prevFrameY+(frames[frameIndex+2]-prevFrameY)*percent-bone.y)*alpha}};spine.ScaleTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*3};spine.ScaleTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/3},setFrame:function(frameIndex,time,x,y){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=x;this.frames[frameIndex+2]=y},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-3]){bone.scaleX+=(bone.data.scaleX*frames[frames.length-2]-bone.scaleX)*alpha;bone.scaleY+=(bone.data.scaleY*frames[frames.length-1]-bone.scaleY)*alpha;return}var frameIndex=spine.Animation.binarySearch(frames,time,3);var prevFrameX=frames[frameIndex-2];var prevFrameY=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);bone.scaleX+=(bone.data.scaleX*(prevFrameX+(frames[frameIndex+1]-prevFrameX)*percent)-bone.scaleX)*alpha;bone.scaleY+=(bone.data.scaleY*(prevFrameY+(frames[frameIndex+2]-prevFrameY)*percent)-bone.scaleY)*alpha}};spine.ColorTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*5};spine.ColorTimeline.prototype={slotIndex:0,getFrameCount:function(){return this.frames.length/5},setFrame:function(frameIndex,time,r,g,b,a){frameIndex*=5;this.frames[frameIndex]=time;this.frames[frameIndex+1]=r;this.frames[frameIndex+2]=g;this.frames[frameIndex+3]=b;this.frames[frameIndex+4]=a},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;var r,g,b,a;if(time>=frames[frames.length-5]){var i=frames.length-1;r=frames[i-3];g=frames[i-2];b=frames[i-1];a=frames[i]}else{var frameIndex=spine.Animation.binarySearch(frames,time,5);var prevFrameR=frames[frameIndex-4];var prevFrameG=frames[frameIndex-3];var prevFrameB=frames[frameIndex-2];var prevFrameA=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-5]-frameTime);percent=this.curves.getCurvePercent(frameIndex/5-1,percent);r=prevFrameR+(frames[frameIndex+1]-prevFrameR)*percent;g=prevFrameG+(frames[frameIndex+2]-prevFrameG)*percent;b=prevFrameB+(frames[frameIndex+3]-prevFrameB)*percent;a=prevFrameA+(frames[frameIndex+4]-prevFrameA)*percent}var slot=skeleton.slots[this.slotIndex];if(alpha<1){slot.r+=(r-slot.r)*alpha;slot.g+=(g-slot.g)*alpha;slot.b+=(b-slot.b)*alpha;slot.a+=(a-slot.a)*alpha}else{slot.r=r;slot.g=g;slot.b=b;slot.a=a}}};spine.AttachmentTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount;this.attachmentNames=[];this.attachmentNames.length=frameCount};spine.AttachmentTimeline.prototype={slotIndex:0,getFrameCount:function(){return this.frames.length},setFrame:function(frameIndex,time,attachmentName){this.frames[frameIndex]=time;this.attachmentNames[frameIndex]=attachmentName},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0]){if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,null,0);return}else if(lastTime>time)lastTime=-1;var frameIndex=time>=frames[frames.length-1]?frames.length-1:spine.Animation.binarySearch1(frames,time)-1;if(frames[frameIndex]<lastTime)return;var attachmentName=this.attachmentNames[frameIndex];skeleton.slots[this.slotIndex].setAttachment(!attachmentName?null:skeleton.getAttachmentBySlotIndex(this.slotIndex,attachmentName))}};spine.EventTimeline=function(frameCount){this.frames=[];this.frames.length=frameCount;this.events=[];this.events.length=frameCount};spine.EventTimeline.prototype={getFrameCount:function(){return this.frames.length},setFrame:function(frameIndex,time,event){this.frames[frameIndex]=time;this.events[frameIndex]=event},apply:function(skeleton,lastTime,time,firedEvents,alpha){if(!firedEvents)return;var frames=this.frames;var frameCount=frames.length;if(lastTime>time){this.apply(skeleton,lastTime,Number.MAX_VALUE,firedEvents,alpha);lastTime=-1}else if(lastTime>=frames[frameCount-1])return;if(time<frames[0])return;var frameIndex;if(lastTime<frames[0])frameIndex=0;else{frameIndex=spine.Animation.binarySearch1(frames,lastTime);var frame=frames[frameIndex];while(frameIndex>0){if(frames[frameIndex-1]!=frame)break;frameIndex--}}var events=this.events;for(;frameIndex<frameCount&&time>=frames[frameIndex];frameIndex++)firedEvents.push(events[frameIndex])}};spine.DrawOrderTimeline=function(frameCount){this.frames=[];this.frames.length=frameCount;this.drawOrders=[];this.drawOrders.length=frameCount};spine.DrawOrderTimeline.prototype={getFrameCount:function(){return this.frames.length},setFrame:function(frameIndex,time,drawOrder){this.frames[frameIndex]=time;this.drawOrders[frameIndex]=drawOrder},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;var frameIndex;if(time>=frames[frames.length-1])frameIndex=frames.length-1;else frameIndex=spine.Animation.binarySearch1(frames,time)-1;var drawOrder=skeleton.drawOrder;var slots=skeleton.slots;var drawOrderToSetupIndex=this.drawOrders[frameIndex];if(drawOrderToSetupIndex){for(var i=0,n=drawOrderToSetupIndex.length;i<n;i++)drawOrder[i]=drawOrderToSetupIndex[i]}}};spine.FfdTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount;this.frameVertices=[];this.frameVertices.length=frameCount};spine.FfdTimeline.prototype={slotIndex:0,attachment:0,getFrameCount:function(){return this.frames.length},setFrame:function(frameIndex,time,vertices){this.frames[frameIndex]=time;this.frameVertices[frameIndex]=vertices},apply:function(skeleton,lastTime,time,firedEvents,alpha){var slot=skeleton.slots[this.slotIndex];if(slot.attachment!=this.attachment)return;var frames=this.frames;if(time<frames[0])return;var frameVertices=this.frameVertices;var vertexCount=frameVertices[0].length;var vertices=slot.attachmentVertices;if(vertices.length!=vertexCount)alpha=1;vertices.length=vertexCount;if(time>=frames[frames.length-1]){var lastVertices=frameVertices[frames.length-1];if(alpha<1){for(var i=0;i<vertexCount;i++)vertices[i]+=(lastVertices[i]-vertices[i])*alpha}else{for(var i=0;i<vertexCount;i++)vertices[i]=lastVertices[i]}return}var frameIndex=spine.Animation.binarySearch1(frames,time);var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-1]-frameTime);percent=this.curves.getCurvePercent(frameIndex-1,percent<0?0:percent>1?1:percent);var prevVertices=frameVertices[frameIndex-1];var nextVertices=frameVertices[frameIndex];if(alpha<1){for(var i=0;i<vertexCount;i++){var prev=prevVertices[i];vertices[i]+=(prev+(nextVertices[i]-prev)*percent-vertices[i])*alpha}}else{for(var i=0;i<vertexCount;i++){var prev=prevVertices[i];vertices[i]=prev+(nextVertices[i]-prev)*percent}}}};spine.IkConstraintTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*3};spine.IkConstraintTimeline.prototype={ikConstraintIndex:0,getFrameCount:function(){return this.frames.length/3},setFrame:function(frameIndex,time,mix,bendDirection){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=mix;this.frames[frameIndex+2]=bendDirection},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;var ikConstraint=skeleton.ikConstraints[this.ikConstraintIndex];if(time>=frames[frames.length-3]){ikConstraint.mix+=(frames[frames.length-2]-ikConstraint.mix)*alpha;ikConstraint.bendDirection=frames[frames.length-1];return}var frameIndex=spine.Animation.binarySearch(frames,time,3);var prevFrameMix=frames[frameIndex+-2];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);var mix=prevFrameMix+(frames[frameIndex+1]-prevFrameMix)*percent;ikConstraint.mix+=(mix-ikConstraint.mix)*alpha;ikConstraint.bendDirection=frames[frameIndex+-1]}};spine.FlipXTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*2};spine.FlipXTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2},setFrame:function(frameIndex,time,flip){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=flip?1:0},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0]){if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,null,0);return}else if(lastTime>time)lastTime=-1;var frameIndex=(time>=frames[frames.length-2]?frames.length:spine.Animation.binarySearch(frames,time,2))-2;if(frames[frameIndex]<lastTime)return;skeleton.bones[boneIndex].flipX=frames[frameIndex+1]!=0}};spine.FlipYTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*2};spine.FlipYTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2},setFrame:function(frameIndex,time,flip){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=flip?1:0},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0]){if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,null,0);return}else if(lastTime>time)lastTime=-1;var frameIndex=(time>=frames[frames.length-2]?frames.length:spine.Animation.binarySearch(frames,time,2))-2;if(frames[frameIndex]<lastTime)return;skeleton.bones[boneIndex].flipY=frames[frameIndex+1]!=0}};spine.SkeletonData=function(){this.bones=[];this.slots=[];this.skins=[];this.events=[];this.animations=[];this.ikConstraints=[]};spine.SkeletonData.prototype={name:null,defaultSkin:null,width:0,height:0,version:null,hash:null,findBone:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return bones[i];return null},findBoneIndex:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return i;return-1},findSlot:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){if(slots[i].name==slotName)return slot[i]}return null},findSlotIndex:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].name==slotName)return i;return-1},findSkin:function(skinName){var skins=this.skins;for(var i=0,n=skins.length;i<n;i++)if(skins[i].name==skinName)return skins[i];return null},findEvent:function(eventName){var events=this.events;for(var i=0,n=events.length;i<n;i++)if(events[i].name==eventName)return events[i];return null},findAnimation:function(animationName){var animations=this.animations;for(var i=0,n=animations.length;i<n;i++)if(animations[i].name==animationName)return animations[i];return null},findIkConstraint:function(ikConstraintName){var ikConstraints=this.ikConstraints;for(var i=0,n=ikConstraints.length;i<n;i++)if(ikConstraints[i].name==ikConstraintName)return ikConstraints[i];return null}};spine.Skeleton=function(skeletonData){this.data=skeletonData;this.bones=[];for(var i=0,n=skeletonData.bones.length;i<n;i++){var boneData=skeletonData.bones[i];var parent=!boneData.parent?null:this.bones[skeletonData.bones.indexOf(boneData.parent)];this.bones.push(new spine.Bone(boneData,this,parent))}this.slots=[];this.drawOrder=[];for(var i=0,n=skeletonData.slots.length;i<n;i++){var slotData=skeletonData.slots[i];var bone=this.bones[skeletonData.bones.indexOf(slotData.boneData)];var slot=new spine.Slot(slotData,bone);this.slots.push(slot);this.drawOrder.push(i)}this.ikConstraints=[];for(var i=0,n=skeletonData.ikConstraints.length;i<n;i++)this.ikConstraints.push(new spine.IkConstraint(skeletonData.ikConstraints[i],this));this.boneCache=[];this.updateCache()};spine.Skeleton.prototype={x:0,y:0,skin:null,r:1,g:1,b:1,a:1,time:0,flipX:false,flipY:false,updateCache:function(){var ikConstraints=this.ikConstraints;var ikConstraintsCount=ikConstraints.length;var arrayCount=ikConstraintsCount+1;var boneCache=this.boneCache;if(boneCache.length>arrayCount)boneCache.length=arrayCount;for(var i=0,n=boneCache.length;i<n;i++)boneCache[i].length=0;while(boneCache.length<arrayCount)boneCache[boneCache.length]=[];var nonIkBones=boneCache[0];var bones=this.bones;outer:for(var i=0,n=bones.length;i<n;i++){var bone=bones[i];var current=bone;do{for(var ii=0;ii<ikConstraintsCount;ii++){var ikConstraint=ikConstraints[ii];var parent=ikConstraint.bones[0];var child=ikConstraint.bones[ikConstraint.bones.length-1];while(true){if(current==child){boneCache[ii].push(bone);boneCache[ii+1].push(bone);continue outer}if(child==parent)break;child=child.parent}}current=current.parent}while(current);nonIkBones[nonIkBones.length]=bone}},updateWorldTransform:function(){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++){var bone=bones[i];bone.rotationIK=bone.rotation}var i=0,last=this.boneCache.length-1;while(true){var cacheBones=this.boneCache[i];for(var ii=0,nn=cacheBones.length;ii<nn;ii++)cacheBones[ii].updateWorldTransform();if(i==last)break;this.ikConstraints[i].apply();i++}},setToSetupPose:function(){this.setBonesToSetupPose();this.setSlotsToSetupPose()},setBonesToSetupPose:function(){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)bones[i].setToSetupPose();var ikConstraints=this.ikConstraints;for(var i=0,n=ikConstraints.length;i<n;i++){var ikConstraint=ikConstraints[i];ikConstraint.bendDirection=ikConstraint.data.bendDirection;ikConstraint.mix=ikConstraint.data.mix}},setSlotsToSetupPose:function(){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){slots[i].setToSetupPose(i)}this.resetDrawOrder()},getRootBone:function(){return this.bones.length?this.bones[0]:null},findBone:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return bones[i];return null},findBoneIndex:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return i;return-1},findSlot:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return slots[i];return null},findSlotIndex:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return i;return-1},setSkinByName:function(skinName){var skin=this.data.findSkin(skinName);if(!skin)throw"Skin not found: "+skinName;this.setSkin(skin)},setSkin:function(newSkin){if(newSkin){if(this.skin)newSkin._attachAll(this,this.skin);else{var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){var slot=slots[i];var name=slot.data.attachmentName;if(name){var attachment=newSkin.getAttachment(i,name);
if(attachment)slot.setAttachment(attachment)}}}}this.skin=newSkin},getAttachmentBySlotName:function(slotName,attachmentName){return this.getAttachmentBySlotIndex(this.data.findSlotIndex(slotName),attachmentName)},getAttachmentBySlotIndex:function(slotIndex,attachmentName){if(this.skin){var attachment=this.skin.getAttachment(slotIndex,attachmentName);if(attachment)return attachment}if(this.data.defaultSkin)return this.data.defaultSkin.getAttachment(slotIndex,attachmentName);return null},setAttachment:function(slotName,attachmentName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){var slot=slots[i];if(slot.data.name==slotName){var attachment=null;if(attachmentName){attachment=this.getAttachmentBySlotIndex(i,attachmentName);if(!attachment)throw"Attachment not found: "+attachmentName+", for slot: "+slotName}slot.setAttachment(attachment);return}}throw"Slot not found: "+slotName},findIkConstraint:function(ikConstraintName){var ikConstraints=this.ikConstraints;for(var i=0,n=ikConstraints.length;i<n;i++)if(ikConstraints[i].data.name==ikConstraintName)return ikConstraints[i];return null},update:function(delta){this.time+=delta},resetDrawOrder:function(){for(var i=0,n=this.drawOrder.length;i<n;i++)this.drawOrder[i]=i}};spine.EventData=function(name){this.name=name};spine.EventData.prototype={intValue:0,floatValue:0,stringValue:null};spine.Event=function(data){this.data=data};spine.Event.prototype={intValue:0,floatValue:0,stringValue:null};spine.AttachmentType={region:0,boundingbox:1,mesh:2,skinnedmesh:3};spine.RegionAttachment=function(name){this.name=name;this.offset=[];this.offset.length=8;this.uvs=[];this.uvs.length=8};spine.RegionAttachment.prototype={type:spine.AttachmentType.region,x:0,y:0,rotation:0,scaleX:1,scaleY:1,width:0,height:0,r:1,g:1,b:1,a:1,path:null,rendererObject:null,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,setUVs:function(u,v,u2,v2,rotate){var uvs=this.uvs;if(rotate){uvs[2]=u;uvs[3]=v2;uvs[4]=u;uvs[5]=v;uvs[6]=u2;uvs[7]=v;uvs[0]=u2;uvs[1]=v2}else{uvs[0]=u;uvs[1]=v2;uvs[2]=u;uvs[3]=v;uvs[4]=u2;uvs[5]=v;uvs[6]=u2;uvs[7]=v2}},updateOffset:function(){var regionScaleX=this.width/this.regionOriginalWidth*this.scaleX;var regionScaleY=this.height/this.regionOriginalHeight*this.scaleY;var localX=-this.width/2*this.scaleX+this.regionOffsetX*regionScaleX;var localY=-this.height/2*this.scaleY+this.regionOffsetY*regionScaleY;var localX2=localX+this.regionWidth*regionScaleX;var localY2=localY+this.regionHeight*regionScaleY;var radians=this.rotation*spine.degRad;var cos=Math.cos(radians);var sin=Math.sin(radians);var localXCos=localX*cos+this.x;var localXSin=localX*sin;var localYCos=localY*cos+this.y;var localYSin=localY*sin;var localX2Cos=localX2*cos+this.x;var localX2Sin=localX2*sin;var localY2Cos=localY2*cos+this.y;var localY2Sin=localY2*sin;var offset=this.offset;offset[0]=localXCos-localYSin;offset[1]=localYCos+localXSin;offset[2]=localXCos-localY2Sin;offset[3]=localY2Cos+localXSin;offset[4]=localX2Cos-localY2Sin;offset[5]=localY2Cos+localX2Sin;offset[6]=localX2Cos-localYSin;offset[7]=localYCos+localX2Sin},computeVertices:function(x,y,bone,vertices){x+=bone.worldX;y+=bone.worldY;var m00=bone.m00,m01=bone.m01,m10=bone.m10,m11=bone.m11;var offset=this.offset;vertices[0]=offset[0]*m00+offset[1]*m01+x;vertices[1]=offset[0]*m10+offset[1]*m11+y;vertices[2]=offset[2]*m00+offset[3]*m01+x;vertices[3]=offset[2]*m10+offset[3]*m11+y;vertices[4]=offset[4]*m00+offset[5]*m01+x;vertices[5]=offset[4]*m10+offset[5]*m11+y;vertices[6]=offset[6]*m00+offset[7]*m01+x;vertices[7]=offset[6]*m10+offset[7]*m11+y}};spine.MeshAttachment=function(name){this.name=name};spine.MeshAttachment.prototype={type:spine.AttachmentType.mesh,vertices:null,uvs:null,regionUVs:null,triangles:null,hullLength:0,r:1,g:1,b:1,a:1,path:null,rendererObject:null,regionU:0,regionV:0,regionU2:0,regionV2:0,regionRotate:false,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,edges:null,width:0,height:0,updateUVs:function(){var width=this.regionU2-this.regionU,height=this.regionV2-this.regionV;var n=this.regionUVs.length;if(!this.uvs||this.uvs.length!=n){this.uvs=new spine.Float32Array(n)}if(this.regionRotate){for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i+1]*width;this.uvs[i+1]=this.regionV+height-this.regionUVs[i]*height}}else{for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i]*width;this.uvs[i+1]=this.regionV+this.regionUVs[i+1]*height}}},computeWorldVertices:function(x,y,slot,worldVertices){var bone=slot.bone;x+=bone.worldX;y+=bone.worldY;var m00=bone.m00,m01=bone.m01,m10=bone.m10,m11=bone.m11;var vertices=this.vertices;var verticesCount=vertices.length;if(slot.attachmentVertices.length==verticesCount)vertices=slot.attachmentVertices;for(var i=0;i<verticesCount;i+=2){var vx=vertices[i];var vy=vertices[i+1];worldVertices[i]=vx*m00+vy*m01+x;worldVertices[i+1]=vx*m10+vy*m11+y}}};spine.SkinnedMeshAttachment=function(name){this.name=name};spine.SkinnedMeshAttachment.prototype={type:spine.AttachmentType.skinnedmesh,bones:null,weights:null,uvs:null,regionUVs:null,triangles:null,hullLength:0,r:1,g:1,b:1,a:1,path:null,rendererObject:null,regionU:0,regionV:0,regionU2:0,regionV2:0,regionRotate:false,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,edges:null,width:0,height:0,updateUVs:function(u,v,u2,v2,rotate){var width=this.regionU2-this.regionU,height=this.regionV2-this.regionV;var n=this.regionUVs.length;if(!this.uvs||this.uvs.length!=n){this.uvs=new spine.Float32Array(n)}if(this.regionRotate){for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i+1]*width;this.uvs[i+1]=this.regionV+height-this.regionUVs[i]*height}}else{for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i]*width;this.uvs[i+1]=this.regionV+this.regionUVs[i+1]*height}}},computeWorldVertices:function(x,y,slot,worldVertices){var skeletonBones=slot.bone.skeleton.bones;var weights=this.weights;var bones=this.bones;var w=0,v=0,b=0,f=0,n=bones.length,nn;var wx,wy,bone,vx,vy,weight;if(!slot.attachmentVertices.length){for(;v<n;w+=2){wx=0;wy=0;nn=bones[v++]+v;for(;v<nn;v++,b+=3){bone=skeletonBones[bones[v]];vx=weights[b];vy=weights[b+1];weight=weights[b+2];wx+=(vx*bone.m00+vy*bone.m01+bone.worldX)*weight;wy+=(vx*bone.m10+vy*bone.m11+bone.worldY)*weight}worldVertices[w]=wx+x;worldVertices[w+1]=wy+y}}else{var ffd=slot.attachmentVertices;for(;v<n;w+=2){wx=0;wy=0;nn=bones[v++]+v;for(;v<nn;v++,b+=3,f+=2){bone=skeletonBones[bones[v]];vx=weights[b]+ffd[f];vy=weights[b+1]+ffd[f+1];weight=weights[b+2];wx+=(vx*bone.m00+vy*bone.m01+bone.worldX)*weight;wy+=(vx*bone.m10+vy*bone.m11+bone.worldY)*weight}worldVertices[w]=wx+x;worldVertices[w+1]=wy+y}}}};spine.BoundingBoxAttachment=function(name){this.name=name;this.vertices=[]};spine.BoundingBoxAttachment.prototype={type:spine.AttachmentType.boundingbox,computeWorldVertices:function(x,y,bone,worldVertices){x+=bone.worldX;y+=bone.worldY;var m00=bone.m00,m01=bone.m01,m10=bone.m10,m11=bone.m11;var vertices=this.vertices;for(var i=0,n=vertices.length;i<n;i+=2){var px=vertices[i];var py=vertices[i+1];worldVertices[i]=px*m00+py*m01+x;worldVertices[i+1]=px*m10+py*m11+y}}};spine.AnimationStateData=function(skeletonData){this.skeletonData=skeletonData;this.animationToMixTime={}};spine.AnimationStateData.prototype={defaultMix:0,setMixByName:function(fromName,toName,duration){var from=this.skeletonData.findAnimation(fromName);if(!from)throw"Animation not found: "+fromName;var to=this.skeletonData.findAnimation(toName);if(!to)throw"Animation not found: "+toName;this.setMix(from,to,duration)},setMix:function(from,to,duration){this.animationToMixTime[from.name+":"+to.name]=duration},getMix:function(from,to){var key=from.name+":"+to.name;return this.animationToMixTime.hasOwnProperty(key)?this.animationToMixTime[key]:this.defaultMix}};spine.TrackEntry=function(){};spine.TrackEntry.prototype={next:null,previous:null,animation:null,loop:false,delay:0,time:0,lastTime:-1,endTime:0,timeScale:1,mixTime:0,mixDuration:0,mix:1,onStart:null,onEnd:null,onComplete:null,onEvent:null};spine.AnimationState=function(stateData){this.data=stateData;this.tracks=[];this.events=[]};spine.AnimationState.prototype={onStart:null,onEnd:null,onComplete:null,onEvent:null,timeScale:1,update:function(delta){delta*=this.timeScale;for(var i=0;i<this.tracks.length;i++){var current=this.tracks[i];if(!current)continue;current.time+=delta*current.timeScale;if(current.previous){var previousDelta=delta*current.previous.timeScale;current.previous.time+=previousDelta;current.mixTime+=previousDelta}var next=current.next;if(next){next.time=current.lastTime-next.delay;if(next.time>=0)this.setCurrent(i,next)}else{if(!current.loop&&current.lastTime>=current.endTime)this.clearTrack(i)}}},apply:function(skeleton){skeleton.resetDrawOrder();for(var i=0;i<this.tracks.length;i++){var current=this.tracks[i];if(!current)continue;this.events.length=0;var time=current.time;var lastTime=current.lastTime;var endTime=current.endTime;var loop=current.loop;if(!loop&&time>endTime)time=endTime;var previous=current.previous;if(!previous){if(current.mix==1)current.animation.apply(skeleton,current.lastTime,time,loop,this.events);else current.animation.mix(skeleton,current.lastTime,time,loop,this.events,current.mix)}else{var previousTime=previous.time;if(!previous.loop&&previousTime>previous.endTime)previousTime=previous.endTime;previous.animation.apply(skeleton,previousTime,previousTime,previous.loop,null);var alpha=current.mixTime/current.mixDuration*current.mix;if(alpha>=1){alpha=1;current.previous=null}current.animation.mix(skeleton,current.lastTime,time,loop,this.events,alpha)}for(var ii=0,nn=this.events.length;ii<nn;ii++){var event=this.events[ii];if(current.onEvent)current.onEvent(i,event);if(this.onEvent)this.onEvent(i,event)}if(loop?lastTime%endTime>time%endTime:lastTime<endTime&&time>=endTime){var count=Math.floor(time/endTime);if(current.onComplete)current.onComplete(i,count);if(this.onComplete)this.onComplete(i,count)}current.lastTime=current.time}},clearTracks:function(){for(var i=0,n=this.tracks.length;i<n;i++)this.clearTrack(i);this.tracks.length=0},clearTrack:function(trackIndex){if(trackIndex>=this.tracks.length)return;var current=this.tracks[trackIndex];if(!current)return;if(current.onEnd)current.onEnd(trackIndex);if(this.onEnd)this.onEnd(trackIndex);this.tracks[trackIndex]=null},_expandToIndex:function(index){if(index<this.tracks.length)return this.tracks[index];while(index>=this.tracks.length)this.tracks.push(null);return null},setCurrent:function(index,entry){var current=this._expandToIndex(index);if(current){var previous=current.previous;current.previous=null;if(current.onEnd)current.onEnd(index);if(this.onEnd)this.onEnd(index);entry.mixDuration=this.data.getMix(current.animation,entry.animation);if(entry.mixDuration>0){entry.mixTime=0;if(previous&&current.mixTime/current.mixDuration<.5)entry.previous=previous;else entry.previous=current}}this.tracks[index]=entry;if(entry.onStart)entry.onStart(index);if(this.onStart)this.onStart(index)},setAnimationByName:function(trackIndex,animationName,loop){var animation=this.data.skeletonData.findAnimation(animationName);if(!animation)throw"Animation not found: "+animationName;return this.setAnimation(trackIndex,animation,loop)},setAnimation:function(trackIndex,animation,loop){var entry=new spine.TrackEntry;entry.animation=animation;entry.loop=loop;entry.endTime=animation.duration;this.setCurrent(trackIndex,entry);return entry},addAnimationByName:function(trackIndex,animationName,loop,delay){var animation=this.data.skeletonData.findAnimation(animationName);if(!animation)throw"Animation not found: "+animationName;return this.addAnimation(trackIndex,animation,loop,delay)},addAnimation:function(trackIndex,animation,loop,delay){var entry=new spine.TrackEntry;entry.animation=animation;entry.loop=loop;entry.endTime=animation.duration;var last=this._expandToIndex(trackIndex);if(last){while(last.next)last=last.next;last.next=entry}else this.tracks[trackIndex]=entry;if(delay<=0){if(last)delay+=last.endTime-this.data.getMix(last.animation,animation);else delay=0}entry.delay=delay;return entry},getCurrent:function(trackIndex){if(trackIndex>=this.tracks.length)return null;return this.tracks[trackIndex]}};spine.SkeletonJson=function(attachmentLoader){this.attachmentLoader=attachmentLoader};spine.SkeletonJson.prototype={scale:1,readSkeletonData:function(root,name){var skeletonData=new spine.SkeletonData;skeletonData.name=name;var skeletonMap=root["skeleton"];if(skeletonMap){skeletonData.hash=skeletonMap["hash"];skeletonData.version=skeletonMap["spine"];skeletonData.width=skeletonMap["width"]||0;skeletonData.height=skeletonMap["height"]||0}var bones=root["bones"];for(var i=0,n=bones.length;i<n;i++){var boneMap=bones[i];var parent=null;if(boneMap["parent"]){parent=skeletonData.findBone(boneMap["parent"]);if(!parent)throw"Parent bone not found: "+boneMap["parent"]}var boneData=new spine.BoneData(boneMap["name"],parent);boneData.length=(boneMap["length"]||0)*this.scale;boneData.x=(boneMap["x"]||0)*this.scale;boneData.y=(boneMap["y"]||0)*this.scale;boneData.rotation=boneMap["rotation"]||0;boneData.scaleX=boneMap.hasOwnProperty("scaleX")?boneMap["scaleX"]:1;boneData.scaleY=boneMap.hasOwnProperty("scaleY")?boneMap["scaleY"]:1;boneData.inheritScale=boneMap.hasOwnProperty("inheritScale")?boneMap["inheritScale"]:true;boneData.inheritRotation=boneMap.hasOwnProperty("inheritRotation")?boneMap["inheritRotation"]:true;skeletonData.bones.push(boneData)}var ik=root["ik"];if(ik){for(var i=0,n=ik.length;i<n;i++){var ikMap=ik[i];var ikConstraintData=new spine.IkConstraintData(ikMap["name"]);var bones=ikMap["bones"];for(var ii=0,nn=bones.length;ii<nn;ii++){var bone=skeletonData.findBone(bones[ii]);if(!bone)throw"IK bone not found: "+bones[ii];ikConstraintData.bones.push(bone)}ikConstraintData.target=skeletonData.findBone(ikMap["target"]);if(!ikConstraintData.target)throw"Target bone not found: "+ikMap["target"];ikConstraintData.bendDirection=!ikMap.hasOwnProperty("bendPositive")||ikMap["bendPositive"]?1:-1;ikConstraintData.mix=ikMap.hasOwnProperty("mix")?ikMap["mix"]:1;skeletonData.ikConstraints.push(ikConstraintData)}}var slots=root["slots"];for(var i=0,n=slots.length;i<n;i++){var slotMap=slots[i];var boneData=skeletonData.findBone(slotMap["bone"]);if(!boneData)throw"Slot bone not found: "+slotMap["bone"];var slotData=new spine.SlotData(slotMap["name"],boneData);var color=slotMap["color"];if(color){slotData.r=this.toColor(color,0);slotData.g=this.toColor(color,1);slotData.b=this.toColor(color,2);slotData.a=this.toColor(color,3)}slotData.attachmentName=slotMap["attachment"];slotData.additiveBlending=slotMap["additive"]&&slotMap["additive"]=="true";skeletonData.slots.push(slotData)}var skins=root["skins"];for(var skinName in skins){if(!skins.hasOwnProperty(skinName))continue;var skinMap=skins[skinName];var skin=new spine.Skin(skinName);for(var slotName in skinMap){if(!skinMap.hasOwnProperty(slotName))continue;var slotIndex=skeletonData.findSlotIndex(slotName);var slotEntry=skinMap[slotName];for(var attachmentName in slotEntry){if(!slotEntry.hasOwnProperty(attachmentName))continue;var attachment=this.readAttachment(skin,attachmentName,slotEntry[attachmentName]);if(attachment)skin.addAttachment(slotIndex,attachmentName,attachment)}}skeletonData.skins.push(skin);if(skin.name=="default")skeletonData.defaultSkin=skin}var events=root["events"];for(var eventName in events){if(!events.hasOwnProperty(eventName))continue;var eventMap=events[eventName];var eventData=new spine.EventData(eventName);eventData.intValue=eventMap["int"]||0;eventData.floatValue=eventMap["float"]||0;eventData.stringValue=eventMap["string"]||null;skeletonData.events.push(eventData)}var animations=root["animations"];for(var animationName in animations){if(!animations.hasOwnProperty(animationName))continue;this.readAnimation(animationName,animations[animationName],skeletonData)}return skeletonData},readAttachment:function(skin,name,map){name=map["name"]||name;var type=spine.AttachmentType[map["type"]||"region"];var path=map["path"]||name;var scale=this.scale;if(type==spine.AttachmentType.region){var region=this.attachmentLoader.newRegionAttachment(skin,name,path);if(!region)return null;region.path=path;region.x=(map["x"]||0)*scale;region.y=(map["y"]||0)*scale;region.scaleX=map.hasOwnProperty("scaleX")?map["scaleX"]:1;region.scaleY=map.hasOwnProperty("scaleY")?map["scaleY"]:1;region.rotation=map["rotation"]||0;region.width=(map["width"]||0)*scale;region.height=(map["height"]||0)*scale;var color=map["color"];if(color){region.r=this.toColor(color,0);region.g=this.toColor(color,1);region.b=this.toColor(color,2);region.a=this.toColor(color,3)}region.updateOffset();return region}else if(type==spine.AttachmentType.mesh){var mesh=this.attachmentLoader.newMeshAttachment(skin,name,path);if(!mesh)return null;mesh.path=path;mesh.vertices=this.getFloatArray(map,"vertices",scale);mesh.triangles=this.getIntArray(map,"triangles");mesh.regionUVs=this.getFloatArray(map,"uvs",1);mesh.updateUVs();color=map["color"];if(color){mesh.r=this.toColor(color,0);mesh.g=this.toColor(color,1);mesh.b=this.toColor(color,2);mesh.a=this.toColor(color,3)}mesh.hullLength=(map["hull"]||0)*2;if(map["edges"])mesh.edges=this.getIntArray(map,"edges");mesh.width=(map["width"]||0)*scale;mesh.height=(map["height"]||0)*scale;return mesh}else if(type==spine.AttachmentType.skinnedmesh){var mesh=this.attachmentLoader.newSkinnedMeshAttachment(skin,name,path);if(!mesh)return null;mesh.path=path;var uvs=this.getFloatArray(map,"uvs",1);var vertices=this.getFloatArray(map,"vertices",1);var weights=[];var bones=[];for(var i=0,n=vertices.length;i<n;){var boneCount=vertices[i++]|0;bones[bones.length]=boneCount;for(var nn=i+boneCount*4;i<nn;){bones[bones.length]=vertices[i];weights[weights.length]=vertices[i+1]*scale;weights[weights.length]=vertices[i+2]*scale;weights[weights.length]=vertices[i+3];i+=4}}mesh.bones=bones;mesh.weights=weights;mesh.triangles=this.getIntArray(map,"triangles");mesh.regionUVs=uvs;mesh.updateUVs();color=map["color"];if(color){mesh.r=this.toColor(color,0);mesh.g=this.toColor(color,1);mesh.b=this.toColor(color,2);mesh.a=this.toColor(color,3)}mesh.hullLength=(map["hull"]||0)*2;if(map["edges"])mesh.edges=this.getIntArray(map,"edges");mesh.width=(map["width"]||0)*scale;mesh.height=(map["height"]||0)*scale;return mesh}else if(type==spine.AttachmentType.boundingbox){var attachment=this.attachmentLoader.newBoundingBoxAttachment(skin,name);var vertices=map["vertices"];for(var i=0,n=vertices.length;i<n;i++)attachment.vertices.push(vertices[i]*scale);return attachment}throw"Unknown attachment type: "+type},readAnimation:function(name,map,skeletonData){var timelines=[];var duration=0;var slots=map["slots"];for(var slotName in slots){if(!slots.hasOwnProperty(slotName))continue;var slotMap=slots[slotName];var slotIndex=skeletonData.findSlotIndex(slotName);for(var timelineName in slotMap){if(!slotMap.hasOwnProperty(timelineName))continue;var values=slotMap[timelineName];if(timelineName=="color"){var timeline=new spine.ColorTimeline(values.length);timeline.slotIndex=slotIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var color=valueMap["color"];var r=this.toColor(color,0);var g=this.toColor(color,1);var b=this.toColor(color,2);var a=this.toColor(color,3);timeline.setFrame(frameIndex,valueMap["time"],r,g,b,a);this.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*5-5])}else if(timelineName=="attachment"){var timeline=new spine.AttachmentTimeline(values.length);timeline.slotIndex=slotIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];timeline.setFrame(frameIndex++,valueMap["time"],valueMap["name"])}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}else throw"Invalid timeline type for a slot: "+timelineName+" ("+slotName+")"}}var bones=map["bones"];for(var boneName in bones){if(!bones.hasOwnProperty(boneName))continue;var boneIndex=skeletonData.findBoneIndex(boneName);if(boneIndex==-1)throw"Bone not found: "+boneName;var boneMap=bones[boneName];for(var timelineName in boneMap){if(!boneMap.hasOwnProperty(timelineName))continue;var values=boneMap[timelineName];if(timelineName=="rotate"){var timeline=new spine.RotateTimeline(values.length);timeline.boneIndex=boneIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];timeline.setFrame(frameIndex,valueMap["time"],valueMap["angle"]);this.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*2-2])}else if(timelineName=="translate"||timelineName=="scale"){var timeline;var timelineScale=1;if(timelineName=="scale")timeline=new spine.ScaleTimeline(values.length);else{timeline=new spine.TranslateTimeline(values.length);timelineScale=this.scale}timeline.boneIndex=boneIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var x=(valueMap["x"]||0)*timelineScale;var y=(valueMap["y"]||0)*timelineScale;timeline.setFrame(frameIndex,valueMap["time"],x,y);this.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*3-3])}else if(timelineName=="flipX"||timelineName=="flipY"){var x=timelineName=="flipX";var timeline=x?new spine.FlipXTimeline(values.length):new spine.FlipYTimeline(values.length);timeline.boneIndex=boneIndex;var field=x?"x":"y";var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];timeline.setFrame(frameIndex,valueMap["time"],valueMap[field]||false);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*2-2])}else throw"Invalid timeline type for a bone: "+timelineName+" ("+boneName+")"}}var ikMap=map["ik"];for(var ikConstraintName in ikMap){if(!ikMap.hasOwnProperty(ikConstraintName))continue;var ikConstraint=skeletonData.findIkConstraint(ikConstraintName);var values=ikMap[ikConstraintName];var timeline=new spine.IkConstraintTimeline(values.length);timeline.ikConstraintIndex=skeletonData.ikConstraints.indexOf(ikConstraint);var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var mix=valueMap.hasOwnProperty("mix")?valueMap["mix"]:1;var bendDirection=!valueMap.hasOwnProperty("bendPositive")||valueMap["bendPositive"]?1:-1;timeline.setFrame(frameIndex,valueMap["time"],mix,bendDirection);this.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.frameCount*3-3])}var ffd=map["ffd"];for(var skinName in ffd){var skin=skeletonData.findSkin(skinName);var slotMap=ffd[skinName];for(slotName in slotMap){var slotIndex=skeletonData.findSlotIndex(slotName);var meshMap=slotMap[slotName];for(var meshName in meshMap){var values=meshMap[meshName];var timeline=new spine.FfdTimeline(values.length);var attachment=skin.getAttachment(slotIndex,meshName);if(!attachment)throw"FFD attachment not found: "+meshName;timeline.slotIndex=slotIndex;timeline.attachment=attachment;var isMesh=attachment.type==spine.AttachmentType.mesh;var vertexCount;if(isMesh)vertexCount=attachment.vertices.length;else vertexCount=attachment.weights.length/3*2;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var vertices;if(!valueMap["vertices"]){if(isMesh)vertices=attachment.vertices;else{vertices=[];vertices.length=vertexCount}}else{var verticesValue=valueMap["vertices"];var vertices=[];vertices.length=vertexCount;var start=valueMap["offset"]||0;var nn=verticesValue.length;if(this.scale==1){for(var ii=0;ii<nn;ii++)vertices[ii+start]=verticesValue[ii]}else{for(var ii=0;ii<nn;ii++)vertices[ii+start]=verticesValue[ii]*this.scale}if(isMesh){var meshVertices=attachment.vertices;for(var ii=0,nn=vertices.length;ii<nn;ii++)vertices[ii]+=meshVertices[ii]}}timeline.setFrame(frameIndex,valueMap["time"],vertices);this.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines[timelines.length]=timeline;duration=Math.max(duration,timeline.frames[timeline.frameCount-1])}}}var drawOrderValues=map["drawOrder"];if(!drawOrderValues)drawOrderValues=map["draworder"];if(drawOrderValues){var timeline=new spine.DrawOrderTimeline(drawOrderValues.length);var slotCount=skeletonData.slots.length;var frameIndex=0;for(var i=0,n=drawOrderValues.length;i<n;i++){var drawOrderMap=drawOrderValues[i];var drawOrder=null;if(drawOrderMap["offsets"]){drawOrder=[];drawOrder.length=slotCount;for(var ii=slotCount-1;ii>=0;ii--)drawOrder[ii]=-1;var offsets=drawOrderMap["offsets"];var unchanged=[];unchanged.length=slotCount-offsets.length;var originalIndex=0,unchangedIndex=0;for(var ii=0,nn=offsets.length;ii<nn;ii++){var offsetMap=offsets[ii];var slotIndex=skeletonData.findSlotIndex(offsetMap["slot"]);if(slotIndex==-1)throw"Slot not found: "+offsetMap["slot"];while(originalIndex!=slotIndex)unchanged[unchangedIndex++]=originalIndex++;drawOrder[originalIndex+offsetMap["offset"]]=originalIndex++}while(originalIndex<slotCount)unchanged[unchangedIndex++]=originalIndex++;for(var ii=slotCount-1;ii>=0;ii--)if(drawOrder[ii]==-1)drawOrder[ii]=unchanged[--unchangedIndex]}timeline.setFrame(frameIndex++,drawOrderMap["time"],drawOrder)}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}var events=map["events"];if(events){var timeline=new spine.EventTimeline(events.length);var frameIndex=0;for(var i=0,n=events.length;i<n;i++){var eventMap=events[i];var eventData=skeletonData.findEvent(eventMap["name"]);if(!eventData)throw"Event not found: "+eventMap["name"];var event=new spine.Event(eventData);event.intValue=eventMap.hasOwnProperty("int")?eventMap["int"]:eventData.intValue;event.floatValue=eventMap.hasOwnProperty("float")?eventMap["float"]:eventData.floatValue;event.stringValue=eventMap.hasOwnProperty("string")?eventMap["string"]:eventData.stringValue;timeline.setFrame(frameIndex++,eventMap["time"],event)}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}skeletonData.animations.push(new spine.Animation(name,timelines,duration))},readCurve:function(timeline,frameIndex,valueMap){var curve=valueMap["curve"];if(!curve)timeline.curves.setLinear(frameIndex);else if(curve=="stepped")timeline.curves.setStepped(frameIndex);else if(curve instanceof Array)timeline.curves.setCurve(frameIndex,curve[0],curve[1],curve[2],curve[3])},toColor:function(hexString,colorIndex){if(hexString.length!=8)throw"Color hexidecimal length must be 8, recieved: "+hexString;return parseInt(hexString.substring(colorIndex*2,colorIndex*2+2),16)/255},getFloatArray:function(map,name,scale){var list=map[name];var values=new spine.Float32Array(list.length);var i=0,n=list.length;if(scale==1){for(;i<n;i++)values[i]=list[i]}else{for(;i<n;i++)values[i]=list[i]*scale}return values},getIntArray:function(map,name){var list=map[name];var values=new spine.Uint16Array(list.length);for(var i=0,n=list.length;i<n;i++)values[i]=list[i]|0;return values}};spine.Atlas=function(atlasText,textureLoader){this.textureLoader=textureLoader;this.pages=[];this.regions=[];var reader=new spine.AtlasReader(atlasText);var tuple=[];tuple.length=4;var page=null;while(true){var line=reader.readLine();if(line===null)break;line=reader.trim(line);if(!line.length)page=null;else if(!page){page=new spine.AtlasPage;page.name=line;if(reader.readTuple(tuple)==2){page.width=parseInt(tuple[0]);page.height=parseInt(tuple[1]);reader.readTuple(tuple)}page.format=spine.Atlas.Format[tuple[0]];reader.readTuple(tuple);page.minFilter=spine.Atlas.TextureFilter[tuple[0]];page.magFilter=spine.Atlas.TextureFilter[tuple[1]];var direction=reader.readValue();page.uWrap=spine.Atlas.TextureWrap.clampToEdge;page.vWrap=spine.Atlas.TextureWrap.clampToEdge;if(direction=="x")page.uWrap=spine.Atlas.TextureWrap.repeat;else if(direction=="y")page.vWrap=spine.Atlas.TextureWrap.repeat;else if(direction=="xy")page.uWrap=page.vWrap=spine.Atlas.TextureWrap.repeat;textureLoader.load(page,line,this);this.pages.push(page)}else{var region=new spine.AtlasRegion;region.name=line;region.page=page;region.rotate=reader.readValue()=="true";reader.readTuple(tuple);var x=parseInt(tuple[0]);var y=parseInt(tuple[1]);reader.readTuple(tuple);var width=parseInt(tuple[0]);var height=parseInt(tuple[1]);region.u=x/page.width;region.v=y/page.height;if(region.rotate){region.u2=(x+height)/page.width;region.v2=(y+width)/page.height}else{region.u2=(x+width)/page.width;region.v2=(y+height)/page.height}region.x=x;region.y=y;region.width=Math.abs(width);region.height=Math.abs(height);if(reader.readTuple(tuple)==4){region.splits=[parseInt(tuple[0]),parseInt(tuple[1]),parseInt(tuple[2]),parseInt(tuple[3])];if(reader.readTuple(tuple)==4){region.pads=[parseInt(tuple[0]),parseInt(tuple[1]),parseInt(tuple[2]),parseInt(tuple[3])];reader.readTuple(tuple)}}region.originalWidth=parseInt(tuple[0]);region.originalHeight=parseInt(tuple[1]);reader.readTuple(tuple);region.offsetX=parseInt(tuple[0]);region.offsetY=parseInt(tuple[1]);region.index=parseInt(reader.readValue());this.regions.push(region)}}};spine.Atlas.prototype={findRegion:function(name){var regions=this.regions;for(var i=0,n=regions.length;i<n;i++)if(regions[i].name==name)return regions[i];return null},dispose:function(){var pages=this.pages;for(var i=0,n=pages.length;i<n;i++)this.textureLoader.unload(pages[i].rendererObject)},updateUVs:function(page){var regions=this.regions;for(var i=0,n=regions.length;i<n;i++){var region=regions[i];if(region.page!=page)continue;region.u=region.x/page.width;region.v=region.y/page.height;if(region.rotate){region.u2=(region.x+region.height)/page.width;region.v2=(region.y+region.width)/page.height}else{region.u2=(region.x+region.width)/page.width;region.v2=(region.y+region.height)/page.height}}}};spine.Atlas.Format={alpha:0,intensity:1,luminanceAlpha:2,rgb565:3,rgba4444:4,rgb888:5,rgba8888:6};spine.Atlas.TextureFilter={nearest:0,linear:1,mipMap:2,mipMapNearestNearest:3,mipMapLinearNearest:4,mipMapNearestLinear:5,mipMapLinearLinear:6};spine.Atlas.TextureWrap={mirroredRepeat:0,clampToEdge:1,repeat:2};spine.AtlasPage=function(){};spine.AtlasPage.prototype={name:null,format:null,minFilter:null,magFilter:null,uWrap:null,vWrap:null,rendererObject:null,width:0,height:0};spine.AtlasRegion=function(){};spine.AtlasRegion.prototype={page:null,name:null,x:0,y:0,width:0,height:0,u:0,v:0,u2:0,v2:0,offsetX:0,offsetY:0,originalWidth:0,originalHeight:0,index:0,rotate:false,splits:null,pads:null};spine.AtlasReader=function(text){this.lines=text.split(/\r\n|\r|\n/)};spine.AtlasReader.prototype={index:0,trim:function(value){return value.replace(/^\s+|\s+$/g,"")},readLine:function(){if(this.index>=this.lines.length)return null;return this.lines[this.index++]},readValue:function(){var line=this.readLine();var colon=line.indexOf(":");if(colon==-1)throw"Invalid line: "+line;return this.trim(line.substring(colon+1))},readTuple:function(tuple){var line=this.readLine();var colon=line.indexOf(":");if(colon==-1)throw"Invalid line: "+line;var i=0,lastMatch=colon+1;for(;i<3;i++){var comma=line.indexOf(",",lastMatch);if(comma==-1)break;tuple[i]=this.trim(line.substr(lastMatch,comma-lastMatch));lastMatch=comma+1}tuple[i]=this.trim(line.substring(lastMatch));return i+1}};spine.AtlasAttachmentLoader=function(atlas){this.atlas=atlas};spine.AtlasAttachmentLoader.prototype={newRegionAttachment:function(skin,name,path){var region=this.atlas.findRegion(path);if(!region)throw"Region not found in atlas: "+path+" (region attachment: "+name+")";var attachment=new spine.RegionAttachment(name);attachment.rendererObject=region;attachment.setUVs(region.u,region.v,region.u2,region.v2,region.rotate);
attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment},newMeshAttachment:function(skin,name,path){var region=this.atlas.findRegion(path);if(!region)throw"Region not found in atlas: "+path+" (mesh attachment: "+name+")";var attachment=new spine.MeshAttachment(name);attachment.rendererObject=region;attachment.regionU=region.u;attachment.regionV=region.v;attachment.regionU2=region.u2;attachment.regionV2=region.v2;attachment.regionRotate=region.rotate;attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment},newSkinnedMeshAttachment:function(skin,name,path){var region=this.atlas.findRegion(path);if(!region)throw"Region not found in atlas: "+path+" (skinned mesh attachment: "+name+")";var attachment=new spine.SkinnedMeshAttachment(name);attachment.rendererObject=region;attachment.regionU=region.u;attachment.regionV=region.v;attachment.regionU2=region.u2;attachment.regionV2=region.v2;attachment.regionRotate=region.rotate;attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment},newBoundingBoxAttachment:function(skin,name){return new spine.BoundingBoxAttachment(name)}};spine.SkeletonBounds=function(){this.polygonPool=[];this.polygons=[];this.boundingBoxes=[]};spine.SkeletonBounds.prototype={minX:0,minY:0,maxX:0,maxY:0,update:function(skeleton,updateAabb){var slots=skeleton.slots;var slotCount=slots.length;var x=skeleton.x,y=skeleton.y;var boundingBoxes=this.boundingBoxes;var polygonPool=this.polygonPool;var polygons=this.polygons;boundingBoxes.length=0;for(var i=0,n=polygons.length;i<n;i++)polygonPool.push(polygons[i]);polygons.length=0;for(var i=0;i<slotCount;i++){var slot=slots[i];var boundingBox=slot.attachment;if(boundingBox.type!=spine.AttachmentType.boundingbox)continue;boundingBoxes.push(boundingBox);var poolCount=polygonPool.length,polygon;if(poolCount>0){polygon=polygonPool[poolCount-1];polygonPool.splice(poolCount-1,1)}else polygon=[];polygons.push(polygon);polygon.length=boundingBox.vertices.length;boundingBox.computeWorldVertices(x,y,slot.bone,polygon)}if(updateAabb)this.aabbCompute()},aabbCompute:function(){var polygons=this.polygons;var minX=Number.MAX_VALUE,minY=Number.MAX_VALUE,maxX=Number.MIN_VALUE,maxY=Number.MIN_VALUE;for(var i=0,n=polygons.length;i<n;i++){var vertices=polygons[i];for(var ii=0,nn=vertices.length;ii<nn;ii+=2){var x=vertices[ii];var y=vertices[ii+1];minX=Math.min(minX,x);minY=Math.min(minY,y);maxX=Math.max(maxX,x);maxY=Math.max(maxY,y)}}this.minX=minX;this.minY=minY;this.maxX=maxX;this.maxY=maxY},aabbContainsPoint:function(x,y){return x>=this.minX&&x<=this.maxX&&y>=this.minY&&y<=this.maxY},aabbIntersectsSegment:function(x1,y1,x2,y2){var minX=this.minX,minY=this.minY,maxX=this.maxX,maxY=this.maxY;if(x1<=minX&&x2<=minX||y1<=minY&&y2<=minY||x1>=maxX&&x2>=maxX||y1>=maxY&&y2>=maxY)return false;var m=(y2-y1)/(x2-x1);var y=m*(minX-x1)+y1;if(y>minY&&y<maxY)return true;y=m*(maxX-x1)+y1;if(y>minY&&y<maxY)return true;var x=(minY-y1)/m+x1;if(x>minX&&x<maxX)return true;x=(maxY-y1)/m+x1;if(x>minX&&x<maxX)return true;return false},aabbIntersectsSkeleton:function(bounds){return this.minX<bounds.maxX&&this.maxX>bounds.minX&&this.minY<bounds.maxY&&this.maxY>bounds.minY},containsPoint:function(x,y){var polygons=this.polygons;for(var i=0,n=polygons.length;i<n;i++)if(this.polygonContainsPoint(polygons[i],x,y))return this.boundingBoxes[i];return null},intersectsSegment:function(x1,y1,x2,y2){var polygons=this.polygons;for(var i=0,n=polygons.length;i<n;i++)if(polygons[i].intersectsSegment(x1,y1,x2,y2))return this.boundingBoxes[i];return null},polygonContainsPoint:function(polygon,x,y){var nn=polygon.length;var prevIndex=nn-2;var inside=false;for(var ii=0;ii<nn;ii+=2){var vertexY=polygon[ii+1];var prevY=polygon[prevIndex+1];if(vertexY<y&&prevY>=y||prevY<y&&vertexY>=y){var vertexX=polygon[ii];if(vertexX+(y-vertexY)/(prevY-vertexY)*(polygon[prevIndex]-vertexX)<x)inside=!inside}prevIndex=ii}return inside},polygonIntersectsSegment:function(polygon,x1,y1,x2,y2){var nn=polygon.length;var width12=x1-x2,height12=y1-y2;var det1=x1*y2-y1*x2;var x3=polygon[nn-2],y3=polygon[nn-1];for(var ii=0;ii<nn;ii+=2){var x4=polygon[ii],y4=polygon[ii+1];var det2=x3*y4-y3*x4;var width34=x3-x4,height34=y3-y4;var det3=width12*height34-height12*width34;var x=(det1*width34-width12*det2)/det3;if((x>=x3&&x<=x4||x>=x4&&x<=x3)&&(x>=x1&&x<=x2||x>=x2&&x<=x1)){var y=(det1*height34-height12*det2)/det3;if((y>=y3&&y<=y4||y>=y4&&y<=y3)&&(y>=y1&&y<=y2||y>=y2&&y<=y1))return true}x3=x4;y3=y4}return false},getPolygon:function(attachment){var index=this.boundingBoxes.indexOf(attachment);return index==-1?null:this.polygons[index]},getWidth:function(){return this.maxX-this.minX},getHeight:function(){return this.maxY-this.minY}};spine.Bone.yDown=true;PIXI.AnimCache={};PIXI.SpineTextureLoader=function(basePath,crossorigin){PIXI.EventTarget.call(this);this.basePath=basePath;this.crossorigin=crossorigin;this.loadingCount=0};PIXI.SpineTextureLoader.prototype=PIXI.SpineTextureLoader;PIXI.SpineTextureLoader.prototype.load=function(page,file){page.rendererObject=PIXI.BaseTexture.fromImage(this.basePath+"/"+file,this.crossorigin);if(!page.rendererObject.hasLoaded){var scope=this;++scope.loadingCount;page.rendererObject.addEventListener("loaded",function(){--scope.loadingCount;scope.dispatchEvent({type:"loadedBaseTexture",content:scope})})}};PIXI.SpineTextureLoader.prototype.unload=function(texture){texture.destroy(true)};PIXI.Spine=function(url){PIXI.DisplayObjectContainer.call(this);this.spineData=PIXI.AnimCache[url];if(!this.spineData){throw new Error("Spine data must be preloaded using PIXI.SpineLoader or PIXI.AssetLoader: "+url)}this.skeleton=new spine.Skeleton(this.spineData);this.skeleton.updateWorldTransform();this.stateData=new spine.AnimationStateData(this.spineData);this.state=new spine.AnimationState(this.stateData);this.slotContainers=[];for(var i=0,n=this.skeleton.slots.length;i<n;i++){var slot=this.skeleton.slots[i];var attachment=slot.attachment;var slotContainer=new PIXI.DisplayObjectContainer;this.slotContainers.push(slotContainer);this.addChild(slotContainer);if(attachment instanceof spine.RegionAttachment){var spriteName=attachment.rendererObject.name;var sprite=this.createSprite(slot,attachment);slot.currentSprite=sprite;slot.currentSpriteName=spriteName;slotContainer.addChild(sprite)}else if(attachment instanceof spine.MeshAttachment){var mesh=this.createMesh(slot,attachment);slot.currentMesh=mesh;slot.currentMeshName=attachment.name;slotContainer.addChild(mesh)}else{continue}}this.autoUpdate=true};PIXI.Spine.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Spine.prototype.constructor=PIXI.Spine;Object.defineProperty(PIXI.Spine.prototype,"autoUpdate",{get:function(){return this.updateTransform===PIXI.Spine.prototype.autoUpdateTransform},set:function(value){this.updateTransform=value?PIXI.Spine.prototype.autoUpdateTransform:PIXI.DisplayObjectContainer.prototype.updateTransform}});PIXI.Spine.prototype.update=function(dt){this.state.update(dt);this.state.apply(this.skeleton);this.skeleton.updateWorldTransform();var drawOrder=this.skeleton.drawOrder;var slots=this.skeleton.slots;for(var i=0,n=drawOrder.length;i<n;i++)this.children[i]=this.slotContainers[drawOrder[i]];for(i=0,n=slots.length;i<n;i++){var slot=slots[i];var attachment=slot.attachment;var slotContainer=this.slotContainers[i];if(!attachment){slotContainer.visible=false;continue}var type=attachment.type;if(type===spine.AttachmentType.region){if(attachment.rendererObject){if(!slot.currentSpriteName||slot.currentSpriteName!==attachment.name){var spriteName=attachment.rendererObject.name;if(slot.currentSprite!==undefined){slot.currentSprite.visible=false}slot.sprites=slot.sprites||{};if(slot.sprites[spriteName]!==undefined){slot.sprites[spriteName].visible=true}else{var sprite=this.createSprite(slot,attachment);slotContainer.addChild(sprite)}slot.currentSprite=slot.sprites[spriteName];slot.currentSpriteName=spriteName}}var bone=slot.bone;slotContainer.position.x=bone.worldX+attachment.x*bone.m00+attachment.y*bone.m01;slotContainer.position.y=bone.worldY+attachment.x*bone.m10+attachment.y*bone.m11;slotContainer.scale.x=bone.worldScaleX;slotContainer.scale.y=bone.worldScaleY;slotContainer.rotation=-(slot.bone.worldRotation*spine.degRad);slot.currentSprite.tint=PIXI.rgb2hex([slot.r,slot.g,slot.b])}else if(type===spine.AttachmentType.skinnedmesh){if(!slot.currentMeshName||slot.currentMeshName!==attachment.name){var meshName=attachment.name;if(slot.currentMesh!==undefined){slot.currentMesh.visible=false}slot.meshes=slot.meshes||{};if(slot.meshes[meshName]!==undefined){slot.meshes[meshName].visible=true}else{var mesh=this.createMesh(slot,attachment);slotContainer.addChild(mesh)}slot.currentMesh=slot.meshes[meshName];slot.currentMeshName=meshName}attachment.computeWorldVertices(slot.bone.skeleton.x,slot.bone.skeleton.y,slot,slot.currentMesh.vertices)}else{slotContainer.visible=false;continue}slotContainer.visible=true;slotContainer.alpha=slot.a}};PIXI.Spine.prototype.autoUpdateTransform=function(){this.lastTime=this.lastTime||Date.now();var timeDelta=(Date.now()-this.lastTime)*.001;this.lastTime=Date.now();this.update(timeDelta);PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.Spine.prototype.createSprite=function(slot,attachment){var descriptor=attachment.rendererObject;var baseTexture=descriptor.page.rendererObject;var spriteRect=new PIXI.Rectangle(descriptor.x,descriptor.y,descriptor.rotate?descriptor.height:descriptor.width,descriptor.rotate?descriptor.width:descriptor.height);var spriteTexture=new PIXI.Texture(baseTexture,spriteRect);var sprite=new PIXI.Sprite(spriteTexture);var baseRotation=descriptor.rotate?Math.PI*.5:0;sprite.scale.set(descriptor.width/descriptor.originalWidth,descriptor.height/descriptor.originalHeight);sprite.rotation=baseRotation-attachment.rotation*spine.degRad;sprite.anchor.x=sprite.anchor.y=.5;slot.sprites=slot.sprites||{};slot.sprites[descriptor.name]=sprite;return sprite};PIXI.Spine.prototype.createMesh=function(slot,attachment){var descriptor=attachment.rendererObject;var baseTexture=descriptor.page.rendererObject;var texture=new PIXI.Texture(baseTexture);var strip=new PIXI.Strip(texture);strip.drawMode=PIXI.Strip.DrawModes.TRIANGLES;strip.canvasPadding=1.5;strip.vertices=new PIXI.Float32Array(attachment.uvs.length);strip.uvs=attachment.uvs;strip.indices=attachment.triangles;slot.meshes=slot.meshes||{};slot.meshes[attachment.name]=strip;return strip};PIXI.BaseTextureCache={};PIXI.BaseTextureCacheIdGenerator=0;PIXI.BaseTexture=function(source,scaleMode){this.resolution=1;this.width=100;this.height=100;this.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.hasLoaded=false;this.source=source;this._UID=PIXI._UID++;this.premultipliedAlpha=true;this._glTextures=[];this.mipmap=false;this._dirty=[true,true,true,true];if(!source)return;if((this.source.complete||this.source.getContext)&&this.source.width&&this.source.height){this.hasLoaded=true;this.width=this.source.naturalWidth||this.source.width;this.height=this.source.naturalHeight||this.source.height;this.dirty()}else{var scope=this;this.source.onload=function(){scope.hasLoaded=true;scope.width=scope.source.naturalWidth||scope.source.width;scope.height=scope.source.naturalHeight||scope.source.height;scope.dirty();scope.dispatchEvent({type:"loaded",content:scope})};this.source.onerror=function(){scope.dispatchEvent({type:"error",content:scope})}}this.imageUrl=null;this._powerOf2=false};PIXI.BaseTexture.prototype.constructor=PIXI.BaseTexture;PIXI.EventTarget.mixin(PIXI.BaseTexture.prototype);PIXI.BaseTexture.prototype.destroy=function(){if(this.imageUrl){delete PIXI.BaseTextureCache[this.imageUrl];delete PIXI.TextureCache[this.imageUrl];this.imageUrl=null;if(!navigator.isCocoonJS)this.source.src=""}else if(this.source&&this.source._pixiId){delete PIXI.BaseTextureCache[this.source._pixiId]}this.source=null;this.unloadFromGPU()};PIXI.BaseTexture.prototype.updateSourceImage=function(newSrc){this.hasLoaded=false;this.source.src=null;this.source.src=newSrc};PIXI.BaseTexture.prototype.dirty=function(){for(var i=0;i<this._glTextures.length;i++){this._dirty[i]=true}};PIXI.BaseTexture.prototype.unloadFromGPU=function(){this.dirty();for(var i=this._glTextures.length-1;i>=0;i--){var glTexture=this._glTextures[i];var gl=PIXI.glContexts[i];if(gl&&glTexture){gl.deleteTexture(glTexture)}}this._glTextures.length=0;this.dirty()};PIXI.BaseTexture.fromImage=function(imageUrl,crossorigin,scaleMode){var baseTexture=PIXI.BaseTextureCache[imageUrl];if(crossorigin===undefined&&imageUrl.indexOf("data:")===-1)crossorigin=true;if(!baseTexture){var image=new Image;if(crossorigin){image.crossOrigin=""}image.src=imageUrl;baseTexture=new PIXI.BaseTexture(image,scaleMode);baseTexture.imageUrl=imageUrl;PIXI.BaseTextureCache[imageUrl]=baseTexture;if(imageUrl.indexOf(PIXI.RETINA_PREFIX+".")!==-1){baseTexture.resolution=2}}return baseTexture};PIXI.BaseTexture.fromCanvas=function(canvas,scaleMode){if(!canvas._pixiId){canvas._pixiId="canvas_"+PIXI.TextureCacheIdGenerator++}var baseTexture=PIXI.BaseTextureCache[canvas._pixiId];if(!baseTexture){baseTexture=new PIXI.BaseTexture(canvas,scaleMode);PIXI.BaseTextureCache[canvas._pixiId]=baseTexture}return baseTexture};PIXI.TextureCache={};PIXI.FrameCache={};PIXI.TextureCacheIdGenerator=0;PIXI.Texture=function(baseTexture,frame,crop,trim){this.noFrame=false;if(!frame){this.noFrame=true;frame=new PIXI.Rectangle(0,0,1,1)}if(baseTexture instanceof PIXI.Texture){baseTexture=baseTexture.baseTexture}this.baseTexture=baseTexture;this.frame=frame;this.trim=trim;this.valid=false;this.requiresUpdate=false;this._uvs=null;this.width=0;this.height=0;this.crop=crop||new PIXI.Rectangle(0,0,1,1);if(baseTexture.hasLoaded){if(this.noFrame)frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(frame)}else{baseTexture.addEventListener("loaded",this.onBaseTextureLoaded.bind(this))}};PIXI.Texture.prototype.constructor=PIXI.Texture;PIXI.EventTarget.mixin(PIXI.Texture.prototype);PIXI.Texture.prototype.onBaseTextureLoaded=function(){var baseTexture=this.baseTexture;baseTexture.removeEventListener("loaded",this.onLoaded);if(this.noFrame)this.frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(this.frame);this.dispatchEvent({type:"update",content:this})};PIXI.Texture.prototype.destroy=function(destroyBase){if(destroyBase)this.baseTexture.destroy();this.valid=false};PIXI.Texture.prototype.setFrame=function(frame){this.noFrame=false;this.frame=frame;this.width=frame.width;this.height=frame.height;this.crop.x=frame.x;this.crop.y=frame.y;this.crop.width=frame.width;this.crop.height=frame.height;if(!this.trim&&(frame.x+frame.width>this.baseTexture.width||frame.y+frame.height>this.baseTexture.height)){throw new Error("Texture Error: frame does not fit inside the base Texture dimensions "+this)}this.valid=frame&&frame.width&&frame.height&&this.baseTexture.source&&this.baseTexture.hasLoaded;if(this.trim){this.width=this.trim.width;this.height=this.trim.height;this.frame.width=this.trim.width;this.frame.height=this.trim.height}if(this.valid)this._updateUvs()};PIXI.Texture.prototype._updateUvs=function(){if(!this._uvs)this._uvs=new PIXI.TextureUvs;var frame=this.crop;var tw=this.baseTexture.width;var th=this.baseTexture.height;this._uvs.x0=frame.x/tw;this._uvs.y0=frame.y/th;this._uvs.x1=(frame.x+frame.width)/tw;this._uvs.y1=frame.y/th;this._uvs.x2=(frame.x+frame.width)/tw;this._uvs.y2=(frame.y+frame.height)/th;this._uvs.x3=frame.x/tw;this._uvs.y3=(frame.y+frame.height)/th};PIXI.Texture.fromImage=function(imageUrl,crossorigin,scaleMode){var texture=PIXI.TextureCache[imageUrl];if(!texture){texture=new PIXI.Texture(PIXI.BaseTexture.fromImage(imageUrl,crossorigin,scaleMode));PIXI.TextureCache[imageUrl]=texture}return texture};PIXI.Texture.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache ');return texture};PIXI.Texture.fromCanvas=function(canvas,scaleMode){var baseTexture=PIXI.BaseTexture.fromCanvas(canvas,scaleMode);return new PIXI.Texture(baseTexture)};PIXI.Texture.addTextureToCache=function(texture,id){PIXI.TextureCache[id]=texture};PIXI.Texture.removeTextureFromCache=function(id){var texture=PIXI.TextureCache[id];delete PIXI.TextureCache[id];delete PIXI.BaseTextureCache[id];return texture};PIXI.TextureUvs=function(){this.x0=0;this.y0=0;this.x1=0;this.y1=0;this.x2=0;this.y2=0;this.x3=0;this.y3=0};PIXI.Texture.emptyTexture=new PIXI.Texture(new PIXI.BaseTexture);PIXI.RenderTexture=function(width,height,renderer,scaleMode,resolution){this.width=width||100;this.height=height||100;this.resolution=resolution||1;this.frame=new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution);this.crop=new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution);this.baseTexture=new PIXI.BaseTexture;this.baseTexture.width=this.width*this.resolution;this.baseTexture.height=this.height*this.resolution;this.baseTexture._glTextures=[];this.baseTexture.resolution=this.resolution;this.baseTexture.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.baseTexture.hasLoaded=true;PIXI.Texture.call(this,this.baseTexture,new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution));this.renderer=renderer||PIXI.defaultRenderer;if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;this.baseTexture._dirty[gl.id]=false;this.textureBuffer=new PIXI.FilterTexture(gl,this.width,this.height,this.baseTexture.scaleMode);this.baseTexture._glTextures[gl.id]=this.textureBuffer.texture;this.render=this.renderWebGL;this.projection=new PIXI.Point(this.width*.5,-this.height*.5)}else{this.render=this.renderCanvas;this.textureBuffer=new PIXI.CanvasBuffer(this.width*this.resolution,this.height*this.resolution);this.baseTexture.source=this.textureBuffer.canvas}this.valid=true;this._updateUvs()};PIXI.RenderTexture.prototype=Object.create(PIXI.Texture.prototype);PIXI.RenderTexture.prototype.constructor=PIXI.RenderTexture;PIXI.RenderTexture.prototype.resize=function(width,height,updateBase){if(width===this.width&&height===this.height)return;this.valid=width>0&&height>0;this.width=width;this.height=height;this.frame.width=this.crop.width=width*this.resolution;this.frame.height=this.crop.height=height*this.resolution;if(updateBase){this.baseTexture.width=this.width*this.resolution;this.baseTexture.height=this.height*this.resolution}if(this.renderer.type===PIXI.WEBGL_RENDERER){this.projection.x=this.width/2;this.projection.y=-this.height/2}if(!this.valid)return;this.textureBuffer.resize(this.width,this.height)};PIXI.RenderTexture.prototype.clear=function(){if(!this.valid)return;if(this.renderer.type===PIXI.WEBGL_RENDERER){this.renderer.gl.bindFramebuffer(this.renderer.gl.FRAMEBUFFER,this.textureBuffer.frameBuffer)}this.textureBuffer.clear()};PIXI.RenderTexture.prototype.renderWebGL=function(displayObject,matrix,clear){if(!this.valid)return;var wt=displayObject.worldTransform;wt.identity();wt.translate(0,this.projection.y*2);if(matrix)wt.append(matrix);wt.scale(1,-1);displayObject.worldAlpha=1;var children=displayObject.children;for(var i=0,j=children.length;i<j;i++){children[i].updateTransform()}var gl=this.renderer.gl;gl.viewport(0,0,this.width*this.resolution,this.height*this.resolution);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);if(clear)this.textureBuffer.clear();this.renderer.spriteBatch.dirty=true;this.renderer.renderDisplayObject(displayObject,this.projection,this.textureBuffer.frameBuffer);this.renderer.spriteBatch.dirty=true};PIXI.RenderTexture.prototype.renderCanvas=function(displayObject,matrix,clear){if(!this.valid)return;var wt=displayObject.worldTransform;wt.identity();if(matrix)wt.append(matrix);displayObject.worldAlpha=1;var children=displayObject.children;for(var i=0,j=children.length;i<j;i++){children[i].updateTransform()}if(clear)this.textureBuffer.clear();var context=this.textureBuffer.context;var realResolution=this.renderer.resolution;this.renderer.resolution=this.resolution;this.renderer.renderDisplayObject(displayObject,context);this.renderer.resolution=realResolution};PIXI.RenderTexture.prototype.getImage=function(){var image=new Image;image.src=this.getBase64();return image};PIXI.RenderTexture.prototype.getBase64=function(){return this.getCanvas().toDataURL()};PIXI.RenderTexture.prototype.getCanvas=function(){if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;var width=this.textureBuffer.width;var height=this.textureBuffer.height;var webGLPixels=new Uint8Array(4*width*height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);gl.readPixels(0,0,width,height,gl.RGBA,gl.UNSIGNED_BYTE,webGLPixels);gl.bindFramebuffer(gl.FRAMEBUFFER,null);var tempCanvas=new PIXI.CanvasBuffer(width,height);var canvasData=tempCanvas.context.getImageData(0,0,width,height);canvasData.data.set(webGLPixels);tempCanvas.context.putImageData(canvasData,0,0);return tempCanvas.canvas}else{return this.textureBuffer.canvas}};PIXI.RenderTexture.tempMatrix=new PIXI.Matrix;PIXI.VideoTexture=function(source,scaleMode){if(!source){throw new Error("No video source element specified.")}if((source.readyState===source.HAVE_ENOUGH_DATA||source.readyState===source.HAVE_FUTURE_DATA)&&source.width&&source.height){source.complete=true}PIXI.BaseTexture.call(this,source,scaleMode);this.autoUpdate=false;this.updateBound=this._onUpdate.bind(this);if(!source.complete){this._onCanPlay=this.onCanPlay.bind(this);source.addEventListener("canplay",this._onCanPlay);source.addEventListener("canplaythrough",this._onCanPlay);source.addEventListener("play",this.onPlayStart.bind(this));source.addEventListener("pause",this.onPlayStop.bind(this))}};PIXI.VideoTexture.prototype=Object.create(PIXI.BaseTexture.prototype);PIXI.VideoTexture.constructor=PIXI.VideoTexture;PIXI.VideoTexture.prototype._onUpdate=function(){if(this.autoUpdate){window.requestAnimationFrame(this.updateBound);this.dirty()}};PIXI.VideoTexture.prototype.onPlayStart=function(){if(!this.autoUpdate){window.requestAnimationFrame(this.updateBound);this.autoUpdate=true}};PIXI.VideoTexture.prototype.onPlayStop=function(){this.autoUpdate=false};PIXI.VideoTexture.prototype.onCanPlay=function(){if(event.type==="canplaythrough"){this.hasLoaded=true;if(this.source){this.source.removeEventListener("canplay",this._onCanPlay);this.source.removeEventListener("canplaythrough",this._onCanPlay);this.width=this.source.videoWidth;this.height=this.source.videoHeight;if(!this.__loaded){this.__loaded=true;this.dispatchEvent({type:"loaded",content:this})}}}};PIXI.VideoTexture.prototype.destroy=function(){if(this.source&&this.source._pixiId){PIXI.BaseTextureCache[this.source._pixiId]=null;delete PIXI.BaseTextureCache[this.source._pixiId];this.source._pixiId=null;delete this.source._pixiId}PIXI.BaseTexture.prototype.destroy.call(this)};PIXI.VideoTexture.baseTextureFromVideo=function(video,scaleMode){if(!video._pixiId){video._pixiId="video_"+PIXI.TextureCacheIdGenerator++}var baseTexture=PIXI.BaseTextureCache[video._pixiId];if(!baseTexture){baseTexture=new PIXI.VideoTexture(video,scaleMode);PIXI.BaseTextureCache[video._pixiId]=baseTexture}return baseTexture};PIXI.VideoTexture.textureFromVideo=function(video,scaleMode){var baseTexture=PIXI.VideoTexture.baseTextureFromVideo(video,scaleMode);return new PIXI.Texture(baseTexture)};PIXI.VideoTexture.fromUrl=function(videoSrc,scaleMode){var video=document.createElement("video");video.src=videoSrc;video.autoPlay=true;video.play();return PIXI.VideoTexture.textureFromVideo(video,scaleMode)};PIXI.AssetLoader=function(assetURLs,crossorigin){this.assetURLs=assetURLs;this.crossorigin=crossorigin;this.loadersByType={jpg:PIXI.ImageLoader,jpeg:PIXI.ImageLoader,png:PIXI.ImageLoader,gif:PIXI.ImageLoader,webp:PIXI.ImageLoader,json:PIXI.JsonLoader,atlas:PIXI.AtlasLoader,anim:PIXI.SpineLoader,xml:PIXI.BitmapFontLoader,fnt:PIXI.BitmapFontLoader}};PIXI.EventTarget.mixin(PIXI.AssetLoader.prototype);PIXI.AssetLoader.prototype.constructor=PIXI.AssetLoader;PIXI.AssetLoader.prototype._getDataType=function(str){var test="data:";var start=str.slice(0,test.length).toLowerCase();if(start===test){var data=str.slice(test.length);var sepIdx=data.indexOf(",");if(sepIdx===-1)return null;var info=data.slice(0,sepIdx).split(";")[0];if(!info||info.toLowerCase()==="text/plain")return"txt";return info.split("/").pop().toLowerCase()}return null};PIXI.AssetLoader.prototype.load=function(){var scope=this;function onLoad(evt){scope.onAssetLoaded(evt.data.content)}this.loadCount=this.assetURLs.length;for(var i=0;i<this.assetURLs.length;i++){var fileName=this.assetURLs[i];var fileType=this._getDataType(fileName);if(!fileType)fileType=fileName.split("?").shift().split(".").pop().toLowerCase();var Constructor=this.loadersByType[fileType];if(!Constructor)throw new Error(fileType+" is an unsupported file type");var loader=new Constructor(fileName,this.crossorigin);loader.on("loaded",onLoad);loader.load()}};PIXI.AssetLoader.prototype.onAssetLoaded=function(loader){this.loadCount--;this.emit("onProgress",{content:this,loader:loader,loaded:this.assetURLs.length-this.loadCount,total:this.assetURLs.length});if(this.onProgress)this.onProgress(loader);if(!this.loadCount){this.emit("onComplete",{content:this});if(this.onComplete)this.onComplete()}};PIXI.JsonLoader=function(url,crossorigin){this.url=url;this.crossorigin=crossorigin;this.baseUrl=url.replace(/[^\/]*$/,"");this.loaded=false};PIXI.JsonLoader.prototype.constructor=PIXI.JsonLoader;PIXI.EventTarget.mixin(PIXI.JsonLoader.prototype);PIXI.JsonLoader.prototype.load=function(){if(window.XDomainRequest&&this.crossorigin){this.ajaxRequest=new window.XDomainRequest;this.ajaxRequest.timeout=3e3;this.ajaxRequest.onerror=this.onError.bind(this);this.ajaxRequest.ontimeout=this.onError.bind(this);this.ajaxRequest.onprogress=function(){};this.ajaxRequest.onload=this.onJSONLoaded.bind(this)}else{if(window.XMLHttpRequest){this.ajaxRequest=new window.XMLHttpRequest}else{this.ajaxRequest=new window.ActiveXObject("Microsoft.XMLHTTP")}this.ajaxRequest.onreadystatechange=this.onReadyStateChanged.bind(this)}this.ajaxRequest.open("GET",this.url,true);this.ajaxRequest.send()};PIXI.JsonLoader.prototype.onReadyStateChanged=function(){if(this.ajaxRequest.readyState===4&&(this.ajaxRequest.status===200||window.location.href.indexOf("http")===-1)){this.onJSONLoaded()}};PIXI.JsonLoader.prototype.onJSONLoaded=function(){if(!this.ajaxRequest.responseText){this.onError();return}this.json=JSON.parse(this.ajaxRequest.responseText);if(this.json.frames&&this.json.meta&&this.json.meta.image){var textureUrl=this.json.meta.image;if(textureUrl.indexOf("data:")===-1){textureUrl=this.baseUrl+textureUrl}var image=new PIXI.ImageLoader(textureUrl,this.crossorigin);var frameData=this.json.frames;this.texture=image.texture.baseTexture;image.addEventListener("loaded",this.onLoaded.bind(this));for(var i in frameData){var rect=frameData[i].frame;if(rect){var textureSize=new PIXI.Rectangle(rect.x,rect.y,rect.w,rect.h);var crop=textureSize.clone();var trim=null;if(frameData[i].trimmed){var actualSize=frameData[i].sourceSize;var realSize=frameData[i].spriteSourceSize;trim=new PIXI.Rectangle(realSize.x,realSize.y,actualSize.w,actualSize.h)}PIXI.TextureCache[i]=new PIXI.Texture(this.texture,textureSize,crop,trim)}}image.load()}else if(this.json.bones){if(PIXI.AnimCache[this.url]){this.onLoaded()}else{var atlasPath=this.url.substr(0,this.url.lastIndexOf("."))+".atlas";var atlasLoader=new PIXI.JsonLoader(atlasPath,this.crossorigin);var originalLoader=this;atlasLoader.onJSONLoaded=function(){if(!this.ajaxRequest.responseText){this.onError();return}var textureLoader=new PIXI.SpineTextureLoader(this.url.substring(0,this.url.lastIndexOf("/")));var spineAtlas=new spine.Atlas(this.ajaxRequest.responseText,textureLoader);var attachmentLoader=new spine.AtlasAttachmentLoader(spineAtlas);var spineJsonParser=new spine.SkeletonJson(attachmentLoader);var skeletonData=spineJsonParser.readSkeletonData(originalLoader.json);PIXI.AnimCache[originalLoader.url]=skeletonData;originalLoader.spine=skeletonData;originalLoader.spineAtlas=spineAtlas;originalLoader.spineAtlasLoader=atlasLoader;if(textureLoader.loadingCount>0){textureLoader.addEventListener("loadedBaseTexture",function(evt){if(evt.content.content.loadingCount<=0){originalLoader.onLoaded()}})}else{originalLoader.onLoaded()}};atlasLoader.load()}}else{this.onLoaded()}};PIXI.JsonLoader.prototype.onLoaded=function(){this.loaded=true;this.dispatchEvent({type:"loaded",content:this})};PIXI.JsonLoader.prototype.onError=function(){this.dispatchEvent({type:"error",content:this})};PIXI.AtlasLoader=function(url,crossorigin){this.url=url;this.baseUrl=url.replace(/[^\/]*$/,"");this.crossorigin=crossorigin;this.loaded=false};PIXI.AtlasLoader.constructor=PIXI.AtlasLoader;PIXI.EventTarget.mixin(PIXI.AtlasLoader.prototype);PIXI.AtlasLoader.prototype.load=function(){this.ajaxRequest=new PIXI.AjaxRequest;this.ajaxRequest.onreadystatechange=this.onAtlasLoaded.bind(this);this.ajaxRequest.open("GET",this.url,true);if(this.ajaxRequest.overrideMimeType)this.ajaxRequest.overrideMimeType("application/json");this.ajaxRequest.send(null)};PIXI.AtlasLoader.prototype.onAtlasLoaded=function(){if(this.ajaxRequest.readyState===4){if(this.ajaxRequest.status===200||window.location.href.indexOf("http")===-1){this.atlas={meta:{image:[]},frames:[]};var result=this.ajaxRequest.responseText.split(/\r?\n/);var lineCount=-3;var currentImageId=0;var currentFrame=null;var nameInNextLine=false;var i=0,j=0,selfOnLoaded=this.onLoaded.bind(this);for(i=0;i<result.length;i++){result[i]=result[i].replace(/^\s+|\s+$/g,"");if(result[i]===""){nameInNextLine=i+1}if(result[i].length>0){if(nameInNextLine===i){this.atlas.meta.image.push(result[i]);currentImageId=this.atlas.meta.image.length-1;this.atlas.frames.push({});lineCount=-3}else if(lineCount>0){if(lineCount%7===1){if(currentFrame!=null){this.atlas.frames[currentImageId][currentFrame.name]=currentFrame}currentFrame={name:result[i],frame:{}}}else{var text=result[i].split(" ");if(lineCount%7===3){currentFrame.frame.x=Number(text[1].replace(",",""));currentFrame.frame.y=Number(text[2])}else if(lineCount%7===4){currentFrame.frame.w=Number(text[1].replace(",",""));currentFrame.frame.h=Number(text[2])}else if(lineCount%7===5){var realSize={x:0,y:0,w:Number(text[1].replace(",","")),h:Number(text[2])};if(realSize.w>currentFrame.frame.w||realSize.h>currentFrame.frame.h){currentFrame.trimmed=true;currentFrame.realSize=realSize}else{currentFrame.trimmed=false}}}}lineCount++}}if(currentFrame!=null){this.atlas.frames[currentImageId][currentFrame.name]=currentFrame}if(this.atlas.meta.image.length>0){this.images=[];for(j=0;j<this.atlas.meta.image.length;j++){var textureUrl=this.baseUrl+this.atlas.meta.image[j];var frameData=this.atlas.frames[j];this.images.push(new PIXI.ImageLoader(textureUrl,this.crossorigin));for(i in frameData){var rect=frameData[i].frame;if(rect){PIXI.TextureCache[i]=new PIXI.Texture(this.images[j].texture.baseTexture,{x:rect.x,y:rect.y,width:rect.w,height:rect.h});if(frameData[i].trimmed){PIXI.TextureCache[i].realSize=frameData[i].realSize;PIXI.TextureCache[i].trim.x=0;PIXI.TextureCache[i].trim.y=0}}}}this.currentImageId=0;for(j=0;j<this.images.length;j++){this.images[j].on("loaded",selfOnLoaded)
}this.images[this.currentImageId].load()}else{this.onLoaded()}}else{this.onError()}}};PIXI.AtlasLoader.prototype.onLoaded=function(){if(this.images.length-1>this.currentImageId){this.currentImageId++;this.images[this.currentImageId].load()}else{this.loaded=true;this.emit("loaded",{content:this})}};PIXI.AtlasLoader.prototype.onError=function(){this.emit("error",{content:this})};PIXI.SpriteSheetLoader=function(url,crossorigin){this.url=url;this.crossorigin=crossorigin;this.baseUrl=url.replace(/[^\/]*$/,"");this.texture=null;this.frames={}};PIXI.SpriteSheetLoader.prototype.constructor=PIXI.SpriteSheetLoader;PIXI.EventTarget.mixin(PIXI.SpriteSheetLoader.prototype);PIXI.SpriteSheetLoader.prototype.load=function(){var scope=this;var jsonLoader=new PIXI.JsonLoader(this.url,this.crossorigin);jsonLoader.on("loaded",function(event){scope.json=event.data.content.json;scope.onLoaded()});jsonLoader.load()};PIXI.SpriteSheetLoader.prototype.onLoaded=function(){this.emit("loaded",{content:this})};PIXI.ImageLoader=function(url,crossorigin){this.texture=PIXI.Texture.fromImage(url,crossorigin);this.frames=[]};PIXI.ImageLoader.prototype.constructor=PIXI.ImageLoader;PIXI.EventTarget.mixin(PIXI.ImageLoader.prototype);PIXI.ImageLoader.prototype.load=function(){if(!this.texture.baseTexture.hasLoaded){this.texture.baseTexture.on("loaded",this.onLoaded.bind(this))}else{this.onLoaded()}};PIXI.ImageLoader.prototype.onLoaded=function(){this.emit("loaded",{content:this})};PIXI.ImageLoader.prototype.loadFramedSpriteSheet=function(frameWidth,frameHeight,textureName){this.frames=[];var cols=Math.floor(this.texture.width/frameWidth);var rows=Math.floor(this.texture.height/frameHeight);var i=0;for(var y=0;y<rows;y++){for(var x=0;x<cols;x++,i++){var texture=new PIXI.Texture(this.texture.baseTexture,{x:x*frameWidth,y:y*frameHeight,width:frameWidth,height:frameHeight});this.frames.push(texture);if(textureName)PIXI.TextureCache[textureName+"-"+i]=texture}}this.load()};PIXI.BitmapFontLoader=function(url,crossorigin){this.url=url;this.crossorigin=crossorigin;this.baseUrl=url.replace(/[^\/]*$/,"");this.texture=null};PIXI.BitmapFontLoader.prototype.constructor=PIXI.BitmapFontLoader;PIXI.EventTarget.mixin(PIXI.BitmapFontLoader.prototype);PIXI.BitmapFontLoader.prototype.load=function(){this.ajaxRequest=new PIXI.AjaxRequest;this.ajaxRequest.onreadystatechange=this.onXMLLoaded.bind(this);this.ajaxRequest.open("GET",this.url,true);if(this.ajaxRequest.overrideMimeType)this.ajaxRequest.overrideMimeType("application/xml");this.ajaxRequest.send(null)};PIXI.BitmapFontLoader.prototype.onXMLLoaded=function(){if(this.ajaxRequest.readyState===4){if(this.ajaxRequest.status===200||window.location.protocol.indexOf("http")===-1){var responseXML=this.ajaxRequest.responseXML;if(!responseXML||/MSIE 9/i.test(navigator.userAgent)||navigator.isCocoonJS){if(typeof window.DOMParser==="function"){var domparser=new DOMParser;responseXML=domparser.parseFromString(this.ajaxRequest.responseText,"text/xml")}else{var div=document.createElement("div");div.innerHTML=this.ajaxRequest.responseText;responseXML=div}}var textureUrl=this.baseUrl+responseXML.getElementsByTagName("page")[0].getAttribute("file");var image=new PIXI.ImageLoader(textureUrl,this.crossorigin);this.texture=image.texture.baseTexture;var data={};var info=responseXML.getElementsByTagName("info")[0];var common=responseXML.getElementsByTagName("common")[0];data.font=info.getAttribute("face");data.size=parseInt(info.getAttribute("size"),10);data.lineHeight=parseInt(common.getAttribute("lineHeight"),10);data.chars={};var letters=responseXML.getElementsByTagName("char");for(var i=0;i<letters.length;i++){var charCode=parseInt(letters[i].getAttribute("id"),10);var textureRect=new PIXI.Rectangle(parseInt(letters[i].getAttribute("x"),10),parseInt(letters[i].getAttribute("y"),10),parseInt(letters[i].getAttribute("width"),10),parseInt(letters[i].getAttribute("height"),10));data.chars[charCode]={xOffset:parseInt(letters[i].getAttribute("xoffset"),10),yOffset:parseInt(letters[i].getAttribute("yoffset"),10),xAdvance:parseInt(letters[i].getAttribute("xadvance"),10),kerning:{},texture:PIXI.TextureCache[charCode]=new PIXI.Texture(this.texture,textureRect)}}var kernings=responseXML.getElementsByTagName("kerning");for(i=0;i<kernings.length;i++){var first=parseInt(kernings[i].getAttribute("first"),10);var second=parseInt(kernings[i].getAttribute("second"),10);var amount=parseInt(kernings[i].getAttribute("amount"),10);data.chars[second].kerning[first]=amount}PIXI.BitmapText.fonts[data.font]=data;image.addEventListener("loaded",this.onLoaded.bind(this));image.load()}}};PIXI.BitmapFontLoader.prototype.onLoaded=function(){this.emit("loaded",{content:this})};PIXI.SpineLoader=function(url,crossorigin){this.url=url;this.crossorigin=crossorigin;this.loaded=false};PIXI.SpineLoader.prototype.constructor=PIXI.SpineLoader;PIXI.EventTarget.mixin(PIXI.SpineLoader.prototype);PIXI.SpineLoader.prototype.load=function(){var scope=this;var jsonLoader=new PIXI.JsonLoader(this.url,this.crossorigin);jsonLoader.on("loaded",function(event){scope.json=event.data.content.json;scope.onLoaded()});jsonLoader.load()};PIXI.SpineLoader.prototype.onLoaded=function(){this.loaded=true;this.emit("loaded",{content:this})};PIXI.AbstractFilter=function(fragmentSrc,uniforms){this.passes=[this];this.shaders=[];this.dirty=true;this.padding=0;this.uniforms=uniforms||{};this.fragmentSrc=fragmentSrc||[]};PIXI.AbstractFilter.prototype.constructor=PIXI.AbstractFilter;PIXI.AbstractFilter.prototype.syncUniforms=function(){for(var i=0,j=this.shaders.length;i<j;i++){this.shaders[i].dirty=true}};PIXI.AlphaMaskFilter=function(texture){PIXI.AbstractFilter.call(this);this.passes=[this];texture.baseTexture._powerOf2=true;this.uniforms={mask:{type:"sampler2D",value:texture},mapDimensions:{type:"2f",value:{x:1,y:5112}},dimensions:{type:"4fv",value:[0,0,0,0]}};if(texture.baseTexture.hasLoaded){this.uniforms.mask.value.x=texture.width;this.uniforms.mask.value.y=texture.height}else{this.boundLoadedFunction=this.onTextureLoaded.bind(this);texture.baseTexture.on("loaded",this.boundLoadedFunction)}this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D mask;","uniform sampler2D uSampler;","uniform vec2 offset;","uniform vec4 dimensions;","uniform vec2 mapDimensions;","void main(void) {","   vec2 mapCords = vTextureCoord.xy;","   mapCords += (dimensions.zw + offset)/ dimensions.xy ;","   mapCords.y *= -1.0;","   mapCords.y += 1.0;","   mapCords *= dimensions.xy / mapDimensions;","   vec4 original =  texture2D(uSampler, vTextureCoord);","   float maskAlpha =  texture2D(mask, mapCords).r;","   original *= maskAlpha;","   gl_FragColor =  original;","}"]};PIXI.AlphaMaskFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.AlphaMaskFilter.prototype.constructor=PIXI.AlphaMaskFilter;PIXI.AlphaMaskFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.mask.value.width;this.uniforms.mapDimensions.value.y=this.uniforms.mask.value.height;this.uniforms.mask.value.baseTexture.off("loaded",this.boundLoadedFunction)};Object.defineProperty(PIXI.AlphaMaskFilter.prototype,"map",{get:function(){return this.uniforms.mask.value},set:function(value){this.uniforms.mask.value=value}});PIXI.ColorMatrixFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={matrix:{type:"mat4",value:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float invert;","uniform mat4 matrix;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * matrix;","}"]};PIXI.ColorMatrixFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.ColorMatrixFilter.prototype.constructor=PIXI.ColorMatrixFilter;Object.defineProperty(PIXI.ColorMatrixFilter.prototype,"matrix",{get:function(){return this.uniforms.matrix.value},set:function(value){this.uniforms.matrix.value=value}});PIXI.GrayFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={gray:{type:"1f",value:1}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","uniform float gray;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord);","   gl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.2126*gl_FragColor.r + 0.7152*gl_FragColor.g + 0.0722*gl_FragColor.b), gray);","}"]};PIXI.GrayFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.GrayFilter.prototype.constructor=PIXI.GrayFilter;Object.defineProperty(PIXI.GrayFilter.prototype,"gray",{get:function(){return this.uniforms.gray.value},set:function(value){this.uniforms.gray.value=value}});PIXI.DisplacementFilter=function(texture){PIXI.AbstractFilter.call(this);this.passes=[this];texture.baseTexture._powerOf2=true;this.uniforms={displacementMap:{type:"sampler2D",value:texture},scale:{type:"2f",value:{x:30,y:30}},offset:{type:"2f",value:{x:0,y:0}},mapDimensions:{type:"2f",value:{x:1,y:5112}},dimensions:{type:"4fv",value:[0,0,0,0]}};if(texture.baseTexture.hasLoaded){this.uniforms.mapDimensions.value.x=texture.width;this.uniforms.mapDimensions.value.y=texture.height}else{this.boundLoadedFunction=this.onTextureLoaded.bind(this);texture.baseTexture.on("loaded",this.boundLoadedFunction)}this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D displacementMap;","uniform sampler2D uSampler;","uniform vec2 scale;","uniform vec2 offset;","uniform vec4 dimensions;","uniform vec2 mapDimensions;","void main(void) {","   vec2 mapCords = vTextureCoord.xy;","   mapCords += (dimensions.zw + offset)/ dimensions.xy ;","   mapCords.y *= -1.0;","   mapCords.y += 1.0;","   vec2 matSample = texture2D(displacementMap, mapCords).xy;","   matSample -= 0.5;","   matSample *= scale;","   matSample /= mapDimensions;","   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x + matSample.x, vTextureCoord.y + matSample.y));","   gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb, 1.0);","   vec2 cord = vTextureCoord;","}"]};PIXI.DisplacementFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.DisplacementFilter.prototype.constructor=PIXI.DisplacementFilter;PIXI.DisplacementFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.displacementMap.value.width;this.uniforms.mapDimensions.value.y=this.uniforms.displacementMap.value.height;this.uniforms.displacementMap.value.baseTexture.off("loaded",this.boundLoadedFunction)};Object.defineProperty(PIXI.DisplacementFilter.prototype,"map",{get:function(){return this.uniforms.displacementMap.value},set:function(value){this.uniforms.displacementMap.value=value}});Object.defineProperty(PIXI.DisplacementFilter.prototype,"scale",{get:function(){return this.uniforms.scale.value},set:function(value){this.uniforms.scale.value=value}});Object.defineProperty(PIXI.DisplacementFilter.prototype,"offset",{get:function(){return this.uniforms.offset.value},set:function(value){this.uniforms.offset.value=value}});PIXI.PixelateFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={invert:{type:"1f",value:0},dimensions:{type:"4fv",value:new PIXI.Float32Array([1e4,100,10,10])},pixelSize:{type:"2f",value:{x:10,y:10}}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 testDim;","uniform vec4 dimensions;","uniform vec2 pixelSize;","uniform sampler2D uSampler;","void main(void) {","   vec2 coord = vTextureCoord;","   vec2 size = dimensions.xy/pixelSize;","   vec2 color = floor( ( vTextureCoord * size ) ) / size + pixelSize/dimensions.xy * 0.5;","   gl_FragColor = texture2D(uSampler, color);","}"]};PIXI.PixelateFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.PixelateFilter.prototype.constructor=PIXI.PixelateFilter;Object.defineProperty(PIXI.PixelateFilter.prototype,"size",{get:function(){return this.uniforms.pixelSize.value},set:function(value){this.dirty=true;this.uniforms.pixelSize.value=value}});PIXI.BlurXFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={blur:{type:"1f",value:1/512}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float blur;","uniform sampler2D uSampler;","void main(void) {","   vec4 sum = vec4(0.0);","   sum += texture2D(uSampler, vec2(vTextureCoord.x - 4.0*blur, vTextureCoord.y)) * 0.05;","   sum += texture2D(uSampler, vec2(vTextureCoord.x - 3.0*blur, vTextureCoord.y)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x - 2.0*blur, vTextureCoord.y)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x - blur, vTextureCoord.y)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * 0.16;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + blur, vTextureCoord.y)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + 2.0*blur, vTextureCoord.y)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + 3.0*blur, vTextureCoord.y)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + 4.0*blur, vTextureCoord.y)) * 0.05;","   gl_FragColor = sum;","}"]};PIXI.BlurXFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurXFilter.prototype.constructor=PIXI.BlurXFilter;Object.defineProperty(PIXI.BlurXFilter.prototype,"blur",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.dirty=true;this.uniforms.blur.value=1/7e3*value}});PIXI.BlurYFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={blur:{type:"1f",value:1/512}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float blur;","uniform sampler2D uSampler;","void main(void) {","   vec4 sum = vec4(0.0);","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 4.0*blur)) * 0.05;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 3.0*blur)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 2.0*blur)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - blur)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * 0.16;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + blur)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 2.0*blur)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 3.0*blur)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 4.0*blur)) * 0.05;","   gl_FragColor = sum;","}"]};PIXI.BlurYFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurYFilter.prototype.constructor=PIXI.BlurYFilter;Object.defineProperty(PIXI.BlurYFilter.prototype,"blur",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.uniforms.blur.value=1/7e3*value}});PIXI.BlurFilter=function(){this.blurXFilter=new PIXI.BlurXFilter;this.blurYFilter=new PIXI.BlurYFilter;this.passes=[this.blurXFilter,this.blurYFilter]};PIXI.BlurFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurFilter.prototype.constructor=PIXI.BlurFilter;Object.defineProperty(PIXI.BlurFilter.prototype,"blur",{get:function(){return this.blurXFilter.blur},set:function(value){this.blurXFilter.blur=this.blurYFilter.blur=value}});Object.defineProperty(PIXI.BlurFilter.prototype,"blurX",{get:function(){return this.blurXFilter.blur},set:function(value){this.blurXFilter.blur=value}});Object.defineProperty(PIXI.BlurFilter.prototype,"blurY",{get:function(){return this.blurYFilter.blur},set:function(value){this.blurYFilter.blur=value}});PIXI.InvertFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={invert:{type:"1f",value:1}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float invert;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord);","   gl_FragColor.rgb = mix( (vec3(1)-gl_FragColor.rgb) * gl_FragColor.a, gl_FragColor.rgb, 1.0 - invert);","}"]};PIXI.InvertFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.InvertFilter.prototype.constructor=PIXI.InvertFilter;Object.defineProperty(PIXI.InvertFilter.prototype,"invert",{get:function(){return this.uniforms.invert.value},set:function(value){this.uniforms.invert.value=value}});PIXI.SepiaFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={sepia:{type:"1f",value:1}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float sepia;","uniform sampler2D uSampler;","const mat3 sepiaMatrix = mat3(0.3588, 0.7044, 0.1368, 0.2990, 0.5870, 0.1140, 0.2392, 0.4696, 0.0912);","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord);","   gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * sepiaMatrix, sepia);","}"]};PIXI.SepiaFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.SepiaFilter.prototype.constructor=PIXI.SepiaFilter;Object.defineProperty(PIXI.SepiaFilter.prototype,"sepia",{get:function(){return this.uniforms.sepia.value},set:function(value){this.uniforms.sepia.value=value}});PIXI.TwistFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={radius:{type:"1f",value:.5},angle:{type:"1f",value:5},offset:{type:"2f",value:{x:.5,y:.5}}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec4 dimensions;","uniform sampler2D uSampler;","uniform float radius;","uniform float angle;","uniform vec2 offset;","void main(void) {","   vec2 coord = vTextureCoord - offset;","   float distance = length(coord);","   if (distance < radius) {","       float ratio = (radius - distance) / radius;","       float angleMod = ratio * ratio * angle;","       float s = sin(angleMod);","       float c = cos(angleMod);","       coord = vec2(coord.x * c - coord.y * s, coord.x * s + coord.y * c);","   }","   gl_FragColor = texture2D(uSampler, coord+offset);","}"]};PIXI.TwistFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.TwistFilter.prototype.constructor=PIXI.TwistFilter;Object.defineProperty(PIXI.TwistFilter.prototype,"offset",{get:function(){return this.uniforms.offset.value},set:function(value){this.dirty=true;this.uniforms.offset.value=value}});Object.defineProperty(PIXI.TwistFilter.prototype,"radius",{get:function(){return this.uniforms.radius.value},set:function(value){this.dirty=true;this.uniforms.radius.value=value}});Object.defineProperty(PIXI.TwistFilter.prototype,"angle",{get:function(){return this.uniforms.angle.value},set:function(value){this.dirty=true;this.uniforms.angle.value=value}});PIXI.ColorStepFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={step:{type:"1f",value:5}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","uniform float step;","void main(void) {","   vec4 color = texture2D(uSampler, vTextureCoord);","   color = floor(color * step) / step;","   gl_FragColor = color;","}"]};PIXI.ColorStepFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.ColorStepFilter.prototype.constructor=PIXI.ColorStepFilter;Object.defineProperty(PIXI.ColorStepFilter.prototype,"step",{get:function(){return this.uniforms.step.value},set:function(value){this.uniforms.step.value=value}});PIXI.DotScreenFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={scale:{type:"1f",value:1},angle:{type:"1f",value:5},dimensions:{type:"4fv",value:[0,0,0,0]}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec4 dimensions;","uniform sampler2D uSampler;","uniform float angle;","uniform float scale;","float pattern() {","   float s = sin(angle), c = cos(angle);","   vec2 tex = vTextureCoord * dimensions.xy;","   vec2 point = vec2(","       c * tex.x - s * tex.y,","       s * tex.x + c * tex.y","   ) * scale;","   return (sin(point.x) * sin(point.y)) * 4.0;","}","void main() {","   vec4 color = texture2D(uSampler, vTextureCoord);","   float average = (color.r + color.g + color.b) / 3.0;","   gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);","}"]};PIXI.DotScreenFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.DotScreenFilter.prototype.constructor=PIXI.DotScreenFilter;Object.defineProperty(PIXI.DotScreenFilter.prototype,"scale",{get:function(){return this.uniforms.scale.value},set:function(value){this.dirty=true;this.uniforms.scale.value=value}});Object.defineProperty(PIXI.DotScreenFilter.prototype,"angle",{get:function(){return this.uniforms.angle.value},set:function(value){this.dirty=true;this.uniforms.angle.value=value}});PIXI.CrossHatchFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={blur:{type:"1f",value:1/512}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float blur;","uniform sampler2D uSampler;","void main(void) {","    float lum = length(texture2D(uSampler, vTextureCoord.xy).rgb);","    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);","    if (lum < 1.00) {","        if (mod(gl_FragCoord.x + gl_FragCoord.y, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","    if (lum < 0.75) {","        if (mod(gl_FragCoord.x - gl_FragCoord.y, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","    if (lum < 0.50) {","        if (mod(gl_FragCoord.x + gl_FragCoord.y - 5.0, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","    if (lum < 0.3) {","        if (mod(gl_FragCoord.x - gl_FragCoord.y - 5.0, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","}"]};PIXI.CrossHatchFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.CrossHatchFilter.prototype.constructor=PIXI.CrossHatchFilter;Object.defineProperty(PIXI.CrossHatchFilter.prototype,"blur",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.uniforms.blur.value=1/7e3*value}});PIXI.RGBSplitFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={red:{type:"2f",value:{x:20,y:20}},green:{type:"2f",value:{x:-20,y:20}},blue:{type:"2f",value:{x:20,y:-20}},dimensions:{type:"4fv",value:[0,0,0,0]}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 red;","uniform vec2 green;","uniform vec2 blue;","uniform vec4 dimensions;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor.r = texture2D(uSampler, vTextureCoord + red/dimensions.xy).r;","   gl_FragColor.g = texture2D(uSampler, vTextureCoord + green/dimensions.xy).g;","   gl_FragColor.b = texture2D(uSampler, vTextureCoord + blue/dimensions.xy).b;","   gl_FragColor.a = texture2D(uSampler, vTextureCoord).a;","}"]};PIXI.RGBSplitFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.RGBSplitFilter.prototype.constructor=PIXI.RGBSplitFilter;Object.defineProperty(PIXI.RGBSplitFilter.prototype,"red",{get:function(){return this.uniforms.red.value},set:function(value){this.uniforms.red.value=value}});Object.defineProperty(PIXI.RGBSplitFilter.prototype,"green",{get:function(){return this.uniforms.green.value},set:function(value){this.uniforms.green.value=value}});Object.defineProperty(PIXI.RGBSplitFilter.prototype,"blue",{get:function(){return this.uniforms.blue.value},set:function(value){this.uniforms.blue.value=value}});if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=PIXI}exports.PIXI=PIXI}else if(typeof define!=="undefined"&&define.amd){define(PIXI)}else{root.PIXI=PIXI}}).call(this);"use strict;";var Box2D=function(){var ClipVertex,Features,b2AABB,b2Body,b2BodyDef,b2Bound,b2BoundValues,b2BuoyancyController,b2CircleContact,b2CircleShape,b2Collision,b2Color,b2ConstantAccelController,b2ConstantForceController,b2Contact,b2ContactConstraint,b2ContactConstraintPoint,b2ContactEdge,b2ContactFactory,b2ContactFilter,b2ContactID,b2ContactImpulse,b2ContactListener,b2ContactManager,b2ContactPoint,b2ContactRegister,b2ContactResult,b2ContactSolver,b2Controller,b2ControllerEdge,b2DebugDraw,b2DestructionListener,b2Distance,b2DistanceInput,b2DistanceJoint,b2DistanceJointDef,b2DistanceOutput,b2DistanceProxy,b2DynamicTree,b2DynamicTreeBroadPhase,b2DynamicTreeNode,b2DynamicTreePair,b2EdgeAndCircleContact,b2EdgeChainDef,b2EdgeShape,b2FilterData,b2Fixture,b2FixtureDef,b2FrictionJoint,b2FrictionJointDef,b2GearJoint,b2GearJointDef,b2GravityController,b2Island,b2Jacobian,b2Joint,b2JointDef,b2JointEdge,b2LineJoint,b2LineJointDef,b2Manifold,b2ManifoldPoint,b2MassData,b2Mat22,b2Mat33,b2Math,b2MouseJoint,b2MouseJointDef,b2NullContact,b2Point,b2PolyAndCircleContact,b2PolyAndEdgeContact,b2PolygonContact,b2PolygonShape,b2PositionSolverManifold,b2PrismaticJoint,b2PrismaticJointDef,b2PulleyJoint,b2PulleyJointDef,b2RayCastInput,b2RayCastOutput,b2RevoluteJoint,b2RevoluteJointDef,b2Segment,b2SeparationFunction,b2Settings,b2Shape,b2Simplex,b2SimplexCache,b2SimplexVertex,b2Sweep,b2TOIInput,b2TensorDampingController,b2TimeOfImpact,b2TimeStep,b2Transform,b2Vec2,b2Vec3,b2WeldJoint,b2WeldJointDef,b2World,b2WorldManifold,parseUInt,b2internal="Box2D.Common.b2internal",IBroadPhase="Box2D.Collision.IBroadPhase",Box2D={is:function(o1,o2){var ref;if(o1===null){return false}if(o2 instanceof Function&&o1 instanceof o2){return true}if((ref=o1.constructor.__implements)!=null?ref[o2.name]:void 0){return true}return false},generateCallback:function(context,cb){return function(){cb.apply(context,arguments)}},NVector:function(length){var a,i;if(length==null){length=0}a=new Array(length);i=0;while(i<length){a[i]=0;++i}return a},parseUInt:function(v){return Math.abs(parseInt(v))}},Vector=Array,Vector_a2j_Number=Box2D.NVector;Box2D.Common={b2internal:b2internal,Math:{}};Box2D.Collision={IBroadPhase:IBroadPhase,Shapes:{}};Box2D.Dynamics={Contacts:{},Controllers:{},Joints:{}};b2Color=Box2D.Common.b2Color=function b2Color(rr,gg,bb){this._r=0;this._g=0;this._b=0;rr=rr||0;gg=gg||0;bb=bb||0;this._r=Box2D.parseUInt(255*b2Math.Clamp(rr,0,1));this._g=Box2D.parseUInt(255*b2Math.Clamp(gg,0,1));this._b=Box2D.parseUInt(255*b2Math.Clamp(bb,0,1))};b2Color.constructor=b2Color;b2Color.prototype.Set=function(rr,gg,bb){rr=rr||0;gg=gg||0;bb=bb||0;this._r=Box2D.parseUInt(255*b2Math.Clamp(rr,0,1));this._g=Box2D.parseUInt(255*b2Math.Clamp(gg,0,1));this._b=Box2D.parseUInt(255*b2Math.Clamp(bb,0,1))};b2Settings=Box2D.Common.b2Settings=function b2Settings(){};b2Settings.constructor=b2Settings;b2Settings.VERSION="2.1alpha";b2Settings.USHRT_MAX=65535;b2Settings.b2_pi=Math.PI;b2Settings.b2_maxManifoldPoints=2;b2Settings.b2_aabbExtension=.1;b2Settings.b2_aabbMultiplier=2;b2Settings.b2_linearSlop=.005;b2Settings.b2_maxTOIContactsPerIsland=32;b2Settings.b2_maxTOIJointsPerIsland=32;b2Settings.b2_velocityThreshold=1;b2Settings.b2_maxLinearCorrection=.2;b2Settings.b2_maxTranslation=2;b2Settings.b2_contactBaumgarte=.2;b2Settings.b2_timeToSleep=.5;b2Settings.b2_linearSleepTolerance=.01;b2Settings.b2MixFriction=function(friction1,friction2){friction1=friction1||0;friction2=friction2||0;return Math.sqrt(friction1*friction2)};b2Settings.b2MixRestitution=function(restitution1,restitution2){restitution1=restitution1||0;restitution2=restitution2||0;return restitution1>restitution2?restitution1:restitution2};b2Settings.b2Assert=function(a){if(!a){throw"Assertion Failed"}};b2Settings.b2_angularSleepTolerance=2/180*b2Settings.b2_pi;b2Settings.b2_maxRotationSquared=b2Settings.b2_maxRotation*b2Settings.b2_maxRotation;b2Settings.b2_maxRotation=.5*b2Settings.b2_pi;b2Settings.b2_maxTranslationSquared=b2Settings.b2_maxTranslation*b2Settings.b2_maxTranslation;b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi;b2Settings.b2_toiSlop=8*b2Settings.b2_linearSlop;b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi;b2Settings.b2_polygonRadius=2*b2Settings.b2_linearSlop;b2Vec2=Box2D.Common.Math.b2Vec2=function b2Vec2(x_,y_){this.x=x_||0;this.y=y_||0};b2Vec2.prototype.x=0;b2Vec2.prototype.y=0;b2Vec2.Make=function(x_,y_){x_=x_||0;y_=y_||0;return new b2Vec2(x_,y_)};b2Vec2.prototype.SetZero=function(){this.x=0;this.y=0};b2Vec2.prototype.Set=function(x_,y_){x_=x_||0;y_=y_||0;this.x=x_;this.y=y_};b2Vec2.prototype.SetV=function(v){this.x=v.x;this.y=v.y};b2Vec2.prototype.GetNegative=function(){return new b2Vec2(-this.x,-this.y)};b2Vec2.prototype.NegativeSelf=function(){this.x=-this.x;this.y=-this.y};b2Vec2.prototype.Copy=function(){return new b2Vec2(this.x,this.y)};b2Vec2.prototype.Add=function(v){this.x+=v.x;this.y+=v.y};b2Vec2.prototype.Subtract=function(v){this.x-=v.x;this.y-=v.y};b2Vec2.prototype.Multiply=function(a){a=a||0;this.x*=a;this.y*=a};b2Vec2.prototype.MulM=function(A){var tX=this.x;this.x=A.col1.x*tX+A.col2.x*this.y;this.y=A.col1.y*tX+A.col2.y*this.y};b2Vec2.prototype.MulTM=function(A){var tX=b2Math.Dot(this,A.col1);this.y=b2Math.Dot(this,A.col2);this.x=tX};b2Vec2.prototype.CrossVF=function(s){s=s||0;var tX=this.x;this.x=s*this.y;this.y=-s*tX};b2Vec2.prototype.CrossFV=function(s){s=s||0;var tX=this.x;this.x=-s*this.y;this.y=s*tX};b2Vec2.prototype.MinV=function(b){this.x=this.x<b.x?this.x:b.x;this.y=this.y<b.y?this.y:b.y};b2Vec2.prototype.MaxV=function(b){this.x=this.x>b.x?this.x:b.x;this.y=this.y>b.y?this.y:b.y};b2Vec2.prototype.Abs=function(){if(this.x<0)this.x=-this.x;if(this.y<0)this.y=-this.y};b2Vec2.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};b2Vec2.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y};b2Vec2.prototype.Normalize=function(){var length=Math.sqrt(this.x*this.x+this.y*this.y);if(length<Number.MIN_VALUE){return 0}var invLength=1/length;this.x*=invLength;this.y*=invLength;return length};b2Vec2.prototype.IsValid=function(){return b2Math.IsValid(this.x)&&b2Math.IsValid(this.y)};b2Vec3=Box2D.Common.Math.b2Vec3=function b2Vec3(x,y,z){x=x||0;y=y||0;z=z||0;this.x=x;this.y=y;this.z=z};b2Vec3.constructor=b2Vec3;b2Vec3.prototype.SetZero=function(){this.x=this.y=this.z=0};b2Vec3.prototype.Set=function(x,y,z){x=x||0;y=y||0;z=z||0;this.x=x;this.y=y;this.z=z};b2Vec3.prototype.SetV=function(v){this.x=v.x;this.y=v.y;this.z=v.z};b2Vec3.prototype.GetNegative=function(){return new b2Vec3(-this.x,-this.y,-this.z)};b2Vec3.prototype.NegativeSelf=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z};b2Vec3.prototype.Copy=function(){return new b2Vec3(this.x,this.y,this.z)};b2Vec3.prototype.Add=function(v){this.x+=v.x;this.y+=v.y;this.z+=v.z};b2Vec3.prototype.Subtract=function(v){this.x-=v.x;this.y-=v.y;this.z-=v.z};b2Vec3.prototype.Multiply=function(a){a=a||0;this.x*=a;this.y*=a;this.z*=a};b2Mat22=Box2D.Common.Math.b2Mat22=function b2Mat22(){this.col1=new b2Vec2;this.col2=new b2Vec2;this.SetIdentity()};b2Mat22.constructor=b2Mat22;b2Mat22.FromAngle=function(angle){angle=angle||0;var mat=new b2Mat22;mat.Set(angle);return mat};b2Mat22.FromVV=function(c1,c2){var mat=new b2Mat22;mat.SetVV(c1,c2);return mat};b2Mat22.prototype.Set=function(angle){angle=angle||0;var c=Math.cos(angle),s=Math.sin(angle);this.col1.x=c;this.col2.x=-s;this.col1.y=s;this.col2.y=c};b2Mat22.prototype.SetVV=function(c1,c2){this.col1.SetV(c1);this.col2.SetV(c2)};b2Mat22.prototype.Copy=function(){var mat=new b2Mat22;mat.SetM(this);return mat};b2Mat22.prototype.SetM=function(m){this.col1.SetV(m.col1);this.col2.SetV(m.col2)};b2Mat22.prototype.AddM=function(m){this.col1.x+=m.col1.x;this.col1.y+=m.col1.y;this.col2.x+=m.col2.x;this.col2.y+=m.col2.y};b2Mat22.prototype.SetIdentity=function(){this.col1.x=1;
this.col2.x=0;this.col1.y=0;this.col2.y=1};b2Mat22.prototype.SetZero=function(){this.col1.x=0;this.col2.x=0;this.col1.y=0;this.col2.y=0};b2Mat22.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)};b2Mat22.prototype.GetInverse=function(out){var a=this.col1.x,b=this.col2.x,c=this.col1.y,d=this.col2.y,det=a*d-b*c;if(det!=0){det=1/det}out.col1.x=det*d;out.col2.x=-det*b;out.col1.y=-det*c;out.col2.y=det*a;return out};b2Mat22.prototype.Solve=function(out,bX,bY){bX=bX||0;bY=bY||0;var a11=this.col1.x,a12=this.col2.x,a21=this.col1.y,a22=this.col2.y,det=a11*a22-a12*a21;if(det!=0){det=1/det}out.x=det*(a22*bX-a12*bY);out.y=det*(a11*bY-a21*bX);return out};b2Mat22.prototype.Abs=function(){this.col1.Abs();this.col2.Abs()};b2Mat33=Box2D.Common.Math.b2Mat33=function b2Mat33(c1,c2,c3){this.col1=new b2Vec3;this.col2=new b2Vec3;this.col3=new b2Vec3;c1=c1||null;c2=c2||null;c3=c3||null;if(!c1&&!c2&&!c3){this.col1.SetZero();this.col2.SetZero();this.col3.SetZero()}else{this.col1.SetV(c1);this.col2.SetV(c2);this.col3.SetV(c3)}};b2Mat33.constructor=b2Mat33;b2Mat33.prototype.SetVVV=function(c1,c2,c3){this.col1.SetV(c1);this.col2.SetV(c2);this.col3.SetV(c3)};b2Mat33.prototype.Copy=function(){return new b2Mat33(this.col1,this.col2,this.col3)};b2Mat33.prototype.SetM=function(m){this.col1.SetV(m.col1);this.col2.SetV(m.col2);this.col3.SetV(m.col3)};b2Mat33.prototype.AddM=function(m){this.col1.x+=m.col1.x;this.col1.y+=m.col1.y;this.col1.z+=m.col1.z;this.col2.x+=m.col2.x;this.col2.y+=m.col2.y;this.col2.z+=m.col2.z;this.col3.x+=m.col3.x;this.col3.y+=m.col3.y;this.col3.z+=m.col3.z};b2Mat33.prototype.SetIdentity=function(){this.col1.x=1;this.col2.x=0;this.col3.x=0;this.col1.y=0;this.col2.y=1;this.col3.y=0;this.col1.z=0;this.col2.z=0;this.col3.z=1};b2Mat33.prototype.SetZero=function(){this.col1.x=0;this.col2.x=0;this.col3.x=0;this.col1.y=0;this.col2.y=0;this.col3.y=0;this.col1.z=0;this.col2.z=0;this.col3.z=0};b2Mat33.prototype.Solve22=function(out,bX,bY){bX=bX||0;bY=bY||0;var a11=this.col1.x,a12=this.col2.x,a21=this.col1.y,a22=this.col2.y,det=a11*a22-a12*a21;if(det!=0){det=1/det}out.x=det*(a22*bX-a12*bY);out.y=det*(a11*bY-a21*bX);return out};b2Mat33.prototype.Solve33=function(out,bX,bY,bZ){bX=bX||0;bY=bY||0;bZ=bZ||0;var a11=this.col1.x,a21=this.col1.y,a31=this.col1.z,a12=this.col2.x,a22=this.col2.y,a32=this.col2.z,a13=this.col3.x,a23=this.col3.y,a33=this.col3.z,det=a11*(a22*a33-a32*a23)+a21*(a32*a13-a12*a33)+a31*(a12*a23-a22*a13);if(det!=0){det=1/det}out.x=det*(bX*(a22*a33-a32*a23)+bY*(a32*a13-a12*a33)+bZ*(a12*a23-a22*a13));out.y=det*(a11*(bY*a33-bZ*a23)+a21*(bZ*a13-bX*a33)+a31*(bX*a23-bY*a13));out.z=det*(a11*(a22*bZ-a32*bY)+a21*(a32*bX-a12*bZ)+a31*(a12*bY-a22*bX));return out};b2Sweep=Box2D.Common.Math.b2Sweep=function b2Sweep(){this.localCenter=new b2Vec2;this.c0=new b2Vec2;this.c=new b2Vec2};b2Sweep.constructor=b2Sweep;b2Sweep.prototype.Set=function(other){this.localCenter.SetV(other.localCenter);this.c0.SetV(other.c0);this.c.SetV(other.c);this.a0=other.a0;this.a=other.a;this.t0=other.t0};b2Sweep.prototype.Copy=function(){var copy=new b2Sweep;copy.localCenter.SetV(this.localCenter);copy.c0.SetV(this.c0);copy.c.SetV(this.c);copy.a0=this.a0;copy.a=this.a;copy.t0=this.t0;return copy};b2Sweep.prototype.GetTransform=function(xf,alpha){alpha=alpha||0;xf.position.x=(1-alpha)*this.c0.x+alpha*this.c.x;xf.position.y=(1-alpha)*this.c0.y+alpha*this.c.y;var angle=(1-alpha)*this.a0+alpha*this.a;xf.R.Set(angle);var tMat=xf.R;xf.position.x-=tMat.col1.x*this.localCenter.x+tMat.col2.x*this.localCenter.y;xf.position.y-=tMat.col1.y*this.localCenter.x+tMat.col2.y*this.localCenter.y};b2Sweep.prototype.Advance=function(t){t=t||0;if(this.t0<t&&1-this.t0>Number.MIN_VALUE){var alpha=(t-this.t0)/(1-this.t0);this.c0.x=(1-alpha)*this.c0.x+alpha*this.c.x;this.c0.y=(1-alpha)*this.c0.y+alpha*this.c.y;this.a0=(1-alpha)*this.a0+alpha*this.a;this.t0=t}};b2Transform=Box2D.Common.Math.b2Transform=function b2Transform(pos,r){this.position=new b2Vec2;this.R=new b2Mat22;pos=pos||null;r=r||null;if(pos){this.position.SetV(pos);this.R.SetM(r)}};b2Transform.constructor=b2Transform;b2Transform.prototype.Initialize=function(pos,r){this.position.SetV(pos);this.R.SetM(r)};b2Transform.prototype.SetIdentity=function(){this.position.SetZero();this.R.SetIdentity()};b2Transform.prototype.Set=function(x){this.position.SetV(x.position);this.R.SetM(x.R)};b2Transform.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)};b2Math=Box2D.Common.Math.b2Math=function b2Math(){};b2Math.constructor=b2Math;b2Math.b2Vec2_zero=new b2Vec2(0,0);b2Math.b2Mat22_identity=b2Mat22.FromVV(new b2Vec2(1,0),new b2Vec2(0,1));b2Math.IsValid=function(x){x=x||0;return isFinite(x)};b2Math.Dot=function(a,b){return a.x*b.x+a.y*b.y};b2Math.CrossVV=function(a,b){return a.x*b.y-a.y*b.x};b2Math.CrossVF=function(a,s){s=s||0;var v=new b2Vec2(s*a.y,-s*a.x);return v};b2Math.CrossFV=function(s,a){s=s||0;var v=new b2Vec2(-s*a.y,s*a.x);return v};b2Math.MulMV=function(A,v){var u=new b2Vec2(A.col1.x*v.x+A.col2.x*v.y,A.col1.y*v.x+A.col2.y*v.y);return u};b2Math.MulTMV=function(A,v){var u=new b2Vec2(b2Math.Dot(v,A.col1),b2Math.Dot(v,A.col2));return u};b2Math.MulX=function(T,v){var a=b2Math.MulMV(T.R,v);a.x+=T.position.x;a.y+=T.position.y;return a};b2Math.MulXT=function(T,v){var a=b2Math.SubtractVV(v,T.position),tX=a.x*T.R.col1.x+a.y*T.R.col1.y;a.y=a.x*T.R.col2.x+a.y*T.R.col2.y;a.x=tX;return a};b2Math.AddVV=function(a,b){var v=new b2Vec2(a.x+b.x,a.y+b.y);return v};b2Math.SubtractVV=function(a,b){var v=new b2Vec2(a.x-b.x,a.y-b.y);return v};b2Math.Distance=function(a,b){var cX=a.x-b.x,cY=a.y-b.y;return Math.sqrt(cX*cX+cY*cY)};b2Math.DistanceSquared=function(a,b){var cX=a.x-b.x,cY=a.y-b.y;return cX*cX+cY*cY};b2Math.MulFV=function(s,a){s=s||0;var v=new b2Vec2(s*a.x,s*a.y);return v};b2Math.AddMM=function(A,B){var C=b2Mat22.FromVV(b2Math.AddVV(A.col1,B.col1),b2Math.AddVV(A.col2,B.col2));return C};b2Math.MulMM=function(A,B){var C=b2Mat22.FromVV(b2Math.MulMV(A,B.col1),b2Math.MulMV(A,B.col2));return C};b2Math.MulTMM=function(A,B){var c1=new b2Vec2(b2Math.Dot(A.col1,B.col1),b2Math.Dot(A.col2,B.col1)),c2=new b2Vec2(b2Math.Dot(A.col1,B.col2),b2Math.Dot(A.col2,B.col2)),C=b2Mat22.FromVV(c1,c2);return C};b2Math.Abs=function(a){a=a||0;return a>0?a:-a};b2Math.AbsV=function(a){var b=new b2Vec2(b2Math.Abs(a.x),b2Math.Abs(a.y));return b};b2Math.AbsM=function(A){var B=b2Mat22.FromVV(b2Math.AbsV(A.col1),b2Math.AbsV(A.col2));return B};b2Math.Min=function(a,b){a=a||0;b=b||0;return a<b?a:b};b2Math.MinV=function(a,b){var c=new b2Vec2(b2Math.Min(a.x,b.x),b2Math.Min(a.y,b.y));return c};b2Math.Max=function(a,b){a=a||0;b=b||0;return a>b?a:b};b2Math.MaxV=function(a,b){var c=new b2Vec2(b2Math.Max(a.x,b.x),b2Math.Max(a.y,b.y));return c};b2Math.Clamp=function(a,low,high){a=a||0;low=low||0;high=high||0;return a<low?low:a>high?high:a};b2Math.ClampV=function(a,low,high){return b2Math.MaxV(low,b2Math.MinV(a,high))};b2Math.Swap=function(a,b){var tmp=a[0];a[0]=b[0];b[0]=tmp};b2Math.Random=function(){return Math.random()*2-1};b2Math.RandomRange=function(lo,hi){lo=lo||0;hi=hi||0;var r=Math.random();r=(hi-lo)*r+lo;return r};b2Math.NextPowerOfTwo=function(x){x=x||0;x|=x>>1&2147483647;x|=x>>2&1073741823;x|=x>>4&268435455;x|=x>>8&16777215;x|=x>>16&65535;return x+1};b2Math.IsPowerOfTwo=function(x){x=x||0;var result=x>0&&(x&x-1)==0;return result};b2Math.b2Transform_identity=new b2Transform(b2Math.b2Vec2_zero,b2Math.b2Mat22_identity);b2Shape=Box2D.Collision.Shapes.b2Shape=function b2Shape(){};b2Shape.prototype.m_type=b2Shape.e_unknownShape;b2Shape.prototype.m_radius=b2Settings.b2_linearSlop;b2Shape.e_unknownShape=parseInt(-1);b2Shape.e_circleShape=0;b2Shape.e_polygonShape=1;b2Shape.e_edgeShape=2;b2Shape.e_shapeTypeCount=3;b2Shape.e_hitCollide=1;b2Shape.e_missCollide=0;b2Shape.e_startsInsideCollide=parseInt(-1);b2Shape.TestOverlap=function(shape1,transform1,shape2,transform2){var input=new b2DistanceInput;input.proxyA=new b2DistanceProxy;input.proxyA.Set(shape1);input.proxyB=new b2DistanceProxy;input.proxyB.Set(shape2);input.transformA=transform1;input.transformB=transform2;input.useRadii=true;var simplexCache=new b2SimplexCache;simplexCache.count=0;var output=new b2DistanceOutput;b2Distance.Distance(output,simplexCache,input);return output.distance<10*Number.MIN_VALUE};b2Shape.prototype.Copy=function(){return null};b2Shape.prototype.Set=function(other){this.m_radius=other.m_radius};b2Shape.prototype.GetType=function(){return this.m_type};b2Shape.prototype.TestPoint=function(xf,p){return false};b2Shape.prototype.RayCast=function(output,input,transform){return false};b2Shape.prototype.ComputeAABB=function(aabb,xf){};b2Shape.prototype.ComputeMass=function(massData,density){density=density||0};b2Shape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){offset=offset||0;return 0};b2CircleShape=Box2D.Collision.Shapes.b2CircleShape=function b2CircleShape(radius){this.m_p=new b2Vec2;radius=radius||0;this.m_type=b2Shape.e_circleShape;this.m_radius=radius};b2CircleShape.prototype=Object.create(b2Shape.prototype);b2CircleShape.prototype.m_type=b2Shape.e_circleShape;b2CircleShape.prototype.m_p=null;b2CircleShape.prototype.Copy=function(){var s=new b2CircleShape;s.Set(this);return s};b2CircleShape.prototype.Set=function(other){b2Shape.prototype.Set.call(this,other);if(Box2D.is(other,b2CircleShape)){var other2=other instanceof b2CircleShape?other:null;this.m_p.SetV(other2.m_p)}};b2CircleShape.prototype.TestPoint=function(transform,p){var tMat=transform.R,dX=transform.position.x+(tMat.col1.x*this.m_p.x+tMat.col2.x*this.m_p.y),dY=transform.position.y+(tMat.col1.y*this.m_p.x+tMat.col2.y*this.m_p.y);dX=p.x-dX;dY=p.y-dY;return dX*dX+dY*dY<=this.m_radius*this.m_radius};b2CircleShape.prototype.RayCast=function(output,input,transform){var tMat=transform.R,positionX=transform.position.x+(tMat.col1.x*this.m_p.x+tMat.col2.x*this.m_p.y),positionY=transform.position.y+(tMat.col1.y*this.m_p.x+tMat.col2.y*this.m_p.y),sX=input.p1.x-positionX,sY=input.p1.y-positionY,b=sX*sX+sY*sY-this.m_radius*this.m_radius,rX=input.p2.x-input.p1.x,rY=input.p2.y-input.p1.y,c=sX*rX+sY*rY,rr=rX*rX+rY*rY,sigma=c*c-rr*b;if(sigma<0||rr<Number.MIN_VALUE){return false}var a=-(c+Math.sqrt(sigma));if(0<=a&&a<=input.maxFraction*rr){a/=rr;output.fraction=a;output.normal.x=sX+a*rX;output.normal.y=sY+a*rY;output.normal.Normalize();return true}return false};b2CircleShape.prototype.ComputeAABB=function(aabb,transform){var tMat=transform.R,pX=transform.position.x+(tMat.col1.x*this.m_p.x+tMat.col2.x*this.m_p.y),pY=transform.position.y+(tMat.col1.y*this.m_p.x+tMat.col2.y*this.m_p.y);aabb.lowerBound.Set(pX-this.m_radius,pY-this.m_radius);aabb.upperBound.Set(pX+this.m_radius,pY+this.m_radius)};b2CircleShape.prototype.ComputeMass=function(massData,density){density=density||0;massData.mass=density*b2Settings.b2_pi*this.m_radius*this.m_radius;massData.center.SetV(this.m_p);massData.I=massData.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))};b2CircleShape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){offset=offset||0;var p=b2Math.MulX(xf,this.m_p),l=-(b2Math.Dot(normal,p)-offset);if(l<-this.m_radius+Number.MIN_VALUE){return 0}if(l>this.m_radius){c.SetV(p);return Math.PI*this.m_radius*this.m_radius}var r2=this.m_radius*this.m_radius,l2=l*l,area=r2*(Math.asin(l/this.m_radius)+Math.PI/2)+l*Math.sqrt(r2-l2),com=-2/3*Math.pow(r2-l2,1.5)/area;c.x=p.x+normal.x*com;c.y=p.y+normal.y*com;return area};b2CircleShape.prototype.GetLocalPosition=function(){return this.m_p};b2CircleShape.prototype.SetLocalPosition=function(position){this.m_p.SetV(position)};b2CircleShape.prototype.GetRadius=function(){return this.m_radius};b2CircleShape.prototype.SetRadius=function(radius){radius=radius||0;this.m_radius=radius};b2CircleShape.prototype.GetType=function(){return this.m_type};b2CircleShape.prototype.b2Shape=function(){this.m_type=b2Shape.e_unknownShape;this.m_radius=b2Settings.b2_linearSlop};b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape=function b2PolygonShape(){b2Shape.call(this);this.m_type=b2Shape.e_polygonShape;this.m_centroid=new b2Vec2;this.m_vertices=new Vector;this.m_normals=new Vector};b2PolygonShape.constructor=b2PolygonShape;b2PolygonShape.prototype=Object.create(b2Shape.prototype);b2PolygonShape.s_mat=new b2Mat22;b2PolygonShape.AsArray=function(vertices,vertexCount){vertexCount=vertexCount||0;var polygonShape=new b2PolygonShape;polygonShape.SetAsArray(vertices,vertexCount);return polygonShape};b2PolygonShape.AsVector=function(vertices,vertexCount){vertexCount=vertexCount||0;var polygonShape=new b2PolygonShape;polygonShape.SetAsVector(vertices,vertexCount);return polygonShape};b2PolygonShape.AsBox=function(hx,hy){hx=hx||0;hy=hy||0;var polygonShape=new b2PolygonShape;polygonShape.SetAsBox(hx,hy);return polygonShape};b2PolygonShape.AsOrientedBox=function(hx,hy,center,angle){hx=hx||0;hy=hy||0;center=center||null;angle=angle||0;var polygonShape=new b2PolygonShape;polygonShape.SetAsOrientedBox(hx,hy,center,angle);return polygonShape};b2PolygonShape.AsEdge=function(v1,v2){var polygonShape=new b2PolygonShape;polygonShape.SetAsEdge(v1,v2);return polygonShape};b2PolygonShape.ComputeCentroid=function(vs,count){count=count||0;var c=new b2Vec2,area=0,p1X=0,p1Y=0,inv3=1/3;for(var i=0;i<count;++i){var p2=vs[i],p3=i+1<count?vs[parseInt(i+1)]:vs[0],e1X=p2.x-p1X,e1Y=p2.y-p1Y,e2X=p3.x-p1X,e2Y=p3.y-p1Y,D=e1X*e2Y-e1Y*e2X,triangleArea=.5*D;area+=triangleArea;c.x+=triangleArea*inv3*(p1X+p2.x+p3.x);c.y+=triangleArea*inv3*(p1Y+p2.y+p3.y)}c.x*=1/area;c.y*=1/area;return c};b2PolygonShape.ComputeOBB=function(obb,vs,count){count=count||0;var i=0,p=new Vector(count+1);for(i=0;i<count;++i){p[i]=vs[i]}p[count]=p[0];var minArea=Number.MAX_VALUE;for(i=1;i<=count;++i){var root=p[parseInt(i-1)],uxX=p[i].x-root.x,uxY=p[i].y-root.y,length=Math.sqrt(uxX*uxX+uxY*uxY);uxX/=length;uxY/=length;var uyX=-uxY,uyY=uxX,lowerX=Number.MAX_VALUE,lowerY=Number.MAX_VALUE,upperX=-Number.MAX_VALUE,upperY=-Number.MAX_VALUE;for(var j=0;j<count;++j){var dX=p[j].x-root.x,dY=p[j].y-root.y,rX=uxX*dX+uxY*dY,rY=uyX*dX+uyY*dY;if(rX<lowerX)lowerX=rX;if(rY<lowerY)lowerY=rY;if(rX>upperX)upperX=rX;if(rY>upperY)upperY=rY}var area=(upperX-lowerX)*(upperY-lowerY);if(area<.95*minArea){minArea=area;obb.R.col1.x=uxX;obb.R.col1.y=uxY;obb.R.col2.x=uyX;obb.R.col2.y=uyY;var centerX=.5*(lowerX+upperX),centerY=.5*(lowerY+upperY),tMat=obb.R;obb.center.x=root.x+(tMat.col1.x*centerX+tMat.col2.x*centerY);obb.center.y=root.y+(tMat.col1.y*centerX+tMat.col2.y*centerY);obb.extents.x=.5*(upperX-lowerX);obb.extents.y=.5*(upperY-lowerY)}}};b2PolygonShape.prototype.Copy=function(){var s=new b2PolygonShape;s.Set(this);return s};b2PolygonShape.prototype.Set=function(other){b2Shape.prototype.Set.call(this,other);if(Box2D.is(other,b2PolygonShape)){var other2=other instanceof b2PolygonShape?other:null;this.m_centroid.SetV(other2.m_centroid);this.m_vertexCount=other2.m_vertexCount;this.Reserve(this.m_vertexCount);for(var i=0;i<this.m_vertexCount;i++){this.m_vertices[i].SetV(other2.m_vertices[i]);this.m_normals[i].SetV(other2.m_normals[i])}}};b2PolygonShape.prototype.SetAsArray=function(vertices,vertexCount){vertexCount=vertexCount||0;var v=new Vector;var i=0,tVec;for(i=0;i<vertices.length;++i){tVec=vertices[i];v.push(tVec)}this.SetAsVector(v,vertexCount)};b2PolygonShape.prototype.SetAsVector=function(vertices,vertexCount){vertexCount=vertexCount||0;if(vertexCount==0)vertexCount=vertices.length;b2Settings.b2Assert(2<=vertexCount);this.m_vertexCount=vertexCount;this.Reserve(vertexCount);var i=0;for(i=0;i<this.m_vertexCount;i++){this.m_vertices[i].SetV(vertices[i])}for(i=0;i<this.m_vertexCount;++i){var i1=parseInt(i),i2=parseInt(i+1<this.m_vertexCount?i+1:0),edge=b2Math.SubtractVV(this.m_vertices[i2],this.m_vertices[i1]);b2Settings.b2Assert(edge.LengthSquared()>Number.MIN_VALUE);this.m_normals[i].SetV(b2Math.CrossVF(edge,1));this.m_normals[i].Normalize()}this.m_centroid=b2PolygonShape.ComputeCentroid(this.m_vertices,this.m_vertexCount)};b2PolygonShape.prototype.SetAsBox=function(hx,hy){hx=hx||0;hy=hy||0;this.m_vertexCount=4;this.Reserve(4);this.m_vertices[0].Set(-hx,-hy);this.m_vertices[1].Set(hx,-hy);this.m_vertices[2].Set(hx,hy);this.m_vertices[3].Set(-hx,hy);this.m_normals[0].Set(0,-1);this.m_normals[1].Set(1,0);this.m_normals[2].Set(0,1);this.m_normals[3].Set(-1,0);this.m_centroid.SetZero()};b2PolygonShape.prototype.SetAsOrientedBox=function(hx,hy,center,angle){hx=hx||0;hy=hy||0;center=center||null;angle=angle||0;this.m_vertexCount=4;this.Reserve(4);this.m_vertices[0].Set(-hx,-hy);this.m_vertices[1].Set(hx,-hy);this.m_vertices[2].Set(hx,hy);this.m_vertices[3].Set(-hx,hy);this.m_normals[0].Set(0,-1);this.m_normals[1].Set(1,0);this.m_normals[2].Set(0,1);this.m_normals[3].Set(-1,0);this.m_centroid=center;var xf=new b2Transform;xf.position=center;xf.R.Set(angle);for(var i=0;i<this.m_vertexCount;++i){this.m_vertices[i]=b2Math.MulX(xf,this.m_vertices[i]);this.m_normals[i]=b2Math.MulMV(xf.R,this.m_normals[i])}};b2PolygonShape.prototype.SetAsEdge=function(v1,v2){this.m_vertexCount=2;this.Reserve(2);this.m_vertices[0].SetV(v1);this.m_vertices[1].SetV(v2);this.m_centroid.x=.5*(v1.x+v2.x);this.m_centroid.y=.5*(v1.y+v2.y);this.m_normals[0]=b2Math.CrossVF(b2Math.SubtractVV(v2,v1),1);this.m_normals[0].Normalize();this.m_normals[1].x=-this.m_normals[0].x;this.m_normals[1].y=-this.m_normals[0].y};b2PolygonShape.prototype.TestPoint=function(xf,p){var tVec,tMat=xf.R,tX=p.x-xf.position.x,tY=p.y-xf.position.y,pLocalX=tX*tMat.col1.x+tY*tMat.col1.y,pLocalY=tX*tMat.col2.x+tY*tMat.col2.y;for(var i=0;i<this.m_vertexCount;++i){tVec=this.m_vertices[i];tX=pLocalX-tVec.x;tY=pLocalY-tVec.y;tVec=this.m_normals[i];var dot=tVec.x*tX+tVec.y*tY;if(dot>0){return false}}return true};b2PolygonShape.prototype.RayCast=function(output,input,transform){var lower=0,upper=input.maxFraction,tX=0,tY=0,tMat,tVec;tX=input.p1.x-transform.position.x;tY=input.p1.y-transform.position.y;tMat=transform.R;var p1X=tX*tMat.col1.x+tY*tMat.col1.y,p1Y=tX*tMat.col2.x+tY*tMat.col2.y;tX=input.p2.x-transform.position.x;tY=input.p2.y-transform.position.y;tMat=transform.R;var p2X=tX*tMat.col1.x+tY*tMat.col1.y,p2Y=tX*tMat.col2.x+tY*tMat.col2.y,dX=p2X-p1X,dY=p2Y-p1Y,index=parseInt(-1);for(var i=0;i<this.m_vertexCount;++i){tVec=this.m_vertices[i];tX=tVec.x-p1X;tY=tVec.y-p1Y;tVec=this.m_normals[i];var numerator=tVec.x*tX+tVec.y*tY,denominator=tVec.x*dX+tVec.y*dY;if(denominator==0){if(numerator<0){return false}}else{if(denominator<0&&numerator<lower*denominator){lower=numerator/denominator;index=i}else if(denominator>0&&numerator<upper*denominator){upper=numerator/denominator}}if(upper<lower-Number.MIN_VALUE){return false}}if(index>=0){output.fraction=lower;tMat=transform.R;tVec=this.m_normals[index];output.normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;output.normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;return true}return false};b2PolygonShape.prototype.ComputeAABB=function(aabb,xf){var tMat=xf.R,tVec=this.m_vertices[0],lowerX=xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),lowerY=xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y),upperX=lowerX,upperY=lowerY;for(var i=1;i<this.m_vertexCount;++i){tVec=this.m_vertices[i];var vX=xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),vY=xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);lowerX=lowerX<vX?lowerX:vX;lowerY=lowerY<vY?lowerY:vY;upperX=upperX>vX?upperX:vX;upperY=upperY>vY?upperY:vY}aabb.lowerBound.x=lowerX-this.m_radius;aabb.lowerBound.y=lowerY-this.m_radius;aabb.upperBound.x=upperX+this.m_radius;aabb.upperBound.y=upperY+this.m_radius};b2PolygonShape.prototype.ComputeMass=function(massData,density){density=density||0;if(this.m_vertexCount==2){massData.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x);massData.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y);massData.mass=0;massData.I=0;return}var centerX=0,centerY=0,area=0,I=0,p1X=0,p1Y=0,k_inv3=1/3;for(var i=0;i<this.m_vertexCount;++i){var p2=this.m_vertices[i],p3=i+1<this.m_vertexCount?this.m_vertices[parseInt(i+1)]:this.m_vertices[0],e1X=p2.x-p1X,e1Y=p2.y-p1Y,e2X=p3.x-p1X,e2Y=p3.y-p1Y,D=e1X*e2Y-e1Y*e2X,triangleArea=.5*D;area+=triangleArea;centerX+=triangleArea*k_inv3*(p1X+p2.x+p3.x);centerY+=triangleArea*k_inv3*(p1Y+p2.y+p3.y);var px=p1X,py=p1Y,ex1=e1X,ey1=e1Y,ex2=e2X,ey2=e2Y,intx2=k_inv3*(.25*(ex1*ex1+ex2*ex1+ex2*ex2)+(px*ex1+px*ex2))+.5*px*px,inty2=k_inv3*(.25*(ey1*ey1+ey2*ey1+ey2*ey2)+(py*ey1+py*ey2))+.5*py*py;I+=D*(intx2+inty2)}massData.mass=density*area;centerX*=1/area;centerY*=1/area;massData.center.Set(centerX,centerY);massData.I=density*I};b2PolygonShape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){offset=offset||0;var normalL=b2Math.MulTMV(xf.R,normal),offsetL=offset-b2Math.Dot(normal,xf.position),depths=new Vector_a2j_Number,diveCount=0,intoIndex=parseInt(-1),outoIndex=parseInt(-1),lastSubmerged=false,i=0;for(i=0;i<this.m_vertexCount;++i){depths[i]=b2Math.Dot(normalL,this.m_vertices[i])-offsetL;var isSubmerged=depths[i]<-Number.MIN_VALUE;if(i>0){if(isSubmerged){if(!lastSubmerged){intoIndex=i-1;diveCount++}}else{if(lastSubmerged){outoIndex=i-1;diveCount++}}}lastSubmerged=isSubmerged}switch(diveCount){case 0:if(lastSubmerged){var md=new b2MassData;this.ComputeMass(md,1);c.SetV(b2Math.MulX(xf,md.center));return md.mass}else{return 0}break;case 1:if(intoIndex==-1){intoIndex=this.m_vertexCount-1}else{outoIndex=this.m_vertexCount-1}break}var intoIndex2=parseInt((intoIndex+1)%this.m_vertexCount),outoIndex2=parseInt((outoIndex+1)%this.m_vertexCount),intoLamdda=(0-depths[intoIndex])/(depths[intoIndex2]-depths[intoIndex]),outoLamdda=(0-depths[outoIndex])/(depths[outoIndex2]-depths[outoIndex]),intoVec=new b2Vec2(this.m_vertices[intoIndex].x*(1-intoLamdda)+this.m_vertices[intoIndex2].x*intoLamdda,this.m_vertices[intoIndex].y*(1-intoLamdda)+this.m_vertices[intoIndex2].y*intoLamdda),outoVec=new b2Vec2(this.m_vertices[outoIndex].x*(1-outoLamdda)+this.m_vertices[outoIndex2].x*outoLamdda,this.m_vertices[outoIndex].y*(1-outoLamdda)+this.m_vertices[outoIndex2].y*outoLamdda),area=0,center=new b2Vec2,p2=this.m_vertices[intoIndex2],p3;i=intoIndex2;while(i!=outoIndex2){i=(i+1)%this.m_vertexCount;if(i==outoIndex2)p3=outoVec;else p3=this.m_vertices[i];var triangleArea=.5*((p2.x-intoVec.x)*(p3.y-intoVec.y)-(p2.y-intoVec.y)*(p3.x-intoVec.x));area+=triangleArea;center.x+=triangleArea*(intoVec.x+p2.x+p3.x)/3;center.y+=triangleArea*(intoVec.y+p2.y+p3.y)/3;p2=p3}center.Multiply(1/area);c.SetV(b2Math.MulX(xf,center));return area};b2PolygonShape.prototype.GetVertexCount=function(){return this.m_vertexCount};b2PolygonShape.prototype.GetVertices=function(){return this.m_vertices};b2PolygonShape.prototype.GetNormals=function(){return this.m_normals};b2PolygonShape.prototype.GetSupport=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_vertexCount;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return bestIndex};b2PolygonShape.prototype.GetSupportVertex=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_vertexCount;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return this.m_vertices[bestIndex]};b2PolygonShape.prototype.Validate=function(){return false};b2PolygonShape.prototype.Reserve=function(count){count=count||0;for(var i=parseInt(this.m_vertices.length);i<count;i++){this.m_vertices[i]=new b2Vec2;this.m_normals[i]=new b2Vec2}};b2PolygonShape.prototype.GetType=function(){return this.m_type};b2PolygonShape.prototype.b2Shape=function(){this.m_type=b2Shape.e_unknownShape;this.m_radius=b2Settings.b2_linearSlop};b2EdgeChainDef=Box2D.Collision.Shapes.b2EdgeChainDef=function b2EdgeChainDef(){this.vertexCount=0;this.isALoop=true;this.vertices=[]};b2EdgeChainDef.constructor=b2EdgeChainDef;b2EdgeShape=Box2D.Collision.Shapes.b2EdgeShape=function b2EdgeShape(v1,v2){this.s_supportVec=new b2Vec2;this.m_v1=new b2Vec2;this.m_v2=new b2Vec2;this.m_coreV1=new b2Vec2;this.m_coreV2=new b2Vec2;this.m_normal=new b2Vec2;this.m_direction=new b2Vec2;this.m_cornerDir1=new b2Vec2;this.m_cornerDir2=new b2Vec2;b2Shape.call(this);this.m_type=b2Shape.e_edgeShape;this.m_prevEdge=null;this.m_nextEdge=null;this.m_v1=v1;this.m_v2=v2;this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y);this.m_length=this.m_direction.Normalize();this.m_normal.Set(this.m_direction.y,-this.m_direction.x);this.m_coreV1.Set(-b2Settings.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-b2Settings.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y);this.m_coreV2.Set(-b2Settings.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-b2Settings.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y);this.m_cornerDir1=this.m_normal;this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)};b2EdgeShape.constructor=b2EdgeShape;b2EdgeShape.prototype=Object.create(b2Shape.prototype);b2EdgeShape.prototype.TestPoint=function(transform,p){return false};b2EdgeShape.prototype.RayCast=function(output,input,transform){var tMat,rX=input.p2.x-input.p1.x,rY=input.p2.y-input.p1.y;tMat=transform.R;var v1X=transform.position.x+(tMat.col1.x*this.m_v1.x+tMat.col2.x*this.m_v1.y),v1Y=transform.position.y+(tMat.col1.y*this.m_v1.x+tMat.col2.y*this.m_v1.y),nX=transform.position.y+(tMat.col1.y*this.m_v2.x+tMat.col2.y*this.m_v2.y)-v1Y,nY=-(transform.position.x+(tMat.col1.x*this.m_v2.x+tMat.col2.x*this.m_v2.y)-v1X),k_slop=100*Number.MIN_VALUE,denom=-(rX*nX+rY*nY);if(denom>k_slop){var bX=input.p1.x-v1X,bY=input.p1.y-v1Y,a=bX*nX+bY*nY;if(0<=a&&a<=input.maxFraction*denom){var mu2=-rX*bY+rY*bX;if(-k_slop*denom<=mu2&&mu2<=denom*(1+k_slop)){a/=denom;output.fraction=a;var nLen=Math.sqrt(nX*nX+nY*nY);output.normal.x=nX/nLen;output.normal.y=nY/nLen;return true}}}return false};b2EdgeShape.prototype.ComputeAABB=function(aabb,transform){var tMat=transform.R,v1X=transform.position.x+(tMat.col1.x*this.m_v1.x+tMat.col2.x*this.m_v1.y),v1Y=transform.position.y+(tMat.col1.y*this.m_v1.x+tMat.col2.y*this.m_v1.y),v2X=transform.position.x+(tMat.col1.x*this.m_v2.x+tMat.col2.x*this.m_v2.y),v2Y=transform.position.y+(tMat.col1.y*this.m_v2.x+tMat.col2.y*this.m_v2.y);if(v1X<v2X){aabb.lowerBound.x=v1X;aabb.upperBound.x=v2X}else{aabb.lowerBound.x=v2X;aabb.upperBound.x=v1X}if(v1Y<v2Y){aabb.lowerBound.y=v1Y;aabb.upperBound.y=v2Y}else{aabb.lowerBound.y=v2Y;aabb.upperBound.y=v1Y}};b2EdgeShape.prototype.ComputeMass=function(massData,density){density=density||0;massData.mass=0;massData.center.SetV(this.m_v1);massData.I=0};b2EdgeShape.prototype.ComputeSubmergedArea=function(normal,offset,xf,c){offset=offset||0;var v0=new b2Vec2(normal.x*offset,normal.y*offset),v1=b2Math.MulX(xf,this.m_v1),v2=b2Math.MulX(xf,this.m_v2),d1=b2Math.Dot(normal,v1)-offset,d2=b2Math.Dot(normal,v2)-offset;if(d1>0){if(d2>0){return 0}else{v1.x=-d2/(d1-d2)*v1.x+d1/(d1-d2)*v2.x;v1.y=-d2/(d1-d2)*v1.y+d1/(d1-d2)*v2.y}}else{if(d2>0){v2.x=-d2/(d1-d2)*v1.x+d1/(d1-d2)*v2.x;v2.y=-d2/(d1-d2)*v1.y+d1/(d1-d2)*v2.y}else{}}c.x=(v0.x+v1.x+v2.x)/3;c.y=(v0.y+v1.y+v2.y)/3;return.5*((v1.x-v0.x)*(v2.y-v0.y)-(v1.y-v0.y)*(v2.x-v0.x))};b2EdgeShape.prototype.GetLength=function(){return this.m_length};b2EdgeShape.prototype.GetVertex1=function(){return this.m_v1};b2EdgeShape.prototype.GetVertex2=function(){return this.m_v2};b2EdgeShape.prototype.GetCoreVertex1=function(){return this.m_coreV1};b2EdgeShape.prototype.GetCoreVertex2=function(){return this.m_coreV2};b2EdgeShape.prototype.GetNormalVector=function(){return this.m_normal};b2EdgeShape.prototype.GetDirectionVector=function(){return this.m_direction};b2EdgeShape.prototype.GetCorner1Vector=function(){return this.m_cornerDir1};b2EdgeShape.prototype.GetCorner2Vector=function(){return this.m_cornerDir2};b2EdgeShape.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1};b2EdgeShape.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2};b2EdgeShape.prototype.GetFirstVertex=function(xf){var tMat=xf.R;return new b2Vec2(xf.position.x+(tMat.col1.x*this.m_coreV1.x+tMat.col2.x*this.m_coreV1.y),xf.position.y+(tMat.col1.y*this.m_coreV1.x+tMat.col2.y*this.m_coreV1.y))};b2EdgeShape.prototype.GetNextEdge=function(){return this.m_nextEdge};b2EdgeShape.prototype.GetPrevEdge=function(){return this.m_prevEdge};b2EdgeShape.prototype.Support=function(xf,dX,dY){dX=dX||0;dY=dY||0;var tMat=xf.R,v1X=xf.position.x+(tMat.col1.x*this.m_coreV1.x+tMat.col2.x*this.m_coreV1.y),v1Y=xf.position.y+(tMat.col1.y*this.m_coreV1.x+tMat.col2.y*this.m_coreV1.y),v2X=xf.position.x+(tMat.col1.x*this.m_coreV2.x+tMat.col2.x*this.m_coreV2.y),v2Y=xf.position.y+(tMat.col1.y*this.m_coreV2.x+tMat.col2.y*this.m_coreV2.y);if(v1X*dX+v1Y*dY>v2X*dX+v2Y*dY){this.s_supportVec.x=v1X;this.s_supportVec.y=v1Y}else{this.s_supportVec.x=v2X;this.s_supportVec.y=v2Y}return this.s_supportVec};b2EdgeShape.prototype.SetPrevEdge=function(edge,core,cornerDir,convex){this.m_prevEdge=edge;this.m_coreV1=core;this.m_cornerDir1=cornerDir;this.m_cornerConvex1=convex};b2EdgeShape.prototype.SetNextEdge=function(edge,core,cornerDir,convex){this.m_nextEdge=edge;this.m_coreV2=core;this.m_cornerDir2=cornerDir;this.m_cornerConvex2=convex};b2EdgeShape.prototype.Copy=function(){return null};b2EdgeShape.prototype.Set=function(other){this.m_radius=other.m_radius};b2EdgeShape.prototype.GetType=function(){return this.m_type};b2EdgeShape.prototype.b2Shape=function(){this.m_type=b2Shape.e_unknownShape;this.m_radius=b2Settings.b2_linearSlop};b2MassData=Box2D.Collision.Shapes.b2MassData=function b2MassData(){this.mass=0;this.center=new b2Vec2(0,0);this.I=0};b2MassData.constructor=b2MassData;Features=Box2D.Collision.Features=function Features(){};Features.constructor=Features;b2ContactID=Box2D.Collision.b2ContactID=function b2ContactID(){this.features=new Features;this.features._m_id=this};b2ContactID.constructor=b2ContactID;b2ContactID.prototype.Set=function(id){this.key=id._key};b2ContactID.prototype.Copy=function(){var id=new b2ContactID;id.key=this.key;return id};ClipVertex=Box2D.Collision.ClipVertex=function ClipVertex(){this.v=new b2Vec2;this.id=new b2ContactID};ClipVertex.constructor=ClipVertex;ClipVertex.prototype.Set=function(other){this.v.SetV(other.v);this.id.Set(other.id)};b2AABB=Box2D.Collision.b2AABB=function b2AABB(){this.lowerBound=new b2Vec2;this.upperBound=new b2Vec2};b2AABB.constructor=b2AABB;b2AABB.Combine=function(aabb1,aabb2){var aabb=new b2AABB;aabb.Combine(aabb1,aabb2);return aabb};b2AABB.prototype.IsValid=function(){var dX=this.upperBound.x-this.lowerBound.x,dY=this.upperBound.y-this.lowerBound.y,valid=dX>=0&&dY>=0;valid=valid&&this.lowerBound.IsValid()&&this.upperBound.IsValid();return valid};b2AABB.prototype.GetCenter=function(){return new b2Vec2((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)};b2AABB.prototype.GetExtents=function(){return new b2Vec2((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)};b2AABB.prototype.Contains=function(aabb){var result=true;result=result&&this.lowerBound.x<=aabb.lowerBound.x;result=result&&this.lowerBound.y<=aabb.lowerBound.y;result=result&&aabb.upperBound.x<=this.upperBound.x;result=result&&aabb.upperBound.y<=this.upperBound.y;return result};b2AABB.prototype.RayCast=function(output,input){var tmin=-Number.MAX_VALUE,tmax=Number.MAX_VALUE,pX=input.p1.x,pY=input.p1.y,dX=input.p2.x-input.p1.x,dY=input.p2.y-input.p1.y,absDX=Math.abs(dX),absDY=Math.abs(dY),normal=output.normal,inv_d=0,t1=0,t2=0,t3=0;var s=0;{if(absDX<Number.MIN_VALUE){if(pX<this.lowerBound.x||this.upperBound.x<pX)return false}else{inv_d=1/dX;t1=(this.lowerBound.x-pX)*inv_d;t2=(this.upperBound.x-pX)*inv_d;s=-1;if(t1>t2){t3=t1;t1=t2;t2=t3;s=1}if(t1>tmin){normal.x=s;normal.y=0;tmin=t1}tmax=Math.min(tmax,t2);if(tmin>tmax)return false}}{if(absDY<Number.MIN_VALUE){if(pY<this.lowerBound.y||this.upperBound.y<pY)return false}else{inv_d=1/dY;t1=(this.lowerBound.y-pY)*inv_d;t2=(this.upperBound.y-pY)*inv_d;
s=-1;if(t1>t2){t3=t1;t1=t2;t2=t3;s=1}if(t1>tmin){normal.y=s;normal.x=0;tmin=t1}tmax=Math.min(tmax,t2);if(tmin>tmax)return false}}output.fraction=tmin;return true};b2AABB.prototype.TestOverlap=function(other){var d1X=other.lowerBound.x-this.upperBound.x,d1Y=other.lowerBound.y-this.upperBound.y,d2X=this.lowerBound.x-other.upperBound.x,d2Y=this.lowerBound.y-other.upperBound.y;if(d1X>0||d1Y>0)return false;if(d2X>0||d2Y>0)return false;return true};b2AABB.prototype.Combine=function(aabb1,aabb2){this.lowerBound.x=Math.min(aabb1.lowerBound.x,aabb2.lowerBound.x);this.lowerBound.y=Math.min(aabb1.lowerBound.y,aabb2.lowerBound.y);this.upperBound.x=Math.max(aabb1.upperBound.x,aabb2.upperBound.x);this.upperBound.y=Math.max(aabb1.upperBound.y,aabb2.upperBound.y)};b2SimplexCache=Box2D.Collision.b2SimplexCache=function b2SimplexCache(){this.indexA=new Vector_a2j_Number(3);this.indexB=new Vector_a2j_Number(3)};b2SimplexCache.constructor=b2SimplexCache;b2Bound=Box2D.Collision.b2Bound=function b2Bound(){};b2Bound.constructor=b2Bound;b2Bound.prototype.IsLower=function(){return(this.value&1)==0};b2Bound.prototype.IsUpper=function(){return(this.value&1)==1};b2Bound.prototype.Swap=function(b){var tempValue=this.value,tempProxy=this.proxy,tempStabbingCount=this.stabbingCount;this.value=b.value;this.proxy=b.proxy;this.stabbingCount=b.stabbingCount;b.value=tempValue;b.proxy=tempProxy;b.stabbingCount=tempStabbingCount};b2BoundValues=Box2D.Collision.b2BoundValues=function b2BoundValues(){this.lowerValues=new Vector_a2j_Number;this.lowerValues[0]=0;this.lowerValues[1]=0;this.upperValues=new Vector_a2j_Number;this.upperValues[0]=0;this.upperValues[1]=0};b2BoundValues.constructor=b2BoundValues;b2ManifoldPoint=Box2D.Collision.b2ManifoldPoint=function b2ManifoldPoint(){this.m_localPoint=new b2Vec2;this.m_id=new b2ContactID;this.Reset()};b2ManifoldPoint.constructor=b2ManifoldPoint;b2ManifoldPoint.prototype.Reset=function(){this.m_localPoint.SetZero();this.m_normalImpulse=0;this.m_tangentImpulse=0;this.m_id.key=0};b2ManifoldPoint.prototype.Set=function(m){this.m_localPoint.SetV(m.m_localPoint);this.m_normalImpulse=m.m_normalImpulse;this.m_tangentImpulse=m.m_tangentImpulse;this.m_id.Set(m.m_id)};b2Manifold=Box2D.Collision.b2Manifold=function b2Manifold(){this.m_pointCount=0;this.m_points=new Vector(b2Settings.b2_maxManifoldPoints);for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.m_points[i]=new b2ManifoldPoint}this.m_localPlaneNormal=new b2Vec2;this.m_localPoint=new b2Vec2};b2Manifold.constructor=b2Manifold;b2Manifold.e_circles=1;b2Manifold.e_faceA=2;b2Manifold.e_faceB=4;b2Manifold.prototype.Reset=function(){for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){(this.m_points[i]instanceof b2ManifoldPoint?this.m_points[i]:null).Reset()}this.m_localPlaneNormal.SetZero();this.m_localPoint.SetZero();this.m_type=0;this.m_pointCount=0};b2Manifold.prototype.Set=function(m){this.m_pointCount=m.m_pointCount;for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){(this.m_points[i]instanceof b2ManifoldPoint?this.m_points[i]:null).Set(m.m_points[i])}this.m_localPlaneNormal.SetV(m.m_localPlaneNormal);this.m_localPoint.SetV(m.m_localPoint);this.m_type=m.m_type};b2Manifold.prototype.Copy=function(){var copy=new b2Manifold;copy.Set(this);return copy};b2Collision=Box2D.Collision.b2Collision=function b2Collision(){};b2Collision.constructor=b2Collision;b2Collision.s_edgeAO=new Vector_a2j_Number(1);b2Collision.s_edgeBO=new Vector_a2j_Number(1);b2Collision.s_localTangent=new b2Vec2;b2Collision.s_localNormal=new b2Vec2;b2Collision.s_planePoint=new b2Vec2;b2Collision.s_normal=new b2Vec2;b2Collision.s_tangent=new b2Vec2;b2Collision.s_tangent2=new b2Vec2;b2Collision.s_v11=new b2Vec2;b2Collision.s_v12=new b2Vec2;b2Collision.b2CollidePolyTempVec=new b2Vec2;b2Collision.b2_nullFeature=255;b2Collision.ClipSegmentToLine=function(vOut,vIn,normal,offset){offset=offset||0;var cv,numOut=0;cv=vIn[0];var vIn0=cv.v;cv=vIn[1];var vIn1=cv.v,distance0=normal.x*vIn0.x+normal.y*vIn0.y-offset,distance1=normal.x*vIn1.x+normal.y*vIn1.y-offset;if(distance0<=0)vOut[numOut++].Set(vIn[0]);if(distance1<=0)vOut[numOut++].Set(vIn[1]);if(distance0*distance1<0){var interp=distance0/(distance0-distance1);cv=vOut[numOut];var tVec=cv.v;tVec.x=vIn0.x+interp*(vIn1.x-vIn0.x);tVec.y=vIn0.y+interp*(vIn1.y-vIn0.y);cv=vOut[numOut];var cv2;if(distance0>0){cv2=vIn[0];cv.id=cv2.id}else{cv2=vIn[1];cv.id=cv2.id}++numOut}return numOut};b2Collision.EdgeSeparation=function(poly1,xf1,edge1,poly2,xf2){edge1=edge1||0;var count1=parseInt(poly1.m_vertexCount),vertices1=poly1.m_vertices,normals1=poly1.m_normals,count2=parseInt(poly2.m_vertexCount),vertices2=poly2.m_vertices,tMat,tVec;tMat=xf1.R;tVec=normals1[edge1];var normal1WorldX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,normal1WorldY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xf2.R;var normal1X=tMat.col1.x*normal1WorldX+tMat.col1.y*normal1WorldY,normal1Y=tMat.col2.x*normal1WorldX+tMat.col2.y*normal1WorldY,index=0,minDot=Number.MAX_VALUE;for(var i=0;i<count2;++i){tVec=vertices2[i];var dot=tVec.x*normal1X+tVec.y*normal1Y;if(dot<minDot){minDot=dot;index=i}}tVec=vertices1[edge1];tMat=xf1.R;var v1X=xf1.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),v1Y=xf1.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=vertices2[index];tMat=xf2.R;var v2X=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),v2Y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);v2X-=v1X;v2Y-=v1Y;var separation=v2X*normal1WorldX+v2Y*normal1WorldY;return separation};b2Collision.FindMaxSeparation=function(edgeIndex,poly1,xf1,poly2,xf2){var count1=parseInt(poly1.m_vertexCount),normals1=poly1.m_normals,tVec,tMat;tMat=xf2.R;tVec=poly2.m_centroid;var dX=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),dY=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=xf1.R;tVec=poly1.m_centroid;dX-=xf1.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);dY-=xf1.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);var dLocal1X=dX*xf1.R.col1.x+dY*xf1.R.col1.y,dLocal1Y=dX*xf1.R.col2.x+dY*xf1.R.col2.y,edge=0,maxDot=-Number.MAX_VALUE;for(var i=0;i<count1;++i){tVec=normals1[i];var dot=tVec.x*dLocal1X+tVec.y*dLocal1Y;if(dot>maxDot){maxDot=dot;edge=i}}var s=b2Collision.EdgeSeparation(poly1,xf1,edge,poly2,xf2),prevEdge=parseInt(edge-1>=0?edge-1:count1-1),sPrev=b2Collision.EdgeSeparation(poly1,xf1,prevEdge,poly2,xf2),nextEdge=parseInt(edge+1<count1?edge+1:0),sNext=b2Collision.EdgeSeparation(poly1,xf1,nextEdge,poly2,xf2),bestEdge=0,bestSeparation=0,increment=0;if(sPrev>s&&sPrev>sNext){increment=-1;bestEdge=prevEdge;bestSeparation=sPrev}else if(sNext>s){increment=1;bestEdge=nextEdge;bestSeparation=sNext}else{edgeIndex[0]=edge;return s}while(true){if(increment==-1)edge=bestEdge-1>=0?bestEdge-1:count1-1;else edge=bestEdge+1<count1?bestEdge+1:0;s=b2Collision.EdgeSeparation(poly1,xf1,edge,poly2,xf2);if(s>bestSeparation){bestEdge=edge;bestSeparation=s}else{break}}edgeIndex[0]=bestEdge;return bestSeparation};b2Collision.FindIncidentEdge=function(c,poly1,xf1,edge1,poly2,xf2){edge1=edge1||0;var count1=parseInt(poly1.m_vertexCount),normals1=poly1.m_normals,count2=parseInt(poly2.m_vertexCount),vertices2=poly2.m_vertices,normals2=poly2.m_normals,tMat,tVec;tMat=xf1.R;tVec=normals1[edge1];var normal1X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,normal1Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xf2.R;var tX=tMat.col1.x*normal1X+tMat.col1.y*normal1Y;normal1Y=tMat.col2.x*normal1X+tMat.col2.y*normal1Y;normal1X=tX;var index=0,minDot=Number.MAX_VALUE;for(var i=0;i<count2;++i){tVec=normals2[i];var dot=normal1X*tVec.x+normal1Y*tVec.y;if(dot<minDot){minDot=dot;index=i}}var tClip,i1=parseInt(index),i2=parseInt(i1+1<count2?i1+1:0);tClip=c[0];tVec=vertices2[i1];tMat=xf2.R;tClip.v.x=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);tClip.v.y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tClip.id.features.referenceEdge=edge1;tClip.id.features.incidentEdge=i1;tClip.id.features.incidentVertex=0;tClip=c[1];tVec=vertices2[i2];tMat=xf2.R;tClip.v.x=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);tClip.v.y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tClip.id.features.referenceEdge=edge1;tClip.id.features.incidentEdge=i2;tClip.id.features.incidentVertex=1};b2Collision.MakeClipPointVector=function(){var r=new Vector(2);r[0]=new ClipVertex;r[1]=new ClipVertex;return r};b2Collision.CollidePolygons=function(manifold,polyA,xfA,polyB,xfB){var cv;manifold.m_pointCount=0;var totalRadius=polyA.m_radius+polyB.m_radius,edgeA=0;b2Collision.s_edgeAO[0]=edgeA;var separationA=b2Collision.FindMaxSeparation(b2Collision.s_edgeAO,polyA,xfA,polyB,xfB);edgeA=b2Collision.s_edgeAO[0];if(separationA>totalRadius)return;var edgeB=0;b2Collision.s_edgeBO[0]=edgeB;var separationB=b2Collision.FindMaxSeparation(b2Collision.s_edgeBO,polyB,xfB,polyA,xfA);edgeB=b2Collision.s_edgeBO[0];if(separationB>totalRadius)return;var poly1,poly2,xf1,xf2,edge1=0,flip=0,k_relativeTol=.98,k_absoluteTol=.001,tMat;if(separationB>k_relativeTol*separationA+k_absoluteTol){poly1=polyB;poly2=polyA;xf1=xfB;xf2=xfA;edge1=edgeB;manifold.m_type=b2Manifold.e_faceB;flip=1}else{poly1=polyA;poly2=polyB;xf1=xfA;xf2=xfB;edge1=edgeA;manifold.m_type=b2Manifold.e_faceA;flip=0}var incidentEdge=b2Collision.s_incidentEdge;b2Collision.FindIncidentEdge(incidentEdge,poly1,xf1,edge1,poly2,xf2);var count1=parseInt(poly1.m_vertexCount),vertices1=poly1.m_vertices,local_v11=vertices1[edge1],local_v12;if(edge1+1<count1){local_v12=vertices1[parseInt(edge1+1)]}else{local_v12=vertices1[0]}var localTangent=b2Collision.s_localTangent;localTangent.Set(local_v12.x-local_v11.x,local_v12.y-local_v11.y);localTangent.Normalize();var localNormal=b2Collision.s_localNormal;localNormal.x=localTangent.y;localNormal.y=-localTangent.x;var planePoint=b2Collision.s_planePoint;planePoint.Set(.5*(local_v11.x+local_v12.x),.5*(local_v11.y+local_v12.y));var tangent=b2Collision.s_tangent;tMat=xf1.R;tangent.x=tMat.col1.x*localTangent.x+tMat.col2.x*localTangent.y;tangent.y=tMat.col1.y*localTangent.x+tMat.col2.y*localTangent.y;var tangent2=b2Collision.s_tangent2;tangent2.x=-tangent.x;tangent2.y=-tangent.y;var normal=b2Collision.s_normal;normal.x=tangent.y;normal.y=-tangent.x;var v11=b2Collision.s_v11,v12=b2Collision.s_v12;v11.x=xf1.position.x+(tMat.col1.x*local_v11.x+tMat.col2.x*local_v11.y);v11.y=xf1.position.y+(tMat.col1.y*local_v11.x+tMat.col2.y*local_v11.y);v12.x=xf1.position.x+(tMat.col1.x*local_v12.x+tMat.col2.x*local_v12.y);v12.y=xf1.position.y+(tMat.col1.y*local_v12.x+tMat.col2.y*local_v12.y);var frontOffset=normal.x*v11.x+normal.y*v11.y,sideOffset1=-tangent.x*v11.x-tangent.y*v11.y+totalRadius,sideOffset2=tangent.x*v12.x+tangent.y*v12.y+totalRadius,clipPoints1=b2Collision.s_clipPoints1,clipPoints2=b2Collision.s_clipPoints2,np=0;np=b2Collision.ClipSegmentToLine(clipPoints1,incidentEdge,tangent2,sideOffset1);if(np<2)return;np=b2Collision.ClipSegmentToLine(clipPoints2,clipPoints1,tangent,sideOffset2);if(np<2)return;manifold.m_localPlaneNormal.SetV(localNormal);manifold.m_localPoint.SetV(planePoint);var pointCount=0;for(var i=0;i<b2Settings.b2_maxManifoldPoints;++i){cv=clipPoints2[i];var separation=normal.x*cv.v.x+normal.y*cv.v.y-frontOffset;if(separation<=totalRadius){var cp=manifold.m_points[pointCount];tMat=xf2.R;var tX=cv.v.x-xf2.position.x,tY=cv.v.y-xf2.position.y;cp.m_localPoint.x=tX*tMat.col1.x+tY*tMat.col1.y;cp.m_localPoint.y=tX*tMat.col2.x+tY*tMat.col2.y;cp.m_id.Set(cv.id);cp.m_id.features.flip=flip;++pointCount}}manifold.m_pointCount=pointCount};b2Collision.CollideCircles=function(manifold,circle1,xf1,circle2,xf2){manifold.m_pointCount=0;var tMat,tVec;tMat=xf1.R;tVec=circle1.m_p;var p1X=xf1.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),p1Y=xf1.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=xf2.R;tVec=circle2.m_p;var p2X=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),p2Y=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y),dX=p2X-p1X,dY=p2Y-p1Y,distSqr=dX*dX+dY*dY,radius=circle1.m_radius+circle2.m_radius;if(distSqr>radius*radius){return}manifold.m_type=b2Manifold.e_circles;manifold.m_localPoint.SetV(circle1.m_p);manifold.m_localPlaneNormal.SetZero();manifold.m_pointCount=1;manifold.m_points[0].m_localPoint.SetV(circle2.m_p);manifold.m_points[0].m_id.key=0};b2Collision.CollidePolygonAndCircle=function(manifold,polygon,xf1,circle,xf2){manifold.m_pointCount=0;var tPoint,dX=0,dY=0,positionX=0,positionY=0,tVec,tMat;tMat=xf2.R;tVec=circle.m_p;var cX=xf2.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),cY=xf2.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);dX=cX-xf1.position.x;dY=cY-xf1.position.y;tMat=xf1.R;var cLocalX=dX*tMat.col1.x+dY*tMat.col1.y,cLocalY=dX*tMat.col2.x+dY*tMat.col2.y,dist=0,normalIndex=0,separation=-Number.MAX_VALUE,radius=polygon.m_radius+circle.m_radius,vertexCount=parseInt(polygon.m_vertexCount),vertices=polygon.m_vertices,normals=polygon.m_normals;for(var i=0;i<vertexCount;++i){tVec=vertices[i];dX=cLocalX-tVec.x;dY=cLocalY-tVec.y;tVec=normals[i];var s=tVec.x*dX+tVec.y*dY;if(s>radius){return}if(s>separation){separation=s;normalIndex=i}}var vertIndex1=parseInt(normalIndex),vertIndex2=parseInt(vertIndex1+1<vertexCount?vertIndex1+1:0),v1=vertices[vertIndex1],v2=vertices[vertIndex2];if(separation<Number.MIN_VALUE){manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.SetV(normals[normalIndex]);manifold.m_localPoint.x=.5*(v1.x+v2.x);manifold.m_localPoint.y=.5*(v1.y+v2.y);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0;return}var u1=(cLocalX-v1.x)*(v2.x-v1.x)+(cLocalY-v1.y)*(v2.y-v1.y),u2=(cLocalX-v2.x)*(v1.x-v2.x)+(cLocalY-v2.y)*(v1.y-v2.y);if(u1<=0){if((cLocalX-v1.x)*(cLocalX-v1.x)+(cLocalY-v1.y)*(cLocalY-v1.y)>radius*radius)return;manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.x=cLocalX-v1.x;manifold.m_localPlaneNormal.y=cLocalY-v1.y;manifold.m_localPlaneNormal.Normalize();manifold.m_localPoint.SetV(v1);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0}else if(u2<=0){if((cLocalX-v2.x)*(cLocalX-v2.x)+(cLocalY-v2.y)*(cLocalY-v2.y)>radius*radius)return;manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.x=cLocalX-v2.x;manifold.m_localPlaneNormal.y=cLocalY-v2.y;manifold.m_localPlaneNormal.Normalize();manifold.m_localPoint.SetV(v2);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0}else{var faceCenterX=.5*(v1.x+v2.x),faceCenterY=.5*(v1.y+v2.y);separation=(cLocalX-faceCenterX)*normals[vertIndex1].x+(cLocalY-faceCenterY)*normals[vertIndex1].y;if(separation>radius)return;manifold.m_pointCount=1;manifold.m_type=b2Manifold.e_faceA;manifold.m_localPlaneNormal.x=normals[vertIndex1].x;manifold.m_localPlaneNormal.y=normals[vertIndex1].y;manifold.m_localPlaneNormal.Normalize();manifold.m_localPoint.Set(faceCenterX,faceCenterY);manifold.m_points[0].m_localPoint.SetV(circle.m_p);manifold.m_points[0].m_id.key=0}};b2Collision.TestOverlap=function(a,b){var t1=b.lowerBound,t2=a.upperBound,d1X=t1.x-t2.x,d1Y=t1.y-t2.y;t1=a.lowerBound;t2=b.upperBound;var d2X=t1.x-t2.x,d2Y=t1.y-t2.y;if(d1X>0||d1Y>0)return false;if(d2X>0||d2Y>0)return false;return true};b2Collision.s_clipPoints2=b2Collision.MakeClipPointVector();b2Collision.s_clipPoints1=b2Collision.MakeClipPointVector();b2Collision.s_incidentEdge=b2Collision.MakeClipPointVector();b2ContactPoint=Box2D.Collision.b2ContactPoint=function b2ContactPoint(){this.position=new b2Vec2;this.velocity=new b2Vec2;this.normal=new b2Vec2;this.id=new b2ContactID};b2ContactPoint.constructor=b2ContactPoint;b2SimplexVertex=Box2D.Collision.b2SimplexVertex=function b2SimplexVertex(){};b2SimplexVertex.constructor=b2SimplexVertex;b2SimplexVertex.prototype.Set=function(other){this.wA.SetV(other.wA);this.wB.SetV(other.wB);this.w.SetV(other.w);this.a=other.a;this.indexA=other.indexA;this.indexB=other.indexB};b2Simplex=Box2D.Collision.b2Simplex=function b2Simplex(){this.m_v1=new b2SimplexVertex;this.m_v2=new b2SimplexVertex;this.m_v3=new b2SimplexVertex;this.m_vertices=new Vector(3);this.m_vertices[0]=this.m_v1;this.m_vertices[1]=this.m_v2;this.m_vertices[2]=this.m_v3};b2Simplex.constructor=b2Simplex;b2Simplex.prototype.ReadCache=function(cache,proxyA,transformA,proxyB,transformB){b2Settings.b2Assert(0<=cache.count&&cache.count<=3);var wALocal,wBLocal;this.m_count=cache.count;var vertices=this.m_vertices;for(var i=0;i<this.m_count;i++){var v=vertices[i];v.indexA=cache.indexA[i];v.indexB=cache.indexB[i];wALocal=proxyA.GetVertex(v.indexA);wBLocal=proxyB.GetVertex(v.indexB);v.wA=b2Math.MulX(transformA,wALocal);v.wB=b2Math.MulX(transformB,wBLocal);v.w=b2Math.SubtractVV(v.wB,v.wA);v.a=0}if(this.m_count>1){var metric1=cache.metric,metric2=this.GetMetric();if(metric2<.5*metric1||2*metric1<metric2||metric2<Number.MIN_VALUE){this.m_count=0}}if(this.m_count==0){v=vertices[0];v.indexA=0;v.indexB=0;wALocal=proxyA.GetVertex(0);wBLocal=proxyB.GetVertex(0);v.wA=b2Math.MulX(transformA,wALocal);v.wB=b2Math.MulX(transformB,wBLocal);v.w=b2Math.SubtractVV(v.wB,v.wA);this.m_count=1}};b2Simplex.prototype.WriteCache=function(cache){cache.metric=this.GetMetric();cache.count=Box2D.parseUInt(this.m_count);var vertices=this.m_vertices;for(var i=0;i<this.m_count;i++){cache.indexA[i]=Box2D.parseUInt(vertices[i].indexA);cache.indexB[i]=Box2D.parseUInt(vertices[i].indexB)}};b2Simplex.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:{var e12=b2Math.SubtractVV(this.m_v2.w,this.m_v1.w),sgn=b2Math.CrossVV(e12,this.m_v1.w.GetNegative());if(sgn>0){return b2Math.CrossFV(1,e12)}else{return b2Math.CrossVF(e12,1)}}default:b2Settings.b2Assert(false);return new b2Vec2}};b2Simplex.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:b2Settings.b2Assert(false);return new b2Vec2;case 1:return this.m_v1.w;case 2:return new b2Vec2(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);default:b2Settings.b2Assert(false);return new b2Vec2}};b2Simplex.prototype.GetWitnessPoints=function(pA,pB){switch(this.m_count){case 0:b2Settings.b2Assert(false);break;case 1:pA.SetV(this.m_v1.wA);pB.SetV(this.m_v1.wB);break;case 2:pA.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x;pA.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y;pB.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x;pB.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:pB.x=pA.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x;pB.y=pA.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break;default:b2Settings.b2Assert(false);break}};b2Simplex.prototype.GetMetric=function(){switch(this.m_count){case 0:b2Settings.b2Assert(false);return 0;case 1:return 0;case 2:return b2Math.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return b2Math.CrossVV(b2Math.SubtractVV(this.m_v2.w,this.m_v1.w),b2Math.SubtractVV(this.m_v3.w,this.m_v1.w));default:b2Settings.b2Assert(false);return 0}};b2Simplex.prototype.Solve2=function(){var w1=this.m_v1.w,w2=this.m_v2.w,e12=b2Math.SubtractVV(w2,w1),d12_2=-(w1.x*e12.x+w1.y*e12.y);if(d12_2<=0){this.m_v1.a=1;this.m_count=1;return}var d12_1=w2.x*e12.x+w2.y*e12.y;if(d12_1<=0){this.m_v2.a=1;this.m_count=1;this.m_v1.Set(this.m_v2);return}var inv_d12=1/(d12_1+d12_2);this.m_v1.a=d12_1*inv_d12;this.m_v2.a=d12_2*inv_d12;this.m_count=2};b2Simplex.prototype.Solve3=function(){var w1=this.m_v1.w,w2=this.m_v2.w,w3=this.m_v3.w,e12=b2Math.SubtractVV(w2,w1),w1e12=b2Math.Dot(w1,e12),w2e12=b2Math.Dot(w2,e12),d12_1=w2e12,d12_2=-w1e12,e13=b2Math.SubtractVV(w3,w1),w1e13=b2Math.Dot(w1,e13),w3e13=b2Math.Dot(w3,e13),d13_1=w3e13,d13_2=-w1e13,e23=b2Math.SubtractVV(w3,w2),w2e23=b2Math.Dot(w2,e23),w3e23=b2Math.Dot(w3,e23),d23_1=w3e23,d23_2=-w2e23,n123=b2Math.CrossVV(e12,e13),d123_1=n123*b2Math.CrossVV(w2,w3),d123_2=n123*b2Math.CrossVV(w3,w1),d123_3=n123*b2Math.CrossVV(w1,w2);if(d12_2<=0&&d13_2<=0){this.m_v1.a=1;this.m_count=1;return}if(d12_1>0&&d12_2>0&&d123_3<=0){var inv_d12=1/(d12_1+d12_2);this.m_v1.a=d12_1*inv_d12;this.m_v2.a=d12_2*inv_d12;this.m_count=2;return}if(d13_1>0&&d13_2>0&&d123_2<=0){var inv_d13=1/(d13_1+d13_2);this.m_v1.a=d13_1*inv_d13;this.m_v3.a=d13_2*inv_d13;this.m_count=2;this.m_v2.Set(this.m_v3);return}if(d12_1<=0&&d23_2<=0){this.m_v2.a=1;this.m_count=1;this.m_v1.Set(this.m_v2);return}if(d13_1<=0&&d23_1<=0){this.m_v3.a=1;this.m_count=1;this.m_v1.Set(this.m_v3);return}if(d23_1>0&&d23_2>0&&d123_1<=0){var inv_d23=1/(d23_1+d23_2);this.m_v2.a=d23_1*inv_d23;this.m_v3.a=d23_2*inv_d23;this.m_count=2;this.m_v1.Set(this.m_v3);return}var inv_d123=1/(d123_1+d123_2+d123_3);this.m_v1.a=d123_1*inv_d123;this.m_v2.a=d123_2*inv_d123;this.m_v3.a=d123_3*inv_d123;this.m_count=3};b2Distance=Box2D.Collision.b2Distance=function b2Distance(){};b2Distance.constructor=b2Distance;b2Distance.s_simplex=new b2Simplex;b2Distance.s_saveA=new Vector_a2j_Number(3);b2Distance.s_saveB=new Vector_a2j_Number(3);b2Distance.Distance=function(output,cache,input){++b2Distance.b2_gjkCalls;var proxyA=input.proxyA,proxyB=input.proxyB,transformA=input.transformA,transformB=input.transformB,simplex=b2Distance.s_simplex;simplex.ReadCache(cache,proxyA,transformA,proxyB,transformB);var vertices=simplex.m_vertices,k_maxIters=20,saveA=b2Distance.s_saveA,saveB=b2Distance.s_saveB,saveCount=0,closestPoint=simplex.GetClosestPoint(),distanceSqr1=closestPoint.LengthSquared(),distanceSqr2=distanceSqr1,i=0,p,iter=0;while(iter<k_maxIters){saveCount=simplex.m_count;for(i=0;i<saveCount;i++){saveA[i]=vertices[i].indexA;saveB[i]=vertices[i].indexB}switch(simplex.m_count){case 1:break;case 2:simplex.Solve2();break;case 3:simplex.Solve3();break;default:b2Settings.b2Assert(false)}if(simplex.m_count==3){break}p=simplex.GetClosestPoint();distanceSqr2=p.LengthSquared();if(distanceSqr2>distanceSqr1){}distanceSqr1=distanceSqr2;var d=simplex.GetSearchDirection();if(d.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE){break}var vertex=vertices[simplex.m_count];vertex.indexA=proxyA.GetSupport(b2Math.MulTMV(transformA.R,d.GetNegative()));vertex.wA=b2Math.MulX(transformA,proxyA.GetVertex(vertex.indexA));vertex.indexB=proxyB.GetSupport(b2Math.MulTMV(transformB.R,d));vertex.wB=b2Math.MulX(transformB,proxyB.GetVertex(vertex.indexB));vertex.w=b2Math.SubtractVV(vertex.wB,vertex.wA);++iter;++b2Distance.b2_gjkIters;var duplicate=false;for(i=0;i<saveCount;i++){if(vertex.indexA==saveA[i]&&vertex.indexB==saveB[i]){duplicate=true;break}}if(duplicate){break}++simplex.m_count}b2Distance.b2_gjkMaxIters=b2Math.Max(b2Distance.b2_gjkMaxIters,iter);simplex.GetWitnessPoints(output.pointA,output.pointB);output.distance=b2Math.SubtractVV(output.pointA,output.pointB).Length();output.iterations=iter;simplex.WriteCache(cache);if(input.useRadii){var rA=proxyA.m_radius,rB=proxyB.m_radius;if(output.distance>rA+rB&&output.distance>Number.MIN_VALUE){output.distance-=rA+rB;var normal=b2Math.SubtractVV(output.pointB,output.pointA);normal.Normalize();output.pointA.x+=rA*normal.x;output.pointA.y+=rA*normal.y;output.pointB.x-=rB*normal.x;output.pointB.y-=rB*normal.y}else{p=new b2Vec2;p.x=.5*(output.pointA.x+output.pointB.x);p.y=.5*(output.pointA.y+output.pointB.y);output.pointA.x=output.pointB.x=p.x;output.pointA.y=output.pointB.y=p.y;output.distance=0}}};b2DistanceInput=Box2D.Collision.b2DistanceInput=function b2DistanceInput(){};b2DistanceInput.constructor=b2DistanceInput;b2DistanceOutput=Box2D.Collision.b2DistanceOutput=function b2DistanceOutput(){this.pointA=new b2Vec2;this.pointB=new b2Vec2};b2DistanceOutput.constructor=b2DistanceOutput;b2DistanceProxy=Box2D.Collision.b2DistanceProxy=function b2DistanceProxy(){};b2DistanceProxy.constructor=b2DistanceProxy;b2DistanceProxy.prototype.Set=function(shape){switch(shape.GetType()){case b2Shape.e_circleShape:{var circle=shape instanceof b2CircleShape?shape:null;this.m_vertices=new Vector(1,true);this.m_vertices[0]=circle.m_p;this.m_count=1;this.m_radius=circle.m_radius}break;case b2Shape.e_polygonShape:{var polygon=shape instanceof b2PolygonShape?shape:null;this.m_vertices=polygon.m_vertices;this.m_count=polygon.m_vertexCount;this.m_radius=polygon.m_radius}break;default:b2Settings.b2Assert(false)}};b2DistanceProxy.prototype.GetSupport=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_count;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return bestIndex};b2DistanceProxy.prototype.GetSupportVertex=function(d){var bestIndex=0,bestValue=this.m_vertices[0].x*d.x+this.m_vertices[0].y*d.y;for(var i=1;i<this.m_count;++i){var value=this.m_vertices[i].x*d.x+this.m_vertices[i].y*d.y;if(value>bestValue){bestIndex=i;bestValue=value}}return this.m_vertices[bestIndex]};b2DistanceProxy.prototype.GetVertexCount=function(){return this.m_count};b2DistanceProxy.prototype.GetVertex=function(index){index=index||0;b2Settings.b2Assert(0<=index&&index<this.m_count);return this.m_vertices[index]};b2DynamicTreeNode=Box2D.Collision.b2DynamicTreeNode=function b2DynamicTreeNode(){this.aabb=new b2AABB};b2DynamicTreeNode.constructor=b2DynamicTreeNode;b2DynamicTreeNode.prototype.IsLeaf=function(){return this.child1==null};b2DynamicTree=Box2D.Collision.b2DynamicTree=function b2DynamicTree(){this.m_root=null;this.m_freeList=null;this.m_path=0;this.m_insertionCount=0};b2DynamicTree.constructor=b2DynamicTree;b2DynamicTree.prototype.CreateProxy=function(aabb,userData){var node=this.AllocateNode(),extendX=b2Settings.b2_aabbExtension,extendY=b2Settings.b2_aabbExtension;node.aabb.lowerBound.x=aabb.lowerBound.x-extendX;node.aabb.lowerBound.y=aabb.lowerBound.y-extendY;node.aabb.upperBound.x=aabb.upperBound.x+extendX;node.aabb.upperBound.y=aabb.upperBound.y+extendY;node.userData=userData;this.InsertLeaf(node);return node};b2DynamicTree.prototype.DestroyProxy=function(proxy){this.RemoveLeaf(proxy);this.FreeNode(proxy)};b2DynamicTree.prototype.MoveProxy=function(proxy,aabb,displacement){b2Settings.b2Assert(proxy.IsLeaf());if(proxy.aabb.Contains(aabb)){return false}this.RemoveLeaf(proxy);var extendX=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(displacement.x>0?displacement.x:-displacement.x),extendY=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(displacement.y>0?displacement.y:-displacement.y);proxy.aabb.lowerBound.x=aabb.lowerBound.x-extendX;proxy.aabb.lowerBound.y=aabb.lowerBound.y-extendY;proxy.aabb.upperBound.x=aabb.upperBound.x+extendX;proxy.aabb.upperBound.y=aabb.upperBound.y+extendY;this.InsertLeaf(proxy);return true};b2DynamicTree.prototype.Rebalance=function(iterations){iterations=iterations||0;if(this.m_root==null)return;for(var i=0;i<iterations;i++){var node=this.m_root,bit=0;while(node.IsLeaf()==false){node=this.m_path>>bit&1?node.child2:node.child1;bit=bit+1&31}++this.m_path;this.RemoveLeaf(node);this.InsertLeaf(node)}};b2DynamicTree.prototype.GetFatAABB=function(proxy){return proxy.aabb};b2DynamicTree.prototype.GetUserData=function(proxy){return proxy.userData};b2DynamicTree.prototype.Query=function(callback,aabb){if(this.m_root==null)return;var stack=new Vector,count=0;stack[count++]=this.m_root;while(count>0){var node=stack[--count];if(node.aabb.TestOverlap(aabb)){if(node.IsLeaf()){var proceed=callback(node);if(!proceed)return}else{stack[count++]=node.child1;stack[count++]=node.child2}}}};b2DynamicTree.prototype.RayCast=function(callback,input){if(this.m_root==null)return;var p1=input.p1,p2=input.p2,r=b2Math.SubtractVV(p1,p2);r.Normalize();var v=b2Math.CrossFV(1,r),abs_v=b2Math.AbsV(v),maxFraction=input.maxFraction,segmentAABB=new b2AABB,tX=0;var tY=0;{tX=p1.x+maxFraction*(p2.x-p1.x);tY=p1.y+maxFraction*(p2.y-p1.y);segmentAABB.lowerBound.x=Math.min(p1.x,tX);segmentAABB.lowerBound.y=Math.min(p1.y,tY);segmentAABB.upperBound.x=Math.max(p1.x,tX);segmentAABB.upperBound.y=Math.max(p1.y,tY)}var stack=new Vector,count=0;stack[count++]=this.m_root;while(count>0){var node=stack[--count];if(node.aabb.TestOverlap(segmentAABB)==false){continue}var c=node.aabb.GetCenter(),h=node.aabb.GetExtents(),separation=Math.abs(v.x*(p1.x-c.x)+v.y*(p1.y-c.y))-abs_v.x*h.x-abs_v.y*h.y;if(separation>0)continue;if(node.IsLeaf()){var subInput=new b2RayCastInput;subInput.p1=input.p1;subInput.p2=input.p2;subInput.maxFraction=input.maxFraction;maxFraction=callback(subInput,node);if(maxFraction==0)return;if(maxFraction>0){tX=p1.x+maxFraction*(p2.x-p1.x);tY=p1.y+maxFraction*(p2.y-p1.y);segmentAABB.lowerBound.x=Math.min(p1.x,tX);segmentAABB.lowerBound.y=Math.min(p1.y,tY);segmentAABB.upperBound.x=Math.max(p1.x,tX);segmentAABB.upperBound.y=Math.max(p1.y,tY)}}else{stack[count++]=node.child1;stack[count++]=node.child2}}};b2DynamicTree.prototype.AllocateNode=function(){if(this.m_freeList){var node=this.m_freeList;this.m_freeList=node.parent;node.parent=null;node.child1=null;node.child2=null;return node}return new b2DynamicTreeNode};b2DynamicTree.prototype.FreeNode=function(node){node.parent=this.m_freeList;this.m_freeList=node};b2DynamicTree.prototype.InsertLeaf=function(leaf){++this.m_insertionCount;if(this.m_root==null){this.m_root=leaf;this.m_root.parent=null;return}var center=leaf.aabb.GetCenter(),sibling=this.m_root;if(sibling.IsLeaf()==false){do{var child1=sibling.child1,child2=sibling.child2,norm1=Math.abs((child1.aabb.lowerBound.x+child1.aabb.upperBound.x)/2-center.x)+Math.abs((child1.aabb.lowerBound.y+child1.aabb.upperBound.y)/2-center.y),norm2=Math.abs((child2.aabb.lowerBound.x+child2.aabb.upperBound.x)/2-center.x)+Math.abs((child2.aabb.lowerBound.y+child2.aabb.upperBound.y)/2-center.y);if(norm1<norm2){sibling=child1}else{sibling=child2}}while(sibling.IsLeaf()==false)}var node1=sibling.parent,node2=this.AllocateNode();node2.parent=node1;node2.userData=null;node2.aabb.Combine(leaf.aabb,sibling.aabb);if(node1){if(sibling.parent.child1==sibling){node1.child1=node2}else{node1.child2=node2}node2.child1=sibling;node2.child2=leaf;sibling.parent=node2;leaf.parent=node2;do{if(node1.aabb.Contains(node2.aabb))break;node1.aabb.Combine(node1.child1.aabb,node1.child2.aabb);node2=node1;node1=node1.parent}while(node1)}else{node2.child1=sibling;node2.child2=leaf;sibling.parent=node2;leaf.parent=node2;this.m_root=node2}};b2DynamicTree.prototype.RemoveLeaf=function(leaf){if(leaf==this.m_root){this.m_root=null;return}var node2=leaf.parent,node1=node2.parent,sibling;if(node2.child1==leaf){sibling=node2.child2}else{sibling=node2.child1}if(node1){if(node1.child1==node2){node1.child1=sibling}else{node1.child2=sibling}sibling.parent=node1;this.FreeNode(node2);while(node1){var oldAABB=node1.aabb;node1.aabb=b2AABB.Combine(node1.child1.aabb,node1.child2.aabb);if(oldAABB.Contains(node1.aabb))break;node1=node1.parent}}else{this.m_root=sibling;sibling.parent=null;this.FreeNode(node2)}};b2DynamicTreePair=Box2D.Collision.b2DynamicTreePair=function b2DynamicTreePair(){};b2DynamicTreePair.constructor=b2DynamicTreePair;b2DynamicTreeBroadPhase=Box2D.Collision.b2DynamicTreeBroadPhase=function b2DynamicTreeBroadPhase(){this.m_tree=new b2DynamicTree;this.m_moveBuffer=new Vector;this.m_pairBuffer=new Vector;this.m_pairCount=0};b2DynamicTreeBroadPhase.constructor=b2DynamicTreeBroadPhase;b2DynamicTreeBroadPhase.prototype.CreateProxy=function(aabb,userData){var proxy=this.m_tree.CreateProxy(aabb,userData);++this.m_proxyCount;this.BufferMove(proxy);return proxy};b2DynamicTreeBroadPhase.prototype.DestroyProxy=function(proxy){this.UnBufferMove(proxy);--this.m_proxyCount;this.m_tree.DestroyProxy(proxy)};b2DynamicTreeBroadPhase.prototype.MoveProxy=function(proxy,aabb,displacement){var buffer=this.m_tree.MoveProxy(proxy,aabb,displacement);if(buffer){this.BufferMove(proxy)}};b2DynamicTreeBroadPhase.prototype.TestOverlap=function(proxyA,proxyB){var aabbA=this.m_tree.GetFatAABB(proxyA),aabbB=this.m_tree.GetFatAABB(proxyB);return aabbA.TestOverlap(aabbB)};b2DynamicTreeBroadPhase.prototype.GetUserData=function(proxy){return this.m_tree.GetUserData(proxy)};b2DynamicTreeBroadPhase.prototype.GetFatAABB=function(proxy){return this.m_tree.GetFatAABB(proxy)
};b2DynamicTreeBroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount};b2DynamicTreeBroadPhase.prototype.UpdatePairs=function(callback){var __this=this;__this.m_pairCount=0;var i=0,queryProxy;for(i=0;i<__this.m_moveBuffer.length;++i){queryProxy=__this.m_moveBuffer[i];function QueryCallback(proxy){if(proxy==queryProxy)return true;if(__this.m_pairCount==__this.m_pairBuffer.length){__this.m_pairBuffer[__this.m_pairCount]=new b2DynamicTreePair}var pair=__this.m_pairBuffer[__this.m_pairCount];pair.proxyA=proxy<queryProxy?proxy:queryProxy;pair.proxyB=proxy>=queryProxy?proxy:queryProxy;++__this.m_pairCount;return true}var fatAABB=__this.m_tree.GetFatAABB(queryProxy);__this.m_tree.Query(QueryCallback,fatAABB)}__this.m_moveBuffer.length=0;for(var i=0;i<__this.m_pairCount;){var primaryPair=__this.m_pairBuffer[i],userDataA=__this.m_tree.GetUserData(primaryPair.proxyA),userDataB=__this.m_tree.GetUserData(primaryPair.proxyB);callback(userDataA,userDataB);++i;while(i<__this.m_pairCount){var pair=__this.m_pairBuffer[i];if(pair.proxyA!=primaryPair.proxyA||pair.proxyB!=primaryPair.proxyB){break}++i}}};b2DynamicTreeBroadPhase.prototype.Query=function(callback,aabb){this.m_tree.Query(callback,aabb)};b2DynamicTreeBroadPhase.prototype.RayCast=function(callback,input){this.m_tree.RayCast(callback,input)};b2DynamicTreeBroadPhase.prototype.Validate=function(){};b2DynamicTreeBroadPhase.prototype.Rebalance=function(iterations){iterations=iterations||0;this.m_tree.Rebalance(iterations)};b2DynamicTreeBroadPhase.prototype.BufferMove=function(proxy){this.m_moveBuffer[this.m_moveBuffer.length]=proxy};b2DynamicTreeBroadPhase.prototype.UnBufferMove=function(proxy){var i=parseInt(this.m_moveBuffer.indexOf(proxy));this.m_moveBuffer.splice(i,1)};b2DynamicTreeBroadPhase.prototype.ComparePairs=function(pair1,pair2){return 0};b2Point=Box2D.Collision.b2Point=function b2Point(){this.p=new b2Vec2};b2Point.constructor=b2Point;b2Point.prototype.Support=function(xf,vX,vY){vX=vX||0;vY=vY||0;return this.p};b2Point.prototype.GetFirstVertex=function(xf){return this.p};b2RayCastInput=Box2D.Collision.b2RayCastInput=function b2RayCastInput(p1,p2,maxFraction){this.p1=new b2Vec2;this.p2=new b2Vec2;p1=p1||null;p2=p2||null;maxFraction=maxFraction||1;if(p1)this.p1.SetV(p1);if(p2)this.p2.SetV(p2);this.maxFraction=maxFraction};b2RayCastInput.constructor=b2RayCastInput;b2RayCastOutput=Box2D.Collision.b2RayCastOutput=function b2RayCastOutput(){this.normal=new b2Vec2};b2RayCastOutput.constructor=b2RayCastOutput;b2Segment=Box2D.Collision.b2Segment=function b2Segment(){this.p1=new b2Vec2;this.p2=new b2Vec2};b2Segment.constructor=b2Segment;b2Segment.prototype.TestSegment=function(lambda,normal,segment,maxLambda){maxLambda=maxLambda||0;var s=segment.p1,rX=segment.p2.x-s.x,rY=segment.p2.y-s.y,dX=this.p2.x-this.p1.x,dY=this.p2.y-this.p1.y,nX=dY,nY=-dX,k_slop=100*Number.MIN_VALUE,denom=-(rX*nX+rY*nY);if(denom>k_slop){var bX=s.x-this.p1.x,bY=s.y-this.p1.y,a=bX*nX+bY*nY;if(0<=a&&a<=maxLambda*denom){var mu2=-rX*bY+rY*bX;if(-k_slop*denom<=mu2&&mu2<=denom*(1+k_slop)){a/=denom;var nLen=Math.sqrt(nX*nX+nY*nY);nX/=nLen;nY/=nLen;lambda[0]=a;normal.Set(nX,nY);return true}}}return false};b2Segment.prototype.Extend=function(aabb){this.ExtendForward(aabb);this.ExtendBackward(aabb)};b2Segment.prototype.ExtendForward=function(aabb){var dX=this.p2.x-this.p1.x,dY=this.p2.y-this.p1.y;var lambda=Math.min(dX>0?(aabb.upperBound.x-this.p1.x)/dX:dX<0?(aabb.lowerBound.x-this.p1.x)/dX:Number.POSITIVE_INFINITY,dY>0?(aabb.upperBound.y-this.p1.y)/dY:dY<0?(aabb.lowerBound.y-this.p1.y)/dY:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+dX*lambda;this.p2.y=this.p1.y+dY*lambda};b2Segment.prototype.ExtendBackward=function(aabb){var dX=-this.p2.x+this.p1.x,dY=-this.p2.y+this.p1.y;var lambda=Math.min(dX>0?(aabb.upperBound.x-this.p2.x)/dX:dX<0?(aabb.lowerBound.x-this.p2.x)/dX:Number.POSITIVE_INFINITY,dY>0?(aabb.upperBound.y-this.p2.y)/dY:dY<0?(aabb.lowerBound.y-this.p2.y)/dY:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+dX*lambda;this.p1.y=this.p2.y+dY*lambda};b2SeparationFunction=Box2D.Collision.b2SeparationFunction=function b2SeparationFunction(){this.m_localPoint=new b2Vec2;this.m_axis=new b2Vec2};b2SeparationFunction.constructor=b2SeparationFunction;b2SeparationFunction.e_points=1;b2SeparationFunction.e_faceA=2;b2SeparationFunction.e_faceB=4;b2SeparationFunction.prototype.Initialize=function(cache,proxyA,transformA,proxyB,transformB){this.m_proxyA=proxyA;this.m_proxyB=proxyB;var count=parseInt(cache.count);b2Settings.b2Assert(0<count&&count<3);var localPointA,localPointA1,localPointA2,localPointB,localPointB1,localPointB2,pointAX=0,pointAY=0,pointBX=0,pointBY=0,normalX=0,normalY=0,tMat,tVec,s=0,sgn=0;if(count==1){this.m_type=b2SeparationFunction.e_points;localPointA=this.m_proxyA.GetVertex(cache.indexA[0]);localPointB=this.m_proxyB.GetVertex(cache.indexB[0]);tVec=localPointA;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointB;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);this.m_axis.x=pointBX-pointAX;this.m_axis.y=pointBY-pointAY;this.m_axis.Normalize()}else if(cache.indexB[0]==cache.indexB[1]){this.m_type=b2SeparationFunction.e_faceA;localPointA1=this.m_proxyA.GetVertex(cache.indexA[0]);localPointA2=this.m_proxyA.GetVertex(cache.indexA[1]);localPointB=this.m_proxyB.GetVertex(cache.indexB[0]);this.m_localPoint.x=.5*(localPointA1.x+localPointA2.x);this.m_localPoint.y=.5*(localPointA1.y+localPointA2.y);this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointA2,localPointA1),1);this.m_axis.Normalize();tVec=this.m_axis;tMat=transformA.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointB;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);s=(pointBX-pointAX)*normalX+(pointBY-pointAY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}else if(cache.indexA[0]==cache.indexA[0]){this.m_type=b2SeparationFunction.e_faceB;localPointB1=this.m_proxyB.GetVertex(cache.indexB[0]);localPointB2=this.m_proxyB.GetVertex(cache.indexB[1]);localPointA=this.m_proxyA.GetVertex(cache.indexA[0]);this.m_localPoint.x=.5*(localPointB1.x+localPointB2.x);this.m_localPoint.y=.5*(localPointB1.y+localPointB2.y);this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointB2,localPointB1),1);this.m_axis.Normalize();tVec=this.m_axis;tMat=transformB.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointA;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);s=(pointAX-pointBX)*normalX+(pointAY-pointBY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}else{localPointA1=this.m_proxyA.GetVertex(cache.indexA[0]);localPointA2=this.m_proxyA.GetVertex(cache.indexA[1]);localPointB1=this.m_proxyB.GetVertex(cache.indexB[0]);localPointB2=this.m_proxyB.GetVertex(cache.indexB[1]);var pA=b2Math.MulX(transformA,localPointA),dA=b2Math.MulMV(transformA.R,b2Math.SubtractVV(localPointA2,localPointA1)),pB=b2Math.MulX(transformB,localPointB),dB=b2Math.MulMV(transformB.R,b2Math.SubtractVV(localPointB2,localPointB1)),a=dA.x*dA.x+dA.y*dA.y,e=dB.x*dB.x+dB.y*dB.y,r=b2Math.SubtractVV(dB,dA),c=dA.x*r.x+dA.y*r.y,f=dB.x*r.x+dB.y*r.y,b=dA.x*dB.x+dA.y*dB.y,denom=a*e-b*b;s=0;if(denom!=0){s=b2Math.Clamp((b*f-c*e)/denom,0,1)}var t=(b*s+f)/e;if(t<0){t=0;s=b2Math.Clamp((b-c)/a,0,1)}localPointA=new b2Vec2;localPointA.x=localPointA1.x+s*(localPointA2.x-localPointA1.x);localPointA.y=localPointA1.y+s*(localPointA2.y-localPointA1.y);localPointB=new b2Vec2;localPointB.x=localPointB1.x+s*(localPointB2.x-localPointB1.x);localPointB.y=localPointB1.y+s*(localPointB2.y-localPointB1.y);if(s==0||s==1){this.m_type=b2SeparationFunction.e_faceB;this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointB2,localPointB1),1);this.m_axis.Normalize();this.m_localPoint=localPointB;tVec=this.m_axis;tMat=transformB.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointA;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);sgn=(pointAX-pointBX)*normalX+(pointAY-pointBY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}else{this.m_type=b2SeparationFunction.e_faceA;this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(localPointA2,localPointA1),1);this.m_localPoint=localPointA;tVec=this.m_axis;tMat=transformA.R;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tVec=this.m_localPoint;tMat=transformA.R;pointAX=transformA.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointAY=transformA.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tVec=localPointB;tMat=transformB.R;pointBX=transformB.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);pointBY=transformB.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);sgn=(pointBX-pointAX)*normalX+(pointBY-pointAY)*normalY;if(s<0){this.m_axis.NegativeSelf()}}}};b2SeparationFunction.prototype.Evaluate=function(transformA,transformB){var axisA,axisB,localPointA,localPointB,pointA,pointB,seperation=0,normal;switch(this.m_type){case b2SeparationFunction.e_points:{axisA=b2Math.MulTMV(transformA.R,this.m_axis);axisB=b2Math.MulTMV(transformB.R,this.m_axis.GetNegative());localPointA=this.m_proxyA.GetSupportVertex(axisA);localPointB=this.m_proxyB.GetSupportVertex(axisB);pointA=b2Math.MulX(transformA,localPointA);pointB=b2Math.MulX(transformB,localPointB);seperation=(pointB.x-pointA.x)*this.m_axis.x+(pointB.y-pointA.y)*this.m_axis.y;return seperation}case b2SeparationFunction.e_faceA:{normal=b2Math.MulMV(transformA.R,this.m_axis);pointA=b2Math.MulX(transformA,this.m_localPoint);axisB=b2Math.MulTMV(transformB.R,normal.GetNegative());localPointB=this.m_proxyB.GetSupportVertex(axisB);pointB=b2Math.MulX(transformB,localPointB);seperation=(pointB.x-pointA.x)*normal.x+(pointB.y-pointA.y)*normal.y;return seperation}case b2SeparationFunction.e_faceB:{normal=b2Math.MulMV(transformB.R,this.m_axis);pointB=b2Math.MulX(transformB,this.m_localPoint);axisA=b2Math.MulTMV(transformA.R,normal.GetNegative());localPointA=this.m_proxyA.GetSupportVertex(axisA);pointA=b2Math.MulX(transformA,localPointA);seperation=(pointA.x-pointB.x)*normal.x+(pointA.y-pointB.y)*normal.y;return seperation}default:b2Settings.b2Assert(false);return 0}};b2TimeOfImpact=Box2D.Collision.b2TimeOfImpact=function b2TimeOfImpact(){};b2TimeOfImpact.constructor=b2TimeOfImpact;b2TimeOfImpact.b2_toiCalls=0;b2TimeOfImpact.b2_toiIters=0;b2TimeOfImpact.b2_toiMaxIters=0;b2TimeOfImpact.b2_toiRootIters=0;b2TimeOfImpact.b2_toiMaxRootIters=0;b2TimeOfImpact.s_cache=new b2SimplexCache;b2TimeOfImpact.s_distanceInput=new b2DistanceInput;b2TimeOfImpact.s_xfA=new b2Transform;b2TimeOfImpact.s_xfB=new b2Transform;b2TimeOfImpact.s_fcn=new b2SeparationFunction;b2TimeOfImpact.s_distanceOutput=new b2DistanceOutput;b2TimeOfImpact.TimeOfImpact=function(input){++b2TimeOfImpact.b2_toiCalls;var proxyA=input.proxyA,proxyB=input.proxyB,sweepA=input.sweepA,sweepB=input.sweepB;b2Settings.b2Assert(sweepA.t0==sweepB.t0);b2Settings.b2Assert(1-sweepA.t0>Number.MIN_VALUE);var radius=proxyA.m_radius+proxyB.m_radius,tolerance=input.tolerance,alpha=0,k_maxIterations=1e3,iter=0,target=0;b2TimeOfImpact.s_cache.count=0;b2TimeOfImpact.s_distanceInput.useRadii=false;for(;;){sweepA.GetTransform(b2TimeOfImpact.s_xfA,alpha);sweepB.GetTransform(b2TimeOfImpact.s_xfB,alpha);b2TimeOfImpact.s_distanceInput.proxyA=proxyA;b2TimeOfImpact.s_distanceInput.proxyB=proxyB;b2TimeOfImpact.s_distanceInput.transformA=b2TimeOfImpact.s_xfA;b2TimeOfImpact.s_distanceInput.transformB=b2TimeOfImpact.s_xfB;b2Distance.Distance(b2TimeOfImpact.s_distanceOutput,b2TimeOfImpact.s_cache,b2TimeOfImpact.s_distanceInput);if(b2TimeOfImpact.s_distanceOutput.distance<=0){alpha=1;break}b2TimeOfImpact.s_fcn.Initialize(b2TimeOfImpact.s_cache,proxyA,b2TimeOfImpact.s_xfA,proxyB,b2TimeOfImpact.s_xfB);var separation=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(separation<=0){alpha=1;break}if(iter==0){if(separation>radius){target=b2Math.Max(radius-tolerance,.75*radius)}else{target=b2Math.Max(separation-tolerance,.02*radius)}}if(separation-target<.5*tolerance){if(iter==0){alpha=1;break}break}var newAlpha=alpha;{var x1=alpha,x2=1,f1=separation;sweepA.GetTransform(b2TimeOfImpact.s_xfA,x2);sweepB.GetTransform(b2TimeOfImpact.s_xfB,x2);var f2=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(f2>=target){alpha=1;break}var rootIterCount=0;for(;;){var x=0;if(rootIterCount&1){x=x1+(target-f1)*(x2-x1)/(f2-f1)}else{x=.5*(x1+x2)}sweepA.GetTransform(b2TimeOfImpact.s_xfA,x);sweepB.GetTransform(b2TimeOfImpact.s_xfB,x);var f=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(b2Math.Abs(f-target)<.025*tolerance){newAlpha=x;break}if(f>target){x1=x;f1=f}else{x2=x;f2=f}++rootIterCount;++b2TimeOfImpact.b2_toiRootIters;if(rootIterCount==50){break}}b2TimeOfImpact.b2_toiMaxRootIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxRootIters,rootIterCount)}if(newAlpha<(1+100*Number.MIN_VALUE)*alpha){break}alpha=newAlpha;iter++;++b2TimeOfImpact.b2_toiIters;if(iter==k_maxIterations){break}}b2TimeOfImpact.b2_toiMaxIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxIters,iter);return alpha};b2TOIInput=Box2D.Collision.b2TOIInput=function b2TOIInput(){this.proxyA=new b2DistanceProxy;this.proxyB=new b2DistanceProxy;this.sweepA=new b2Sweep;this.sweepB=new b2Sweep};b2TOIInput.constructor=b2TOIInput;b2WorldManifold=Box2D.Collision.b2WorldManifold=function b2WorldManifold(){this.m_normal=new b2Vec2;this.m_points=new Vector(b2Settings.b2_maxManifoldPoints);for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.m_points[i]=new b2Vec2}};b2WorldManifold.constructor=b2WorldManifold;b2WorldManifold.prototype.Initialize=function(manifold,xfA,radiusA,xfB,radiusB){radiusA=radiusA||0;radiusB=radiusB||0;if(manifold.m_pointCount==0){return}var i=0,tVec,tMat,normalX=0,normalY=0,planePointX=0,planePointY=0,clipPointX=0,clipPointY=0;switch(manifold.m_type){case b2Manifold.e_circles:{tMat=xfA.R;tVec=manifold.m_localPoint;var pointAX=xfA.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,pointAY=xfA.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xfB.R;tVec=manifold.m_points[0].m_localPoint;var pointBX=xfB.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y,pointBY=xfB.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y,dX=pointBX-pointAX,dY=pointBY-pointAY,d2=dX*dX+dY*dY;if(d2>Number.MIN_VALUE*Number.MIN_VALUE){var d=Math.sqrt(d2);this.m_normal.x=dX/d;this.m_normal.y=dY/d}else{this.m_normal.x=1;this.m_normal.y=0}var cAX=pointAX+radiusA*this.m_normal.x,cAY=pointAY+radiusA*this.m_normal.y,cBX=pointBX-radiusB*this.m_normal.x,cBY=pointBY-radiusB*this.m_normal.y;this.m_points[0].x=.5*(cAX+cBX);this.m_points[0].y=.5*(cAY+cBY)}break;case b2Manifold.e_faceA:{tMat=xfA.R;tVec=manifold.m_localPlaneNormal;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xfA.R;tVec=manifold.m_localPoint;planePointX=xfA.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;planePointY=xfA.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_normal.x=normalX;this.m_normal.y=normalY;for(i=0;i<manifold.m_pointCount;i++){tMat=xfB.R;tVec=manifold.m_points[i].m_localPoint;clipPointX=xfB.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;clipPointY=xfB.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_points[i].x=clipPointX+.5*(radiusA-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusB)*normalX;this.m_points[i].y=clipPointY+.5*(radiusA-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusB)*normalY}}break;case b2Manifold.e_faceB:{tMat=xfB.R;tVec=manifold.m_localPlaneNormal;normalX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;normalY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=xfB.R;tVec=manifold.m_localPoint;planePointX=xfB.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;planePointY=xfB.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_normal.x=-normalX;this.m_normal.y=-normalY;for(i=0;i<manifold.m_pointCount;i++){tMat=xfA.R;tVec=manifold.m_points[i].m_localPoint;clipPointX=xfA.position.x+tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;clipPointY=xfA.position.y+tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_points[i].x=clipPointX+.5*(radiusB-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusA)*normalX;this.m_points[i].y=clipPointY+.5*(radiusB-(clipPointX-planePointX)*normalX-(clipPointY-planePointY)*normalY-radiusA)*normalY}}break}};b2FilterData=Box2D.Dynamics.b2FilterData=function b2FilterData(){this.categoryBits=1;this.maskBits=65535;this.groupIndex=0};b2FilterData.constructor=b2FilterData;b2FilterData.prototype.Copy=function(){var copy=new b2FilterData;copy.categoryBits=this.categoryBits;copy.maskBits=this.maskBits;copy.groupIndex=this.groupIndex;return copy};b2TimeStep=Box2D.Dynamics.b2TimeStep=function b2TimeStep(){};b2TimeStep.constructor=b2TimeStep;b2TimeStep.prototype.Set=function(step){this.dt=step.dt;this.inv_dt=step.inv_dt;this.positionIterations=step.positionIterations;this.velocityIterations=step.velocityIterations;this.warmStarting=step.warmStarting};b2ContactRegister=Box2D.Dynamics.Contacts.b2ContactRegister=function b2ContactRegister(){};b2ContactRegister.constructor=b2ContactRegister;b2ContactResult=Box2D.Dynamics.Contacts.b2ContactResult=function b2ContactResult(){this.position=new b2Vec2;this.normal=new b2Vec2;this.id=new b2ContactID};b2ContactResult.constructor=b2ContactResult;b2ContactEdge=Box2D.Dynamics.Contacts.b2ContactEdge=function b2ContactEdge(){};b2ContactEdge.constructor=b2ContactEdge;b2ContactConstraintPoint=Box2D.Dynamics.Contacts.b2ContactConstraintPoint=function b2ContactConstraintPoint(){this.localPoint=new b2Vec2;this.rA=new b2Vec2;this.rB=new b2Vec2};b2ContactConstraintPoint.constructor=b2ContactConstraintPoint;b2ContactConstraint=Box2D.Dynamics.Contacts.b2ContactConstraint=function b2ContactConstraint(){this.localPlaneNormal=new b2Vec2;this.localPoint=new b2Vec2;this.normal=new b2Vec2;this.normalMass=new b2Mat22;this.K=new b2Mat22;this.points=new Vector(b2Settings.b2_maxManifoldPoints);for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.points[i]=new b2ContactConstraintPoint}};b2ContactConstraint.constructor=b2ContactConstraint;b2Contact=Box2D.Dynamics.Contacts.b2Contact=function b2Contact(){this.m_nodeA=new b2ContactEdge;this.m_nodeB=new b2ContactEdge;this.m_manifold=new b2Manifold;this.m_oldManifold=new b2Manifold};b2Contact.constructor=b2Contact;b2Contact.e_sensorFlag=1;b2Contact.e_continuousFlag=2;b2Contact.e_islandFlag=4;b2Contact.e_toiFlag=8;b2Contact.e_touchingFlag=16;b2Contact.e_enabledFlag=32;b2Contact.e_filterFlag=64;b2Contact.s_input=new b2TOIInput;b2Contact.prototype.GetManifold=function(){return this.m_manifold};b2Contact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2Contact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2Contact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2Contact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2Contact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2Contact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2Contact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2Contact.prototype.GetNext=function(){return this.m_next};b2Contact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2Contact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2Contact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2Contact.prototype.Reset=function(fixtureA,fixtureB){fixtureA=fixtureA||null;fixtureB=fixtureB||null;this.m_flags=b2Contact.e_enabledFlag;if(!fixtureA||!fixtureB){this.m_fixtureA=null;this.m_fixtureB=null;return}if(fixtureA.IsSensor()||fixtureB.IsSensor()){this.m_flags|=b2Contact.e_sensorFlag}var bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}this.m_fixtureA=fixtureA;this.m_fixtureB=fixtureB;this.m_manifold.m_pointCount=0;this.m_prev=null;this.m_next=null;this.m_nodeA.contact=null;this.m_nodeA.prev=null;this.m_nodeA.next=null;this.m_nodeA.other=null;this.m_nodeB.contact=null;this.m_nodeB.prev=null;this.m_nodeB.next=null;this.m_nodeB.other=null};b2Contact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2Contact.prototype.Evaluate=function(){};b2Contact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2CircleContact=Box2D.Dynamics.Contacts.b2CircleContact=function b2CircleContact(){b2Contact.apply(this,arguments)};b2CircleContact.constructor=b2CircleContact;b2CircleContact.prototype=Object.create(b2Contact.prototype);b2CircleContact.Create=function(allocator){return new b2CircleContact};b2CircleContact.Destroy=function(contact,allocator){};b2CircleContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB)};b2CircleContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();b2Collision.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2CircleShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2CircleShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2CircleContact.prototype.GetManifold=function(){return this.m_manifold};b2CircleContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2CircleContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2CircleContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2CircleContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2CircleContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2CircleContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2CircleContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2CircleContact.prototype.GetNext=function(){return this.m_next};b2CircleContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2CircleContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2CircleContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2CircleContact.prototype.b2Contact=function(){};b2CircleContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2CircleContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PositionSolverManifold=Box2D.Dynamics.Contacts.b2PositionSolverManifold=function b2PositionSolverManifold(){this.m_normal=new b2Vec2;this.m_separations=new Vector_a2j_Number(b2Settings.b2_maxManifoldPoints);this.m_points=new Vector(b2Settings.b2_maxManifoldPoints);for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.m_points[i]=new b2Vec2}};b2PositionSolverManifold.constructor=b2PositionSolverManifold;b2PositionSolverManifold.circlePointA=new b2Vec2;b2PositionSolverManifold.circlePointB=new b2Vec2;b2PositionSolverManifold.prototype.Initialize=function(cc){b2Settings.b2Assert(cc.pointCount>0);var i=0,clipPointX=0,clipPointY=0,tMat,tVec,planePointX=0,planePointY=0;switch(cc.type){case b2Manifold.e_circles:{tMat=cc.bodyA.m_xf.R;tVec=cc.localPoint;var pointAX=cc.bodyA.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),pointAY=cc.bodyA.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=cc.bodyB.m_xf.R;tVec=cc.points[0].localPoint;var pointBX=cc.bodyB.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y),pointBY=cc.bodyB.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y),dX=pointBX-pointAX,dY=pointBY-pointAY,d2=dX*dX+dY*dY;if(d2>Number.MIN_VALUE*Number.MIN_VALUE){var d=Math.sqrt(d2);this.m_normal.x=dX/d;this.m_normal.y=dY/d}else{this.m_normal.x=1;this.m_normal.y=0}this.m_points[0].x=.5*(pointAX+pointBX);this.m_points[0].y=.5*(pointAY+pointBY);this.m_separations[0]=dX*this.m_normal.x+dY*this.m_normal.y-cc.radius}break;case b2Manifold.e_faceA:{tMat=cc.bodyA.m_xf.R;tVec=cc.localPlaneNormal;this.m_normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=cc.bodyA.m_xf.R;tVec=cc.localPoint;planePointX=cc.bodyA.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);planePointY=cc.bodyA.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=cc.bodyB.m_xf.R;for(i=0;i<cc.pointCount;++i){tVec=cc.points[i].localPoint;clipPointX=cc.bodyB.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);clipPointY=cc.bodyB.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);this.m_separations[i]=(clipPointX-planePointX)*this.m_normal.x+(clipPointY-planePointY)*this.m_normal.y-cc.radius;this.m_points[i].x=clipPointX;this.m_points[i].y=clipPointY}}break;case b2Manifold.e_faceB:{tMat=cc.bodyB.m_xf.R;tVec=cc.localPlaneNormal;this.m_normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=cc.bodyB.m_xf.R;tVec=cc.localPoint;planePointX=cc.bodyB.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);planePointY=cc.bodyB.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);tMat=cc.bodyA.m_xf.R;for(i=0;i<cc.pointCount;++i){tVec=cc.points[i].localPoint;clipPointX=cc.bodyA.m_xf.position.x+(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);clipPointY=cc.bodyA.m_xf.position.y+(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);this.m_separations[i]=(clipPointX-planePointX)*this.m_normal.x+(clipPointY-planePointY)*this.m_normal.y-cc.radius;this.m_points[i].Set(clipPointX,clipPointY)}this.m_normal.x*=-1;this.m_normal.y*=-1}break}};b2ContactSolver=Box2D.Dynamics.Contacts.b2ContactSolver=function b2ContactSolver(){this.m_step=new b2TimeStep;this.m_constraints=new Vector};b2ContactSolver.constructor=b2ContactSolver;b2ContactSolver.s_worldManifold=new b2WorldManifold;b2ContactSolver.s_psm=new b2PositionSolverManifold;b2ContactSolver.prototype.Initialize=function(step,contacts,contactCount,allocator){contactCount=contactCount||0;var contact;this.m_step.Set(step);this.m_allocator=allocator;var i=0,tVec,tMat;this.m_constraintCount=contactCount;while(this.m_constraints.length<this.m_constraintCount){this.m_constraints[this.m_constraints.length]=new b2ContactConstraint
}for(i=0;i<contactCount;++i){contact=contacts[i];var fixtureA=contact.m_fixtureA,fixtureB=contact.m_fixtureB,shapeA=fixtureA.m_shape,shapeB=fixtureB.m_shape,radiusA=shapeA.m_radius,radiusB=shapeB.m_radius,bodyA=fixtureA.m_body,bodyB=fixtureB.m_body,manifold=contact.GetManifold(),friction=b2Settings.b2MixFriction(fixtureA.GetFriction(),fixtureB.GetFriction()),restitution=b2Settings.b2MixRestitution(fixtureA.GetRestitution(),fixtureB.GetRestitution()),vAX=bodyA.m_linearVelocity.x,vAY=bodyA.m_linearVelocity.y,vBX=bodyB.m_linearVelocity.x,vBY=bodyB.m_linearVelocity.y,wA=bodyA.m_angularVelocity,wB=bodyB.m_angularVelocity;b2Settings.b2Assert(manifold.m_pointCount>0);b2ContactSolver.s_worldManifold.Initialize(manifold,bodyA.m_xf,radiusA,bodyB.m_xf,radiusB);var normalX=b2ContactSolver.s_worldManifold.m_normal.x,normalY=b2ContactSolver.s_worldManifold.m_normal.y,cc=this.m_constraints[i];cc.bodyA=bodyA;cc.bodyB=bodyB;cc.manifold=manifold;cc.normal.x=normalX;cc.normal.y=normalY;cc.pointCount=manifold.m_pointCount;cc.friction=friction;cc.restitution=restitution;cc.localPlaneNormal.x=manifold.m_localPlaneNormal.x;cc.localPlaneNormal.y=manifold.m_localPlaneNormal.y;cc.localPoint.x=manifold.m_localPoint.x;cc.localPoint.y=manifold.m_localPoint.y;cc.radius=radiusA+radiusB;cc.type=manifold.m_type;for(var k=0;k<cc.pointCount;++k){var cp=manifold.m_points[k],ccp=cc.points[k];ccp.normalImpulse=cp.m_normalImpulse;ccp.tangentImpulse=cp.m_tangentImpulse;ccp.localPoint.SetV(cp.m_localPoint);var rAX=ccp.rA.x=b2ContactSolver.s_worldManifold.m_points[k].x-bodyA.m_sweep.c.x,rAY=ccp.rA.y=b2ContactSolver.s_worldManifold.m_points[k].y-bodyA.m_sweep.c.y,rBX=ccp.rB.x=b2ContactSolver.s_worldManifold.m_points[k].x-bodyB.m_sweep.c.x,rBY=ccp.rB.y=b2ContactSolver.s_worldManifold.m_points[k].y-bodyB.m_sweep.c.y,rnA=rAX*normalY-rAY*normalX,rnB=rBX*normalY-rBY*normalX;rnA*=rnA;rnB*=rnB;var kNormal=bodyA.m_invMass+bodyB.m_invMass+bodyA.m_invI*rnA+bodyB.m_invI*rnB;ccp.normalMass=1/kNormal;var kEqualized=bodyA.m_mass*bodyA.m_invMass+bodyB.m_mass*bodyB.m_invMass;kEqualized+=bodyA.m_mass*bodyA.m_invI*rnA+bodyB.m_mass*bodyB.m_invI*rnB;ccp.equalizedMass=1/kEqualized;var tangentX=normalY,tangentY=-normalX,rtA=rAX*tangentY-rAY*tangentX,rtB=rBX*tangentY-rBY*tangentX;rtA*=rtA;rtB*=rtB;var kTangent=bodyA.m_invMass+bodyB.m_invMass+bodyA.m_invI*rtA+bodyB.m_invI*rtB;ccp.tangentMass=1/kTangent;ccp.velocityBias=0;var tX=vBX+-wB*rBY-vAX- -wA*rAY,tY=vBY+wB*rBX-vAY-wA*rAX,vRel=cc.normal.x*tX+cc.normal.y*tY;if(vRel<-b2Settings.b2_velocityThreshold){ccp.velocityBias+=-cc.restitution*vRel}}if(cc.pointCount==2){var ccp1=cc.points[0],ccp2=cc.points[1],invMassA=bodyA.m_invMass,invIA=bodyA.m_invI,invMassB=bodyB.m_invMass,invIB=bodyB.m_invI,rn1A=ccp1.rA.x*normalY-ccp1.rA.y*normalX,rn1B=ccp1.rB.x*normalY-ccp1.rB.y*normalX,rn2A=ccp2.rA.x*normalY-ccp2.rA.y*normalX,rn2B=ccp2.rB.x*normalY-ccp2.rB.y*normalX,k11=invMassA+invMassB+invIA*rn1A*rn1A+invIB*rn1B*rn1B,k22=invMassA+invMassB+invIA*rn2A*rn2A+invIB*rn2B*rn2B,k12=invMassA+invMassB+invIA*rn1A*rn2A+invIB*rn1B*rn2B,k_maxConditionNumber=100;if(k11*k11<k_maxConditionNumber*(k11*k22-k12*k12)){cc.K.col1.Set(k11,k12);cc.K.col2.Set(k12,k22);cc.K.GetInverse(cc.normalMass)}else{cc.pointCount=1}}}};b2ContactSolver.prototype.InitVelocityConstraints=function(step){var tVec,tVec2,tMat;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i],bodyA=c.bodyA,bodyB=c.bodyB,invMassA=bodyA.m_invMass,invIA=bodyA.m_invI,invMassB=bodyB.m_invMass,invIB=bodyB.m_invI,normalX=c.normal.x,normalY=c.normal.y,tangentX=normalY,tangentY=-normalX,tX=0,j=0,tCount=0;if(step.warmStarting){tCount=c.pointCount;for(j=0;j<tCount;++j){var ccp=c.points[j];ccp.normalImpulse*=step.dtRatio;ccp.tangentImpulse*=step.dtRatio;var PX=ccp.normalImpulse*normalX+ccp.tangentImpulse*tangentX,PY=ccp.normalImpulse*normalY+ccp.tangentImpulse*tangentY;bodyA.m_angularVelocity-=invIA*(ccp.rA.x*PY-ccp.rA.y*PX);bodyA.m_linearVelocity.x-=invMassA*PX;bodyA.m_linearVelocity.y-=invMassA*PY;bodyB.m_angularVelocity+=invIB*(ccp.rB.x*PY-ccp.rB.y*PX);bodyB.m_linearVelocity.x+=invMassB*PX;bodyB.m_linearVelocity.y+=invMassB*PY}}else{tCount=c.pointCount;for(j=0;j<tCount;++j){var ccp2=c.points[j];ccp2.normalImpulse=0;ccp2.tangentImpulse=0}}}};b2ContactSolver.prototype.SolveVelocityConstraints=function(){var j=0,ccp,rAX=0,rAY=0,rBX=0,rBY=0,dvX=0,dvY=0,vn=0,vt=0,lambda=0,maxFriction=0,newImpulse=0,PX=0,PY=0,dX=0,dY=0,P1X=0,P1Y=0,P2X=0,P2Y=0,tMat,tVec;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i],bodyA=c.bodyA,bodyB=c.bodyB,wA=bodyA.m_angularVelocity,wB=bodyB.m_angularVelocity,vA=bodyA.m_linearVelocity,vB=bodyB.m_linearVelocity,invMassA=bodyA.m_invMass,invIA=bodyA.m_invI,invMassB=bodyB.m_invMass,invIB=bodyB.m_invI,normalX=c.normal.x,normalY=c.normal.y,tangentX=normalY,tangentY=-normalX,friction=c.friction,tX=0;for(j=0;j<c.pointCount;j++){ccp=c.points[j];dvX=vB.x-wB*ccp.rB.y-vA.x+wA*ccp.rA.y;dvY=vB.y+wB*ccp.rB.x-vA.y-wA*ccp.rA.x;vt=dvX*tangentX+dvY*tangentY;lambda=ccp.tangentMass*-vt;maxFriction=friction*ccp.normalImpulse;newImpulse=b2Math.Clamp(ccp.tangentImpulse+lambda,-maxFriction,maxFriction);lambda=newImpulse-ccp.tangentImpulse;PX=lambda*tangentX;PY=lambda*tangentY;vA.x-=invMassA*PX;vA.y-=invMassA*PY;wA-=invIA*(ccp.rA.x*PY-ccp.rA.y*PX);vB.x+=invMassB*PX;vB.y+=invMassB*PY;wB+=invIB*(ccp.rB.x*PY-ccp.rB.y*PX);ccp.tangentImpulse=newImpulse}var tCount=parseInt(c.pointCount);if(c.pointCount==1){ccp=c.points[0];dvX=vB.x+-wB*ccp.rB.y-vA.x- -wA*ccp.rA.y;dvY=vB.y+wB*ccp.rB.x-vA.y-wA*ccp.rA.x;vn=dvX*normalX+dvY*normalY;lambda=-ccp.normalMass*(vn-ccp.velocityBias);newImpulse=ccp.normalImpulse+lambda;newImpulse=newImpulse>0?newImpulse:0;lambda=newImpulse-ccp.normalImpulse;PX=lambda*normalX;PY=lambda*normalY;vA.x-=invMassA*PX;vA.y-=invMassA*PY;wA-=invIA*(ccp.rA.x*PY-ccp.rA.y*PX);vB.x+=invMassB*PX;vB.y+=invMassB*PY;wB+=invIB*(ccp.rB.x*PY-ccp.rB.y*PX);ccp.normalImpulse=newImpulse}else{var cp1=c.points[0],cp2=c.points[1],aX=cp1.normalImpulse,aY=cp2.normalImpulse,dv1X=vB.x-wB*cp1.rB.y-vA.x+wA*cp1.rA.y,dv1Y=vB.y+wB*cp1.rB.x-vA.y-wA*cp1.rA.x,dv2X=vB.x-wB*cp2.rB.y-vA.x+wA*cp2.rA.y,dv2Y=vB.y+wB*cp2.rB.x-vA.y-wA*cp2.rA.x,vn1=dv1X*normalX+dv1Y*normalY,vn2=dv2X*normalX+dv2Y*normalY,bX=vn1-cp1.velocityBias,bY=vn2-cp2.velocityBias;tMat=c.K;bX-=tMat.col1.x*aX+tMat.col2.x*aY;bY-=tMat.col1.y*aX+tMat.col2.y*aY;var k_errorTol=.001;for(;;){tMat=c.normalMass;var xX=-(tMat.col1.x*bX+tMat.col2.x*bY),xY=-(tMat.col1.y*bX+tMat.col2.y*bY);if(xX>=0&&xY>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}xX=-cp1.normalMass*bX;xY=0;vn1=0;vn2=c.K.col1.y*xX+bY;if(xX>=0&&vn2>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}xX=0;xY=-cp2.normalMass*bY;vn1=c.K.col2.x*xY+bX;vn2=0;if(xY>=0&&vn1>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}xX=0;xY=0;vn1=bX;vn2=bY;if(vn1>=0&&vn2>=0){dX=xX-aX;dY=xY-aY;P1X=dX*normalX;P1Y=dX*normalY;P2X=dY*normalX;P2Y=dY*normalY;vA.x-=invMassA*(P1X+P2X);vA.y-=invMassA*(P1Y+P2Y);wA-=invIA*(cp1.rA.x*P1Y-cp1.rA.y*P1X+cp2.rA.x*P2Y-cp2.rA.y*P2X);vB.x+=invMassB*(P1X+P2X);vB.y+=invMassB*(P1Y+P2Y);wB+=invIB*(cp1.rB.x*P1Y-cp1.rB.y*P1X+cp2.rB.x*P2Y-cp2.rB.y*P2X);cp1.normalImpulse=xX;cp2.normalImpulse=xY;break}break}}bodyA.m_angularVelocity=wA;bodyB.m_angularVelocity=wB}};b2ContactSolver.prototype.FinalizeVelocityConstraints=function(){for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i],m=c.manifold;for(var j=0;j<c.pointCount;++j){var point1=m.m_points[j],point2=c.points[j];point1.m_normalImpulse=point2.normalImpulse;point1.m_tangentImpulse=point2.tangentImpulse}}};b2ContactSolver.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var minSeparation=0;for(var i=0;i<this.m_constraintCount;i++){var c=this.m_constraints[i],bodyA=c.bodyA,bodyB=c.bodyB,invMassA=bodyA.m_mass*bodyA.m_invMass,invIA=bodyA.m_mass*bodyA.m_invI,invMassB=bodyB.m_mass*bodyB.m_invMass,invIB=bodyB.m_mass*bodyB.m_invI;b2ContactSolver.s_psm.Initialize(c);var normal=b2ContactSolver.s_psm.m_normal;for(var j=0;j<c.pointCount;j++){var ccp=c.points[j],point=b2ContactSolver.s_psm.m_points[j],separation=b2ContactSolver.s_psm.m_separations[j],rAX=point.x-bodyA.m_sweep.c.x,rAY=point.y-bodyA.m_sweep.c.y,rBX=point.x-bodyB.m_sweep.c.x,rBY=point.y-bodyB.m_sweep.c.y;minSeparation=minSeparation<separation?minSeparation:separation;var C=b2Math.Clamp(baumgarte*(separation+b2Settings.b2_linearSlop),-b2Settings.b2_maxLinearCorrection,0),impulse=-ccp.equalizedMass*C,PX=impulse*normal.x,PY=impulse*normal.y;bodyA.m_sweep.c.x-=invMassA*PX;bodyA.m_sweep.c.y-=invMassA*PY;bodyA.m_sweep.a-=invIA*(rAX*PY-rAY*PX);bodyA.SynchronizeTransform();bodyB.m_sweep.c.x+=invMassB*PX;bodyB.m_sweep.c.y+=invMassB*PY;bodyB.m_sweep.a+=invIB*(rBX*PY-rBY*PX);bodyB.SynchronizeTransform()}}return minSeparation>-1.5*b2Settings.b2_linearSlop};b2EdgeAndCircleContact=Box2D.Dynamics.Contacts.b2EdgeAndCircleContact=function b2EdgeAndCircleContact(){b2Contact.apply(this,arguments)};b2EdgeAndCircleContact.constructor=b2EdgeAndCircleContact;b2EdgeAndCircleContact.prototype=Object.create(b2Contact.prototype);b2EdgeAndCircleContact.Create=function(allocator){return new b2EdgeAndCircleContact};b2EdgeAndCircleContact.Destroy=function(contact,allocator){};b2EdgeAndCircleContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB)};b2EdgeAndCircleContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2EdgeShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2CircleShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2EdgeAndCircleContact.prototype.b2CollideEdgeAndCircle=function(manifold,edge,xf1,circle,xf2){};b2EdgeAndCircleContact.prototype.GetManifold=function(){return this.m_manifold};b2EdgeAndCircleContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2EdgeAndCircleContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2EdgeAndCircleContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2EdgeAndCircleContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2EdgeAndCircleContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2EdgeAndCircleContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2EdgeAndCircleContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2EdgeAndCircleContact.prototype.GetNext=function(){return this.m_next};b2EdgeAndCircleContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2EdgeAndCircleContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2EdgeAndCircleContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2EdgeAndCircleContact.prototype.b2Contact=function(){};b2EdgeAndCircleContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2EdgeAndCircleContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2NullContact=Box2D.Dynamics.Contacts.b2NullContact=function b2NullContact(){b2Contact.call(this)};b2NullContact.constructor=b2NullContact;b2NullContact.prototype=Object.create(b2Contact.prototype);b2NullContact.prototype.Evaluate=function(){};b2NullContact.prototype.GetManifold=function(){return this.m_manifold};b2NullContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2NullContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2NullContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2NullContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2NullContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2NullContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2NullContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2NullContact.prototype.GetNext=function(){return this.m_next};b2NullContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2NullContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2NullContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2NullContact.prototype.b2Contact=function(){};b2NullContact.prototype.Reset=function(fixtureA,fixtureB){fixtureA=fixtureA||null;fixtureB=fixtureB||null;this.m_flags=b2Contact.e_enabledFlag;if(!fixtureA||!fixtureB){this.m_fixtureA=null;this.m_fixtureB=null;return}if(fixtureA.IsSensor()||fixtureB.IsSensor()){this.m_flags|=b2Contact.e_sensorFlag}var bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}this.m_fixtureA=fixtureA;this.m_fixtureB=fixtureB;this.m_manifold.m_pointCount=0;this.m_prev=null;this.m_next=null;this.m_nodeA.contact=null;this.m_nodeA.prev=null;this.m_nodeA.next=null;this.m_nodeA.other=null;this.m_nodeB.contact=null;this.m_nodeB.prev=null;this.m_nodeB.next=null;this.m_nodeB.other=null};b2NullContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2NullContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PolyAndCircleContact=Box2D.Dynamics.Contacts.b2PolyAndCircleContact=function b2PolyAndCircleContact(){b2Contact.apply(this,arguments)};b2PolyAndCircleContact.constructor=b2PolyAndCircleContact;b2PolyAndCircleContact.prototype=Object.create(b2Contact.prototype);b2PolyAndCircleContact.Create=function(allocator){return new b2PolyAndCircleContact};b2PolyAndCircleContact.Destroy=function(contact,allocator){};b2PolyAndCircleContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB);b2Settings.b2Assert(fixtureA.GetType()==b2Shape.e_polygonShape);b2Settings.b2Assert(fixtureB.GetType()==b2Shape.e_circleShape)};b2PolyAndCircleContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.m_body,bB=this.m_fixtureB.m_body;b2Collision.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2PolygonShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2CircleShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2PolyAndCircleContact.prototype.GetManifold=function(){return this.m_manifold};b2PolyAndCircleContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2PolyAndCircleContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2PolyAndCircleContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2PolyAndCircleContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2PolyAndCircleContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2PolyAndCircleContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2PolyAndCircleContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2PolyAndCircleContact.prototype.GetNext=function(){return this.m_next};b2PolyAndCircleContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2PolyAndCircleContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2PolyAndCircleContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2PolyAndCircleContact.prototype.b2Contact=function(){};b2PolyAndCircleContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2PolyAndCircleContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PolyAndEdgeContact=Box2D.Dynamics.Contacts.b2PolyAndEdgeContact=function b2PolyAndEdgeContact(){b2Contact.apply(this,arguments)};b2PolyAndEdgeContact.constructor=b2PolyAndEdgeContact;b2PolyAndEdgeContact.prototype=Object.create(b2Contact.prototype);b2PolyAndEdgeContact.Create=function(allocator){return new b2PolyAndEdgeContact};b2PolyAndEdgeContact.Destroy=function(contact,allocator){};b2PolyAndEdgeContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB);b2Settings.b2Assert(fixtureA.GetType()==b2Shape.e_polygonShape);b2Settings.b2Assert(fixtureB.GetType()==b2Shape.e_edgeShape)};b2PolyAndEdgeContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2PolygonShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2EdgeShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2PolyAndEdgeContact.prototype.b2CollidePolyAndEdge=function(manifold,polygon,xf1,edge,xf2){};b2PolyAndEdgeContact.prototype.GetManifold=function(){return this.m_manifold};b2PolyAndEdgeContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2PolyAndEdgeContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2PolyAndEdgeContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2PolyAndEdgeContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2PolyAndEdgeContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2PolyAndEdgeContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2PolyAndEdgeContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2PolyAndEdgeContact.prototype.GetNext=function(){return this.m_next};b2PolyAndEdgeContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2PolyAndEdgeContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2PolyAndEdgeContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2PolyAndEdgeContact.prototype.b2Contact=function(){};b2PolyAndEdgeContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2PolyAndEdgeContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2PolygonContact=Box2D.Dynamics.Contacts.b2PolygonContact=function b2PolygonContact(){b2Contact.apply(this,arguments)};b2PolygonContact.constructor=b2PolygonContact;b2PolygonContact.prototype=Object.create(b2Contact.prototype);b2PolygonContact.Create=function(allocator){return new b2PolygonContact};b2PolygonContact.Destroy=function(contact,allocator){};b2PolygonContact.prototype.Reset=function(fixtureA,fixtureB){b2Contact.prototype.Reset.call(this,fixtureA,fixtureB)};b2PolygonContact.prototype.Evaluate=function(){var bA=this.m_fixtureA.GetBody(),bB=this.m_fixtureB.GetBody();b2Collision.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape()instanceof b2PolygonShape?this.m_fixtureA.GetShape():null,bA.m_xf,this.m_fixtureB.GetShape()instanceof b2PolygonShape?this.m_fixtureB.GetShape():null,bB.m_xf)};b2PolygonContact.prototype.GetManifold=function(){return this.m_manifold};b2PolygonContact.prototype.GetWorldManifold=function(worldManifold){var bodyA=this.m_fixtureA.GetBody(),bodyB=this.m_fixtureB.GetBody(),shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.m_radius,bodyB.GetTransform(),shapeB.m_radius)};b2PolygonContact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag};b2PolygonContact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag};b2PolygonContact.prototype.SetSensor=function(sensor){if(sensor){this.m_flags|=b2Contact.e_sensorFlag}else{this.m_flags&=~b2Contact.e_sensorFlag}};b2PolygonContact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag};b2PolygonContact.prototype.SetEnabled=function(flag){if(flag){this.m_flags|=b2Contact.e_enabledFlag}else{this.m_flags&=~b2Contact.e_enabledFlag}};b2PolygonContact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag};b2PolygonContact.prototype.GetNext=function(){return this.m_next};b2PolygonContact.prototype.GetFixtureA=function(){return this.m_fixtureA};b2PolygonContact.prototype.GetFixtureB=function(){return this.m_fixtureB};b2PolygonContact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag};b2PolygonContact.prototype.b2Contact=function(){};b2PolygonContact.prototype.Update=function(listener){var tManifold=this.m_oldManifold;this.m_oldManifold=this.m_manifold;this.m_manifold=tManifold;this.m_flags|=b2Contact.e_enabledFlag;var touching=false,wasTouching=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,bodyA=this.m_fixtureA.m_body,bodyB=this.m_fixtureB.m_body,aabbOverlap=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(aabbOverlap){var shapeA=this.m_fixtureA.GetShape(),shapeB=this.m_fixtureB.GetShape(),xfA=bodyA.GetTransform(),xfB=bodyB.GetTransform();touching=b2Shape.TestOverlap(shapeA,xfA,shapeB,xfB)}this.m_manifold.m_pointCount=0}else{if(bodyA.GetType()!=b2Body.b2_dynamicBody||bodyA.IsBullet()||bodyB.GetType()!=b2Body.b2_dynamicBody||bodyB.IsBullet()){this.m_flags|=b2Contact.e_continuousFlag}else{this.m_flags&=~b2Contact.e_continuousFlag}if(aabbOverlap){this.Evaluate();touching=this.m_manifold.m_pointCount>0;for(var i=0;i<this.m_manifold.m_pointCount;++i){var mp2=this.m_manifold.m_points[i];mp2.m_normalImpulse=0;mp2.m_tangentImpulse=0;var id2=mp2.m_id;for(var j=0;j<this.m_oldManifold.m_pointCount;++j){var mp1=this.m_oldManifold.m_points[j];if(mp1.m_id.key==id2.key){mp2.m_normalImpulse=mp1.m_normalImpulse;
mp2.m_tangentImpulse=mp1.m_tangentImpulse;break}}}}else{this.m_manifold.m_pointCount=0}if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true)}}if(touching){this.m_flags|=b2Contact.e_touchingFlag}else{this.m_flags&=~b2Contact.e_touchingFlag}if(wasTouching==false&&touching==true){listener.BeginContact(this)}if(wasTouching==true&&touching==false){listener.EndContact(this)}if((this.m_flags&b2Contact.e_sensorFlag)==0){listener.PreSolve(this,this.m_oldManifold)}};b2PolygonContact.prototype.ComputeTOI=function(sweepA,sweepB){b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());b2Contact.s_input.sweepA=sweepA;b2Contact.s_input.sweepB=sweepB;b2Contact.s_input.tolerance=b2Settings.b2_linearSlop;return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)};b2ContactFactory=Box2D.Dynamics.Contacts.b2ContactFactory=function b2ContactFactory(allocator){this.m_allocator=allocator;this.InitializeRegisters()};b2ContactFactory.constructor=b2ContactFactory;b2ContactFactory.prototype.AddType=function(createFcn,destroyFcn,type1,type2){type1=type1||0;type2=type2||0;this.m_registers[type1][type2].createFcn=createFcn;this.m_registers[type1][type2].destroyFcn=destroyFcn;this.m_registers[type1][type2].primary=true;if(type1!=type2){this.m_registers[type2][type1].createFcn=createFcn;this.m_registers[type2][type1].destroyFcn=destroyFcn;this.m_registers[type2][type1].primary=false}};b2ContactFactory.prototype.InitializeRegisters=function(){this.m_registers=new Vector(b2Shape.e_shapeTypeCount);for(var i=0;i<b2Shape.e_shapeTypeCount;i++){this.m_registers[i]=new Vector(b2Shape.e_shapeTypeCount);for(var j=0;j<b2Shape.e_shapeTypeCount;j++){this.m_registers[i][j]=new b2ContactRegister}}this.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape);this.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_circleShape);this.AddType(b2PolygonContact.Create,b2PolygonContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_polygonShape);this.AddType(b2EdgeAndCircleContact.Create,b2EdgeAndCircleContact.Destroy,b2Shape.e_edgeShape,b2Shape.e_circleShape);this.AddType(b2PolyAndEdgeContact.Create,b2PolyAndEdgeContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_edgeShape)};b2ContactFactory.prototype.Create=function(fixtureA,fixtureB){var type1=parseInt(fixtureA.GetType()),type2=parseInt(fixtureB.GetType()),reg=this.m_registers[type1][type2],c;if(reg.pool){c=reg.pool;reg.pool=c.m_next;reg.poolCount--;c.Reset(fixtureA,fixtureB);return c}var createFcn=reg.createFcn;if(createFcn!=null){if(reg.primary){c=createFcn(this.m_allocator);c.Reset(fixtureA,fixtureB);return c}else{c=createFcn(this.m_allocator);c.Reset(fixtureB,fixtureA);return c}}else{return null}};b2ContactFactory.prototype.Destroy=function(contact){if(contact.m_manifold.m_pointCount>0){contact.m_fixtureA.m_body.SetAwake(true);contact.m_fixtureB.m_body.SetAwake(true)}var type1=parseInt(contact.m_fixtureA.GetType()),type2=parseInt(contact.m_fixtureB.GetType()),reg=this.m_registers[type1][type2];if(true){reg.poolCount++;contact.m_next=reg.pool;reg.pool=contact}var destroyFcn=reg.destroyFcn;destroyFcn(contact,this.m_allocator)};b2ControllerEdge=Box2D.Dynamics.Controllers.b2ControllerEdge=function b2ControllerEdge(){};b2ControllerEdge.constructor=b2ControllerEdge;b2Controller=Box2D.Dynamics.Controllers.b2Controller=function b2Controller(){};b2Controller.constructor=b2Controller;b2Controller.prototype.Step=function(step){};b2Controller.prototype.Draw=function(debugDraw){};b2Controller.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2Controller.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!=this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList==edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList==edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2Controller.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2Controller.prototype.GetNext=function(){return this.m_next};b2Controller.prototype.GetWorld=function(){return this.m_world};b2Controller.prototype.GetBodyList=function(){return this.m_bodyList};b2BuoyancyController=Box2D.Dynamics.Controllers.b2BuoyancyController=function b2BuoyancyController(){this.normal=new b2Vec2(0,-1);this.offset=0;this.density=0;this.velocity=new b2Vec2(0,0);this.linearDrag=2;this.angularDrag=1;this.useDensity=false;this.useWorldGravity=true;this.gravity=null;b2Controller.apply(this,arguments)};b2BuoyancyController.constructor=b2BuoyancyController;b2BuoyancyController.prototype=Object.create(b2Controller.prototype);b2BuoyancyController.prototype.Step=function(step){if(!this.m_bodyList)return;if(this.useWorldGravity){this.gravity=this.GetWorld().GetGravity().Copy()}for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(body.IsAwake()==false){continue}var areac=new b2Vec2,massc=new b2Vec2,area=0,mass=0;for(var fixture=body.GetFixtureList();fixture;fixture=fixture.GetNext()){var sc=new b2Vec2,sarea=fixture.GetShape().ComputeSubmergedArea(this.normal,this.offset,body.GetTransform(),sc);area+=sarea;areac.x+=sarea*sc.x;areac.y+=sarea*sc.y;var shapeDensity=0;if(this.useDensity){shapeDensity=1}else{shapeDensity=1}mass+=sarea*shapeDensity;massc.x+=sarea*sc.x*shapeDensity;massc.y+=sarea*sc.y*shapeDensity}areac.x/=area;areac.y/=area;massc.x/=mass;massc.y/=mass;if(area<Number.MIN_VALUE)continue;var buoyancyForce=this.gravity.GetNegative();buoyancyForce.Multiply(this.density*area);body.ApplyForce(buoyancyForce,massc);var dragForce=body.GetLinearVelocityFromWorldPoint(areac);dragForce.Subtract(this.velocity);dragForce.Multiply(-this.linearDrag*area);body.ApplyForce(dragForce,areac);body.ApplyTorque(-body.GetInertia()/body.GetMass()*area*body.GetAngularVelocity()*this.angularDrag)}};b2BuoyancyController.prototype.Draw=function(debugDraw){var r=1e3,p1=new b2Vec2,p2=new b2Vec2;p1.x=this.normal.x*this.offset+this.normal.y*r;p1.y=this.normal.y*this.offset-this.normal.x*r;p2.x=this.normal.x*this.offset-this.normal.y*r;p2.y=this.normal.y*this.offset+this.normal.x*r;var color=new b2Color(0,0,1);debugDraw.DrawSegment(p1,p2,color)};b2BuoyancyController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2BuoyancyController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!=this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList==edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList==edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2BuoyancyController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2BuoyancyController.prototype.GetNext=function(){return this.m_next};b2BuoyancyController.prototype.GetWorld=function(){return this.m_world};b2BuoyancyController.prototype.GetBodyList=function(){return this.m_bodyList};b2ConstantAccelController=Box2D.Dynamics.Controllers.b2ConstantAccelController=function b2ConstantAccelController(){this.A=new b2Vec2(0,0);b2Controller.apply(this,arguments)};b2ConstantAccelController.constructor=b2ConstantAccelController;b2ConstantAccelController.prototype=Object.create(b2Controller.prototype);b2ConstantAccelController.prototype.Step=function(step){var smallA=new b2Vec2(this.A.x*step.dt,this.A.y*step.dt);for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(!body.IsAwake())continue;body.SetLinearVelocity(new b2Vec2(body.GetLinearVelocity().x+smallA.x,body.GetLinearVelocity().y+smallA.y))}};b2ConstantAccelController.prototype.Draw=function(debugDraw){};b2ConstantAccelController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2ConstantAccelController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!=this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList==edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList==edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2ConstantAccelController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2ConstantAccelController.prototype.GetNext=function(){return this.m_next};b2ConstantAccelController.prototype.GetWorld=function(){return this.m_world};b2ConstantAccelController.prototype.GetBodyList=function(){return this.m_bodyList};b2ConstantForceController=Box2D.Dynamics.Controllers.b2ConstantForceController=function b2ConstantForceController(){this.F=new b2Vec2(0,0);b2Controller.apply(this,arguments)};b2ConstantForceController.constructor=b2ConstantForceController;b2ConstantForceController.prototype=Object.create(b2Controller.prototype);b2ConstantForceController.prototype.Step=function(step){for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(!body.IsAwake())continue;body.ApplyForce(this.F,body.GetWorldCenter())}};b2ConstantForceController.prototype.Draw=function(debugDraw){};b2ConstantForceController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2ConstantForceController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!=this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList==edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList==edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2ConstantForceController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2ConstantForceController.prototype.GetNext=function(){return this.m_next};b2ConstantForceController.prototype.GetWorld=function(){return this.m_world};b2ConstantForceController.prototype.GetBodyList=function(){return this.m_bodyList};b2GravityController=Box2D.Dynamics.Controllers.b2GravityController=function b2GravityController(){this.G=1;this.invSqr=true;b2Controller.apply(this,arguments)};b2GravityController.constructor=b2GravityController;b2GravityController.prototype=Object.create(b2Controller.prototype);b2GravityController.prototype.Step=function(step){var i=null,body1=null,p1=null,mass1=0,j=null,body2=null,p2=null,dx=0,dy=0,r2=0,f=null;if(this.invSqr){for(i=this.m_bodyList;i;i=i.nextBody){body1=i.body;p1=body1.GetWorldCenter();mass1=body1.GetMass();for(j=this.m_bodyList;j!=i;j=j.nextBody){body2=j.body;p2=body2.GetWorldCenter();dx=p2.x-p1.x;dy=p2.y-p1.y;r2=dx*dx+dy*dy;if(r2<Number.MIN_VALUE)continue;f=new b2Vec2(dx,dy);f.Multiply(this.G/r2/Math.sqrt(r2)*mass1*body2.GetMass());if(body1.IsAwake())body1.ApplyForce(f,p1);f.Multiply(-1);if(body2.IsAwake())body2.ApplyForce(f,p2)}}}else{for(i=this.m_bodyList;i;i=i.nextBody){body1=i.body;p1=body1.GetWorldCenter();mass1=body1.GetMass();for(j=this.m_bodyList;j!=i;j=j.nextBody){body2=j.body;p2=body2.GetWorldCenter();dx=p2.x-p1.x;dy=p2.y-p1.y;r2=dx*dx+dy*dy;if(r2<Number.MIN_VALUE)continue;f=new b2Vec2(dx,dy);f.Multiply(this.G/r2*mass1*body2.GetMass());if(body1.IsAwake())body1.ApplyForce(f,p1);f.Multiply(-1);if(body2.IsAwake())body2.ApplyForce(f,p2)}}}};b2GravityController.prototype.Draw=function(debugDraw){};b2GravityController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2GravityController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!=this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList==edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList==edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2GravityController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2GravityController.prototype.GetNext=function(){return this.m_next};b2GravityController.prototype.GetWorld=function(){return this.m_world};b2GravityController.prototype.GetBodyList=function(){return this.m_bodyList};b2TensorDampingController=Box2D.Dynamics.Controllers.b2TensorDampingController=function b2TensorDampingController(){this.T=new b2Mat22;this.maxTimestep=0;b2Controller.apply(this,arguments)};b2TensorDampingController.constructor=b2TensorDampingController;b2TensorDampingController.prototype=Object.create(b2Controller.prototype);b2TensorDampingController.prototype.SetAxisAligned=function(xDamping,yDamping){xDamping=xDamping||0;yDamping=yDamping||0;this.T.col1.x=-xDamping;this.T.col1.y=0;this.T.col2.x=0;this.T.col2.y=-yDamping;if(xDamping>0||yDamping>0){this.maxTimestep=1/Math.max(xDamping,yDamping)}else{this.maxTimestep=0}};b2TensorDampingController.prototype.Step=function(step){var timestep=step.dt;if(timestep<=Number.MIN_VALUE)return;if(timestep>this.maxTimestep&&this.maxTimestep>0)timestep=this.maxTimestep;for(var i=this.m_bodyList;i;i=i.nextBody){var body=i.body;if(!body.IsAwake()){continue}var damping=body.GetWorldVector(b2Math.MulMV(this.T,body.GetLocalVector(body.GetLinearVelocity())));body.SetLinearVelocity(new b2Vec2(body.GetLinearVelocity().x+damping.x*timestep,body.GetLinearVelocity().y+damping.y*timestep))}};b2TensorDampingController.prototype.Draw=function(debugDraw){};b2TensorDampingController.prototype.AddBody=function(body){var edge=new b2ControllerEdge;edge.controller=this;edge.body=body;edge.nextBody=this.m_bodyList;edge.prevBody=null;this.m_bodyList=edge;if(edge.nextBody)edge.nextBody.prevBody=edge;this.m_bodyCount++;edge.nextController=body.m_controllerList;edge.prevController=null;body.m_controllerList=edge;if(edge.nextController)edge.nextController.prevController=edge;body.m_controllerCount++};b2TensorDampingController.prototype.RemoveBody=function(body){var edge=body.m_controllerList;while(edge&&edge.controller!=this)edge=edge.nextController;if(edge.prevBody)edge.prevBody.nextBody=edge.nextBody;if(edge.nextBody)edge.nextBody.prevBody=edge.prevBody;if(edge.nextController)edge.nextController.prevController=edge.prevController;if(edge.prevController)edge.prevController.nextController=edge.nextController;if(this.m_bodyList==edge)this.m_bodyList=edge.nextBody;if(body.m_controllerList==edge)body.m_controllerList=edge.nextController;body.m_controllerCount--;this.m_bodyCount--};b2TensorDampingController.prototype.Clear=function(){while(this.m_bodyList)this.RemoveBody(this.m_bodyList.body)};b2TensorDampingController.prototype.GetNext=function(){return this.m_next};b2TensorDampingController.prototype.GetWorld=function(){return this.m_world};b2TensorDampingController.prototype.GetBodyList=function(){return this.m_bodyList};b2Joint=Box2D.Dynamics.Joints.b2Joint=function b2Joint(def){this.m_edgeA=new b2JointEdge;this.m_edgeB=new b2JointEdge;this.m_localCenterA=new b2Vec2;this.m_localCenterB=new b2Vec2;b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2Joint.constructor=b2Joint;b2Joint.e_unknownJoint=0;b2Joint.e_revoluteJoint=1;b2Joint.e_prismaticJoint=2;b2Joint.e_distanceJoint=3;b2Joint.e_pulleyJoint=4;b2Joint.e_mouseJoint=5;b2Joint.e_gearJoint=6;b2Joint.e_lineJoint=7;b2Joint.e_weldJoint=8;b2Joint.e_frictionJoint=9;b2Joint.e_inactiveLimit=0;b2Joint.e_atLowerLimit=1;b2Joint.e_atUpperLimit=2;b2Joint.e_equalLimits=3;b2Joint.Create=function(def,allocator){var joint=null;switch(def.type){case b2Joint.e_distanceJoint:{joint=new b2DistanceJoint(def instanceof b2DistanceJointDef?def:null)}break;case b2Joint.e_mouseJoint:{joint=new b2MouseJoint(def instanceof b2MouseJointDef?def:null)}break;case b2Joint.e_prismaticJoint:{joint=new b2PrismaticJoint(def instanceof b2PrismaticJointDef?def:null)}break;case b2Joint.e_revoluteJoint:{joint=new b2RevoluteJoint(def instanceof b2RevoluteJointDef?def:null)}break;case b2Joint.e_pulleyJoint:{joint=new b2PulleyJoint(def instanceof b2PulleyJointDef?def:null)}break;case b2Joint.e_gearJoint:{joint=new b2GearJoint(def instanceof b2GearJointDef?def:null)}break;case b2Joint.e_lineJoint:{joint=new b2LineJoint(def instanceof b2LineJointDef?def:null)}break;case b2Joint.e_weldJoint:{joint=new b2WeldJoint(def instanceof b2WeldJointDef?def:null)}break;case b2Joint.e_frictionJoint:{joint=new b2FrictionJoint(def instanceof b2FrictionJointDef?def:null)}break;default:break}return joint};b2Joint.Destroy=function(joint,allocator){};b2Joint.prototype.GetType=function(){return this.m_type};b2Joint.prototype.GetAnchorA=function(){return null};b2Joint.prototype.GetAnchorB=function(){return null};b2Joint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return null};b2Joint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2Joint.prototype.GetBodyA=function(){return this.m_bodyA};b2Joint.prototype.GetBodyB=function(){return this.m_bodyB};b2Joint.prototype.GetNext=function(){return this.m_next};b2Joint.prototype.GetUserData=function(){return this.m_userData};b2Joint.prototype.SetUserData=function(data){this.m_userData=data};b2Joint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2Joint.prototype.InitVelocityConstraints=function(step){};b2Joint.prototype.SolveVelocityConstraints=function(step){};b2Joint.prototype.FinalizeVelocityConstraints=function(){};b2Joint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;return false};b2JointDef=Box2D.Dynamics.Joints.b2JointDef=function b2JointDef(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2JointDef.constructor=b2JointDef;b2JointEdge=Box2D.Dynamics.Joints.b2JointEdge=function b2JointEdge(){};b2JointEdge.constructor=b2JointEdge;b2Jacobian=Box2D.Dynamics.Joints.b2Jacobian=function b2Jacobian(){this.linearA=new b2Vec2;this.linearB=new b2Vec2};b2Jacobian.constructor=b2Jacobian;b2Jacobian.prototype.SetZero=function(){this.linearA.SetZero();this.angularA=0;this.linearB.SetZero();this.angularB=0};b2Jacobian.prototype.Set=function(x1,a1,x2,a2){a1=a1||0;a2=a2||0;this.linearA.SetV(x1);this.angularA=a1;this.linearB.SetV(x2);this.angularB=a2};b2Jacobian.prototype.Compute=function(x1,a1,x2,a2){a1=a1||0;a2=a2||0;return this.linearA.x*x1.x+this.linearA.y*x1.y+this.angularA*a1+(this.linearB.x*x2.x+this.linearB.y*x2.y)+this.angularB*a2};b2DistanceJoint=Box2D.Dynamics.Joints.b2DistanceJoint=function b2DistanceJoint(def){this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u=new b2Vec2;b2Joint.call(this,def);var tMat,tX=0,tY=0;this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_length=def.length;this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio;this.m_impulse=0;this.m_gamma=0;this.m_bias=0};b2DistanceJoint.constructor=b2DistanceJoint;b2DistanceJoint.prototype=Object.create(b2Joint.prototype);b2DistanceJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2DistanceJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2DistanceJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse*this.m_u.x,inv_dt*this.m_impulse*this.m_u.y)};b2DistanceJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2DistanceJoint.prototype.GetLength=function(){return this.m_length};b2DistanceJoint.prototype.SetLength=function(length){length=length||0;this.m_length=length};b2DistanceJoint.prototype.GetFrequency=function(){return this.m_frequencyHz};b2DistanceJoint.prototype.SetFrequency=function(hz){hz=hz||0;this.m_frequencyHz=hz};b2DistanceJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio};b2DistanceJoint.prototype.SetDampingRatio=function(ratio){ratio=ratio||0;this.m_dampingRatio=ratio};b2DistanceJoint.prototype.InitVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;this.m_u.x=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X;this.m_u.y=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y;var length=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);if(length>b2Settings.b2_linearSlop){this.m_u.Multiply(1/length)}else{this.m_u.SetZero()}var cr1u=r1X*this.m_u.y-r1Y*this.m_u.x,cr2u=r2X*this.m_u.y-r2Y*this.m_u.x,invMass=bA.m_invMass+bA.m_invI*cr1u*cr1u+bB.m_invMass+bB.m_invI*cr2u*cr2u;this.m_mass=invMass!=0?1/invMass:0;if(this.m_frequencyHz>0){var C=length-this.m_length,omega=2*Math.PI*this.m_frequencyHz,d=2*this.m_mass*this.m_dampingRatio*omega,k=this.m_mass*omega*omega;this.m_gamma=step.dt*(d+step.dt*k);this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0;this.m_bias=C*step.dt*k*this.m_gamma;this.m_mass=invMass+this.m_gamma;this.m_mass=this.m_mass!=0?1/this.m_mass:0}if(step.warmStarting){this.m_impulse*=step.dtRatio;var PX=this.m_impulse*this.m_u.x,PY=this.m_impulse*this.m_u.y;bA.m_linearVelocity.x-=bA.m_invMass*PX;bA.m_linearVelocity.y-=bA.m_invMass*PY;bA.m_angularVelocity-=bA.m_invI*(r1X*PY-r1Y*PX);bB.m_linearVelocity.x+=bB.m_invMass*PX;bB.m_linearVelocity.y+=bB.m_invMass*PY;bB.m_angularVelocity+=bB.m_invI*(r2X*PY-r2Y*PX)}else{this.m_impulse=0}};b2DistanceJoint.prototype.SolveVelocityConstraints=function(step){var tMat,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var v1X=bA.m_linearVelocity.x+-bA.m_angularVelocity*r1Y,v1Y=bA.m_linearVelocity.y+bA.m_angularVelocity*r1X,v2X=bB.m_linearVelocity.x+-bB.m_angularVelocity*r2Y,v2Y=bB.m_linearVelocity.y+bB.m_angularVelocity*r2X,Cdot=this.m_u.x*(v2X-v1X)+this.m_u.y*(v2Y-v1Y),impulse=-this.m_mass*(Cdot+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=impulse;var PX=impulse*this.m_u.x,PY=impulse*this.m_u.y;bA.m_linearVelocity.x-=bA.m_invMass*PX;bA.m_linearVelocity.y-=bA.m_invMass*PY;bA.m_angularVelocity-=bA.m_invI*(r1X*PY-r1Y*PX);bB.m_linearVelocity.x+=bB.m_invMass*PX;bB.m_linearVelocity.y+=bB.m_invMass*PY;bB.m_angularVelocity+=bB.m_invI*(r2X*PY-r2Y*PX)};b2DistanceJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var tMat;if(this.m_frequencyHz>0){return true}var bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,dY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y,length=Math.sqrt(dX*dX+dY*dY);dX/=length;dY/=length;var C=length-this.m_length;C=b2Math.Clamp(C,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var impulse=-this.m_mass*C;this.m_u.Set(dX,dY);var PX=impulse*this.m_u.x,PY=impulse*this.m_u.y;bA.m_sweep.c.x-=bA.m_invMass*PX;bA.m_sweep.c.y-=bA.m_invMass*PY;bA.m_sweep.a-=bA.m_invI*(r1X*PY-r1Y*PX);bB.m_sweep.c.x+=bB.m_invMass*PX;bB.m_sweep.c.y+=bB.m_invMass*PY;bB.m_sweep.a+=bB.m_invI*(r2X*PY-r2Y*PX);bA.SynchronizeTransform();bB.SynchronizeTransform();return b2Math.Abs(C)<b2Settings.b2_linearSlop};b2DistanceJoint.prototype.GetType=function(){return this.m_type};b2DistanceJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2DistanceJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2DistanceJoint.prototype.GetNext=function(){return this.m_next};b2DistanceJoint.prototype.GetUserData=function(){return this.m_userData};b2DistanceJoint.prototype.SetUserData=function(data){this.m_userData=data};b2DistanceJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2DistanceJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2DistanceJoint.prototype.FinalizeVelocityConstraints=function(){};b2DistanceJointDef=Box2D.Dynamics.Joints.b2DistanceJointDef=function b2DistanceJointDef(){this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_distanceJoint;this.length=1;this.frequencyHz=0;this.dampingRatio=0};b2DistanceJointDef.constructor=b2DistanceJointDef;b2DistanceJointDef.prototype=Object.create(b2JointDef.prototype);b2DistanceJointDef.prototype.Initialize=function(bA,bB,anchorA,anchorB){this.bodyA=bA;this.bodyB=bB;this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchorA));this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchorB));var dX=anchorB.x-anchorA.x,dY=anchorB.y-anchorA.y;this.length=Math.sqrt(dX*dX+dY*dY);this.frequencyHz=0;this.dampingRatio=0};b2DistanceJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2FrictionJoint=Box2D.Dynamics.Joints.b2FrictionJoint=function b2FrictionJoint(def){this.m_localAnchorA=new b2Vec2;this.m_localAnchorB=new b2Vec2;this.m_linearMass=new b2Mat22;this.m_linearImpulse=new b2Vec2;b2Joint.call(this,def);this.m_localAnchorA.SetV(def.localAnchorA);this.m_localAnchorB.SetV(def.localAnchorB);this.m_linearMass.SetZero();this.m_angularMass=0;this.m_linearImpulse.SetZero();this.m_angularImpulse=0;this.m_maxForce=def.maxForce;this.m_maxTorque=def.maxTorque};b2FrictionJoint.constructor=b2FrictionJoint;b2FrictionJoint.prototype=Object.create(b2Joint.prototype);b2FrictionJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)};b2FrictionJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)};b2FrictionJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_linearImpulse.x,inv_dt*this.m_linearImpulse.y)};b2FrictionJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_angularImpulse};b2FrictionJoint.prototype.SetMaxForce=function(force){force=force||0;this.m_maxForce=force};b2FrictionJoint.prototype.GetMaxForce=function(){return this.m_maxForce};b2FrictionJoint.prototype.SetMaxTorque=function(torque){torque=torque||0;this.m_maxTorque=torque};b2FrictionJoint.prototype.GetMaxTorque=function(){return this.m_maxTorque};b2FrictionJoint.prototype.InitVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI,K=new b2Mat22;K.col1.x=mA+mB;K.col2.x=0;K.col1.y=0;K.col2.y=mA+mB;K.col1.x+=iA*rAY*rAY;K.col2.x+=-iA*rAX*rAY;K.col1.y+=-iA*rAX*rAY;K.col2.y+=iA*rAX*rAX;K.col1.x+=iB*rBY*rBY;K.col2.x+=-iB*rBX*rBY;K.col1.y+=-iB*rBX*rBY;K.col2.y+=iB*rBX*rBX;K.GetInverse(this.m_linearMass);this.m_angularMass=iA+iB;if(this.m_angularMass>0){this.m_angularMass=1/this.m_angularMass}if(step.warmStarting){this.m_linearImpulse.x*=step.dtRatio;this.m_linearImpulse.y*=step.dtRatio;this.m_angularImpulse*=step.dtRatio;var P=this.m_linearImpulse;bA.m_linearVelocity.x-=mA*P.x;bA.m_linearVelocity.y-=mA*P.y;bA.m_angularVelocity-=iA*(rAX*P.y-rAY*P.x+this.m_angularImpulse);bB.m_linearVelocity.x+=mB*P.x;bB.m_linearVelocity.y+=mB*P.y;bB.m_angularVelocity+=iB*(rBX*P.y-rBY*P.x+this.m_angularImpulse)}else{this.m_linearImpulse.SetZero();this.m_angularImpulse=0}};b2FrictionJoint.prototype.SolveVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB,vA=bA.m_linearVelocity,wA=bA.m_angularVelocity,vB=bB.m_linearVelocity,wB=bB.m_angularVelocity,mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;
rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var maxImpulse=0;{var Cdot=wB-wA,impulse=-this.m_angularMass*Cdot,oldImpulse=this.m_angularImpulse;maxImpulse=step.dt*this.m_maxTorque;this.m_angularImpulse=b2Math.Clamp(this.m_angularImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_angularImpulse-oldImpulse;wA-=iA*impulse;wB+=iB*impulse}{var CdotX=vB.x-wB*rBY-vA.x+wA*rAY,CdotY=vB.y+wB*rBX-vA.y-wA*rAX,impulseV=b2Math.MulMV(this.m_linearMass,new b2Vec2(-CdotX,-CdotY)),oldImpulseV=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(impulseV);maxImpulse=step.dt*this.m_maxForce;if(this.m_linearImpulse.LengthSquared()>maxImpulse*maxImpulse){this.m_linearImpulse.Normalize();this.m_linearImpulse.Multiply(maxImpulse)}impulseV=b2Math.SubtractVV(this.m_linearImpulse,oldImpulseV);vA.x-=mA*impulseV.x;vA.y-=mA*impulseV.y;wA-=iA*(rAX*impulseV.y-rAY*impulseV.x);vB.x+=mB*impulseV.x;vB.y+=mB*impulseV.y;wB+=iB*(rBX*impulseV.y-rBY*impulseV.x)}bA.m_angularVelocity=wA;bB.m_angularVelocity=wB};b2FrictionJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;return true};b2FrictionJoint.prototype.GetType=function(){return this.m_type};b2FrictionJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2FrictionJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2FrictionJoint.prototype.GetNext=function(){return this.m_next};b2FrictionJoint.prototype.GetUserData=function(){return this.m_userData};b2FrictionJoint.prototype.SetUserData=function(data){this.m_userData=data};b2FrictionJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2FrictionJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2FrictionJoint.prototype.FinalizeVelocityConstraints=function(){};b2FrictionJointDef=Box2D.Dynamics.Joints.b2FrictionJointDef=function b2FrictionJointDef(){this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_frictionJoint;this.maxForce=0;this.maxTorque=0};b2FrictionJointDef.constructor=b2FrictionJointDef;b2FrictionJointDef.prototype=Object.create(b2JointDef.prototype);b2FrictionJointDef.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchor));this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchor))};b2FrictionJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2GearJoint=Box2D.Dynamics.Joints.b2GearJoint=function b2GearJoint(def){this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_J=new b2Jacobian;b2Joint.call(this,def);var type1=parseInt(def.joint1.m_type),type2=parseInt(def.joint2.m_type);this.m_revolute1=null;this.m_prismatic1=null;this.m_revolute2=null;this.m_prismatic2=null;var coordinate1=0,coordinate2=0;this.m_ground1=def.joint1.GetBodyA();this.m_bodyA=def.joint1.GetBodyB();if(type1==b2Joint.e_revoluteJoint){this.m_revolute1=def.joint1 instanceof b2RevoluteJoint?def.joint1:null;this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2);coordinate1=this.m_revolute1.GetJointAngle()}else{this.m_prismatic1=def.joint1 instanceof b2PrismaticJoint?def.joint1:null;this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2);coordinate1=this.m_prismatic1.GetJointTranslation()}this.m_ground2=def.joint2.GetBodyA();this.m_bodyB=def.joint2.GetBodyB();if(type2==b2Joint.e_revoluteJoint){this.m_revolute2=def.joint2 instanceof b2RevoluteJoint?def.joint2:null;this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2);coordinate2=this.m_revolute2.GetJointAngle()}else{this.m_prismatic2=def.joint2 instanceof b2PrismaticJoint?def.joint2:null;this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2);coordinate2=this.m_prismatic2.GetJointTranslation()}this.m_ratio=def.ratio;this.m_constant=coordinate1+this.m_ratio*coordinate2;this.m_impulse=0};b2GearJoint.constructor=b2GearJoint;b2GearJoint.prototype=Object.create(b2Joint.prototype);b2GearJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2GearJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2GearJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse*this.m_J.linearB.x,inv_dt*this.m_impulse*this.m_J.linearB.y)};b2GearJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;var tMat=this.m_bodyB.m_xf.R,rX=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,rY=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;var PX=this.m_impulse*this.m_J.linearB.x,PY=this.m_impulse*this.m_J.linearB.y;return inv_dt*(this.m_impulse*this.m_J.angularB-rX*PY+rY*PX)};b2GearJoint.prototype.GetRatio=function(){return this.m_ratio};b2GearJoint.prototype.SetRatio=function(ratio){ratio=ratio||0;this.m_ratio=ratio};b2GearJoint.prototype.InitVelocityConstraints=function(step){var g1=this.m_ground1,g2=this.m_ground2,bA=this.m_bodyA,bB=this.m_bodyB,ugX=0,ugY=0,rX=0,rY=0,tMat,tVec,crug=0,tX=0,K=0;this.m_J.SetZero();if(this.m_revolute1){this.m_J.angularA=-1;K+=bA.m_invI}else{tMat=g1.m_xf.R;tVec=this.m_prismatic1.m_localXAxis1;ugX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;ugY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=bA.m_xf.R;rX=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;rY=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;crug=rX*ugY-rY*ugX;this.m_J.linearA.Set(-ugX,-ugY);this.m_J.angularA=-crug;K+=bA.m_invMass+bA.m_invI*crug*crug}if(this.m_revolute2){this.m_J.angularB=-this.m_ratio;K+=this.m_ratio*this.m_ratio*bB.m_invI}else{tMat=g2.m_xf.R;tVec=this.m_prismatic2.m_localXAxis1;ugX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;ugY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=bB.m_xf.R;rX=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;rY=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;crug=rX*ugY-rY*ugX;this.m_J.linearB.Set(-this.m_ratio*ugX,-this.m_ratio*ugY);this.m_J.angularB=-this.m_ratio*crug;K+=this.m_ratio*this.m_ratio*(bB.m_invMass+bB.m_invI*crug*crug)}this.m_mass=K>0?1/K:0;if(step.warmStarting){bA.m_linearVelocity.x+=bA.m_invMass*this.m_impulse*this.m_J.linearA.x;bA.m_linearVelocity.y+=bA.m_invMass*this.m_impulse*this.m_J.linearA.y;bA.m_angularVelocity+=bA.m_invI*this.m_impulse*this.m_J.angularA;bB.m_linearVelocity.x+=bB.m_invMass*this.m_impulse*this.m_J.linearB.x;bB.m_linearVelocity.y+=bB.m_invMass*this.m_impulse*this.m_J.linearB.y;bB.m_angularVelocity+=bB.m_invI*this.m_impulse*this.m_J.angularB}else{this.m_impulse=0}};b2GearJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,Cdot=this.m_J.Compute(bA.m_linearVelocity,bA.m_angularVelocity,bB.m_linearVelocity,bB.m_angularVelocity),impulse=-this.m_mass*Cdot;this.m_impulse+=impulse;bA.m_linearVelocity.x+=bA.m_invMass*impulse*this.m_J.linearA.x;bA.m_linearVelocity.y+=bA.m_invMass*impulse*this.m_J.linearA.y;bA.m_angularVelocity+=bA.m_invI*impulse*this.m_J.angularA;bB.m_linearVelocity.x+=bB.m_invMass*impulse*this.m_J.linearB.x;bB.m_linearVelocity.y+=bB.m_invMass*impulse*this.m_J.linearB.y;bB.m_angularVelocity+=bB.m_invI*impulse*this.m_J.angularB};b2GearJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var linearError=0,bA=this.m_bodyA,bB=this.m_bodyB,coordinate1=0,coordinate2=0;if(this.m_revolute1){coordinate1=this.m_revolute1.GetJointAngle()}else{coordinate1=this.m_prismatic1.GetJointTranslation()}if(this.m_revolute2){coordinate2=this.m_revolute2.GetJointAngle()}else{coordinate2=this.m_prismatic2.GetJointTranslation()}var C=this.m_constant-(coordinate1+this.m_ratio*coordinate2),impulse=-this.m_mass*C;bA.m_sweep.c.x+=bA.m_invMass*impulse*this.m_J.linearA.x;bA.m_sweep.c.y+=bA.m_invMass*impulse*this.m_J.linearA.y;bA.m_sweep.a+=bA.m_invI*impulse*this.m_J.angularA;bB.m_sweep.c.x+=bB.m_invMass*impulse*this.m_J.linearB.x;bB.m_sweep.c.y+=bB.m_invMass*impulse*this.m_J.linearB.y;bB.m_sweep.a+=bB.m_invI*impulse*this.m_J.angularB;bA.SynchronizeTransform();bB.SynchronizeTransform();return linearError<b2Settings.b2_linearSlop};b2GearJoint.prototype.GetType=function(){return this.m_type};b2GearJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2GearJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2GearJoint.prototype.GetNext=function(){return this.m_next};b2GearJoint.prototype.GetUserData=function(){return this.m_userData};b2GearJoint.prototype.SetUserData=function(data){this.m_userData=data};b2GearJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2GearJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2GearJoint.prototype.FinalizeVelocityConstraints=function(){};b2GearJointDef=Box2D.Dynamics.Joints.b2GearJointDef=function b2GearJointDef(){b2JointDef.call(this);this.type=b2Joint.e_gearJoint;this.joint1=null;this.joint2=null;this.ratio=1};b2GearJointDef.constructor=b2GearJointDef;b2GearJointDef.prototype=Object.create(b2JointDef.prototype);b2GearJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2LineJoint=Box2D.Dynamics.Joints.b2LineJoint=function b2LineJoint(def){this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_localXAxis1=new b2Vec2;this.m_localYAxis1=new b2Vec2;this.m_axis=new b2Vec2;this.m_perp=new b2Vec2;this.m_K=new b2Mat22;this.m_impulse=new b2Vec2;b2Joint.call(this,def);var tMat,tX=0,tY=0;this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_localXAxis1.SetV(def.localAxisA);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_impulse.SetZero();this.m_motorMass=0;this.m_motorImpulse=0;this.m_lowerTranslation=def.lowerTranslation;this.m_upperTranslation=def.upperTranslation;this.m_maxMotorForce=def.maxMotorForce;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=b2Joint.e_inactiveLimit;this.m_axis.SetZero();this.m_perp.SetZero()};b2LineJoint.constructor=b2LineJoint;b2LineJoint.prototype=Object.create(b2Joint.prototype);b2LineJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2LineJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2LineJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),inv_dt*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))};b2LineJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.y};b2LineJoint.prototype.GetJointTranslation=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,p1=bA.GetWorldPoint(this.m_localAnchor1),p2=bB.GetWorldPoint(this.m_localAnchor2),dX=p2.x-p1.x,dY=p2.y-p1.y,axis=bA.GetWorldVector(this.m_localXAxis1),translation=axis.x*dX+axis.y*dY;return translation};b2LineJoint.prototype.GetJointSpeed=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var p1X=bA.m_sweep.c.x+r1X,p1Y=bA.m_sweep.c.y+r1Y,p2X=bB.m_sweep.c.x+r2X,p2Y=bB.m_sweep.c.y+r2Y,dX=p2X-p1X,dY=p2Y-p1Y,axis=bA.GetWorldVector(this.m_localXAxis1),v1=bA.m_linearVelocity,v2=bB.m_linearVelocity,w1=bA.m_angularVelocity,w2=bB.m_angularVelocity,speed=dX*(-w1*axis.y)+dY*(w1*axis.x)+(axis.x*(v2.x+-w2*r2Y-v1.x- -w1*r1Y)+axis.y*(v2.y+w2*r2X-v1.y-w1*r1X));return speed};b2LineJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit};b2LineJoint.prototype.EnableLimit=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableLimit=flag};b2LineJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation};b2LineJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation};b2LineJoint.prototype.SetLimits=function(lower,upper){lower=lower||0;upper=upper||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_lowerTranslation=lower;this.m_upperTranslation=upper};b2LineJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor};b2LineJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag};b2LineJoint.prototype.SetMotorSpeed=function(speed){speed=speed||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed};b2LineJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed};b2LineJoint.prototype.SetMaxMotorForce=function(force){force=force||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorForce=force};b2LineJoint.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce};b2LineJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse};b2LineJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0;this.m_localCenterA.SetV(bA.GetLocalCenter());this.m_localCenterB.SetV(bB.GetLocalCenter());var xf1=bA.GetTransform(),xf2=bB.GetTransform();tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,dY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y;this.m_invMassA=bA.m_invMass;this.m_invMassB=bB.m_invMass;this.m_invIA=bA.m_invI;this.m_invIB=bB.m_invI;{this.m_axis.SetV(b2Math.MulMV(xf1.R,this.m_localXAxis1));this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2;this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0}{this.m_perp.SetV(b2Math.MulMV(xf1.R,this.m_localYAxis1));this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var m1=this.m_invMassA,m2=this.m_invMassB,i1=this.m_invIA,i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2}if(this.m_enableLimit){var jointTransition=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointTransition<=this.m_lowerTranslation){if(this.m_limitState!=b2Joint.e_atLowerLimit){this.m_limitState=b2Joint.e_atLowerLimit;this.m_impulse.y=0}}else if(jointTransition>=this.m_upperTranslation){if(this.m_limitState!=b2Joint.e_atUpperLimit){this.m_limitState=b2Joint.e_atUpperLimit;this.m_impulse.y=0}}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_impulse.y=0}}else{this.m_limitState=b2Joint.e_inactiveLimit}if(this.m_enableMotor==false){this.m_motorImpulse=0}if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_motorImpulse*=step.dtRatio;var PX=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,PY=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,L1=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,L2=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;bA.m_linearVelocity.x-=this.m_invMassA*PX;bA.m_linearVelocity.y-=this.m_invMassA*PY;bA.m_angularVelocity-=this.m_invIA*L1;bB.m_linearVelocity.x+=this.m_invMassB*PX;bB.m_linearVelocity.y+=this.m_invMassB*PY;bB.m_angularVelocity+=this.m_invIB*L2}else{this.m_impulse.SetZero();this.m_motorImpulse=0}};b2LineJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,v1=bA.m_linearVelocity,w1=bA.m_angularVelocity,v2=bB.m_linearVelocity,w2=bB.m_angularVelocity,PX=0,PY=0,L1=0,L2=0;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var Cdot=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,impulse=this.m_motorMass*(this.m_motorSpeed-Cdot),oldImpulse=this.m_motorImpulse,maxImpulse=step.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;PX=impulse*this.m_axis.x;PY=impulse*this.m_axis.y;L1=impulse*this.m_a1;L2=impulse*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}var Cdot1=this.m_perp.x*(v2.x-v1.x)+this.m_perp.y*(v2.y-v1.y)+this.m_s2*w2-this.m_s1*w1;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var Cdot2=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,f1=this.m_impulse.Copy(),df=this.m_K.Solve(new b2Vec2,-Cdot1,-Cdot2);this.m_impulse.Add(df);if(this.m_limitState==b2Joint.e_atLowerLimit){this.m_impulse.y=b2Math.Max(this.m_impulse.y,0)}else if(this.m_limitState==b2Joint.e_atUpperLimit){this.m_impulse.y=b2Math.Min(this.m_impulse.y,0)}var b=-Cdot1-(this.m_impulse.y-f1.y)*this.m_K.col2.x,f2r=0;if(this.m_K.col1.x!=0){f2r=b/this.m_K.col1.x+f1.x}else{f2r=f1.x}this.m_impulse.x=f2r;df.x=this.m_impulse.x-f1.x;df.y=this.m_impulse.y-f1.y;PX=df.x*this.m_perp.x+df.y*this.m_axis.x;PY=df.x*this.m_perp.y+df.y*this.m_axis.y;L1=df.x*this.m_s1+df.y*this.m_a1;L2=df.x*this.m_s2+df.y*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}else{var df2=0;if(this.m_K.col1.x!=0){df2=-Cdot1/this.m_K.col1.x}else{df2=0}this.m_impulse.x+=df2;PX=df2*this.m_perp.x;PY=df2*this.m_perp.y;L1=df2*this.m_s1;L2=df2*this.m_s2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}bA.m_linearVelocity.SetV(v1);bA.m_angularVelocity=w1;bB.m_linearVelocity.SetV(v2);bB.m_angularVelocity=w2};b2LineJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var limitC=0,oldLimitImpulse=0,bA=this.m_bodyA,bB=this.m_bodyB,c1=bA.m_sweep.c,a1=bA.m_sweep.a,c2=bB.m_sweep.c,a2=bB.m_sweep.a,tMat,tX=0,m1=0,m2=0,i1=0,i2=0,linearError=0,angularError=0,active=false,C2=0,R1=b2Mat22.FromAngle(a1),R2=b2Mat22.FromAngle(a2);tMat=R1;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=R2;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=c2.x+r2X-c1.x-r1X,dY=c2.y+r2Y-c1.y-r1Y;if(this.m_enableLimit){this.m_axis=b2Math.MulMV(R1,this.m_localXAxis1);this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;var translation=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){C2=b2Math.Clamp(translation,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);linearError=b2Math.Abs(translation);active=true}else if(translation<=this.m_lowerTranslation){C2=b2Math.Clamp(translation-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);linearError=this.m_lowerTranslation-translation;active=true}else if(translation>=this.m_upperTranslation){C2=b2Math.Clamp(translation-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection);linearError=translation-this.m_upperTranslation;active=true}}this.m_perp=b2Math.MulMV(R1,this.m_localYAxis1);this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var impulse=new b2Vec2,C1=this.m_perp.x*dX+this.m_perp.y*dY;linearError=b2Math.Max(linearError,b2Math.Abs(C1));angularError=0;if(active){m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2;this.m_K.Solve(impulse,-C1,-C2)}else{m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;var k11=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2,impulse1=0;if(k11!=0){impulse1=-C1/k11}else{impulse1=0}impulse.x=impulse1;impulse.y=0}var PX=impulse.x*this.m_perp.x+impulse.y*this.m_axis.x,PY=impulse.x*this.m_perp.y+impulse.y*this.m_axis.y,L1=impulse.x*this.m_s1+impulse.y*this.m_a1,L2=impulse.x*this.m_s2+impulse.y*this.m_a2;c1.x-=this.m_invMassA*PX;c1.y-=this.m_invMassA*PY;a1-=this.m_invIA*L1;c2.x+=this.m_invMassB*PX;c2.y+=this.m_invMassB*PY;a2+=this.m_invIB*L2;bA.m_sweep.a=a1;bB.m_sweep.a=a2;bA.SynchronizeTransform();bB.SynchronizeTransform();return linearError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2LineJoint.prototype.GetType=function(){return this.m_type};b2LineJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2LineJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2LineJoint.prototype.GetNext=function(){return this.m_next};b2LineJoint.prototype.GetUserData=function(){return this.m_userData};b2LineJoint.prototype.SetUserData=function(data){this.m_userData=data};b2LineJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2LineJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2LineJoint.prototype.FinalizeVelocityConstraints=function(){};b2LineJointDef=Box2D.Dynamics.Joints.b2LineJointDef=function b2LineJointDef(){this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;this.localAxisA=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_lineJoint;this.localAxisA.Set(1,0);this.enableLimit=false;this.lowerTranslation=0;this.upperTranslation=0;this.enableMotor=false;this.maxMotorForce=0;this.motorSpeed=0};b2LineJointDef.constructor=b2LineJointDef;b2LineJointDef.prototype=Object.create(b2JointDef.prototype);b2LineJointDef.prototype.Initialize=function(bA,bB,anchor,axis){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.localAxisA=this.bodyA.GetLocalVector(axis)};b2LineJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2MouseJoint=Box2D.Dynamics.Joints.b2MouseJoint=function b2MouseJoint(def){this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.m_localAnchor=new b2Vec2;this.m_target=new b2Vec2;this.m_impulse=new b2Vec2;this.m_mass=new b2Mat22;this.m_C=new b2Vec2;b2Joint.call(this,def);this.m_target.SetV(def.target);var tX=this.m_target.x-this.m_bodyB.m_xf.position.x,tY=this.m_target.y-this.m_bodyB.m_xf.position.y,tMat=this.m_bodyB.m_xf.R;this.m_localAnchor.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor.y=tX*tMat.col2.x+tY*tMat.col2.y;this.m_maxForce=def.maxForce;this.m_impulse.SetZero();this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio;this.m_beta=0;this.m_gamma=0};b2MouseJoint.constructor=b2MouseJoint;b2MouseJoint.prototype=Object.create(b2Joint.prototype);b2MouseJoint.prototype.GetAnchorA=function(){return this.m_target};b2MouseJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)};b2MouseJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse.x,inv_dt*this.m_impulse.y)};b2MouseJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2MouseJoint.prototype.GetTarget=function(){return this.m_target};b2MouseJoint.prototype.SetTarget=function(target){if(this.m_bodyB.IsAwake()==false){this.m_bodyB.SetAwake(true)}this.m_target=target};b2MouseJoint.prototype.GetMaxForce=function(){return this.m_maxForce};b2MouseJoint.prototype.SetMaxForce=function(maxForce){maxForce=maxForce||0;this.m_maxForce=maxForce};b2MouseJoint.prototype.GetFrequency=function(){return this.m_frequencyHz};b2MouseJoint.prototype.SetFrequency=function(hz){hz=hz||0;this.m_frequencyHz=hz};b2MouseJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio};b2MouseJoint.prototype.SetDampingRatio=function(ratio){ratio=ratio||0;this.m_dampingRatio=ratio};b2MouseJoint.prototype.InitVelocityConstraints=function(step){var b=this.m_bodyB,mass=b.GetMass(),omega=2*Math.PI*this.m_frequencyHz,d=2*mass*this.m_dampingRatio*omega,k=mass*omega*omega;this.m_gamma=step.dt*(d+step.dt*k);this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0;this.m_beta=step.dt*k*this.m_gamma;var tMat;tMat=b.m_xf.R,rX=this.m_localAnchor.x-b.m_sweep.localCenter.x,rY=this.m_localAnchor.y-b.m_sweep.localCenter.y,tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;var invMass=b.m_invMass,invI=b.m_invI;this.K1.col1.x=invMass;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass;this.K2.col1.x=invI*rY*rY;this.K2.col2.x=-invI*rX*rY;this.K2.col1.y=-invI*rX*rY;this.K2.col2.y=invI*rX*rX;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.col1.x+=this.m_gamma;this.K.col2.y+=this.m_gamma;this.K.GetInverse(this.m_mass);this.m_C.x=b.m_sweep.c.x+rX-this.m_target.x;this.m_C.y=b.m_sweep.c.y+rY-this.m_target.y;b.m_angularVelocity*=.98;this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;b.m_linearVelocity.x+=invMass*this.m_impulse.x;b.m_linearVelocity.y+=invMass*this.m_impulse.y;b.m_angularVelocity+=invI*(rX*this.m_impulse.y-rY*this.m_impulse.x)};b2MouseJoint.prototype.SolveVelocityConstraints=function(step){var b=this.m_bodyB,tMat,tX=0,tY=0;tMat=b.m_xf.R;var rX=this.m_localAnchor.x-b.m_sweep.localCenter.x,rY=this.m_localAnchor.y-b.m_sweep.localCenter.y;tX=tMat.col1.x*rX+tMat.col2.x*rY;rY=tMat.col1.y*rX+tMat.col2.y*rY;rX=tX;var CdotX=b.m_linearVelocity.x+-b.m_angularVelocity*rY,CdotY=b.m_linearVelocity.y+b.m_angularVelocity*rX;tMat=this.m_mass;tX=CdotX+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x;tY=CdotY+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var impulseX=-(tMat.col1.x*tX+tMat.col2.x*tY),impulseY=-(tMat.col1.y*tX+tMat.col2.y*tY),oldImpulseX=this.m_impulse.x,oldImpulseY=this.m_impulse.y;this.m_impulse.x+=impulseX;this.m_impulse.y+=impulseY;var maxImpulse=step.dt*this.m_maxForce;if(this.m_impulse.LengthSquared()>maxImpulse*maxImpulse){this.m_impulse.Multiply(maxImpulse/this.m_impulse.Length())}impulseX=this.m_impulse.x-oldImpulseX;impulseY=this.m_impulse.y-oldImpulseY;b.m_linearVelocity.x+=b.m_invMass*impulseX;b.m_linearVelocity.y+=b.m_invMass*impulseY;b.m_angularVelocity+=b.m_invI*(rX*impulseY-rY*impulseX)};b2MouseJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;return true};b2MouseJoint.prototype.GetType=function(){return this.m_type};b2MouseJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2MouseJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2MouseJoint.prototype.GetNext=function(){return this.m_next};b2MouseJoint.prototype.GetUserData=function(){return this.m_userData};b2MouseJoint.prototype.SetUserData=function(data){this.m_userData=data};b2MouseJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2MouseJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2MouseJoint.prototype.FinalizeVelocityConstraints=function(){};b2MouseJointDef=Box2D.Dynamics.Joints.b2MouseJointDef=function b2MouseJointDef(){this.target=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_mouseJoint;this.maxForce=0;this.frequencyHz=5;this.dampingRatio=.7};b2MouseJointDef.constructor=b2MouseJointDef;b2MouseJointDef.prototype=Object.create(b2JointDef.prototype);b2MouseJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2PrismaticJoint=Box2D.Dynamics.Joints.b2PrismaticJoint=function b2PrismaticJoint(def){this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_localXAxis1=new b2Vec2;this.m_localYAxis1=new b2Vec2;this.m_axis=new b2Vec2;this.m_perp=new b2Vec2;this.m_K=new b2Mat33;this.m_impulse=new b2Vec3;b2Joint.call(this,def);var tMat,tX=0,tY=0;this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_localXAxis1.SetV(def.localAxisA);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_refAngle=def.referenceAngle;this.m_impulse.SetZero();this.m_motorMass=0;this.m_motorImpulse=0;this.m_lowerTranslation=def.lowerTranslation;this.m_upperTranslation=def.upperTranslation;this.m_maxMotorForce=def.maxMotorForce;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=b2Joint.e_inactiveLimit;this.m_axis.SetZero();this.m_perp.SetZero()};b2PrismaticJoint.constructor=b2PrismaticJoint;b2PrismaticJoint.prototype=Object.create(b2Joint.prototype);b2PrismaticJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2PrismaticJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2PrismaticJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),inv_dt*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))};b2PrismaticJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.y};b2PrismaticJoint.prototype.GetJointTranslation=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,p1=bA.GetWorldPoint(this.m_localAnchor1),p2=bB.GetWorldPoint(this.m_localAnchor2),dX=p2.x-p1.x,dY=p2.y-p1.y,axis=bA.GetWorldVector(this.m_localXAxis1),translation=axis.x*dX+axis.y*dY;return translation};b2PrismaticJoint.prototype.GetJointSpeed=function(){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;
r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var p1X=bA.m_sweep.c.x+r1X,p1Y=bA.m_sweep.c.y+r1Y,p2X=bB.m_sweep.c.x+r2X,p2Y=bB.m_sweep.c.y+r2Y,dX=p2X-p1X,dY=p2Y-p1Y,axis=bA.GetWorldVector(this.m_localXAxis1),v1=bA.m_linearVelocity,v2=bB.m_linearVelocity,w1=bA.m_angularVelocity,w2=bB.m_angularVelocity,speed=dX*(-w1*axis.y)+dY*(w1*axis.x)+(axis.x*(v2.x+-w2*r2Y-v1.x- -w1*r1Y)+axis.y*(v2.y+w2*r2X-v1.y-w1*r1X));return speed};b2PrismaticJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit};b2PrismaticJoint.prototype.EnableLimit=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableLimit=flag};b2PrismaticJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation};b2PrismaticJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation};b2PrismaticJoint.prototype.SetLimits=function(lower,upper){lower=lower||0;upper=upper||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_lowerTranslation=lower;this.m_upperTranslation=upper};b2PrismaticJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor};b2PrismaticJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag};b2PrismaticJoint.prototype.SetMotorSpeed=function(speed){speed=speed||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed};b2PrismaticJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed};b2PrismaticJoint.prototype.SetMaxMotorForce=function(force){force=force||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorForce=force};b2PrismaticJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse};b2PrismaticJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0;this.m_localCenterA.SetV(bA.GetLocalCenter());this.m_localCenterB.SetV(bB.GetLocalCenter());var xf1=bA.GetTransform(),xf2=bB.GetTransform();tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,dY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y;this.m_invMassA=bA.m_invMass;this.m_invMassB=bB.m_invMass;this.m_invIA=bA.m_invI;this.m_invIB=bB.m_invI;{this.m_axis.SetV(b2Math.MulMV(xf1.R,this.m_localXAxis1));this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2;if(this.m_motorMass>Number.MIN_VALUE)this.m_motorMass=1/this.m_motorMass}{this.m_perp.SetV(b2Math.MulMV(xf1.R,this.m_localYAxis1));this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var m1=this.m_invMassA,m2=this.m_invMassB,i1=this.m_invIA,i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1+i2*this.m_s2;this.m_K.col1.z=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=i1+i2;this.m_K.col2.z=i1*this.m_a1+i2*this.m_a2;this.m_K.col3.x=this.m_K.col1.z;this.m_K.col3.y=this.m_K.col2.z;this.m_K.col3.z=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2}if(this.m_enableLimit){var jointTransition=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointTransition<=this.m_lowerTranslation){if(this.m_limitState!=b2Joint.e_atLowerLimit){this.m_limitState=b2Joint.e_atLowerLimit;this.m_impulse.z=0}}else if(jointTransition>=this.m_upperTranslation){if(this.m_limitState!=b2Joint.e_atUpperLimit){this.m_limitState=b2Joint.e_atUpperLimit;this.m_impulse.z=0}}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_impulse.z=0}}else{this.m_limitState=b2Joint.e_inactiveLimit}if(this.m_enableMotor==false){this.m_motorImpulse=0}if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_motorImpulse*=step.dtRatio;var PX=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,PY=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,L1=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,L2=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;bA.m_linearVelocity.x-=this.m_invMassA*PX;bA.m_linearVelocity.y-=this.m_invMassA*PY;bA.m_angularVelocity-=this.m_invIA*L1;bB.m_linearVelocity.x+=this.m_invMassB*PX;bB.m_linearVelocity.y+=this.m_invMassB*PY;bB.m_angularVelocity+=this.m_invIB*L2}else{this.m_impulse.SetZero();this.m_motorImpulse=0}};b2PrismaticJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,v1=bA.m_linearVelocity,w1=bA.m_angularVelocity,v2=bB.m_linearVelocity,w2=bB.m_angularVelocity,PX=0,PY=0,L1=0,L2=0;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var Cdot=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,impulse=this.m_motorMass*(this.m_motorSpeed-Cdot),oldImpulse=this.m_motorImpulse,maxImpulse=step.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;PX=impulse*this.m_axis.x;PY=impulse*this.m_axis.y;L1=impulse*this.m_a1;L2=impulse*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}var Cdot1X=this.m_perp.x*(v2.x-v1.x)+this.m_perp.y*(v2.y-v1.y)+this.m_s2*w2-this.m_s1*w1,Cdot1Y=w2-w1;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var Cdot2=this.m_axis.x*(v2.x-v1.x)+this.m_axis.y*(v2.y-v1.y)+this.m_a2*w2-this.m_a1*w1,f1=this.m_impulse.Copy(),df=this.m_K.Solve33(new b2Vec3,-Cdot1X,-Cdot1Y,-Cdot2);this.m_impulse.Add(df);if(this.m_limitState==b2Joint.e_atLowerLimit){this.m_impulse.z=b2Math.Max(this.m_impulse.z,0)}else if(this.m_limitState==b2Joint.e_atUpperLimit){this.m_impulse.z=b2Math.Min(this.m_impulse.z,0)}var bX=-Cdot1X-(this.m_impulse.z-f1.z)*this.m_K.col3.x,bY=-Cdot1Y-(this.m_impulse.z-f1.z)*this.m_K.col3.y,f2r=this.m_K.Solve22(new b2Vec2,bX,bY);f2r.x+=f1.x;f2r.y+=f1.y;this.m_impulse.x=f2r.x;this.m_impulse.y=f2r.y;df.x=this.m_impulse.x-f1.x;df.y=this.m_impulse.y-f1.y;df.z=this.m_impulse.z-f1.z;PX=df.x*this.m_perp.x+df.z*this.m_axis.x;PY=df.x*this.m_perp.y+df.z*this.m_axis.y;L1=df.x*this.m_s1+df.y+df.z*this.m_a1;L2=df.x*this.m_s2+df.y+df.z*this.m_a2;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}else{var df2=this.m_K.Solve22(new b2Vec2,-Cdot1X,-Cdot1Y);this.m_impulse.x+=df2.x;this.m_impulse.y+=df2.y;PX=df2.x*this.m_perp.x;PY=df2.x*this.m_perp.y;L1=df2.x*this.m_s1+df2.y;L2=df2.x*this.m_s2+df2.y;v1.x-=this.m_invMassA*PX;v1.y-=this.m_invMassA*PY;w1-=this.m_invIA*L1;v2.x+=this.m_invMassB*PX;v2.y+=this.m_invMassB*PY;w2+=this.m_invIB*L2}bA.m_linearVelocity.SetV(v1);bA.m_angularVelocity=w1;bB.m_linearVelocity.SetV(v2);bB.m_angularVelocity=w2};b2PrismaticJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var limitC=0,oldLimitImpulse=0,bA=this.m_bodyA,bB=this.m_bodyB,c1=bA.m_sweep.c,a1=bA.m_sweep.a,c2=bB.m_sweep.c,a2=bB.m_sweep.a,tMat,tX=0,m1=0,m2=0,i1=0,i2=0,linearError=0,angularError=0,active=false,C2=0,R1=b2Mat22.FromAngle(a1),R2=b2Mat22.FromAngle(a2);tMat=R1;var r1X=this.m_localAnchor1.x-this.m_localCenterA.x,r1Y=this.m_localAnchor1.y-this.m_localCenterA.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=R2;var r2X=this.m_localAnchor2.x-this.m_localCenterB.x,r2Y=this.m_localAnchor2.y-this.m_localCenterB.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var dX=c2.x+r2X-c1.x-r1X,dY=c2.y+r2Y-c1.y-r1Y;if(this.m_enableLimit){this.m_axis=b2Math.MulMV(R1,this.m_localXAxis1);this.m_a1=(dX+r1X)*this.m_axis.y-(dY+r1Y)*this.m_axis.x;this.m_a2=r2X*this.m_axis.y-r2Y*this.m_axis.x;var translation=this.m_axis.x*dX+this.m_axis.y*dY;if(b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){C2=b2Math.Clamp(translation,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);linearError=b2Math.Abs(translation);active=true}else if(translation<=this.m_lowerTranslation){C2=b2Math.Clamp(translation-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);linearError=this.m_lowerTranslation-translation;active=true}else if(translation>=this.m_upperTranslation){C2=b2Math.Clamp(translation-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection);linearError=translation-this.m_upperTranslation;active=true}}this.m_perp=b2Math.MulMV(R1,this.m_localYAxis1);this.m_s1=(dX+r1X)*this.m_perp.y-(dY+r1Y)*this.m_perp.x;this.m_s2=r2X*this.m_perp.y-r2Y*this.m_perp.x;var impulse=new b2Vec3,C1X=this.m_perp.x*dX+this.m_perp.y*dY,C1Y=a2-a1-this.m_refAngle;linearError=b2Math.Max(linearError,b2Math.Abs(C1X));angularError=b2Math.Abs(C1Y);if(active){m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;this.m_K.col1.x=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2;this.m_K.col1.y=i1*this.m_s1+i2*this.m_s2;this.m_K.col1.z=i1*this.m_s1*this.m_a1+i2*this.m_s2*this.m_a2;this.m_K.col2.x=this.m_K.col1.y;this.m_K.col2.y=i1+i2;this.m_K.col2.z=i1*this.m_a1+i2*this.m_a2;this.m_K.col3.x=this.m_K.col1.z;this.m_K.col3.y=this.m_K.col2.z;this.m_K.col3.z=m1+m2+i1*this.m_a1*this.m_a1+i2*this.m_a2*this.m_a2;this.m_K.Solve33(impulse,-C1X,-C1Y,-C2)}else{m1=this.m_invMassA;m2=this.m_invMassB;i1=this.m_invIA;i2=this.m_invIB;var k11=m1+m2+i1*this.m_s1*this.m_s1+i2*this.m_s2*this.m_s2,k12=i1*this.m_s1+i2*this.m_s2,k22=i1+i2;this.m_K.col1.Set(k11,k12,0);this.m_K.col2.Set(k12,k22,0);var impulse1=this.m_K.Solve22(new b2Vec2,-C1X,-C1Y);impulse.x=impulse1.x;impulse.y=impulse1.y;impulse.z=0}var PX=impulse.x*this.m_perp.x+impulse.z*this.m_axis.x,PY=impulse.x*this.m_perp.y+impulse.z*this.m_axis.y,L1=impulse.x*this.m_s1+impulse.y+impulse.z*this.m_a1,L2=impulse.x*this.m_s2+impulse.y+impulse.z*this.m_a2;c1.x-=this.m_invMassA*PX;c1.y-=this.m_invMassA*PY;a1-=this.m_invIA*L1;c2.x+=this.m_invMassB*PX;c2.y+=this.m_invMassB*PY;a2+=this.m_invIB*L2;bA.m_sweep.a=a1;bB.m_sweep.a=a2;bA.SynchronizeTransform();bB.SynchronizeTransform();return linearError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2PrismaticJoint.prototype.GetType=function(){return this.m_type};b2PrismaticJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2PrismaticJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2PrismaticJoint.prototype.GetNext=function(){return this.m_next};b2PrismaticJoint.prototype.GetUserData=function(){return this.m_userData};b2PrismaticJoint.prototype.SetUserData=function(data){this.m_userData=data};b2PrismaticJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2PrismaticJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2PrismaticJoint.prototype.FinalizeVelocityConstraints=function(){};b2PrismaticJointDef=Box2D.Dynamics.Joints.b2PrismaticJointDef=function b2PrismaticJointDef(){this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;this.localAxisA=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_prismaticJoint;this.localAxisA.Set(1,0);this.referenceAngle=0;this.enableLimit=false;this.lowerTranslation=0;this.upperTranslation=0;this.enableMotor=false;this.maxMotorForce=0;this.motorSpeed=0};b2PrismaticJointDef.constructor=b2PrismaticJointDef;b2PrismaticJointDef.prototype=Object.create(b2JointDef.prototype);b2PrismaticJointDef.prototype.Initialize=function(bA,bB,anchor,axis){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.localAxisA=this.bodyA.GetLocalVector(axis);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()};b2PrismaticJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2PulleyJoint=Box2D.Dynamics.Joints.b2PulleyJoint=function b2PulleyJoint(def){this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u1=new b2Vec2;this.m_u2=new b2Vec2;b2Joint.call(this,def);var tMat,tX=0,tY=0;this.m_ground=this.m_bodyA.m_world.m_groundBody;this.m_groundAnchor1.x=def.groundAnchorA.x-this.m_ground.m_xf.position.x;this.m_groundAnchor1.y=def.groundAnchorA.y-this.m_ground.m_xf.position.y;this.m_groundAnchor2.x=def.groundAnchorB.x-this.m_ground.m_xf.position.x;this.m_groundAnchor2.y=def.groundAnchorB.y-this.m_ground.m_xf.position.y;this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_ratio=def.ratio;this.m_constant=def.lengthA+this.m_ratio*def.lengthB;this.m_maxLength1=b2Math.Min(def.maxLengthA,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength);this.m_maxLength2=b2Math.Min(def.maxLengthB,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio);this.m_impulse=0;this.m_limitImpulse1=0;this.m_limitImpulse2=0};b2PulleyJoint.constructor=b2PulleyJoint;b2PulleyJoint.prototype=Object.create(b2Joint.prototype);b2PulleyJoint.b2_minPulleyLength=2;b2PulleyJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2PulleyJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2PulleyJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse*this.m_u2.x,inv_dt*this.m_impulse*this.m_u2.y)};b2PulleyJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return 0};b2PulleyJoint.prototype.GetGroundAnchorA=function(){var a=this.m_ground.m_xf.position.Copy();a.Add(this.m_groundAnchor1);return a};b2PulleyJoint.prototype.GetGroundAnchorB=function(){var a=this.m_ground.m_xf.position.Copy();a.Add(this.m_groundAnchor2);return a};b2PulleyJoint.prototype.GetLength1=function(){var p=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),sX=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,sY=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,dX=p.x-sX,dY=p.y-sY;return Math.sqrt(dX*dX+dY*dY)};b2PulleyJoint.prototype.GetLength2=function(){var p=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),sX=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,sY=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,dX=p.x-sX,dY=p.y-sY;return Math.sqrt(dX*dX+dY*dY)};b2PulleyJoint.prototype.GetRatio=function(){return this.m_ratio};b2PulleyJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var p1X=bA.m_sweep.c.x+r1X,p1Y=bA.m_sweep.c.y+r1Y,p2X=bB.m_sweep.c.x+r2X,p2Y=bB.m_sweep.c.y+r2Y,s1X=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,s1Y=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,s2X=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,s2Y=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);this.m_u2.Set(p2X-s2X,p2Y-s2Y);var length1=this.m_u1.Length(),length2=this.m_u2.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.Multiply(1/length1)}else{this.m_u1.SetZero()}if(length2>b2Settings.b2_linearSlop){this.m_u2.Multiply(1/length2)}else{this.m_u2.SetZero()}var C=this.m_constant-length1-this.m_ratio*length2;if(C>0){this.m_state=b2Joint.e_inactiveLimit;this.m_impulse=0}else{this.m_state=b2Joint.e_atUpperLimit}if(length1<this.m_maxLength1){this.m_limitState1=b2Joint.e_inactiveLimit;this.m_limitImpulse1=0}else{this.m_limitState1=b2Joint.e_atUpperLimit}if(length2<this.m_maxLength2){this.m_limitState2=b2Joint.e_inactiveLimit;this.m_limitImpulse2=0}else{this.m_limitState2=b2Joint.e_atUpperLimit}var cr1u1=r1X*this.m_u1.y-r1Y*this.m_u1.x,cr2u2=r2X*this.m_u2.y-r2Y*this.m_u2.x;this.m_limitMass1=bA.m_invMass+bA.m_invI*cr1u1*cr1u1;this.m_limitMass2=bB.m_invMass+bB.m_invI*cr2u2*cr2u2;this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2;this.m_limitMass1=1/this.m_limitMass1;this.m_limitMass2=1/this.m_limitMass2;this.m_pulleyMass=1/this.m_pulleyMass;if(step.warmStarting){this.m_impulse*=step.dtRatio;this.m_limitImpulse1*=step.dtRatio;this.m_limitImpulse2*=step.dtRatio;var P1X=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,P1Y=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,P2X=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,P2Y=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;bA.m_linearVelocity.x+=bA.m_invMass*P1X;bA.m_linearVelocity.y+=bA.m_invMass*P1Y;bA.m_angularVelocity+=bA.m_invI*(r1X*P1Y-r1Y*P1X);bB.m_linearVelocity.x+=bB.m_invMass*P2X;bB.m_linearVelocity.y+=bB.m_invMass*P2Y;bB.m_angularVelocity+=bB.m_invI*(r2X*P2Y-r2Y*P2X)}else{this.m_impulse=0;this.m_limitImpulse1=0;this.m_limitImpulse2=0}};b2PulleyJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat;tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y,tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var v1X=0,v1Y=0,v2X=0,v2Y=0,P1X=0,P1Y=0,P2X=0,P2Y=0,Cdot=0,impulse=0,oldImpulse=0;if(this.m_state==b2Joint.e_atUpperLimit){v1X=bA.m_linearVelocity.x+-bA.m_angularVelocity*r1Y;v1Y=bA.m_linearVelocity.y+bA.m_angularVelocity*r1X;v2X=bB.m_linearVelocity.x+-bB.m_angularVelocity*r2Y;v2Y=bB.m_linearVelocity.y+bB.m_angularVelocity*r2X;Cdot=-(this.m_u1.x*v1X+this.m_u1.y*v1Y)-this.m_ratio*(this.m_u2.x*v2X+this.m_u2.y*v2Y);impulse=this.m_pulleyMass*-Cdot;oldImpulse=this.m_impulse;this.m_impulse=b2Math.Max(0,this.m_impulse+impulse);impulse=this.m_impulse-oldImpulse;P1X=-impulse*this.m_u1.x;P1Y=-impulse*this.m_u1.y;P2X=-this.m_ratio*impulse*this.m_u2.x;P2Y=-this.m_ratio*impulse*this.m_u2.y;bA.m_linearVelocity.x+=bA.m_invMass*P1X;bA.m_linearVelocity.y+=bA.m_invMass*P1Y;bA.m_angularVelocity+=bA.m_invI*(r1X*P1Y-r1Y*P1X);bB.m_linearVelocity.x+=bB.m_invMass*P2X;bB.m_linearVelocity.y+=bB.m_invMass*P2Y;bB.m_angularVelocity+=bB.m_invI*(r2X*P2Y-r2Y*P2X)}if(this.m_limitState1==b2Joint.e_atUpperLimit){v1X=bA.m_linearVelocity.x+-bA.m_angularVelocity*r1Y;v1Y=bA.m_linearVelocity.y+bA.m_angularVelocity*r1X;Cdot=-(this.m_u1.x*v1X+this.m_u1.y*v1Y);impulse=-this.m_limitMass1*Cdot;oldImpulse=this.m_limitImpulse1;this.m_limitImpulse1=b2Math.Max(0,this.m_limitImpulse1+impulse);impulse=this.m_limitImpulse1-oldImpulse;P1X=-impulse*this.m_u1.x;P1Y=-impulse*this.m_u1.y;bA.m_linearVelocity.x+=bA.m_invMass*P1X;bA.m_linearVelocity.y+=bA.m_invMass*P1Y;bA.m_angularVelocity+=bA.m_invI*(r1X*P1Y-r1Y*P1X)}if(this.m_limitState2==b2Joint.e_atUpperLimit){v2X=bB.m_linearVelocity.x+-bB.m_angularVelocity*r2Y;v2Y=bB.m_linearVelocity.y+bB.m_angularVelocity*r2X;Cdot=-(this.m_u2.x*v2X+this.m_u2.y*v2Y);impulse=-this.m_limitMass2*Cdot;oldImpulse=this.m_limitImpulse2;this.m_limitImpulse2=b2Math.Max(0,this.m_limitImpulse2+impulse);impulse=this.m_limitImpulse2-oldImpulse;P2X=-impulse*this.m_u2.x;P2Y=-impulse*this.m_u2.y;bB.m_linearVelocity.x+=bB.m_invMass*P2X;bB.m_linearVelocity.y+=bB.m_invMass*P2Y;bB.m_angularVelocity+=bB.m_invI*(r2X*P2Y-r2Y*P2X)}};b2PulleyJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var bA=this.m_bodyA,bB=this.m_bodyB,tMat,s1X=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,s1Y=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,s2X=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,s2Y=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,r1X=0,r1Y=0,r2X=0,r2Y=0,p1X=0,p1Y=0,p2X=0,p2Y=0,length1=0,length2=0,C=0,impulse=0,oldImpulse=0,oldLimitPositionImpulse=0,tX=0,linearError=0;if(this.m_state==b2Joint.e_atUpperLimit){tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;p1X=bA.m_sweep.c.x+r1X;p1Y=bA.m_sweep.c.y+r1Y;p2X=bB.m_sweep.c.x+r2X;p2Y=bB.m_sweep.c.y+r2Y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);this.m_u2.Set(p2X-s2X,p2Y-s2Y);length1=this.m_u1.Length();length2=this.m_u2.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.Multiply(1/length1)}else{this.m_u1.SetZero()}if(length2>b2Settings.b2_linearSlop){this.m_u2.Multiply(1/length2)}else{this.m_u2.SetZero()}C=this.m_constant-length1-this.m_ratio*length2;linearError=b2Math.Max(linearError,-C);C=b2Math.Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_pulleyMass*C;p1X=-impulse*this.m_u1.x;p1Y=-impulse*this.m_u1.y;p2X=-this.m_ratio*impulse*this.m_u2.x;p2Y=-this.m_ratio*impulse*this.m_u2.y;bA.m_sweep.c.x+=bA.m_invMass*p1X;bA.m_sweep.c.y+=bA.m_invMass*p1Y;bA.m_sweep.a+=bA.m_invI*(r1X*p1Y-r1Y*p1X);bB.m_sweep.c.x+=bB.m_invMass*p2X;bB.m_sweep.c.y+=bB.m_invMass*p2Y;bB.m_sweep.a+=bB.m_invI*(r2X*p2Y-r2Y*p2X);bA.SynchronizeTransform();bB.SynchronizeTransform()}if(this.m_limitState1==b2Joint.e_atUpperLimit){tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;p1X=bA.m_sweep.c.x+r1X;p1Y=bA.m_sweep.c.y+r1Y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);length1=this.m_u1.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.x*=1/length1;this.m_u1.y*=1/length1}else{this.m_u1.SetZero()}C=this.m_maxLength1-length1;linearError=b2Math.Max(linearError,-C);C=b2Math.Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_limitMass1*C;p1X=-impulse*this.m_u1.x;p1Y=-impulse*this.m_u1.y;bA.m_sweep.c.x+=bA.m_invMass*p1X;bA.m_sweep.c.y+=bA.m_invMass*p1Y;bA.m_sweep.a+=bA.m_invI*(r1X*p1Y-r1Y*p1X);bA.SynchronizeTransform()}if(this.m_limitState2==b2Joint.e_atUpperLimit){tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;p2X=bB.m_sweep.c.x+r2X;p2Y=bB.m_sweep.c.y+r2Y;this.m_u2.Set(p2X-s2X,p2Y-s2Y);length2=this.m_u2.Length();if(length2>b2Settings.b2_linearSlop){this.m_u2.x*=1/length2;this.m_u2.y*=1/length2}else{this.m_u2.SetZero()}C=this.m_maxLength2-length2;linearError=b2Math.Max(linearError,-C);C=b2Math.Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_limitMass2*C;p2X=-impulse*this.m_u2.x;p2Y=-impulse*this.m_u2.y;bB.m_sweep.c.x+=bB.m_invMass*p2X;bB.m_sweep.c.y+=bB.m_invMass*p2Y;bB.m_sweep.a+=bB.m_invI*(r2X*p2Y-r2Y*p2X);bB.SynchronizeTransform()}return linearError<b2Settings.b2_linearSlop};b2PulleyJoint.prototype.GetType=function(){return this.m_type};b2PulleyJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2PulleyJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2PulleyJoint.prototype.GetNext=function(){return this.m_next};b2PulleyJoint.prototype.GetUserData=function(){return this.m_userData};b2PulleyJoint.prototype.SetUserData=function(data){this.m_userData=data};b2PulleyJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2PulleyJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2PulleyJoint.prototype.FinalizeVelocityConstraints=function(){};b2PulleyJointDef=Box2D.Dynamics.Joints.b2PulleyJointDef=function b2PulleyJointDef(){this.groundAnchorA=new b2Vec2;this.groundAnchorB=new b2Vec2;this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_pulleyJoint;this.groundAnchorA.Set(-1,1);this.groundAnchorB.Set(1,1);this.localAnchorA.Set(-1,0);this.localAnchorB.Set(1,0);this.lengthA=0;this.maxLengthA=0;this.lengthB=0;this.maxLengthB=0;this.ratio=1;this.collideConnected=true};b2PulleyJointDef.constructor=b2PulleyJointDef;b2PulleyJointDef.prototype=Object.create(b2JointDef.prototype);b2PulleyJointDef.prototype.Initialize=function(bA,bB,gaA,gaB,anchorA,anchorB,r){r=r||0;this.bodyA=bA;this.bodyB=bB;this.groundAnchorA.SetV(gaA);this.groundAnchorB.SetV(gaB);this.localAnchorA=this.bodyA.GetLocalPoint(anchorA);this.localAnchorB=this.bodyB.GetLocalPoint(anchorB);var d1X=anchorA.x-gaA.x,d1Y=anchorA.y-gaA.y;this.lengthA=Math.sqrt(d1X*d1X+d1Y*d1Y);var d2X=anchorB.x-gaB.x,d2Y=anchorB.y-gaB.y;this.lengthB=Math.sqrt(d2X*d2X+d2Y*d2Y);this.ratio=r;var C=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=C-this.ratio*b2PulleyJoint.b2_minPulleyLength;this.maxLengthB=(C-b2PulleyJoint.b2_minPulleyLength)/this.ratio};b2PulleyJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2RevoluteJoint=Box2D.Dynamics.Joints.b2RevoluteJoint=function b2RevoluteJoint(def){this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.K3=new b2Mat22;this.impulse3=new b2Vec3;this.impulse2=new b2Vec2;this.reduced=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_impulse=new b2Vec3;this.m_mass=new b2Mat33;b2Joint.call(this,def);this.m_localAnchor1.SetV(def.localAnchorA);this.m_localAnchor2.SetV(def.localAnchorB);this.m_referenceAngle=def.referenceAngle;this.m_impulse.SetZero();this.m_motorImpulse=0;this.m_lowerAngle=def.lowerAngle;this.m_upperAngle=def.upperAngle;this.m_maxMotorTorque=def.maxMotorTorque;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=b2Joint.e_inactiveLimit};b2RevoluteJoint.constructor=b2RevoluteJoint;b2RevoluteJoint.prototype=Object.create(b2Joint.prototype);b2RevoluteJoint.tImpulse=new b2Vec2;b2RevoluteJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)};b2RevoluteJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)};b2RevoluteJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse.x,inv_dt*this.m_impulse.y)};b2RevoluteJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.z};b2RevoluteJoint.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle};b2RevoluteJoint.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity};b2RevoluteJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit};b2RevoluteJoint.prototype.EnableLimit=function(flag){this.m_enableLimit=flag};b2RevoluteJoint.prototype.GetLowerLimit=function(){return this.m_lowerAngle};b2RevoluteJoint.prototype.GetUpperLimit=function(){return this.m_upperAngle};b2RevoluteJoint.prototype.SetLimits=function(lower,upper){lower=lower||0;upper=upper||0;this.m_lowerAngle=lower;this.m_upperAngle=upper};b2RevoluteJoint.prototype.IsMotorEnabled=function(){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);return this.m_enableMotor};b2RevoluteJoint.prototype.EnableMotor=function(flag){this.m_enableMotor=flag};b2RevoluteJoint.prototype.SetMotorSpeed=function(speed){speed=speed||0;this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed};b2RevoluteJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed};b2RevoluteJoint.prototype.SetMaxMotorTorque=function(torque){torque=torque||0;this.m_maxMotorTorque=torque};b2RevoluteJoint.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque};b2RevoluteJoint.prototype.InitVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0;if(this.m_enableMotor||this.m_enableLimit){}tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var m1=bA.m_invMass,m2=bB.m_invMass,i1=bA.m_invI,i2=bB.m_invI;this.m_mass.col1.x=m1+m2+r1Y*r1Y*i1+r2Y*r2Y*i2;this.m_mass.col2.x=-r1Y*r1X*i1-r2Y*r2X*i2;this.m_mass.col3.x=-r1Y*i1-r2Y*i2;this.m_mass.col1.y=this.m_mass.col2.x;this.m_mass.col2.y=m1+m2+r1X*r1X*i1+r2X*r2X*i2;this.m_mass.col3.y=r1X*i1+r2X*i2;this.m_mass.col1.z=this.m_mass.col3.x;this.m_mass.col2.z=this.m_mass.col3.y;this.m_mass.col3.z=i1+i2;this.m_motorMass=1/(i1+i2);if(this.m_enableMotor==false){this.m_motorImpulse=0}if(this.m_enableLimit){var jointAngle=bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle;if(b2Math.Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointAngle<=this.m_lowerAngle){if(this.m_limitState!=b2Joint.e_atLowerLimit){this.m_impulse.z=0}this.m_limitState=b2Joint.e_atLowerLimit}else if(jointAngle>=this.m_upperAngle){if(this.m_limitState!=b2Joint.e_atUpperLimit){this.m_impulse.z=0}this.m_limitState=b2Joint.e_atUpperLimit}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_impulse.z=0}}else{this.m_limitState=b2Joint.e_inactiveLimit}if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_motorImpulse*=step.dtRatio;var PX=this.m_impulse.x,PY=this.m_impulse.y;bA.m_linearVelocity.x-=m1*PX;bA.m_linearVelocity.y-=m1*PY;bA.m_angularVelocity-=i1*(r1X*PY-r1Y*PX+this.m_motorImpulse+this.m_impulse.z);bB.m_linearVelocity.x+=m2*PX;bB.m_linearVelocity.y+=m2*PY;bB.m_angularVelocity+=i2*(r2X*PY-r2Y*PX+this.m_motorImpulse+this.m_impulse.z)}else{this.m_impulse.SetZero();this.m_motorImpulse=0}};b2RevoluteJoint.prototype.SolveVelocityConstraints=function(step){var bA=this.m_bodyA,bB=this.m_bodyB,tMat,tX=0,newImpulse=0,r1X=0,r1Y=0,r2X=0,r2Y=0,v1=bA.m_linearVelocity,w1=bA.m_angularVelocity,v2=bB.m_linearVelocity,w2=bB.m_angularVelocity,m1=bA.m_invMass,m2=bB.m_invMass,i1=bA.m_invI,i2=bB.m_invI;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var Cdot=w2-w1-this.m_motorSpeed,impulse=this.m_motorMass*-Cdot,oldImpulse=this.m_motorImpulse,maxImpulse=step.dt*this.m_maxMotorTorque;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;w1-=i1*impulse;w2+=i2*impulse}if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;
r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var Cdot1X=v2.x+-w2*r2Y-v1.x- -w1*r1Y,Cdot1Y=v2.y+w2*r2X-v1.y-w1*r1X,Cdot2=w2-w1;this.m_mass.Solve33(this.impulse3,-Cdot1X,-Cdot1Y,-Cdot2);if(this.m_limitState==b2Joint.e_equalLimits){this.m_impulse.Add(this.impulse3)}else if(this.m_limitState==b2Joint.e_atLowerLimit){newImpulse=this.m_impulse.z+this.impulse3.z;if(newImpulse<0){this.m_mass.Solve22(this.reduced,-Cdot1X,-Cdot1Y);this.impulse3.x=this.reduced.x;this.impulse3.y=this.reduced.y;this.impulse3.z=-this.m_impulse.z;this.m_impulse.x+=this.reduced.x;this.m_impulse.y+=this.reduced.y;this.m_impulse.z=0}}else if(this.m_limitState==b2Joint.e_atUpperLimit){newImpulse=this.m_impulse.z+this.impulse3.z;if(newImpulse>0){this.m_mass.Solve22(this.reduced,-Cdot1X,-Cdot1Y);this.impulse3.x=this.reduced.x;this.impulse3.y=this.reduced.y;this.impulse3.z=-this.m_impulse.z;this.m_impulse.x+=this.reduced.x;this.m_impulse.y+=this.reduced.y;this.m_impulse.z=0}}v1.x-=m1*this.impulse3.x;v1.y-=m1*this.impulse3.y;w1-=i1*(r1X*this.impulse3.y-r1Y*this.impulse3.x+this.impulse3.z);v2.x+=m2*this.impulse3.x;v2.y+=m2*this.impulse3.y;w2+=i2*(r2X*this.impulse3.y-r2Y*this.impulse3.x+this.impulse3.z)}else{tMat=bA.m_xf.R;r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x;r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x;r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var CdotX=v2.x+-w2*r2Y-v1.x- -w1*r1Y,CdotY=v2.y+w2*r2X-v1.y-w1*r1X;this.m_mass.Solve22(this.impulse2,-CdotX,-CdotY);this.m_impulse.x+=this.impulse2.x;this.m_impulse.y+=this.impulse2.y;v1.x-=m1*this.impulse2.x;v1.y-=m1*this.impulse2.y;w1-=i1*(r1X*this.impulse2.y-r1Y*this.impulse2.x);v2.x+=m2*this.impulse2.x;v2.y+=m2*this.impulse2.y;w2+=i2*(r2X*this.impulse2.y-r2Y*this.impulse2.x)}bA.m_linearVelocity.SetV(v1);bA.m_angularVelocity=w1;bB.m_linearVelocity.SetV(v2);bB.m_angularVelocity=w2};b2RevoluteJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var oldLimitImpulse=0,C=0,tMat,bA=this.m_bodyA,bB=this.m_bodyB,angularError=0,positionError=0,tX=0,impulseX=0,impulseY=0;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var angle=bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle,limitImpulse=0;if(this.m_limitState==b2Joint.e_equalLimits){C=b2Math.Clamp(angle-this.m_lowerAngle,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection);limitImpulse=-this.m_motorMass*C;angularError=b2Math.Abs(C)}else if(this.m_limitState==b2Joint.e_atLowerLimit){C=angle-this.m_lowerAngle;angularError=-C;C=b2Math.Clamp(C+b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0);limitImpulse=-this.m_motorMass*C}else if(this.m_limitState==b2Joint.e_atUpperLimit){C=angle-this.m_upperAngle;angularError=C;C=b2Math.Clamp(C-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection);limitImpulse=-this.m_motorMass*C}bA.m_sweep.a-=bA.m_invI*limitImpulse;bB.m_sweep.a+=bB.m_invI*limitImpulse;bA.SynchronizeTransform();bB.SynchronizeTransform()}{tMat=bA.m_xf.R;var r1X=this.m_localAnchor1.x-bA.m_sweep.localCenter.x,r1Y=this.m_localAnchor1.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*r1X+tMat.col2.x*r1Y;r1Y=tMat.col1.y*r1X+tMat.col2.y*r1Y;r1X=tX;tMat=bB.m_xf.R;var r2X=this.m_localAnchor2.x-bB.m_sweep.localCenter.x,r2Y=this.m_localAnchor2.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*r2X+tMat.col2.x*r2Y;r2Y=tMat.col1.y*r2X+tMat.col2.y*r2Y;r2X=tX;var CX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X,CY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y,CLengthSquared=CX*CX+CY*CY,CLength=Math.sqrt(CLengthSquared);positionError=CLength;var invMass1=bA.m_invMass,invMass2=bB.m_invMass,invI1=bA.m_invI,invI2=bB.m_invI,k_allowedStretch=10*b2Settings.b2_linearSlop;if(CLengthSquared>k_allowedStretch*k_allowedStretch){var uX=CX/CLength,uY=CY/CLength,k=invMass1+invMass2,m=1/k;impulseX=m*-CX;impulseY=m*-CY;var k_beta=.5;bA.m_sweep.c.x-=k_beta*invMass1*impulseX;bA.m_sweep.c.y-=k_beta*invMass1*impulseY;bB.m_sweep.c.x+=k_beta*invMass2*impulseX;bB.m_sweep.c.y+=k_beta*invMass2*impulseY;CX=bB.m_sweep.c.x+r2X-bA.m_sweep.c.x-r1X;CY=bB.m_sweep.c.y+r2Y-bA.m_sweep.c.y-r1Y}this.K1.col1.x=invMass1+invMass2;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass1+invMass2;this.K2.col1.x=invI1*r1Y*r1Y;this.K2.col2.x=-invI1*r1X*r1Y;this.K2.col1.y=-invI1*r1X*r1Y;this.K2.col2.y=invI1*r1X*r1X;this.K3.col1.x=invI2*r2Y*r2Y;this.K3.col2.x=-invI2*r2X*r2Y;this.K3.col1.y=-invI2*r2X*r2Y;this.K3.col2.y=invI2*r2X*r2X;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Solve(b2RevoluteJoint.tImpulse,-CX,-CY);impulseX=b2RevoluteJoint.tImpulse.x;impulseY=b2RevoluteJoint.tImpulse.y;bA.m_sweep.c.x-=bA.m_invMass*impulseX;bA.m_sweep.c.y-=bA.m_invMass*impulseY;bA.m_sweep.a-=bA.m_invI*(r1X*impulseY-r1Y*impulseX);bB.m_sweep.c.x+=bB.m_invMass*impulseX;bB.m_sweep.c.y+=bB.m_invMass*impulseY;bB.m_sweep.a+=bB.m_invI*(r2X*impulseY-r2Y*impulseX);bA.SynchronizeTransform();bB.SynchronizeTransform()}return positionError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2RevoluteJoint.prototype.GetType=function(){return this.m_type};b2RevoluteJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2RevoluteJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2RevoluteJoint.prototype.GetNext=function(){return this.m_next};b2RevoluteJoint.prototype.GetUserData=function(){return this.m_userData};b2RevoluteJoint.prototype.SetUserData=function(data){this.m_userData=data};b2RevoluteJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2RevoluteJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2RevoluteJoint.prototype.FinalizeVelocityConstraints=function(){};b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef=function b2RevoluteJointDef(){this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_revoluteJoint;this.localAnchorA.Set(0,0);this.localAnchorB.Set(0,0);this.referenceAngle=0;this.lowerAngle=0;this.upperAngle=0;this.maxMotorTorque=0;this.motorSpeed=0;this.enableLimit=false;this.enableMotor=false};b2RevoluteJointDef.constructor=b2RevoluteJointDef;b2RevoluteJointDef.prototype=Object.create(b2JointDef.prototype);b2RevoluteJointDef.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()};b2RevoluteJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2WeldJoint=Box2D.Dynamics.Joints.b2WeldJoint=function b2WeldJoint(def){this.m_localAnchorA=new b2Vec2;this.m_localAnchorB=new b2Vec2;this.m_impulse=new b2Vec3;this.m_mass=new b2Mat33;b2Joint.call(this,def);this.m_localAnchorA.SetV(def.localAnchorA);this.m_localAnchorB.SetV(def.localAnchorB);this.m_referenceAngle=def.referenceAngle;this.m_impulse.SetZero();this.m_mass=new b2Mat33};b2WeldJoint.constructor=b2WeldJoint;b2WeldJoint.prototype=Object.create(b2Joint.prototype);b2WeldJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)};b2WeldJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)};b2WeldJoint.prototype.GetReactionForce=function(inv_dt){inv_dt=inv_dt||0;return new b2Vec2(inv_dt*this.m_impulse.x,inv_dt*this.m_impulse.y)};b2WeldJoint.prototype.GetReactionTorque=function(inv_dt){inv_dt=inv_dt||0;return inv_dt*this.m_impulse.z};b2WeldJoint.prototype.InitVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI;this.m_mass.col1.x=mA+mB+rAY*rAY*iA+rBY*rBY*iB;this.m_mass.col2.x=-rAY*rAX*iA-rBY*rBX*iB;this.m_mass.col3.x=-rAY*iA-rBY*iB;this.m_mass.col1.y=this.m_mass.col2.x;this.m_mass.col2.y=mA+mB+rAX*rAX*iA+rBX*rBX*iB;this.m_mass.col3.y=rAX*iA+rBX*iB;this.m_mass.col1.z=this.m_mass.col3.x;this.m_mass.col2.z=this.m_mass.col3.y;this.m_mass.col3.z=iA+iB;if(step.warmStarting){this.m_impulse.x*=step.dtRatio;this.m_impulse.y*=step.dtRatio;this.m_impulse.z*=step.dtRatio;bA.m_linearVelocity.x-=mA*this.m_impulse.x;bA.m_linearVelocity.y-=mA*this.m_impulse.y;bA.m_angularVelocity-=iA*(rAX*this.m_impulse.y-rAY*this.m_impulse.x+this.m_impulse.z);bB.m_linearVelocity.x+=mB*this.m_impulse.x;bB.m_linearVelocity.y+=mB*this.m_impulse.y;bB.m_angularVelocity+=iB*(rBX*this.m_impulse.y-rBY*this.m_impulse.x+this.m_impulse.z)}else{this.m_impulse.SetZero()}};b2WeldJoint.prototype.SolveVelocityConstraints=function(step){var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB,vA=bA.m_linearVelocity,wA=bA.m_angularVelocity,vB=bB.m_linearVelocity,wB=bB.m_angularVelocity,mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var Cdot1X=vB.x-wB*rBY-vA.x+wA*rAY,Cdot1Y=vB.y+wB*rBX-vA.y-wA*rAX,Cdot2=wB-wA,impulse=new b2Vec3;this.m_mass.Solve33(impulse,-Cdot1X,-Cdot1Y,-Cdot2);this.m_impulse.Add(impulse);vA.x-=mA*impulse.x;vA.y-=mA*impulse.y;wA-=iA*(rAX*impulse.y-rAY*impulse.x+impulse.z);vB.x+=mB*impulse.x;vB.y+=mB*impulse.y;wB+=iB*(rBX*impulse.y-rBY*impulse.x+impulse.z);bA.m_angularVelocity=wA;bB.m_angularVelocity=wB};b2WeldJoint.prototype.SolvePositionConstraints=function(baumgarte){baumgarte=baumgarte||0;var tMat,tX=0,bA=this.m_bodyA,bB=this.m_bodyB;tMat=bA.m_xf.R;var rAX=this.m_localAnchorA.x-bA.m_sweep.localCenter.x,rAY=this.m_localAnchorA.y-bA.m_sweep.localCenter.y;tX=tMat.col1.x*rAX+tMat.col2.x*rAY;rAY=tMat.col1.y*rAX+tMat.col2.y*rAY;rAX=tX;tMat=bB.m_xf.R;var rBX=this.m_localAnchorB.x-bB.m_sweep.localCenter.x,rBY=this.m_localAnchorB.y-bB.m_sweep.localCenter.y;tX=tMat.col1.x*rBX+tMat.col2.x*rBY;rBY=tMat.col1.y*rBX+tMat.col2.y*rBY;rBX=tX;var mA=bA.m_invMass,mB=bB.m_invMass,iA=bA.m_invI,iB=bB.m_invI,C1X=bB.m_sweep.c.x+rBX-bA.m_sweep.c.x-rAX,C1Y=bB.m_sweep.c.y+rBY-bA.m_sweep.c.y-rAY,C2=bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle,k_allowedStretch=10*b2Settings.b2_linearSlop,positionError=Math.sqrt(C1X*C1X+C1Y*C1Y),angularError=b2Math.Abs(C2);if(positionError>k_allowedStretch){iA*=1;iB*=1}this.m_mass.col1.x=mA+mB+rAY*rAY*iA+rBY*rBY*iB;this.m_mass.col2.x=-rAY*rAX*iA-rBY*rBX*iB;this.m_mass.col3.x=-rAY*iA-rBY*iB;this.m_mass.col1.y=this.m_mass.col2.x;this.m_mass.col2.y=mA+mB+rAX*rAX*iA+rBX*rBX*iB;this.m_mass.col3.y=rAX*iA+rBX*iB;this.m_mass.col1.z=this.m_mass.col3.x;this.m_mass.col2.z=this.m_mass.col3.y;this.m_mass.col3.z=iA+iB;var impulse=new b2Vec3;this.m_mass.Solve33(impulse,-C1X,-C1Y,-C2);bA.m_sweep.c.x-=mA*impulse.x;bA.m_sweep.c.y-=mA*impulse.y;bA.m_sweep.a-=iA*(rAX*impulse.y-rAY*impulse.x+impulse.z);bB.m_sweep.c.x+=mB*impulse.x;bB.m_sweep.c.y+=mB*impulse.y;bB.m_sweep.a+=iB*(rBX*impulse.y-rBY*impulse.x+impulse.z);bA.SynchronizeTransform();bB.SynchronizeTransform();return positionError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop};b2WeldJoint.prototype.GetType=function(){return this.m_type};b2WeldJoint.prototype.GetBodyA=function(){return this.m_bodyA};b2WeldJoint.prototype.GetBodyB=function(){return this.m_bodyB};b2WeldJoint.prototype.GetNext=function(){return this.m_next};b2WeldJoint.prototype.GetUserData=function(){return this.m_userData};b2WeldJoint.prototype.SetUserData=function(data){this.m_userData=data};b2WeldJoint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()};b2WeldJoint.prototype.b2Joint=function(def){b2Settings.b2Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData};b2WeldJoint.prototype.FinalizeVelocityConstraints=function(){};b2WeldJointDef=Box2D.Dynamics.Joints.b2WeldJointDef=function b2WeldJointDef(){this.localAnchorA=new b2Vec2;this.localAnchorB=new b2Vec2;b2JointDef.call(this);this.type=b2Joint.e_weldJoint;this.referenceAngle=0};b2WeldJointDef.constructor=b2WeldJointDef;b2WeldJointDef.prototype=Object.create(b2JointDef.prototype);b2WeldJointDef.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchor));this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchor));this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()};b2WeldJointDef.prototype.b2JointDef=function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false};b2ContactListener=Box2D.Dynamics.b2ContactListener=function b2ContactListener(){};b2ContactListener.constructor=b2ContactListener;b2ContactListener.prototype.BeginContact=function(contact){};b2ContactListener.prototype.EndContact=function(contact){};b2ContactListener.prototype.PreSolve=function(contact,oldManifold){};b2ContactListener.prototype.PostSolve=function(contact,impulse){};b2ContactListener.b2_defaultListener=new b2ContactListener;b2ContactFilter=Box2D.Dynamics.b2ContactFilter=function b2ContactFilter(){};b2ContactFilter.constructor=b2ContactFilter;b2ContactFilter.prototype.ShouldCollide=function(fixtureA,fixtureB){var filter1=fixtureA.GetFilterData(),filter2=fixtureB.GetFilterData();if(filter1.groupIndex==filter2.groupIndex&&filter1.groupIndex!=0){return filter1.groupIndex>0}var collide=(filter1.maskBits&filter2.categoryBits)!=0&&(filter1.categoryBits&filter2.maskBits)!=0;return collide};b2ContactFilter.prototype.RayCollide=function(userData,fixture){if(!userData)return true;return this.ShouldCollide(userData instanceof b2Fixture?userData:null,fixture)};b2ContactFilter.b2_defaultFilter=new b2ContactFilter;b2Fixture=Box2D.Dynamics.b2Fixture=function b2Fixture(){this.m_filter=new b2FilterData;this.m_aabb=new b2AABB;this.m_userData=null;this.m_body=null;this.m_next=null;this.m_shape=null;this.m_density=0;this.m_friction=0;this.m_restitution=0};b2Fixture.constructor=b2Fixture;b2Fixture.prototype.GetType=function(){return this.m_shape.GetType()};b2Fixture.prototype.GetShape=function(){return this.m_shape};b2Fixture.prototype.SetSensor=function(sensor){if(this.m_isSensor==sensor)return;this.m_isSensor=sensor;if(this.m_body==null)return;var edge=this.m_body.GetContactList();while(edge){var contact=edge.contact,fixtureA=contact.GetFixtureA(),fixtureB=contact.GetFixtureB();if(fixtureA==this||fixtureB==this)contact.SetSensor(fixtureA.IsSensor()||fixtureB.IsSensor());edge=edge.next}};b2Fixture.prototype.IsSensor=function(){return this.m_isSensor};b2Fixture.prototype.SetFilterData=function(filter){this.m_filter=filter.Copy();if(this.m_body)return;var edge=this.m_body.GetContactList();while(edge){var contact=edge.contact,fixtureA=contact.GetFixtureA(),fixtureB=contact.GetFixtureB();if(fixtureA==this||fixtureB==this)contact.FlagForFiltering();edge=edge.next}};b2Fixture.prototype.GetFilterData=function(){return this.m_filter.Copy()};b2Fixture.prototype.GetBody=function(){return this.m_body};b2Fixture.prototype.GetNext=function(){return this.m_next};b2Fixture.prototype.GetUserData=function(){return this.m_userData};b2Fixture.prototype.SetUserData=function(data){this.m_userData=data};b2Fixture.prototype.TestPoint=function(p){return this.m_shape.TestPoint(this.m_body.GetTransform(),p)};b2Fixture.prototype.RayCast=function(output,input){return this.m_shape.RayCast(output,input,this.m_body.GetTransform())};b2Fixture.prototype.GetMassData=function(massData){massData=massData||null;if(massData==null){massData=new b2MassData}this.m_shape.ComputeMass(massData,this.m_density);return massData};b2Fixture.prototype.SetDensity=function(density){density=density||0;this.m_density=density};b2Fixture.prototype.GetDensity=function(){return this.m_density};b2Fixture.prototype.GetFriction=function(){return this.m_friction};b2Fixture.prototype.SetFriction=function(friction){friction=friction||0;this.m_friction=friction};b2Fixture.prototype.GetRestitution=function(){return this.m_restitution};b2Fixture.prototype.SetRestitution=function(restitution){restitution=restitution||0;this.m_restitution=restitution};b2Fixture.prototype.GetAABB=function(){return this.m_aabb};b2Fixture.prototype.Create=function(body,xf,def){this.m_userData=def.userData;this.m_friction=def.friction;this.m_restitution=def.restitution;this.m_body=body;this.m_next=null;this.m_filter=def.filter.Copy();this.m_isSensor=def.isSensor;this.m_shape=def.shape.Copy();this.m_density=def.density};b2Fixture.prototype.Destroy=function(){this.m_shape=null};b2Fixture.prototype.CreateProxy=function(broadPhase,xf){this.m_shape.ComputeAABB(this.m_aabb,xf);this.m_proxy=broadPhase.CreateProxy(this.m_aabb,this)};b2Fixture.prototype.DestroyProxy=function(broadPhase){if(this.m_proxy==null){return}broadPhase.DestroyProxy(this.m_proxy);this.m_proxy=null};b2Fixture.prototype.Synchronize=function(broadPhase,transform1,transform2){if(!this.m_proxy)return;var aabb1=new b2AABB,aabb2=new b2AABB;this.m_shape.ComputeAABB(aabb1,transform1);this.m_shape.ComputeAABB(aabb2,transform2);this.m_aabb.Combine(aabb1,aabb2);var displacement=b2Math.SubtractVV(transform2.position,transform1.position);broadPhase.MoveProxy(this.m_proxy,this.m_aabb,displacement)};b2ContactManager=Box2D.Dynamics.b2ContactManager=function b2ContactManager(){this.m_world=null;this.m_contactCount=0;this.m_contactFilter=b2ContactFilter.b2_defaultFilter;this.m_contactListener=b2ContactListener.b2_defaultListener;this.m_contactFactory=new b2ContactFactory(this.m_allocator);this.m_broadPhase=new b2DynamicTreeBroadPhase};b2ContactManager.constructor=b2ContactManager;b2ContactManager.s_evalCP=new b2ContactPoint;b2ContactManager.prototype.AddPair=function(proxyUserDataA,proxyUserDataB){var fixtureA=proxyUserDataA instanceof b2Fixture?proxyUserDataA:null,fixtureB=proxyUserDataB instanceof b2Fixture?proxyUserDataB:null,bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA==bodyB)return;var edge=bodyB.GetContactList();while(edge){if(edge.other==bodyA){var fA=edge.contact.GetFixtureA(),fB=edge.contact.GetFixtureB();if(fA==fixtureA&&fB==fixtureB)return;if(fA==fixtureB&&fB==fixtureA)return}edge=edge.next}if(bodyB.ShouldCollide(bodyA)==false){return}if(this.m_contactFilter.ShouldCollide(fixtureA,fixtureB)==false){return}var c=this.m_contactFactory.Create(fixtureA,fixtureB);fixtureA=c.GetFixtureA();fixtureB=c.GetFixtureB();bodyA=fixtureA.m_body;bodyB=fixtureB.m_body;c.m_prev=null;c.m_next=this.m_world.m_contactList;if(this.m_world.m_contactList!=null){this.m_world.m_contactList.m_prev=c}this.m_world.m_contactList=c;c.m_nodeA.contact=c;c.m_nodeA.other=bodyB;c.m_nodeA.prev=null;c.m_nodeA.next=bodyA.m_contactList;if(bodyA.m_contactList!=null){bodyA.m_contactList.prev=c.m_nodeA}bodyA.m_contactList=c.m_nodeA;c.m_nodeB.contact=c;c.m_nodeB.other=bodyA;c.m_nodeB.prev=null;c.m_nodeB.next=bodyB.m_contactList;if(bodyB.m_contactList!=null){bodyB.m_contactList.prev=c.m_nodeB}bodyB.m_contactList=c.m_nodeB;++this.m_world.m_contactCount;return};b2ContactManager.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(Box2D.generateCallback(this,this.AddPair))};b2ContactManager.prototype.Destroy=function(c){var fixtureA=c.GetFixtureA(),fixtureB=c.GetFixtureB(),bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(c.IsTouching()){this.m_contactListener.EndContact(c)}if(c.m_prev){c.m_prev.m_next=c.m_next}if(c.m_next){c.m_next.m_prev=c.m_prev}if(c==this.m_world.m_contactList){this.m_world.m_contactList=c.m_next}if(c.m_nodeA.prev){c.m_nodeA.prev.next=c.m_nodeA.next}if(c.m_nodeA.next){c.m_nodeA.next.prev=c.m_nodeA.prev}if(c.m_nodeA==bodyA.m_contactList){bodyA.m_contactList=c.m_nodeA.next}if(c.m_nodeB.prev){c.m_nodeB.prev.next=c.m_nodeB.next}if(c.m_nodeB.next){c.m_nodeB.next.prev=c.m_nodeB.prev}if(c.m_nodeB==bodyB.m_contactList){bodyB.m_contactList=c.m_nodeB.next}this.m_contactFactory.Destroy(c);--this.m_contactCount};b2ContactManager.prototype.Collide=function(){var c=this.m_world.m_contactList;while(c){var fixtureA=c.GetFixtureA(),fixtureB=c.GetFixtureB(),bodyA=fixtureA.GetBody(),bodyB=fixtureB.GetBody();if(bodyA.IsAwake()==false&&bodyB.IsAwake()==false){c=c.GetNext();continue}if(c.m_flags&b2Contact.e_filterFlag){if(bodyB.ShouldCollide(bodyA)==false){var cNuke=c;c=cNuke.GetNext();this.Destroy(cNuke);continue}if(this.m_contactFilter.ShouldCollide(fixtureA,fixtureB)==false){cNuke=c;c=cNuke.GetNext();this.Destroy(cNuke);continue}c.m_flags&=~b2Contact.e_filterFlag}var proxyA=fixtureA.m_proxy,proxyB=fixtureB.m_proxy,overlap=this.m_broadPhase.TestOverlap(proxyA,proxyB);if(overlap==false){cNuke=c;c=cNuke.GetNext();this.Destroy(cNuke);continue}c.Update(this.m_contactListener);c=c.GetNext()}};b2Body=Box2D.Dynamics.b2Body=function b2Body(bd,world){this.m_xf=new b2Transform;this.m_sweep=new b2Sweep;this.m_linearVelocity=new b2Vec2;this.m_force=new b2Vec2;if(bd.bullet){this.m_flags|=b2Body.e_bulletFlag}if(bd.fixedRotation){this.m_flags|=b2Body.e_fixedRotationFlag}if(bd.allowSleep){this.m_flags|=b2Body.e_allowSleepFlag}if(bd.awake){this.m_flags|=b2Body.e_awakeFlag}if(bd.active){this.m_flags|=b2Body.e_activeFlag}this.m_world=world;this.m_xf.position.SetV(bd.position);this.m_xf.R.Set(bd.angle);this.m_sweep.localCenter.SetZero();this.m_sweep.t0=1;this.m_sweep.a0=this.m_sweep.a=bd.angle;var tMat=this.m_xf.R,tVec=this.m_sweep.localCenter;this.m_sweep.c.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_sweep.c.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_sweep.c.x+=this.m_xf.position.x;this.m_sweep.c.y+=this.m_xf.position.y;this.m_sweep.c0.SetV(this.m_sweep.c);this.m_linearVelocity.SetV(bd.linearVelocity);this.m_angularVelocity=bd.angularVelocity;this.m_linearDamping=bd.linearDamping;this.m_angularDamping=bd.angularDamping;this.m_force.Set(0,0);this.m_type=bd.type;if(this.m_type==b2Body.b2_dynamicBody){this.m_mass=1;this.m_invMass=1}this.m_inertiaScale=bd.inertiaScale;this.m_userData=bd.userData};b2Body.prototype.m_xf=null;b2Body.prototype.m_sweep=null;b2Body.prototype.m_linearVelocity=null;b2Body.prototype.m_force=null;b2Body.prototype.m_flags=0;b2Body.prototype.m_world=null;b2Body.prototype.m_jointList=null;b2Body.prototype.m_controllerList=null;b2Body.prototype.m_contactList=null;b2Body.prototype.m_controllerCount=0;b2Body.prototype.m_prev=null;b2Body.prototype.m_next=null;b2Body.prototype.m_linearVelocity=null;b2Body.prototype.m_angularVelocity=null;b2Body.prototype.m_linearDamping=null;b2Body.prototype.m_angularDamping=null;b2Body.prototype.m_force=null;b2Body.prototype.m_torque=0;b2Body.prototype.m_sleepTime=0;b2Body.prototype.m_type=0;b2Body.prototype.m_mass=0;b2Body.prototype.m_invMass=0;b2Body.prototype.m_I=0;b2Body.prototype.m_invI=0;b2Body.prototype.m_inertiaScale=0;b2Body.prototype.m_userData=null;b2Body.prototype.m_fixtureList=null;b2Body.prototype.m_fixtureCount=0;b2Body.s_xf1=new b2Transform;b2Body.e_islandFlag=1;b2Body.e_awakeFlag=2;b2Body.e_allowSleepFlag=4;b2Body.e_bulletFlag=8;b2Body.e_fixedRotationFlag=16;b2Body.e_activeFlag=32;b2Body.b2_staticBody=0;b2Body.b2_kinematicBody=1;b2Body.b2_dynamicBody=2;b2Body.prototype.connectEdges=function(s1,s2,angle1){angle1=angle1||0;var angle2=Math.atan2(s2.GetDirectionVector().y,s2.GetDirectionVector().x),coreOffset=Math.tan((angle2-angle1)*.5),core=b2Math.MulFV(coreOffset,s2.GetDirectionVector());core=b2Math.SubtractVV(core,s2.GetNormalVector());core=b2Math.MulFV(b2Settings.b2_toiSlop,core);core=b2Math.AddVV(core,s2.GetVertex1());var cornerDir=b2Math.AddVV(s1.GetDirectionVector(),s2.GetDirectionVector());cornerDir.Normalize();var convex=b2Math.Dot(s1.GetDirectionVector(),s2.GetNormalVector())>0;s1.SetNextEdge(s2,core,cornerDir,convex);s2.SetPrevEdge(s1,core,cornerDir,convex);return angle2};b2Body.prototype.CreateFixture=function(def){if(this.m_world.IsLocked()==true){return null}var fixture=new b2Fixture;fixture.Create(this,this.m_xf,def);if(this.m_flags&b2Body.e_activeFlag){var broadPhase=this.m_world.m_contactManager.m_broadPhase;fixture.CreateProxy(broadPhase,this.m_xf)}fixture.m_next=this.m_fixtureList;this.m_fixtureList=fixture;++this.m_fixtureCount;fixture.m_body=this;if(fixture.m_density>0){this.ResetMassData()}this.m_world.m_flags|=b2World.e_newFixture;return fixture};b2Body.prototype.CreateFixture2=function(shape,density){density=density||0;var def=new b2FixtureDef;def.shape=shape;def.density=density;return this.CreateFixture(def)};b2Body.prototype.DestroyFixture=function(fixture){if(this.m_world.IsLocked()==true){return}var node=this.m_fixtureList,ppF=null,found=false;while(node!=null){if(node==fixture){if(ppF)ppF.m_next=fixture.m_next;else this.m_fixtureList=fixture.m_next;found=true;break}ppF=node;node=node.m_next}var edge=this.m_contactList;while(edge){var c=edge.contact;edge=edge.next;var fixtureA=c.GetFixtureA(),fixtureB=c.GetFixtureB();if(fixture==fixtureA||fixture==fixtureB){this.m_world.m_contactManager.Destroy(c)}}if(this.m_flags&b2Body.e_activeFlag){var broadPhase=this.m_world.m_contactManager.m_broadPhase;fixture.DestroyProxy(broadPhase)}else{}fixture.Destroy();fixture.m_body=null;fixture.m_next=null;--this.m_fixtureCount;this.ResetMassData()};b2Body.prototype.SetPositionAndAngle=function(position,angle){angle=angle||0;var f;if(this.m_world.IsLocked()==true){return}this.m_xf.R.Set(angle);this.m_xf.position.SetV(position);var tMat=this.m_xf.R,tVec=this.m_sweep.localCenter;this.m_sweep.c.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;this.m_sweep.c.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;this.m_sweep.c.x+=this.m_xf.position.x;this.m_sweep.c.y+=this.m_xf.position.y;this.m_sweep.c0.SetV(this.m_sweep.c);this.m_sweep.a0=this.m_sweep.a=angle;var broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.Synchronize(broadPhase,this.m_xf,this.m_xf)}this.m_world.m_contactManager.FindNewContacts()};b2Body.prototype.SetTransform=function(xf){this.SetPositionAndAngle(xf.position,xf.GetAngle())};b2Body.prototype.GetTransform=function(){return this.m_xf};b2Body.prototype.GetPosition=function(){return this.m_xf.position};b2Body.prototype.SetPosition=function(position){this.SetPositionAndAngle(position,this.GetAngle())};b2Body.prototype.GetAngle=function(){return this.m_sweep.a};b2Body.prototype.SetAngle=function(angle){angle=angle||0;this.SetPositionAndAngle(this.GetPosition(),angle)};b2Body.prototype.GetWorldCenter=function(){return this.m_sweep.c};b2Body.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter};b2Body.prototype.SetLinearVelocity=function(v){if(this.m_type==b2Body.b2_staticBody){return}this.m_linearVelocity.SetV(v)};b2Body.prototype.GetLinearVelocity=function(){return this.m_linearVelocity};b2Body.prototype.SetAngularVelocity=function(omega){omega=omega||0;if(this.m_type==b2Body.b2_staticBody){return}this.m_angularVelocity=omega};b2Body.prototype.GetAngularVelocity=function(){return this.m_angularVelocity};b2Body.prototype.GetDefinition=function(){var bd=new b2BodyDef;bd.type=this.GetType();bd.allowSleep=(this.m_flags&b2Body.e_allowSleepFlag)==b2Body.e_allowSleepFlag;bd.angle=this.GetAngle();bd.angularDamping=this.m_angularDamping;bd.angularVelocity=this.m_angularVelocity;bd.fixedRotation=(this.m_flags&b2Body.e_fixedRotationFlag)==b2Body.e_fixedRotationFlag;bd.bullet=(this.m_flags&b2Body.e_bulletFlag)==b2Body.e_bulletFlag;bd.awake=(this.m_flags&b2Body.e_awakeFlag)==b2Body.e_awakeFlag;bd.linearDamping=this.m_linearDamping;bd.linearVelocity.SetV(this.GetLinearVelocity());bd.position=this.GetPosition();bd.userData=this.GetUserData();return bd};b2Body.prototype.ApplyForce=function(force,point){if(this.m_type!=b2Body.b2_dynamicBody){return}if(this.IsAwake()==false){this.SetAwake(true)}this.m_force.x+=force.x;this.m_force.y+=force.y;this.m_torque+=(point.x-this.m_sweep.c.x)*force.y-(point.y-this.m_sweep.c.y)*force.x};b2Body.prototype.ApplyTorque=function(torque){torque=torque||0;if(this.m_type!=b2Body.b2_dynamicBody){return}if(this.IsAwake()==false){this.SetAwake(true)}this.m_torque+=torque};b2Body.prototype.ApplyImpulse=function(impulse,point){if(this.m_type!=b2Body.b2_dynamicBody){return}if(this.IsAwake()==false){this.SetAwake(true)}this.m_linearVelocity.x+=this.m_invMass*impulse.x;this.m_linearVelocity.y+=this.m_invMass*impulse.y;this.m_angularVelocity+=this.m_invI*((point.x-this.m_sweep.c.x)*impulse.y-(point.y-this.m_sweep.c.y)*impulse.x)};b2Body.prototype.Split=function(callback){var linearVelocity=this.GetLinearVelocity().Copy(),angularVelocity=this.GetAngularVelocity(),center=this.GetWorldCenter(),body1=this,body2=this.m_world.CreateBody(this.GetDefinition()),prev;for(var f=body1.m_fixtureList;f;){if(callback(f)){var next=f.m_next;if(prev){prev.m_next=next}else{body1.m_fixtureList=next}body1.m_fixtureCount--;f.m_next=body2.m_fixtureList;body2.m_fixtureList=f;body2.m_fixtureCount++;f.m_body=body2;f=next}else{prev=f;f=f.m_next}}body1.ResetMassData();body2.ResetMassData();var center1=body1.GetWorldCenter(),center2=body2.GetWorldCenter(),velocity1=b2Math.AddVV(linearVelocity,b2Math.CrossFV(angularVelocity,b2Math.SubtractVV(center1,center))),velocity2=b2Math.AddVV(linearVelocity,b2Math.CrossFV(angularVelocity,b2Math.SubtractVV(center2,center)));body1.SetLinearVelocity(velocity1);body2.SetLinearVelocity(velocity2);body1.SetAngularVelocity(angularVelocity);body2.SetAngularVelocity(angularVelocity);body1.SynchronizeFixtures();body2.SynchronizeFixtures();return body2};b2Body.prototype.Merge=function(other){var f;for(f=other.m_fixtureList;f;){var next=f.m_next;other.m_fixtureCount--;f.m_next=this.m_fixtureList;this.m_fixtureList=f;this.m_fixtureCount++;f.m_body=body2;f=next}body1.m_fixtureCount=0;var body1=this,body2=other,center1=body1.GetWorldCenter(),center2=body2.GetWorldCenter(),velocity1=body1.GetLinearVelocity().Copy(),velocity2=body2.GetLinearVelocity().Copy(),angular1=body1.GetAngularVelocity(),angular=body2.GetAngularVelocity();body1.ResetMassData();this.SynchronizeFixtures()};b2Body.prototype.GetMass=function(){return this.m_mass};b2Body.prototype.GetInertia=function(){return this.m_I};b2Body.prototype.GetMassData=function(data){data.mass=this.m_mass;data.I=this.m_I;data.center.SetV(this.m_sweep.localCenter)};b2Body.prototype.SetMassData=function(massData){b2Settings.b2Assert(this.m_world.IsLocked()==false);if(this.m_world.IsLocked()==true){return}if(this.m_type!=b2Body.b2_dynamicBody){return}this.m_invMass=0;this.m_I=0;this.m_invI=0;this.m_mass=massData.mass;if(this.m_mass<=0){this.m_mass=1}this.m_invMass=1/this.m_mass;if(massData.I>0&&(this.m_flags&b2Body.e_fixedRotationFlag)==0){this.m_I=massData.I-this.m_mass*(massData.center.x*massData.center.x+massData.center.y*massData.center.y);this.m_invI=1/this.m_I}var oldCenter=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(massData.center);this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter));
this.m_sweep.c.SetV(this.m_sweep.c0);this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-oldCenter.y);this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-oldCenter.x)};b2Body.prototype.ResetMassData=function(){this.m_mass=0;this.m_invMass=0;this.m_I=0;this.m_invI=0;this.m_sweep.localCenter.SetZero();if(this.m_type==b2Body.b2_staticBody||this.m_type==b2Body.b2_kinematicBody){return}var center=b2Vec2.Make(0,0);for(var f=this.m_fixtureList;f;f=f.m_next){if(f.m_density==0){continue}var massData=f.GetMassData();this.m_mass+=massData.mass;center.x+=massData.center.x*massData.mass;center.y+=massData.center.y*massData.mass;this.m_I+=massData.I}if(this.m_mass>0){this.m_invMass=1/this.m_mass;center.x*=this.m_invMass;center.y*=this.m_invMass}else{this.m_mass=1;this.m_invMass=1}if(this.m_I>0&&(this.m_flags&b2Body.e_fixedRotationFlag)==0){this.m_I-=this.m_mass*(center.x*center.x+center.y*center.y);this.m_I*=this.m_inertiaScale;b2Settings.b2Assert(this.m_I>0);this.m_invI=1/this.m_I}else{this.m_I=0;this.m_invI=0}var oldCenter=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(center);this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter));this.m_sweep.c.SetV(this.m_sweep.c0);this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-oldCenter.y);this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-oldCenter.x)};b2Body.prototype.GetWorldPoint=function(localPoint){var A=this.m_xf.R,u=new b2Vec2(A.col1.x*localPoint.x+A.col2.x*localPoint.y,A.col1.y*localPoint.x+A.col2.y*localPoint.y);u.x+=this.m_xf.position.x;u.y+=this.m_xf.position.y;return u};b2Body.prototype.GetWorldVector=function(localVector){return b2Math.MulMV(this.m_xf.R,localVector)};b2Body.prototype.GetLocalPoint=function(worldPoint){return b2Math.MulXT(this.m_xf,worldPoint)};b2Body.prototype.GetLocalVector=function(worldVector){return b2Math.MulTMV(this.m_xf.R,worldVector)};b2Body.prototype.GetLinearVelocityFromWorldPoint=function(worldPoint){return new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(worldPoint.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(worldPoint.x-this.m_sweep.c.x))};b2Body.prototype.GetLinearVelocityFromLocalPoint=function(localPoint){var A=this.m_xf.R,worldPoint=new b2Vec2(A.col1.x*localPoint.x+A.col2.x*localPoint.y,A.col1.y*localPoint.x+A.col2.y*localPoint.y);worldPoint.x+=this.m_xf.position.x;worldPoint.y+=this.m_xf.position.y;return new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(worldPoint.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(worldPoint.x-this.m_sweep.c.x))};b2Body.prototype.GetLinearDamping=function(){return this.m_linearDamping};b2Body.prototype.SetLinearDamping=function(linearDamping){linearDamping=linearDamping||0;this.m_linearDamping=linearDamping};b2Body.prototype.GetAngularDamping=function(){return this.m_angularDamping};b2Body.prototype.SetAngularDamping=function(angularDamping){angularDamping=angularDamping||0;this.m_angularDamping=angularDamping};b2Body.prototype.SetType=function(type){type=type||0;if(this.m_type==type){return}this.m_type=type;this.ResetMassData();if(this.m_type==b2Body.b2_staticBody){this.m_linearVelocity.SetZero();this.m_angularVelocity=0}this.SetAwake(true);this.m_force.SetZero();this.m_torque=0;for(var ce=this.m_contactList;ce;ce=ce.next){ce.contact.FlagForFiltering()}};b2Body.prototype.GetType=function(){return this.m_type};b2Body.prototype.SetBullet=function(flag){if(flag){this.m_flags|=b2Body.e_bulletFlag}else{this.m_flags&=~b2Body.e_bulletFlag}};b2Body.prototype.IsBullet=function(){return(this.m_flags&b2Body.e_bulletFlag)==b2Body.e_bulletFlag};b2Body.prototype.SetSleepingAllowed=function(flag){if(flag){this.m_flags|=b2Body.e_allowSleepFlag}else{this.m_flags&=~b2Body.e_allowSleepFlag;this.SetAwake(true)}};b2Body.prototype.SetAwake=function(flag){if(flag){this.m_flags|=b2Body.e_awakeFlag;this.m_sleepTime=0}else{this.m_flags&=~b2Body.e_awakeFlag;this.m_sleepTime=0;this.m_linearVelocity.SetZero();this.m_angularVelocity=0;this.m_force.SetZero();this.m_torque=0}};b2Body.prototype.IsAwake=function(){return(this.m_flags&b2Body.e_awakeFlag)==b2Body.e_awakeFlag};b2Body.prototype.SetFixedRotation=function(fixed){if(fixed){this.m_flags|=b2Body.e_fixedRotationFlag}else{this.m_flags&=~b2Body.e_fixedRotationFlag}this.ResetMassData()};b2Body.prototype.IsFixedRotation=function(){return(this.m_flags&b2Body.e_fixedRotationFlag)==b2Body.e_fixedRotationFlag};b2Body.prototype.SetActive=function(flag){if(flag==this.IsActive()){return}var broadPhase,f;if(flag){this.m_flags|=b2Body.e_activeFlag;broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.CreateProxy(broadPhase,this.m_xf)}}else{this.m_flags&=~b2Body.e_activeFlag;broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.DestroyProxy(broadPhase)}var ce=this.m_contactList;while(ce){var ce0=ce;ce=ce.next;this.m_world.m_contactManager.Destroy(ce0.contact)}this.m_contactList=null}};b2Body.prototype.IsActive=function(){return(this.m_flags&b2Body.e_activeFlag)==b2Body.e_activeFlag};b2Body.prototype.IsSleepingAllowed=function(){return(this.m_flags&b2Body.e_allowSleepFlag)==b2Body.e_allowSleepFlag};b2Body.prototype.GetFixtureList=function(){return this.m_fixtureList};b2Body.prototype.GetJointList=function(){return this.m_jointList};b2Body.prototype.GetControllerList=function(){return this.m_controllerList};b2Body.prototype.GetContactList=function(){return this.m_contactList};b2Body.prototype.GetNext=function(){return this.m_next};b2Body.prototype.GetUserData=function(){return this.m_userData};b2Body.prototype.SetUserData=function(data){this.m_userData=data};b2Body.prototype.GetWorld=function(){return this.m_world};b2Body.prototype.SynchronizeFixtures=function(){var xf1=b2Body.s_xf1;xf1.R.Set(this.m_sweep.a0);var tMat=xf1.R,tVec=this.m_sweep.localCenter;xf1.position.x=this.m_sweep.c0.x-(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);xf1.position.y=this.m_sweep.c0.y-(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y);var f,broadPhase=this.m_world.m_contactManager.m_broadPhase;for(f=this.m_fixtureList;f;f=f.m_next){f.Synchronize(broadPhase,xf1,this.m_xf)}};b2Body.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var tMat=this.m_xf.R,tVec=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(tMat.col1.x*tVec.x+tMat.col2.x*tVec.y);this.m_xf.position.y=this.m_sweep.c.y-(tMat.col1.y*tVec.x+tMat.col2.y*tVec.y)};b2Body.prototype.ShouldCollide=function(other){if(this.m_type!=b2Body.b2_dynamicBody&&other.m_type!=b2Body.b2_dynamicBody){return false}for(var jn=this.m_jointList;jn;jn=jn.next){if(jn.other==other)if(jn.joint.m_collideConnected==false){return false}}return true};b2Body.prototype.Advance=function(t){t=t||0;this.m_sweep.Advance(t);this.m_sweep.c.SetV(this.m_sweep.c0);this.m_sweep.a=this.m_sweep.a0;this.SynchronizeTransform()};b2DebugDraw=Box2D.Dynamics.b2DebugDraw=function b2DebugDraw(){this.m_drawScale=1;this.m_lineThickness=1;this.m_alpha=1;this.m_fillAlpha=1;this.m_xformScale=1;var __this=this;this.m_sprite={graphics:{clear:function(){__this.m_ctx.clearRect(0,0,__this.m_ctx.canvas.width,__this.m_ctx.canvas.height)}}};this.m_drawFlags=0};b2DebugDraw.constructor=b2DebugDraw;b2DebugDraw.e_shapeBit=1;b2DebugDraw.e_jointBit=2;b2DebugDraw.e_aabbBit=4;b2DebugDraw.e_pairBit=8;b2DebugDraw.e_centerOfMassBit=16;b2DebugDraw.e_controllerBit=32;b2DebugDraw.prototype.SetFlags=function(flags){flags=flags||0;this.m_drawFlags=flags};b2DebugDraw.prototype.GetFlags=function(){return this.m_drawFlags};b2DebugDraw.prototype.AppendFlags=function(flags){flags=flags||0;this.m_drawFlags|=flags};b2DebugDraw.prototype.ClearFlags=function(flags){flags=flags||0;this.m_drawFlags&=~flags};b2DebugDraw.prototype.SetSprite=function(sprite){this.m_ctx=sprite};b2DebugDraw.prototype.GetSprite=function(){return this.m_ctx};b2DebugDraw.prototype.SetDrawScale=function(drawScale){drawScale=drawScale||0;this.m_drawScale=drawScale};b2DebugDraw.prototype.GetDrawScale=function(){return this.m_drawScale};b2DebugDraw.prototype.SetLineThickness=function(lineThickness){lineThickness=lineThickness||0;this.m_lineThickness=lineThickness;this.m_ctx.strokeWidth=lineThickness};b2DebugDraw.prototype.GetLineThickness=function(){return this.m_lineThickness};b2DebugDraw.prototype.SetAlpha=function(alpha){alpha=alpha||0;this.m_alpha=alpha};b2DebugDraw.prototype.GetAlpha=function(){return this.m_alpha};b2DebugDraw.prototype.SetFillAlpha=function(alpha){alpha=alpha||0;this.m_fillAlpha=alpha};b2DebugDraw.prototype.GetFillAlpha=function(){return this.m_fillAlpha};b2DebugDraw.prototype.SetXFormScale=function(xformScale){xformScale=xformScale||0;this.m_xformScale=xformScale};b2DebugDraw.prototype.GetXFormScale=function(){return this.m_xformScale};b2DebugDraw.prototype.DrawPolygon=function(vertices,vertexCount,color){if(!vertexCount)return;var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.moveTo(vertices[0].x*drawScale,vertices[0].y*drawScale);for(var i=1;i<vertexCount;i++){s.lineTo(vertices[i].x*drawScale,vertices[i].y*drawScale)}s.lineTo(vertices[0].x*drawScale,vertices[0].y*drawScale);s.closePath();s.stroke()};b2DebugDraw.prototype.DrawSolidPolygon=function(vertices,vertexCount,color){if(!vertexCount)return;var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.fillStyle=this._color(color.color,this.m_fillAlpha);s.moveTo(vertices[0].x*drawScale,vertices[0].y*drawScale);for(var i=1;i<vertexCount;i++){s.lineTo(vertices[i].x*drawScale,vertices[i].y*drawScale)}s.lineTo(vertices[0].x*drawScale,vertices[0].y*drawScale);s.closePath();s.fill();s.stroke()};b2DebugDraw.prototype.DrawCircle=function(center,radius,color){if(!radius)return;var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.arc(center.x*drawScale,center.y*drawScale,radius*drawScale,0,Math.PI*2,true);s.closePath();s.stroke()};b2DebugDraw.prototype.DrawSolidCircle=function(center,radius,axis,color){if(!radius)return;var s=this.m_ctx,drawScale=this.m_drawScale,cx=center.x*drawScale,cy=center.y*drawScale;s.moveTo(0,0);s.beginPath();s.strokeStyle=this._color(color.color,this.m_alpha);s.fillStyle=this._color(color.color,this.m_fillAlpha);s.arc(cx,cy,radius*drawScale,0,Math.PI*2,true);s.moveTo(cx,cy);s.lineTo((center.x+axis.x*radius)*drawScale,(center.y+axis.y*radius)*drawScale);s.closePath();s.fill();s.stroke()};b2DebugDraw.prototype.DrawSegment=function(p1,p2,color){var s=this.m_ctx,drawScale=this.m_drawScale;s.strokeStyle=this._color(color.color,this.m_alpha);s.beginPath();s.moveTo(p1.x*drawScale,p1.y*drawScale);s.lineTo(p2.x*drawScale,p2.y*drawScale);s.closePath();s.stroke()};b2DebugDraw.prototype.DrawTransform=function(xf){var s=this.m_ctx,drawScale=this.m_drawScale;s.beginPath();s.strokeStyle=this._color(16711680,this.m_alpha);s.moveTo(xf.position.x*drawScale,xf.position.y*drawScale);s.lineTo((xf.position.x+this.m_xformScale*xf.R.col1.x)*drawScale,(xf.position.y+this.m_xformScale*xf.R.col1.y)*drawScale);s.strokeStyle=this._color(65280,this.m_alpha);s.moveTo(xf.position.x*drawScale,xf.position.y*drawScale);s.lineTo((xf.position.x+this.m_xformScale*xf.R.col2.x)*drawScale,(xf.position.y+this.m_xformScale*xf.R.col2.y)*drawScale);s.closePath();s.stroke()};b2DebugDraw.prototype._color=function(color,alpha){return"rgba("+((color&16711680)>>16)+","+((color&65280)>>8)+","+(color&255)+","+alpha+")"};b2BodyDef=Box2D.Dynamics.b2BodyDef=function b2BodyDef(){this.position=new b2Vec2;this.linearVelocity=new b2Vec2;this.position.Set(0,0);this.linearVelocity.Set(0,0)};b2BodyDef.prototype.position=null;b2BodyDef.prototype.linearVelocity=null;b2BodyDef.prototype.userData=null;b2BodyDef.prototype.angle=0;b2BodyDef.prototype.linearVelocity=null;b2BodyDef.prototype.angularVelocity=0;b2BodyDef.prototype.linearDamping=0;b2BodyDef.prototype.angularDamping=0;b2BodyDef.prototype.allowSleep=true;b2BodyDef.prototype.awake=true;b2BodyDef.prototype.fixedRotation=false;b2BodyDef.prototype.bullet=false;b2BodyDef.prototype.type=b2Body.b2_staticBody;b2BodyDef.prototype.active=true;b2BodyDef.prototype.inertiaScale=1;b2ContactFilter=Box2D.Dynamics.b2ContactFilter=function b2ContactFilter(){};b2ContactFilter.constructor=b2ContactFilter;b2ContactFilter.prototype.ShouldCollide=function(fixtureA,fixtureB){var filter1=fixtureA.GetFilterData(),filter2=fixtureB.GetFilterData();if(filter1.groupIndex==filter2.groupIndex&&filter1.groupIndex!=0){return filter1.groupIndex>0}var collide=(filter1.maskBits&filter2.categoryBits)!=0&&(filter1.categoryBits&filter2.maskBits)!=0;return collide};b2ContactFilter.prototype.RayCollide=function(userData,fixture){if(!userData)return true;return this.ShouldCollide(userData instanceof b2Fixture?userData:null,fixture)};b2ContactFilter.b2_defaultFilter=new b2ContactFilter;b2ContactImpulse=Box2D.Dynamics.b2ContactImpulse=function b2ContactImpulse(){this.normalImpulses=new Vector_a2j_Number(b2Settings.b2_maxManifoldPoints);this.tangentImpulses=new Vector_a2j_Number(b2Settings.b2_maxManifoldPoints)};b2ContactImpulse.constructor=b2ContactImpulse;b2FixtureDef=Box2D.Dynamics.b2FixtureDef=function b2FixtureDef(){this.filter=new b2FilterData;this.filter.categoryBits=1;this.filter.maskBits=65535;this.filter.groupIndex=0};b2FixtureDef.prototype.shape=null;b2FixtureDef.prototype.userData=null;b2FixtureDef.prototype.friction=.2;b2FixtureDef.prototype.restitution=0;b2FixtureDef.prototype.density=0;b2FixtureDef.prototype.isSensor=false;b2FixtureDef.prototype.filter=null;b2Island=Box2D.Dynamics.b2Island=function b2Island(){this.m_bodies=new Vector;this.m_contacts=new Vector;this.m_joints=new Vector};b2Island.constructor=b2Island;b2Island.s_impulse=new b2ContactImpulse;b2Island.prototype.Initialize=function(bodyCapacity,contactCapacity,jointCapacity,allocator,listener,contactSolver){bodyCapacity=bodyCapacity||0;contactCapacity=contactCapacity||0;jointCapacity=jointCapacity||0;var i=0;this.m_bodyCapacity=bodyCapacity;this.m_contactCapacity=contactCapacity;this.m_jointCapacity=jointCapacity;this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0;this.m_allocator=allocator;this.m_listener=listener;this.m_contactSolver=contactSolver;for(i=this.m_bodies.length;i<bodyCapacity;i++)this.m_bodies[i]=null;for(i=this.m_contacts.length;i<contactCapacity;i++)this.m_contacts[i]=null;for(i=this.m_joints.length;i<jointCapacity;i++)this.m_joints[i]=null};b2Island.prototype.Clear=function(){this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0};b2Island.prototype.Solve=function(step,gravity,allowSleep){var i=0,j=0,b,joint;for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.GetType()!=b2Body.b2_dynamicBody)continue;b.m_linearVelocity.x+=step.dt*(gravity.x+b.m_invMass*b.m_force.x);b.m_linearVelocity.y+=step.dt*(gravity.y+b.m_invMass*b.m_force.y);b.m_angularVelocity+=step.dt*b.m_invI*b.m_torque;b.m_linearVelocity.Multiply(b2Math.Clamp(1-step.dt*b.m_linearDamping,0,1));b.m_angularVelocity*=b2Math.Clamp(1-step.dt*b.m_angularDamping,0,1)}this.m_contactSolver.Initialize(step,this.m_contacts,this.m_contactCount,this.m_allocator);var contactSolver=this.m_contactSolver;contactSolver.InitVelocityConstraints(step);for(i=0;i<this.m_jointCount;++i){joint=this.m_joints[i];joint.InitVelocityConstraints(step)}for(i=0;i<step.velocityIterations;++i){for(j=0;j<this.m_jointCount;++j){joint=this.m_joints[j];joint.SolveVelocityConstraints(step)}contactSolver.SolveVelocityConstraints()}for(i=0;i<this.m_jointCount;++i){joint=this.m_joints[i];joint.FinalizeVelocityConstraints()}contactSolver.FinalizeVelocityConstraints();for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.GetType()==b2Body.b2_staticBody)continue;var translationX=step.dt*b.m_linearVelocity.x,translationY=step.dt*b.m_linearVelocity.y;if(translationX*translationX+translationY*translationY>b2Settings.b2_maxTranslationSquared){b.m_linearVelocity.Normalize();b.m_linearVelocity.x*=b2Settings.b2_maxTranslation*step.inv_dt;b.m_linearVelocity.y*=b2Settings.b2_maxTranslation*step.inv_dt}var rotation=step.dt*b.m_angularVelocity;if(rotation*rotation>b2Settings.b2_maxRotationSquared){if(b.m_angularVelocity<0){b.m_angularVelocity=-b2Settings.b2_maxRotation*step.inv_dt}else{b.m_angularVelocity=b2Settings.b2_maxRotation*step.inv_dt}}b.m_sweep.c0.SetV(b.m_sweep.c);b.m_sweep.a0=b.m_sweep.a;b.m_sweep.c.x+=step.dt*b.m_linearVelocity.x;b.m_sweep.c.y+=step.dt*b.m_linearVelocity.y;b.m_sweep.a+=step.dt*b.m_angularVelocity;b.SynchronizeTransform()}for(i=0;i<step.positionIterations;++i){var contactsOkay=contactSolver.SolvePositionConstraints(b2Settings.b2_contactBaumgarte),jointsOkay=true;for(j=0;j<this.m_jointCount;++j){joint=this.m_joints[j];var jointOkay=joint.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);jointsOkay=jointsOkay&&jointOkay}if(contactsOkay&&jointsOkay){break}}this.Report(contactSolver.m_constraints);if(allowSleep){var minSleepTime=Number.MAX_VALUE,linTolSqr=b2Settings.b2_linearSleepTolerance*b2Settings.b2_linearSleepTolerance,angTolSqr=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance;for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.GetType()==b2Body.b2_staticBody){continue}if((b.m_flags&b2Body.e_allowSleepFlag)==0){b.m_sleepTime=0;minSleepTime=0}if((b.m_flags&b2Body.e_allowSleepFlag)==0||b.m_angularVelocity*b.m_angularVelocity>angTolSqr||b2Math.Dot(b.m_linearVelocity,b.m_linearVelocity)>linTolSqr){b.m_sleepTime=0;minSleepTime=0}else{b.m_sleepTime+=step.dt;minSleepTime=b2Math.Min(minSleepTime,b.m_sleepTime)}}if(minSleepTime>=b2Settings.b2_timeToSleep){for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];b.SetAwake(false)}}}};b2Island.prototype.SolveTOI=function(subStep){var i=0,j=0;this.m_contactSolver.Initialize(subStep,this.m_contacts,this.m_contactCount,this.m_allocator);var contactSolver=this.m_contactSolver;for(i=0;i<this.m_jointCount;++i){this.m_joints[i].InitVelocityConstraints(subStep)}for(i=0;i<subStep.velocityIterations;++i){contactSolver.SolveVelocityConstraints();for(j=0;j<this.m_jointCount;++j){this.m_joints[j].SolveVelocityConstraints(subStep)}}for(i=0;i<this.m_bodyCount;++i){var b=this.m_bodies[i];if(b.GetType()==b2Body.b2_staticBody)continue;var translationX=subStep.dt*b.m_linearVelocity.x,translationY=subStep.dt*b.m_linearVelocity.y;if(translationX*translationX+translationY*translationY>b2Settings.b2_maxTranslationSquared){b.m_linearVelocity.Normalize();b.m_linearVelocity.x*=b2Settings.b2_maxTranslation*subStep.inv_dt;b.m_linearVelocity.y*=b2Settings.b2_maxTranslation*subStep.inv_dt}var rotation=subStep.dt*b.m_angularVelocity;if(rotation*rotation>b2Settings.b2_maxRotationSquared){if(b.m_angularVelocity<0){b.m_angularVelocity=-b2Settings.b2_maxRotation*subStep.inv_dt}else{b.m_angularVelocity=b2Settings.b2_maxRotation*subStep.inv_dt}}b.m_sweep.c0.SetV(b.m_sweep.c);b.m_sweep.a0=b.m_sweep.a;b.m_sweep.c.x+=subStep.dt*b.m_linearVelocity.x;b.m_sweep.c.y+=subStep.dt*b.m_linearVelocity.y;b.m_sweep.a+=subStep.dt*b.m_angularVelocity;b.SynchronizeTransform()}var k_toiBaumgarte=.75;for(i=0;i<subStep.positionIterations;++i){var contactsOkay=contactSolver.SolvePositionConstraints(k_toiBaumgarte),jointsOkay=true;for(j=0;j<this.m_jointCount;++j){var jointOkay=this.m_joints[j].SolvePositionConstraints(b2Settings.b2_contactBaumgarte);jointsOkay=jointsOkay&&jointOkay}if(contactsOkay&&jointsOkay){break}}this.Report(contactSolver.m_constraints)};b2Island.prototype.Report=function(constraints){if(this.m_listener==null){return}for(var i=0;i<this.m_contactCount;++i){var c=this.m_contacts[i],cc=constraints[i];for(var j=0;j<cc.pointCount;++j){b2Island.s_impulse.normalImpulses[j]=cc.points[j].normalImpulse;b2Island.s_impulse.tangentImpulses[j]=cc.points[j].tangentImpulse}this.m_listener.PostSolve(c,b2Island.s_impulse)}};b2Island.prototype.AddBody=function(body){body.m_islandIndex=this.m_bodyCount;this.m_bodies[this.m_bodyCount++]=body};b2Island.prototype.AddContact=function(contact){this.m_contacts[this.m_contactCount++]=contact};b2Island.prototype.AddJoint=function(joint){this.m_joints[this.m_jointCount++]=joint};b2World=Box2D.Dynamics.b2World=function b2World(gravity,doSleep){this.s_stack=new Vector;this.m_contactManager=new b2ContactManager;this.m_contactSolver=new b2ContactSolver;this.m_island=new b2Island;this.m_destructionListener=null;this.m_debugDraw=null;this.m_bodyList=null;this.m_contactList=null;this.m_jointList=null;this.m_controllerList=null;this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0;this.m_controllerCount=0;b2World.m_warmStarting=true;b2World.m_continuousPhysics=true;this.m_allowSleep=doSleep;this.m_gravity=gravity;this.m_inv_dt0=0;this.m_contactManager.m_world=this;var bd=new b2BodyDef;this.m_groundBody=this.CreateBody(bd)};b2World.constructor=b2World;b2World.s_timestep2=new b2TimeStep;b2World.s_xf=new b2Transform;b2World.s_backupA=new b2Sweep;b2World.s_backupB=new b2Sweep;b2World.s_timestep=new b2TimeStep;b2World.s_queue=new Vector;b2World.s_jointColor=new b2Color(.5,.8,.8);b2World.e_newFixture=1;b2World.e_locked=2;b2World.prototype.SetDestructionListener=function(listener){this.m_destructionListener=listener};b2World.prototype.SetContactFilter=function(filter){this.m_contactManager.m_contactFilter=filter};b2World.prototype.SetContactListener=function(listener){this.m_contactManager.m_contactListener=listener};b2World.prototype.SetDebugDraw=function(debugDraw){this.m_debugDraw=debugDraw};b2World.prototype.SetBroadPhase=function(broadPhase){var oldBroadPhase=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=broadPhase;for(var b=this.m_bodyList;b;b=b.m_next){for(var f=b.m_fixtureList;f;f=f.m_next){f.m_proxy=broadPhase.CreateProxy(oldBroadPhase.GetFatAABB(f.m_proxy),f)}}};b2World.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()};b2World.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()};b2World.prototype.CreateBody=function(def){if(this.IsLocked()==true){return null}var b=new b2Body(def,this);b.m_prev=null;b.m_next=this.m_bodyList;if(this.m_bodyList){this.m_bodyList.m_prev=b}this.m_bodyList=b;++this.m_bodyCount;return b};b2World.prototype.DestroyBody=function(b){if(this.IsLocked()==true){return}var jn=b.m_jointList;while(jn){var jn0=jn;jn=jn.next;if(this.m_destructionListener){this.m_destructionListener.SayGoodbyeJoint(jn0.joint)}this.DestroyJoint(jn0.joint)}var coe=b.m_controllerList;while(coe){var coe0=coe;coe=coe.nextController;coe0.controller.RemoveBody(b)}var ce=b.m_contactList;while(ce){var ce0=ce;ce=ce.next;this.m_contactManager.Destroy(ce0.contact)}b.m_contactList=null;var f=b.m_fixtureList;while(f){var f0=f;f=f.m_next;if(this.m_destructionListener){this.m_destructionListener.SayGoodbyeFixture(f0)}f0.DestroyProxy(this.m_contactManager.m_broadPhase);f0.Destroy()}b.m_fixtureList=null;b.m_fixtureCount=0;if(b.m_prev){b.m_prev.m_next=b.m_next}if(b.m_next){b.m_next.m_prev=b.m_prev}if(b==this.m_bodyList){this.m_bodyList=b.m_next}--this.m_bodyCount};b2World.prototype.CreateJoint=function(def){var j=b2Joint.Create(def,null);j.m_prev=null;j.m_next=this.m_jointList;if(this.m_jointList){this.m_jointList.m_prev=j}this.m_jointList=j;++this.m_jointCount;j.m_edgeA.joint=j;j.m_edgeA.other=j.m_bodyB;j.m_edgeA.prev=null;j.m_edgeA.next=j.m_bodyA.m_jointList;if(j.m_bodyA.m_jointList)j.m_bodyA.m_jointList.prev=j.m_edgeA;j.m_bodyA.m_jointList=j.m_edgeA;j.m_edgeB.joint=j;j.m_edgeB.other=j.m_bodyA;j.m_edgeB.prev=null;j.m_edgeB.next=j.m_bodyB.m_jointList;if(j.m_bodyB.m_jointList)j.m_bodyB.m_jointList.prev=j.m_edgeB;j.m_bodyB.m_jointList=j.m_edgeB;var bodyA=def.bodyA,bodyB=def.bodyB;if(def.collideConnected==false){var edge=bodyB.GetContactList();while(edge){if(edge.other==bodyA){edge.contact.FlagForFiltering()}edge=edge.next}}return j};b2World.prototype.DestroyJoint=function(j){var collideConnected=j.m_collideConnected;if(j.m_prev){j.m_prev.m_next=j.m_next}if(j.m_next){j.m_next.m_prev=j.m_prev}if(j==this.m_jointList){this.m_jointList=j.m_next}var bodyA=j.m_bodyA,bodyB=j.m_bodyB;bodyA.SetAwake(true);bodyB.SetAwake(true);if(j.m_edgeA.prev){j.m_edgeA.prev.next=j.m_edgeA.next}if(j.m_edgeA.next){j.m_edgeA.next.prev=j.m_edgeA.prev}if(j.m_edgeA==bodyA.m_jointList){bodyA.m_jointList=j.m_edgeA.next}j.m_edgeA.prev=null;j.m_edgeA.next=null;if(j.m_edgeB.prev){j.m_edgeB.prev.next=j.m_edgeB.next}if(j.m_edgeB.next){j.m_edgeB.next.prev=j.m_edgeB.prev}if(j.m_edgeB==bodyB.m_jointList){bodyB.m_jointList=j.m_edgeB.next}j.m_edgeB.prev=null;j.m_edgeB.next=null;b2Joint.Destroy(j,null);--this.m_jointCount;if(collideConnected==false){var edge=bodyB.GetContactList();while(edge){if(edge.other==bodyA){edge.contact.FlagForFiltering()}edge=edge.next}}};b2World.prototype.AddController=function(c){c.m_next=this.m_controllerList;c.m_prev=null;this.m_controllerList=c;c.m_world=this;this.m_controllerCount++;return c};b2World.prototype.RemoveController=function(c){if(c.m_prev)c.m_prev.m_next=c.m_next;if(c.m_next)c.m_next.m_prev=c.m_prev;if(this.m_controllerList==c)this.m_controllerList=c.m_next;this.m_controllerCount--};b2World.prototype.CreateController=function(controller){if(controller.m_world!=this)throw new Error("Controller can only be a member of one world");controller.m_next=this.m_controllerList;controller.m_prev=null;if(this.m_controllerList)this.m_controllerList.m_prev=controller;this.m_controllerList=controller;++this.m_controllerCount;controller.m_world=this;return controller};b2World.prototype.DestroyController=function(controller){controller.Clear();if(controller.m_next)controller.m_next.m_prev=controller.m_prev;if(controller.m_prev)controller.m_prev.m_next=controller.m_next;if(controller==this.m_controllerList)this.m_controllerList=controller.m_next;--this.m_controllerCount};b2World.prototype.SetWarmStarting=function(flag){b2World.m_warmStarting=flag};b2World.prototype.SetContinuousPhysics=function(flag){b2World.m_continuousPhysics=flag};b2World.prototype.GetBodyCount=function(){return this.m_bodyCount};b2World.prototype.GetJointCount=function(){return this.m_jointCount};b2World.prototype.GetContactCount=function(){return this.m_contactCount};b2World.prototype.SetGravity=function(gravity){this.m_gravity=gravity};b2World.prototype.GetGravity=function(){return this.m_gravity};b2World.prototype.GetGroundBody=function(){return this.m_groundBody};b2World.prototype.Step=function(dt,velocityIterations,positionIterations){dt=dt||0;velocityIterations=velocityIterations||0;positionIterations=positionIterations||0;if(this.m_flags&b2World.e_newFixture){this.m_contactManager.FindNewContacts();this.m_flags&=~b2World.e_newFixture}this.m_flags|=b2World.e_locked;var step=b2World.s_timestep2;step.dt=dt;step.velocityIterations=velocityIterations;step.positionIterations=positionIterations;if(dt>0){step.inv_dt=1/dt}else{step.inv_dt=0}step.dtRatio=this.m_inv_dt0*dt;step.warmStarting=b2World.m_warmStarting;this.m_contactManager.Collide();if(step.dt>0){this.Solve(step)}if(b2World.m_continuousPhysics&&step.dt>0){this.SolveTOI(step)}if(step.dt>0){this.m_inv_dt0=step.inv_dt}this.m_flags&=~b2World.e_locked};b2World.prototype.ClearForces=function(){for(var body=this.m_bodyList;body;body=body.m_next){body.m_force.SetZero();body.m_torque=0}};b2World.prototype.DrawDebugData=function(){if(this.m_debugDraw==null){return}this.m_debugDraw.m_sprite.graphics.clear();var flags=this.m_debugDraw.GetFlags(),i=0,b,f,s,j,bp,invQ=new b2Vec2,x1=new b2Vec2,x2=new b2Vec2,xf,b1=new b2AABB,b2=new b2AABB,vs=[new b2Vec2,new b2Vec2,new b2Vec2,new b2Vec2],color=new b2Color(0,0,0);if(flags&b2DebugDraw.e_shapeBit){for(b=this.m_bodyList;b;b=b.m_next){xf=b.m_xf;for(f=b.GetFixtureList();f;f=f.m_next){s=f.GetShape();if(b.IsActive()==false){color.Set(.5,.5,.3);this.DrawShape(s,xf,color)}else if(b.GetType()==b2Body.b2_staticBody){color.Set(.5,.9,.5);this.DrawShape(s,xf,color)}else if(b.GetType()==b2Body.b2_kinematicBody){color.Set(.5,.5,.9);this.DrawShape(s,xf,color)}else if(b.IsAwake()==false){color.Set(.6,.6,.6);this.DrawShape(s,xf,color)}else{color.Set(.9,.7,.7);this.DrawShape(s,xf,color)}}}}if(flags&b2DebugDraw.e_jointBit){for(j=this.m_jointList;j;j=j.m_next){this.DrawJoint(j)}}if(flags&b2DebugDraw.e_controllerBit){for(var c=this.m_controllerList;c;c=c.m_next){c.Draw(this.m_debugDraw)}}if(flags&b2DebugDraw.e_pairBit){color.Set(.3,.9,.9);for(var contact=this.m_contactManager.m_contactList;contact;contact=contact.GetNext()){var fixtureA=contact.GetFixtureA(),fixtureB=contact.GetFixtureB(),cA=fixtureA.GetAABB().GetCenter(),cB=fixtureB.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(cA,cB,color)}}if(flags&b2DebugDraw.e_aabbBit){bp=this.m_contactManager.m_broadPhase;vs=[new b2Vec2,new b2Vec2,new b2Vec2,new b2Vec2];for(b=this.m_bodyList;b;b=b.GetNext()){if(b.IsActive()==false){continue}for(f=b.GetFixtureList();f;f=f.GetNext()){var aabb=bp.GetFatAABB(f.m_proxy);vs[0].Set(aabb.lowerBound.x,aabb.lowerBound.y);vs[1].Set(aabb.upperBound.x,aabb.lowerBound.y);vs[2].Set(aabb.upperBound.x,aabb.upperBound.y);vs[3].Set(aabb.lowerBound.x,aabb.upperBound.y);this.m_debugDraw.DrawPolygon(vs,4,color)}}}if(flags&b2DebugDraw.e_centerOfMassBit){for(b=this.m_bodyList;b;b=b.m_next){xf=b2World.s_xf;xf.R=b.m_xf.R;xf.position=b.GetWorldCenter();this.m_debugDraw.DrawTransform(xf)}}};b2World.prototype.QueryAABB=function(callback,aabb){var __this=this,broadPhase=__this.m_contactManager.m_broadPhase;function WorldQueryWrapper(proxy){return callback(broadPhase.GetUserData(proxy))}broadPhase.Query(WorldQueryWrapper,aabb)};b2World.prototype.QueryShape=function(callback,shape,transform){var __this=this;transform=transform||null;if(transform==null){transform=new b2Transform;transform.SetIdentity()}var broadPhase=__this.m_contactManager.m_broadPhase;function WorldQueryWrapper(proxy){var fixture=broadPhase.GetUserData(proxy)instanceof b2Fixture?broadPhase.GetUserData(proxy):null;if(b2Shape.TestOverlap(shape,transform,fixture.GetShape(),fixture.GetBody().GetTransform()))return callback(fixture);return true}var aabb=new b2AABB;shape.ComputeAABB(aabb,transform);broadPhase.Query(WorldQueryWrapper,aabb)};b2World.prototype.QueryPoint=function(callback,p){var __this=this,broadPhase=__this.m_contactManager.m_broadPhase;function WorldQueryWrapper(proxy){var fixture=broadPhase.GetUserData(proxy)instanceof b2Fixture?broadPhase.GetUserData(proxy):null;if(fixture.TestPoint(p))return callback(fixture);return true}var aabb=new b2AABB;aabb.lowerBound.Set(p.x-b2Settings.b2_linearSlop,p.y-b2Settings.b2_linearSlop);aabb.upperBound.Set(p.x+b2Settings.b2_linearSlop,p.y+b2Settings.b2_linearSlop);broadPhase.Query(WorldQueryWrapper,aabb)};b2World.prototype.RayCast=function(callback,point1,point2){var __this=this,broadPhase=__this.m_contactManager.m_broadPhase,output=new b2RayCastOutput;function RayCastWrapper(input,proxy){var userData=broadPhase.GetUserData(proxy),fixture=userData instanceof b2Fixture?userData:null,hit=fixture.RayCast(output,input);if(hit){var fraction=output.fraction,point=new b2Vec2((1-fraction)*point1.x+fraction*point2.x,(1-fraction)*point1.y+fraction*point2.y);return callback(fixture,point,output.normal,fraction)}return input.maxFraction}var input=new b2RayCastInput(point1,point2);broadPhase.RayCast(RayCastWrapper,input)};b2World.prototype.RayCastOne=function(point1,point2){var __this=this,result;function RayCastOneWrapper(fixture,point,normal,fraction){fraction=fraction||0;result=fixture;return fraction}__this.RayCast(RayCastOneWrapper,point1,point2);return result};b2World.prototype.RayCastAll=function(point1,point2){var __this=this,result=new Vector;function RayCastAllWrapper(fixture,point,normal,fraction){fraction=fraction||0;result[result.length]=fixture;return 1}__this.RayCast(RayCastAllWrapper,point1,point2);return result};b2World.prototype.GetBodyList=function(){return this.m_bodyList};b2World.prototype.GetJointList=function(){return this.m_jointList};b2World.prototype.GetContactList=function(){return this.m_contactList};b2World.prototype.IsLocked=function(){return(this.m_flags&b2World.e_locked)>0
};b2World.prototype.Solve=function(step){var b;for(var controller=this.m_controllerList;controller;controller=controller.m_next){controller.Step(step)}var island=this.m_island;island.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver);for(b=this.m_bodyList;b;b=b.m_next){b.m_flags&=~b2Body.e_islandFlag}for(var c=this.m_contactList;c;c=c.m_next){c.m_flags&=~b2Contact.e_islandFlag}for(var j=this.m_jointList;j;j=j.m_next){j.m_islandFlag=false}var stackSize=parseInt(this.m_bodyCount),stack=this.s_stack;for(var seed=this.m_bodyList;seed;seed=seed.m_next){if(seed.m_flags&b2Body.e_islandFlag){continue}if(seed.IsAwake()==false||seed.IsActive()==false){continue}if(seed.GetType()==b2Body.b2_staticBody){continue}island.Clear();var stackCount=0;stack[stackCount++]=seed;seed.m_flags|=b2Body.e_islandFlag;while(stackCount>0){b=stack[--stackCount];island.AddBody(b);if(b.IsAwake()==false){b.SetAwake(true)}if(b.GetType()==b2Body.b2_staticBody){continue}var other;for(var ce=b.m_contactList;ce;ce=ce.next){if(ce.contact.m_flags&b2Contact.e_islandFlag){continue}if(ce.contact.IsSensor()==true||ce.contact.IsEnabled()==false||ce.contact.IsTouching()==false){continue}island.AddContact(ce.contact);ce.contact.m_flags|=b2Contact.e_islandFlag;other=ce.other;if(other.m_flags&b2Body.e_islandFlag){continue}stack[stackCount++]=other;other.m_flags|=b2Body.e_islandFlag}for(var jn=b.m_jointList;jn;jn=jn.next){if(jn.joint.m_islandFlag==true){continue}other=jn.other;if(other.IsActive()==false){continue}island.AddJoint(jn.joint);jn.joint.m_islandFlag=true;if(other.m_flags&b2Body.e_islandFlag){continue}stack[stackCount++]=other;other.m_flags|=b2Body.e_islandFlag}}island.Solve(step,this.m_gravity,this.m_allowSleep);for(var i=0;i<island.m_bodyCount;++i){b=island.m_bodies[i];if(b.GetType()==b2Body.b2_staticBody){b.m_flags&=~b2Body.e_islandFlag}}}for(i=0;i<stack.length;++i){if(!stack[i])break;stack[i]=null}for(b=this.m_bodyList;b;b=b.m_next){if(b.IsAwake()==false||b.IsActive()==false){continue}if(b.GetType()==b2Body.b2_staticBody){continue}b.SynchronizeFixtures()}this.m_contactManager.FindNewContacts()};b2World.prototype.SolveTOI=function(step){var b,fA,fB,bA,bB,cEdge,j,island=this.m_island;island.Initialize(this.m_bodyCount,b2Settings.b2_maxTOIContactsPerIsland,b2Settings.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var queue=b2World.s_queue;for(b=this.m_bodyList;b;b=b.m_next){b.m_flags&=~b2Body.e_islandFlag;b.m_sweep.t0=0}var c;for(c=this.m_contactList;c;c=c.m_next){c.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag)}for(j=this.m_jointList;j;j=j.m_next){j.m_islandFlag=false}for(;;){var minContact=null,minTOI=1;for(c=this.m_contactList;c;c=c.m_next){if(c.IsSensor()==true||c.IsEnabled()==false||c.IsContinuous()==false){continue}var toi=1;if(c.m_flags&b2Contact.e_toiFlag){toi=c.m_toi}else{fA=c.m_fixtureA;fB=c.m_fixtureB;bA=fA.m_body;bB=fB.m_body;if((bA.GetType()!=b2Body.b2_dynamicBody||bA.IsAwake()==false)&&(bB.GetType()!=b2Body.b2_dynamicBody||bB.IsAwake()==false)){continue}var t0=bA.m_sweep.t0;if(bA.m_sweep.t0<bB.m_sweep.t0){t0=bB.m_sweep.t0;bA.m_sweep.Advance(t0)}else if(bB.m_sweep.t0<bA.m_sweep.t0){t0=bA.m_sweep.t0;bB.m_sweep.Advance(t0)}toi=c.ComputeTOI(bA.m_sweep,bB.m_sweep);b2Settings.b2Assert(0<=toi&&toi<=1);if(toi>0&&toi<1){toi=(1-toi)*t0+toi;if(toi>1)toi=1}c.m_toi=toi;c.m_flags|=b2Contact.e_toiFlag}if(Number.MIN_VALUE<toi&&toi<minTOI){minContact=c;minTOI=toi}}if(minContact==null||1-100*Number.MIN_VALUE<minTOI){break}fA=minContact.m_fixtureA;fB=minContact.m_fixtureB;bA=fA.m_body;bB=fB.m_body;b2World.s_backupA.Set(bA.m_sweep);b2World.s_backupB.Set(bB.m_sweep);bA.Advance(minTOI);bB.Advance(minTOI);minContact.Update(this.m_contactManager.m_contactListener);minContact.m_flags&=~b2Contact.e_toiFlag;if(minContact.IsSensor()==true||minContact.IsEnabled()==false){bA.m_sweep.Set(b2World.s_backupA);bB.m_sweep.Set(b2World.s_backupB);bA.SynchronizeTransform();bB.SynchronizeTransform();continue}if(minContact.IsTouching()==false){continue}var seed=bA;if(seed.GetType()!=b2Body.b2_dynamicBody){seed=bB}island.Clear();var queueStart=0,queueSize=0;queue[queueStart+queueSize++]=seed;seed.m_flags|=b2Body.e_islandFlag;while(queueSize>0){b=queue[queueStart++];--queueSize;island.AddBody(b);if(b.IsAwake()==false){b.SetAwake(true)}if(b.GetType()!=b2Body.b2_dynamicBody){continue}for(cEdge=b.m_contactList;cEdge;cEdge=cEdge.next){if(island.m_contactCount==island.m_contactCapacity){break}if(cEdge.contact.m_flags&b2Contact.e_islandFlag){continue}if(cEdge.contact.IsSensor()==true||cEdge.contact.IsEnabled()==false||cEdge.contact.IsTouching()==false){continue}island.AddContact(cEdge.contact);cEdge.contact.m_flags|=b2Contact.e_islandFlag;var other=cEdge.other;if(other.m_flags&b2Body.e_islandFlag){continue}if(other.GetType()!=b2Body.b2_staticBody){other.Advance(minTOI);other.SetAwake(true)}queue[queueStart+queueSize]=other;++queueSize;other.m_flags|=b2Body.e_islandFlag}for(var jEdge=b.m_jointList;jEdge;jEdge=jEdge.next){if(island.m_jointCount==island.m_jointCapacity)continue;if(jEdge.joint.m_islandFlag==true)continue;other=jEdge.other;if(other.IsActive()==false){continue}island.AddJoint(jEdge.joint);jEdge.joint.m_islandFlag=true;if(other.m_flags&b2Body.e_islandFlag)continue;if(other.GetType()!=b2Body.b2_staticBody){other.Advance(minTOI);other.SetAwake(true)}queue[queueStart+queueSize]=other;++queueSize;other.m_flags|=b2Body.e_islandFlag}}var subStep=b2World.s_timestep;subStep.warmStarting=false;subStep.dt=(1-minTOI)*step.dt;subStep.inv_dt=1/subStep.dt;subStep.dtRatio=0;subStep.velocityIterations=step.velocityIterations;subStep.positionIterations=step.positionIterations;island.SolveTOI(subStep);var i=0;for(i=0;i<island.m_bodyCount;++i){b=island.m_bodies[i];b.m_flags&=~b2Body.e_islandFlag;if(b.IsAwake()==false){continue}if(b.GetType()!=b2Body.b2_dynamicBody){continue}b.SynchronizeFixtures();for(cEdge=b.m_contactList;cEdge;cEdge=cEdge.next){cEdge.contact.m_flags&=~b2Contact.e_toiFlag}}for(i=0;i<island.m_contactCount;++i){c=island.m_contacts[i];c.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag)}for(i=0;i<island.m_jointCount;++i){j=island.m_joints[i];j.m_islandFlag=false}this.m_contactManager.FindNewContacts()}};b2World.prototype.DrawJoint=function(joint){var b1=joint.GetBodyA(),b2=joint.GetBodyB(),xf1=b1.m_xf,xf2=b2.m_xf,x1=xf1.position,x2=xf2.position,p1=joint.GetAnchorA(),p2=joint.GetAnchorB(),color=b2World.s_jointColor;switch(joint.m_type){case b2Joint.e_distanceJoint:this.m_debugDraw.DrawSegment(p1,p2,color);break;case b2Joint.e_pulleyJoint:{var pulley=joint instanceof b2PulleyJoint?joint:null,s1=pulley.GetGroundAnchorA(),s2=pulley.GetGroundAnchorB();this.m_debugDraw.DrawSegment(s1,p1,color);this.m_debugDraw.DrawSegment(s2,p2,color);this.m_debugDraw.DrawSegment(s1,s2,color)}break;case b2Joint.e_mouseJoint:this.m_debugDraw.DrawSegment(p1,p2,color);break;default:if(b1!=this.m_groundBody)this.m_debugDraw.DrawSegment(x1,p1,color);this.m_debugDraw.DrawSegment(p1,p2,color);if(b2!=this.m_groundBody)this.m_debugDraw.DrawSegment(x2,p2,color)}};b2World.prototype.DrawShape=function(shape,xf,color){switch(shape.m_type){case b2Shape.e_circleShape:{var circle=shape instanceof b2CircleShape?shape:null,center=b2Math.MulX(xf,circle.m_p),radius=circle.m_radius,axis=xf.R.col1;this.m_debugDraw.DrawSolidCircle(center,radius,axis,color)}break;case b2Shape.e_polygonShape:{var i=0,poly=shape instanceof b2PolygonShape?shape:null,vertexCount=parseInt(poly.GetVertexCount()),localVertices=poly.GetVertices(),vertices=new Vector(vertexCount);for(i=0;i<vertexCount;++i){vertices[i]=b2Math.MulX(xf,localVertices[i])}this.m_debugDraw.DrawSolidPolygon(vertices,vertexCount,color)}break;case b2Shape.e_edgeShape:{var edge=shape instanceof b2EdgeShape?shape:null;this.m_debugDraw.DrawSegment(b2Math.MulX(xf,edge.GetVertex1()),b2Math.MulX(xf,edge.GetVertex2()),color)}break}};b2DestructionListener=Box2D.Dynamics.b2DestructionListener=function b2DestructionListener(){};b2DestructionListener.constructor=b2DestructionListener;b2DestructionListener.prototype.SayGoodbyeJoint=function(joint){};b2DestructionListener.prototype.SayGoodbyeFixture=function(fixture){};return Box2D}.call(this);(function(){"use strict";var ComponentInstanceProvider,ComponentMatchingFamily,ComponentPool,ComponentSingletonProvider,ComponentTypeProvider,Dictionary,DynamicComponentProvider,DynamicSystemProvider,Engine,EngineState,EngineStateMachine,Entity,EntityList,EntityState,EntityStateMachine,Family,FrameTickProvider,ListIteratingSystem,ListenerNode,ListenerNodePool,Node,NodeList,NodePool,Signal0,Signal1,Signal2,Signal3,SignalBase,StateComponentMapping,StateSystemMapping,System,SystemInstanceProvider,SystemList,SystemSingletonProvider,ash,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};ash={signals:{},core:{},fsm:{},tick:{},tools:{}};Dictionary=function(){function Dictionary(){}return Dictionary}();ash.signals.ListenerNode=ListenerNode=function(){function ListenerNode(){}ListenerNode.prototype.previous=null;ListenerNode.prototype.next=null;ListenerNode.prototype.listener=null;ListenerNode.prototype.once=false;return ListenerNode}();ash.signals.ListenerNodePool=ListenerNodePool=function(){function ListenerNodePool(){}ListenerNodePool.prototype.tail=null;ListenerNodePool.prototype.cacheTail=null;ListenerNodePool.prototype.get=function(){var node;if(this.tail!==null){node=this.tail;this.tail=this.tail.previous;node.previous=null;return node}else{return new ListenerNode}};ListenerNodePool.prototype.dispose=function(node){node.listener=null;node.once=false;node.next=null;node.previous=this.tail;this.tail=node};ListenerNodePool.prototype.cache=function(node){node.listener=null;node.previous=this.cacheTail;this.cacheTail=node};ListenerNodePool.prototype.releaseCache=function(){var node;while(this.cacheTail!==null){node=this.cacheTail;this.cacheTail=node.previous;node.next=null;node.previous=this.tail;this.tail=node}};return ListenerNodePool}();ash.signals.SignalBase=SignalBase=function(){SignalBase.prototype.head=null;SignalBase.prototype.tail=null;SignalBase.prototype.numListeners=0;SignalBase.prototype.keys=null;SignalBase.prototype.nodes=null;SignalBase.prototype.listenerNodePool=null;SignalBase.prototype.toAddHead=null;SignalBase.prototype.toAddTail=null;SignalBase.prototype.dispatching=false;function SignalBase(){this.nodes=[];this.keys=[];this.listenerNodePool=new ListenerNodePool;this.numListeners=0}SignalBase.prototype.startDispatch=function(){this.dispatching=true};SignalBase.prototype.endDispatch=function(){this.dispatching=false;if(this.toAddHead){if(!this.head){this.head=this.toAddHead;this.tail=this.toAddTail}else{this.tail.next=this.toAddHead;this.toAddHead.previous=this.tail;this.tail=this.toAddTail}this.toAddHead=null;this.toAddTail=null}this.listenerNodePool.releaseCache()};SignalBase.prototype.getNode=function(listener){var node;node=this.head;while(node!==null){if(node.listener===listener){break}node=node.next}if(node===null){node=this.toAddHead;while(node!==null){if(node.listener===listener){break}node=node.next}}return node};SignalBase.prototype.add=function(listener){var node;if(this.keys.indexOf(listener)!==-1){return}node=this.listenerNodePool.get();node.listener=listener;this.nodes.push(node);this.keys.push(listener);this.addNode(node)};SignalBase.prototype.addOnce=function(listener){var node;if(this.keys.indexOf(listener)!==-1){return}node=this.listenerNodePool.get();node.listener=listener;node.once=true;this.nodes.push(node);this.keys.push(listener);this.addNode(node)};SignalBase.prototype.addNode=function(node){if(this.dispatching){if(this.toAddHead===null){this.toAddHead=this.toAddTail=node}else{this.toAddTail.next=node;node.previous=this.toAddTail;this.toAddTail=node}}else{if(this.head===null){this.head=this.tail=node}else{this.tail.next=node;node.previous=this.tail;this.tail=node}}this.numListeners++};SignalBase.prototype.remove=function(listener){var index,node;index=this.keys.indexOf(listener);node=this.nodes[index];if(node){if(this.head===node){this.head=this.head.next}if(this.tail===node){this.tail=this.tail.previous}if(this.toAddHead===node){this.toAddHead=this.toAddHead.next}if(this.toAddTail===node){this.toAddTail=this.toAddTail.previous}if(node.previous){node.previous.next=node.next}if(node.next){node.next.previous=node.previous}this.nodes.splice(index,1);this.keys.splice(index,1);if(this.dispatching){this.listenerNodePool.cache(node)}else{this.listenerNodePool.dispose(node)}this.numListeners--}};SignalBase.prototype.removeAll=function(){var node;while(this.head){node=this.head;this.head=this.head.next;this.nodes.splice(index,1);this.listenerNodePool.dispose(node)}this.nodes=[];this.keys=[];this.tail=null;this.toAddHead=null;this.toAddTail=null;this.numListeners=0};return SignalBase}();ash.signals.Signal0=Signal0=function(superClass){extend(Signal0,superClass);function Signal0(){return Signal0.__super__.constructor.apply(this,arguments)}Signal0.prototype.dispatch=function(){var node;this.startDispatch();node=this.head;while(node!==null){node.listener();if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal0}(SignalBase);ash.signals.Signal1=Signal1=function(superClass){extend(Signal1,superClass);function Signal1(){return Signal1.__super__.constructor.apply(this,arguments)}Signal1.prototype.dispatch=function($1){var node;this.startDispatch();node=this.head;while(node!==null){node.listener($1);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal1}(SignalBase);ash.signals.Signal2=Signal2=function(superClass){extend(Signal2,superClass);function Signal2(){return Signal2.__super__.constructor.apply(this,arguments)}Signal2.prototype.dispatch=function($1,$2){var node;this.startDispatch();node=this.head;while(node){node.listener($1,$2);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal2}(SignalBase);ash.signals.Signal3=Signal3=function(superClass){extend(Signal3,superClass);function Signal3(){return Signal3.__super__.constructor.apply(this,arguments)}Signal3.prototype.dispatch=function($1,$2,$3){var node;this.startDispatch();node=this.head;while(node!==null){node.listener($1,$2,$3);if(node.once){this.remove(node.listener)}node=node.next}return this.endDispatch()};return Signal3}(SignalBase);ash.core.Entity=Entity=function(){var nameCount;nameCount=0;Entity.prototype._name="";Entity.prototype.componentAdded=null;Entity.prototype.componentRemoved=null;Entity.prototype.nameChanged=null;Entity.prototype.previous=null;Entity.prototype.next=null;Entity.prototype.components=null;function Entity(name){if(name==null){name=""}Object.defineProperties(this,{name:{get:function(){return this._name},set:function(value){var previous;if(this._name!==value){previous=this._name;this._name=value;return this.nameChanged.dispatch(this,previous)}}}});this.componentAdded=new Signal2;this.componentRemoved=new Signal2;this.nameChanged=new Signal2;this.components=new Dictionary;if(name!==""){this._name=name}else{this._name="_entity"+ ++nameCount}}Entity.prototype.add=function(component,componentClass){if(componentClass==null){componentClass=component.constructor}if(componentClass.name in this.components){this.remove(componentClass)}this.components[componentClass.name]=component;this.componentAdded.dispatch(this,componentClass);return this};Entity.prototype.remove=function(componentClass){var component,name;name=componentClass.name!=null?componentClass.name:componentClass;component=this.components[name];if(component){delete this.components[name];this.componentRemoved.dispatch(this,name);return component}return null};Entity.prototype.get=function(componentClass){return this.components[componentClass.name]};Entity.prototype.getAll=function(){var component,componentArray,i,len,ref;componentArray=[];ref=this.components;for(i=0,len=ref.length;i<len;i++){component=ref[i];componentArray.push(component)}return componentArray};Entity.prototype.has=function(componentClass){return componentClass.name in this.components};return Entity}();ash.core.EntityList=EntityList=function(){function EntityList(){}EntityList.prototype.head=null;EntityList.prototype.tail=null;EntityList.prototype.add=function(entity){if(!this.head){this.head=this.tail=entity;entity.next=entity.previous=null}else{this.tail.next=entity;entity.previous=this.tail;entity.next=null;this.tail=entity}};EntityList.prototype.remove=function(entity){if(this.head===entity){this.head=this.head.next}if(this.tail===entity){this.tail=this.tail.previous}if(entity.previous){entity.previous.next=entity.next}if(entity.next){entity.next.previous=entity.previous}};EntityList.prototype.removeAll=function(){var entity;while(this.head){entity=this.head;this.head=this.head.next;entity.previous=null;entity.next=null}this.tail=null};return EntityList}();ash.core.Node=Node=function(){function Node(){}Node.prototype.entity=null;Node.prototype.previous=null;Node.prototype.next=null;return Node}();ash.core.NodeList=NodeList=function(){NodeList.prototype.head=null;NodeList.prototype.tail=null;NodeList.prototype.nodeAdded=null;NodeList.prototype.nodeRemoved=null;function NodeList(){this.nodeAdded=new Signal1;this.nodeRemoved=new Signal1}NodeList.prototype.add=function(node){if(!this.head){this.head=this.tail=node;node.next=node.previous=null}else{this.tail.next=node;node.previous=this.tail;node.next=null;this.tail=node}this.nodeAdded.dispatch(node)};NodeList.prototype.remove=function(node){if(this.head===node){this.head=this.head.next}if(this.tail===node){this.tail=this.tail.previous}if(node.previous){node.previous.next=node.next}if(node.next){node.next.previous=node.previous}this.nodeRemoved.dispatch(node)};NodeList.prototype.removeAll=function(){var node;while(this.head){node=this.head;this.head=this.head.next;node.previous=null;node.next=null;this.nodeRemoved.dispatch(node)}this.tail=null};Object.defineProperties(NodeList.prototype,{empty:{get:function(){return this.head===null}}});NodeList.prototype.swap=function(node1,node2){var temp;if(node1.previous===node2){node1.previous=node2.previous;node2.previous=node1;node2.next=node1.next;node1.next=node2}else if(node2.previous===node1){node2.previous=node1.previous;node1.previous=node2;node1.next=node2.next;node2.next=node1}else{temp=node1.previous;node1.previous=node2.previous;node2.previous=temp;temp=node1.next;node1.next=node2.next;node2.next=temp}if(this.head===node1){this.head=node2}else if(this.head===node2){this.head=node1}if(this.tail===node1){this.tail=node2}else if(this.tail===node2){this.tail=node1}if(node1.previous!==null){node1.previous.next=node1}if(node2.previous!==null){node2.previous.next=node2}if(node1.next!==null){node1.next.previous=node1}if(node2.next!==null){node2.next.previous=node2}};NodeList.prototype.insertionSort=function(sortFunction){var node,other,remains;if(this.head===this.tail){return}remains=this.head.next;node=remains;while(node!==null){remains=node.next;other=node.previous;while(other!==null){if(sortFunction(node,other)>=0){if(node!==other.next){if(this.tail===node){this.tail=node.previous}node.previous.next=node.next;if(node.next!==null){node.next.previous=node.previous}node.next=other.next;node.previous=other;node.next.previous=node;other.next=node}break}other=other.previous}if(other===null){if(this.tail===node){this.tail=node.previous}node.previous.next=node.next;if(node.next!==null){node.next.previous=node.previous}node.next=this.head;this.head.previous=node;node.previous=null;this.head=node}node=remains}};NodeList.prototype.mergeSort=function(sortFunction){var end,lists,next,start;if(this.head===this.tail){return}lists=[];start=this.head;while(start!==null){end=start;while(end.next!==null&&sortFunction(end,end.next)<=0){end=end.next}next=end.next;start.previous=end.next=null;lists.push(start);start=next}while(lists.length>1){lists.push(this.merge(lists.shift(),lists.shift(),sortFunction))}this.tail=this.head=lists[0];while(this.tail.next!==null){this.tail=this.tail.next}};NodeList.prototype.merge=function(head1,head2,sortFunction){var head,node;if(sortFunction(head1,head2)<=0){head=node=head1;head1=head1.next}else{head=node=head2;head2=head2.next}while(head1!==null&&head2!==null){if(sortFunction(head1,head2)<=0){node.next=head1;head1.previous=node;node=head1;head1=head1.next}else{node.next=head2;head2.previous=node;node=head2;head2=head2.next}}if(head1!==null){node.next=head1;head1.previous=node}else{node.next=head2;head2.previous=node}return head};return NodeList}();ash.core.NodePool=NodePool=function(){NodePool.prototype.tail=null;NodePool.prototype.nodeClass=null;NodePool.prototype.cacheTail=null;NodePool.prototype.components=null;function NodePool(nodeClass1,components){this.nodeClass=nodeClass1;this.components=components}NodePool.prototype.get=function(){var node;if(this.tail){node=this.tail;this.tail=this.tail.previous;node.previous=null;return node}else{return new this.nodeClass}};NodePool.prototype.dispose=function(node){var componentName;for(componentName in this.components){node[componentName]=null}node.entity=null;node.next=null;node.previous=this.tail;this.tail=node};NodePool.prototype.cache=function(node){node.previous=this.cacheTail;this.cacheTail=node};NodePool.prototype.releaseCache=function(){var node;while(this.cacheTail){node=this.cacheTail;this.cacheTail=node.previous;this.dispose(node)}};return NodePool}();ash.core.System=System=function(){function System(){this.update=bind(this.update,this)}System.prototype.previous=null;System.prototype.next=null;System.prototype.priority=0;System.prototype.addToEngine=function(engine){};System.prototype.removeFromEngine=function(engine){};System.prototype.update=function(time){};return System}();ash.core.SystemList=SystemList=function(){function SystemList(){}SystemList.prototype.head=null;SystemList.prototype.tail=null;SystemList.prototype.add=function(system){var node;if(!this.head){this.head=this.tail=system;system.next=system.previous=null}else{node=this.tail;while(node){if(node.priority<=system.priority){break}node=node.previous}if(node===this.tail){this.tail.next=system;system.previous=this.tail;system.next=null;this.tail=system}else if(!node){system.next=this.head;system.previous=null;this.head.previous=system;this.head=system}else{system.next=node.next;system.previous=node;node.next.previous=system;node.next=system}}};SystemList.prototype.remove=function(system){if(this.head===system){this.head=this.head.next}if(this.tail===system){this.tail=this.tail.previous}if(system.previous){system.previous.next=system.next}if(system.next){system.next.previous=system.previous}};SystemList.prototype.removeAll=function(){var system;while(this.head){system=this.head;this.head=this.head.next;system.previous=null;system.next=null}this.tail=null};SystemList.prototype.get=function(type){var system;system=this.head;while(system){if(system.constructor===type){return system}system=system.next}return null};return SystemList}();ash.core.Family=Family=function(){Family.prototype.nodes=null;function Family(){Object.defineProperties(this,{nodeList:{get:function(){return this.nodes}}})}Family.prototype.newEntity=function(entity){throw new Error("Method must be overriden")};Family.prototype.removeEntity=function(entity){throw new Error("Method must be overriden")};Family.prototype.componentAddedToEntity=function(entity,componentClass){throw new Error("Method must be overriden")};Family.prototype.componentRemovedFromEntity=function(entity,componentClass){throw new Error("Method must be overriden")};Family.prototype.cleanUp=function(){throw new Error("Method must be overriden")};return Family}();ash.core.ComponentMatchingFamily=ComponentMatchingFamily=function(){ComponentMatchingFamily.prototype.nodes=null;ComponentMatchingFamily.prototype.entities=null;ComponentMatchingFamily.prototype.nodeClass=null;ComponentMatchingFamily.prototype.components=null;ComponentMatchingFamily.prototype.nodePool=null;ComponentMatchingFamily.prototype.engine=null;function ComponentMatchingFamily(nodeClass1,engine1){this.nodeClass=nodeClass1;this.engine=engine1;this.releaseNodePoolCache=bind(this.releaseNodePoolCache,this);this.init()}ComponentMatchingFamily.prototype.init=function(){var name,ref,type;this.nodes=new NodeList;this.entities=new Dictionary;this.components=new Dictionary;this.nodePool=new NodePool(this.nodeClass,this.nodeClass.components);ref=this.nodeClass.components;for(name in ref){type=ref[name];this.components[type.name]=type}};Object.defineProperties(ComponentMatchingFamily.prototype,{nodeList:{get:function(){return this.nodes}}});ComponentMatchingFamily.prototype.newEntity=function(entity){this.addIfMatch(entity)};ComponentMatchingFamily.prototype.componentAddedToEntity=function(entity,componentClass){this.addIfMatch(entity)};ComponentMatchingFamily.prototype.componentRemovedFromEntity=function(entity,componentClass){var name;name=componentClass.name!=null?componentClass.name:componentClass;if(name in this.components){this.removeIfMatch(entity)}};ComponentMatchingFamily.prototype.removeEntity=function(entity){this.removeIfMatch(entity)};ComponentMatchingFamily.prototype.addIfMatch=function(entity){var componentClass,name,node,ref,ref1;if(this.entities[entity.name]==null){ref=this.nodeClass.components;for(name in ref){componentClass=ref[name];if(!entity.has(componentClass)){return}}node=this.nodePool.get();node.entity=entity;ref1=this.nodeClass.components;for(name in ref1){componentClass=ref1[name];node[name]=entity.get(componentClass)}this.entities[entity.name]=node;this.nodes.add(node)}};ComponentMatchingFamily.prototype.removeIfMatch=function(entity){var node;if(entity.name in this.entities){node=this.entities[entity.name];delete this.entities[entity.name];this.nodes.remove(node);if(this.engine.updating){this.nodePool.cache(node);this.engine.updateComplete.add(this.releaseNodePoolCache)}else{this.nodePool.dispose(node)}}};ComponentMatchingFamily.prototype.releaseNodePoolCache=function(){this.engine.updateComplete.remove(this.releaseNodePoolCache);this.nodePool.releaseCache()};ComponentMatchingFamily.prototype.cleanUp=function(){var node;node=this.nodes.head;while(node){this.entities.remove(node.entity);node=node.next}this.nodes.removeAll()};return ComponentMatchingFamily}();ash.core.Engine=Engine=function(){Engine.prototype.entityNames=null;Engine.prototype.entityList=null;Engine.prototype.systemList=null;Engine.prototype.families=null;Engine.prototype.updating=false;Engine.prototype.updateComplete=null;Engine.prototype.familyClass=ComponentMatchingFamily;function Engine(){this.update=bind(this.update,this);this.componentRemoved=bind(this.componentRemoved,this);this.componentAdded=bind(this.componentAdded,this);this.entityNameChanged=bind(this.entityNameChanged,this);this.entityList=new EntityList;this.entityNames=new Dictionary;this.systemList=new SystemList;this.families=new Dictionary;this.updateComplete=new Signal0}Object.defineProperties(Engine.prototype,{entities:{get:function(){var entities,entity;entities=[];entity=this.entityList.head;while(entity){this.entities.push(entity);entity=entity.next}return entities}},systems:{get:function(){var system,systems;systems=[];system=this.systemList.head;while(system){systems.push(system);system=system.next}return systems}}});Engine.prototype.addEntity=function(entity){var each,family,ref;if(this.entityNames[entity.name]){throw"The entity name "+entity.name+" is already in use by another entity."}this.entityList.add(entity);this.entityNames[entity.name]=entity;entity.componentAdded.add(this.componentAdded);entity.componentRemoved.add(this.componentRemoved);entity.nameChanged.add(this.entityNameChanged);ref=this.families;for(each in ref){family=ref[each];family.newEntity(entity)}};Engine.prototype.removeEntity=function(entity){var each,family,ref;entity.componentAdded.remove(this.componentAdded);entity.componentRemoved.remove(this.componentRemoved);entity.nameChanged.remove(this.entityNameChanged);ref=this.families;for(each in ref){family=ref[each];family.removeEntity(entity)}delete this.entityNames[entity.name];this.entityList.remove(entity)};Engine.prototype.entityNameChanged=function(entity,oldName){if(this.entityNames[oldName]===entity){delete this.entityNames[oldName];this.entityNames[entity.name]=entity}};Engine.prototype.getEntityByName=function(name){return this.entityNames[name]};Engine.prototype.removeAllEntities=function(){while(this.entityList.head!==null){this.removeEntity(this.entityList.head)}};Engine.prototype.componentAdded=function(entity,componentClass){var each,family,ref;ref=this.families;for(each in ref){family=ref[each];family.componentAddedToEntity(entity,componentClass)}};Engine.prototype.componentRemoved=function(entity,componentClass){var each,family,ref;ref=this.families;for(each in ref){family=ref[each];family.componentRemovedFromEntity(entity,componentClass)}};Engine.prototype.getNodeList=function(nodeClass){var entity,family;if(nodeClass.name in this.families){return this.families[nodeClass.name].nodeList}family=new this.familyClass(nodeClass,this);this.families[nodeClass.name]=family;entity=this.entityList.head;while(entity){family.newEntity(entity);entity=entity.next}return family.nodeList};Engine.prototype.releaseNodeList=function(nodeClass){if(nodeClass.name in this.families){this.families[nodeClass.name].cleanUp();delete this.families[nodeClass.name]}};Engine.prototype.addSystem=function(system,priority){system.priority=priority;system.addToEngine(this);this.systemList.add(system)};Engine.prototype.getSystem=function(type){return systemList.get(type)};Engine.prototype.removeSystem=function(system){this.systemList.remove(system);system.removeFromEngine(this)};Engine.prototype.removeAllSystems=function(){while(this.systemList.head!==null){this.removeSystem(this.systemList.head)}};Engine.prototype.update=function(time){var system;this.updating=true;system=this.systemList.head;while(system){system.update(time);system=system.next}this.updating=false;this.updateComplete.dispatch()};return Engine}();ash.fsm.ComponentInstanceProvider=ComponentInstanceProvider=function(){ComponentInstanceProvider.prototype.instance=null;function ComponentInstanceProvider(instance){this.instance=instance}ComponentInstanceProvider.prototype.getComponent=function(){return this.instance};Object.defineProperties(ComponentInstanceProvider.prototype,{identifier:{get:function(){return this.instance}}});return ComponentInstanceProvider}();ash.fsm.ComponentSingletonProvider=ComponentSingletonProvider=function(){ComponentSingletonProvider.prototype.componentType=null;ComponentSingletonProvider.prototype.instance=null;function ComponentSingletonProvider(type){this.componentType=type}ComponentSingletonProvider.prototype.getComponent=function(){if(this.instance==null){this.instance=new this.componentType}return this.instance};Object.defineProperties(ComponentSingletonProvider.prototype,{identifier:{get:function(){return this.getComponent()}}});return ComponentSingletonProvider}();ash.fsm.ComponentTypeProvider=ComponentTypeProvider=function(){ComponentTypeProvider.prototype.componentType=null;function ComponentTypeProvider(type){this.componentType=type}ComponentTypeProvider.prototype.getComponent=function(){return new this.componentType};Object.defineProperties(ComponentTypeProvider.prototype,{identifier:{get:function(){return this.componentType}}});return ComponentTypeProvider}();ash.fsm.DynamicComponentProvider=DynamicComponentProvider=function(){DynamicComponentProvider.prototype._closure=null;
function DynamicComponentProvider(closure){this._closure=closure}DynamicComponentProvider.prototype.getComponent=function(){return this._closure};Object.defineProperties(DynamicComponentProvider.prototype,{identifier:{get:function(){return this._closure}}});return DynamicComponentProvider}();ash.fsm.DynamicSystemProvider=DynamicSystemProvider=function(){DynamicSystemProvider.prototype.method=function(){};DynamicSystemProvider.prototype.systemPriority=0;function DynamicSystemProvider(method1){this.method=method1}DynamicSystemProvider.prototype.getSystem=function(){return this.method()};Object.defineProperties(DynamicSystemProvider.prototype,{identifier:{get:function(){return this.method}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return DynamicSystemProvider}();ash.fsm.EngineState=EngineState=function(){EngineState.prototype.providers=null;function EngineState(){this.providers=[]}EngineState.prototype.addInstance=function(system){return this.addProvider(new SystemInstanceProvider(system))};EngineState.prototype.addSingleton=function(type){return this.addProvider(new SystemSingletonProvider(type))};EngineState.prototype.addMethod=function(method){return this.addProvider(new DynamicSystemProvider(method))};EngineState.prototype.addProvider=function(provider){var mapping;mapping=new StateSystemMapping(this,provider);this.providers.push(provider);return mapping};return EngineState}();ash.fsm.StateComponentMapping=StateComponentMapping=function(){StateComponentMapping.prototype.componentType=null;StateComponentMapping.prototype.creatingState=null;StateComponentMapping.prototype.provider=null;function StateComponentMapping(creatingState1,type){this.creatingState=creatingState1;this.componentType=type;this.withType(type)}StateComponentMapping.prototype.withInstance=function(component){this.setProvider(new ComponentInstanceProvider(component));return this};StateComponentMapping.prototype.withType=function(type){this.setProvider(new ComponentTypeProvider(type));return this};StateComponentMapping.prototype.withSingleton=function(type){if(type==null){type=this.componentType}this.setProvider(new ComponentSingletonProvider(type));return this};StateComponentMapping.prototype.withMethod=function(method){this.setProvider(new DynamicComponentProvider(method));return this};StateComponentMapping.prototype.withProvider=function(provider){this.setProvider(provider);return this};StateComponentMapping.prototype.add=function(type){return this.creatingState.add(type)};StateComponentMapping.prototype.setProvider=function(provider){this.provider=provider;return this.creatingState.providers[this.componentType]=provider};return StateComponentMapping}();ash.fsm.EngineStateMachine=EngineStateMachine=function(){EngineStateMachine.prototype.engine=null;EngineStateMachine.prototype.states=null;EngineStateMachine.prototype.currentState=null;function EngineStateMachine(engine1){this.engine=engine1;this.states=new Dictionary}EngineStateMachine.prototype.addState=function(name,state){this.states[name]=state;return this};EngineStateMachine.prototype.createState=function(name){var state;state=new EngineState;this.states[name]=state;return this};EngineStateMachine.prototype.changeState=function(name){var each,id,newState,other,provider,ref,ref1,toAdd;newState=this.states[name];if(newState==null){throw new Error("Engine state "+name+" doesn't exist")}if(newState===this.currentState){newState=null;return}toAdd=new Dictionary;ref=newState.providers;for(each in ref){provider=ref[each];id=provider.identifier;toAdd[id]=provider}if(currentState){ref1=this.currentState.providers;for(each in ref1){provider=ref1[each];id=provider.identifier;other=toAdd[id];if(other){delete toAdd[id]}else{this.engine.removeSystem(provider.getSystem())}}}for(each in toAdd){provider=toAdd[each];this.engine.addSystem(provider.getSystem(),provider.priority)}return this.currentState=newState};return EngineStateMachine}();ash.fsm.EntityState=EntityState=function(){EntityState.prototype.providers=null;function EntityState(){this.providers=new Dictionary}EntityState.prototype.add=function(type){return new StateComponentMapping(this,type.name)};EntityState.prototype.get=function(type){return this.providers[type]};EntityState.prototype.has=function(type){return this.providers[type]!==null};return EntityState}();ash.fsm.EntityStateMachine=EntityStateMachine=function(){EntityStateMachine.prototype.states=null;EntityStateMachine.prototype.currentState=null;EntityStateMachine.prototype.entity=null;function EntityStateMachine(entity1){this.entity=entity1;this.states=new Dictionary}EntityStateMachine.prototype.addState=function(name,state){this.states[name]=state;return this};EntityStateMachine.prototype.createState=function(name){var state;state=new EntityState;this.states[name]=state;return state};EntityStateMachine.prototype.changeState=function(name){var newState,other,toAdd,type;newState=this.states[name];if(!newState){throw new Error("Entity state "+name+" doesn't exist")}if(newState===this.currentState){newState=null;return}if(this.currentState){toAdd=new Dictionary;for(type in newState.providers){toAdd[type]=newState.providers[type]}for(type in this.currentState.providers){other=toAdd[type];if(other&&other.identifier===this.currentState.providers[type].identifier){delete toAdd[type]}else{this.entity.remove(type)}}}else{toAdd=newState.providers}for(type in toAdd){this.entity.add(toAdd[type].getComponent())}return this.currentState=newState};return EntityStateMachine}();ash.fsm.StateSystemMapping=StateSystemMapping=function(){StateSystemMapping.prototype.creatingState=null;StateSystemMapping.prototype.provider=null;function StateSystemMapping(creatingState1,provider1){this.creatingState=creatingState1;this.provider=provider1}StateSystemMapping.prototype.withPriority=function(priority){this.provider.priority=priority;return this};StateSystemMapping.prototype.addInstance=function(system){return creatingState.addInstance(system)};StateSystemMapping.prototype.addSingleton=function(type){return creatingState.addSingleton(type)};StateSystemMapping.prototype.addMethod=function(method){return creatingState.addMethod(method)};StateSystemMapping.prototype.addProvider=function(provider){return creatingState.addProvider(provider)};return StateSystemMapping}();ash.fsm.SystemInstanceProvider=SystemInstanceProvider=function(){SystemInstanceProvider.prototype.instance=null;SystemInstanceProvider.prototype.systemPriority=0;function SystemInstanceProvider(instance){this.instance=instance}SystemInstanceProvider.prototype.getSystem=function(){return this.instance};Object.defineProperties(SystemInstanceProvider.prototype,{identifier:{get:function(){return this.instance}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return SystemInstanceProvider}();ash.fsm.SystemSingletonProvider=SystemSingletonProvider=function(){SystemSingletonProvider.prototype.componentType=null;SystemSingletonProvider.prototype.instance=null;SystemSingletonProvider.prototype.systemPriority=0;function SystemSingletonProvider(type){this.componentType=type}SystemSingletonProvider.prototype.getSystem=function(){if(!this.instance){this.instance=new this.componentType}return this.instance};Object.defineProperties(SystemSingletonProvider.prototype,{identifier:{get:function(){return this.getSystem()}},priority:{get:function(){return this.systemPriority},set:function(value){return this.systemPriority=value}}});return SystemSingletonProvider}();ash.tick.FrameTickProvider=FrameTickProvider=function(superClass){extend(FrameTickProvider,superClass);FrameTickProvider.prototype.displayObject=null;FrameTickProvider.prototype.previousTime=0;FrameTickProvider.prototype.maximumFrameTime=0;FrameTickProvider.prototype.isPlaying=false;FrameTickProvider.prototype.request=null;FrameTickProvider.prototype.timeAdjustment=1;function FrameTickProvider(displayObject,maximumFrameTime){this.displayObject=displayObject;this.maximumFrameTime=maximumFrameTime;this.dispatchTick=bind(this.dispatchTick,this);FrameTickProvider.__super__.constructor.apply(this,arguments)}Object.defineProperties(FrameTickProvider.prototype,{playing:{get:function(){return this.isPlaying}}});FrameTickProvider.prototype.start=function(){this.request=requestAnimationFrame(this.dispatchTick);this.isPlaying=true};FrameTickProvider.prototype.stop=function(){cancelRequestAnimationFrame(this.request);this.isPlaying=false};FrameTickProvider.prototype.dispatchTick=function(timestamp){var frameTime,temp;if(timestamp==null){timestamp=Date.now()}if(this.displayObject){this.displayObject.begin()}temp=this.previousTime||timestamp;this.previousTime=timestamp;frameTime=(timestamp-temp)*.001;this.dispatch(frameTime);requestAnimationFrame(this.dispatchTick);if(this.displayObject){this.displayObject.end()}};return FrameTickProvider}(Signal1);ash.tools.ComponentPool=ComponentPool=function(){var getPool,pools;function ComponentPool(){}pools=new Dictionary;getPool=function(componentClass){var ref;if(ref=componentClass.name,indexOf.call(pools,ref)>=0){return pools[componentClass.name]}else{return pools[componentClass.name]=[]}};ComponentPool.get=function(componentClass){var pool;pool=getPool(componentClass);if(pool.length>0){return pool.pop()}else{return new componentClass}};ComponentPool.dispose=function(component){var pool,type;if(component){type=component.constructor;pool=getPool(type);pool.push(component)}};ComponentPool.empty=function(){return pools=new Dictionary};return ComponentPool}();ash.tools.ListIteratingSystem=ListIteratingSystem=function(superClass){extend(ListIteratingSystem,superClass);ListIteratingSystem.prototype.nodeList=null;ListIteratingSystem.prototype.nodeClass=null;ListIteratingSystem.prototype.nodeUpdateFunction=null;ListIteratingSystem.prototype.nodeAddedFunction=null;ListIteratingSystem.prototype.nodeRemovedFunction=null;function ListIteratingSystem(nodeClass,nodeUpdateFunction,nodeAddedFunction,nodeRemovedFunction){if(nodeAddedFunction==null){nodeAddedFunction=null}if(nodeRemovedFunction==null){nodeRemovedFunction=null}this.nodeClass=nodeClass;this.nodeUpdateFunction=nodeUpdateFunction;this.nodeAddedFunction=nodeAddedFunction;this.nodeRemovedFunction=nodeRemovedFunction}ListIteratingSystem.prototype.addToEngine=function(engine){var node;this.nodeList=engine.getNodeList(this.nodeClass);if(this.nodeAddedFunction!==null){node=this.nodeList.head;while(node){this.nodeAddedFunction(node);node=node.next}this.nodeList.nodeAdded.add(this.nodeAddedFunction)}if(this.nodeRemovedFunction!==null){this.nodeList.nodeRemoved.add(this.nodeRemovedFunction)}};ListIteratingSystem.prototype.removeFromEngine=function(engine){if(this.nodeAddedFunction!==null){this.nodeList.nodeAdded.remove(this.nodeAddedFunction)}if(this.nodeRemovedFunction!==null){this.nodeList.nodeRemoved.remove(this.nodeRemovedFunction)}this.nodeList=null};ListIteratingSystem.prototype.update=function(time){var node;node=this.nodeList.head;while(node){this.nodeUpdateFunction(node,time);node=node.next}};return ListIteratingSystem}(System);if(typeof module!=="undefined"&&module!==null){module.exports=ash}else{window.ash=ash}}).call(this);var Stats=function(){var l=Date.now(),m=l,g=0,n=Infinity,o=0,h=0,p=Infinity,q=0,r=0,s=0,f=document.createElement("div");f.id="stats";f.addEventListener("mousedown",function(b){b.preventDefault();t(++s%2)},!1);f.style.cssText="width:80px;opacity:0.9;cursor:pointer";var a=document.createElement("div");a.id="fps";a.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002";f.appendChild(a);var i=document.createElement("div");i.id="fpsText";i.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";i.innerHTML="FPS";a.appendChild(i);var c=document.createElement("div");c.id="fpsGraph";c.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";for(a.appendChild(c);74>c.children.length;){var j=document.createElement("span");j.style.cssText="width:1px;height:30px;float:left;background-color:#113";c.appendChild(j)}var d=document.createElement("div");d.id="ms";d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none";f.appendChild(d);var k=document.createElement("div");k.id="msText";k.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";k.innerHTML="MS";d.appendChild(k);var e=document.createElement("div");e.id="msGraph";e.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";for(d.appendChild(e);74>e.children.length;)j=document.createElement("span"),j.style.cssText="width:1px;height:30px;float:left;background-color:#131",e.appendChild(j);var t=function(b){s=b;switch(s){case 0:a.style.display="block";d.style.display="none";break;case 1:a.style.display="none",d.style.display="block"}};return{REVISION:12,domElement:f,setMode:t,begin:function(){l=Date.now()},end:function(){var b=Date.now();g=b-l;n=Math.min(n,g);o=Math.max(o,g);k.textContent=g+" MS ("+n+"-"+o+")";var a=Math.min(30,30-30*(g/200));e.appendChild(e.firstChild).style.height=a+"px";r++;b>m+1e3&&(h=Math.round(1e3*r/(b-m)),p=Math.min(p,h),q=Math.max(q,h),i.textContent=h+" FPS ("+p+"-"+q+")",a=Math.min(30,30-30*(h/100)),c.appendChild(c.firstChild).style.height=a+"px",m=b,r=0);return b},update:function(){l=this.end()}}};"object"===typeof module&&(module.exports=Stats);(function(){"use strict";var Animation,AnimationNode,AnimationSystem,Asteroid,AsteroidCollisionNode,AsteroidDeathView,AsteroidView,Asteroids,Audio,AudioNode,AudioSystem,Bullet,BulletAgeNode,BulletAgeSystem,BulletCollisionNode,BulletView,Collision,CollisionSystem,DeathThroes,DeathThroesNode,DeathThroesSystem,Display,Dot,EntityCreator,ExplodeAsteroid,ExplodeShip,GameConfig,GameManager,GameNode,GameState,Gun,GunControlNode,GunControlSystem,GunControls,Hud,HudNode,HudSystem,HudView,KeyPoll,MersenneTwister,MotionControls,MovementNode,Physics,PhysicsControlNode,PhysicsControlSystem,PhysicsNode,PhysicsSystem,Point,Position,RenderNode,RenderSystem,ShootGun,Sound,Spaceship,SpaceshipDeathView,SpaceshipNode,SpaceshipView,SystemPriorities,WaitForStart,WaitForStartNode,WaitForStartSystem,WaitForStartView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};MersenneTwister=function(){var LOWER_MASK,M,MATRIX_A,N,UPPER_MASK;N=624;M=397;MATRIX_A=2567483615;UPPER_MASK=2147483648;LOWER_MASK=2147483647;MersenneTwister.prototype.mt=null;MersenneTwister.prototype.mti=N+1;function MersenneTwister(seed){var _i,_results;this.mt=function(){_results=[];for(var _i=0;0<=N?_i<N:_i>N;0<=N?_i++:_i--){_results.push(_i)}return _results}.apply(this);switch(typeof seed){case"number":this.init_genrand(seed);break;case"object":this.init_genrand(seed,seed.length);break;default:this.init_genrand(Date.now()%LOWER_MASK)}}MersenneTwister.prototype.nextBool=function(){return(this.genrand_int32()&1)===1};MersenneTwister.prototype.nextDouble=function(){return this.genrand_res53()};MersenneTwister.prototype.nextInt=function(max){return~~(this.genrand_res53()*max)};MersenneTwister.prototype.init_genrand=function(s){this.mt[0]=s&4294967295;this.mti=1;while(this.mti<N){this.mt[this.mti]=1812433253*(this.mt[this.mti-1]^this.mt[this.mti-1]>>30)+this.mti;this.mt[this.mti]&=4294967295;this.mti++}};MersenneTwister.prototype.init_by_array=function(init_key,key_length){var i,j,k;this.init_genrand(19650218);i=1;j=0;k=N>key_length?N:key_length;while(k>0){this.mt[i]=(this.mt[i]^(this.mt[i-1]^this.mt[i-1]>>30)*1664525)+init_key[j]+j;this.mt[i]&=4294967295;i++;j++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}if(j>=key_length){j=0}k--}k=N-1;while(k>0){this.mt[i]=(this.mt[i]^(this.mt[i-1]^this.mt[i-1]>>30)*1566083941)-i;this.mt[i]&=4294967295;i++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}k--}this.mt[0]=2147483648};MersenneTwister.prototype.genrand_int32=function(){var kk,mag01,y;mag01=[0,MATRIX_A];if(this.mti>=N){if(this.mti===N+1){this.init_genrand(5489)}kk=0;while(kk<N-M){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+M]^y>>1^mag01[y&1];kk++}while(kk<N-1){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+(M-N)]^y>>1^mag01[y&1];kk++}y=this.mt[N-1]&UPPER_MASK|this.mt[0]&LOWER_MASK;this.mt[N-1]=this.mt[M-1]^y>>1^mag01[y&1];this.mti=0}y=this.mt[this.mti++];y^=y>>11;y^=y<<7&2636928640;y^=y<<15&4022730752;y^=y>>18;return y>>0};MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>1};MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967296)};MersenneTwister.prototype.genrand_real2=function(){return this.genrand_int32()*(1/4294967296)};MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)};MersenneTwister.prototype.genrand_res53=function(){var a,b;a=this.genrand_int32()>>5;b=this.genrand_int32()>>6;return(a*67108864+b)*(1/9007199254740992)};return MersenneTwister}();Point=function(){Point.prototype.x=0;Point.prototype.y=0;function Point(x,y){this.x=x!=null?x:0;this.y=y!=null?y:0}Point.distance=function(point1,point2){var dx,dy;dx=point1.x-point2.x;dy=point1.y-point2.y;return Math.sqrt(dx*dx+dy*dy)};Point.prototype.distanceSquaredTo=function(targetPoint){var dx,dy;dx=this.x-targetPoint.x;dy=this.y-targetPoint.y;return dx*dx+dy*dy};Point.prototype.distanceTo=function(targetPoint){var dx,dy;dx=this.x-targetPoint.x;dy=this.y-targetPoint.y;return Math.sqrt(dx*dx+dy*dy)};return Point}();KeyPoll=function(){KeyPoll.KEY_LEFT=37;KeyPoll.KEY_UP=38;KeyPoll.KEY_RIGHT=39;KeyPoll.KEY_Z=90;KeyPoll.prototype.states=null;KeyPoll.prototype.stage=null;KeyPoll.prototype.btn0=null;KeyPoll.prototype.btn1=null;KeyPoll.prototype.btn2=null;KeyPoll.prototype.btn3=null;KeyPoll.prototype.keys=[KeyPoll.KEY_LEFT,KeyPoll.KEY_RIGHT,KeyPoll.KEY_Z,KeyPoll.KEY_UP];function KeyPoll(stage,config){this.stage=stage;this.isUp=__bind(this.isUp,this);this.isDown=__bind(this.isDown,this);this.keyUpListener=__bind(this.keyUpListener,this);this.keyDownListener=__bind(this.keyDownListener,this);this.states={};window.addEventListener("keydown",this.keyDownListener);window.addEventListener("keyup",this.keyUpListener);this.gamePad(config)}KeyPoll.prototype.keyDownListener=function(event){this.states[event.keyCode]=true};KeyPoll.prototype.keyUpListener=function(event){if(this.states[event.keyCode]){this.states[event.keyCode]=false}};KeyPoll.prototype.isDown=function(keyCode){return this.states[keyCode]};KeyPoll.prototype.isUp=function(keyCode){return!this.states[keyCode]};KeyPoll.prototype.gamePad=function(config){var tmp1,tmp2;tmp1=PIXI.Texture.fromImage("res/round.png");tmp2=PIXI.Texture.fromImage("res/square.png");this.btn0=new PIXI.Sprite(tmp1);this.btn0.interactive=true;this.btn0.width*=window.devicePixelRatio*1.4;this.btn0.height*=window.devicePixelRatio*1.4;this.btn0.position.x=0;this.btn0.position.y=config.height-this.btn0.height*2+35;this.btn0.mousedown=this.btn0.touchstart=function(_this){return function(evt){_this.states[_this.keys[0]]=true}}(this);this.btn0.mouseup=this.btn0.touchend=function(_this){return function(evt){_this.states[_this.keys[0]]=false}}(this);this.btn1=new PIXI.Sprite(tmp1);this.btn1.interactive=true;this.btn1.width*=window.devicePixelRatio*1.4;this.btn1.height*=window.devicePixelRatio*1.4;this.btn1.position.x=this.btn1.width-35;this.btn1.position.y=config.height-this.btn1.height;this.btn1.mousedown=this.btn1.touchstart=function(_this){return function(evt){_this.states[_this.keys[1]]=true}}(this);this.btn1.mouseup=this.btn1.touchend=function(_this){return function(evt){_this.states[_this.keys[1]]=false}}(this);this.btn2=new PIXI.Sprite(tmp1);this.btn2.interactive=true;this.btn2.width*=window.devicePixelRatio*1.4;this.btn2.height*=window.devicePixelRatio*1.4;this.btn2.position.x=config.width-this.btn2.width*2+35;this.btn2.position.y=config.height-this.btn2.height;this.btn2.mousedown=this.btn2.touchstart=function(_this){return function(evt){_this.states[_this.keys[2]]=true}}(this);this.btn2.mouseup=this.btn2.touchend=function(_this){return function(evt){_this.states[_this.keys[2]]=false}}(this);this.btn3=new PIXI.Sprite(tmp2);this.btn3.interactive=true;this.btn3.width*=window.devicePixelRatio*1.4;this.btn3.height*=window.devicePixelRatio*1.4;this.btn3.position.x=config.width-this.btn3.width;this.btn3.position.y=config.height-this.btn3.height*2+35;this.btn3.mousedown=this.btn3.touchstart=function(_this){return function(evt){_this.states[_this.keys[3]]=true}}(this);this.btn3.mouseup=this.btn3.touchend=function(_this){return function(evt){_this.states[_this.keys[3]]=false}}(this);this.stage.addChild(this.btn0);this.stage.addChild(this.btn1);this.stage.addChild(this.btn2);return this.stage.addChild(this.btn3)};return KeyPoll}();Sound=function(){Sound.volume=.5;Sound.enabled=true;Sound.preload=function(src){var audio;audio=new window.Audio;audio.src=src;audio.volume=0;audio.play();return src};Sound.prototype.src="";Sound.prototype.audio=null;function Sound(){this.audio=new window.Audio;this.audio.src=this.src;this.audio.load()}Sound.prototype.loop=function(){return this};Sound.prototype.play=function(){if(Sound.enabled){this.audio.volume=Sound.volume;this.audio.play()}return this};Sound.prototype.pause=function(){this.audio.pause();return this};return Sound}();ExplodeAsteroid=function(_super){__extends(ExplodeAsteroid,_super);function ExplodeAsteroid(){return ExplodeAsteroid.__super__.constructor.apply(this,arguments)}ExplodeAsteroid.prototype.src=Sound.preload("res/sounds/asteroid.wav");return ExplodeAsteroid}(Sound);ExplodeShip=function(_super){__extends(ExplodeShip,_super);function ExplodeShip(){return ExplodeShip.__super__.constructor.apply(this,arguments)}ExplodeShip.prototype.src=Sound.preload("res/sounds/ship.wav");return ExplodeShip}(Sound);ShootGun=function(_super){__extends(ShootGun,_super);function ShootGun(){return ShootGun.__super__.constructor.apply(this,arguments)}ShootGun.prototype.src=Sound.preload("res/sounds/shoot.wav");return ShootGun}(Sound);AsteroidView=function(){AsteroidView.prototype.graphics=null;Object.defineProperties(AsteroidView.prototype,{x:{get:function(){return this.graphics.x},set:function(x){return this.graphics.x=x}},y:{get:function(){return this.graphics.x},set:function(y){return this.graphics.y=y}},rotation:{get:function(){return this.graphics.rotation},set:function(rotation){return this.graphics.rotation=rotation}}});function AsteroidView(stage,radius){var angle,length,posX,posY;this.stage=stage;this.graphics=new PIXI.Graphics;this.graphics.clear();angle=0;this.graphics.beginFill(16777215);this.graphics.moveTo(radius,0);while(angle<Math.PI*2){length=(.75+rnd.nextDouble()*.25)*radius;posX=Math.cos(angle)*length;posY=Math.sin(angle)*length;this.graphics.lineTo(posX,posY);angle+=rnd.nextDouble()*.5}this.graphics.moveTo(radius,0);this.graphics.endFill();this.stage.addChild(this.graphics)}AsteroidView.prototype.dispose=function(){return this.stage.removeChild(this.graphics)};return AsteroidView}();AsteroidDeathView=function(){AsteroidDeathView.prototype.dots=null;AsteroidDeathView.prototype.x=0;AsteroidDeathView.prototype.y=0;AsteroidDeathView.prototype.rotation=0;AsteroidDeathView.prototype.stage=null;AsteroidDeathView.prototype.first=true;function AsteroidDeathView(stage,radius){var dot,i,_i;this.stage=stage;this.animate=__bind(this.animate,this);this.dots=[];for(i=_i=0;_i<8;i=++_i){dot=new Dot(this.stage,radius);this.dots.push(dot)}}AsteroidDeathView.prototype.animate=function(time){var dot,_i,_j,_len,_len1,_ref,_ref1,_results;if(this.first){this.first=false;_ref=this.dots;for(_i=0,_len=_ref.length;_i<_len;_i++){dot=_ref[_i];this.stage.addChild(dot.graphics);dot.graphics.x=this.x;dot.graphics.y=this.y}}_ref1=this.dots;_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){dot=_ref1[_j];dot.graphics.x+=dot.velocity.x*time;_results.push(dot.graphics.y+=dot.velocity.y*time)}return _results};AsteroidDeathView.prototype.dispose=function(){var dot,_i,_len,_ref,_results;_ref=this.dots;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){dot=_ref[_i];_results.push(this.stage.removeChild(dot.graphics))}return _results};return AsteroidDeathView}();Dot=function(){Dot.prototype.velocity=null;Dot.prototype.graphics=null;Dot.prototype.x=0;Dot.prototype.y=0;function Dot(stage,maxDistance){var angle,distance,speed;this.stage=stage;this.graphics=new PIXI.Graphics;this.graphics.beginFill(16777215);this.graphics.drawCircle(0,0,1);this.graphics.endFill();angle=rnd.nextDouble()*2*Math.PI;distance=rnd.nextDouble()*maxDistance;this.graphics.x=Math.cos(angle)*distance;this.graphics.y=Math.sin(angle)*distance;speed=rnd.nextDouble()*10+10;this.velocity=new Point(Math.cos(angle)*speed,Math.sin(angle)*speed)}return Dot}();BulletView=function(){BulletView.prototype.graphics=null;Object.defineProperties(BulletView.prototype,{x:{get:function(){return this.graphics.x},set:function(x){return this.graphics.x=x}},y:{get:function(){return this.graphics.x},set:function(y){return this.graphics.y=y}},rotation:{get:function(){return this.graphics.rotation},set:function(rotation){return this.graphics.rotation=rotation}}});function BulletView(stage){this.stage=stage;this.graphics=new PIXI.Graphics;this.graphics.beginFill(16777215);this.graphics.drawCircle(0,0,2*window.devicePixelRatio);this.graphics.endFill();this.stage.addChild(this.graphics)}BulletView.prototype.dispose=function(){return this.stage.removeChild(this.graphics)};return BulletView}();HudView=function(){HudView.prototype.graphics=null;HudView.prototype.score=null;HudView.prototype.lives=null;HudView.prototype.x=0;HudView.prototype.y=0;HudView.prototype.rotation=0;function HudView(stage){this.setScore=__bind(this.setScore,this);this.setLives=__bind(this.setLives,this);this.graphics=new PIXI.Graphics;this.graphics.x=0;this.graphics.y=200;this.graphics.beginFill(12632256);this.graphics.drawRect(0,0,60,80);this.graphics.endFill();this.graphics.alpha=.5;stage.addChild(this.graphics);this.score=this.createTextField();this.score.x=window.innerWidth*window.devicePixelRatio-130;this.score.y=20;stage.addChild(this.score);this.setScore(0);this.setLives(3)}HudView.prototype.dispose=function(){this.stage.removeChild(this.graphics);return this.stage.removeChild(this.score)};HudView.prototype.setLives=function(lives){var c,i,_i;this.graphics.clear();this.graphics.beginFill(12632256);this.graphics.drawRect(0,0,60,80);this.graphics.endFill();this.graphics.beginFill(0);for(i=_i=0;0<=lives?_i<lives:_i>lives;i=0<=lives?++_i:--_i){c=i*20+20;this.graphics.moveTo(10*window.devicePixelRatio+20,0+c);this.graphics.lineTo(-7*window.devicePixelRatio+20,7*window.devicePixelRatio+c);this.graphics.lineTo(-4*window.devicePixelRatio+20,0+c);this.graphics.lineTo(-7*window.devicePixelRatio+20,-7*window.devicePixelRatio+c);this.graphics.lineTo(10*window.devicePixelRatio+20,0+c)}this.graphics.endFill();this.graphics.alpha=.5};HudView.prototype.setScore=function(score){this.score.setText("SCORE: "+score)};HudView.prototype.createTextField=function(){return new PIXI.Text("",{font:"bold 22px opendyslexic",fill:"#00ffff"})};return HudView}();SpaceshipDeathView=function(){SpaceshipDeathView.prototype.stage=null;SpaceshipDeathView.prototype.shape1=null;SpaceshipDeathView.prototype.shape2=null;SpaceshipDeathView.prototype.vel1=null;SpaceshipDeathView.prototype.vel2=null;SpaceshipDeathView.prototype.rot1=null;SpaceshipDeathView.prototype.rot2=null;SpaceshipDeathView.prototype.first=true;SpaceshipDeathView.prototype.x=0;SpaceshipDeathView.prototype.y=0;SpaceshipDeathView.prototype.rotation=0;SpaceshipDeathView.prototype.check=true;function SpaceshipDeathView(stage){this.stage=stage;this.animate=__bind(this.animate,this);this.shape1=new PIXI.Graphics;this.shape1.clear();this.shape1.beginFill(16777215);this.shape1.moveTo(10*window.devicePixelRatio,0);this.shape1.lineTo(-7*window.devicePixelRatio,7*window.devicePixelRatio);this.shape1.lineTo(-4*window.devicePixelRatio,0);this.shape1.lineTo(10*window.devicePixelRatio,0);this.shape1.endFill();this.shape2=new PIXI.Graphics;this.shape2.clear();this.shape2.beginFill(16777215);this.shape2.moveTo(10*window.devicePixelRatio,0);this.shape2.lineTo(-7*window.devicePixelRatio,-7*window.devicePixelRatio);this.shape2.lineTo(-4*window.devicePixelRatio,0);this.shape2.lineTo(10*window.devicePixelRatio,0);this.shape2.endFill();this.vel1=new Point(rnd.nextDouble()*10-5,rnd.nextDouble()*10+10);this.vel2=new Point(rnd.nextDouble()*10-5,-(rnd.nextDouble()*10+10));this.rot1=rnd.nextDouble()*300-150;this.rot2=rnd.nextDouble()*300-150}SpaceshipDeathView.prototype.dispose=function(){this.stage.removeChild(this.shape1);return this.stage.removeChild(this.shape2)};SpaceshipDeathView.prototype.animate=function(time){if(this.first){this.first=false;this.stage.addChild(this.shape1);this.stage.addChild(this.shape2);this.shape1.x=this.shape2.x=this.x;this.shape1.y=this.shape2.y=this.y;this.shape1.rotation=this.shape2.rotation=this.rotation}this.shape1.x+=this.vel1.x*time;this.shape1.y+=this.vel1.y*time;this.shape1.rotation+=this.rot1*time;this.shape2.x+=this.vel2.x*time;this.shape2.y+=this.vel2.y*time;this.shape2.rotation+=this.rot2*time};return SpaceshipDeathView}();SpaceshipView=function(){SpaceshipView.prototype.stage=null;SpaceshipView.prototype.graphics=null;Object.defineProperties(SpaceshipView.prototype,{x:{get:function(){return this.graphics.x},set:function(x){return this.graphics.x=x}},y:{get:function(){return this.graphics.x},set:function(y){return this.graphics.y=y}},rotation:{get:function(){return this.graphics.rotation},set:function(rotation){return this.graphics.rotation=rotation}}});function SpaceshipView(stage){this.stage=stage;this.graphics=new PIXI.Graphics;this.graphics.clear();this.graphics.beginFill(16777215);this.graphics.moveTo(10*window.devicePixelRatio,0);this.graphics.lineTo(-7*window.devicePixelRatio,7*window.devicePixelRatio);this.graphics.lineTo(-4*window.devicePixelRatio,0);this.graphics.lineTo(-7*window.devicePixelRatio,-7*window.devicePixelRatio);this.graphics.lineTo(10*window.devicePixelRatio,0);this.graphics.endFill();this.stage.addChild(this.graphics)}SpaceshipView.prototype.dispose=function(){return this.stage.removeChild(this.graphics)};return SpaceshipView}();WaitForStartView=function(){var Signal0;WaitForStartView.count=0;Signal0=ash.signals.Signal0;WaitForStartView.prototype.x=0;WaitForStartView.prototype.y=0;WaitForStartView.prototype.rotation=0;WaitForStartView.prototype.text1=null;WaitForStartView.prototype.text2=null;WaitForStartView.prototype.text3=null;WaitForStartView.prototype.click=null;function WaitForStartView(stage){this.stage=stage;this.start=__bind(this.start,this);this.click=new Signal0;this.createText(WaitForStartView.count++)}WaitForStartView.prototype.createText=function(first){if(first===1){this.text1=new PIXI.Text("GAME OVER",{font:"bold 120px opendyslexic",fill:"white",stroke:"black",strokeThickness:60})}else{this.text1=new PIXI.Text("ASTEROIDS",{font:"bold 120px opendyslexic",fill:"white",stroke:"black",strokeThickness:60})}this.text2=new PIXI.Text("CLICK TO START",{font:"bold 24px opendyslexic",fill:"white"});this.text3=new PIXI.Text("Z to Fire  ~  Arrow Keys to Move",{font:"bold 18px opendyslexic",fill:"white"});this.text1.anchor.x=.5;this.text1.position.x=Math.floor(window.innerWidth*window.devicePixelRatio/2);this.text1.position.y=175;this.text2.anchor.x=.5;this.text2.position.x=Math.floor(window.innerWidth*window.devicePixelRatio/2);this.text2.position.y=335;this.text3.anchor.x=.5;this.text3.position.x=Math.floor(window.innerWidth*window.devicePixelRatio/2);this.text3.position.y=window.innerHeight*window.devicePixelRatio-40;
this.text1.interactive=true;this.text2.interactive=true;this.text1.mousedown=this.text1.touchstart=this.text2.mousedown=this.text2.touchstart=this.start;this.stage.addChild(this.text1);this.stage.addChild(this.text2);return this.stage.addChild(this.text3)};WaitForStartView.prototype.start=function(data){this.stage.removeChild(this.text1);this.stage.removeChild(this.text2);this.stage.removeChild(this.text3);return this.click.dispatch()};return WaitForStartView}();Animation=function(){Animation.prototype.animation=null;function Animation(animation){this.animation=animation}return Animation}();Asteroid=function(){Asteroid.prototype.fsm=null;function Asteroid(fsm){this.fsm=fsm}return Asteroid}();Audio=function(){Audio.prototype.toPlay=null;function Audio(){this.toPlay=[]}Audio.prototype.play=function(sound){return this.toPlay.push(sound)};return Audio}();Bullet=function(){Bullet.prototype.lifeRemaining=0;function Bullet(lifeRemaining){this.lifeRemaining=lifeRemaining}return Bullet}();Collision=function(){Collision.prototype.radius=0;function Collision(radius){this.radius=radius}return Collision}();DeathThroes=function(){DeathThroes.prototype.countdown=0;DeathThroes.prototype.body=null;function DeathThroes(duration){this.countdown=duration}return DeathThroes}();Display=function(){Display.prototype.graphic=0;function Display(graphic){this.graphic=graphic}return Display}();GameState=function(){function GameState(){}GameState.prototype.lives=3;GameState.prototype.level=0;GameState.prototype.hits=0;GameState.prototype.playing=false;GameState.prototype.setForStart=function(){this.lives=3;this.level=0;this.hits=0;this.playing=true};return GameState}();Gun=function(){Gun.prototype.shooting=false;Gun.prototype.offsetFromParent=null;Gun.prototype.timeSinceLastShot=0;Gun.prototype.offsetFromParent=null;function Gun(offsetX,offsetY,minimumShotInterval,bulletLifetime){this.minimumShotInterval=minimumShotInterval;this.bulletLifetime=bulletLifetime;this.shooting=false;this.offsetFromParent=null;this.timeSinceLastShot=0;this.offsetFromParent=new Point(offsetX,offsetY)}return Gun}();GunControls=function(){GunControls.prototype.trigger=0;function GunControls(trigger){this.trigger=trigger}return GunControls}();Hud=function(){Hud.prototype.view=null;function Hud(view){this.view=view}return Hud}();MotionControls=function(){MotionControls.prototype.left=0;MotionControls.prototype.right=0;MotionControls.prototype.accelerate=0;MotionControls.prototype.accelerationRate=0;MotionControls.prototype.rotationRate=0;function MotionControls(left,right,accelerate,accelerationRate,rotationRate){this.left=left;this.right=right;this.accelerate=accelerate;this.accelerationRate=accelerationRate;this.rotationRate=rotationRate}return MotionControls}();Physics=function(){Physics.prototype.body=null;function Physics(body){this.body=body}return Physics}();Position=function(){Position.prototype.position=null;Position.prototype.rotation=0;function Position(x,y,rotation){this.rotation=rotation;this.position=new Point(x,y)}return Position}();Spaceship=function(){Spaceship.prototype.fsm=null;function Spaceship(fsm){this.fsm=fsm}return Spaceship}();WaitForStart=function(){WaitForStart.prototype.waitForStart=null;WaitForStart.prototype.startGame=false;function WaitForStart(waitForStart){this.waitForStart=waitForStart;this.setStartGame=__bind(this.setStartGame,this);this.waitForStart.click.add(this.setStartGame)}WaitForStart.prototype.setStartGame=function(){this.startGame=true};return WaitForStart}();AnimationNode=function(_super){__extends(AnimationNode,_super);function AnimationNode(){return AnimationNode.__super__.constructor.apply(this,arguments)}AnimationNode.components={animation:Animation};AnimationNode.prototype.animation=null;return AnimationNode}(ash.core.Node);AsteroidCollisionNode=function(_super){__extends(AsteroidCollisionNode,_super);function AsteroidCollisionNode(){return AsteroidCollisionNode.__super__.constructor.apply(this,arguments)}AsteroidCollisionNode.components={asteroid:Asteroid,position:Position,collision:Collision,audio:Audio,physics:Physics};AsteroidCollisionNode.prototype.asteroid=null;AsteroidCollisionNode.prototype.position=null;AsteroidCollisionNode.prototype.collision=null;AsteroidCollisionNode.prototype.audio=null;AsteroidCollisionNode.prototype.physics=null;return AsteroidCollisionNode}(ash.core.Node);AudioNode=function(_super){__extends(AudioNode,_super);function AudioNode(){return AudioNode.__super__.constructor.apply(this,arguments)}AudioNode.components={audio:Audio};AudioNode.prototype.audio=null;return AudioNode}(ash.core.Node);BulletAgeNode=function(_super){__extends(BulletAgeNode,_super);function BulletAgeNode(){return BulletAgeNode.__super__.constructor.apply(this,arguments)}BulletAgeNode.components={bullet:Bullet,physics:Physics,display:Display};BulletAgeNode.prototype.bullet=null;BulletAgeNode.prototype.physics=null;BulletAgeNode.prototype.display=null;return BulletAgeNode}(ash.core.Node);BulletCollisionNode=function(_super){__extends(BulletCollisionNode,_super);function BulletCollisionNode(){return BulletCollisionNode.__super__.constructor.apply(this,arguments)}BulletCollisionNode.components={bullet:Bullet,position:Position,physics:Physics};BulletCollisionNode.prototype.bullet=null;BulletCollisionNode.prototype.physics=null;return BulletCollisionNode}(ash.core.Node);DeathThroesNode=function(_super){__extends(DeathThroesNode,_super);function DeathThroesNode(){return DeathThroesNode.__super__.constructor.apply(this,arguments)}DeathThroesNode.components={dead:DeathThroes,display:Display};DeathThroesNode.prototype.dead=null;DeathThroesNode.prototype.display=null;return DeathThroesNode}(ash.core.Node);GameNode=function(_super){__extends(GameNode,_super);function GameNode(){return GameNode.__super__.constructor.apply(this,arguments)}GameNode.components={state:GameState};GameNode.prototype.state=null;return GameNode}(ash.core.Node);GunControlNode=function(_super){__extends(GunControlNode,_super);function GunControlNode(){return GunControlNode.__super__.constructor.apply(this,arguments)}GunControlNode.components={audio:Audio,control:GunControls,gun:Gun,position:Position};GunControlNode.prototype.control=null;GunControlNode.prototype.gun=null;GunControlNode.prototype.position=null;GunControlNode.prototype.audio=null;return GunControlNode}(ash.core.Node);HudNode=function(_super){__extends(HudNode,_super);function HudNode(){return HudNode.__super__.constructor.apply(this,arguments)}HudNode.components={state:GameState,hud:Hud};HudNode.prototype.state=null;HudNode.prototype.hud=null;return HudNode}(ash.core.Node);MovementNode=function(_super){__extends(MovementNode,_super);function MovementNode(){return MovementNode.__super__.constructor.apply(this,arguments)}MovementNode.components={position:Position};MovementNode.prototype.position=null;return MovementNode}(ash.core.Node);PhysicsControlNode=function(_super){__extends(PhysicsControlNode,_super);function PhysicsControlNode(){return PhysicsControlNode.__super__.constructor.apply(this,arguments)}PhysicsControlNode.components={control:MotionControls,physics:Physics};PhysicsControlNode.prototype.control=null;PhysicsControlNode.prototype.physics=null;return PhysicsControlNode}(ash.core.Node);PhysicsNode=function(_super){__extends(PhysicsNode,_super);function PhysicsNode(){return PhysicsNode.__super__.constructor.apply(this,arguments)}PhysicsNode.components={position:Position,physics:Physics};PhysicsNode.prototype.position=null;PhysicsNode.prototype.physics=null;return PhysicsNode}(ash.core.Node);RenderNode=function(_super){__extends(RenderNode,_super);function RenderNode(){return RenderNode.__super__.constructor.apply(this,arguments)}RenderNode.components={position:Position,display:Display};RenderNode.prototype.position=null;RenderNode.prototype.display=null;return RenderNode}(ash.core.Node);SpaceshipNode=function(_super){__extends(SpaceshipNode,_super);function SpaceshipNode(){return SpaceshipNode.__super__.constructor.apply(this,arguments)}SpaceshipNode.components={spaceship:Spaceship,position:Position};SpaceshipNode.prototype.spaceship=0;SpaceshipNode.prototype.position=0;return SpaceshipNode}(ash.core.Node);WaitForStartNode=function(_super){__extends(WaitForStartNode,_super);function WaitForStartNode(){return WaitForStartNode.__super__.constructor.apply(this,arguments)}WaitForStartNode.components={wait:WaitForStart};WaitForStartNode.prototype.wait=null;return WaitForStartNode}(ash.core.Node);PhysicsSystem=function(_super){var b2Body,b2Vec2;__extends(PhysicsSystem,_super);b2Body=Box2D.Dynamics.b2Body;b2Vec2=Box2D.Common.Math.b2Vec2;PhysicsSystem.prototype.config=null;PhysicsSystem.prototype.world=null;PhysicsSystem.prototype.stage=null;PhysicsSystem.prototype.creator=null;PhysicsSystem.prototype.nodes=null;PhysicsSystem.prototype.enabled=true;PhysicsSystem.deadPool=[];function PhysicsSystem(config,world,stage){this.config=config;this.world=world;this.stage=stage;this.updateNode=__bind(this.updateNode,this);this.update=__bind(this.update,this)}PhysicsSystem.prototype.addToEngine=function(engine){this.nodes=engine.getNodeList(PhysicsNode)};PhysicsSystem.prototype.removeFromEngine=function(engine){this.nodes=null};PhysicsSystem.prototype.update=function(time){var body,node,ud;if(!this.enabled){return}this.world.Step(time,10,10);this.world.ClearForces();node=this.nodes.head;while(node){this.updateNode(node,time);node=node.next}while(body=PhysicsSystem.deadPool.pop()){ud=body.GetUserData();if(ud.entity!=null){delete ud.entity}body.SetUserData(ud);this.world.DestroyBody(body)}};PhysicsSystem.prototype.updateNode=function(node,time){var body,physics,position,x,x1,y,y1,_ref;position=node.position;physics=node.physics;body=physics.body;_ref=body.GetPosition(),x=_ref.x,y=_ref.y;x1=x>this.config.width?0:x<0?this.config.width:x;y1=y>this.config.height?0:y<0?this.config.height:y;if(x1!==x||y1!==y){body.SetPosition(new b2Vec2(x1,y1))}position.position.x=x1;position.position.y=y1;position.rotation=body.GetAngularVelocity()};return PhysicsSystem}(ash.core.System);AnimationSystem=function(_super){__extends(AnimationSystem,_super);function AnimationSystem(){this.updateNode=__bind(this.updateNode,this);AnimationSystem.__super__.constructor.call(this,AnimationNode,this.updateNode)}AnimationSystem.prototype.updateNode=function(node,time){node.animation.animation.animate(time)};return AnimationSystem}(ash.tools.ListIteratingSystem);AudioSystem=function(_super){__extends(AudioSystem,_super);function AudioSystem(){this.updateNode=__bind(this.updateNode,this);AudioSystem.__super__.constructor.call(this,AudioNode,this.updateNode)}AudioSystem.prototype.updateNode=function(node,time){var each,sound,type,_ref;_ref=node.audio.toPlay;for(each in _ref){type=_ref[each];sound=new type;sound.play(0,1)}node.audio.toPlay=[]};return AudioSystem}(ash.tools.ListIteratingSystem);BulletAgeSystem=function(_super){__extends(BulletAgeSystem,_super);BulletAgeSystem.prototype.creator=null;function BulletAgeSystem(creator){this.creator=creator;this.updateNode=__bind(this.updateNode,this);BulletAgeSystem.__super__.constructor.call(this,BulletAgeNode,this.updateNode)}BulletAgeSystem.prototype.updateNode=function(node,time){var bullet;bullet=node.bullet;bullet.lifeRemaining-=time;if(bullet.lifeRemaining<=0){node.display.graphic.dispose();PhysicsSystem.deadPool.push(node.physics.body);this.creator.destroyEntity(node.entity)}};return BulletAgeSystem}(ash.tools.ListIteratingSystem);CollisionSystem=function(_super){var AsteroidHitShip,BulletHitAsteroid,b2ContactListener;__extends(CollisionSystem,_super);b2ContactListener=Box2D.Dynamics.b2ContactListener;BulletHitAsteroid=1;AsteroidHitShip=2;CollisionSystem.prototype.world=null;CollisionSystem.prototype.creator=null;CollisionSystem.prototype.games=null;CollisionSystem.prototype.collisions=null;function CollisionSystem(world,creator){this.world=world;this.creator=creator;this.PostSolve=__bind(this.PostSolve,this);this.PreSolve=__bind(this.PreSolve,this);this.EndContact=__bind(this.EndContact,this);this.BeginContact=__bind(this.BeginContact,this);this.update=__bind(this.update,this);this.collisions=[];this.world.SetContactListener(this)}CollisionSystem.prototype.update=function(time){var a,b,body,position,radius,type,_ref;while(this.collisions.length){_ref=this.collisions.pop(),type=_ref.type,a=_ref.a,b=_ref.b;if(type===BulletHitAsteroid){if(a.get(Physics)!=null){this.creator.destroyEntity(a);a.get(Display).graphic.dispose();PhysicsSystem.deadPool.push(a.get(Physics).body)}if(b.get(Physics)!=null){radius=b.get(Collision).radius;position=b.get(Position).position;if(radius>10){this.creator.createAsteroid(radius-10,position.x+rnd.nextDouble()*10-5,position.y+rnd.nextDouble()*10-5);this.creator.createAsteroid(radius-10,position.x+rnd.nextDouble()*10-5,position.y+rnd.nextDouble()*10-5)}body=b.get(Physics).body;b.get(Display).graphic.dispose();b.get(Asteroid).fsm.changeState("destroyed");b.get(DeathThroes).body=body;b.get(Audio).play(ExplodeAsteroid);if(this.games.head){this.games.head.state.hits++}}}else if(type===AsteroidHitShip){if(b.get(Physics)!=null){body=b.get(Physics).body;b.get(Display).graphic.dispose();b.get(Spaceship).fsm.changeState("destroyed");b.get(DeathThroes).body=body;b.get(Audio).play(ExplodeShip);if(this.games.head){this.games.head.state.lives--}}}}};CollisionSystem.prototype.addToEngine=function(engine){this.games=engine.getNodeList(GameNode)};CollisionSystem.prototype.removeFromEngine=function(engine){this.games=null};CollisionSystem.prototype.BeginContact=function(contact){var a,b;a=contact.GetFixtureA().GetBody().GetUserData();b=contact.GetFixtureB().GetBody().GetUserData();switch(a.type){case"asteroid":switch(b.type){case"bullet":this.collisions.push({type:BulletHitAsteroid,a:b.entity,b:a.entity});break;case"spaceship":this.collisions.push({type:AsteroidHitShip,a:a.entity,b:b.entity})}break;case"bullet":if(b.type==="asteroid"){this.collisions.push({type:BulletHitAsteroid,a:a.entity,b:b.entity})}break;case"spaceship":if(b.type==="asteroid"){this.collisions.push({type:AsteroidHitShip,a:b.entity,b:a.entity})}}};CollisionSystem.prototype.EndContact=function(contact){};CollisionSystem.prototype.PreSolve=function(contact,oldManifold){};CollisionSystem.prototype.PostSolve=function(contact,impulse){};return CollisionSystem}(ash.core.System);DeathThroesSystem=function(_super){__extends(DeathThroesSystem,_super);DeathThroesSystem.prototype.creator=null;function DeathThroesSystem(creator){this.creator=creator;this.updateNode=__bind(this.updateNode,this);DeathThroesSystem.__super__.constructor.call(this,DeathThroesNode,this.updateNode)}DeathThroesSystem.prototype.updateNode=function(node,time){var dead;dead=node.dead;dead.countdown-=time;if(dead.countdown<=0){this.creator.destroyEntity(node.entity);node.display.graphic.dispose();PhysicsSystem.deadPool.push(dead.body)}};return DeathThroesSystem}(ash.tools.ListIteratingSystem);GameManager=function(_super){__extends(GameManager,_super);GameManager.prototype.config=null;GameManager.prototype.creator=null;GameManager.prototype.gameNodes=null;GameManager.prototype.spaceships=null;GameManager.prototype.asteroids=null;GameManager.prototype.bullets=null;function GameManager(creator,config){this.creator=creator;this.config=config;this.update=__bind(this.update,this)}GameManager.prototype.addToEngine=function(engine){this.gameNodes=engine.getNodeList(GameNode);this.spaceships=engine.getNodeList(SpaceshipNode);this.asteroids=engine.getNodeList(AsteroidCollisionNode);this.bullets=engine.getNodeList(BulletCollisionNode)};GameManager.prototype.update=function(time){var asteroid,asteroidCount,clearToAddSpaceship,i,newSpaceshipPosition,node,position,spaceship;node=this.gameNodes.head;if(node&&node.state.playing){if(this.spaceships.empty){if(node.state.lives>0){newSpaceshipPosition=new Point(this.config.width*.5,this.config.height*.5);clearToAddSpaceship=true;asteroid=this.asteroids.head;while(asteroid){if(Point.distance(asteroid.position.position,newSpaceshipPosition)<=asteroid.collision.radius+50){clearToAddSpaceship=false;break}asteroid=asteroid.next}if(clearToAddSpaceship){this.creator.createSpaceship()}}else{node.state.playing=false;this.creator.createWaitForClick()}}if(this.asteroids.empty&&this.bullets.empty&&!this.spaceships.empty){spaceship=this.spaceships.head;node.state.level++;asteroidCount=2+node.state.level;i=0;while(i<asteroidCount){while(true){position=new Point(rnd.nextDouble()*this.config.width,rnd.nextDouble()*this.config.height);if(!(Point.distance(position,spaceship.position.position)<=80)){break}}this.creator.createAsteroid(30,position.x,position.y);++i}}}};GameManager.prototype.removeFromEngine=function(engine){this.gameNodes=null;this.spaceships=null;this.asteroids=null;this.bullets=null};return GameManager}(ash.core.System);GunControlSystem=function(_super){__extends(GunControlSystem,_super);GunControlSystem.prototype.keyPoll=null;GunControlSystem.prototype.creator=null;function GunControlSystem(keyPoll,creator){this.keyPoll=keyPoll;this.creator=creator;this.updateNode=__bind(this.updateNode,this);GunControlSystem.__super__.constructor.call(this,GunControlNode,this.updateNode)}GunControlSystem.prototype.updateNode=function(node,time){var control,gun,position;control=node.control;position=node.position;gun=node.gun;gun.shooting=this.keyPoll.isDown(control.trigger);gun.timeSinceLastShot+=time;if(gun.shooting&&gun.timeSinceLastShot>=gun.minimumShotInterval){this.creator.createUserBullet(gun,position);node.audio.play(ShootGun);gun.timeSinceLastShot=0}};return GunControlSystem}(ash.tools.ListIteratingSystem);HudSystem=function(_super){__extends(HudSystem,_super);function HudSystem(){this.updateNode=__bind(this.updateNode,this);HudSystem.__super__.constructor.call(this,HudNode,this.updateNode)}HudSystem.prototype.updateNode=function(node,time){node.hud.view.setLives(node.state.lives);node.hud.view.setScore(node.state.hits)};return HudSystem}(ash.tools.ListIteratingSystem);PhysicsControlSystem=function(_super){var IDTK,R,b2Vec2,_ref;__extends(PhysicsControlSystem,_super);R=window.devicePixelRatio;IDTK=((_ref=window.ext)!=null?_ref.IDTK_SRV_BOX2D:void 0)!=null;b2Vec2=Box2D.Common.Math.b2Vec2;PhysicsControlSystem.prototype.keyPoll=null;function PhysicsControlSystem(keyPoll){this.keyPoll=keyPoll;this.updateNode=__bind(this.updateNode,this);PhysicsControlSystem.__super__.constructor.call(this,PhysicsControlNode,this.updateNode)}PhysicsControlSystem.prototype.updateNode=function(node,time){var body,control,rotation,v;control=node.control;body=node.physics.body;if(this.keyPoll.isDown(control.left)){rotation=body.GetAngularVelocity();body.SetAngularVelocity(rotation-control.rotationRate*time)}if(this.keyPoll.isDown(control.right)){rotation=rotation||body.GetAngularVelocity();body.SetAngularVelocity(rotation+control.rotationRate*time)}if(this.keyPoll.isDown(control.accelerate)){rotation=rotation||body.GetAngularVelocity();v=body.GetLinearVelocity();v.x+=Math.cos(rotation)*control.accelerationRate*time*R;v.y+=Math.sin(rotation)*control.accelerationRate*time*R;if(!IDTK){body.SetAwake(true)}body.SetLinearVelocity(v)}};return PhysicsControlSystem}(ash.tools.ListIteratingSystem);RenderSystem=function(_super){__extends(RenderSystem,_super);RenderSystem.prototype.stage=null;RenderSystem.prototype.renderer=null;RenderSystem.prototype.nodes=null;function RenderSystem(stage,renderer){this.stage=stage;this.renderer=renderer;this.update=__bind(this.update,this)}RenderSystem.prototype.addToEngine=function(engine){var node;this.nodes=engine.getNodeList(RenderNode);node=this.nodes.head;while(node){this.addToDisplay(node);node=node.next}};RenderSystem.prototype.addToDisplay=function(node){};RenderSystem.prototype.removeFromDisplay=function(node){};RenderSystem.prototype.removeFromEngine=function(engine){this.nodes=null};RenderSystem.prototype.update=function(time){var display,graphic,node,position;node=this.nodes.head;while(node){display=node.display;graphic=display.graphic;position=node.position;graphic.x=position.position.x;graphic.y=position.position.y;graphic.rotation=position.rotation;node=node.next}this.renderer.render(this.stage)};return RenderSystem}(ash.core.System);SystemPriorities=function(){function SystemPriorities(){}SystemPriorities.preUpdate=1;SystemPriorities.update=2;SystemPriorities.move=3;SystemPriorities.resolveCollisions=4;SystemPriorities.stateMachines=5;SystemPriorities.render=6;SystemPriorities.animate=7;return SystemPriorities}();WaitForStartSystem=function(_super){__extends(WaitForStartSystem,_super);WaitForStartSystem.prototype.engine=null;WaitForStartSystem.prototype.creator=null;WaitForStartSystem.prototype.gameNodes=null;WaitForStartSystem.prototype.waitNodes=null;WaitForStartSystem.prototype.asteroids=null;function WaitForStartSystem(creator){this.creator=creator;this.update=__bind(this.update,this)}WaitForStartSystem.prototype.addToEngine=function(engine){this.engine=engine;this.waitNodes=engine.getNodeList(WaitForStartNode);this.gameNodes=engine.getNodeList(GameNode);this.asteroids=engine.getNodeList(AsteroidCollisionNode)};WaitForStartSystem.prototype.removeFromEngine=function(engine){this.waitNodes=null;this.gameNodes=null;this.asteroids=null};WaitForStartSystem.prototype.update=function(time){var asteroid,game,graphic,node;node=this.waitNodes.head;game=this.gameNodes.head;if(node&&node.wait.startGame&&game){asteroid=this.asteroids.head;while(asteroid){graphic=asteroid.entity.get(Display).graphic;this.creator.destroyEntity(asteroid.entity);graphic.dispose();asteroid=asteroid.next}game.state.setForStart();node.wait.startGame=false;this.engine.removeEntity(node.entity)}};return WaitForStartSystem}(ash.core.System);EntityCreator=function(){var Entity,EntityStateMachine,b2Body,b2BodyDef,b2CircleShape,b2FixtureDef,b2PolygonShape,b2Vec2;Entity=ash.core.Entity;EntityStateMachine=ash.fsm.EntityStateMachine;b2Body=Box2D.Dynamics.b2Body;b2BodyDef=Box2D.Dynamics.b2BodyDef;b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;b2FixtureDef=Box2D.Dynamics.b2FixtureDef;b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;b2Vec2=Box2D.Common.Math.b2Vec2;EntityCreator.prototype.engine=null;EntityCreator.prototype.world=null;EntityCreator.prototype.waitEntity=null;EntityCreator.prototype.bulletId=0;EntityCreator.prototype.asteroidId=0;EntityCreator.prototype.spaceshipId=0;function EntityCreator(engine,world,config,stage){this.engine=engine;this.world=world;this.config=config;this.stage=stage}EntityCreator.prototype.destroyEntity=function(entity){this.engine.removeEntity(entity)};EntityCreator.prototype.createGame=function(){var gameEntity,hud;hud=new HudView(this.stage);gameEntity=new Entity("game").add(new GameState).add(new Hud(hud)).add(new Display(hud)).add(new Position(0,0,0,0));this.engine.addEntity(gameEntity);return gameEntity};EntityCreator.prototype.createWaitForClick=function(){var waitView;waitView=new WaitForStartView(this.stage);this.waitEntity=new Entity("wait").add(new WaitForStart(waitView)).add(new Display(waitView)).add(new Position(0,0,0,0));this.waitEntity.get(WaitForStart).startGame=false;this.engine.addEntity(this.waitEntity);return this.waitEntity};EntityCreator.prototype.createAsteroid=function(radius,x,y){var asteroid,body,bodyDef,deathView,fixDef,fsm,liveView,v1,v2;bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=true;bodyDef.position.x=x;bodyDef.position.y=y;v1=(rnd.nextDouble()-.5)*4*(50-radius)*2*window.devicePixelRatio;v2=(rnd.nextDouble()-.5)*4*(50-radius)*2*window.devicePixelRatio;bodyDef.linearVelocity.Set(v1,v2);bodyDef.angularVelocity=rnd.nextDouble()*2-1;fixDef=new b2FixtureDef;fixDef.density=1;fixDef.friction=1;fixDef.restitution=.2;fixDef.shape=new b2CircleShape(radius);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);asteroid=new Entity;fsm=new EntityStateMachine(asteroid);liveView=new AsteroidView(this.stage,radius);fsm.createState("alive").add(Physics).withInstance(new Physics(body)).add(Collision).withInstance(new Collision(radius)).add(Display).withInstance(new Display(liveView));deathView=new AsteroidDeathView(this.stage,radius);fsm.createState("destroyed").add(DeathThroes).withInstance(new DeathThroes(3)).add(Display).withInstance(new Display(deathView)).add(Animation).withInstance(new Animation(deathView));asteroid.add(new Asteroid(fsm)).add(new Position(x,y,0)).add(new Audio);body.SetUserData({type:"asteroid",entity:asteroid});fsm.changeState("alive");this.engine.addEntity(asteroid);return asteroid};EntityCreator.prototype.createSpaceship=function(){var body,bodyDef,deathView,fixDef,fsm,liveView,spaceship,x,y;x=rnd.nextInt(this.config.width);y=rnd.nextInt(this.config.height);bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=false;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set(0,0);bodyDef.angularVelocity=0;bodyDef.linearDamping=.75;fixDef=new b2FixtureDef;fixDef.density=1;fixDef.friction=1;fixDef.restitution=.2;fixDef.shape=new b2PolygonShape;fixDef.shape.SetAsArray([new b2Vec2(.45*window.devicePixelRatio,0),new b2Vec2(-.25*window.devicePixelRatio,.25*window.devicePixelRatio),new b2Vec2(-.25*window.devicePixelRatio,-.25*window.devicePixelRatio)],3);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);spaceship=new Entity;fsm=new EntityStateMachine(spaceship);liveView=new SpaceshipView(this.stage);fsm.createState("playing").add(Physics).withInstance(new Physics(body)).add(MotionControls).withInstance(new MotionControls(KeyPoll.KEY_LEFT,KeyPoll.KEY_RIGHT,KeyPoll.KEY_UP,100,3)).add(Gun).withInstance(new Gun(8,0,.3,2)).add(GunControls).withInstance(new GunControls(KeyPoll.KEY_Z)).add(Collision).withInstance(new Collision(9*window.devicePixelRatio)).add(Display).withInstance(new Display(liveView));deathView=new SpaceshipDeathView(this.stage);fsm.createState("destroyed").add(DeathThroes).withInstance(new DeathThroes(5)).add(Display).withInstance(new Display(deathView)).add(Animation).withInstance(new Animation(deathView));spaceship.add(new Spaceship(fsm)).add(new Position(x,y,0)).add(new Audio);body.SetUserData({type:"spaceship",entity:spaceship});fsm.changeState("playing");this.engine.addEntity(spaceship);return spaceship};EntityCreator.prototype.createUserBullet=function(gun,parentPosition){var body,bodyDef,bullet,bulletView,cos,fixDef,sin,x,y;cos=Math.cos(parentPosition.rotation);sin=Math.sin(parentPosition.rotation);x=cos*gun.offsetFromParent.x-sin*gun.offsetFromParent.y+parentPosition.position.x;y=sin*gun.offsetFromParent.x+cos*gun.offsetFromParent.y+parentPosition.position.y;bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_dynamicBody;bodyDef.fixedRotation=true;bodyDef.position.x=x;bodyDef.position.y=y;bodyDef.linearVelocity.Set(cos*150*window.devicePixelRatio,sin*150*window.devicePixelRatio);bodyDef.angularVelocity=0;fixDef=new b2FixtureDef;fixDef.density=1;fixDef.friction=0;fixDef.restitution=.2;fixDef.shape=new b2CircleShape(0);body=this.world.CreateBody(bodyDef);body.CreateFixture(fixDef);bulletView=new BulletView(this.stage);bullet=(new Entity).add(new Bullet(gun.bulletLifetime*window.devicePixelRatio)).add(new Position(x,y,0)).add(new Collision(0)).add(new Physics(body)).add(new Display(bulletView));body.SetUserData({type:"bullet",entity:bullet});this.engine.addEntity(bullet);return bullet};return EntityCreator}();GameConfig=function(){function GameConfig(){}GameConfig.prototype.width=0;GameConfig.prototype.height=0;return GameConfig}();Asteroids=function(){var Engine,FrameTickProvider,b2DebugDraw,b2Vec2,b2World;function Asteroids(){this.setPlaySfx=__bind(this.setPlaySfx,this);this.setPlayMusic=__bind(this.setPlayMusic,this);this.setBackground=__bind(this.setBackground,this);this.pause=__bind(this.pause,this)}b2Vec2=Box2D.Common.Math.b2Vec2;b2World=Box2D.Dynamics.b2World;b2DebugDraw=Box2D.Dynamics.b2DebugDraw;Engine=ash.core.Engine;FrameTickProvider=ash.tick.FrameTickProvider;Asteroids.prototype.engine=null;Asteroids.prototype.tickProvider=null;Asteroids.prototype.creator=null;Asteroids.prototype.keyPoll=null;Asteroids.prototype.config=null;Asteroids.prototype.world=null;Asteroids.prototype.stage=null;Asteroids.prototype.renderer=null;Asteroids.prototype.background=null;Asteroids.prototype.physics=null;Asteroids.prototype.playMusic=localStorage.playMusic;Asteroids.prototype.playSfx=localStorage.playSfx;Asteroids.prototype.optBgd=localStorage.background||"blue";Asteroids.prototype.bgdColor=6970061;Asteroids.prototype.assets=["res/starfield.png","res/b_Leaderboard.png","res/b_More1.png","res/b_Parameters.png","res/round.png","res/square.png"];Asteroids.prototype.start=function(canvas,stats){var height,width;width=canvas.width;height=canvas.height;if(this.optBgd!=="blue"){this.bgdColor=6970061}this.stage=new PIXI.Stage(this.bgdColor);this.renderer=new PIXI.CanvasRenderer(width,height,{view:canvas});this.background=PIXI.Sprite.fromImage("res/starfield.png");this.background.width=window.innerWidth*window.devicePixelRatio;this.background.height=window.innerHeight*window.devicePixelRatio;this.background.x=0;this.background.y=0;if(this.optBgd==="blue"){this.background.alpha=0}this.stage.addChild(this.background);this.config=new GameConfig;this.config.height=height;this.config.width=width;this.options();this.world=new b2World(new b2Vec2(0,0),true);this.engine=new Engine;this.creator=new EntityCreator(this.engine,this.world,this.config,this.stage);this.keyPoll=new KeyPoll(this.stage,this.config);this.engine.addSystem(new WaitForStartSystem(this.creator),SystemPriorities.preUpdate);this.engine.addSystem(new GameManager(this.creator,this.config),SystemPriorities.preUpdate);this.engine.addSystem(new PhysicsControlSystem(this.keyPoll),SystemPriorities.update);this.engine.addSystem(new GunControlSystem(this.keyPoll,this.creator),SystemPriorities.update);this.engine.addSystem(new BulletAgeSystem(this.creator),SystemPriorities.update);this.engine.addSystem(new DeathThroesSystem(this.creator),SystemPriorities.update);this.engine.addSystem(this.physics=new PhysicsSystem(this.config,this.world,this.stage),SystemPriorities.move);this.engine.addSystem(new CollisionSystem(this.world,this.creator),SystemPriorities.resolveCollisions);this.engine.addSystem(new AnimationSystem,SystemPriorities.animate);this.engine.addSystem(new HudSystem,SystemPriorities.animate);this.engine.addSystem(new RenderSystem(this.stage,this.renderer),SystemPriorities.render);this.engine.addSystem(new AudioSystem,SystemPriorities.render);this.creator.createWaitForClick();this.creator.createGame();this.tickProvider=new FrameTickProvider(stats);this.tickProvider.add(this.engine.update);this.tickProvider.start()};Asteroids.prototype.options=function(){var leaders,more,options;options=PIXI.Sprite.fromImage("res/b_Parameters.png");options.interactive=true;options.mousedown=options.touchstart=function(data){return Cocoon.App.loadInTheWebView("options.html")};options.anchor.x=.5;options.anchor.y=.5;options.position.x=this.config.width-options.width;options.position.y=options.height*2;this.stage.addChild(options);leaders=PIXI.Sprite.fromImage("res/b_Leaderboard.png");leaders.interactive=true;leaders.mousedown=leaders.touchstart=function(data){return Cocoon.App.loadInTheWebView("leaders.html")};leaders.anchor.x=.5;leaders.anchor.y=.5;leaders.position.x=this.config.width-options.width;leaders.position.y=leaders.height*3+40;this.stage.addChild(leaders);more=PIXI.Sprite.fromImage("res/b_More1.png");more.interactive=true;more.mousedown=more.touchstart=function(data){return Cocoon.App.loadInTheWebView("more.html")};more.anchor.x=.5;more.anchor.y=.5;more.position.x=this.config.width-options.width;more.position.y=leaders.height*4+80;this.stage.addChild(more);Cocoon.App.WebView.on("load",{success:function(_this){return function(){_this.pause(true);return Cocoon.App.showTheWebView()}}(this),error:function(_this){return function(){console.log("Cannot show the Webview for some reason :/");return console.log(JSON.stringify(arguments))
}}(this)})};Asteroids.prototype.pause=function(bValue){this.physics.enabled=!bValue};Asteroids.prototype.setBackground=function(value){if(value===1){this.background.alpha=1;this.optBgd="star";localStorage.background="star"}else{this.background.alpha=0;this.optBgd="blue";localStorage.background="blue"}};Asteroids.prototype.setPlayMusic=function(value){this.playMusic=value;localStorage.playMusic=value};Asteroids.prototype.setPlaySfx=function(value){this.playSfx=value;Sound.volume=value/100;localStorage.playSfx=value};return Asteroids}();(function(){window.rnd=new MersenneTwister;if(!window.requestAnimationFrame){window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}()}return window.addEventListener("load",function(){var canvas,container,loader,stats,x,y;if(navigator.isCocoonJS){stats=null}else{stats=new Stats;container=document.createElement("div");document.body.appendChild(container);container.appendChild(stats.domElement);stats.domElement.style.position="absolute";x=0;y=0;stats.setMode(0);stats.domElement.style.position="absolute";stats.domElement.style.left=""+x+"px";stats.domElement.style.top=""+y+"px";document.body.appendChild(stats.domElement)}canvas=document.createElement(navigator.isCocoonJS?"screencanvas":"canvas");canvas.width=window.innerWidth*window.devicePixelRatio;canvas.height=window.innerHeight*window.devicePixelRatio;canvas.style.width="100%";canvas.style.height="100%";document.body.appendChild(canvas);window.game=new Asteroids;loader=new PIXI.AssetLoader(game.assets);loader.onComplete=function(){return game.start(canvas,stats)};loader.load()})})()}).call(this);